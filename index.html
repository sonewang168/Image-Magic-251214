<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üé© ÂúñÊñáÈ≠îË°ìÂ∏´ V2.0 ÁµÇÊ•µÁâà</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --primary-dark: #7c3aed;
            --secondary: #06b6d4;
            --accent: #f472b6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-input: #0f3460;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --border: #4a5568;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ===== ÈñãÊ©üÂãïÁï´ ===== */
        #splashScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s, visibility 0.5s;
        }
        #splashScreen.fade-out { opacity: 0; visibility: hidden; }
        .splash-logo {
            font-size: 120px;
            animation: spinMagic 2s ease-in-out infinite;
            text-shadow: 0 0 50px rgba(255,255,255,0.5);
        }
        @keyframes spinMagic {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.1); }
            100% { transform: rotateY(360deg) scale(1); }
        }
        .splash-title {
            font-size: 32px;
            font-weight: bold;
            margin-top: 20px;
            background: linear-gradient(90deg, #fff, #f0abfc, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .splash-version { color: rgba(255,255,255,0.8); margin-top: 10px; }
        .splash-loading {
            margin-top: 30px;
            width: 150px; height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        .splash-loading::after {
            content: '';
            display: block;
            width: 50%; height: 100%;
            background: white;
            animation: loading 1s ease-in-out infinite;
        }
        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(300%); }
        }
        
        /* ===== ÁØÄÊÖ∂ÊïàÊûú ===== */
        #festivalEffect {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        .festival-item {
            position: absolute;
            top: -60px;
            animation: festivalFall linear infinite;
            font-size: 24px;
            opacity: 0.7;
        }
        @keyframes festivalFall {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(110vh) rotate(360deg); }
        }
        
        /* ===== ‰∏ªÂÆπÂô® ===== */
        .app-container {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* ===== Header ===== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .header-left { display: flex; align-items: center; gap: 8px; }
        .header-logo { font-size: 28px; animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .header-title { font-size: 18px; font-weight: bold; }
        .header-version {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .header-time { font-size: 11px; opacity: 0.9; }
        .header-festival { font-size: 22px; }
        
        /* ===== Â∑•ÂÖ∑Âàó ===== */
        .toolbar {
            background: var(--bg-card);
            padding: 8px 10px;
            display: flex;
            gap: 6px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }
        /* ÈõªËÖ¶ÁâàÈ°ØÁ§∫Á¥∞Á∑ªÊªæÂãïÊ¢ù */
        .toolbar::-webkit-scrollbar { height: 6px; }
        .toolbar::-webkit-scrollbar-track { background: var(--bg-input); border-radius: 3px; }
        .toolbar::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
        .toolbar::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        .tool-btn {
            flex-shrink: 0;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .tool-btn:hover, .tool-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            transform: scale(1.05);
        }
        .tool-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .tool-btn .icon { font-size: 14px; }
        
        /* ===== PDF ÊéßÂà∂Âàó ===== */
        .pdf-controls {
            background: var(--bg-card);
            padding: 8px 15px;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }
        .pdf-controls.show { display: flex; }
        .pdf-nav-btn {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        .pdf-nav-btn:disabled { opacity: 0.3; }
        .pdf-page-info { font-size: 13px; min-width: 70px; text-align: center; }
        
        /* ===== ‰∏ªÁ∑®ËºØÂçÄ ===== */
        .editor-area { padding: 15px; }
        
        /* ===== ‰∏äÂÇ≥ÂçÄ ===== */
        .upload-zone {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-input));
            border: 2px dashed var(--primary);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            transition: all 0.3s;
        }
        .upload-zone.dragover {
            border-color: var(--accent);
            transform: scale(1.02);
        }
        .upload-zone.hidden { display: none; }
        .upload-icon { font-size: 50px; margin-bottom: 10px; animation: bounce 2s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .upload-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .upload-subtitle { color: var(--text-secondary); font-size: 12px; margin-bottom: 15px; }
        
        /* È¶ñÈ†ÅË™™ÊòéÂçÄÂ°ä */
        .home-guide {
            margin-top: 20px;
            padding: 15px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            border: 1px solid var(--primary);
            text-align: left;
        }
        .guide-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .guide-intro {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .guide-steps {
            margin-bottom: 12px;
        }
        .guide-step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 12px;
            color: var(--text-primary);
        }
        .step-icon {
            font-size: 14px;
        }
        .guide-features {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .feature-tag {
            padding: 6px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .feature-tag:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }
        .guide-hint {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 10px;
            opacity: 0.7;
        }
        
        @keyframes highlight {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 15px 5px var(--primary); transform: scale(1.1); }
        }
        
        .upload-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        .upload-btn {
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .upload-btn.primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; }
        .upload-btn.secondary { background: var(--bg-input); color: white; border: 1px solid var(--border); }
        .upload-btn:hover { transform: scale(1.05); }
        
        /* ===== Áï´Â∏ÉÂçÄ ===== */
        .canvas-wrapper {
            display: none;
            position: relative;
            background: #2d2d2d;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .canvas-wrapper.show { display: block; }
        .canvas-container {
            position: relative;
            overflow: auto;
            max-height: 65vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: repeating-conic-gradient(#1a1a2e 0% 25%, #252540 0% 50%) 50% / 20px 20px;
            border-radius: 10px;
            padding: 10px;
        }
        #mainCanvas { 
            display: block; 
            max-width: 100%; 
            max-height: calc(65vh - 20px);
            width: auto;
            height: auto;
            cursor: crosshair;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .canvas-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            flex-wrap: wrap;
            gap: 8px;
        }
        .canvas-info-bar span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #canvasInfo::before { content: 'üìê '; }
        #zoomInfo { 
            cursor: pointer; 
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 50px;
            text-align: center;
        }
        #zoomInfo:hover { background: var(--bg-input); }
        #zoomInfo::before { content: 'üîç '; }
        .canvas-quick-tools {
            display: flex;
            gap: 5px;
        }
        .quick-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .quick-btn:hover { background: var(--primary); transform: scale(1.05); }
        .quick-btn:active { transform: scale(0.95); }
        .quick-btn.active { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .quick-btn.danger:hover { background: #ef4444; }
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .zoom-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .zoom-btn:hover { background: var(--primary); }
        .zoom-btn:active { transform: scale(0.95); }
        .zoom-btn.fit { font-size: 14px; }
        .zoom-hint {
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
            padding: 5px;
            opacity: 0.7;
        }
        .selection-box {
            position: absolute;
            border: 2px dashed var(--accent);
            background: rgba(244, 114, 182, 0.2);
            pointer-events: none;
            display: none;
        }
        
        /* ÊãñÊõ≥ÂúñÂ±§ */
        .drag-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .drag-object {
            position: absolute;
            cursor: move;
            pointer-events: auto;
            border: 2px dashed var(--primary);
            border-radius: 4px;
            background: rgba(99, 102, 241, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            touch-action: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: dragPulse 1.5s infinite;
        }
        .drag-object:hover {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--primary);
        }
        .drag-object.dragging {
            opacity: 0.8;
            transform: scale(1.02);
        }
        .drag-object img {
            max-width: 100%;
            max-height: 100%;
            pointer-events: none;
        }
        .drag-object-text {
            white-space: nowrap;
            pointer-events: none;
        }
        @keyframes dragPulse {
            0%, 100% { border-color: var(--primary); }
            50% { border-color: var(--accent); }
        }
        .drag-controls {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 10px;
            margin-top: 10px;
        }
        .drag-controls.show { display: flex; }
        .drag-hint {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .drag-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .drag-btn.confirm {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
        }
        .drag-btn.cancel {
            background: var(--bg-input);
            color: var(--text-primary);
        }
        .drag-btn:hover { transform: scale(1.05); }
        .drag-btn:active { transform: scale(0.95); }
        
        /* ===== AI ÂàÜÊûêÈù¢Êùø ===== */
        .ai-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--primary);
        }
        .ai-panel.show { display: block; }
        .ai-model-select {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .ai-model-select label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .ai-model-select select {
            flex: 1;
            padding: 8px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 12px;
        }
        .ai-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .ai-option {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: var(--bg-input);
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ai-option:has(input:checked) {
            background: var(--primary);
        }
        .ai-option input { display: none; }
        .ai-analyze-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        .ai-analyze-btn:hover { transform: scale(1.02); }
        .ai-analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .ai-result {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 12px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 12px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .ai-result-placeholder {
            color: var(--text-secondary);
            text-align: center;
            padding: 30px 0;
        }
        .ai-result.loading {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ai-result.loading::after {
            content: '';
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .ai-actions {
            display: flex;
            gap: 8px;
        }
        
        /* ===== PDF Â∑•ÂÖ∑Èù¢Êùø ===== */
        .pdf-tool-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--secondary);
        }
        .pdf-tool-panel.show { display: block; }
        .pdf-pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 12px 0;
            max-height: 250px;
            overflow-y: auto;
            padding: 5px;
        }
        .pdf-page-thumb {
            position: relative;
            aspect-ratio: 3/4;
            background: var(--bg-input);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .pdf-page-thumb:hover { border-color: var(--primary); }
        .pdf-page-thumb.selected { border-color: var(--accent); }
        .pdf-page-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .pdf-page-thumb .page-num {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 10px;
            text-align: center;
            padding: 2px;
        }
        .pdf-page-thumb .check-mark {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .pdf-page-thumb.selected .check-mark { display: flex; }
        .pdf-tool-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .pdf-tool-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .pdf-tool-btn:hover { transform: scale(1.02); }
        .pdf-tool-btn.select-all { background: var(--bg-input); color: white; border: 1px solid var(--border); }
        .pdf-tool-btn.export-images { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
        .pdf-tool-btn.export-pdf { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        
        /* ===== ÊµÆÊ∞¥Âç∞Â∑•ÂÖ∑Èù¢Êùø ===== */
        .watermark-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--accent);
        }
        .watermark-panel.show { display: block; }
        .watermark-section { margin-bottom: 15px; }
        .section-subtitle {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent);
        }
        .watermark-type-select {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .watermark-type {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .watermark-type:has(input:checked) { background: var(--primary); }
        .watermark-type input { display: none; }
        .wm-input {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .wm-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .wm-option {
            flex: 1;
            min-width: 80px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .wm-option label {
            font-size: 10px;
            color: var(--text-secondary);
        }
        .wm-option input[type="number"] {
            width: 100%;
            padding: 6px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 12px;
        }
        .wm-option input[type="range"] {
            width: 100%;
            accent-color: var(--primary);
        }
        .wm-option input[type="color"] {
            width: 100%;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .wm-upload-btn {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 2px dashed var(--border);
            border-radius: 10px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .wm-upload-btn:hover { border-color: var(--primary); }
        .wm-image-preview {
            width: 100%;
            height: 80px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .wm-image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .wm-position {
            margin-bottom: 12px;
        }
        .wm-position > label {
            font-size: 11px;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 8px;
        }
        .position-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            max-width: 150px;
            margin-bottom: 10px;
        }
        .pos-btn {
            aspect-ratio: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pos-btn:hover, .pos-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        .tile-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .tile-option input {
            accent-color: var(--primary);
        }
        .wm-action-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }
        .wm-action-btn:hover { transform: scale(1.02); }
        .wm-action-btn.add {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
        }
        .wm-action-btn.remove {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
        }
        .wm-action-btn.remove-manual {
            background: var(--bg-input);
            color: white;
            border: 1px solid var(--border);
        }
        .wm-divider {
            height: 1px;
            background: var(--border);
            margin: 15px 0;
        }
        .wm-remove-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .wm-model-select {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .wm-model-select label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .wm-model-select select {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 12px;
        }
        
        /* ===== ÊñáÂ≠óÁ∑®ËºØÈù¢Êùø ===== */
        .text-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
        .text-panel.show { display: block; }
        
        /* ===== ÈÄöÁî®ÂäüËÉΩÈù¢Êùø ===== */
        .stamp-panel, .sign-panel, .filter-panel, .adjust-panel, 
        .frame-panel, .sticker-panel, .crop-panel, .merge-panel, 
        .qr-panel, .compress-panel, .arrow-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .stamp-panel.show, .sign-panel.show, .filter-panel.show, .adjust-panel.show,
        .frame-panel.show, .sticker-panel.show, .crop-panel.show, .merge-panel.show,
        .qr-panel.show, .compress-panel.show, .arrow-panel.show { display: block; }
        
        /* Â∑•ÂÖ∑ÊèêÁ§∫ */
        .tool-tip {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 10px 15px;
            margin-top: 10px;
            border-left: 3px solid var(--primary);
        }
        .tip-content { font-size: 12px; color: var(--text-secondary); }
        
        /* ÂúñÁ´†Èù¢Êùø */
        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .stamp-item {
            padding: 10px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .stamp-item:hover { background: var(--primary); transform: scale(1.05); }
        .stamp-custom {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .stamp-custom input {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 12px;
        }
        .stamp-custom button {
            padding: 8px 15px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }
        .stamp-options { display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* Á∞ΩÂêçÈù¢Êùø */
        #signCanvas {
            width: 100%;
            height: 150px;
            background: white;
            border-radius: 10px;
            cursor: crosshair;
            touch-action: none;
        }
        .sign-options {
            display: flex;
            gap: 15px;
            margin: 12px 0;
        }
        .sign-actions {
            display: flex;
            gap: 10px;
        }
        
        /* ÊøæÈè°Èù¢Êùø */
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .filter-preview-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 12px;
        }
        .filter-preview-area canvas {
            border-radius: 8px;
            border: 2px solid var(--border);
            margin-bottom: 8px;
        }
        .filter-preview-area span {
            font-size: 12px;
            color: var(--accent);
            font-weight: bold;
        }
        .filter-item {
            padding: 12px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-item:hover { background: var(--primary); }
        
        /* Ë™øÊï¥Èù¢Êùø */
        .adjust-sliders { margin-bottom: 15px; }
        .adjust-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .adjust-item label {
            min-width: 50px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .adjust-item input[type="range"] {
            flex: 1;
            accent-color: var(--primary);
        }
        .adjust-item span {
            min-width: 35px;
            font-size: 11px;
            text-align: right;
        }
        .adjust-actions { display: flex; gap: 10px; }
        
        /* ÈÇäÊ°ÜÈù¢Êùø */
        .frame-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .frame-item {
            padding: 12px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .frame-item:hover { background: var(--primary); }
        .frame-options { display: flex; gap: 15px; flex-wrap: wrap; }
        
        /* Ë≤ºÂúñÈù¢Êùø */
        .sticker-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }
        .sticker-tab {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        .sticker-tab.active { background: var(--primary); }
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .sticker-item {
            aspect-ratio: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .sticker-item:hover { transform: scale(1.2); }
        .sticker-options { display: flex; gap: 15px; }
        
        /* Ë£ÅÂàáÈù¢Êùø */
        .crop-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .crop-preset {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .crop-preset:hover, .crop-preset.active { background: var(--primary); }
        .crop-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 8px;
        }
        
        /* ÊãºÊé•Èù¢Êùø */
        .merge-direction {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        .merge-dir {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .merge-dir:has(input:checked) { background: var(--primary); }
        .merge-dir input { accent-color: var(--primary); }
        .merge-list {
            margin-bottom: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        .merge-item {
            padding: 8px 12px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .merge-item.current { border-left: 3px solid var(--primary); }
        .merge-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
        }
        .merge-item .remove-merge {
            margin-left: auto;
            background: var(--danger);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            color: white;
            cursor: pointer;
            font-size: 10px;
        }
        
        /* QR Code Èù¢Êùø */
        .qr-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 12px 0;
        }
        .qr-preview {
            width: 100%;
            min-height: 120px;
            background: var(--bg-input);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }
        .qr-preview canvas { max-width: 100%; }
        
        /* Â£ìÁ∏ÆÈù¢Êùø */
        .compress-info {
            background: var(--bg-input);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 12px;
        }
        .compress-info div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .compress-info div:last-child { margin-bottom: 0; }
        .compress-slider {
            margin-bottom: 12px;
        }
        .compress-slider label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .compress-slider input {
            width: 100%;
            accent-color: var(--primary);
        }
        .compress-resize {
            margin-bottom: 12px;
        }
        .compress-resize > label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .compress-resize input[type="checkbox"] { accent-color: var(--primary); }
        .resize-options {
            margin-top: 8px;
        }
        .resize-options select {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        
        /* ===== Êñ∞ÂäüËÉΩÈù¢ÊùøÈÄöÁî®Ê®£Âºè ===== */
        .brush-panel, .shape-panel, .textfx-panel, .template-panel, .collage-panel,
        .beauty-panel, .removebg-panel, .batch-panel, .effect-panel, .overlay-panel,
        .annotate-panel, .history-panel, .info-panel, .colorreplace-panel, .idphoto-panel,
        .screenshot-panel, .pixelart-panel, .ascii-panel, .duotone-panel, .gradient-panel,
        .noise-panel, .blurbg-panel, .texture-panel, .bokeh-panel, .mirror-panel,
        .split-panel, .social-panel, .export-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .brush-panel.show, .shape-panel.show, .textfx-panel.show, .template-panel.show,
        .collage-panel.show, .beauty-panel.show, .removebg-panel.show, .batch-panel.show,
        .effect-panel.show, .overlay-panel.show, .annotate-panel.show, .history-panel.show,
        .info-panel.show, .colorreplace-panel.show, .idphoto-panel.show, .screenshot-panel.show,
        .pixelart-panel.show, .ascii-panel.show, .duotone-panel.show, .gradient-panel.show,
        .noise-panel.show, .blurbg-panel.show, .texture-panel.show, .bokeh-panel.show,
        .mirror-panel.show, .split-panel.show, .social-panel.show, .export-panel.show { display: block; }
        
        /* Áï´Á≠ÜÈù¢Êùø */
        .brush-types, .shape-types, .textfx-styles, .mirror-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .brush-type, .shape-type, .fx-style, .mirror-type {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .brush-type.active, .shape-type.active, .fx-style.active, .mirror-type.active {
            background: var(--primary);
        }
        .brush-colors {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .color-preset {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
        }
        .color-preset:hover { transform: scale(1.1); }
        
        /* Ê®°ÊùøÈù¢Êùø */
        .template-categories, .sticker-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }
        .template-cat, .collage-layout {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .template-cat.active, .collage-layout.active { background: var(--primary); }
        .template-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .template-item {
            padding: 10px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 10px;
            text-align: center;
            cursor: pointer;
        }
        .template-item:hover { background: var(--primary); }
        .custom-size { margin-top: 12px; }
        .size-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }
        .size-inputs input {
            width: 80px;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            text-align: center;
        }
        
        /* ÊãºË≤ºÈù¢Êùø */
        .collage-layouts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .collage-images {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            min-height: 60px;
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
        }
        .collage-thumb {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            object-fit: cover;
        }
        
        /* ÁæéÈ°èÈù¢Êùø */
        .beauty-sliders { margin-bottom: 12px; }
        .beauty-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .beauty-preset {
            flex: 1;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .beauty-preset:hover { background: var(--primary); }
        
        /* ÂéªËÉåÈù¢Êùø */
        .removebg-options, .newbg-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .removebg-btn, .newbg-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .removebg-btn:hover, .newbg-btn:hover { background: var(--primary); }
        .color-pick-row, .tolerance-row {
            margin-bottom: 12px;
        }
        .new-bg-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        
        /* ÊâπÊ¨°ËôïÁêÜÈù¢Êùø */
        .batch-list {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            margin: 12px 0;
            max-height: 150px;
            overflow-y: auto;
        }
        .batch-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-size: 12px;
        }
        .batch-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            font-size: 12px;
        }
        .batch-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
        }
        .batch-actions { margin-bottom: 12px; }
        .batch-action {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* ÁâπÊïàÈù¢Êùø */
        .effect-grid, .texture-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .effect-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .effect-cat {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .effect-cat:hover, .effect-cat.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        .effect-tip {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: var(--bg-input);
            border-radius: 8px;
        }
        .effect-item, .texture-item {
            padding: 12px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .effect-item:hover, .texture-item:hover { background: var(--primary); }
        
        /* ÁñäÂä†Èù¢Êùø */
        .overlay-types {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .overlay-type {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .overlay-type.active { background: var(--primary); }
        .overlay-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .overlay-item {
            aspect-ratio: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
        }
        
        /* ÊâπË®ªÈù¢Êùø */
        .annotate-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .annotate-tool {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .annotate-tool.active { background: var(--primary); }
        
        /* Ê≠∑Âè≤Ë®òÈåÑÈù¢Êùø */
        .history-list {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .history-item:hover { background: var(--primary); }
        .history-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        /* ÂúñÁâáË≥áË®äÈù¢Êùø */
        .info-content {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 12px;
            font-size: 12px;
            line-height: 1.8;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            padding: 5px 0;
        }
        .info-row:last-child { border-bottom: none; }
        
        /* È°èËâ≤ÊõøÊèõÈù¢Êùø */
        .color-replace-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .color-replace-row .arrow {
            font-size: 20px;
            color: var(--primary);
        }
        
        /* Ë≠â‰ª∂ÁÖßÈù¢Êùø */
        .id-sizes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .id-size {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .id-size:hover, .id-size.active { background: var(--primary); }
        .id-options {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .id-options select {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        
        /* Êà™ÂúñÁæéÂåñÈù¢Êùø */
        .device-frames {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .device-frame {
            padding: 10px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .device-frame:hover { background: var(--primary); }
        
        /* ÂÉèÁ¥†Áï´/ASCII Èù¢Êùø */
        .pixel-presets, .split-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .pixel-preset, .split-preset {
            flex: 1;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        .pixel-preset:hover, .split-preset:hover { background: var(--primary); }
        .ascii-output {
            width: 100%;
            height: 150px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--primary);
            font-family: monospace;
            font-size: 8px;
            padding: 10px;
            margin-bottom: 12px;
            resize: none;
        }
        .ascii-actions {
            display: flex;
            gap: 8px;
        }
        
        /* ÈõôËâ≤Ë™ø/Êº∏Â±§Èù¢Êùø */
        .duotone-presets, .gradient-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .duotone-preset, .gradient-preset {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
        }
        .duotone-preset:hover, .gradient-preset:hover {
            transform: scale(1.1);
            border-color: white;
        }
        .duotone-custom {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
        }
        
        /* Á§æÁæ§Â™íÈ´îÈù¢Êùø */
        .social-platforms {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .social-platform {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
        }
        .platform-name {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .social-platform button {
            padding: 6px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 10px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .social-platform button:hover { background: var(--primary); }
        
        /* ÂåØÂá∫Èù¢Êùø */
        .export-options {
            margin-bottom: 12px;
        }
        .export-options select, .export-options input[type="text"] {
            width: 100%;
            margin-top: 5px;
        }
        .export-info {
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 12px;
            text-align: center;
        }
        
        /* Èù¢ÊùøÂâØÊ®ôÈ°å */
        .panel-subtitle {
            font-size: 12px;
            font-weight: bold;
            color: var(--accent);
            margin: 10px 0;
        }
        
        /* ÊèêÁ§∫ÊñáÂ≠ó */
        .shape-tip, .blur-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        /* ===== È¶ñÈ†Å‰ΩøÁî®Ë™™ÊòéÊ®£Âºè ===== */
        .help-guide {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(99,102,241,0.1) 100%);
            border-radius: 20px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid var(--border);
            display: block !important;
        }
        .help-guide .help-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .help-guide .help-intro {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 12px;
        }
        .help-guide .help-section {
            margin-bottom: 20px;
        }
        .help-guide .help-section-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }
        .help-guide .help-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .help-guide .help-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 12px;
            transition: transform 0.2s;
        }
        .help-guide .help-step:hover {
            transform: translateX(5px);
        }
        .help-guide .step-num {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        .help-guide .step-text {
            font-size: 12px;
            color: var(--text-primary);
        }
        .help-guide .help-detail {
            background: var(--bg-input);
            border-radius: 12px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .help-guide .help-detail summary {
            padding: 12px 15px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .help-guide .help-detail summary:hover {
            background: rgba(99,102,241,0.2);
        }
        .help-guide .help-detail p {
            padding: 0 15px 15px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin: 0;
        }
        .help-guide .help-tips {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .help-guide .help-tip {
            font-size: 11px;
            color: var(--text-secondary);
            padding: 10px 12px;
            background: var(--bg-input);
            border-radius: 10px;
            border-left: 3px solid var(--primary);
        }
        .help-guide .help-tip b {
            color: var(--text-primary);
        }
        .help-guide .help-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding-top: 15px;
            margin-top: 15px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-secondary);
        }
        .help-guide .help-footer span:first-child {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary);
        }
        
        /* ===== ‰ΩøÁî®Ë™™ÊòéÈù¢ÊùøÊ®£Âºè ===== */
        .help-panel {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(99,102,241,0.1) 100%);
            border-radius: 20px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .help-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .help-intro {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 12px;
        }
        .help-section {
            margin-bottom: 20px;
        }
        .help-section-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }
        .help-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .help-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 12px;
            transition: transform 0.2s;
        }
        .help-step:hover {
            transform: translateX(5px);
        }
        .step-num {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        .step-text {
            font-size: 12px;
            color: var(--text-primary);
        }
        .help-detail {
            background: var(--bg-input);
            border-radius: 12px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .help-detail summary {
            padding: 12px 15px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .help-detail summary:hover {
            background: rgba(99,102,241,0.2);
        }
        .help-detail summary::marker {
            color: var(--primary);
        }
        .help-detail p {
            padding: 0 15px 15px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin: 0;
        }
        .help-tips {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .help-tip {
            font-size: 11px;
            color: var(--text-secondary);
            padding: 10px 12px;
            background: var(--bg-input);
            border-radius: 10px;
            border-left: 3px solid var(--primary);
        }
        .help-tip b {
            color: var(--text-primary);
        }
        .help-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding-top: 15px;
            margin-top: 15px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-secondary);
        }
        .help-footer span:first-child {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary);
        }
        
        /* ===== Êõ¥Â§öÈù¢ÊùøÊ®£Âºè ===== */
        .layer-panel, .liquify-panel, .curve-panel, .level-panel, .histogram-panel,
        .colorbalance-panel, .selectivecolor-panel, .photofilter-panel, .lensblur-panel,
        .motionblur-panel, .perspective-panel, .distort-panel, .warp-panel, .meme-panel,
        .poster-panel, .card-panel, .banner-panel, .avatar-panel, .logo-panel, .gif-panel,
        .palette-panel, .eyedropper-adv-panel, .guide-panel, .align-panel, .path-panel,
        .channel-panel, .slimface-panel, .bigeye-panel, .makeup-panel, .splittone-panel,
        .colorgrade-panel, .lut-panel, .vintage-panel, .film-panel, .cinema-panel,
        .print-panel, .share-panel, .cloud-panel, .shortcut-panel, .help-panel,
        .colorsplash-panel, .dotart-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .layer-panel.show, .liquify-panel.show, .curve-panel.show, .level-panel.show,
        .histogram-panel.show, .colorbalance-panel.show, .selectivecolor-panel.show,
        .photofilter-panel.show, .lensblur-panel.show, .motionblur-panel.show,
        .perspective-panel.show, .distort-panel.show, .warp-panel.show, .meme-panel.show,
        .poster-panel.show, .card-panel.show, .banner-panel.show, .avatar-panel.show,
        .logo-panel.show, .gif-panel.show, .palette-panel.show, .eyedropper-adv-panel.show,
        .guide-panel.show, .align-panel.show, .path-panel.show, .channel-panel.show,
        .slimface-panel.show, .bigeye-panel.show, .makeup-panel.show, .splittone-panel.show,
        .colorgrade-panel.show, .lut-panel.show, .vintage-panel.show, .film-panel.show,
        .cinema-panel.show, .print-panel.show, .share-panel.show, .cloud-panel.show,
        .shortcut-panel.show, .help-panel.show, .colorsplash-panel.show, .dotart-panel.show { display: block; }
        
        /* ÂúñÂ±§Èù¢Êùø */
        .layer-list {
            background: var(--bg-input);
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        .layer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            font-size: 12px;
        }
        .layer-item:last-child { border-bottom: none; }
        .layer-item:hover { background: rgba(255,255,255,0.05); }
        .layer-item.active { background: var(--primary); }
        .layer-visibility, .layer-lock { cursor: pointer; }
        .layer-thumb {
            width: 30px;
            height: 30px;
            background: var(--bg-dark);
            border-radius: 5px;
        }
        .layer-name { flex: 1; }
        .layer-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
        }
        .layer-actions button {
            flex: 1;
            min-width: 60px;
            padding: 6px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .layer-actions button:hover { background: var(--primary); }
        .layer-blend, .layer-opacity { margin-bottom: 10px; }
        .layer-blend select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        
        /* Ê∂≤ÂåñÈù¢Êùø */
        .liquify-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .liquify-tool {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .liquify-tool.active { background: var(--primary); }
        .liquify-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        /* Êõ≤Á∑öÈù¢Êùø */
        .curve-channel {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }
        .channel-btn {
            flex: 1;
            padding: 6px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .channel-btn.active { background: var(--primary); }
        .curve-canvas {
            width: 100%;
            height: 200px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: crosshair;
        }
        .curve-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
        }
        .curve-presets button {
            flex: 1;
            padding: 6px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .curve-presets button:hover { background: var(--primary); }
        
        /* Ëâ≤ÈöéÈù¢Êùø */
        .level-histogram {
            width: 100%;
            height: 100px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .level-inputs { margin-bottom: 12px; }
        .level-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .level-row span { width: 70px; }
        .level-row input[type="number"] {
            width: 50px;
            padding: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            text-align: center;
        }
        .level-row input[type="range"] { flex: 1; }
        .level-presets {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .level-presets button {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }
        .level-presets button:hover { background: var(--primary); }
        
        /* Áõ¥ÊñπÂúñÈù¢Êùø */
        .histogram-canvas {
            width: 100%;
            height: 150px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 12px;
        }
        .histogram-channels {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
            font-size: 12px;
        }
        .histogram-channels label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .histogram-stats {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            font-size: 11px;
        }
        
        /* Ëâ≤ÂΩ©Âπ≥Ë°°Èù¢Êùø */
        .balance-section {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 10px;
        }
        .balance-label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent);
        }
        .balance-slider {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 11px;
        }
        .balance-slider span { width: 40px; text-align: center; }
        .balance-slider input[type="range"] { flex: 1; }
        
        /* ÈÅ∏ÊìáÊÄßË™øËâ≤Èù¢Êùø */
        .selective-color-select {
            margin-bottom: 12px;
        }
        .selective-color-select select {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        .selective-sliders .adjust-item {
            margin-bottom: 10px;
        }
        
        /* Áõ∏ÁâáÊøæÈè°Èù¢Êùø */
        .photofilter-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .pf-item {
            padding: 8px;
            border-radius: 8px;
            color: white;
            font-size: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .pf-item:hover { border-color: white; }
        .pf-options { margin-top: 12px; }
        
        /* Êâ≠Êõ≤/ÂΩéÊõ≤Èù¢Êùø */
        .distort-types, .warp-styles {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .distort-type, .warp-style {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .distort-type:hover, .warp-style:hover { background: var(--primary); }
        
        /* Ëø∑Âõ†/Êµ∑Â†±/ÂêçÁâáÈù¢Êùø */
        .meme-templates, .poster-templates, .card-templates, .logo-templates {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .meme-template, .poster-template, .card-template, .logo-template {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .meme-template:hover, .poster-template:hover, .card-template:hover, .logo-template:hover { background: var(--primary); }
        .card-fields {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        /* Ê©´ÂπÖÈù¢Êùø */
        .banner-sizes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .banner-sizes button {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .banner-sizes button:hover { background: var(--primary); }
        
        /* È†≠ÂÉèÈù¢Êùø */
        .avatar-shapes, .avatar-sizes {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .avatar-shape, .avatar-sizes button {
            flex: 1;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .avatar-shape:hover, .avatar-shape.active, .avatar-sizes button:hover { background: var(--primary); }
        
        /* GIF Èù¢Êùø */
        .gif-frames {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        .gif-frame-item {
            padding: 8px;
            background: var(--bg-dark);
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        /* Ë™øËâ≤Áõ§Èù¢Êùø */
        .palette-colors {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 12px 0;
            min-height: 50px;
        }
        .palette-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .palette-preset {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .palette-preset:hover { background: var(--primary); }
        
        /* ÂèñËâ≤Âô®Èù¢Êùø */
        .color-preview-large {
            width: 100%;
            height: 60px;
            border-radius: 10px;
            margin-bottom: 12px;
            background: #666;
        }
        .color-values { margin-bottom: 12px; }
        .color-value-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .color-value-row span { width: 50px; }
        .color-value-row input {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-family: monospace;
        }
        .color-value-row button {
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }
        .color-history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        /* ÂèÉËÄÉÁ∑öÈù¢Êùø */
        .guide-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .guide-actions button {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .guide-actions button:hover { background: var(--primary); }
        .guide-list {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            min-height: 50px;
        }
        
        /* Â∞çÈΩäÈù¢Êùø */
        .align-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .align-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .align-buttons button {
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .align-buttons button:hover { background: var(--primary); }
        
        /* Ëâ≤ÁâàÈù¢Êùø */
        .channel-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .channel-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .channel-item:hover { background: var(--primary); }
        .channel-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        /* ÂΩ©Â¶ùÈù¢Êùø */
        .makeup-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .makeup-type {
            padding: 10px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .makeup-type:hover, .makeup-type.active { background: var(--primary); }
        
        /* ÈõªÂΩ±Ë™øËâ≤Èù¢Êùø */
        .colorgrade-presets, .lut-presets, .vintage-presets, .film-presets {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .cg-preset, .lut-preset, .vintage-preset, .film-preset {
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .cg-preset:hover, .lut-preset:hover, .vintage-preset:hover, .film-preset:hover { background: var(--primary); }
        
        /* ÈõªÂΩ±ÊïàÊûúÈù¢Êùø */
        .cinema-options {
            margin-bottom: 12px;
        }
        .cinema-options .tile-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .cinema-ratio {
            margin-bottom: 12px;
        }
        .cinema-ratio select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        
        /* ÂàóÂç∞Èù¢Êùø */
        .print-options {
            margin-bottom: 12px;
        }
        .print-options select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        
        /* ÂàÜ‰∫´Èù¢Êùø */
        .share-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .share-btn {
            padding: 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        .share-btn:hover { background: var(--primary); }
        
        /* Èõ≤Á´ØÈù¢Êùø */
        .cloud-services {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .cloud-btn {
            flex: 1;
            padding: 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        .cloud-btn:hover { background: var(--primary); }
        .cloud-result {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 15px;
            min-height: 50px;
        }
        
        /* Âø´Êç∑ÈçµÈù¢Êùø */
        .shortcut-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-input);
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .shortcut-item span:first-child {
            font-family: monospace;
            background: var(--bg-dark);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        /* Ë™™ÊòéÈù¢Êùø */
        .help-sections {
            margin-bottom: 15px;
        }
        .help-sections details {
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        .help-sections summary {
            padding: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
        }
        .help-sections p {
            padding: 0 12px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0;
        }
        .help-links {
            display: flex;
            gap: 15px;
        }
        .help-links a {
            color: var(--primary);
            text-decoration: none;
            font-size: 12px;
        }
        .help-links a:hover { text-decoration: underline; }
        
        /* Â±ÄÈÉ®ÂΩ©Ëâ≤Èù¢Êùø */
        .colorsplash-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        /* ÈªûÈô£ÂúñÈù¢Êùø */
        .dotart-options {
            margin-bottom: 12px;
        }
        
        /* ===== ÂúñÂ±§Èù¢ÊùøÊ®£Âºè ===== */
        .layer-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .layer-panel.show { display: block; }
        
        .layer-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        .layer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .layer-item:hover { background: var(--bg-dark); }
        .layer-item.active { background: var(--primary); }
        .layer-visibility, .layer-lock {
            cursor: pointer;
            font-size: 14px;
        }
        .layer-thumb {
            width: 30px;
            height: 30px;
            background: var(--bg-dark);
            border-radius: 4px;
        }
        .layer-name {
            flex: 1;
            font-size: 12px;
        }
        .layer-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
        }
        .layer-actions button {
            flex: 1;
            min-width: 60px;
            padding: 6px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .layer-actions button:hover { background: var(--primary); }
        .layer-blend, .layer-opacity {
            margin-bottom: 10px;
        }
        .layer-blend select {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            margin-top: 5px;
        }
        
        /* ===== Ê∂≤ÂåñÈù¢ÊùøÊ®£Âºè ===== */
        .liquify-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .liquify-panel.show { display: block; }
        
        .liquify-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .liquify-tool {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .liquify-tool.active { background: var(--primary); }
        .liquify-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
        }
        
        /* ===== Êõ≤Á∑öÈù¢ÊùøÊ®£Âºè ===== */
        .curve-panel, .level-panel, .histogram-panel, .colorbalance-panel,
        .selectivecolor-panel, .photofilter-panel, .lensblur-panel, .motionblur-panel,
        .perspective-panel, .distort-panel, .warp-panel, .meme-panel, .poster-panel,
        .card-panel, .banner-panel, .avatar-panel, .logo-panel, .gif-panel,
        .palette-panel, .eyedropper-adv-panel, .guide-panel, .align-panel,
        .path-panel, .channel-panel, .slimface-panel, .bigeye-panel, .makeup-panel,
        .splittone-panel, .colorgrade-panel, .lut-panel, .vintage-panel, .film-panel,
        .cinema-panel, .print-panel, .share-panel, .cloud-panel, .shortcut-panel,
        .help-panel, .colorsplash-panel, .dotart-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .curve-panel.show, .level-panel.show, .histogram-panel.show, .colorbalance-panel.show,
        .selectivecolor-panel.show, .photofilter-panel.show, .lensblur-panel.show, .motionblur-panel.show,
        .perspective-panel.show, .distort-panel.show, .warp-panel.show, .meme-panel.show, .poster-panel.show,
        .card-panel.show, .banner-panel.show, .avatar-panel.show, .logo-panel.show, .gif-panel.show,
        .palette-panel.show, .eyedropper-adv-panel.show, .guide-panel.show, .align-panel.show,
        .path-panel.show, .channel-panel.show, .slimface-panel.show, .bigeye-panel.show, .makeup-panel.show,
        .splittone-panel.show, .colorgrade-panel.show, .lut-panel.show, .vintage-panel.show, .film-panel.show,
        .cinema-panel.show, .print-panel.show, .share-panel.show, .cloud-panel.show, .shortcut-panel.show,
        .help-panel.show, .colorsplash-panel.show, .dotart-panel.show { display: block; }
        
        .curve-channel {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .channel-btn {
            flex: 1;
            padding: 6px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .channel-btn.active { background: var(--primary); }
        .curve-canvas, .histogram-canvas {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .curve-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        .curve-presets button {
            padding: 5px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .curve-presets button:hover { background: var(--primary); }
        
        /* ===== Ëâ≤ÈöéÈù¢ÊùøÊ®£Âºè ===== */
        .level-histogram {
            margin-bottom: 12px;
        }
        .level-inputs {
            margin-bottom: 12px;
        }
        .level-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 11px;
        }
        .level-row span { min-width: 60px; }
        .level-row input[type="number"] {
            width: 50px;
            padding: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            text-align: center;
        }
        .level-row input[type="range"] { flex: 1; }
        .level-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .level-presets button {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .level-presets button:hover { background: var(--primary); }
        
        /* ===== Áõ¥ÊñπÂúñÈù¢ÊùøÊ®£Âºè ===== */
        .histogram-channels {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }
        .histogram-channels label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        .histogram-stats {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 10px;
            font-size: 11px;
        }
        
        /* ===== Ëâ≤ÂΩ©Âπ≥Ë°°Èù¢ÊùøÊ®£Âºè ===== */
        .balance-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .balance-section:last-of-type {
            border-bottom: none;
            margin-bottom: 10px;
        }
        .balance-label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent);
        }
        .balance-slider {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .balance-slider span {
            font-size: 10px;
            min-width: 30px;
            text-align: center;
        }
        .balance-slider input[type="range"] { flex: 1; }
        
        /* ===== ÈÅ∏ÊìáÊÄßË™øËâ≤Èù¢ÊùøÊ®£Âºè ===== */
        .selective-color-select {
            margin-bottom: 12px;
        }
        .selective-color-select select {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        .selective-sliders { margin-bottom: 12px; }
        
        /* ===== Áõ∏ÁâáÊøæÈè°Èù¢ÊùøÊ®£Âºè ===== */
        .photofilter-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .pf-item {
            padding: 8px;
            border-radius: 8px;
            color: white;
            font-size: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .pf-item:hover { border-color: white; }
        .pf-options { margin-bottom: 12px; }
        
        /* ===== Ê®°Á≥äÈù¢ÊùøÊ®£Âºè ===== */
        .lensblur-options, .motionblur-options, .perspective-options {
            margin-bottom: 12px;
        }
        
        /* ===== Êâ≠Êõ≤Èù¢ÊùøÊ®£Âºè ===== */
        .distort-types, .warp-styles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .distort-type, .warp-style {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .distort-type:hover, .warp-style:hover { background: var(--primary); }
        .distort-options, .warp-options { margin-bottom: 12px; }
        
        /* ===== Ëø∑Âõ†Èù¢ÊùøÊ®£Âºè ===== */
        .meme-options { margin-bottom: 12px; }
        
        /* ===== Êµ∑Â†±Èù¢ÊùøÊ®£Âºè ===== */
        .poster-templates, .card-templates, .logo-templates {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .poster-template, .card-template, .logo-template {
            padding: 10px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .poster-template:hover, .card-template:hover, .logo-template:hover { background: var(--primary); }
        .poster-options { margin-bottom: 12px; }
        
        /* ===== ÂêçÁâáÈù¢ÊùøÊ®£Âºè ===== */
        .card-fields {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        /* ===== Ê©´ÂπÖÈù¢ÊùøÊ®£Âºè ===== */
        .banner-sizes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .banner-sizes button {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .banner-sizes button:hover { background: var(--primary); }
        .banner-options { margin-bottom: 12px; }
        
        /* ===== È†≠ÂÉèÈù¢ÊùøÊ®£Âºè ===== */
        .avatar-shapes, .avatar-sizes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .avatar-shape {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .avatar-shape.active { background: var(--primary); }
        .avatar-sizes button {
            padding: 8px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .avatar-sizes button:hover { background: var(--primary); }
        .avatar-options { margin-bottom: 12px; }
        
        /* ===== GIF Èù¢ÊùøÊ®£Âºè ===== */
        .gif-frames {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        .gif-frame-item {
            padding: 8px;
            background: var(--bg-dark);
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .gif-options { margin-bottom: 12px; }
        
        /* ===== Ë™øËâ≤Áõ§Èù¢ÊùøÊ®£Âºè ===== */
        .palette-extract { margin-bottom: 12px; }
        .palette-colors {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
            min-height: 50px;
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
        }
        .palette-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .palette-preset {
            padding: 8px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .palette-preset:hover { background: var(--primary); }
        
        /* ===== ÂèñËâ≤Âô®Èù¢ÊùøÊ®£Âºè ===== */
        .color-preview-large {
            width: 100%;
            height: 60px;
            border-radius: 10px;
            margin-bottom: 12px;
            background: #666;
        }
        .color-values {
            margin-bottom: 12px;
        }
        .color-value-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .color-value-row span {
            min-width: 45px;
            font-size: 11px;
        }
        .color-value-row input {
            flex: 1;
            padding: 6px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 11px;
            font-family: monospace;
        }
        .color-value-row button {
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .color-value-row button:hover { background: var(--primary); }
        .color-history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .color-history-item {
            width: 25px;
            height: 25px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* ===== ÂèÉËÄÉÁ∑öÈù¢ÊùøÊ®£Âºè ===== */
        .guide-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .guide-actions button {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .guide-actions button:hover { background: var(--primary); }
        .guide-list {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            min-height: 50px;
        }
        
        /* ===== Â∞çÈΩäÈù¢ÊùøÊ®£Âºè ===== */
        .align-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .align-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .align-buttons button {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .align-buttons button:hover { background: var(--primary); }
        
        /* ===== Ëâ≤ÁâàÈù¢ÊùøÊ®£Âºè ===== */
        .channel-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .channel-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
        }
        .channel-item:hover { background: var(--primary); }
        .channel-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        /* ===== ÁæéÈ°èÈÄ≤ÈöéÈù¢ÊùøÊ®£Âºè ===== */
        .slimface-info, .bigeye-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .slimface-options, .bigeye-options { margin-bottom: 12px; }
        
        /* ===== ÂΩ©Â¶ùÈù¢ÊùøÊ®£Âºè ===== */
        .makeup-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .makeup-type {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .makeup-type:hover { background: var(--primary); }
        .makeup-options { margin-bottom: 12px; }
        
        /* ===== ÂàÜÈõ¢Ëâ≤Ë™øÈù¢ÊùøÊ®£Âºè ===== */
        .splittone-options { margin-bottom: 12px; }
        
        /* ===== ÈõªÂΩ±Ë™øËâ≤Èù¢ÊùøÊ®£Âºè ===== */
        .colorgrade-presets {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .cg-preset {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .cg-preset:hover { background: var(--primary); }
        
        /* ===== LUT Èù¢ÊùøÊ®£Âºè ===== */
        .lut-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .lut-preset {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .lut-preset:hover { background: var(--primary); }
        .lut-options { margin-bottom: 12px; }
        
        /* ===== Âæ©Âè§/Â∫ïÁâáÈù¢ÊùøÊ®£Âºè ===== */
        .vintage-presets, .film-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .vintage-preset, .film-preset {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .vintage-preset:hover, .film-preset:hover { background: var(--primary); }
        
        /* ===== ÈõªÂΩ±ÊïàÊûúÈù¢ÊùøÊ®£Âºè ===== */
        .cinema-options {
            margin-bottom: 12px;
        }
        .cinema-ratio {
            margin-bottom: 12px;
        }
        .cinema-ratio select {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            margin-top: 5px;
        }
        
        /* ===== ÂàóÂç∞Èù¢ÊùøÊ®£Âºè ===== */
        .print-options { margin-bottom: 12px; }
        .print-options select {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            margin-top: 5px;
        }
        
        /* ===== ÂàÜ‰∫´Èù¢ÊùøÊ®£Âºè ===== */
        .share-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .share-btn {
            padding: 15px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
        }
        .share-btn:hover { background: var(--primary); }
        
        /* ===== Èõ≤Á´ØÈù¢ÊùøÊ®£Âºè ===== */
        .cloud-services {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .cloud-btn {
            flex: 1;
            padding: 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        .cloud-btn:hover { background: var(--primary); }
        .cloud-result {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 15px;
            min-height: 50px;
        }
        
        /* ===== Âø´Êç∑ÈçµÈù¢ÊùøÊ®£Âºè ===== */
        .shortcut-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-input);
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .shortcut-item span:first-child {
            background: var(--bg-dark);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* ===== Ë™™ÊòéÈù¢ÊùøÊ®£Âºè ===== */
        .help-sections {
            margin-bottom: 15px;
        }
        .help-sections details {
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .help-sections summary {
            padding: 12px;
            cursor: pointer;
            font-size: 13px;
        }
        .help-sections summary:hover { background: var(--bg-dark); }
        .help-sections p {
            padding: 0 12px 12px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        .help-links {
            display: flex;
            gap: 15px;
        }
        .help-links a {
            color: var(--primary);
            text-decoration: none;
            font-size: 12px;
        }
        .help-links a:hover { text-decoration: underline; }
        
        /* ===== Â±ÄÈÉ®ÂΩ©Ëâ≤Èù¢ÊùøÊ®£Âºè ===== */
        .colorsplash-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .colorsplash-options { margin-bottom: 12px; }
        
        /* ===== ÈªûÈô£ÂúñÈù¢ÊùøÊ®£Âºè ===== */
        .dotart-options { margin-bottom: 12px; }
        
        /* ===== ÈüøÊáâÂºèÈÄ≤ÈöéË™øÊï¥ ===== */
        @media (max-width: 768px) {
            .photofilter-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .colorgrade-presets {
                grid-template-columns: repeat(2, 1fr);
            }
            .share-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            .align-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .photofilter-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .lut-presets, .vintage-presets, .film-presets {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ===== ÂãïÁï´ÊïàÊûú ===== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .panel-title {
            animation: slideIn 0.3s ease;
        }
        
        .layer-item, .history-item, .batch-item {
            animation: fadeIn 0.2s ease;
        }
        
        /* ===== ÊªæÂãïÊ¢ùÁæéÂåñ ===== */
        .layer-list::-webkit-scrollbar,
        .history-list::-webkit-scrollbar,
        .batch-list::-webkit-scrollbar,
        .shortcut-list::-webkit-scrollbar,
        .sticker-grid::-webkit-scrollbar {
            width: 6px;
        }
        
        .layer-list::-webkit-scrollbar-track,
        .history-list::-webkit-scrollbar-track,
        .batch-list::-webkit-scrollbar-track,
        .shortcut-list::-webkit-scrollbar-track,
        .sticker-grid::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 3px;
        }
        
        .layer-list::-webkit-scrollbar-thumb,
        .history-list::-webkit-scrollbar-thumb,
        .batch-list::-webkit-scrollbar-thumb,
        .shortcut-list::-webkit-scrollbar-thumb,
        .sticker-grid::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
        
        /* ===== Â∑•ÂÖ∑ÊèêÁ§∫ ===== */
        .tool-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-dark);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }
        
        .tool-btn:hover .tool-tooltip {
            opacity: 1;
        }
        
        /* ===== ÈÄ≤Â∫¶ÊåáÁ§∫Âô® ===== */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-dark);
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* ===== ËºâÂÖ•ÂãïÁï´ ===== */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== ÊãñÊõ≥ÂçÄÂüüÊ®£Âºè ===== */
        .drop-zone-active {
            border-color: var(--primary) !important;
            background: rgba(99, 102, 241, 0.1) !important;
        }
        
        /* ===== ÈÅ∏È†ÖÂç°Ê®£Âºè ===== */
        .tab-container {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }
        
        .tab-item {
            padding: 8px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px 8px 0 0;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-item:hover {
            background: var(--bg-dark);
            color: white;
        }
        
        .tab-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* ===== Êï∏ÂÄºËº∏ÂÖ•Ê®£Âºè ===== */
        .number-input-group {
            display: flex;
            align-items: center;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .number-input-group button {
            width: 30px;
            height: 30px;
            background: var(--bg-dark);
            border: none;
            color: white;
            cursor: pointer;
        }
        
        .number-input-group button:hover {
            background: var(--primary);
        }
        
        .number-input-group input {
            flex: 1;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            padding: 5px;
        }
        
        /* ===== ÈñãÈóúÂàáÊèõÊ®£Âºè ===== */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-input);
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* ===== Ê®ôÁ±§Ê®£Âºè ===== */
        .tag {
            display: inline-block;
            padding: 3px 10px;
            background: var(--primary);
            color: white;
            border-radius: 15px;
            font-size: 10px;
            margin-right: 5px;
        }
        
        .tag.success { background: #10b981; }
        .tag.warning { background: #f59e0b; }
        .tag.danger { background: #ef4444; }
        .tag.info { background: #3b82f6; }
        
        /* ===== Âç°ÁâáÁ∂≤Ê†ºÊ®£Âºè ===== */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }
        
        .card-item {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .card-item:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }
        
        .card-item-icon {
            font-size: 30px;
            margin-bottom: 8px;
        }
        
        .card-item-label {
            font-size: 11px;
        }
        
        /* ===== Áµ±Ë®àÊï∏ÊìöÊ®£Âºè ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat-item {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        /* ===== ÊôÇÈñìËª∏Ê®£Âºè ===== */
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 15px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary);
        }
        
        .timeline-time {
            font-size: 10px;
            color: var(--text-secondary);
        }
        
        .timeline-content {
            font-size: 12px;
            margin-top: 3px;
        }
        
        /* ===== Êõ¥Â§öÂäüËÉΩÈù¢ÊùøÊ®£Âºè ===== */
        .meme-panel, .poster-panel, .banner-panel, .chart-panel, .diagram-panel,
        .timeline-panel, .infographic-panel, .businesscard-panel, .invoice-panel,
        .certificate-panel, .badge-panel, .avatar-panel, .thumbnail-panel,
        .cover-panel, .mockup-panel, .colorpalette-panel, .aienhance-panel,
        .aistyle-panel, .hsl-panel, .levels-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .meme-panel.show, .poster-panel.show, .banner-panel.show, .chart-panel.show,
        .diagram-panel.show, .timeline-panel.show, .infographic-panel.show,
        .businesscard-panel.show, .invoice-panel.show, .certificate-panel.show,
        .badge-panel.show, .avatar-panel.show, .thumbnail-panel.show, .cover-panel.show,
        .mockup-panel.show, .colorpalette-panel.show, .aienhance-panel.show,
        .aistyle-panel.show, .hsl-panel.show, .levels-panel.show { display: block; }
        
        /* Ê¢óÂúñÈù¢Êùø */
        .meme-templates {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .meme-template {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .meme-template.active { background: var(--primary); }
        .meme-inputs {
            margin-bottom: 12px;
        }
        .meme-inputs label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin: 8px 0 4px;
        }
        .meme-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        
        /* Êµ∑Â†±Èù¢Êùø */
        .poster-styles, .card-styles, .cert-styles, .badge-shapes, .avatar-shapes,
        .thumbnail-platforms, .cover-types, .mockup-devices, .ai-enhance-options,
        .ai-styles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .poster-style, .card-style, .cert-style, .badge-shape, .avatar-shape,
        .thumb-platform, .cover-type, .mockup-device, .ai-enhance-btn, .ai-style-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
        }
        .poster-style:hover, .card-style:hover, .cert-style:hover, .badge-shape:hover,
        .avatar-shape:hover, .thumb-platform:hover, .cover-type:hover, .mockup-device:hover,
        .ai-enhance-btn:hover, .ai-style-btn:hover { background: var(--primary); }
        
        /* Ê©´ÂπÖÈù¢Êùø */
        .banner-colors {
            display: flex;
            gap: 15px;
            margin: 12px 0;
        }
        .banner-sizes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .banner-size-item {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
        }
        .banner-size-item:hover { background: var(--primary); }
        
        /* ÂúñË°®Èù¢Êùø */
        .chart-types, .diagram-shapes, .infographic-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        .chart-type, .diagram-shape, .info-type {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
        }
        .chart-type:hover, .diagram-shape:hover, .info-type:hover { background: var(--primary); }
        
        /* Ëâ≤ÂΩ©ÂàÜÊûê */
        .palette-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .palette-color {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .palette-color:hover { transform: scale(1.1); }
        .palette-info {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
        }
        
        /* HSL/Ëâ≤ÈöéÈù¢Êùø */
        .hsl-sliders, .levels-sliders {
            margin-bottom: 15px;
        }
        .panel-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .text-input-area {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            margin-bottom: 10px;
        }
        .text-input-area:focus { outline: none; border-color: var(--primary); }
        .text-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .option-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-input);
            padding: 5px 10px;
            border-radius: 8px;
        }
        .option-group label { font-size: 11px; color: var(--text-secondary); }
        .option-group input[type="number"] {
            width: 50px;
            padding: 4px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 12px;
        }
        .option-group input[type="color"] {
            width: 30px; height: 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .style-btn {
            width: 32px; height: 32px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        .style-btn.active { background: var(--primary); border-color: var(--primary); }
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .eyedropper-btn {
            width: 32px; height: 32px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .eyedropper-btn.active { background: var(--warning); }
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .action-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .action-btn.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .action-btn.danger { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
        .action-btn.success { background: linear-gradient(135deg, var(--success), #16a34a); color: white; }
        
        /* ===== ‰∏ãËºâÈù¢Êùø ===== */
        .download-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
        .download-panel.show { display: block; }
        .download-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .download-btn {
            flex: 1;
            min-width: 140px;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .download-btn:hover { transform: translateY(-3px); }
        .download-btn .icon { font-size: 24px; }
        .download-btn.png { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
        .download-btn.pdf { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        .download-btn.line { background: linear-gradient(135deg, #00c300, #00e000); color: white; }
        
        /* ===== ‰ΩøÁî®Ë™™Êòé ===== */
        .help-panel {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
        .help-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .help-list { list-style: none; }
        .help-list li {
            padding: 8px 0;
            font-size: 12px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .help-list li:last-child { border-bottom: none; }
        .help-list .icon { font-size: 16px; flex-shrink: 0; }
        
        /* ===== Â∫ïÈÉ®Â∞éËà™ ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 5px 15px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 10px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-item .icon { font-size: 22px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active .icon { transform: scale(1.1); }
        
        /* ===== È†ÅÈù¢ÂàáÊèõ ===== */
        .page { display: none; }
        .page.active { display: block; }
        
        /* ===== Ë®≠ÂÆöÈ†Å ===== */
        .settings-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .settings-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .setting-item:last-child { border-bottom: none; }
        .setting-item label { font-size: 12px; color: var(--text-secondary); }
        .setting-item input {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 13px;
        }
        .save-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .clear-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        .toggle-pwd-btn {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-line-btn {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #00C300, #00a000);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* ===== Toast ===== */
        #toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 13px;
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s;
            white-space: nowrap;
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        /* ===== ÈüøÊáâÂºè ===== */
        @media (min-width: 768px) {
            .app-container { max-width: 800px; margin: 0 auto; }
            .canvas-container { max-height: 75vh; }
            #mainCanvas { max-height: calc(75vh - 20px); }
        }
        @media (min-width: 1024px) {
            .app-container { max-width: 1000px; }
            .canvas-container { max-height: 80vh; }
            #mainCanvas { max-height: calc(80vh - 20px); }
        }
    </style>
</head>
<body>
    <!-- ÈñãÊ©üÂãïÁï´ -->
    <div id="splashScreen">
        <div class="splash-logo">üé©</div>
        <div class="splash-title">ÂúñÊñáÈ≠îË°ìÂ∏´</div>
        <div class="splash-version">V2.0 ÁµÇÊ•µÁâà</div>
        <div class="splash-loading"></div>
    </div>
    
    <!-- ÁØÄÊÖ∂ÊïàÊûúÂÆπÂô® -->
    <div id="festivalEffect"></div>
    
    <!-- ‰∏ªÂÆπÂô® -->
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <span class="header-logo">üé©</span>
                <span class="header-title">ÂúñÊñáÈ≠îË°ìÂ∏´<span class="header-version">V2.0</span></span>
            </div>
            <div class="header-right">
                <span class="header-time" id="headerTime">--:--</span>
                <span class="header-festival" id="headerFestival">üéä</span>
            </div>
        </header>
        
        <!-- È¶ñÈ†Å -->
        <div class="page active" id="page-home">
            <!-- Â∑•ÂÖ∑Âàó -->
            <div class="toolbar">
                <button class="tool-btn" onclick="triggerUpload('image')"><span class="icon">üñºÔ∏è</span>ÂúñÁâá</button>
                <button class="tool-btn" onclick="triggerUpload('pdf')"><span class="icon">üìÑ</span>PDF</button>
                <button class="tool-btn" onclick="pasteFromClipboard()"><span class="icon">üìã</span>Ë≤º‰∏ä</button>
                <button class="tool-btn" onclick="takePhoto()"><span class="icon">üì∑</span>ÊãçÁÖß</button>
                <button class="tool-btn" id="selectBtn" onclick="setTool('select')" disabled><span class="icon">‚úÇÔ∏è</span>ÈÅ∏Âèñ</button>
                <button class="tool-btn" id="clearBtn" onclick="clearSelection()" disabled><span class="icon">üßπ</span>Ê∏ÖÈô§</button>
                <button class="tool-btn" id="undoBtn" onclick="undoAction()" disabled><span class="icon">‚Ü©Ô∏è</span>Âæ©Âéü</button>
                <button class="tool-btn" id="resetBtn" onclick="resetCanvas()" disabled><span class="icon">üóëÔ∏è</span>ÈáçÁΩÆ</button>
                <button class="tool-btn" id="aiBtn" onclick="showAIPanel()" disabled><span class="icon">ü§ñ</span>AI</button>
                <button class="tool-btn" id="pdfToolBtn" onclick="showPdfToolPanel()" style="display:none"><span class="icon">üìë</span>ÊãÜÂàÜ</button>
                <button class="tool-btn" id="watermarkBtn" onclick="showWatermarkPanel()" disabled><span class="icon">üí¶</span>ÊµÆÊ∞¥Âç∞</button>
                <button class="tool-btn" id="mosaicBtn" onclick="setTool('mosaic')" disabled><span class="icon">üî≤</span>È¶¨Ë≥ΩÂÖã</button>
                <button class="tool-btn" id="stampBtn" onclick="showStampPanel()" disabled><span class="icon">üîñ</span>ÂúñÁ´†</button>
                <button class="tool-btn" id="signBtn" onclick="showSignPanel()" disabled><span class="icon">‚úçÔ∏è</span>Á∞ΩÂêç</button>
                <button class="tool-btn" id="filterBtn" onclick="showFilterPanel()" disabled><span class="icon">üé®</span>ÊøæÈè°</button>
                <button class="tool-btn" id="adjustBtn" onclick="showAdjustPanel()" disabled><span class="icon">üåà</span>Ë™øÊï¥</button>
                <button class="tool-btn" id="frameBtn" onclick="showFramePanel()" disabled><span class="icon">üñºÔ∏è</span>ÈÇäÊ°Ü</button>
                <button class="tool-btn" id="stickerBtn" onclick="showStickerPanel()" disabled><span class="icon">üòÄ</span>Ë≤ºÂúñ</button>
                <button class="tool-btn" id="arrowBtn" onclick="showArrowPanel()" disabled><span class="icon">‚û°Ô∏è</span>ÁÆ≠È†≠</button>
                <button class="tool-btn" id="rotateBtn" onclick="rotateImage90()" disabled><span class="icon">üîÑ</span>ÊóãËΩâ</button>
                <button class="tool-btn" id="flipHBtn" onclick="flipImage('h')" disabled><span class="icon">‚ÜîÔ∏è</span>Ê∞¥Âπ≥Áøª</button>
                <button class="tool-btn" id="flipVBtn" onclick="flipImage('v')" disabled><span class="icon">‚ÜïÔ∏è</span>ÂûÇÁõ¥Áøª</button>
                <button class="tool-btn" id="cropBtn" onclick="showCropPanel()" disabled><span class="icon">‚¨ú</span>Ë£ÅÂàá</button>
                <button class="tool-btn" id="mergeBtn" onclick="showMergePanel()" disabled><span class="icon">üìê</span>ÊãºÊé•</button>
                <button class="tool-btn" id="qrBtn" onclick="showQRPanel()" disabled><span class="icon">üì±</span>QRÁ¢º</button>
                <button class="tool-btn" id="compressBtn" onclick="showCompressPanel()" disabled><span class="icon">üì¶</span>Â£ìÁ∏Æ</button>
                <!-- Êñ∞Â¢ûÂäüËÉΩ -->
                <button class="tool-btn" id="brushBtn" onclick="showBrushPanel()" disabled><span class="icon">üñåÔ∏è</span>Áï´Á≠Ü</button>
                <button class="tool-btn" id="shapeBtn" onclick="showShapePanel()" disabled><span class="icon">‚≠ï</span>ÂΩ¢ÁãÄ</button>
                <button class="tool-btn" id="textFxBtn" onclick="showTextFxPanel()" disabled><span class="icon">üî§</span>ÊñáÂ≠óÁâπÊïà</button>
                <button class="tool-btn" id="templateBtn" onclick="showTemplatePanel()"><span class="icon">üìã</span>Ê®°Êùø</button>
                <button class="tool-btn" id="collageBtn" onclick="showCollagePanel()" disabled><span class="icon">üß©</span>ÊãºË≤º</button>
                <button class="tool-btn" id="beautyBtn" onclick="showBeautyPanel()" disabled><span class="icon">‚ú®</span>ÁæéÈ°è</button>
                <button class="tool-btn" id="removeBgBtn" onclick="showRemoveBgPanel()" disabled><span class="icon">üé≠</span>ÂéªËÉå</button>
                <button class="tool-btn" id="batchBtn" onclick="showBatchPanel()" disabled><span class="icon">üìö</span>ÊâπÊ¨°</button>
                <button class="tool-btn" id="effectBtn" onclick="showEffectPanel()" disabled><span class="icon">üí´</span>ÁâπÊïà</button>
                <button class="tool-btn" id="overlayBtn" onclick="showOverlayPanel()" disabled><span class="icon">üé¥</span>ÁñäÂä†</button>
                <button class="tool-btn" id="annotateBtn" onclick="showAnnotatePanel()" disabled><span class="icon">üìù</span>ÊâπË®ª</button>
                <button class="tool-btn" id="measureBtn" onclick="setTool('measure')" disabled><span class="icon">üìè</span>Ê∏¨Èáè</button>
                <button class="tool-btn" id="gridBtn" onclick="toggleGrid()" disabled><span class="icon">üìê</span>Á∂≤Ê†º</button>
                <button class="tool-btn" id="historyBtn" onclick="showHistoryPanel()" disabled><span class="icon">üìú</span>Ê≠∑Âè≤</button>
                <button class="tool-btn" id="infoBtn" onclick="showInfoPanel()" disabled><span class="icon">‚ÑπÔ∏è</span>Ë≥áË®ä</button>
                <button class="tool-btn" id="colorReplaceBtn" onclick="showColorReplacePanel()" disabled><span class="icon">üé®</span>ÊèõËâ≤</button>
                <button class="tool-btn" id="compareBtn" onclick="toggleCompare()" disabled><span class="icon">üîÄ</span>ÊØîËºÉ</button>
                <button class="tool-btn" id="idPhotoBtn" onclick="showIdPhotoPanel()" disabled><span class="icon">ü™™</span>Ë≠â‰ª∂ÁÖß</button>
                <button class="tool-btn" id="screenshotBtn" onclick="showScreenshotPanel()" disabled><span class="icon">üì≤</span>Êà™ÂúñÁæéÂåñ</button>
                <button class="tool-btn" id="pixelArtBtn" onclick="showPixelArtPanel()" disabled><span class="icon">üëæ</span>ÂÉèÁ¥†Áï´</button>
                <button class="tool-btn" id="asciiBtn" onclick="showAsciiPanel()" disabled><span class="icon">üíª</span>ASCII</button>
                <button class="tool-btn" id="cartoonBtn" onclick="applyCartoon()" disabled><span class="icon">üé®</span>Âç°ÈÄöÂåñ</button>
                <button class="tool-btn" id="sketchBtn" onclick="applySketch()" disabled><span class="icon">‚úèÔ∏è</span>Á¥†Êèè</button>
                <button class="tool-btn" id="oilPaintBtn" onclick="applyOilPaint()" disabled><span class="icon">üñºÔ∏è</span>Ê≤πÁï´</button>
                <button class="tool-btn" id="glitchBtn" onclick="applyGlitch()" disabled><span class="icon">üì∫</span>ÊïÖÈöú</button>
                <button class="tool-btn" id="duotoneBtn" onclick="showDuotonePanel()" disabled><span class="icon">üé≠</span>ÈõôËâ≤Ë™ø</button>
                <button class="tool-btn" id="gradientBtn" onclick="showGradientPanel()" disabled><span class="icon">üåÖ</span>Êº∏Â±§</button>
                <button class="tool-btn" id="vignetteBtn" onclick="applyVignette()" disabled><span class="icon">üîò</span>ÊöàÂΩ±</button>
                <button class="tool-btn" id="noiseBtn" onclick="showNoisePanel()" disabled><span class="icon">üìª</span>ÈõúË®ä</button>
                <button class="tool-btn" id="blurBgBtn" onclick="showBlurBgPanel()" disabled><span class="icon">üå´Ô∏è</span>ËÉåÊôØÊ®°Á≥ä</button>
                <button class="tool-btn" id="textureBtn" onclick="showTexturePanel()" disabled><span class="icon">üß±</span>Á¥ãÁêÜ</button>
                <button class="tool-btn" id="lightLeakBtn" onclick="applyLightLeak()" disabled><span class="icon">‚òÄÔ∏è</span>ÊºèÂÖâ</button>
                <button class="tool-btn" id="bokehBtn" onclick="showBokehPanel()" disabled><span class="icon">üí°</span>Êï£ÊôØ</button>
                <button class="tool-btn" id="tiltShiftBtn" onclick="applyTiltShift()" disabled><span class="icon">üèôÔ∏è</span>ÁßªËª∏</button>
                <button class="tool-btn" id="mirrorBtn" onclick="showMirrorPanel()" disabled><span class="icon">ü™û</span>Èè°ÂÉè</button>
                <button class="tool-btn" id="kaleidoBtn" onclick="applyKaleidoscope()" disabled><span class="icon">üîÆ</span>Ëê¨Ëä±Á≠í</button>
                <button class="tool-btn" id="splitBtn" onclick="showSplitPanel()" disabled><span class="icon">üî≤</span>ÂàÜÂâ≤</button>
                <button class="tool-btn" id="socialBtn" onclick="showSocialPanel()" disabled><span class="icon">üì±</span>Á§æÁæ§</button>
                <button class="tool-btn" id="exportBtn" onclick="showExportPanel()" disabled><span class="icon">üíæ</span>ÂåØÂá∫</button>
                <!-- Êõ¥Â§öÈÄ≤ÈöéÂäüËÉΩ -->
                <button class="tool-btn" id="layerBtn" onclick="showLayerPanel()" disabled><span class="icon">üìö</span>ÂúñÂ±§</button>
                <button class="tool-btn" id="cloneBtn" onclick="setTool('clone')" disabled><span class="icon">üîÑ</span>‰ªøË£Ω</button>
                <button class="tool-btn" id="healBtn" onclick="setTool('heal')" disabled><span class="icon">ü©π</span>‰øÆÂæ©</button>
                <button class="tool-btn" id="liquifyBtn" onclick="showLiquifyPanel()" disabled><span class="icon">üíß</span>Ê∂≤Âåñ</button>
                <button class="tool-btn" id="hdrBtn" onclick="applyHDR()" disabled><span class="icon">üåü</span>HDR</button>
                <button class="tool-btn" id="curveBtn" onclick="showCurvePanel()" disabled><span class="icon">üìà</span>Êõ≤Á∑ö</button>
                <button class="tool-btn" id="levelBtn" onclick="showLevelPanel()" disabled><span class="icon">üìä</span>Ëâ≤Èöé</button>
                <button class="tool-btn" id="histogramBtn" onclick="showHistogramPanel()" disabled><span class="icon">üìâ</span>Áõ¥ÊñπÂúñ</button>
                <button class="tool-btn" id="colorBalanceBtn" onclick="showColorBalancePanel()" disabled><span class="icon">‚öñÔ∏è</span>Ëâ≤ÂΩ©Âπ≥Ë°°</button>
                <button class="tool-btn" id="selectiveColorBtn" onclick="showSelectiveColorPanel()" disabled><span class="icon">üéØ</span>ÈÅ∏ÊìáÊÄßË™øËâ≤</button>
                <button class="tool-btn" id="photoFilterBtn" onclick="showPhotoFilterPanel()" disabled><span class="icon">üì∑</span>Áõ∏ÁâáÊøæÈè°</button>
                <button class="tool-btn" id="lensBlurBtn" onclick="showLensBlurPanel()" disabled><span class="icon">üî≠</span>Èè°È†≠Ê®°Á≥ä</button>
                <button class="tool-btn" id="motionBlurBtn" onclick="showMotionBlurPanel()" disabled><span class="icon">üí®</span>ÂãïÊÖãÊ®°Á≥ä</button>
                <button class="tool-btn" id="zoomBlurBtn" onclick="applyZoomBlur()" disabled><span class="icon">üîç</span>ÊîæÂ∞ÑÊ®°Á≥ä</button>
                <button class="tool-btn" id="perspectiveBtn" onclick="showPerspectivePanel()" disabled><span class="icon">üìê</span>ÈÄèË¶ñ</button>
                <button class="tool-btn" id="distortBtn" onclick="showDistortPanel()" disabled><span class="icon">üåÄ</span>Êâ≠Êõ≤</button>
                <button class="tool-btn" id="warpBtn" onclick="showWarpPanel()" disabled><span class="icon">„Ä∞Ô∏è</span>ÂΩéÊõ≤</button>
                <button class="tool-btn" id="memeBtn" onclick="showMemePanel()" disabled><span class="icon">üòÇ</span>Ëø∑Âõ†</button>
                <button class="tool-btn" id="posterBtn" onclick="showPosterPanel()" disabled><span class="icon">üé®</span>Êµ∑Â†±</button>
                <button class="tool-btn" id="cardBtn" onclick="showCardPanel()" disabled><span class="icon">üí≥</span>ÂêçÁâá</button>
                <button class="tool-btn" id="bannerBtn" onclick="showBannerPanel()" disabled><span class="icon">üè∑Ô∏è</span>Ê©´ÂπÖ</button>
                <button class="tool-btn" id="avatarBtn" onclick="showAvatarPanel()" disabled><span class="icon">üë§</span>È†≠ÂÉè</button>
                <button class="tool-btn" id="logoBtn" onclick="showLogoPanel()" disabled><span class="icon">üè¢</span>Logo</button>
                <button class="tool-btn" id="gifBtn" onclick="showGifPanel()" disabled><span class="icon">üé¨</span>GIF</button>
                <button class="tool-btn" id="colorPaletteBtn" onclick="showColorPalettePanel()" disabled><span class="icon">üé®</span>Ë™øËâ≤Áõ§</button>
                <button class="tool-btn" id="eyeDropperAdvBtn" onclick="showEyeDropperAdvPanel()" disabled><span class="icon">üíâ</span>ÂèñËâ≤Âô®</button>
                <button class="tool-btn" id="rulerBtn" onclick="toggleRuler()" disabled><span class="icon">üìè</span>Â∞∫Ë¶è</button>
                <button class="tool-btn" id="guideBtn" onclick="showGuidePanel()" disabled><span class="icon">üìç</span>ÂèÉËÄÉÁ∑ö</button>
                <button class="tool-btn" id="alignBtn" onclick="showAlignPanel()" disabled><span class="icon">üìê</span>Â∞çÈΩä</button>
                <button class="tool-btn" id="magicWandBtn" onclick="setTool('magicWand')" disabled><span class="icon">ü™Ñ</span>È≠îË°ìÊ£í</button>
                <button class="tool-btn" id="lassoBtn" onclick="setTool('lasso')" disabled><span class="icon">üîó</span>Â•óÁ¥¢</button>
                <button class="tool-btn" id="penToolBtn" onclick="setTool('penTool')" disabled><span class="icon">üñäÔ∏è</span>ÈãºÁ≠Ü</button>
                <button class="tool-btn" id="channelBtn" onclick="showChannelPanel()" disabled><span class="icon">üì∫</span>Ëâ≤Áâà</button>
                <button class="tool-btn" id="autoEnhanceBtn" onclick="autoEnhance()" disabled><span class="icon">‚ú®</span>Ëá™ÂãïÂ¢ûÂº∑</button>
                <button class="tool-btn" id="autoColorBtn" onclick="autoColor()" disabled><span class="icon">üåà</span>Ëá™ÂãïËâ≤ÂΩ©</button>
                <button class="tool-btn" id="autoContrastBtn" onclick="autoContrast()" disabled><span class="icon">üé≠</span>Ëá™ÂãïÂ∞çÊØî</button>
                <button class="tool-btn" id="autoLevelBtn" onclick="autoLevel()" disabled><span class="icon">üìä</span>Ëá™ÂãïËâ≤Èöé</button>
                <button class="tool-btn" id="redEyeBtn" onclick="setTool('redEye')" disabled><span class="icon">üëÅÔ∏è</span>Á¥ÖÁúº</button>
                <button class="tool-btn" id="blemishBtn" onclick="setTool('blemish')" disabled><span class="icon">‚ú®</span>ÂéªÊñë</button>
                <button class="tool-btn" id="whiteTeethBtn" onclick="setTool('whiteTeeth')" disabled><span class="icon">üòÅ</span>ÁæéÁôΩÁâôÈΩí</button>
                <button class="tool-btn" id="slimFaceBtn" onclick="showSlimFacePanel()" disabled><span class="icon">üßë</span>Áò¶Ëáâ</button>
                <button class="tool-btn" id="bigEyeBtn" onclick="showBigEyePanel()" disabled><span class="icon">üëÄ</span>Â§ßÁúº</button>
                <button class="tool-btn" id="makeupBtn" onclick="showMakeupPanel()" disabled><span class="icon">üíÑ</span>ÂΩ©Â¶ù</button>
                <button class="tool-btn" id="faceSwapBtn" onclick="showFaceSwapPanel()" disabled><span class="icon">üé≠</span>ÊèõËáâ</button>
                <button class="tool-btn" id="bgBlurPortraitBtn" onclick="applyPortraitBlur()" disabled><span class="icon">üñºÔ∏è</span>‰∫∫ÂÉèÊ®°Á≥ä</button>
                <button class="tool-btn" id="skeletonBtn" onclick="showSkeletonPanel()" disabled><span class="icon">ü¶¥</span>È™®Êû∂</button>
                <button class="tool-btn" id="outlineBtn" onclick="applyOutlineEffect()" disabled><span class="icon">‚úèÔ∏è</span>ÊèèÈÇä</button>
                <button class="tool-btn" id="dotArtBtn" onclick="showDotArtPanel()" disabled><span class="icon">‚ö´</span>ÈªûÈô£Âúñ</button>
                <button class="tool-btn" id="lowPolyBtn" onclick="applyLowPoly()" disabled><span class="icon">üî∫</span>‰ΩéÂ§öÈÇäÂΩ¢</button>
                <button class="tool-btn" id="mosaic2Btn" onclick="showMosaicArtPanel()" disabled><span class="icon">üß±</span>È¶¨Ë≥ΩÂÖãËóùË°ì</button>
                <button class="tool-btn" id="colorSplashBtn" onclick="showColorSplashPanel()" disabled><span class="icon">üí¶</span>Â±ÄÈÉ®ÂΩ©Ëâ≤</button>
                <button class="tool-btn" id="miniatureBtn" onclick="applyMiniature()" disabled><span class="icon">üè†</span>ÂæÆÁ∏Æ</button>
                <button class="tool-btn" id="infraredBtn" onclick="applyInfrared()" disabled><span class="icon">üî¥</span>Á¥ÖÂ§ñÁ∑ö</button>
                <button class="tool-btn" id="crossProcessBtn" onclick="applyCrossProcess()" disabled><span class="icon">üéûÔ∏è</span>‰∫§ÂèâÊ≤ñÂç∞</button>
                <button class="tool-btn" id="bleachBypassBtn" onclick="applyBleachBypass()" disabled><span class="icon">ü•õ</span>ÊºÇÁôΩ</button>
                <button class="tool-btn" id="splitToneBtn" onclick="showSplitTonePanel()" disabled><span class="icon">üé®</span>ÂàÜÈõ¢Ëâ≤Ë™ø</button>
                <button class="tool-btn" id="colorGradeBtn" onclick="showColorGradePanel()" disabled><span class="icon">üé¨</span>Ë™øËâ≤</button>
                <button class="tool-btn" id="lutBtn" onclick="showLutPanel()" disabled><span class="icon">üé•</span>LUT</button>
                <button class="tool-btn" id="vintageBtn" onclick="showVintagePanel()" disabled><span class="icon">üìª</span>Âæ©Âè§</button>
                <button class="tool-btn" id="filmBtn" onclick="showFilmPanel()" disabled><span class="icon">üéûÔ∏è</span>Â∫ïÁâá</button>
                <button class="tool-btn" id="cinemaBtn" onclick="showCinemaPanel()" disabled><span class="icon">üé¨</span>ÈõªÂΩ±</button>
                <button class="tool-btn" id="printBtn" onclick="showPrintPanel()" disabled><span class="icon">üñ®Ô∏è</span>ÂàóÂç∞</button>
                <button class="tool-btn" id="shareBtn" onclick="showSharePanel()" disabled><span class="icon">üì§</span>ÂàÜ‰∫´</button>
                <button class="tool-btn" id="cloudBtn" onclick="showCloudPanel()" disabled><span class="icon">‚òÅÔ∏è</span>Èõ≤Á´Ø</button>
                <button class="tool-btn" id="shortcutBtn" onclick="showShortcutPanel()"><span class="icon">‚å®Ô∏è</span>Âø´Êç∑Èçµ</button>
                <button class="tool-btn" id="themeBtn" onclick="toggleTheme()"><span class="icon">üé®</span>‰∏ªÈ°å</button>
                <button class="tool-btn" id="helpBtn" onclick="showHelpPanel()"><span class="icon">‚ùì</span>Ë™™Êòé</button>
            </div>
            
            <!-- PDF ÊéßÂà∂Âàó -->
            <div class="pdf-controls" id="pdfControls">
                <button class="pdf-nav-btn" id="prevPage" onclick="changePage(-1)">‚óÄ</button>
                <span class="pdf-page-info"><span id="currentPage">1</span> / <span id="totalPages">1</span></span>
                <button class="pdf-nav-btn" id="nextPage" onclick="changePage(1)">‚ñ∂</button>
            </div>
            
            <!-- Á∑®ËºØÂçÄ -->
            <div class="editor-area">
                <!-- ‰∏äÂÇ≥ÂçÄ -->
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">‚ú®</div>
                    <div class="upload-title">ÈñãÂßã‰Ω†ÁöÑÈ≠îÊ≥ï‰øÆÂúñ</div>
                    <div class="upload-subtitle">ÊîØÊè¥ JPG„ÄÅPNG„ÄÅPDFÔΩúÂèØÁõ¥Êé•Ë≤º‰∏äÊà™Âúñ</div>
                    <div class="upload-buttons">
                        <button class="upload-btn primary" onclick="triggerUpload('image')">üñºÔ∏è ÈÅ∏ÊìáÂúñÁâá</button>
                        <button class="upload-btn primary" onclick="triggerUpload('pdf')">üìÑ ÈÅ∏Êìá PDF</button>
                        <button class="upload-btn secondary" onclick="pasteFromClipboard()">üìã Ë≤º‰∏äÊà™Âúñ</button>
                        <button class="upload-btn secondary" onclick="takePhoto()">üì∑ ÊãçÁÖß</button>
                    </div>
                    
                    <!-- È¶ñÈ†Å‰ΩøÁî®Ë™™ÊòéÔºàÂú®‰∏äÂÇ≥ÂçÄÂÖßÔºåÈ†êË®≠È°ØÁ§∫Ôºâ -->
                    <div class="home-guide" id="homeGuide">
                        <div class="guide-title">üé© Ê≠°Ëøé‰æÜÂà∞ÂúñÊñáÈ≠îË°ìÂ∏´ÔºÅ</div>
                        <div class="guide-intro">
                            Ë∂ÖÂº∑ÁÄèË¶ΩÂô®ÂúñÁâáÁ∑®ËºØÂô®Ôºå‰∏çÁî®Ë£ùËªüÈ´îÔºåÊâìÈñãÂ∞±ËÉΩÁî®ÔºÅ
                        </div>
                        
                        <div class="guide-steps">
                            <div class="guide-step"><span class="step-icon">1Ô∏è‚É£</span> ‰∏äÂÇ≥ÂúñÁâáÊàñ PDFÔºå‰πüÂèØ‰ª• Ctrl+V Ë≤º‰∏äÊà™Âúñ</div>
                            <div class="guide-step"><span class="step-icon">2Ô∏è‚É£</span> Áî®‰∏äÊñπ 133 ÂÄãÂ∑•ÂÖ∑Áõ°ÊÉÖÁ∑®ËºØ</div>
                            <div class="guide-step"><span class="step-icon">3Ô∏è‚É£</span> ÂÆåÊàêÂæå‰∏ãËºâÊàñÊé®ÈÄÅÂà∞ LINE</div>
                        </div>
                        
                        <div class="guide-features">
                            <button class="feature-tag" onclick="scrollToTool('brushBtn')">üñåÔ∏è Áπ™Âúñ</button>
                            <button class="feature-tag" onclick="scrollToTool('filterBtn')">üé® ÊøæÈè°</button>
                            <button class="feature-tag" onclick="scrollToTool('beautyBtn')">‚ú® ÁæéÈ°è</button>
                            <button class="feature-tag" onclick="scrollToTool('watermarkBtn')">üí¶ ÊµÆÊ∞¥Âç∞</button>
                            <button class="feature-tag" onclick="scrollToTool('idPhotoBtn')">ü™™ Ë≠â‰ª∂ÁÖß</button>
                            <button class="feature-tag" onclick="scrollToTool('aiBtn')">ü§ñ AI Ëß£Êûê</button>
                            <button class="feature-tag" onclick="scrollToTool('pdfToolBtn')">üìë PDF</button>
                            <button class="feature-tag" onclick="scrollToTool('curveBtn')">üìà Êõ≤Á∑ö</button>
                        </div>
                        <div class="guide-hint">üëÜ ÈªûÊìä‰∏äÊñπÊ®ôÁ±§ÂèØÂø´ÈÄüË∑≥Âà∞Â∞çÊáâÂ∑•ÂÖ∑ÔºàÈúÄÂÖà‰∏äÂÇ≥ÂúñÁâáÔºâ</div>
                    </div>
                </div>
                
                <!-- Áï´Â∏ÉÂçÄ -->
                <div class="canvas-wrapper" id="canvasWrapper">
                    <div class="canvas-info-bar">
                        <span id="canvasInfo">0 x 0</span>
                        <div class="canvas-quick-tools">
                            <button class="quick-btn" id="selectBtn2" onclick="setTool('select')" title="ÈÅ∏Âèñ">‚úÇÔ∏è</button>
                            <button class="quick-btn" id="clearBtn2" onclick="clearSelection()" title="Ê∏ÖÈô§ÈÅ∏Âèñ">üßπ</button>
                            <button class="quick-btn" id="undoBtn2" onclick="undoAction()" title="Âæ©Âéü">‚Ü©Ô∏è</button>
                            <button class="quick-btn danger" id="resetBtn2" onclick="resetCanvas()" title="ÈáçÁΩÆ">üóëÔ∏è</button>
                        </div>
                        <div class="zoom-controls">
                            <button class="zoom-btn" onclick="zoomCanvas(-0.1)" title="Á∏ÆÂ∞è">‚ûñ</button>
                            <span id="zoomInfo" onclick="resetZoom()" title="ÈªûÊìäÈáçÁΩÆ">100%</span>
                            <button class="zoom-btn" onclick="zoomCanvas(0.1)" title="ÊîæÂ§ß">‚ûï</button>
                            <button class="zoom-btn fit" onclick="fitToScreen()" title="ÈÅ©ÂêàËû¢Âπï">üî≤</button>
                        </div>
                    </div>
                    <div class="canvas-container" id="canvasContainer">
                        <canvas id="mainCanvas"></canvas>
                        <div class="drag-layer" id="dragLayer"></div>
                        <div class="selection-box" id="selectionBox"></div>
                    </div>
                    <div class="drag-controls" id="dragControls">
                        <span class="drag-hint">üéØ ÊãñÊõ≥Ë™øÊï¥‰ΩçÁΩÆ</span>
                        <button class="drag-btn confirm" onclick="confirmDragObject()">‚úÖ Á¢∫Ë™ç</button>
                        <button class="drag-btn cancel" onclick="cancelDragObject()">‚ùå ÂèñÊ∂à</button>
                    </div>
                    <div class="zoom-hint">üí° ÈõôÊåáÁ∏ÆÊîæ | ÊªæËº™Á∏ÆÊîæ | ÈõôÊìäÈáçÁΩÆ</div>
                </div>
                
                <!-- AI ÂàÜÊûêÈù¢Êùø -->
                <div class="ai-panel" id="aiPanel">
                    <div class="panel-title">ü§ñ AI ÂúñÊñáËß£Êûê</div>
                    <div class="ai-model-select">
                        <label>ÈÅ∏ÊìáÊ®°ÂûãÔºö</label>
                        <select id="aiModel">
                            <optgroup label="üíé GeminiÔºàÂÖçË≤ªÔºâ">
                                <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                            </optgroup>
                            <optgroup label="üíé GeminiÔºà‰ªòË≤ªÔºâ">
                                <option value="gemini-2.5-pro">üí∞ Gemini 2.5 Pro</option>
                                <option value="gemini-3.0-pro">üí∞ Gemini 3.0 Pro</option>
                            </optgroup>
                            <optgroup label="‚ö° GroqÔºàÂÖçË≤ªÔºâ">
                                <option value="llama-4-scout">Llama 4 Scout</option>
                                <option value="llama-4-maverick">Llama 4 Maverick</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="ai-options">
                        <label class="ai-option">
                            <input type="radio" name="aiMode" value="ocr" checked>
                            <span>üìù ÊñáÂ≠óËæ®Ë≠ò</span>
                        </label>
                        <label class="ai-option">
                            <input type="radio" name="aiMode" value="describe">
                            <span>üîç ÂúñÁâáÊèèËø∞</span>
                        </label>
                        <label class="ai-option">
                            <input type="radio" name="aiMode" value="translate">
                            <span>üåê ÁøªË≠ØÂÖßÂÆπ</span>
                        </label>
                    </div>
                    <button class="ai-analyze-btn" onclick="analyzeImage()">üöÄ ÈñãÂßãÂàÜÊûê</button>
                    <div class="ai-result" id="aiResult">
                        <div class="ai-result-placeholder">AI ÂàÜÊûêÁµêÊûúÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£°...</div>
                    </div>
                    <div class="ai-actions">
                        <button class="action-btn primary" onclick="copyAIResult()">üìã Ë§áË£ΩÁµêÊûú</button>
                        <button class="action-btn success" onclick="applyAIText()">‚úÖ ÊáâÁî®ÊñáÂ≠ó</button>
                    </div>
                </div>
                
                <!-- PDF ÊãÜÂàÜÁµÑÂêàÂ∑•ÂÖ∑ -->
                <div class="pdf-tool-panel" id="pdfToolPanel">
                    <div class="panel-title">üìë PDF ÊãÜÂàÜÁµÑÂêà</div>
                    <div style="font-size:11px;color:var(--text-secondary);margin-bottom:10px;">
                        ÈªûÈÅ∏È†ÅÈù¢ÈÄ≤Ë°åÈÅ∏ÂèñÔºåÂèØÂ§öÈÅ∏ÂæåÂåØÂá∫
                    </div>
                    <div class="pdf-pages-grid" id="pdfPagesGrid"></div>
                    <div class="pdf-tool-actions">
                        <button class="pdf-tool-btn select-all" onclick="toggleSelectAllPages()">‚òëÔ∏è ÂÖ®ÈÅ∏/ÂèñÊ∂à</button>
                        <button class="pdf-tool-btn export-images" onclick="exportSelectedAsImages()">üñºÔ∏è ÂåØÂá∫ÂúñÁâá</button>
                        <button class="pdf-tool-btn export-pdf" onclick="exportSelectedAsPdf()">üìÑ Âêà‰Ωµ PDF</button>
                    </div>
                </div>
                
                <!-- ÊµÆÊ∞¥Âç∞Â∑•ÂÖ∑Èù¢Êùø -->
                <div class="watermark-panel" id="watermarkPanel">
                    <div class="panel-title">üí¶ ÊµÆÊ∞¥Âç∞Â∑•ÂÖ∑</div>
                    
                    <!-- Âä†‰∏äÊµÆÊ∞¥Âç∞ -->
                    <div class="watermark-section">
                        <div class="section-subtitle">‚ûï Âä†‰∏äÊµÆÊ∞¥Âç∞</div>
                        <div class="watermark-type-select">
                            <label class="watermark-type">
                                <input type="radio" name="wmType" value="text" checked>
                                <span>üìù ÊñáÂ≠óÊµÆÊ∞¥Âç∞</span>
                            </label>
                            <label class="watermark-type">
                                <input type="radio" name="wmType" value="image">
                                <span>üñºÔ∏è ÂúñÁâáÊµÆÊ∞¥Âç∞</span>
                            </label>
                        </div>
                        
                        <!-- ÊñáÂ≠óÊµÆÊ∞¥Âç∞Ë®≠ÂÆö -->
                        <div class="wm-text-options" id="wmTextOptions">
                            <input type="text" id="wmText" placeholder="Ëº∏ÂÖ•ÊµÆÊ∞¥Âç∞ÊñáÂ≠ó..." class="wm-input">
                            <div class="wm-row">
                                <div class="wm-option">
                                    <label>Â§ßÂ∞è</label>
                                    <input type="number" id="wmFontSize" value="48" min="12" max="200">
                                </div>
                                <div class="wm-option">
                                    <label>È°èËâ≤</label>
                                    <input type="color" id="wmColor" value="#000000">
                                </div>
                                <div class="wm-option">
                                    <label>ÈÄèÊòéÂ∫¶</label>
                                    <input type="range" id="wmOpacity" min="0.05" max="1" step="0.05" value="0.3" oninput="document.getElementById('wmOpacityValue').textContent=Math.round(this.value*100)+'%'">
                                    <span id="wmOpacityValue">30%</span>
                                </div>
                            </div>
                            <div class="wm-row">
                                <div class="wm-option">
                                    <label>ËßíÂ∫¶</label>
                                    <input type="range" id="wmAngle" min="-90" max="90" value="-30">
                                    <span id="wmAngleValue">-30¬∞</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ÂúñÁâáÊµÆÊ∞¥Âç∞Ë®≠ÂÆö -->
                        <div class="wm-image-options" id="wmImageOptions" style="display:none;">
                            <button class="wm-upload-btn" onclick="document.getElementById('wmImageInput').click()">
                                üì§ ÈÅ∏ÊìáÊµÆÊ∞¥Âç∞ÂúñÁâá
                            </button>
                            <input type="file" id="wmImageInput" accept="image/*" style="display:none" onchange="loadWatermarkImage(event)">
                            <div id="wmImagePreview" class="wm-image-preview"></div>
                            <div class="wm-row">
                                <div class="wm-option">
                                    <label>Â§ßÂ∞è %</label>
                                    <input type="range" id="wmImageSize" min="5" max="50" value="20">
                                    <span id="wmImageSizeValue">20%</span>
                                </div>
                                <div class="wm-option">
                                    <label>ÈÄèÊòéÂ∫¶</label>
                                    <input type="range" id="wmImageOpacity" min="0.05" max="1" step="0.05" value="0.5" oninput="document.getElementById('wmImageOpacityValue').textContent=Math.round(this.value*100)+'%'">
                                    <span id="wmImageOpacityValue">50%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ‰ΩçÁΩÆÈÅ∏Êìá -->
                        <div class="wm-position">
                            <label>‰ΩçÁΩÆÔºö</label>
                            <div class="position-grid">
                                <button class="pos-btn" data-pos="top-left">‚Üñ</button>
                                <button class="pos-btn" data-pos="top-center">‚Üë</button>
                                <button class="pos-btn" data-pos="top-right">‚Üó</button>
                                <button class="pos-btn" data-pos="middle-left">‚Üê</button>
                                <button class="pos-btn active" data-pos="center">‚¨§</button>
                                <button class="pos-btn" data-pos="middle-right">‚Üí</button>
                                <button class="pos-btn" data-pos="bottom-left">‚Üô</button>
                                <button class="pos-btn" data-pos="bottom-center">‚Üì</button>
                                <button class="pos-btn" data-pos="bottom-right">‚Üò</button>
                            </div>
                            <label class="tile-option">
                                <input type="checkbox" id="wmTile">
                                <span>Âπ≥Èã™Êï¥ÂºµÂúñÁâá</span>
                            </label>
                        </div>
                        
                        <button class="wm-action-btn add" onclick="addWatermark()">‚ú® Âä†‰∏äÊµÆÊ∞¥Âç∞</button>
                    </div>
                    
                    <!-- ÂàÜÈöîÁ∑ö -->
                    <div class="wm-divider"></div>
                    
                    <!-- ÂéªÈô§ÊµÆÊ∞¥Âç∞ -->
                    <div class="watermark-section">
                        <div class="section-subtitle">üßπ AI ÂéªÈô§ÊµÆÊ∞¥Âç∞</div>
                        <div class="wm-remove-info">
                            ÂÖàÁî®„ÄåÈÅ∏Âèñ„ÄçÂ∑•ÂÖ∑Ê°ÜÈÅ∏ÊµÆÊ∞¥Âç∞ÂçÄÂüüÔºåÂÜçÈªûÊìä‰∏ãÊñπÊåâÈàï
                        </div>
                        <div class="wm-model-select">
                            <label>AI Ê®°ÂûãÔºö</label>
                            <select id="wmRemoveModel">
                                <optgroup label="üíé Gemini">
                                    <option value="gemini-2.0-flash">Gemini 2.0 FlashÔºàÂÖçË≤ªÔºâ</option>
                                    <option value="gemini-2.5-flash">Gemini 2.5 FlashÔºàÂÖçË≤ªÔºâ</option>
                                </optgroup>
                            </select>
                        </div>
                        <button class="wm-action-btn remove" onclick="removeWatermarkAI()">ü§ñ AI Êô∫ÊÖßÂéªÈô§</button>
                        <button class="wm-action-btn remove-manual" onclick="removeWatermarkManual()">üßπ ÊâãÂãïÂ°´Ëâ≤ÂéªÈô§</button>
                    </div>
                </div>
                
                <!-- È¶¨Ë≥ΩÂÖãÊèêÁ§∫ -->
                <div class="tool-tip" id="mosaicTip" style="display:none;">
                    <div class="tip-content">üî≤ ÊãñÊõ≥ÈÅ∏ÂèñË¶ÅÊâìÈ¶¨Ë≥ΩÂÖãÁöÑÂçÄÂüü</div>
                </div>
                
                <!-- ÂúñÁ´†Èù¢Êùø -->
                <div class="stamp-panel" id="stampPanel">
                    <div class="panel-title">üîñ ÂúñÁ´†Â∑•ÂÖ∑</div>
                    <div class="stamp-grid">
                        <button class="stamp-item" onclick="addStamp('Ê©üÂØÜ')">üî¥ Ê©üÂØÜ</button>
                        <button class="stamp-item" onclick="addStamp('ÊÄ•‰ª∂')">üü† ÊÄ•‰ª∂</button>
                        <button class="stamp-item" onclick="addStamp('Â∑≤ÂØ©Ê†∏')">üü¢ Â∑≤ÂØ©Ê†∏</button>
                        <button class="stamp-item" onclick="addStamp('Â∑≤‰ªòÊ¨æ')">üí∞ Â∑≤‰ªòÊ¨æ</button>
                        <button class="stamp-item" onclick="addStamp('‰ΩúÂª¢')">‚ùå ‰ΩúÂª¢</button>
                        <button class="stamp-item" onclick="addStamp('COPY')">üìã COPY</button>
                        <button class="stamp-item" onclick="addStamp('DRAFT')">üìù DRAFT</button>
                        <button class="stamp-item" onclick="addStamp('APPROVED')">‚úÖ APPROVED</button>
                        <button class="stamp-item" onclick="addStamp('REJECTED')">üö´ REJECTED</button>
                        <button class="stamp-item" onclick="addStamp('CONFIDENTIAL')">üîí CONFIDENTIAL</button>
                        <button class="stamp-item" onclick="addStamp('SAMPLE')">üì¶ SAMPLE</button>
                        <button class="stamp-item" onclick="addStamp('VOID')">‚õî VOID</button>
                    </div>
                    <div class="stamp-custom">
                        <input type="text" id="customStamp" placeholder="Ëá™Ë®ÇÂúñÁ´†ÊñáÂ≠ó...">
                        <button onclick="addStamp(document.getElementById('customStamp').value)">Êñ∞Â¢û</button>
                    </div>
                    <div class="stamp-options">
                        <div class="wm-option">
                            <label>Â§ßÂ∞è</label>
                            <input type="range" id="stampSize" min="30" max="150" value="60">
                        </div>
                        <div class="wm-option">
                            <label>È°èËâ≤</label>
                            <input type="color" id="stampColor" value="#ff0000">
                        </div>
                        <div class="wm-option">
                            <label>ËßíÂ∫¶</label>
                            <input type="range" id="stampAngle" min="-45" max="45" value="-15">
                        </div>
                    </div>
                    <div class="wm-position" style="margin-top:10px;" id="stampPositionGrid">
                        <label>ÂàùÂßã‰ΩçÁΩÆÔºö</label>
                        <div class="position-grid">
                            <button class="pos-btn" onclick="setStampPosition('top-left', this)">‚Üñ</button>
                            <button class="pos-btn" onclick="setStampPosition('top-center', this)">‚Üë</button>
                            <button class="pos-btn" onclick="setStampPosition('top-right', this)">‚Üó</button>
                            <button class="pos-btn" onclick="setStampPosition('middle-left', this)">‚Üê</button>
                            <button class="pos-btn active" onclick="setStampPosition('center', this)">‚¨§</button>
                            <button class="pos-btn" onclick="setStampPosition('middle-right', this)">‚Üí</button>
                            <button class="pos-btn" onclick="setStampPosition('bottom-left', this)">‚Üô</button>
                            <button class="pos-btn" onclick="setStampPosition('bottom-center', this)">‚Üì</button>
                            <button class="pos-btn" onclick="setStampPosition('bottom-right', this)">‚Üò</button>
                        </div>
                    </div>
                    <button class="wm-action-btn" onclick="cancelStampPlacement()" style="margin-top:10px;background:var(--bg-input);">‚ùå ÂèñÊ∂àÊîæÁΩÆ</button>
                </div>
                <div class="sign-panel" id="signPanel">
                    <div class="panel-title">‚úçÔ∏è ÈõªÂ≠êÁ∞ΩÂêç</div>
                    <canvas id="signCanvas" width="300" height="150"></canvas>
                    <div class="sign-options">
                        <div class="wm-option">
                            <label>Á≠ÜËß∏</label>
                            <input type="range" id="signLineWidth" min="1" max="8" value="3">
                        </div>
                        <div class="wm-option">
                            <label>È°èËâ≤</label>
                            <input type="color" id="signColor" value="#000000">
                        </div>
                    </div>
                    <div class="wm-position" style="margin-top:10px;" id="signPositionGrid">
                        <label>ÂàùÂßã‰ΩçÁΩÆÔºö</label>
                        <div class="position-grid">
                            <button class="pos-btn" onclick="setSignPosition('top-left', this)">‚Üñ</button>
                            <button class="pos-btn" onclick="setSignPosition('top-center', this)">‚Üë</button>
                            <button class="pos-btn" onclick="setSignPosition('top-right', this)">‚Üó</button>
                            <button class="pos-btn" onclick="setSignPosition('middle-left', this)">‚Üê</button>
                            <button class="pos-btn" onclick="setSignPosition('center', this)">‚¨§</button>
                            <button class="pos-btn" onclick="setSignPosition('middle-right', this)">‚Üí</button>
                            <button class="pos-btn" onclick="setSignPosition('bottom-left', this)">‚Üô</button>
                            <button class="pos-btn" onclick="setSignPosition('bottom-center', this)">‚Üì</button>
                            <button class="pos-btn active" onclick="setSignPosition('bottom-right', this)">‚Üò</button>
                        </div>
                    </div>
                    <div class="sign-actions">
                        <button class="action-btn danger" onclick="clearSignature()">üóëÔ∏è Ê∏ÖÈô§</button>
                        <button class="action-btn primary" onclick="applySignature()">‚úÖ Â•óÁî®Á∞ΩÂêç</button>
                        <button class="action-btn" onclick="cancelSignPlacement()" style="background:var(--bg-input);margin-top:5px;width:100%;">‚ùå ÂèñÊ∂àÊîæÁΩÆ</button>
                    </div>
                </div>
                
                <!-- ÊøæÈè°Èù¢Êùø -->
                <div class="filter-panel" id="filterPanel">
                    <div class="panel-title">üé® ÊøæÈè°ÊïàÊûú</div>
                    <div class="filter-preview-area">
                        <canvas id="filterPreview" width="120" height="80"></canvas>
                        <span id="filterPreviewName">ÂéüÂúñ</span>
                    </div>
                    <div class="filter-grid">
                        <button class="filter-item" onmouseover="previewFilter('none')" onclick="applyFilter('none')">üîÑ ÂéüÂúñ</button>
                        <button class="filter-item" onmouseover="previewFilter('grayscale')" onclick="applyFilter('grayscale')">‚¨õ ÈªëÁôΩ</button>
                        <button class="filter-item" onmouseover="previewFilter('sepia')" onclick="applyFilter('sepia')">üü§ Âæ©Âè§</button>
                        <button class="filter-item" onmouseover="previewFilter('invert')" onclick="applyFilter('invert')">üîÉ ÂèçËΩâ</button>
                        <button class="filter-item" onmouseover="previewFilter('blur')" onclick="applyFilter('blur')">üå´Ô∏è Ê®°Á≥ä</button>
                        <button class="filter-item" onmouseover="previewFilter('sharpen')" onclick="applyFilter('sharpen')">üî™ Èä≥Âåñ</button>
                        <button class="filter-item" onmouseover="previewFilter('brightness')" onclick="applyFilter('brightness')">‚òÄÔ∏è Êòé‰∫Æ</button>
                        <button class="filter-item" onmouseover="previewFilter('contrast')" onclick="applyFilter('contrast')">üé≠ Â∞çÊØî</button>
                        <button class="filter-item" onmouseover="previewFilter('saturate')" onclick="applyFilter('saturate')">üåà ÈÆÆË±î</button>
                        <button class="filter-item" onmouseover="previewFilter('cool')" onclick="applyFilter('cool')">‚ùÑÔ∏è ÂÜ∑Ëâ≤</button>
                        <button class="filter-item" onmouseover="previewFilter('warm')" onclick="applyFilter('warm')">üî• ÊöñËâ≤</button>
                        <button class="filter-item" onmouseover="previewFilter('vintage')" onclick="applyFilter('vintage')">üì∑ Êá∑Ëàä</button>
                    </div>
                </div>
                
                <!-- Ë™øÊï¥Èù¢Êùø -->
                <div class="adjust-panel" id="adjustPanel">
                    <div class="panel-title">üåà Ëâ≤ÂΩ©Ë™øÊï¥</div>
                    <div class="adjust-sliders">
                        <div class="adjust-item">
                            <label>‰∫ÆÂ∫¶</label>
                            <input type="range" id="adjustBrightness" min="-100" max="100" value="0">
                            <span id="brightnessVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>Â∞çÊØî</label>
                            <input type="range" id="adjustContrast" min="-100" max="100" value="0">
                            <span id="contrastVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>È£ΩÂíåÂ∫¶</label>
                            <input type="range" id="adjustSaturation" min="-100" max="100" value="0">
                            <span id="saturationVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>Ëâ≤Áõ∏</label>
                            <input type="range" id="adjustHue" min="0" max="360" value="0">
                            <span id="hueVal">0¬∞</span>
                        </div>
                    </div>
                    <div class="adjust-actions">
                        <button class="action-btn danger" onclick="resetAdjustments()">üîÑ ÈáçÁΩÆ</button>
                        <button class="action-btn primary" onclick="applyAdjustments()">‚úÖ Â•óÁî®</button>
                    </div>
                </div>
                
                <!-- ÈÇäÊ°ÜÈù¢Êùø -->
                <div class="frame-panel" id="framePanel">
                    <div class="panel-title">üñºÔ∏è ÈÇäÊ°ÜË£ùÈ£æ</div>
                    <div class="frame-grid">
                        <button class="frame-item" onclick="addFrame('none')">‚ùå ÁÑ°</button>
                        <button class="frame-item" onclick="addFrame('simple')">‚¨ú Á∞°Á¥ÑÁôΩ</button>
                        <button class="frame-item" onclick="addFrame('black')">‚¨õ Á∂ìÂÖ∏Èªë</button>
                        <button class="frame-item" onclick="addFrame('rounded')">üî≤ ÂúìËßí</button>
                        <button class="frame-item" onclick="addFrame('shadow')">üåë Èô∞ÂΩ±</button>
                        <button class="frame-item" onclick="addFrame('polaroid')">üì∏ ÊãçÁ´ãÂæó</button>
                        <button class="frame-item" onclick="addFrame('film')">üéûÔ∏è ËÜ†Êç≤</button>
                        <button class="frame-item" onclick="addFrame('torn')">üìÉ ÊíïÁ¥ô</button>
                    </div>
                    <div class="frame-options">
                        <div class="wm-option">
                            <label>ÈÇäÊ°ÜÂØ¨Â∫¶</label>
                            <input type="range" id="frameWidth" min="5" max="50" value="20">
                        </div>
                        <div class="wm-option">
                            <label>ÈÇäÊ°ÜÈ°èËâ≤</label>
                            <input type="color" id="frameColor" value="#ffffff">
                        </div>
                    </div>
                </div>
                
                <!-- Ë≤ºÂúñÈù¢Êùø -->
                <div class="sticker-panel" id="stickerPanel">
                    <div class="panel-title">üòÄ Ë°®ÊÉÖË≤ºÂúñ</div>
                    <div class="sticker-tabs">
                        <button class="sticker-tab active" onclick="showStickerTab('emoji')">üòÄ Ë°®ÊÉÖ</button>
                        <button class="sticker-tab" onclick="showStickerTab('symbol')">‚≠ê Á¨¶Ëôü</button>
                        <button class="sticker-tab" onclick="showStickerTab('shape')">üî∑ ÂΩ¢ÁãÄ</button>
                    </div>
                    <div class="sticker-grid" id="stickerGrid">
                        <!-- ÂãïÊÖãÂ°´ÂÖÖ -->
                    </div>
                    <div class="sticker-options">
                        <div class="wm-option">
                            <label>Â§ßÂ∞è</label>
                            <input type="range" id="stickerSize" min="30" max="200" value="80">
                        </div>
                    </div>
                    <div class="wm-position" style="margin-top:10px;" id="stickerPositionGrid">
                        <label>ÂàùÂßã‰ΩçÁΩÆÔºö</label>
                        <div class="position-grid">
                            <button class="pos-btn" onclick="setStickerPosition('top-left', this)">‚Üñ</button>
                            <button class="pos-btn" onclick="setStickerPosition('top-center', this)">‚Üë</button>
                            <button class="pos-btn" onclick="setStickerPosition('top-right', this)">‚Üó</button>
                            <button class="pos-btn" onclick="setStickerPosition('middle-left', this)">‚Üê</button>
                            <button class="pos-btn active" onclick="setStickerPosition('center', this)">‚¨§</button>
                            <button class="pos-btn" onclick="setStickerPosition('middle-right', this)">‚Üí</button>
                            <button class="pos-btn" onclick="setStickerPosition('bottom-left', this)">‚Üô</button>
                            <button class="pos-btn" onclick="setStickerPosition('bottom-center', this)">‚Üì</button>
                            <button class="pos-btn" onclick="setStickerPosition('bottom-right', this)">‚Üò</button>
                        </div>
                    </div>
                    <button class="wm-action-btn" onclick="cancelStickerPlacement()" style="margin-top:10px;background:var(--bg-input);">‚ùå ÂèñÊ∂àÊîæÁΩÆ</button>
                </div>
                
                <!-- ÁÆ≠È†≠Èù¢Êùø -->
                <div class="arrow-panel" id="arrowPanel">
                    <div class="panel-title">‚û°Ô∏è ÁÆ≠È†≠Â∑•ÂÖ∑</div>
                    <div class="arrow-info" style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;">
                        Ë®≠ÂÆöÂÆåÊàêÂæåÔºåÂú®Áï´Â∏É‰∏äÊãñÊõ≥Âç≥ÂèØÁï´ÁÆ≠È†≠
                    </div>
                    <div class="stamp-options">
                        <div class="wm-option">
                            <label>Á≤óÁ¥∞</label>
                            <input type="range" id="arrowWidth" min="1" max="15" value="3" oninput="document.getElementById('arrowWidthValue').textContent=this.value+'px'">
                            <span id="arrowWidthValue">3px</span>
                        </div>
                        <div class="wm-option">
                            <label>È°èËâ≤</label>
                            <input type="color" id="arrowColor" value="#ff0000">
                        </div>
                    </div>
                    <div class="wm-option" style="margin-top:10px;">
                        <label>Á∑öÊ¢ùÊ®£Âºè</label>
                        <select id="arrowStyle" style="width:100%;padding:8px;border-radius:8px;background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border);">
                            <option value="solid">‚îÅ‚îÅ ÂØ¶Á∑ö</option>
                            <option value="dashed">‚îÑ‚îÑ ËôõÁ∑ö</option>
                            <option value="dotted">¬∑¬∑¬∑¬∑ ÈªûÁ∑ö</option>
                        </select>
                    </div>
                    <div class="wm-option" style="margin-top:10px;">
                        <label>ÁÆ≠È†≠Ê®£Âºè</label>
                        <select id="arrowHead" style="width:100%;padding:8px;border-radius:8px;background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border);">
                            <option value="filled">‚ñ∂ ÂØ¶ÂøÉ</option>
                            <option value="outline">‚ñ∑ Á©∫ÂøÉ</option>
                            <option value="diamond">‚óÜ Ëè±ÂΩ¢</option>
                            <option value="double">‚óÄ‚ñ∂ ÈõôÂêë</option>
                            <option value="circle">‚óè ÂúìÈªû</option>
                        </select>
                    </div>
                    <button class="wm-action-btn add" onclick="activateArrowTool()" style="margin-top:15px;">‚úèÔ∏è ÈñãÂßãÁï´ÁÆ≠È†≠</button>
                    <button class="wm-action-btn" onclick="cancelArrowTool()" style="margin-top:5px;background:var(--bg-input);">‚ùå ÂèñÊ∂à</button>
                </div>
                
                <!-- Ë£ÅÂàáÈù¢Êùø -->
                <div class="crop-panel" id="cropPanel">
                    <div class="panel-title">‚¨ú Ë£ÅÂàáÂúñÁâá</div>
                    <div class="crop-presets">
                        <button class="crop-preset" onclick="setCropRatio('free')">üîì Ëá™Áî±</button>
                        <button class="crop-preset" onclick="setCropRatio('1:1')">‚¨ú 1:1</button>
                        <button class="crop-preset" onclick="setCropRatio('4:3')">üì∫ 4:3</button>
                        <button class="crop-preset" onclick="setCropRatio('16:9')">üñ•Ô∏è 16:9</button>
                        <button class="crop-preset" onclick="setCropRatio('3:4')">üì± 3:4</button>
                        <button class="crop-preset" onclick="setCropRatio('9:16')">üì± 9:16</button>
                    </div>
                    <div class="crop-info">ÂÖàÁî®„ÄåÈÅ∏Âèñ„ÄçÂ∑•ÂÖ∑Ê°ÜÈÅ∏Ë£ÅÂàáÂçÄÂüü</div>
                    <button class="wm-action-btn add" onclick="applyCrop()">‚úÇÔ∏è Âü∑Ë°åË£ÅÂàá</button>
                </div>
                
                <!-- ÊãºÊé•Èù¢Êùø -->
                <div class="merge-panel" id="mergePanel">
                    <div class="panel-title">üìê ÂúñÁâáÊãºÊé•</div>
                    <div class="merge-direction">
                        <label class="merge-dir">
                            <input type="radio" name="mergeDir" value="vertical" checked>
                            <span>üìè ÂûÇÁõ¥ÊãºÊé•Ôºà‰∏ä‰∏ãÔºâ</span>
                        </label>
                        <label class="merge-dir">
                            <input type="radio" name="mergeDir" value="horizontal">
                            <span>üìê Ê∞¥Âπ≥ÊãºÊé•ÔºàÂ∑¶Âè≥Ôºâ</span>
                        </label>
                    </div>
                    <div class="merge-list" id="mergeList">
                        <div class="merge-item current">üìå ÁõÆÂâçÂúñÁâá</div>
                    </div>
                    <button class="wm-upload-btn" onclick="document.getElementById('mergeInput').click()">
                        ‚ûï Ê∑ªÂä†ÂúñÁâá
                    </button>
                    <input type="file" id="mergeInput" accept="image/*" multiple style="display:none" onchange="addMergeImages(event)">
                    <button class="wm-action-btn add" onclick="executeMerge()">üîó Âü∑Ë°åÊãºÊé•</button>
                </div>
                
                <!-- QR Code Èù¢Êùø -->
                <div class="qr-panel" id="qrPanel">
                    <div class="panel-title">üì± QR Code ÁîüÊàê</div>
                    <input type="text" id="qrContent" class="wm-input" placeholder="Ëº∏ÂÖ•Á∂≤ÂùÄÊàñÊñáÂ≠ó...">
                    <div class="qr-options">
                        <div class="wm-option">
                            <label>Â§ßÂ∞è</label>
                            <input type="range" id="qrSize" min="50" max="200" value="100">
                        </div>
                        <div class="wm-option">
                            <label>ÂâçÊôØËâ≤</label>
                            <input type="color" id="qrFgColor" value="#000000">
                        </div>
                        <div class="wm-option">
                            <label>ËÉåÊôØËâ≤</label>
                            <input type="color" id="qrBgColor" value="#ffffff">
                        </div>
                    </div>
                    <div id="qrPreview" class="qr-preview"></div>
                    <button class="wm-action-btn add" onclick="generateQR()">üì± ÁîüÊàê QR Code</button>
                    <div class="wm-position" style="margin-top:10px;">
                        <label>ÂàùÂßã‰ΩçÁΩÆÔºö</label>
                        <div class="position-grid">
                            <button class="pos-btn" onclick="setQRPosition('top-left', this)">‚Üñ</button>
                            <button class="pos-btn" onclick="setQRPosition('top-center', this)">‚Üë</button>
                            <button class="pos-btn" onclick="setQRPosition('top-right', this)">‚Üó</button>
                            <button class="pos-btn" onclick="setQRPosition('middle-left', this)">‚Üê</button>
                            <button class="pos-btn" onclick="setQRPosition('center', this)">‚¨§</button>
                            <button class="pos-btn" onclick="setQRPosition('middle-right', this)">‚Üí</button>
                            <button class="pos-btn" onclick="setQRPosition('bottom-left', this)">‚Üô</button>
                            <button class="pos-btn" onclick="setQRPosition('bottom-center', this)">‚Üì</button>
                            <button class="pos-btn active" onclick="setQRPosition('bottom-right', this)">‚Üò</button>
                        </div>
                    </div>
                    <button class="wm-action-btn remove" onclick="placeQR()">üìç ÊîæÁΩÆÂà∞ÂúñÁâá</button>
                    <button class="wm-action-btn" onclick="cancelQRPlacement()" style="margin-top:10px;background:var(--bg-input);">‚ùå ÂèñÊ∂àÊîæÁΩÆ</button>
                </div>
                
                <!-- Â£ìÁ∏ÆÈù¢Êùø -->
                <div class="compress-panel" id="compressPanel">
                    <div class="panel-title">üì¶ ÂúñÁâáÂ£ìÁ∏Æ</div>
                    <div class="compress-info">
                        <div>ÂéüÂßãÂ§ßÂ∞èÔºö<span id="originalSize">--</span></div>
                        <div>Â£ìÁ∏ÆÂæåÔºö<span id="compressedSize">--</span></div>
                        <div>Â£ìÁ∏ÆÁéáÔºö<span id="compressRatio">--</span></div>
                    </div>
                    <div class="compress-slider">
                        <label>ÂìÅË≥™Ôºö<span id="qualityVal">80%</span></label>
                        <input type="range" id="compressQuality" min="10" max="100" value="80">
                    </div>
                    <div class="compress-resize">
                        <label>
                            <input type="checkbox" id="enableResize">
                            Á∏ÆÂ∞èÂ∞∫ÂØ∏
                        </label>
                        <div class="resize-options" id="resizeOptions" style="display:none;">
                            <select id="resizePreset">
                                <option value="100">ÂéüÂßãÂ§ßÂ∞è</option>
                                <option value="75">75%</option>
                                <option value="50" selected>50%</option>
                                <option value="25">25%</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="previewCompress()">üëÅÔ∏è È†êË¶ΩÂ£ìÁ∏Æ</button>
                    <button class="wm-action-btn remove" onclick="downloadCompressed()">üíæ ‰∏ãËºâÂ£ìÁ∏ÆÊ™î</button>
                </div>
                
                <!-- Áï´Á≠ÜÈù¢Êùø -->
                <div class="brush-panel" id="brushPanel">
                    <div class="panel-title">üñåÔ∏è Áï´Á≠ÜÂ∑•ÂÖ∑</div>
                    <div class="brush-types">
                        <button class="brush-type active" data-brush="pen" onclick="setBrushType('pen')">‚úèÔ∏è ÈãºÁ≠Ü</button>
                        <button class="brush-type" data-brush="marker" onclick="setBrushType('marker')">üñçÔ∏è È∫•ÂÖãÁ≠Ü</button>
                        <button class="brush-type" data-brush="highlighter" onclick="setBrushType('highlighter')">üìç Ëû¢ÂÖâÁ≠Ü</button>
                        <button class="brush-type" data-brush="spray" onclick="setBrushType('spray')">üí® Âô¥Êßç</button>
                        <button class="brush-type" data-brush="eraser" onclick="setBrushType('eraser')">üßΩ Ê©°ÁöÆÊì¶</button>
                    </div>
                    <div class="brush-options">
                        <div class="wm-option">
                            <label>Â§ßÂ∞è</label>
                            <input type="range" id="brushSize" min="1" max="50" value="5" oninput="document.getElementById('brushSizeVal').textContent=this.value">
                            <span id="brushSizeVal">5</span>
                        </div>
                        <div class="wm-option">
                            <label>ÈÄèÊòéÂ∫¶</label>
                            <input type="range" id="brushOpacity" min="0.1" max="1" step="0.1" value="1">
                        </div>
                        <div class="wm-option">
                            <label>È°èËâ≤</label>
                            <input type="color" id="brushColor" value="#ff0000">
                        </div>
                    </div>
                    <div class="brush-colors">
                        <button class="color-preset" style="background:#000" onclick="setBrushColor('#000000')"></button>
                        <button class="color-preset" style="background:#fff" onclick="setBrushColor('#ffffff')"></button>
                        <button class="color-preset" style="background:#f00" onclick="setBrushColor('#ff0000')"></button>
                        <button class="color-preset" style="background:#0f0" onclick="setBrushColor('#00ff00')"></button>
                        <button class="color-preset" style="background:#00f" onclick="setBrushColor('#0000ff')"></button>
                        <button class="color-preset" style="background:#ff0" onclick="setBrushColor('#ffff00')"></button>
                        <button class="color-preset" style="background:#f0f" onclick="setBrushColor('#ff00ff')"></button>
                        <button class="color-preset" style="background:#0ff" onclick="setBrushColor('#00ffff')"></button>
                    </div>
                </div>
                
                <!-- ÂΩ¢ÁãÄÈù¢Êùø -->
                <div class="shape-panel" id="shapePanel">
                    <div class="panel-title">‚≠ï ÂΩ¢ÁãÄÂ∑•ÂÖ∑</div>
                    <div class="shape-types">
                        <button class="shape-type active" onclick="setShapeType('rect')">‚¨ú Áü©ÂΩ¢</button>
                        <button class="shape-type" onclick="setShapeType('circle')">‚≠ï ÂúìÂΩ¢</button>
                        <button class="shape-type" onclick="setShapeType('ellipse')">üî¥ Ê©¢Âúì</button>
                        <button class="shape-type" onclick="setShapeType('triangle')">üî∫ ‰∏âËßí</button>
                        <button class="shape-type" onclick="setShapeType('star')">‚≠ê ÊòüÂΩ¢</button>
                        <button class="shape-type" onclick="setShapeType('heart')">‚ù§Ô∏è ÊÑõÂøÉ</button>
                        <button class="shape-type" onclick="setShapeType('line')">‚ûñ Á∑öÊ¢ù</button>
                        <button class="shape-type" onclick="setShapeType('polygon')">‚¨° Â§öÈÇäÂΩ¢</button>
                    </div>
                    <div class="shape-options">
                        <div class="wm-option">
                            <label>ÈÇäÊ°ÜÂØ¨Â∫¶</label>
                            <input type="range" id="shapeStroke" min="0" max="20" value="2">
                        </div>
                        <div class="wm-option">
                            <label>ÈÇäÊ°ÜËâ≤</label>
                            <input type="color" id="shapeStrokeColor" value="#000000">
                        </div>
                        <div class="wm-option">
                            <label>Â°´ÂÖÖËâ≤</label>
                            <input type="color" id="shapeFillColor" value="#ffffff">
                        </div>
                        <label class="tile-option">
                            <input type="checkbox" id="shapeFilled" checked>
                            <span>Â°´ÂÖÖÂΩ¢ÁãÄ</span>
                        </label>
                    </div>
                    <div class="shape-tip">ÊãñÊõ≥Áï´Â∏ÉÁπ™Ë£ΩÂΩ¢ÁãÄ</div>
                </div>
                
                <!-- ÊñáÂ≠óÁâπÊïàÈù¢Êùø -->
                <div class="textfx-panel" id="textFxPanel">
                    <div class="panel-title">üî§ ÊñáÂ≠óÁâπÊïà</div>
                    <input type="text" id="fxText" class="wm-input" placeholder="Ëº∏ÂÖ•ÊñáÂ≠ó...">
                    <div class="textfx-styles">
                        <button class="fx-style" onclick="applyTextFx('shadow')">üåë Èô∞ÂΩ±</button>
                        <button class="fx-style" onclick="applyTextFx('outline')">‚≠ï ÊèèÈÇä</button>
                        <button class="fx-style" onclick="applyTextFx('gradient')">üåà Êº∏Â±§</button>
                        <button class="fx-style" onclick="applyTextFx('glow')">‚ú® ÁôºÂÖâ</button>
                        <button class="fx-style" onclick="applyTextFx('3d')">üé≤ 3D</button>
                        <button class="fx-style" onclick="applyTextFx('neon')">üí° ÈúìËôπ</button>
                        <button class="fx-style" onclick="applyTextFx('retro')">üì∫ Âæ©Âè§</button>
                        <button class="fx-style" onclick="applyTextFx('metal')">üî© ÈáëÂ±¨</button>
                    </div>
                    <div class="textfx-options">
                        <div class="wm-option">
                            <label>Â§ßÂ∞è</label>
                            <input type="range" id="fxFontSize" min="20" max="150" value="60">
                        </div>
                        <div class="wm-option">
                            <label>‰∏ªËâ≤</label>
                            <input type="color" id="fxColor1" value="#ff0000">
                        </div>
                        <div class="wm-option">
                            <label>ÂâØËâ≤</label>
                            <input type="color" id="fxColor2" value="#0000ff">
                        </div>
                    </div>
                    <div class="wm-position" style="margin-top:10px;">
                        <label>ÂàùÂßã‰ΩçÁΩÆÔºö</label>
                        <div class="position-grid">
                            <button class="pos-btn" onclick="setTextFxPosition('top-left', this)">‚Üñ</button>
                            <button class="pos-btn" onclick="setTextFxPosition('top-center', this)">‚Üë</button>
                            <button class="pos-btn" onclick="setTextFxPosition('top-right', this)">‚Üó</button>
                            <button class="pos-btn" onclick="setTextFxPosition('middle-left', this)">‚Üê</button>
                            <button class="pos-btn active" onclick="setTextFxPosition('center', this)">‚¨§</button>
                            <button class="pos-btn" onclick="setTextFxPosition('middle-right', this)">‚Üí</button>
                            <button class="pos-btn" onclick="setTextFxPosition('bottom-left', this)">‚Üô</button>
                            <button class="pos-btn" onclick="setTextFxPosition('bottom-center', this)">‚Üì</button>
                            <button class="pos-btn" onclick="setTextFxPosition('bottom-right', this)">‚Üò</button>
                        </div>
                    </div>
                    <button class="wm-action-btn" onclick="cancelTextFxPlacement()" style="margin-top:10px;background:var(--bg-input);">‚ùå ÂèñÊ∂àÊîæÁΩÆ</button>
                </div>
                
                <!-- Ê®°ÊùøÈù¢Êùø -->
                <div class="template-panel" id="templatePanel">
                    <div class="panel-title">üìã Â∞∫ÂØ∏Ê®°Êùø</div>
                    <div class="template-categories">
                        <button class="template-cat active" onclick="showTemplates('social')">üì± Á§æÁæ§</button>
                        <button class="template-cat" onclick="showTemplates('print')">üñ®Ô∏è Âç∞Âà∑</button>
                        <button class="template-cat" onclick="showTemplates('web')">üåê Á∂≤È†Å</button>
                        <button class="template-cat" onclick="showTemplates('video')">üé¨ ÂΩ±Áâá</button>
                    </div>
                    <div class="template-grid" id="templateGrid">
                        <!-- ÂãïÊÖãÂ°´ÂÖÖ -->
                    </div>
                    <div class="custom-size">
                        <div class="panel-subtitle">üìê Ëá™Ë®ÇÂ∞∫ÂØ∏</div>
                        <div class="size-inputs">
                            <input type="number" id="customWidth" placeholder="ÂØ¨Â∫¶" value="800">
                            <span>√ó</span>
                            <input type="number" id="customHeight" placeholder="È´òÂ∫¶" value="600">
                            <span>px</span>
                        </div>
                        <button class="wm-action-btn add" onclick="createCustomCanvas()">Âª∫Á´ãÁï´Â∏É</button>
                    </div>
                </div>
                
                <!-- ÊãºË≤ºÈù¢Êùø -->
                <div class="collage-panel" id="collagePanel">
                    <div class="panel-title">üß© ÁÖßÁâáÊãºË≤º</div>
                    <div class="collage-layouts">
                        <button class="collage-layout" onclick="setCollageLayout(2, 'h')">‚ó´ 2Ê†ºÊ©´</button>
                        <button class="collage-layout" onclick="setCollageLayout(2, 'v')">‚óß 2Ê†ºÁõ¥</button>
                        <button class="collage-layout" onclick="setCollageLayout(3, 'h')">‚äü 3Ê†ºÊ©´</button>
                        <button class="collage-layout" onclick="setCollageLayout(4, 'grid')">‚äû 4Ê†º</button>
                        <button class="collage-layout" onclick="setCollageLayout(6, 'grid')">‚äû 6Ê†º</button>
                        <button class="collage-layout" onclick="setCollageLayout(9, 'grid')">‚äû 9Ê†º</button>
                    </div>
                    <div class="collage-options">
                        <div class="wm-option">
                            <label>ÈñìË∑ù</label>
                            <input type="range" id="collageGap" min="0" max="30" value="10">
                        </div>
                        <div class="wm-option">
                            <label>ÂúìËßí</label>
                            <input type="range" id="collageRadius" min="0" max="30" value="0">
                        </div>
                        <div class="wm-option">
                            <label>ËÉåÊôØ</label>
                            <input type="color" id="collageBg" value="#ffffff">
                        </div>
                    </div>
                    <div class="collage-images" id="collageImages">
                        <!-- ÂãïÊÖãÂ°´ÂÖÖÂúñÁâá -->
                    </div>
                    <button class="wm-upload-btn" onclick="document.getElementById('collageInput').click()">
                        ‚ûï Ê∑ªÂä†ÁÖßÁâá
                    </button>
                    <input type="file" id="collageInput" accept="image/*" multiple style="display:none" onchange="addCollageImages(event)">
                    <button class="wm-action-btn add" onclick="generateCollage()">üß© Áî¢ÁîüÊãºË≤º</button>
                </div>
                
                <!-- ÁæéÈ°èÈù¢Êùø -->
                <div class="beauty-panel" id="beautyPanel">
                    <div class="panel-title">‚ú® ÁæéÈ°èÁæéÂåñ</div>
                    <div class="beauty-sliders">
                        <div class="adjust-item">
                            <label>Á£®ÁöÆ</label>
                            <input type="range" id="beautySkin" min="0" max="100" value="0">
                            <span id="skinVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>ÁæéÁôΩ</label>
                            <input type="range" id="beautyWhite" min="0" max="100" value="0">
                            <span id="whiteVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>Á¥ÖÊΩ§</label>
                            <input type="range" id="beautyRosy" min="0" max="100" value="0">
                            <span id="rosyVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>Èä≥Âåñ</label>
                            <input type="range" id="beautySharp" min="0" max="100" value="0">
                            <span id="sharpVal">0</span>
                        </div>
                    </div>
                    <div class="beauty-presets">
                        <button class="beauty-preset" onclick="applyBeautyPreset('natural')">üåø Ëá™ÁÑ∂</button>
                        <button class="beauty-preset" onclick="applyBeautyPreset('soft')">üå∏ ÊüîËÜö</button>
                        <button class="beauty-preset" onclick="applyBeautyPreset('bright')">‚òÄÔ∏è ‰∫ÆÁôΩ</button>
                        <button class="beauty-preset" onclick="applyBeautyPreset('glamour')">üíé È≠ÖÂäõ</button>
                    </div>
                    <button class="wm-action-btn add" onclick="applyBeauty()">‚ú® Â•óÁî®ÁæéÈ°è</button>
                </div>
                
                <!-- ÂéªËÉåÈù¢Êùø -->
                <div class="removebg-panel" id="removeBgPanel">
                    <div class="panel-title">üé≠ ËÉåÊôØËôïÁêÜ</div>
                    <div class="removebg-options">
                        <button class="removebg-btn" onclick="removeBackground('white')">‚¨ú ÂéªÁôΩËÉåÊôØ</button>
                        <button class="removebg-btn" onclick="removeBackground('black')">‚¨õ ÂéªÈªëËÉåÊôØ</button>
                        <button class="removebg-btn" onclick="removeBackground('green')">üü© ÂéªÁ∂†Âπï</button>
                        <button class="removebg-btn" onclick="removeBackground('color')">üé® ÂéªÊåáÂÆöËâ≤</button>
                    </div>
                    <div class="color-pick-row" id="bgColorPick" style="display:none;">
                        <label>ÈÅ∏ÊìáË¶ÅÂéªÈô§ÁöÑÈ°èËâ≤Ôºö</label>
                        <input type="color" id="removeBgColor" value="#00ff00">
                        <button class="eyedropper-btn" onclick="pickBgColor()">üíß Âê∏Âèñ</button>
                    </div>
                    <div class="tolerance-row">
                        <label>ÂÆπÂ∑ÆÔºö<span id="toleranceVal">30</span></label>
                        <input type="range" id="bgTolerance" min="0" max="100" value="30">
                    </div>
                    <div class="new-bg-section">
                        <div class="panel-subtitle">üñºÔ∏è ÊõøÊèõËÉåÊôØ</div>
                        <div class="new-bg-options">
                            <button class="newbg-btn" onclick="setNewBg('transparent')">üî≥ ÈÄèÊòé</button>
                            <button class="newbg-btn" onclick="setNewBg('color')">üé® Á¥îËâ≤</button>
                            <button class="newbg-btn" onclick="setNewBg('gradient')">üåÖ Êº∏Â±§</button>
                            <button class="newbg-btn" onclick="setNewBg('image')">üñºÔ∏è ÂúñÁâá</button>
                        </div>
                        <input type="color" id="newBgColor" value="#ffffff" style="margin-top:10px;">
                    </div>
                </div>
                
                <!-- ÊâπÊ¨°ËôïÁêÜÈù¢Êùø -->
                <div class="batch-panel" id="batchPanel">
                    <div class="panel-title">üìö ÊâπÊ¨°ËôïÁêÜ</div>
                    <div class="batch-upload">
                        <button class="wm-upload-btn" onclick="document.getElementById('batchInput').click()">
                            üì§ ÈÅ∏ÊìáÂ§öÂºµÂúñÁâá
                        </button>
                        <input type="file" id="batchInput" accept="image/*" multiple style="display:none" onchange="loadBatchImages(event)">
                    </div>
                    <div class="batch-list" id="batchList">
                        <div class="batch-placeholder">Â∞öÊú™ÈÅ∏ÊìáÂúñÁâá</div>
                    </div>
                    <div class="batch-actions">
                        <div class="panel-subtitle">üìã ÊâπÊ¨°Êìç‰Ωú</div>
                        <label class="batch-action"><input type="checkbox" id="batchResize"> üìê Áµ±‰∏ÄÂ∞∫ÂØ∏</label>
                        <label class="batch-action"><input type="checkbox" id="batchWatermark"> üí¶ Âä†ÊµÆÊ∞¥Âç∞</label>
                        <label class="batch-action"><input type="checkbox" id="batchFilter"> üé® Â•óÁî®ÊøæÈè°</label>
                        <label class="batch-action"><input type="checkbox" id="batchCompress"> üì¶ Â£ìÁ∏ÆÂúñÁâá</label>
                        <label class="batch-action"><input type="checkbox" id="batchRename"> üìù ÊâπÊ¨°ÂëΩÂêç</label>
                    </div>
                    <button class="wm-action-btn add" onclick="executeBatch()">üöÄ Âü∑Ë°åÊâπÊ¨°ËôïÁêÜ</button>
                </div>
                
                <!-- ÁâπÊïàÈù¢Êùø -->
                <div class="effect-panel" id="effectPanel">
                    <div class="panel-title">üí´ ÂúñÁâáÁâπÊïà</div>
                    <div class="effect-categories">
                        <button class="effect-cat active" onclick="showEffectCategory('all')">ÂÖ®ÈÉ®</button>
                        <button class="effect-cat" onclick="showEffectCategory('art')">üé® ËóùË°ì</button>
                        <button class="effect-cat" onclick="showEffectCategory('film')">üé¨ ÈõªÂΩ±</button>
                        <button class="effect-cat" onclick="showEffectCategory('retro')">üìª Âæ©Âè§</button>
                    </div>
                    <div class="effect-grid" id="effectGrid">
                        <button class="effect-item" data-cat="art" onclick="applyEffect('emboss')">üî≤ ÊµÆÈõï</button>
                        <button class="effect-item" data-cat="art" onclick="applyEffect('edge')">üìä ÈÇäÁ∑£</button>
                        <button class="effect-item" data-cat="art" onclick="applyEffect('posterize')">üé® Ëâ≤Ë™øÂàÜÈõ¢</button>
                        <button class="effect-item" data-cat="film" onclick="applyEffect('solarize')">‚òÄÔ∏è ÊõùÂÖâ</button>
                        <button class="effect-item" data-cat="film" onclick="applyEffect('thermal')">üå°Ô∏è ÁÜ±ÊàêÂÉè</button>
                        <button class="effect-item" data-cat="film" onclick="applyEffect('xray')">üíÄ XÂÖâ</button>
                        <button class="effect-item" data-cat="film" onclick="applyEffect('night')">üåô Â§úË¶ñ</button>
                        <button class="effect-item" data-cat="art" onclick="applyEffect('comic')">üí• Êº´Áï´</button>
                        <button class="effect-item" data-cat="retro" onclick="applyEffect('pop')">üé™ ÊôÆÊôÆ</button>
                        <button class="effect-item" data-cat="retro" onclick="applyEffect('halftone')">üì∞ ÂçäËâ≤Ë™ø</button>
                        <button class="effect-item" data-cat="art" onclick="applyEffect('crosshatch')">üìê ‰∫§ÂèâÁ∑ö</button>
                        <button class="effect-item" data-cat="retro" onclick="applyEffect('dotscreen')">‚ö´ Á∂≤Èªû</button>
                    </div>
                    <div class="effect-tip">üí° ÊªëÈº†ÁßªÂà∞ÊïàÊûú‰∏äÂèØÈ†êË¶ΩÔºåÈªûÊìäÂ•óÁî®</div>
                </div>
                
                <!-- ÁñäÂä†Èù¢Êùø -->
                <div class="overlay-panel" id="overlayPanel">
                    <div class="panel-title">üé¥ ÂúñÂ±§ÁñäÂä†</div>
                    <div class="overlay-types">
                        <button class="overlay-type" onclick="showOverlayType('light')">‚òÄÔ∏è ÂÖâÊïà</button>
                        <button class="overlay-type" onclick="showOverlayType('texture')">üß± Á¥ãÁêÜ</button>
                        <button class="overlay-type" onclick="showOverlayType('pattern')">üî≤ ÂúñÊ°à</button>
                        <button class="overlay-type" onclick="showOverlayType('gradient')">üåÖ Êº∏Â±§</button>
                    </div>
                    <div class="overlay-grid" id="overlayGrid">
                        <!-- ÂãïÊÖãÂ°´ÂÖÖ -->
                    </div>
                    <div class="overlay-options">
                        <div class="wm-option">
                            <label>Ê∑∑ÂêàÊ®°Âºè</label>
                            <select id="blendMode">
                                <option value="normal">Ê≠£Â∏∏</option>
                                <option value="multiply">Ê≠£ÁâáÁñäÂ∫ï</option>
                                <option value="screen">ÊøæËâ≤</option>
                                <option value="overlay">Ë¶ÜËìã</option>
                                <option value="soft-light">ÊüîÂÖâ</option>
                                <option value="hard-light">Âº∑ÂÖâ</option>
                                <option value="color-dodge">È°èËâ≤Ê∏õÊ∑°</option>
                                <option value="color-burn">È°èËâ≤Âä†Ê∑±</option>
                            </select>
                        </div>
                        <div class="wm-option">
                            <label>ÈÄèÊòéÂ∫¶</label>
                            <input type="range" id="overlayOpacity" min="0" max="1" step="0.1" value="0.5">
                        </div>
                    </div>
                </div>
                
                <!-- ÊâπË®ªÈù¢Êùø -->
                <div class="annotate-panel" id="annotatePanel">
                    <div class="panel-title">üìù ÊâπË®ªÂ∑•ÂÖ∑</div>
                    <div class="annotate-tools">
                        <button class="annotate-tool" onclick="setAnnotateTool('highlight')">üìç Ëû¢ÂÖâÊ®ôË®ò</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('underline')">üìè Â∫ïÁ∑ö</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('strikethrough')">‚ùå Âà™Èô§Á∑ö</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('circle')">‚≠ï ÂúàÈÅ∏</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('box')">üî≤ ÊñπÊ°Ü</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('check')">‚úÖ ÊâìÂãæ</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('cross')">‚ùå ÊâìÂèâ</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('number')">üî¢ Á∑®Ëôü</button>
                    </div>
                    <div class="annotate-options">
                        <div class="wm-option">
                            <label>È°èËâ≤</label>
                            <input type="color" id="annotateColor" value="#ff0000">
                        </div>
                        <div class="wm-option">
                            <label>Á≤óÁ¥∞</label>
                            <input type="range" id="annotateWidth" min="1" max="10" value="3">
                        </div>
                    </div>
                </div>
                
                <!-- Ê≠∑Âè≤Ë®òÈåÑÈù¢Êùø -->
                <div class="history-panel" id="historyPanel">
                    <div class="panel-title">üìú Ê≠∑Âè≤Ë®òÈåÑ</div>
                    <div class="history-list" id="historyList">
                        <!-- ÂãïÊÖãÂ°´ÂÖÖ -->
                    </div>
                    <div class="history-actions">
                        <button class="action-btn danger" onclick="clearHistory()">üóëÔ∏è Ê∏ÖÈô§Ê≠∑Âè≤</button>
                    </div>
                </div>
                
                <!-- ÂúñÁâáË≥áË®äÈù¢Êùø -->
                <div class="info-panel" id="infoPanel">
                    <div class="panel-title">‚ÑπÔ∏è ÂúñÁâáË≥áË®ä</div>
                    <div class="info-content" id="infoContent">
                        <!-- ÂãïÊÖãÂ°´ÂÖÖ -->
                    </div>
                </div>
                
                <!-- È°èËâ≤ÊõøÊèõÈù¢Êùø -->
                <div class="colorreplace-panel" id="colorReplacePanel">
                    <div class="panel-title">üé® È°èËâ≤ÊõøÊèõ</div>
                    <div class="color-replace-row">
                        <div class="wm-option">
                            <label>ÂéüÂßãÈ°èËâ≤</label>
                            <input type="color" id="replaceFrom" value="#ff0000">
                            <button class="eyedropper-btn" onclick="pickReplaceColor('from')">üíß</button>
                        </div>
                        <span class="arrow">‚Üí</span>
                        <div class="wm-option">
                            <label>ÊõøÊèõÁÇ∫</label>
                            <input type="color" id="replaceTo" value="#0000ff">
                        </div>
                    </div>
                    <div class="wm-option">
                        <label>ÂÆπÂ∑ÆÔºö<span id="replaceToleranceVal">30</span></label>
                        <input type="range" id="replaceTolerance" min="0" max="100" value="30">
                    </div>
                    <button class="wm-action-btn add" onclick="replaceColor()">üîÑ Âü∑Ë°åÊõøÊèõ</button>
                </div>
                
                <!-- Ë≠â‰ª∂ÁÖßÈù¢Êùø -->
                <div class="idphoto-panel" id="idPhotoPanel">
                    <div class="panel-title">ü™™ Ë≠â‰ª∂ÁÖßË£Ω‰Ωú</div>
                    <div class="id-sizes">
                        <button class="id-size" onclick="setIdSize('1inch')">1Âêã (25√ó35mm)</button>
                        <button class="id-size" onclick="setIdSize('2inch')">2Âêã (35√ó45mm)</button>
                        <button class="id-size" onclick="setIdSize('passport')">Ë≠∑ÁÖß (35√ó45mm)</button>
                        <button class="id-size" onclick="setIdSize('visa')">Á∞ΩË≠â (33√ó48mm)</button>
                        <button class="id-size" onclick="setIdSize('license')">ÈßïÁÖß (22√ó30mm)</button>
                    </div>
                    <div class="id-options">
                        <div class="wm-option">
                            <label>ËÉåÊôØËâ≤</label>
                            <select id="idBgColor">
                                <option value="#ffffff">ÁôΩËâ≤</option>
                                <option value="#438edb">ËóçËâ≤</option>
                                <option value="#ff0000">Á¥ÖËâ≤</option>
                                <option value="#cccccc">ÁÅ∞Ëâ≤</option>
                            </select>
                        </div>
                        <div class="wm-option">
                            <label>ÊéíÁâàÊï∏Èáè</label>
                            <select id="idCount">
                                <option value="1">1Âºµ</option>
                                <option value="4">4Âºµ</option>
                                <option value="8" selected>8Âºµ</option>
                                <option value="12">12Âºµ</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="generateIdPhoto()">ü™™ Áî¢ÁîüË≠â‰ª∂ÁÖß</button>
                </div>
                
                <!-- Êà™ÂúñÁæéÂåñÈù¢Êùø -->
                <div class="screenshot-panel" id="screenshotPanel">
                    <div class="panel-title">üì≤ Êà™ÂúñÁæéÂåñ</div>
                    <div class="device-frames">
                        <button class="device-frame" onclick="addDeviceFrame('iphone')">üì± iPhone</button>
                        <button class="device-frame" onclick="addDeviceFrame('android')">üì± Android</button>
                        <button class="device-frame" onclick="addDeviceFrame('ipad')">üì± iPad</button>
                        <button class="device-frame" onclick="addDeviceFrame('macbook')">üíª MacBook</button>
                        <button class="device-frame" onclick="addDeviceFrame('imac')">üñ•Ô∏è iMac</button>
                        <button class="device-frame" onclick="addDeviceFrame('browser')">üåê ÁÄèË¶ΩÂô®</button>
                    </div>
                    <div class="screenshot-options">
                        <div class="wm-option">
                            <label>ËÉåÊôØ</label>
                            <select id="screenshotBg">
                                <option value="gradient1">Êº∏Â±§Á¥´Á≤â</option>
                                <option value="gradient2">Êº∏Â±§ËóçÁ∂†</option>
                                <option value="gradient3">Êº∏Â±§Ê©òÁ¥Ö</option>
                                <option value="solid">Á¥îËâ≤</option>
                                <option value="pattern">ÂúñÊ°à</option>
                            </select>
                        </div>
                        <label class="tile-option">
                            <input type="checkbox" id="screenshotShadow" checked>
                            <span>Ë£ùÁΩÆÈô∞ÂΩ±</span>
                        </label>
                    </div>
                </div>
                
                <!-- ÂÉèÁ¥†Áï´Èù¢Êùø -->
                <div class="pixelart-panel" id="pixelArtPanel">
                    <div class="panel-title">üëæ ÂÉèÁ¥†Âåñ</div>
                    <div class="pixel-options">
                        <div class="wm-option">
                            <label>ÂÉèÁ¥†Â§ßÂ∞è</label>
                            <input type="range" id="pixelSize" min="2" max="30" value="10">
                            <span id="pixelSizeVal">10</span>
                        </div>
                    </div>
                    <div class="pixel-presets">
                        <button class="pixel-preset" onclick="applyPixelArt(5)">Á¥∞Á∑ª</button>
                        <button class="pixel-preset" onclick="applyPixelArt(10)">‰∏≠Á≠â</button>
                        <button class="pixel-preset" onclick="applyPixelArt(20)">Á≤óÁ≥ô</button>
                        <button class="pixel-preset" onclick="applyPixelArt(30)">Ë∂ÖÂ§ß</button>
                    </div>
                </div>
                
                <!-- ASCII Èù¢Êùø -->
                <div class="ascii-panel" id="asciiPanel">
                    <div class="panel-title">üíª ASCII ËóùË°ì</div>
                    <div class="ascii-options">
                        <div class="wm-option">
                            <label>Â≠óÂÖÉÂØÜÂ∫¶</label>
                            <input type="range" id="asciiDensity" min="1" max="10" value="5">
                        </div>
                        <div class="wm-option">
                            <label>Â≠óÂÖÉÈõÜ</label>
                            <select id="asciiCharset">
                                <option value="standard">Ê®ôÊ∫ñ (@#%*+-:.)</option>
                                <option value="blocks">ÊñπÂ°ä (‚ñà‚ñì‚ñí‚ñë)</option>
                                <option value="numbers">Êï∏Â≠ó (0-9)</option>
                                <option value="custom">Ëá™Ë®Ç</option>
                            </select>
                        </div>
                    </div>
                    <textarea id="asciiOutput" class="ascii-output" readonly></textarea>
                    <div class="ascii-actions">
                        <button class="action-btn primary" onclick="generateAscii()">üîÑ ÁîüÊàê</button>
                        <button class="action-btn success" onclick="copyAscii()">üìã Ë§áË£Ω</button>
                        <button class="action-btn" onclick="asciiToImage()">üñºÔ∏è ËΩâÂúñÁâá</button>
                    </div>
                </div>
                
                <!-- ÈõôËâ≤Ë™øÈù¢Êùø -->
                <div class="duotone-panel" id="duotonePanel">
                    <div class="panel-title">üé≠ ÈõôËâ≤Ë™ø</div>
                    <div class="duotone-presets">
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4)" onclick="applyDuotone('#ff6b6b','#4ecdc4')"></button>
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#6c5ce7,#ffeaa7)" onclick="applyDuotone('#6c5ce7','#ffeaa7')"></button>
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#e17055,#0984e3)" onclick="applyDuotone('#e17055','#0984e3')"></button>
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#00b894,#fd79a8)" onclick="applyDuotone('#00b894','#fd79a8')"></button>
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#fdcb6e,#e84393)" onclick="applyDuotone('#fdcb6e','#e84393')"></button>
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#55efc4,#a29bfe)" onclick="applyDuotone('#55efc4','#a29bfe')"></button>
                    </div>
                    <div class="duotone-custom">
                        <div class="wm-option">
                            <label>ÊöóÈÉ®</label>
                            <input type="color" id="duotoneDark" value="#000000">
                        </div>
                        <div class="wm-option">
                            <label>‰∫ÆÈÉ®</label>
                            <input type="color" id="duotoneLight" value="#ffffff">
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyDuotoneCustom()">üé≠ Â•óÁî®ÈõôËâ≤Ë™ø</button>
                </div>
                
                <!-- Êº∏Â±§ÁñäÂä†Èù¢Êùø -->
                <div class="gradient-panel" id="gradientPanel">
                    <div class="panel-title">üåÖ Êº∏Â±§ÁñäÂä†</div>
                    <div class="gradient-presets">
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#667eea,#764ba2)" onclick="applyGradientOverlay('#667eea','#764ba2')"></button>
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#f093fb,#f5576c)" onclick="applyGradientOverlay('#f093fb','#f5576c')"></button>
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#4facfe,#00f2fe)" onclick="applyGradientOverlay('#4facfe','#00f2fe')"></button>
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#43e97b,#38f9d7)" onclick="applyGradientOverlay('#43e97b','#38f9d7')"></button>
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#fa709a,#fee140)" onclick="applyGradientOverlay('#fa709a','#fee140')"></button>
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#a8edea,#fed6e3)" onclick="applyGradientOverlay('#a8edea','#fed6e3')"></button>
                    </div>
                    <div class="gradient-options">
                        <div class="wm-option">
                            <label>ËßíÂ∫¶</label>
                            <input type="range" id="gradientAngle" min="0" max="360" value="135">
                            <span id="gradientAngleVal">135¬∞</span>
                        </div>
                        <div class="wm-option">
                            <label>ÈÄèÊòéÂ∫¶</label>
                            <input type="range" id="gradientOpacity" min="0.1" max="1" step="0.1" value="0.5">
                        </div>
                    </div>
                </div>
                
                <!-- ÈõúË®äÈù¢Êùø -->
                <div class="noise-panel" id="noisePanel">
                    <div class="panel-title">üìª ÈõúË®ä/È°ÜÁ≤í</div>
                    <div class="noise-options">
                        <div class="wm-option">
                            <label>Âº∑Â∫¶</label>
                            <input type="range" id="noiseAmount" min="0" max="100" value="20">
                            <span id="noiseAmountVal">20</span>
                        </div>
                        <div class="wm-option">
                            <label>È°ûÂûã</label>
                            <select id="noiseType">
                                <option value="gaussian">È´òÊñØÈõúË®ä</option>
                                <option value="uniform">ÂùáÂãªÈõúË®ä</option>
                                <option value="film">Â∫ïÁâáÈ°ÜÁ≤í</option>
                            </select>
                        </div>
                        <label class="tile-option">
                            <input type="checkbox" id="noiseColor">
                            <span>ÂΩ©Ëâ≤ÈõúË®ä</span>
                        </label>
                    </div>
                    <button class="wm-action-btn add" onclick="applyNoise()">üìª Ê∑ªÂä†ÈõúË®ä</button>
                </div>
                
                <!-- ËÉåÊôØÊ®°Á≥äÈù¢Êùø -->
                <div class="blurbg-panel" id="blurBgPanel">
                    <div class="panel-title">üå´Ô∏è ÊôØÊ∑±Ê®°Á≥ä</div>
                    <div class="blur-info">ÂÖàÁî®„ÄåÈÅ∏Âèñ„ÄçÂ∑•ÂÖ∑Ê°ÜÈÅ∏Ë¶Å‰øùÊåÅÊ∏ÖÊô∞ÁöÑÂçÄÂüü</div>
                    <div class="blur-options">
                        <div class="wm-option">
                            <label>Ê®°Á≥äÁ®ãÂ∫¶</label>
                            <input type="range" id="blurAmount" min="1" max="20" value="10">
                            <span id="blurAmountVal">10</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applySelectiveBlur()">üå´Ô∏è Â•óÁî®ÊôØÊ∑±</button>
                </div>
                
                <!-- Á¥ãÁêÜÈù¢Êùø -->
                <div class="texture-panel" id="texturePanel">
                    <div class="panel-title">üß± Á¥ãÁêÜÁñäÂä†</div>
                    <div class="texture-grid">
                        <button class="texture-item" onclick="applyTexture('paper')">üìú Á¥ôÂºµ</button>
                        <button class="texture-item" onclick="applyTexture('canvas')">üé® Áï´Â∏É</button>
                        <button class="texture-item" onclick="applyTexture('leather')">üëú ÁöÆÈù©</button>
                        <button class="texture-item" onclick="applyTexture('wood')">ü™µ Êú®Á¥ã</button>
                        <button class="texture-item" onclick="applyTexture('fabric')">üßµ Â∏ÉÊñô</button>
                        <button class="texture-item" onclick="applyTexture('metal')">üî© ÈáëÂ±¨</button>
                        <button class="texture-item" onclick="applyTexture('concrete')">üß± Ê∞¥Ê≥•</button>
                        <button class="texture-item" onclick="applyTexture('noise')">üì∫ ÈõúË®ä</button>
                    </div>
                    <div class="texture-options">
                        <div class="wm-option">
                            <label>Âº∑Â∫¶</label>
                            <input type="range" id="textureAmount" min="0.1" max="1" step="0.1" value="0.3">
                        </div>
                    </div>
                </div>
                
                <!-- Êï£ÊôØÈù¢Êùø -->
                <div class="bokeh-panel" id="bokehPanel">
                    <div class="panel-title">üí° Êï£ÊôØÂÖâÊñë</div>
                    <div class="bokeh-options">
                        <div class="wm-option">
                            <label>Êï∏Èáè</label>
                            <input type="range" id="bokehCount" min="5" max="50" value="20">
                        </div>
                        <div class="wm-option">
                            <label>Â§ßÂ∞è</label>
                            <input type="range" id="bokehSize" min="10" max="100" value="40">
                        </div>
                        <div class="wm-option">
                            <label>È°èËâ≤</label>
                            <select id="bokehColor">
                                <option value="warm">ÊöñËâ≤Á≥ª</option>
                                <option value="cool">ÂÜ∑Ëâ≤Á≥ª</option>
                                <option value="rainbow">ÂΩ©Ëôπ</option>
                                <option value="gold">ÈáëËâ≤</option>
                                <option value="custom">Ëá™Ë®Ç</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="addBokeh()">üí° Ê∑ªÂä†Êï£ÊôØ</button>
                </div>
                
                <!-- Èè°ÂÉèÈù¢Êùø -->
                <div class="mirror-panel" id="mirrorPanel">
                    <div class="panel-title">ü™û Èè°ÂÉèÊïàÊûú</div>
                    <div class="mirror-types">
                        <button class="mirror-type" onclick="applyMirror('left')">‚óß Â∑¶Èè°ÂÉè</button>
                        <button class="mirror-type" onclick="applyMirror('right')">‚ó® Âè≥Èè°ÂÉè</button>
                        <button class="mirror-type" onclick="applyMirror('top')">‚¨í ‰∏äÈè°ÂÉè</button>
                        <button class="mirror-type" onclick="applyMirror('bottom')">‚¨ì ‰∏ãÈè°ÂÉè</button>
                        <button class="mirror-type" onclick="applyMirror('quad')">‚äû ÂõõË±°Èôê</button>
                    </div>
                </div>
                
                <!-- ÂàÜÂâ≤Èù¢Êùø -->
                <div class="split-panel" id="splitPanel">
                    <div class="panel-title">üî≤ ÂúñÁâáÂàÜÂâ≤</div>
                    <div class="split-options">
                        <div class="wm-option">
                            <label>ÂàóÊï∏</label>
                            <input type="number" id="splitRows" min="1" max="10" value="3">
                        </div>
                        <div class="wm-option">
                            <label>Ê¨ÑÊï∏</label>
                            <input type="number" id="splitCols" min="1" max="10" value="3">
                        </div>
                    </div>
                    <div class="split-presets">
                        <button class="split-preset" onclick="setSplit(2,2)">2√ó2</button>
                        <button class="split-preset" onclick="setSplit(3,3)">3√ó3</button>
                        <button class="split-preset" onclick="setSplit(4,4)">4√ó4</button>
                        <button class="split-preset" onclick="setSplit(1,3)">1√ó3</button>
                        <button class="split-preset" onclick="setSplit(3,1)">3√ó1</button>
                    </div>
                    <button class="wm-action-btn add" onclick="splitImage()">üî≤ ÂàÜÂâ≤‰∏¶‰∏ãËºâ</button>
                </div>
                
                <!-- Á§æÁæ§Â™íÈ´îÈù¢Êùø -->
                <div class="social-panel" id="socialPanel">
                    <div class="panel-title">üì± Á§æÁæ§Â™íÈ´îÂ∞∫ÂØ∏</div>
                    <div class="social-platforms">
                        <div class="social-platform">
                            <div class="platform-name">üì∏ Instagram</div>
                            <button onclick="resizeForSocial('ig-post')">Ë≤ºÊñá 1:1</button>
                            <button onclick="resizeForSocial('ig-story')">ÈôêÂãï 9:16</button>
                            <button onclick="resizeForSocial('ig-reel')">Reels 9:16</button>
                        </div>
                        <div class="social-platform">
                            <div class="platform-name">üìò Facebook</div>
                            <button onclick="resizeForSocial('fb-post')">Ë≤ºÊñá</button>
                            <button onclick="resizeForSocial('fb-cover')">Â∞ÅÈù¢</button>
                            <button onclick="resizeForSocial('fb-story')">ÈôêÂãï</button>
                        </div>
                        <div class="social-platform">
                            <div class="platform-name">üê¶ Twitter/X</div>
                            <button onclick="resizeForSocial('tw-post')">Êé®Êñá</button>
                            <button onclick="resizeForSocial('tw-header')">Ê©´ÂπÖ</button>
                        </div>
                        <div class="social-platform">
                            <div class="platform-name">‚ñ∂Ô∏è YouTube</div>
                            <button onclick="resizeForSocial('yt-thumb')">Á∏ÆÂúñ</button>
                            <button onclick="resizeForSocial('yt-banner')">Ê©´ÂπÖ</button>
                        </div>
                        <div class="social-platform">
                            <div class="platform-name">üíº LinkedIn</div>
                            <button onclick="resizeForSocial('li-post')">Ë≤ºÊñá</button>
                            <button onclick="resizeForSocial('li-cover')">Ê©´ÂπÖ</button>
                        </div>
                    </div>
                </div>
                
                <!-- ÂåØÂá∫Èù¢Êùø -->
                <div class="export-panel" id="exportPanel">
                    <div class="panel-title">üíæ ÈÄ≤ÈöéÂåØÂá∫</div>
                    <div class="export-options">
                        <div class="wm-option">
                            <label>Ê†ºÂºè</label>
                            <select id="exportFormat">
                                <option value="png">PNGÔºàÁÑ°ÊêçÔºâ</option>
                                <option value="jpeg">JPEGÔºàÊúâÊêçÔºâ</option>
                                <option value="webp">WebPÔºàÈ´òÊïàÔºâ</option>
                                <option value="gif">GIF</option>
                                <option value="bmp">BMP</option>
                            </select>
                        </div>
                        <div class="wm-option" id="jpegQualityOption">
                            <label>ÂìÅË≥™</label>
                            <input type="range" id="exportQuality" min="0.1" max="1" step="0.1" value="0.9">
                            <span id="exportQualityVal">90%</span>
                        </div>
                        <div class="wm-option">
                            <label>Á∏ÆÊîæ</label>
                            <select id="exportScale">
                                <option value="1">100%</option>
                                <option value="0.75">75%</option>
                                <option value="0.5">50%</option>
                                <option value="0.25">25%</option>
                                <option value="2">200%</option>
                            </select>
                        </div>
                        <div class="wm-option">
                            <label>Ê™îÂêç</label>
                            <input type="text" id="exportFilename" value="image-magic" class="wm-input">
                        </div>
                    </div>
                    <div class="export-info" id="exportInfo">
                        È†ê‰º∞Â§ßÂ∞èÔºöË®àÁÆó‰∏≠...
                    </div>
                    <button class="wm-action-btn add" onclick="advancedExport()">üíæ ‰∏ãËºâ</button>
                </div>
                
                <!-- Ê¢óÂúñÈù¢Êùø -->
                <div class="meme-panel" id="memePanel">
                    <div class="panel-title">üòÇ Ê¢óÂúñÁî¢ÁîüÂô®</div>
                    <div class="meme-templates" id="memeTemplateGrid"></div>
                    <div class="meme-inputs" id="memeInputs"></div>
                    <div class="meme-options">
                        <div class="wm-option">
                            <label>Â≠óÂûãÂ§ßÂ∞è</label>
                            <input type="range" id="memeFontSize" min="20" max="80" value="40">
                        </div>
                        <div class="wm-option">
                            <label>ÊñáÂ≠óËâ≤</label>
                            <input type="color" id="memeFontColor" value="#ffffff">
                        </div>
                        <div class="wm-option">
                            <label>ÊèèÈÇäËâ≤</label>
                            <input type="color" id="memeStrokeColor" value="#000000">
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="generateMeme()">üòÇ Áî¢ÁîüÊ¢óÂúñ</button>
                </div>
                
                <!-- Êµ∑Â†±Èù¢Êùø -->
                <div class="poster-panel" id="posterPanel">
                    <div class="panel-title">üì∞ Êµ∑Â†±Ë£Ω‰Ωú</div>
                    <input type="text" id="posterTitle" class="wm-input" placeholder="Ê®ôÈ°å">
                    <input type="text" id="posterSubtitle" class="wm-input" placeholder="ÂâØÊ®ôÈ°å">
                    <input type="text" id="posterDate" class="wm-input" placeholder="Êó•Êúü">
                    <input type="text" id="posterLocation" class="wm-input" placeholder="Âú∞Èªû">
                    <div class="poster-styles">
                        <button class="poster-style" onclick="createPoster('movie')">üé¨ ÈõªÂΩ±</button>
                        <button class="poster-style" onclick="createPoster('concert')">üé§ ÊºîÂî±ÊúÉ</button>
                        <button class="poster-style" onclick="createPoster('sale')">üõí ÁâπË≥£</button>
                        <button class="poster-style" onclick="createPoster('minimalist')">‚¨ú Ê•µÁ∞°</button>
                        <button class="poster-style" onclick="createPoster('vintage')">üì∑ Âæ©Âè§</button>
                        <button class="poster-style" onclick="createPoster('neon')">üí° ÈúìËôπ</button>
                    </div>
                </div>
                
                <!-- Ê©´ÂπÖÈù¢Êùø -->
                <div class="banner-panel" id="bannerPanel">
                    <div class="panel-title">üéØ Ê©´ÂπÖË£Ω‰Ωú</div>
                    <input type="text" id="bannerText" class="wm-input" placeholder="Ê©´ÂπÖÊ®ôÈ°å">
                    <input type="text" id="bannerCTA" class="wm-input" placeholder="ÊåâÈàïÊñáÂ≠óÔºàÂ¶ÇÔºöÁ´ãÂç≥Ë≥ºË≤∑Ôºâ">
                    <div class="banner-colors">
                        <div class="wm-option">
                            <label>ËÉåÊôØËâ≤</label>
                            <input type="color" id="bannerBgColor" value="#667eea">
                        </div>
                        <div class="wm-option">
                            <label>ÊñáÂ≠óËâ≤</label>
                            <input type="color" id="bannerTextColor" value="#ffffff">
                        </div>
                    </div>
                    <div class="banner-sizes" id="bannerSizeGrid"></div>
                </div>
                
                <!-- ÂúñË°®Èù¢Êùø -->
                <div class="chart-panel" id="chartPanel">
                    <div class="panel-title">üìä ÂúñË°®Ë£Ω‰Ωú</div>
                    <input type="text" id="chartTitle" class="wm-input" placeholder="ÂúñË°®Ê®ôÈ°å">
                    <textarea id="chartData" class="wm-input" placeholder="Êï∏ÊìöÔºàÈÄóËôüÂàÜÈöîÔºåÂ¶ÇÔºö30,50,40,60Ôºâ" rows="2"></textarea>
                    <textarea id="chartLabels" class="wm-input" placeholder="Ê®ôÁ±§ÔºàÈÄóËôüÂàÜÈöîÔºåÂ¶ÇÔºöA,B,C,DÔºâ" rows="2"></textarea>
                    <div class="chart-types">
                        <button class="chart-type" onclick="createChart('bar')">üìä Èï∑Ê¢ùÂúñ</button>
                        <button class="chart-type" onclick="createChart('line')">üìà ÊäòÁ∑öÂúñ</button>
                        <button class="chart-type" onclick="createChart('pie')">ü•ß ÂúìÈ§ÖÂúñ</button>
                        <button class="chart-type" onclick="createChart('donut')">üç© ÁîúÁîúÂúà</button>
                        <button class="chart-type" onclick="createChart('horizontal')">üìè Ê©´Ê¢ùÂúñ</button>
                        <button class="chart-type" onclick="createChart('area')">üìâ Èù¢Á©çÂúñ</button>
                    </div>
                </div>
                
                <!-- ÊµÅÁ®ãÂúñÈù¢Êùø -->
                <div class="diagram-panel" id="diagramPanel">
                    <div class="panel-title">üìê ÊµÅÁ®ãÂúñ</div>
                    <input type="text" id="diagramText" class="wm-input" placeholder="ÂΩ¢ÁãÄÊñáÂ≠ó">
                    <div class="wm-option">
                        <label>È°èËâ≤</label>
                        <input type="color" id="diagramColor" value="#4ecdc4">
                    </div>
                    <div class="diagram-shapes">
                        <button class="diagram-shape" onclick="addDiagramShape('process')">‚¨ú ËôïÁêÜ</button>
                        <button class="diagram-shape" onclick="addDiagramShape('decision')">‚óá Âà§Êñ∑</button>
                        <button class="diagram-shape" onclick="addDiagramShape('start')">‚≠ï ÈñãÂßã/ÁµêÊùü</button>
                        <button class="diagram-shape" onclick="addDiagramShape('io')">‚ñ± Ëº∏ÂÖ•/Ëº∏Âá∫</button>
                        <button class="diagram-shape" onclick="addDiagramShape('connector')">‚óã ÈÄ£Êé•</button>
                    </div>
                    <button class="wm-action-btn add" onclick="addDiagramArrow()">‚û°Ô∏è Áï´ÁÆ≠È†≠ÈÄ£Êé•</button>
                </div>
                
                <!-- ÊôÇÈñìËª∏Èù¢Êùø -->
                <div class="timeline-panel" id="timelinePanel">
                    <div class="panel-title">üìÖ ÊôÇÈñìËª∏</div>
                    <input type="text" id="timelineTitle" class="wm-input" placeholder="ÊôÇÈñìËª∏Ê®ôÈ°å">
                    <textarea id="timelineEvents" class="wm-input" placeholder="‰∫ã‰ª∂ÔºàÊØèË°å‰∏ÄÂÄãÔºâ" rows="4"></textarea>
                    <textarea id="timelineDates" class="wm-input" placeholder="Êó•ÊúüÔºàÊØèË°å‰∏ÄÂÄãÔºâ" rows="4"></textarea>
                    <div class="wm-option">
                        <label>‰∏ªÈ°åËâ≤</label>
                        <input type="color" id="timelineColor" value="#4ecdc4">
                    </div>
                    <button class="wm-action-btn add" onclick="createTimeline()">üìÖ Âª∫Á´ãÊôÇÈñìËª∏</button>
                </div>
                
                <!-- Ë≥áË®äÂúñË°®Èù¢Êùø -->
                <div class="infographic-panel" id="infographicPanel">
                    <div class="panel-title">üìä Ë≥áË®äÂúñË°®</div>
                    <input type="text" id="infoTitle" class="wm-input" placeholder="Ê®ôÈ°å">
                    <textarea id="infoStats" class="wm-input" placeholder="È†ÖÁõÆÔºàÊØèË°å‰∏ÄÂÄãÔºâ" rows="3"></textarea>
                    <textarea id="infoValues" class="wm-input" placeholder="Êï∏ÂÄºÔºàÊØèË°å‰∏ÄÂÄãÔºâ" rows="3"></textarea>
                    <div class="infographic-types">
                        <button class="info-type" onclick="createInfographic('stats')">üìä Êï∏ÊìöÁµ±Ë®à</button>
                        <button class="info-type" onclick="createInfographic('comparison')">‚öñÔ∏è ÊØîËºÉÂúñ</button>
                        <button class="info-type" onclick="createInfographic('steps')">üî¢ Ê≠•È©üÂúñ</button>
                        <button class="info-type" onclick="createInfographic('icons')">üéØ ÂúñÁ§∫Áµ±Ë®à</button>
                    </div>
                </div>
                
                <!-- ÂêçÁâáÈù¢Êùø -->
                <div class="businesscard-panel" id="businessCardPanel">
                    <div class="panel-title">ü™™ ÂêçÁâáË£Ω‰Ωú</div>
                    <input type="text" id="cardName" class="wm-input" placeholder="ÂßìÂêç">
                    <input type="text" id="cardTitle" class="wm-input" placeholder="ËÅ∑Á®±">
                    <input type="text" id="cardCompany" class="wm-input" placeholder="ÂÖ¨Âè∏ÂêçÁ®±">
                    <input type="text" id="cardPhone" class="wm-input" placeholder="ÈõªË©±">
                    <input type="text" id="cardEmail" class="wm-input" placeholder="Email">
                    <input type="text" id="cardWebsite" class="wm-input" placeholder="Á∂≤Á´ô">
                    <div class="card-styles">
                        <button class="card-style" onclick="createBusinessCard('minimal')">‚¨ú Ê•µÁ∞°</button>
                        <button class="card-style" onclick="createBusinessCard('dark')">‚¨õ Ê∑±Ëâ≤</button>
                        <button class="card-style" onclick="createBusinessCard('gradient')">üåà Êº∏Â±§</button>
                        <button class="card-style" onclick="createBusinessCard('creative')">üé® ÂâµÊÑè</button>
                    </div>
                </div>
                
                <!-- ÁôºÁ•®Èù¢Êùø -->
                <div class="invoice-panel" id="invoicePanel">
                    <div class="panel-title">üßæ ÁôºÁ•®/Êî∂Êìö</div>
                    <input type="text" id="invoiceCompany" class="wm-input" placeholder="ÂÖ¨Âè∏ÂêçÁ®±">
                    <input type="text" id="invoiceNo" class="wm-input" placeholder="ÁôºÁ•®Á∑®Ëôü">
                    <input type="text" id="invoiceDate" class="wm-input" placeholder="Êó•Êúü">
                    <textarea id="invoiceItems" class="wm-input" placeholder="È†ÖÁõÆÔºàÊØèË°å‰∏ÄÂÄãÔºâ" rows="4"></textarea>
                    <textarea id="invoicePrices" class="wm-input" placeholder="ÈáëÈ°çÔºàÊØèË°å‰∏ÄÂÄãÔºâ" rows="4"></textarea>
                    <button class="wm-action-btn add" onclick="createInvoice()">üßæ Âª∫Á´ãÁôºÁ•®</button>
                </div>
                
                <!-- Ë≠âÊõ∏Èù¢Êùø -->
                <div class="certificate-panel" id="certificatePanel">
                    <div class="panel-title">üèÜ Ë≠âÊõ∏Ë£Ω‰Ωú</div>
                    <input type="text" id="certRecipient" class="wm-input" placeholder="ÂèóÁçé‰∫∫ÂßìÂêç">
                    <input type="text" id="certAchievement" class="wm-input" placeholder="Áç≤ÁçéÈ†ÖÁõÆ">
                    <input type="text" id="certIssuer" class="wm-input" placeholder="È†íÁôºÂñÆ‰Ωç">
                    <input type="text" id="certDate" class="wm-input" placeholder="Êó•Êúü">
                    <div class="cert-styles">
                        <button class="cert-style" onclick="createCertificate('classic')">üìú Á∂ìÂÖ∏</button>
                        <button class="cert-style" onclick="createCertificate('modern')">üé® Áèæ‰ª£</button>
                        <button class="cert-style" onclick="createCertificate('elegant')">‚ú® ÂÑ™ÈõÖ</button>
                    </div>
                </div>
                
                <!-- ÂæΩÁ´†Èù¢Êùø -->
                <div class="badge-panel" id="badgePanel">
                    <div class="panel-title">üèÖ ÂæΩÁ´†Ë£Ω‰Ωú</div>
                    <input type="text" id="badgeText" class="wm-input" placeholder="‰∏ªË¶ÅÊñáÂ≠ó">
                    <input type="text" id="badgeSubtext" class="wm-input" placeholder="ÂâØÊ®ôÊñáÂ≠ó">
                    <div class="badge-colors">
                        <div class="wm-option">
                            <label>È°èËâ≤ 1</label>
                            <input type="color" id="badgeColor1" value="#667eea">
                        </div>
                        <div class="wm-option">
                            <label>È°èËâ≤ 2</label>
                            <input type="color" id="badgeColor2" value="#764ba2">
                        </div>
                    </div>
                    <div class="badge-shapes">
                        <button class="badge-shape" onclick="createBadge('circle')">‚≠ï ÂúìÂΩ¢</button>
                        <button class="badge-shape" onclick="createBadge('shield')">üõ°Ô∏è ÁõæÁâå</button>
                        <button class="badge-shape" onclick="createBadge('ribbon')">üéÄ Á∑ûÂ∏∂</button>
                        <button class="badge-shape" onclick="createBadge('star')">‚≠ê ÊòüÂΩ¢</button>
                        <button class="badge-shape" onclick="createBadge('hexagon')">‚¨° ÂÖ≠Ëßí</button>
                    </div>
                </div>
                
                <!-- Â§ßÈ†≠Ë≤ºÈù¢Êùø -->
                <div class="avatar-panel" id="avatarPanel">
                    <div class="panel-title">üé≠ Â§ßÈ†≠Ë≤ºË£Ω‰Ωú</div>
                    <div class="avatar-options">
                        <div class="wm-option">
                            <label>ËÉåÊôØËâ≤</label>
                            <input type="color" id="avatarBgColor" value="#667eea">
                        </div>
                        <div class="wm-option">
                            <label>ÈÇäÊ°ÜÂØ¨Â∫¶</label>
                            <input type="range" id="avatarBorder" min="0" max="20" value="5">
                        </div>
                        <div class="wm-option">
                            <label>ÈÇäÊ°ÜËâ≤</label>
                            <input type="color" id="avatarBorderColor" value="#ffffff">
                        </div>
                    </div>
                    <div class="avatar-shapes">
                        <button class="avatar-shape" onclick="createAvatar('circle')">‚≠ï ÂúìÂΩ¢</button>
                        <button class="avatar-shape" onclick="createAvatar('rounded')">üî≤ ÂúìËßí</button>
                        <button class="avatar-shape" onclick="createAvatar('hexagon')">‚¨° ÂÖ≠Ëßí</button>
                    </div>
                </div>
                
                <!-- Á∏ÆÂúñÈù¢Êùø -->
                <div class="thumbnail-panel" id="thumbnailPanel">
                    <div class="panel-title">üñºÔ∏è Á∏ÆÂúñË£Ω‰Ωú</div>
                    <input type="text" id="thumbTitle" class="wm-input" placeholder="Ê®ôÈ°å">
                    <input type="text" id="thumbSubtitle" class="wm-input" placeholder="ÂâØÊ®ôÈ°å">
                    <div class="thumbnail-platforms">
                        <button class="thumb-platform" onclick="createThumbnail('youtube')">‚ñ∂Ô∏è YouTube</button>
                        <button class="thumb-platform" onclick="createThumbnail('twitch')">üü£ Twitch</button>
                        <button class="thumb-platform" onclick="createThumbnail('facebook')">üìò Facebook</button>
                        <button class="thumb-platform" onclick="createThumbnail('instagram')">üì∏ Instagram</button>
                    </div>
                </div>
                
                <!-- Â∞ÅÈù¢Èù¢Êùø -->
                <div class="cover-panel" id="coverPanel">
                    <div class="panel-title">üìö Â∞ÅÈù¢Ë£Ω‰Ωú</div>
                    <input type="text" id="coverTitle" class="wm-input" placeholder="Ê®ôÈ°å">
                    <input type="text" id="coverAuthor" class="wm-input" placeholder="‰ΩúËÄÖ">
                    <div class="cover-types">
                        <button class="cover-type" onclick="createCover('book')">üìñ Êõ∏Á±ç</button>
                        <button class="cover-type" onclick="createCover('album')">üíø Â∞àËºØ</button>
                        <button class="cover-type" onclick="createCover('magazine')">üì∞ ÈõúË™å</button>
                        <button class="cover-type" onclick="createCover('ebook')">üì± ÈõªÂ≠êÊõ∏</button>
                    </div>
                </div>
                
                <!-- Mockup Èù¢Êùø -->
                <div class="mockup-panel" id="mockupPanel">
                    <div class="panel-title">üì± Áî¢ÂìÅ Mockup</div>
                    <div class="mockup-devices">
                        <button class="mockup-device" onclick="createMockup('iphone')">üì± iPhone</button>
                        <button class="mockup-device" onclick="createMockup('macbook')">üíª MacBook</button>
                        <button class="mockup-device" onclick="createMockup('ipad')">üì± iPad</button>
                        <button class="mockup-device" onclick="createMockup('monitor')">üñ•Ô∏è Ëû¢Âπï</button>
                    </div>
                </div>
                
                <!-- Ëâ≤ÂΩ©ÂàÜÊûêÈù¢Êùø -->
                <div class="colorpalette-panel" id="colorPalettePanel">
                    <div class="panel-title">üé® Ëâ≤ÂΩ©ÂàÜÊûê</div>
                    <div class="palette-display" id="colorPaletteDisplay" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:10px;"></div>
                    <button class="wm-action-btn add" onclick="analyzeColors()">üîÑ ÈáçÊñ∞ÂàÜÊûê</button>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">üí° ÈªûÊìäÈ°èËâ≤Ë§áË£ΩËâ≤Á¢º</small>
                </div>
                
                <!-- AI Â¢ûÂº∑Èù¢Êùø -->
                <div class="aienhance-panel" id="aiEnhancePanel">
                    <div class="panel-title">‚ú® AI Â¢ûÂº∑</div>
                    <div class="ai-enhance-options">
                        <button class="ai-enhance-btn" onclick="aiEnhance('enhance')">‚ú® Ëá™ÂãïÂ¢ûÂº∑</button>
                        <button class="ai-enhance-btn" onclick="aiEnhance('denoise')">üîá ÂéªÂô™Èªû</button>
                        <button class="ai-enhance-btn" onclick="aiEnhance('sharpen')">üî™ Èä≥Âåñ</button>
                        <button class="ai-enhance-btn" onclick="aiEnhance('upscale')">üìê ÊîæÂ§ß 2x</button>
                        <button class="ai-enhance-btn" onclick="aiEnhance('restore')">üîß ‰øÆÂæ©ËÄÅÁÖßÁâá</button>
                    </div>
                </div>
                
                <!-- AI È¢®Ê†ºÈù¢Êùø -->
                <div class="aistyle-panel" id="aiStylePanel">
                    <div class="panel-title">üé® AI È¢®Ê†ºËΩâÊèõ</div>
                    <div class="ai-styles">
                        <button class="ai-style-btn" onclick="aiStyleTransfer('anime')">üéå ÂãïÊº´</button>
                        <button class="ai-style-btn" onclick="aiStyleTransfer('watercolor')">üé® Ê∞¥ÂΩ©</button>
                        <button class="ai-style-btn" onclick="aiStyleTransfer('pencil')">‚úèÔ∏è Á¥†Êèè</button>
                        <button class="ai-style-btn" onclick="aiStyleTransfer('impressionist')">üñºÔ∏è Âç∞Ë±°Ê¥æ</button>
                        <button class="ai-style-btn" onclick="aiStyleTransfer('pop_art')">üé™ ÊôÆÊôÆ</button>
                        <button class="ai-style-btn" onclick="aiStyleTransfer('cyberpunk')">ü§ñ Ë≥ΩÂçöÈæêÂÖã</button>
                    </div>
                </div>
                
                <!-- HSL Èù¢Êùø -->
                <div class="hsl-panel" id="hslPanel">
                    <div class="panel-title">üåà HSL Ë™øÊï¥</div>
                    <div class="hsl-sliders">
                        <div class="adjust-item">
                            <label>Ëâ≤Áõ∏</label>
                            <input type="range" id="hslHue" min="-180" max="180" value="0">
                            <span id="hslHueVal">0¬∞</span>
                        </div>
                        <div class="adjust-item">
                            <label>È£ΩÂíåÂ∫¶</label>
                            <input type="range" id="hslSaturation" min="-100" max="100" value="0">
                            <span id="hslSatVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>ÊòéÂ∫¶</label>
                            <input type="range" id="hslLightness" min="-100" max="100" value="0">
                            <span id="hslLightVal">0</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyHsl()">üåà Â•óÁî® HSL</button>
                </div>
                
                <!-- Ëâ≤ÈöéÈù¢Êùø -->
                <div class="levels-panel" id="levelsPanel">
                    <div class="panel-title">üìä Ëâ≤ÈöéË™øÊï¥</div>
                    <div class="levels-sliders">
                        <div class="adjust-item">
                            <label>Ëº∏ÂÖ•ÈªëÈªû</label>
                            <input type="range" id="levelsInputBlack" min="0" max="255" value="0">
                            <span>0</span>
                        </div>
                        <div class="adjust-item">
                            <label>Ëº∏ÂÖ•ÁôΩÈªû</label>
                            <input type="range" id="levelsInputWhite" min="0" max="255" value="255">
                            <span>255</span>
                        </div>
                        <div class="adjust-item">
                            <label>Gamma</label>
                            <input type="range" id="levelsGamma" min="0.1" max="3" step="0.1" value="1">
                            <span>1.0</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyLevels()">üìä Â•óÁî®Ëâ≤Èöé</button>
                </div>
                
                <!-- Áõ∏ÁâáÊøæÈè°Èù¢Êùø -->
                <div class="photo-filter-panel" id="photoFilterPanel">
                    <div class="panel-title">üì∑ Áõ∏ÁâáÊøæÈè°</div>
                    <div class="filter-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyPhotoFilter('warm')" style="background:linear-gradient(135deg,#ff9966,#ff5e62);">üåÖ ÊöñËâ≤</button>
                        <button class="wm-action-btn" onclick="applyPhotoFilter('cool')" style="background:linear-gradient(135deg,#667eea,#764ba2);">‚ùÑÔ∏è ÂÜ∑Ëâ≤</button>
                        <button class="wm-action-btn" onclick="applyPhotoFilter('sunset')" style="background:linear-gradient(135deg,#f093fb,#f5576c);">üåá Êó•ËêΩ</button>
                        <button class="wm-action-btn" onclick="applyPhotoFilter('forest')" style="background:linear-gradient(135deg,#11998e,#38ef7d);">üå≤ Ê£ÆÊûó</button>
                        <button class="wm-action-btn" onclick="applyPhotoFilter('ocean')" style="background:linear-gradient(135deg,#2193b0,#6dd5ed);">üåä Êµ∑Ê¥ã</button>
                        <button class="wm-action-btn" onclick="applyPhotoFilter('sepia')" style="background:linear-gradient(135deg,#c79081,#dfa579);">üìú Âæ©Âè§Ë§ê</button>
                    </div>
                </div>
                
                <!-- ÈÅ∏ÊìáÊÄßË™øËâ≤Èù¢Êùø -->
                <div class="selective-color-panel" id="selectiveColorPanel">
                    <div class="panel-title">üéØ ÈÅ∏ÊìáÊÄßË™øËâ≤</div>
                    <div class="selective-options">
                        <div class="wm-option">
                            <label>ÁõÆÊ®ôÈ°èËâ≤</label>
                            <select id="selectiveTarget" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="red">üî¥ Á¥ÖËâ≤</option>
                                <option value="orange">üü† Ê©ôËâ≤</option>
                                <option value="yellow">üü° ÈªÉËâ≤</option>
                                <option value="green">üü¢ Á∂†Ëâ≤</option>
                                <option value="cyan">üîµ ÈùíËâ≤</option>
                                <option value="blue">üíô ËóçËâ≤</option>
                                <option value="purple">üíú Á¥´Ëâ≤</option>
                            </select>
                        </div>
                        <div class="adjust-item">
                            <label>Ëâ≤Áõ∏ÂÅèÁßª</label>
                            <input type="range" id="selectiveHue" min="-30" max="30" value="0">
                            <span id="selectiveHueVal">0¬∞</span>
                        </div>
                        <div class="adjust-item">
                            <label>È£ΩÂíåÂ∫¶</label>
                            <input type="range" id="selectiveSat" min="-100" max="100" value="0">
                            <span id="selectiveSatVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>ÊòéÂ∫¶</label>
                            <input type="range" id="selectiveLight" min="-100" max="100" value="0">
                            <span id="selectiveLightVal">0</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applySelectiveColor()">üéØ Â•óÁî®ÈÅ∏ÊìáÊÄßË™øËâ≤</button>
                </div>
                
                <!-- Ëâ≤ÂΩ©Âπ≥Ë°°Èù¢Êùø -->
                <div class="color-balance-panel" id="colorBalancePanel">
                    <div class="panel-title">‚öñÔ∏è Ëâ≤ÂΩ©Âπ≥Ë°°</div>
                    <div class="balance-sliders">
                        <div class="adjust-item">
                            <label>ÈùíËâ≤ ‚Üî Á¥ÖËâ≤</label>
                            <input type="range" id="balanceCyanRed" min="-100" max="100" value="0">
                            <span id="balanceCRVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>Ê¥ãÁ¥Ö ‚Üî Á∂†Ëâ≤</label>
                            <input type="range" id="balanceMagentaGreen" min="-100" max="100" value="0">
                            <span id="balanceMGVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>ÈªÉËâ≤ ‚Üî ËóçËâ≤</label>
                            <input type="range" id="balanceYellowBlue" min="-100" max="100" value="0">
                            <span id="balanceYBVal">0</span>
                        </div>
                        <div class="wm-option" style="margin-top:10px;">
                            <label>Ë™øÊï¥ÁØÑÂúç</label>
                            <select id="balanceRange" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="shadows">ÊöóÈÉ®</option>
                                <option value="midtones" selected>‰∏≠ÈñìË™ø</option>
                                <option value="highlights">‰∫ÆÈÉ®</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyColorBalance()">‚öñÔ∏è Â•óÁî®Ëâ≤ÂΩ©Âπ≥Ë°°</button>
                </div>
                
                <!-- Áõ¥ÊñπÂúñÈù¢Êùø -->
                <div class="histogram-panel" id="histogramPanel">
                    <div class="panel-title">üìä Áõ¥ÊñπÂúñ</div>
                    <canvas id="histogramCanvas" width="280" height="150" style="width:100%;background:#1a1a2e;border-radius:8px;"></canvas>
                    <div style="display:flex;gap:5px;margin-top:10px;">
                        <button class="wm-action-btn" onclick="drawHistogram('all')" style="flex:1;font-size:11px;">ÂÖ®ÈÉ®</button>
                        <button class="wm-action-btn" onclick="drawHistogram('red')" style="flex:1;font-size:11px;background:#f44;">Á¥Ö</button>
                        <button class="wm-action-btn" onclick="drawHistogram('green')" style="flex:1;font-size:11px;background:#4f4;">Á∂†</button>
                        <button class="wm-action-btn" onclick="drawHistogram('blue')" style="flex:1;font-size:11px;background:#44f;">Ëóç</button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">üí° È°ØÁ§∫ÂúñÁâáÁöÑËâ≤Ë™øÂàÜ‰Ωà</small>
                </div>
                
                <!-- Êõ≤Á∑öÈù¢Êùø -->
                <div class="curve-panel" id="curvePanel">
                    <div class="panel-title">üìà Êõ≤Á∑öË™øÊï¥</div>
                    <canvas id="curveCanvas" width="200" height="200" style="width:100%;background:#1a1a2e;border-radius:8px;cursor:crosshair;"></canvas>
                    <div style="display:flex;gap:5px;margin-top:10px;">
                        <button class="wm-action-btn" onclick="setCurveChannel('rgb')" style="flex:1;font-size:11px;">RGB</button>
                        <button class="wm-action-btn" onclick="setCurveChannel('red')" style="flex:1;font-size:11px;background:#f44;">R</button>
                        <button class="wm-action-btn" onclick="setCurveChannel('green')" style="flex:1;font-size:11px;background:#4f4;">G</button>
                        <button class="wm-action-btn" onclick="setCurveChannel('blue')" style="flex:1;font-size:11px;background:#44f;">B</button>
                    </div>
                    <button class="wm-action-btn add" onclick="applyCurve()" style="margin-top:10px;">üìà Â•óÁî®Êõ≤Á∑ö</button>
                </div>
                
                <!-- Ê∂≤ÂåñÈù¢Êùø -->
                <div class="liquify-panel" id="liquifyPanel">
                    <div class="panel-title">üíß Ê∂≤ÂåñÂ∑•ÂÖ∑</div>
                    <div class="liquify-tools" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="setLiquifyTool('push')">üëÜ Êé®Áßª</button>
                        <button class="wm-action-btn" onclick="setLiquifyTool('bloat')">üî¥ ËÜ®ËÑπ</button>
                        <button class="wm-action-btn" onclick="setLiquifyTool('pucker')">‚ö´ Êî∂Á∏Æ</button>
                        <button class="wm-action-btn" onclick="setLiquifyTool('twirl')">üåÄ Êâ≠ËΩâ</button>
                    </div>
                    <div class="adjust-item" style="margin-top:10px;">
                        <label>Á≠ÜÂà∑Â§ßÂ∞è</label>
                        <input type="range" id="liquifySize" min="10" max="100" value="30">
                        <span id="liquifySizeVal">30</span>
                    </div>
                    <div class="adjust-item">
                        <label>Âº∑Â∫¶</label>
                        <input type="range" id="liquifyStrength" min="1" max="100" value="50">
                        <span id="liquifyStrengthVal">50</span>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">üí° Âú®Áï´Â∏É‰∏äÊãñÊõ≥ÈÄ≤Ë°åÊ∂≤Âåñ</small>
                </div>
                
                <!-- ÂúñÂ±§Èù¢Êùø -->
                <div class="layer-panel" id="layerPanel">
                    <div class="panel-title">üìö ÂúñÂ±§</div>
                    <div id="layerList" style="max-height:200px;overflow-y:auto;"></div>
                    <div style="display:flex;gap:8px;margin-top:10px;">
                        <button class="wm-action-btn" onclick="addLayer()" style="flex:1;">‚ûï Êñ∞Â¢û</button>
                        <button class="wm-action-btn" onclick="duplicateLayer()" style="flex:1;">üìã Ë§áË£Ω</button>
                        <button class="wm-action-btn" onclick="deleteLayer()" style="flex:1;">üóëÔ∏è Âà™Èô§</button>
                    </div>
                    <div class="adjust-item" style="margin-top:10px;">
                        <label>‰∏çÈÄèÊòéÂ∫¶</label>
                        <input type="range" id="layerOpacity" min="0" max="100" value="100">
                        <span id="layerOpacityVal">100%</span>
                    </div>
                </div>
                
                <!-- Ëâ≤ÁâàÈù¢Êùø -->
                <div class="channel-panel" id="channelPanel">
                    <div class="panel-title">üì∫ Ëâ≤Áâà</div>
                    <div class="channel-list" style="display:flex;flex-direction:column;gap:8px;">
                        <button class="wm-action-btn" onclick="showChannel('rgb')">üé® RGB ÂÖ®ÂΩ©</button>
                        <button class="wm-action-btn" onclick="showChannel('red')" style="background:#c44;">üî¥ Á¥ÖËâ≤Ëâ≤Áâà</button>
                        <button class="wm-action-btn" onclick="showChannel('green')" style="background:#4c4;">üü¢ Á∂†Ëâ≤Ëâ≤Áâà</button>
                        <button class="wm-action-btn" onclick="showChannel('blue')" style="background:#44c;">üîµ ËóçËâ≤Ëâ≤Áâà</button>
                        <button class="wm-action-btn" onclick="showChannel('alpha')" style="background:#888;">‚¨ú Alpha Ëâ≤Áâà</button>
                    </div>
                </div>
                
                <!-- Â∞çÈΩäÈù¢Êùø -->
                <div class="align-panel" id="alignPanel">
                    <div class="panel-title">üìê Â∞çÈΩäÂ∑•ÂÖ∑</div>
                    <div class="align-grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="alignSelection('left')">‚¨ÖÔ∏è</button>
                        <button class="wm-action-btn" onclick="alignSelection('centerH')">‚ÜîÔ∏è</button>
                        <button class="wm-action-btn" onclick="alignSelection('right')">‚û°Ô∏è</button>
                        <button class="wm-action-btn" onclick="alignSelection('top')">‚¨ÜÔ∏è</button>
                        <button class="wm-action-btn" onclick="alignSelection('centerV')">‚ÜïÔ∏è</button>
                        <button class="wm-action-btn" onclick="alignSelection('bottom')">‚¨áÔ∏è</button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">üí° ÂÖàÈÅ∏ÂèñÂçÄÂüüÂÜçÂ∞çÈΩä</small>
                </div>
                
                <!-- ÂèÉËÄÉÁ∑öÈù¢Êùø -->
                <div class="guide-panel" id="guidePanel">
                    <div class="panel-title">üìç ÂèÉËÄÉÁ∑ö</div>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <button class="wm-action-btn" onclick="addGuide('horizontal')">‚ûñ Êñ∞Â¢ûÊ∞¥Âπ≥Á∑ö</button>
                        <button class="wm-action-btn" onclick="addGuide('vertical')">| Êñ∞Â¢ûÂûÇÁõ¥Á∑ö</button>
                        <button class="wm-action-btn" onclick="addGuide('center')">‚ûï ‰∏≠ÂøÉÂçÅÂ≠óÁ∑ö</button>
                        <button class="wm-action-btn" onclick="addGuide('thirds')">üî≤ ‰∏âÂàÜÊ≥ïÊ†ºÁ∑ö</button>
                        <button class="wm-action-btn" onclick="clearGuides()" style="background:#f44;">üóëÔ∏è Ê∏ÖÈô§ÊâÄÊúâ</button>
                    </div>
                </div>
                
                <!-- ÈªûÈô£ÂúñÈù¢Êùø -->
                <div class="dot-art-panel" id="dotArtPanel">
                    <div class="panel-title">‚ö´ ÈªûÈô£ÂúñÊïàÊûú</div>
                    <div class="dot-options">
                        <div class="adjust-item">
                            <label>ÈªûÂ§ßÂ∞è</label>
                            <input type="range" id="dotSize" min="2" max="20" value="5">
                            <span id="dotSizeVal">5</span>
                        </div>
                        <div class="adjust-item">
                            <label>ÈªûÈñìË∑ù</label>
                            <input type="range" id="dotSpacing" min="3" max="30" value="8">
                            <span id="dotSpacingVal">8</span>
                        </div>
                        <div class="wm-option">
                            <label>ÈªûÊ®£Âºè</label>
                            <select id="dotStyle" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="circle">‚ö´ ÂúìÂΩ¢</option>
                                <option value="square">‚¨õ ÊñπÂΩ¢</option>
                                <option value="diamond">üî∑ Ëè±ÂΩ¢</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyDotArt()">‚ö´ Â•óÁî®ÈªûÈô£ÊïàÊûú</button>
                </div>
                
                <!-- Â±ÄÈÉ®ÂΩ©Ëâ≤Èù¢Êùø -->
                <div class="color-splash-panel" id="colorSplashPanel">
                    <div class="panel-title">üí¶ Â±ÄÈÉ®ÂΩ©Ëâ≤</div>
                    <div class="splash-options">
                        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;">‰øùÁïôÈÅ∏ÂèñÁöÑÈ°èËâ≤ÔºåÂÖ∂È§òËΩâÁÇ∫ÈªëÁôΩ</p>
                        <div class="wm-option">
                            <label>‰øùÁïôÈ°èËâ≤</label>
                            <input type="color" id="splashColor" value="#ff0000" style="width:100%;height:40px;border:none;cursor:pointer;">
                        </div>
                        <div class="adjust-item">
                            <label>ÂÆπÂ∑Æ</label>
                            <input type="range" id="splashTolerance" min="10" max="100" value="30">
                            <span id="splashToleranceVal">30</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyColorSplash()">üí¶ Â•óÁî®Â±ÄÈÉ®ÂΩ©Ëâ≤</button>
                </div>
                
                <!-- Áò¶ËáâÈù¢Êùø -->
                <div class="slim-face-panel" id="slimFacePanel">
                    <div class="panel-title">üßë Áò¶ËáâÂ∑•ÂÖ∑</div>
                    <div class="face-options">
                        <div class="adjust-item">
                            <label>Áò¶ËáâÁ®ãÂ∫¶</label>
                            <input type="range" id="slimAmount" min="0" max="100" value="30">
                            <span id="slimAmountVal">30%</span>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">üí° Ê≠§ÂäüËÉΩÈúÄË¶Å AI Ê®°ÂûãÊîØÊè¥ÔºåÁõÆÂâçÊèê‰æõÊ®°Êì¨ÊïàÊûú</small>
                    </div>
                    <button class="wm-action-btn add" onclick="applySlimFace()">üßë Â•óÁî®Áò¶Ëáâ</button>
                </div>
                
                <!-- Â§ßÁúºÈù¢Êùø -->
                <div class="big-eye-panel" id="bigEyePanel">
                    <div class="panel-title">üëÄ Â§ßÁúºÂ∑•ÂÖ∑</div>
                    <div class="eye-options">
                        <div class="adjust-item">
                            <label>ÊîæÂ§ßÁ®ãÂ∫¶</label>
                            <input type="range" id="eyeEnlarge" min="0" max="100" value="20">
                            <span id="eyeEnlargeVal">20%</span>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">üí° Ê≠§ÂäüËÉΩÈúÄË¶Å AI Ê®°ÂûãÊîØÊè¥ÔºåÁõÆÂâçÊèê‰æõÊ®°Êì¨ÊïàÊûú</small>
                    </div>
                    <button class="wm-action-btn add" onclick="applyBigEye()">üëÄ Â•óÁî®Â§ßÁúº</button>
                </div>
                
                <!-- ÂΩ©Â¶ùÈù¢Êùø -->
                <div class="makeup-panel" id="makeupPanel">
                    <div class="panel-title">üíÑ ÂΩ©Â¶ùÂ∑•ÂÖ∑</div>
                    <div class="makeup-options" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyMakeup('lipstick')">üíã Âè£Á¥Ö</button>
                        <button class="wm-action-btn" onclick="applyMakeup('blush')">üå∏ ËÖÆÁ¥Ö</button>
                        <button class="wm-action-btn" onclick="applyMakeup('eyeshadow')">üëÅÔ∏è ÁúºÂΩ±</button>
                        <button class="wm-action-btn" onclick="applyMakeup('eyeliner')">‚úèÔ∏è ÁúºÁ∑ö</button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">üí° Ê≠§ÂäüËÉΩÈúÄË¶Å AI ‰∫∫ËáâÊ™¢Ê∏¨</small>
                </div>
                
                <!-- ÊèõËáâÈù¢Êùø -->
                <div class="face-swap-panel" id="faceSwapPanel">
                    <div class="panel-title">üé≠ ÊèõËáâÂ∑•ÂÖ∑</div>
                    <div class="swap-options">
                        <input type="file" id="faceSwapInput" accept="image/*" style="margin-bottom:10px;">
                        <small style="color:var(--text-secondary);font-size:10px;display:block;">ÈÅ∏ÊìáË¶ÅÊõøÊèõÁöÑËáâÈÉ®ÂúñÁâá</small>
                    </div>
                    <button class="wm-action-btn add" onclick="applyFaceSwap()">üé≠ ÈñãÂßãÊèõËáâ</button>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">‚ö†Ô∏è Ê≠§ÂäüËÉΩÈúÄË¶ÅÈÄ≤Èöé AI Ê®°Âûã</small>
                </div>
                
                <!-- È™®Êû∂Èù¢Êùø -->
                <div class="skeleton-panel" id="skeletonPanel">
                    <div class="panel-title">ü¶¥ È™®Êû∂Ê™¢Ê∏¨</div>
                    <div class="skeleton-options">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="showSkeleton" style="width:18px;height:18px;">
                            <span>È°ØÁ§∫È™®Êû∂Á∑öÊ¢ù</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-top:8px;">
                            <input type="checkbox" id="showKeypoints" checked style="width:18px;height:18px;">
                            <span>È°ØÁ§∫ÈóúÁØÄÈªû</span>
                        </label>
                    </div>
                    <button class="wm-action-btn add" onclick="detectSkeleton()">ü¶¥ Ê™¢Ê∏¨È™®Êû∂</button>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">üí° ÈúÄË¶Å AI ÂßøÊÖãÊ™¢Ê∏¨Ê®°Âûã</small>
                </div>
                
                <!-- Èè°È†≠Ê®°Á≥äÈù¢Êùø -->
                <div class="lens-blur-panel" id="lensBlurPanel">
                    <div class="panel-title">üì∑ Èè°È†≠Ê®°Á≥ä</div>
                    <div class="blur-options">
                        <div class="adjust-item">
                            <label>Ê®°Á≥äÂçäÂæë</label>
                            <input type="range" id="lensBlurRadius" min="1" max="50" value="10">
                            <span id="lensBlurRadiusVal">10</span>
                        </div>
                        <div class="adjust-item">
                            <label>Êï£ÊôØÂΩ¢ÁãÄ</label>
                            <select id="bokehShape" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="circle">‚ö™ ÂúìÂΩ¢</option>
                                <option value="hexagon">‚¨° ÂÖ≠ÈÇäÂΩ¢</option>
                                <option value="octagon">‚ØÉ ÂÖ´ÈÇäÂΩ¢</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyLensBlur()">üì∑ Â•óÁî®Èè°È†≠Ê®°Á≥ä</button>
                </div>
                
                <!-- ÂãïÊÖãÊ®°Á≥äÈù¢Êùø -->
                <div class="motion-blur-panel" id="motionBlurPanel">
                    <div class="panel-title">üí® ÂãïÊÖãÊ®°Á≥ä</div>
                    <div class="motion-options">
                        <div class="adjust-item">
                            <label>Ê®°Á≥äË∑ùÈõ¢</label>
                            <input type="range" id="motionDistance" min="5" max="100" value="20">
                            <span id="motionDistanceVal">20</span>
                        </div>
                        <div class="adjust-item">
                            <label>ËßíÂ∫¶</label>
                            <input type="range" id="motionAngle" min="0" max="360" value="0">
                            <span id="motionAngleVal">0¬∞</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyMotionBlur()">üí® Â•óÁî®ÂãïÊÖãÊ®°Á≥ä</button>
                </div>
                
                <!-- ËÆäÂΩ¢Èù¢Êùø -->
                <div class="warp-panel" id="warpPanel">
                    <div class="panel-title">üîÑ ËÆäÂΩ¢Â∑•ÂÖ∑</div>
                    <div class="warp-options" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyWarp('arc')">üåô ÂºßÂΩ¢</button>
                        <button class="wm-action-btn" onclick="applyWarp('bulge')">üî¥ Âá∏Ëµ∑</button>
                        <button class="wm-action-btn" onclick="applyWarp('pinch')">‚ö´ Êì†Â£ì</button>
                        <button class="wm-action-btn" onclick="applyWarp('twist')">üåÄ Êâ≠ËΩâ</button>
                        <button class="wm-action-btn" onclick="applyWarp('wave')">„Ä∞Ô∏è Ê≥¢Êµ™</button>
                        <button class="wm-action-btn" onclick="applyWarp('fisheye')">üêü È≠öÁúº</button>
                    </div>
                </div>
                
                <!-- ÈÄèË¶ñÈù¢Êùø -->
                <div class="perspective-panel" id="perspectivePanel">
                    <div class="panel-title">üî≤ ÈÄèË¶ñËÆäÊèõ</div>
                    <div class="perspective-options">
                        <div class="adjust-item">
                            <label>Ê∞¥Âπ≥ÂÇæÊñú</label>
                            <input type="range" id="perspectiveH" min="-45" max="45" value="0">
                            <span id="perspectiveHVal">0¬∞</span>
                        </div>
                        <div class="adjust-item">
                            <label>ÂûÇÁõ¥ÂÇæÊñú</label>
                            <input type="range" id="perspectiveV" min="-45" max="45" value="0">
                            <span id="perspectiveVVal">0¬∞</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyPerspective()">üî≤ Â•óÁî®ÈÄèË¶ñ</button>
                </div>
                
                <!-- Êâ≠Êõ≤Èù¢Êùø -->
                <div class="distort-panel" id="distortPanel">
                    <div class="panel-title">üåä Êâ≠Êõ≤ÊïàÊûú</div>
                    <div class="distort-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyDistort('spherize')">üîÆ ÁêÉÈù¢Âåñ</button>
                        <button class="wm-action-btn" onclick="applyDistort('ripple')">üåä Êº£Êº™</button>
                        <button class="wm-action-btn" onclick="applyDistort('zigzag')">‚ö° Èã∏ÈΩí</button>
                        <button class="wm-action-btn" onclick="applyDistort('polar')">üéØ Ê•µÂ∫ßÊ®ô</button>
                    </div>
                </div>
                
                <!-- Âç°ÁâáÈù¢Êùø -->
                <div class="card-panel" id="cardPanel">
                    <div class="panel-title">üé¥ Âç°ÁâáÊ®°Êùø</div>
                    <div class="card-templates" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="createCard('birthday')">üéÇ ÁîüÊó•Âç°</button>
                        <button class="wm-action-btn" onclick="createCard('christmas')">üéÑ ËÅñË™ïÂç°</button>
                        <button class="wm-action-btn" onclick="createCard('wedding')">üíí Â©öÁ¶ÆÂç°</button>
                        <button class="wm-action-btn" onclick="createCard('thanks')">üôè ÊÑüË¨ùÂç°</button>
                        <button class="wm-action-btn" onclick="createCard('invite')">üíå ÈÇÄË´ãÂáΩ</button>
                        <button class="wm-action-btn" onclick="createCard('greeting')">üëã ÂïèÂÄôÂç°</button>
                    </div>
                </div>
                
                <!-- Logo Èù¢Êùø -->
                <div class="logo-panel" id="logoPanel">
                    <div class="panel-title">üè¢ Logo Ë£Ω‰Ωú</div>
                    <div class="logo-options">
                        <input type="text" id="logoText" placeholder="Ëº∏ÂÖ• Logo ÊñáÂ≠ó..." value="LOGO" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);margin-bottom:10px;background:var(--bg-input);color:var(--text-primary);font-size:16px;">
                        <div class="wm-option">
                            <label>Â≠óÈ´îÊ®£Âºè</label>
                            <select id="logoFont" style="padding:8px;border-radius:4px;width:100%;background:var(--bg-input);color:var(--text-primary);">
                                <option value="bold">Á≤óÈ´î</option>
                                <option value="elegant">ÂÑ™ÈõÖ</option>
                                <option value="tech">ÁßëÊäÄ</option>
                                <option value="handwrite">ÊâãÂØ´</option>
                            </select>
                        </div>
                        <div style="margin-top:10px;">
                            <label style="font-size:12px;color:var(--text-secondary);">Êº∏Â±§È°èËâ≤</label>
                            <div style="display:flex;gap:10px;margin-top:5px;">
                                <input type="color" id="logoColor1" value="#667eea" style="flex:1;height:40px;border:none;cursor:pointer;border-radius:4px;">
                                <input type="color" id="logoColor2" value="#764ba2" style="flex:1;height:40px;border:none;cursor:pointer;border-radius:4px;">
                            </div>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="createLogo()" style="margin-top:10px;">üè¢ Áî¢Áîü Logo</button>
                </div>
                
                <!-- ÂàóÂç∞Èù¢Êùø -->
                <div class="print-panel" id="printPanel">
                    <div class="panel-title">üñ®Ô∏è ÂàóÂç∞Ë®≠ÂÆö</div>
                    <div class="print-preview" style="background:#fff;padding:10px;border-radius:8px;margin-bottom:10px;text-align:center;">
                        <img id="printPreviewImg" style="max-width:100%;max-height:150px;border:1px solid #ddd;">
                    </div>
                    <div class="print-options">
                        <div class="wm-option">
                            <label>Á¥ôÂºµÂ§ßÂ∞è</label>
                            <select id="printSize" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="a4">A4 (210√ó297mm)</option>
                                <option value="a3">A3 (297√ó420mm)</option>
                                <option value="letter">Letter (8.5√ó11")</option>
                                <option value="photo4x6">4√ó6 Áõ∏Áâá</option>
                                <option value="photo5x7">5√ó7 Áõ∏Áâá</option>
                            </select>
                        </div>
                        <div class="wm-option">
                            <label>ÂàóÂç∞ÂìÅË≥™</label>
                            <select id="printQuality" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="high">È´òÂìÅË≥™</option>
                                <option value="normal" selected>Ê®ôÊ∫ñ</option>
                                <option value="draft">ËçâÁ®ø</option>
                            </select>
                        </div>
                        <div class="wm-option" style="display:flex;align-items:center;gap:10px;">
                            <input type="checkbox" id="printFitPage" checked style="width:18px;height:18px;">
                            <label for="printFitPage">Ëá™ÂãïÁ∏ÆÊîæËá≥Á¥ôÂºµÂ§ßÂ∞è</label>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="printImage()">üñ®Ô∏è ÈñãÂïüÂàóÂç∞Â∞çË©±Ê°Ü</button>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">üí° ÊúÉÈñãÂïüÁ≥ªÁµ±ÂàóÂç∞Ë¶ñÁ™óÔºåÂèØÈÅ∏ÊìáÂç∞Ë°®Ê©ü</small>
                </div>
                
                <!-- ÂàÜ‰∫´Èù¢Êùø -->
                <div class="share-panel" id="sharePanel">
                    <div class="panel-title">üì§ ÂàÜ‰∫´ÂúñÁâá</div>
                    <div class="share-buttons" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <button class="wm-action-btn" onclick="shareNative()" style="background:linear-gradient(135deg,#667eea,#764ba2);">
                            üì± Á≥ªÁµ±ÂàÜ‰∫´
                        </button>
                        <button class="wm-action-btn" onclick="shareToEmail()" style="background:linear-gradient(135deg,#f093fb,#f5576c);">
                            üìß Email
                        </button>
                        <button class="wm-action-btn" onclick="copyToClipboard()" style="background:linear-gradient(135deg,#4facfe,#00f2fe);">
                            üìã Ë§áË£ΩÂúñÁâá
                        </button>
                        <button class="wm-action-btn" onclick="sendToLine()" style="background:#06c755;">
                            üí¨ LINE
                        </button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">üí° Á≥ªÁµ±ÂàÜ‰∫´ÊîØÊè¥ÊâÄÊúâÂ∑≤ÂÆâË£ùÁöÑÊáâÁî®Á®ãÂºè</small>
                </div>
                
                <!-- Èõ≤Á´ØÈù¢Êùø -->
                <div class="cloud-panel" id="cloudPanel">
                    <div class="panel-title">‚òÅÔ∏è Èõ≤Á´ØÂúñÂ∫ä</div>
                    <div class="cloud-api-setting" style="margin-bottom:15px;padding:10px;background:rgba(99,102,241,0.1);border-radius:8px;">
                        <label style="font-size:12px;display:block;margin-bottom:5px;">üîë ImgBB API Key</label>
                        <div style="display:flex;gap:5px;">
                            <input type="password" id="imgbbApiKey" placeholder="Ëº∏ÂÖ• API Key..." style="flex:1;padding:8px;border-radius:4px;border:1px solid var(--border);background:var(--bg-input);">
                            <button onclick="togglePassword('imgbbApiKey', this)" style="padding:8px;border-radius:4px;border:none;background:var(--bg-input);cursor:pointer;">üëÅÔ∏è</button>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:5px;">
                            Âæû <a href="https://api.imgbb.com/" target="_blank" style="color:var(--primary);">api.imgbb.com</a> ÂÖçË≤ªÂèñÂæó
                        </small>
                    </div>
                    <div class="cloud-buttons" style="display:flex;flex-direction:column;gap:10px;">
                        <button class="wm-action-btn" onclick="uploadToImgBB()" style="background:linear-gradient(135deg,#3498db,#2980b9);">
                            üåê ‰∏äÂÇ≥Ëá≥ ImgBB
                        </button>
                        <button class="wm-action-btn" onclick="saveToLocalStorage()" style="background:linear-gradient(135deg,#667eea,#764ba2);">
                            üíæ Â≠òÂà∞ÁÄèË¶ΩÂô®ÔºàÈõ¢Á∑öÔºâ
                        </button>
                        <button class="wm-action-btn" onclick="loadFromLocalStorage()" style="background:linear-gradient(135deg,#f093fb,#f5576c);">
                            üìÇ ÂæûÁÄèË¶ΩÂô®ËºâÂÖ•
                        </button>
                    </div>
                    <div id="cloudResult" style="margin-top:10px;padding:10px;background:var(--bg-input);border-radius:8px;display:none;">
                        <small>‰∏äÂÇ≥ÁµêÊûúÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£°</small>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">üí° ImgBB Êèê‰æõÂÖçË≤ªÊ∞∏‰πÖÂúñÂ∫äÔºå‰∏äÂÇ≥ÂæåÂèØÂèñÂæóÂàÜ‰∫´ÈÄ£Áµê</small>
                </div>
                
                <!-- Âø´Êç∑ÈçµÈù¢Êùø -->
                <div class="shortcut-panel" id="shortcutPanel">
                    <div class="panel-title">‚å®Ô∏è Âø´Êç∑Èçµ‰∏ÄË¶Ω</div>
                    <div class="shortcut-list" style="font-size:12px;line-height:2;">
                        <div><kbd>Ctrl+Z</kbd> Âæ©Âéü</div>
                        <div><kbd>Ctrl+S</kbd> ÂÑ≤Â≠ò</div>
                        <div><kbd>Ctrl+C</kbd> Ë§áË£Ω</div>
                        <div><kbd>Ctrl+V</kbd> Ë≤º‰∏ä</div>
                        <div><kbd>ESC</kbd> ÂèñÊ∂àÂ∑•ÂÖ∑</div>
                        <div><kbd>Delete</kbd> Ê∏ÖÈô§ÈÅ∏Âèñ</div>
                        <div><kbd>+/-</kbd> Á∏ÆÊîæ</div>
                        <div><kbd>0</kbd> ÈáçÁΩÆÁ∏ÆÊîæ</div>
                        <div><kbd>R</kbd> ÊóãËΩâ 90¬∞</div>
                        <div><kbd>H</kbd> Ê∞¥Âπ≥ÁøªËΩâ</div>
                        <div><kbd>V</kbd> ÂûÇÁõ¥ÁøªËΩâ</div>
                    </div>
                </div>
                
                <!-- Ë™™ÊòéÈù¢Êùø -->
                <div class="help-panel" id="helpPanel">
                    <div class="panel-title">‚ùì ‰ΩøÁî®Ë™™Êòé</div>
                    <div style="font-size:12px;line-height:1.8;">
                        <p><strong>üì∑ ËºâÂÖ•ÂúñÁâá</strong><br>ÈªûÊìä‰∏äÂÇ≥ÊàñÊãñÊîæÂúñÁâáÂà∞Áï´Â∏É</p>
                        <p><strong>‚úÇÔ∏è ÈÅ∏ÂèñÂ∑•ÂÖ∑</strong><br>Ê°ÜÈÅ∏ÂçÄÂüüÂæåÂèØË£ÅÂàá„ÄÅÊ®°Á≥ä„ÄÅË§áË£Ω</p>
                        <p><strong>üî≤ È¶¨Ë≥ΩÂÖã</strong><br>Âú®Áï´Â∏É‰∏äÂ°óÊäπÊâìÁ¢º</p>
                        <p><strong>üí¶ ÊµÆÊ∞¥Âç∞</strong><br>Ê∑ªÂä†ÊñáÂ≠óÊàñÂúñÁâáÊµÆÊ∞¥Âç∞</p>
                        <p><strong>üîñ ÂúñÁ´†</strong><br>Ê∑ªÂä†Êó•Êúü„ÄÅÊ†∏ÂáÜÁ≠âÂç∞Á´†</p>
                        <p><strong>üì± QRÁ¢º</strong><br>ÁîüÊàê‰∏¶ÊîæÁΩÆ QR Code</p>
                        <p><strong>üé® ÊøæÈè°</strong><br>Â•óÁî®ÂêÑÁ®ÆÁõ∏ÁâáÊøæÈè°</p>
                        <p><strong>üíæ ÂÑ≤Â≠ò</strong><br>‰∏ãËºâÁÇ∫ PNG/JPG/PDF</p>
                    </div>
                </div>
                
                <!-- Ë™øËâ≤Èù¢Êùø -->
                <div class="color-grade-panel" id="colorGradePanel">
                    <div class="panel-title">üé¨ ÈõªÂΩ±Ë™øËâ≤</div>
                    <div class="preset-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyColorGrade('teal-orange')" style="background:linear-gradient(135deg,#008080,#ff6600);">üåä ÈùíÊ©ô</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('noir')" style="background:linear-gradient(135deg,#1a1a1a,#4a4a4a);">üé¨ ÈªëËâ≤ÈõªÂΩ±</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('matrix')" style="background:linear-gradient(135deg,#003300,#00ff00);">üíö Èß≠ÂÆ¢‰ªªÂãô</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('sepia-cinema')" style="background:linear-gradient(135deg,#704214,#c4a35a);">üìú Âæ©Âè§Ë§ê</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('blade-runner')" style="background:linear-gradient(135deg,#ff6b00,#0066ff);">üåÉ ÈäÄÁøºÊÆ∫Êâã</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('horror')" style="background:linear-gradient(135deg,#8b0000,#2d0000);">üëª ÊÅêÊÄñÁâá</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('romance')" style="background:linear-gradient(135deg,#ffb6c1,#ff69b4);">üíï Êµ™Êº´</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('action')" style="background:linear-gradient(135deg,#ff4500,#1e90ff);">üí• Âãï‰ΩúÁâá</button>
                    </div>
                </div>
                
                <!-- LUT Èù¢Êùø -->
                <div class="lut-panel" id="lutPanel">
                    <div class="panel-title">üé• LUT ÊøæÈè°</div>
                    <div class="preset-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyLut('fuji')" style="background:linear-gradient(135deg,#2e8b57,#98fb98);">üéûÔ∏è Fuji ÂØåÂ£´</button>
                        <button class="wm-action-btn" onclick="applyLut('kodak')" style="background:linear-gradient(135deg,#daa520,#ffd700);">üéûÔ∏è Kodak ÊüØÈÅî</button>
                        <button class="wm-action-btn" onclick="applyLut('cinematic')" style="background:linear-gradient(135deg,#483d8b,#7b68ee);">üé¨ ÈõªÂΩ±ÊÑü</button>
                        <button class="wm-action-btn" onclick="applyLut('portrait')" style="background:linear-gradient(135deg,#deb887,#f5deb3);">üë§ ‰∫∫ÂÉè</button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">üí° LUT ÊòØÂ∞àÊ•≠Ë™øËâ≤È†êË®≠ÔºåÂèØÂø´ÈÄüÂ•óÁî®ÈõªÂΩ±Ë≥™ÊÑü</small>
                </div>
                
                <!-- Âæ©Âè§Èù¢Êùø -->
                <div class="vintage-panel" id="vintagePanel">
                    <div class="panel-title">üìª Âæ©Âè§ÊïàÊûú</div>
                    <div class="preset-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyVintagePreset('60s')" style="background:linear-gradient(135deg,#cd853f,#f4a460);">üì∫ 60Âπ¥‰ª£</button>
                        <button class="wm-action-btn" onclick="applyVintagePreset('70s')" style="background:linear-gradient(135deg,#d2691e,#ff8c00);">üï∫ 70Âπ¥‰ª£</button>
                        <button class="wm-action-btn" onclick="applyVintagePreset('80s')" style="background:linear-gradient(135deg,#ff1493,#00ffff);">üé∏ 80Âπ¥‰ª£</button>
                        <button class="wm-action-btn" onclick="applyVintagePreset('90s')" style="background:linear-gradient(135deg,#808080,#c0c0c0);">üíæ 90Âπ¥‰ª£</button>
                        <button class="wm-action-btn" onclick="applyVintagePreset('polaroid')" style="background:linear-gradient(135deg,#f5f5dc,#fffacd);">üì∏ ÊãçÁ´ãÂæó</button>
                        <button class="wm-action-btn" onclick="applyVintagePreset('daguerreotype')" style="background:linear-gradient(135deg,#696969,#a9a9a9);">üñºÔ∏è ÈäÄÁâàÊîùÂΩ±</button>
                    </div>
                </div>
                
                <!-- Â∫ïÁâáÈù¢Êùø -->
                <div class="film-panel" id="filmPanel">
                    <div class="panel-title">üéûÔ∏è Â∫ïÁâáÊ®°Êì¨</div>
                    <div class="preset-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyFilmEffect('portra400')" style="background:linear-gradient(135deg,#deb887,#f5deb3);">üì∑ Portra 400</button>
                        <button class="wm-action-btn" onclick="applyFilmEffect('ektar100')" style="background:linear-gradient(135deg,#ff6347,#ffa07a);">üì∑ Ektar 100</button>
                        <button class="wm-action-btn" onclick="applyFilmEffect('velvia50')" style="background:linear-gradient(135deg,#228b22,#32cd32);">üì∑ Velvia 50</button>
                        <button class="wm-action-btn" onclick="applyFilmEffect('provia100')" style="background:linear-gradient(135deg,#4682b4,#87ceeb);">üì∑ Provia 100</button>
                        <button class="wm-action-btn" onclick="applyFilmEffect('cinestill800')" style="background:linear-gradient(135deg,#ff4500,#ffd700);">üì∑ CineStill 800</button>
                        <button class="wm-action-btn" onclick="applyFilmEffect('trix400')" style="background:linear-gradient(135deg,#2f2f2f,#5f5f5f);">üì∑ Tri-X 400</button>
                    </div>
                </div>
                
                <!-- ÈõªÂΩ±ÊïàÊûúÈù¢Êùø -->
                <div class="cinema-panel" id="cinemaPanel">
                    <div class="panel-title">üé¨ ÈõªÂΩ±ÊïàÊûú</div>
                    <div class="cinema-options" style="display:flex;flex-direction:column;gap:10px;">
                        <div class="wm-option">
                            <label>Áï´Èù¢ÊØî‰æã</label>
                            <select id="cinemaRatio" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="2.35">2.35:1 ÂØ¨ÈäÄÂπï</option>
                                <option value="2.39">2.39:1 ËÆäÂΩ¢ÂØ¨ÈäÄÂπï</option>
                                <option value="1.85">1.85:1 Ê®ôÊ∫ñÂØ¨ÈäÄÂπï</option>
                                <option value="1.33">4:3 Á∂ìÂÖ∏</option>
                            </select>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:8px;">
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                <input type="checkbox" id="cinemaLetterbox" checked style="width:18px;height:18px;">
                                <span>üé¨ ÈõªÂΩ±ÈªëÈÇä (Letterbox)</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                <input type="checkbox" id="cinemaGrain" style="width:18px;height:18px;">
                                <span>üéûÔ∏è Â∫ïÁâáÈ°ÜÁ≤í</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                <input type="checkbox" id="cinemaVignette" style="width:18px;height:18px;">
                                <span>üî≤ ÊöóËßíÊïàÊûú</span>
                            </label>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyCinemaEffect()" style="margin-top:10px;">üé¨ Â•óÁî®ÈõªÂΩ±ÊïàÊûú</button>
                </div>
                
                <!-- ÂàÜÈõ¢Ëâ≤Ë™øÈù¢Êùø -->
                <div class="split-tone-panel" id="splitTonePanel">
                    <div class="panel-title">üé® ÂàÜÈõ¢Ëâ≤Ë™ø</div>
                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <div class="tone-section">
                            <label style="display:flex;align-items:center;gap:8px;">
                                <span>‚òÄÔ∏è ‰∫ÆÈÉ®Ëâ≤Ë™ø</span>
                                <input type="color" id="highlightTone" value="#ffd700" style="width:40px;height:30px;border:none;cursor:pointer;">
                            </label>
                            <div class="adjust-item" style="margin-top:5px;">
                                <label>È£ΩÂíåÂ∫¶</label>
                                <input type="range" id="highlightSat" min="0" max="100" value="25">
                                <span id="highlightSatVal">25%</span>
                            </div>
                        </div>
                        <div class="tone-section">
                            <label style="display:flex;align-items:center;gap:8px;">
                                <span>üåô ÊöóÈÉ®Ëâ≤Ë™ø</span>
                                <input type="color" id="shadowTone" value="#4169e1" style="width:40px;height:30px;border:none;cursor:pointer;">
                            </label>
                            <div class="adjust-item" style="margin-top:5px;">
                                <label>È£ΩÂíåÂ∫¶</label>
                                <input type="range" id="shadowSat" min="0" max="100" value="25">
                                <span id="shadowSatVal">25%</span>
                            </div>
                        </div>
                        <div class="adjust-item">
                            <label>Âπ≥Ë°°</label>
                            <input type="range" id="toneBalance" min="-100" max="100" value="0">
                            <span id="toneBalanceVal">0</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applySplitTone()" style="margin-top:10px;">üé® Â•óÁî®ÂàÜÈõ¢Ëâ≤Ë™ø</button>
                </div>
                
                <!-- ÂèñËâ≤Âô®Èù¢Êùø -->
                <div class="eyedropper-panel" id="eyeDropperAdvPanel">
                    <div class="panel-title">üíâ ÂèñËâ≤Âô®</div>
                    <div id="colorPreviewLarge" style="width:100%;height:60px;background:#888;border-radius:8px;margin-bottom:10px;"></div>
                    <div style="display:flex;flex-direction:column;gap:8px;font-size:12px;">
                        <div style="display:flex;justify-content:space-between;">
                            <span>HEX:</span>
                            <span id="colorHex">#888888</span>
                            <button onclick="copyColor('hex')" style="padding:2px 8px;font-size:10px;cursor:pointer;">Ë§áË£Ω</button>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>RGB:</span>
                            <span id="colorRgb">rgb(136, 136, 136)</span>
                            <button onclick="copyColor('rgb')" style="padding:2px 8px;font-size:10px;cursor:pointer;">Ë§áË£Ω</button>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>HSL:</span>
                            <span id="colorHsl">hsl(0, 0%, 53%)</span>
                            <button onclick="copyColor('hsl')" style="padding:2px 8px;font-size:10px;cursor:pointer;">Ë§áË£Ω</button>
                        </div>
                    </div>
                    <div id="colorHistory" style="display:flex;gap:5px;flex-wrap:wrap;margin-top:10px;"></div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">üí° ÈªûÊìäÁï´Â∏É‰ªªÊÑè‰ΩçÁΩÆÂèñËâ≤</small>
                </div>
                
                <!-- GIF Èù¢Êùø -->
                <div class="gif-panel" id="gifPanel">
                    <div class="panel-title">üé¨ GIF ÂãïÂúñ</div>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <div class="wm-option">
                            <label>ÈÅ∏ÊìáÂ§öÂºµÂúñÁâáË£Ω‰Ωú GIF</label>
                            <input type="file" id="gifFrameInput" multiple accept="image/*" onchange="addGifFrames(event)" style="margin-top:5px;">
                        </div>
                        <div class="wm-option">
                            <label>ÊØèÂπÄÈñìÈöî (ÊØ´Áßí)</label>
                            <input type="range" id="gifDelay" min="50" max="1000" value="200" oninput="document.getElementById('gifDelayVal').textContent=this.value+'ms'">
                            <span id="gifDelayVal">200ms</span>
                        </div>
                        <div id="gifFramePreview" style="display:flex;gap:5px;flex-wrap:wrap;max-height:100px;overflow-y:auto;"></div>
                        <div style="display:flex;gap:8px;">
                            <button class="wm-action-btn" onclick="previewGif()" style="flex:1;">üëÅÔ∏è È†êË¶Ω</button>
                            <button class="wm-action-btn add" onclick="createGif()" style="flex:1;">üé¨ Áî¢Áîü GIF</button>
                        </div>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">üí° ÈÅ∏Êìá 2 Âºµ‰ª•‰∏äÂúñÁâáÔºåË®≠ÂÆöÈñìÈöîÊôÇÈñìÂæåÁî¢Áîü</small>
                </div>
                
                <!-- ÊñáÂ≠óÁ∑®ËºØÈù¢Êùø -->
                <div class="text-panel" id="textPanel">
                    <div class="panel-title">‚úçÔ∏è ÊñáÂ≠óÁ∑®ËºØ</div>
                    <textarea class="text-input-area" id="textInput" placeholder="Ëº∏ÂÖ•ÊñáÂ≠ó..."></textarea>
                    <div class="text-options">
                        <div class="option-group">
                            <label>Â§ßÂ∞è</label>
                            <input type="number" id="fontSize" value="24" min="8" max="200">
                        </div>
                        <div class="option-group">
                            <label>ÊñáÂ≠óËâ≤</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="textColor" value="#ffffff">
                                <button class="eyedropper-btn" id="textEyedropper" onclick="startEyedropper('text')" title="Âê∏ÂèñÈ°èËâ≤">üíß</button>
                            </div>
                        </div>
                        <div class="option-group">
                            <label>ËÉåÊôØËâ≤</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="bgColor" value="#000000">
                                <button class="eyedropper-btn" id="bgEyedropper" onclick="startEyedropper('bg')" title="Âê∏ÂèñÈ°èËâ≤">üíß</button>
                            </div>
                        </div>
                    </div>
                    <div class="text-options">
                        <button class="style-btn" id="boldBtn" onclick="toggleStyle('bold')"><b>B</b></button>
                        <button class="style-btn" id="italicBtn" onclick="toggleStyle('italic')"><i>I</i></button>
                        <button class="style-btn" id="underlineBtn" onclick="toggleStyle('underline')"><u>U</u></button>
                        <button class="style-btn" onclick="setAlign('left')">‚¨ÖÔ∏è</button>
                        <button class="style-btn" onclick="setAlign('center')">‚¨õ</button>
                        <button class="style-btn" onclick="setAlign('right')">‚û°Ô∏è</button>
                    </div>
                    <div class="wm-position" style="margin-top:10px;">
                        <label>ÂàùÂßã‰ΩçÁΩÆÔºö</label>
                        <div class="position-grid">
                            <button class="pos-btn" onclick="setQuickTextPosition('top-left', this)">‚Üñ</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('top-center', this)">‚Üë</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('top-right', this)">‚Üó</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('middle-left', this)">‚Üê</button>
                            <button class="pos-btn active" onclick="setQuickTextPosition('center', this)">‚¨§</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('middle-right', this)">‚Üí</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('bottom-left', this)">‚Üô</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('bottom-center', this)">‚Üì</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('bottom-right', this)">‚Üò</button>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="addQuickText()">üéØ ÊãñÊõ≥ÊîæÁΩÆÊñáÂ≠ó</button>
                        <button class="action-btn" onclick="applyText()">üì¶ Â°´ÂÖ•ÈÅ∏ÂèñÂçÄ</button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:5px;">üí° ‰πùÂÆÆÊ†ºË®≠ÂÆöÂàùÂßã‰ΩçÁΩÆÔºåÊîæÁΩÆÂæåÂèØÊãñÊõ≥ÂæÆË™ø</small>
                </div>
                
                <!-- ‰∏ãËºâÈù¢Êùø -->
                <div class="download-panel" id="downloadPanel">
                    <div class="panel-title">üíæ ‰∏ãËºâËàáÂàÜ‰∫´</div>
                    <div class="download-buttons">
                        <button class="download-btn png" onclick="downloadPNG()">
                            <span class="icon">üñºÔ∏è</span>
                            <span>‰∏ãËºâ PNG</span>
                        </button>
                        <button class="download-btn pdf" onclick="downloadPDF()" id="downloadPdfBtn">
                            <span class="icon">üìÑ</span>
                            <span>‰∏ãËºâ PDF</span>
                        </button>
                        <button class="download-btn line" onclick="sendToLine()">
                            <span class="icon">üí¨</span>
                            <span>LINE ÂàÜ‰∫´</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ë®≠ÂÆöÈ†Å -->
        <div class="page" id="page-settings">
            <div class="editor-area">
                <div class="settings-section">
                    <div class="settings-title">ü§ñ AI Ëß£ÊûêË®≠ÂÆö</div>
                    <div class="setting-item">
                        <label>üíé Gemini API Key</label>
                        <div style="display:flex;gap:5px;">
                            <input type="password" id="geminiApiKey" placeholder="AIza..." style="flex:1;">
                            <button class="toggle-pwd-btn" onclick="togglePassword('geminiApiKey', this)">üëÅÔ∏è</button>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;">Âæû <a href="https://aistudio.google.com/" target="_blank" style="color:var(--secondary);">Google AI Studio</a> ÂÖçË≤ªÂèñÂæó</small>
                    </div>
                    <div class="setting-item">
                        <label>‚ö° Groq API Key</label>
                        <div style="display:flex;gap:5px;">
                            <input type="password" id="groqApiKey" placeholder="gsk_..." style="flex:1;">
                            <button class="toggle-pwd-btn" onclick="togglePassword('groqApiKey', this)">üëÅÔ∏è</button>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;">Âæû <a href="https://console.groq.com/" target="_blank" style="color:var(--secondary);">Groq Console</a> ÂÖçË≤ªÂèñÂæó</small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">üí¨ LINE Êé®Êí≠Ë®≠ÂÆöÔºàMessaging APIÔºâ</div>
                    <div class="setting-item">
                        <label>GAS ÈÉ®ÁΩ≤ URL</label>
                        <div style="display:flex;gap:5px;">
                            <input type="password" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec" style="flex:1;">
                            <button class="toggle-pwd-btn" onclick="togglePassword('gasUrl', this)">üëÅÔ∏è</button>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;">ÈÉ®ÁΩ≤ Google Apps Script ÂæåÂèñÂæóÁöÑÁ∂≤ÂùÄ</small>
                    </div>
                    <div class="setting-item">
                        <label>LINE User ID</label>
                        <div style="display:flex;gap:5px;">
                            <input type="password" id="lineUserId" placeholder="Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" style="flex:1;">
                            <button class="toggle-pwd-btn" onclick="togglePassword('lineUserId', this)">üëÅÔ∏è</button>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;">33 Â≠óÂÖÉÔºå‰ª• U ÈñãÈ†≠„ÄÇÂä†ÂÖ• Bot ÂæåËº∏ÂÖ•„ÄåID„ÄçÂèØÂèñÂæó</small>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:10px;">
                        <button class="test-line-btn" onclick="testLineNotify()">üß™ Ê∏¨Ë©¶ LINE ÈÄöÁü•</button>
                    </div>
                </div>
                
                <div style="display:flex;gap:10px;margin-top:15px;">
                    <button class="save-btn" onclick="saveSettings()" style="flex:1;">üíæ ÂÑ≤Â≠òË®≠ÂÆö</button>
                    <button class="clear-btn" onclick="clearSettings()">üóëÔ∏è Ê∏ÖÈô§</button>
                </div>
                
                <div class="settings-section" style="margin-top:15px;">
                    <div class="settings-title">üìñ LINE Messaging API Ë®≠ÂÆöÊïôÂ≠∏</div>
                    <div style="font-size:11px;color:var(--text-secondary);line-height:1.8;">
                        <p style="color:#f59e0b;margin-bottom:8px;">‚ö†Ô∏è LINE Notify Â∑≤Êñº 2025/3/31 ÂÅúÊ≠¢ÊúçÂãôÔºåË´ãÊîπÁî® Messaging API</p>
                        <p><b>Step 1Ôºö</b>ÂâçÂæÄ <a href="https://developers.line.biz/console/" target="_blank" style="color:var(--secondary);">LINE Developers Console</a></p>
                        <p><b>Step 2Ôºö</b>Âª∫Á´ã Provider ‚Üí Âª∫Á´ã Messaging API Channel</p>
                        <p><b>Step 3Ôºö</b>Âú® Channel Ë®≠ÂÆöÈ†ÅÈù¢ÂèñÂæó <b>Channel Access Token</b></p>
                        <p><b>Step 4Ôºö</b>ÂâçÂæÄ <a href="https://script.google.com/" target="_blank" style="color:var(--secondary);">Google Apps Script</a> Êñ∞Âª∫Â∞àÊ°à</p>
                        <p><b>Step 5Ôºö</b>Ë≤º‰∏ä gas-line-messaging.js Á®ãÂºèÁ¢ºÔºåÂ°´ÂÖ• Token</p>
                        <p><b>Step 6Ôºö</b>ÈÉ®ÁΩ≤ ‚Üí Êñ∞Â¢ûÈÉ®ÁΩ≤ ‚Üí Á∂≤È†ÅÊáâÁî®Á®ãÂºè</p>
                        <p><b>Step 7Ôºö</b>Âü∑Ë°åË∫´ÂàÜÈÅ∏„ÄåÊàë„ÄçÔºåÂ≠òÂèñÊ¨äÈÅ∏„ÄåÊâÄÊúâ‰∫∫„Äç</p>
                        <p><b>Step 8Ôºö</b>ÊääÈÉ®ÁΩ≤Á∂≤ÂùÄË≤ºÂà∞‰∏äÈù¢ÁöÑÊ¨Ñ‰Ωç</p>
                        <p><b>Step 9Ôºö</b>Áî® LINE Âä†ÂÖ•‰Ω†ÁöÑ BotÔºåËº∏ÂÖ•„ÄåID„ÄçÂèñÂæó User ID</p>
                        <p style="color:var(--accent);margin-top:8px;">‚úÖ ÂÆåÊàêÔºÅÁèæÂú®ÂèØ‰ª•Êé®ÈÄÅÂúñÁâáÂà∞ LINE ‰∫Ü</p>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">‚ÑπÔ∏è ÈóúÊñºÊú¨Â∑•ÂÖ∑</div>
                    <div style="font-size:12px;color:var(--text-secondary);line-height:1.8;">
                        <p>üé© <b>ÂúñÊñáÈ≠îË°ìÂ∏´ V2.0 ÁµÇÊ•µÁâà</b></p>
                        <p>üìù Âè≤‰∏äÊúÄÂº∑ÁÄèË¶ΩÂô®ÂúñÁâáÁ∑®ËºØÂô®</p>
                        <p>üîß 133 ÂÄãÂ∑•ÂÖ∑ÊåâÈàï | 13000+ Ë°å‰ª£Á¢º</p>
                        <p>üìÑ ÊîØÊè¥ PNG / JPG / WebP / PDF</p>
                        <p>ü§ñ Êï¥Âêà Gemini + Groq Èõô AI ÂºïÊìé</p>
                        <p>üí¨ ÂèØÊé®ÈÄÅÂà∞ LINE Âç≥ÊôÇÂàÜ‰∫´</p>
                        <p style="margin-top:10px;">Made with üíú by Sone Wang</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Â∫ïÈÉ®Â∞éËà™ -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showPage('home')">
            <span class="icon">üè†</span>
            <span>È¶ñÈ†Å</span>
        </div>
        <div class="nav-item" onclick="showPage('settings')">
            <span class="icon">‚öôÔ∏è</span>
            <span>Ë®≠ÂÆö</span>
        </div>
    </nav>
    
    <!-- Toast -->
    <div id="toast"></div>
    
    <!-- Èö±ËóèÁöÑ input -->
    <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
    <input type="file" id="pdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(event)">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleImageUpload(event)">
    
    <script>
        // ===== ÂÖ®ÂüüËÆäÊï∏ =====
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let currentImage = null;
        let originalImageData = null;
        let pdfDoc = null;
        let pdfPages = [];
        let currentPageNum = 1;
        let totalPagesNum = 1;
        let isSelecting = false;
        let selectionStart = { x: 0, y: 0 };
        let selectionEnd = { x: 0, y: 0 };
        let currentSelection = null;
        let currentTool = null;
        let eyedropperTarget = null;
        let textStyle = { bold: false, italic: false, underline: false, align: 'left' };
        let quickTextPosition = 'center';
        let settings = { gasUrl: '', lineUserId: '', geminiApiKey: '', groqApiKey: '' };
        let aiResultText = '';
        
        // ÊãñÊõ≥Á≥ªÁµ±ËÆäÊï∏ÔºàÊèêÂâçÂÆöÁæ©Ôºâ
        let currentDragObject = null;
        let dragOffsetX = 0, dragOffsetY = 0;
        let isDraggingObject = false;
        
        // ===== ÁØÄÊÖ∂Ë®≠ÂÆö =====
        const festivals = {
            1: { emoji: 'üéä', items: ['üéâ', 'üéä', 'üßß', 'üí∞', 'üéÜ'], name: 'Êñ∞Âπ¥' },
            2: { emoji: 'üíï', items: ['üíï', '‚ù§Ô∏è', 'üíñ', 'üíù', 'üåπ'], name: 'ÊÉÖ‰∫∫ÁØÄ' },
            3: { emoji: 'üå∏', items: ['üå∏', 'üå∑', 'üå∫', 'üíÆ', 'üåº'], name: 'Êò•Â§©' },
            4: { emoji: 'üê£', items: ['üê£', 'ü•ö', 'üê∞', 'üå∑', 'ü¶ã'], name: 'Âæ©Ê¥ªÁØÄ' },
            5: { emoji: 'üåπ', items: ['üåπ', 'üíê', 'üå∑', 'üå∏', 'üíï'], name: 'ÊØçË¶™ÁØÄ' },
            6: { emoji: 'üê≤', items: ['üê≤', 'üéè', 'üèÆ', 'üåä', '‚õµ'], name: 'Á´ØÂçàÁØÄ' },
            7: { emoji: 'üåä', items: ['üåä', '‚òÄÔ∏è', 'üèñÔ∏è', 'üçâ', 'üå¥'], name: 'Â§èÊó•' },
            8: { emoji: 'üëî', items: ['üëî', 'üèÜ', '‚≠ê', 'üéñÔ∏è', 'üí™'], name: 'Áà∂Ë¶™ÁØÄ' },
            9: { emoji: 'ü•Æ', items: ['ü•Æ', 'üåï', 'üèÆ', 'üê∞', '‚ú®'], name: '‰∏≠ÁßãÁØÄ' },
            10: { emoji: 'üéÉ', items: ['üéÉ', 'üëª', 'ü¶á', 'üï∑Ô∏è', 'üíÄ'], name: 'Ëê¨ËÅñÁØÄ' },
            11: { emoji: 'üçÇ', items: ['üçÇ', 'üçÅ', 'ü¶É', 'üåΩ', 'ü•ß'], name: 'ÊÑüÊÅ©ÁØÄ' },
            12: { emoji: 'üéÑ', items: ['‚ùÑÔ∏è', 'üéÑ', 'üéÖ', '‚≠ê', 'üéÅ'], name: 'ËÅñË™ïÁØÄ' }
        };
        
        // ===== ÂàùÂßãÂåñ =====
        window.onload = function() {
            loadSettings();
            updateTime();
            setInterval(updateTime, 1000);
            initFestival();
            initCanvasEvents();
            initKeyboardEvents();
            initPasteEvent();
            initWatermarkEvents();
            
            // ÈñãÊ©üÂãïÁï´
            setTimeout(() => {
                document.getElementById('splashScreen').classList.add('fade-out');
            }, 2000);
        };
        
        // ===== ÊôÇÈñìÊõ¥Êñ∞ =====
        function updateTime() {
            const now = new Date();
            document.getElementById('headerTime').textContent = 
                now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        }
        
        // ===== ÁØÄÊÖ∂ÊïàÊûú =====
        function initFestival() {
            const month = new Date().getMonth() + 1;
            const festival = festivals[month];
            document.getElementById('headerFestival').textContent = festival.emoji;
            
            const container = document.getElementById('festivalEffect');
            for (let i = 0; i < 15; i++) {
                setTimeout(() => createFestivalItem(container, festival.items), i * 500);
            }
            setInterval(() => createFestivalItem(container, festival.items), 2000);
        }
        
        function createFestivalItem(container, items) {
            const item = document.createElement('div');
            item.className = 'festival-item';
            item.textContent = items[Math.floor(Math.random() * items.length)];
            item.style.left = Math.random() * 100 + '%';
            item.style.animationDuration = (5 + Math.random() * 5) + 's';
            item.style.fontSize = (16 + Math.random() * 16) + 'px';
            container.appendChild(item);
            setTimeout(() => item.remove(), 10000);
        }
        
        // ===== È†ÅÈù¢ÂàáÊèõ =====
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        // Âø´ÈÄüË∑≥Âà∞Â∑•ÂÖ∑ÊåâÈàï
        function scrollToTool(btnId) {
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                // ÈñÉÁàçÊèêÁ§∫
                btn.style.animation = 'none';
                btn.offsetHeight; // Ëß∏ÁôºÈáçÁπ™
                btn.style.animation = 'highlight 1s ease';
                setTimeout(() => { btn.style.animation = ''; }, 1000);
                
                if (btn.disabled) {
                    showToast('Ë´ãÂÖà‰∏äÂÇ≥ÂúñÁâáÂÜç‰ΩøÁî®Ê≠§ÂäüËÉΩ üì§');
                }
            }
        }
        
        // ===== ‰∏äÂÇ≥ÂäüËÉΩ =====
        function triggerUpload(type) {
            if (type === 'image') {
                document.getElementById('imageInput').click();
            } else if (type === 'pdf') {
                document.getElementById('pdfInput').click();
            }
        }
        
        function takePhoto() {
            document.getElementById('cameraInput').click();
        }
        
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                loadImage(event.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        function loadImage(src) {
            const img = new Image();
            img.onload = function() {
                currentImage = img;
                pdfDoc = null;
                pdfPages = [];
                
                // Èö±Ëóè PDF Áõ∏Èóú UI
                document.getElementById('pdfControls').classList.remove('show');
                document.getElementById('pdfToolBtn').style.display = 'none';
                document.getElementById('pdfToolPanel').classList.remove('show');
                
                // ‰øùÊåÅÂéüÂßãÂ∞∫ÂØ∏ÔºàÁ¢∫‰øùËº∏Âá∫ÂìÅË≥™Ôºâ
                // ‰ΩÜÂ¶ÇÊûúÂúñÁâáÂ§™Â§ßÔºàË∂ÖÈÅé 4000pxÔºâÔºåÂâáÁ∏ÆÂ∞è‰ª•ÈÅøÂÖçÊïàËÉΩÂïèÈ°å
                const maxDimension = 4000;
                let width = img.width;
                let height = img.height;
                
                if (width > maxDimension || height > maxDimension) {
                    if (width > height) {
                        height = (maxDimension / width) * height;
                        width = maxDimension;
                    } else {
                        width = (maxDimension / height) * width;
                        height = maxDimension;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                originalImageData = ctx.getImageData(0, 0, width, height);
                
                // ÈáçÁΩÆÁ∏ÆÊîæ‰∏¶ÈÅ©ÊáâËû¢Âπï
                currentZoom = 1;
                
                // Êõ¥Êñ∞Áï´Â∏ÉÈ°ØÁ§∫Ë≥áË®ä
                updateCanvasInfo();
                
                showEditor();
                
                // Âª∂ÈÅ≤Âü∑Ë°åÈÅ©ÊáâËû¢ÂπïÔºåÁ¢∫‰øù DOM Â∑≤Êõ¥Êñ∞
                setTimeout(() => {
                    fitToScreen();
                }, 100);
                
                showToast(`‚ú® ÂúñÁâáËºâÂÖ•ÊàêÂäüÔºÅ(${Math.round(width)} x ${Math.round(height)})`);
            };
            img.src = src;
        }
        
        function updateCanvasInfo() {
            const info = document.getElementById('canvasInfo');
            if (info) {
                info.textContent = `${canvas.width} x ${canvas.height}`;
            }
        }
        
        // ===== Áï´Â∏ÉÁ∏ÆÊîæÂäüËÉΩ =====
        let currentZoom = 1;
        const minZoom = 0.1;
        const maxZoom = 5;
        
        function updateZoomInfo() {
            const zoomInfo = document.getElementById('zoomInfo');
            if (zoomInfo) {
                zoomInfo.textContent = `${Math.round(currentZoom * 100)}%`;
            }
            applyZoom();
        }
        
        function applyZoom() {
            canvas.style.transform = `scale(${currentZoom})`;
            canvas.style.transformOrigin = 'center top';
            
            // Ë™øÊï¥ÂÆπÂô®È´òÂ∫¶‰ª•ÈÅ©ÊáâÁ∏ÆÊîæÂæåÁöÑÁï´Â∏É
            const container = document.getElementById('canvasContainer');
            if (container && canvas.height > 0) {
                const scaledHeight = canvas.height * currentZoom;
                container.style.minHeight = `${Math.min(scaledHeight + 20, window.innerHeight * 0.8)}px`;
            }
        }
        
        function zoomCanvas(delta) {
            const newZoom = Math.max(minZoom, Math.min(maxZoom, currentZoom + delta));
            if (newZoom !== currentZoom) {
                currentZoom = newZoom;
                updateZoomInfo();
            }
        }
        
        function setZoom(zoom) {
            currentZoom = Math.max(minZoom, Math.min(maxZoom, zoom));
            updateZoomInfo();
        }
        
        function resetZoom() {
            currentZoom = 1;
            updateZoomInfo();
            showToast('üîç Á∏ÆÊîæÂ∑≤ÈáçÁΩÆÁÇ∫ 100%');
        }
        
        function fitToScreen() {
            const container = document.getElementById('canvasContainer');
            if (!container || canvas.width === 0) return;
            
            const containerWidth = container.clientWidth - 40;
            const containerHeight = window.innerHeight * 0.65;
            
            const scaleX = containerWidth / canvas.width;
            const scaleY = containerHeight / canvas.height;
            
            currentZoom = Math.min(scaleX, scaleY, 1);
            updateZoomInfo();
            showToast('üî≤ Â∑≤ÈÅ©ÊáâËû¢ÂπïÂ§ßÂ∞è');
        }
        
        // ÊªæËº™Á∏ÆÊîæ
        function initZoomEvents() {
            const container = document.getElementById('canvasContainer');
            if (!container) return;
            
            // ÊªæËº™Á∏ÆÊîæÔºàCtrl + ÊªæËº™Ôºâ
            container.addEventListener('wheel', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    zoomCanvas(delta);
                }
            }, { passive: false });
            
            // ÈõôÊìäÈáçÁΩÆÁ∏ÆÊîæ
            canvas.addEventListener('dblclick', (e) => {
                if (!currentTool && !eyedropperTarget && !stampDragMode && !stickerDragMode && !signDragMode) {
                    resetZoom();
                }
            });
            
            // Ëß∏ÊéßÁ∏ÆÊîæÔºàÈõôÊåáÔºâ
            let initialDistance = 0;
            let initialZoom = 1;
            
            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    initialDistance = getTouchDistance(e.touches);
                    initialZoom = currentZoom;
                }
            }, { passive: false });
            
            container.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = getTouchDistance(e.touches);
                    const scale = currentDistance / initialDistance;
                    setZoom(initialZoom * scale);
                }
            }, { passive: false });
        }
        
        function getTouchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñÁ∏ÆÊîæ‰∫ã‰ª∂
        document.addEventListener('DOMContentLoaded', initZoomEvents);
        
        // Áõ£ËÅΩË¶ñÁ™óÂ§ßÂ∞èËÆäÂåñ
        window.addEventListener('resize', () => {
            if (document.getElementById('canvasWrapper').classList.contains('show')) {
                updateZoomInfo();
            }
        });
        
        // Áõ£ËÅΩ ESC ÈçµÂèñÊ∂àÊâÄÊúâÂ∑•ÂÖ∑ÂíåÊîæÁΩÆÊ®°Âºè
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                let cancelled = false;
                
                // ÂèñÊ∂àÊãñÊõ≥Áâ©‰ª∂
                if (currentDragObject) {
                    removeDragObject();
                    cancelled = true;
                }
                
                // ÂèñÊ∂àÁï∂ÂâçÂ∑•ÂÖ∑
                if (currentTool) {
                    currentTool = null;
                    document.getElementById('selectBtn')?.classList.remove('active');
                    document.getElementById('selectBtn2')?.classList.remove('active');
                    document.getElementById('mosaicBtn')?.classList.remove('active');
                    document.getElementById('arrowBtn')?.classList.remove('active');
                    document.getElementById('brushBtn')?.classList.remove('active');
                    document.getElementById('shapeBtn')?.classList.remove('active');
                    cancelled = true;
                }
                
                if (cancelled) {
                    canvas.style.cursor = 'default';
                    showToast('üîì Â∑≤ÂèñÊ∂à');
                }
            }
        });
        
        // ===== PDF ËôïÁêÜ =====
        async function handlePdfUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            showToast('üìÑ ËºâÂÖ• PDF ‰∏≠...');
            
            const arrayBuffer = await file.arrayBuffer();
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            try {
                pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                totalPagesNum = pdfDoc.numPages;
                pdfPages = new Array(totalPagesNum).fill(null);
                
                document.getElementById('totalPages').textContent = totalPagesNum;
                document.getElementById('pdfControls').classList.add('show');
                
                await renderPdfPage(1);
                showToast(`‚ú® PDF ËºâÂÖ•ÊàêÂäüÔºÅÂÖ± ${totalPagesNum} È†Å`);
            } catch (err) {
                showToast('‚ùå PDF ËºâÂÖ•Â§±Êïó');
                console.error(err);
            }
        }
        
        async function renderPdfPage(pageNum) {
            if (!pdfDoc) return;
            
            currentPageNum = pageNum;
            document.getElementById('currentPage').textContent = pageNum;
            document.getElementById('prevPage').disabled = pageNum <= 1;
            document.getElementById('nextPage').disabled = pageNum >= totalPagesNum;
            
            // È°ØÁ§∫ PDF ÊãÜÂàÜÊåâÈàï
            document.getElementById('pdfToolBtn').style.display = 'flex';
            
            // Â¶ÇÊûúÊúâÊö´Â≠òÂ∞±Áî®Êö´Â≠ò
            if (pdfPages[pageNum - 1]) {
                canvas.width = pdfPages[pageNum - 1].width;
                canvas.height = pdfPages[pageNum - 1].height;
                ctx.putImageData(pdfPages[pageNum - 1], 0, 0);
                originalImageData = pdfPages[pageNum - 1];
                showEditor();
                return;
            }
            
            const page = await pdfDoc.getPage(pageNum);
            // ‰ΩøÁî®ËºÉÈ´òÁöÑ scale ‰ª•‰øùÊåÅÂìÅË≥™ÔºåCSS ÊúÉËá™ÂãïÁ∏ÆÊîæÈ°ØÁ§∫
            let viewport = page.getViewport({ scale: 1 });
            // ÊúÄÂ§ßÂ∞∫ÂØ∏ÈôêÂà∂ÁÇ∫ 3000px
            const maxDimension = 3000;
            let scale = 2; // È†êË®≠ 2x ÂìÅË≥™
            
            if (viewport.width * scale > maxDimension || viewport.height * scale > maxDimension) {
                scale = Math.min(maxDimension / viewport.width, maxDimension / viewport.height);
            }
            
            viewport = page.getViewport({ scale });
            
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({
                canvasContext: ctx,
                viewport: viewport
            }).promise;
            
            originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            pdfPages[pageNum - 1] = originalImageData;
            showEditor();
        }
        
        function changePage(delta) {
            // ÂÑ≤Â≠òÁï∂ÂâçÈ†ÅÈù¢
            pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            const newPage = currentPageNum + delta;
            if (newPage >= 1 && newPage <= totalPagesNum) {
                renderPdfPage(newPage);
            }
        }
        
        // ===== Ââ™Ë≤ºÁ∞øË≤º‰∏ä =====
        function initPasteEvent() {
            document.addEventListener('paste', async (e) => {
                const items = e.clipboardData?.items;
                if (!items) return;
                
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (e) => loadImage(e.target.result);
                        reader.readAsDataURL(blob);
                        showToast('üìã Â∑≤Ë≤º‰∏äÂúñÁâáÔºÅ');
                        break;
                    }
                }
            });
        }
        
        async function pasteFromClipboard() {
            try {
                const clipboardItems = await navigator.clipboard.read();
                for (const item of clipboardItems) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            const blob = await item.getType(type);
                            const reader = new FileReader();
                            reader.onload = (e) => loadImage(e.target.result);
                            reader.readAsDataURL(blob);
                            showToast('üìã Â∑≤Ë≤º‰∏äÂúñÁâáÔºÅ');
                            return;
                        }
                    }
                }
                showToast('‚ö†Ô∏è Ââ™Ë≤ºÁ∞øÊ≤íÊúâÂúñÁâá');
            } catch (err) {
                showToast('‚ö†Ô∏è Ë´ãÂÖÅË®±Â≠òÂèñÂâ™Ë≤ºÁ∞ø');
            }
        }
        
        // ===== È°ØÁ§∫Á∑®ËºØÂô® =====
        function showEditor() {
            document.getElementById('uploadZone').classList.add('hidden');
            document.getElementById('canvasWrapper').classList.add('show');
            document.getElementById('textPanel').classList.add('show');
            document.getElementById('downloadPanel').classList.add('show');
            
            // Êõ¥Êñ∞Áï´Â∏ÉË≥áË®ä
            updateCanvasInfo();
            
            // Áõ£ËÅΩË¶ñÁ™óÂ§ßÂ∞èËÆäÂåñÔºåÊõ¥Êñ∞Á∏ÆÊîæÊØî‰æã
            setTimeout(updateZoomInfo, 100);
            
            // ÂïüÁî®ÊâÄÊúâÂ∑•ÂÖ∑ÊåâÈàï
            const buttons = [
                'selectBtn', 'clearBtn', 'aiBtn', 'watermarkBtn', 'mosaicBtn',
                'stampBtn', 'signBtn', 'filterBtn', 'adjustBtn', 'frameBtn',
                'stickerBtn', 'arrowBtn', 'rotateBtn', 'flipHBtn', 'flipVBtn',
                'cropBtn', 'mergeBtn', 'qrBtn', 'compressBtn', 'undoBtn', 'resetBtn',
                'brushBtn', 'shapeBtn', 'textFxBtn', 'templateBtn', 'collageBtn',
                'beautyBtn', 'removeBgBtn', 'batchBtn', 'effectBtn', 'overlayBtn',
                'annotateBtn', 'measureBtn', 'gridBtn', 'historyBtn', 'infoBtn',
                'colorReplaceBtn', 'compareBtn', 'idPhotoBtn', 'screenshotBtn',
                'pixelArtBtn', 'asciiBtn', 'cartoonBtn', 'sketchBtn', 'oilPaintBtn',
                'glitchBtn', 'duotoneBtn', 'gradientBtn', 'vignetteBtn', 'noiseBtn',
                'blurBgBtn', 'textureBtn', 'lightLeakBtn', 'bokehBtn', 'tiltShiftBtn',
                'mirrorBtn', 'kaleidoBtn', 'splitBtn', 'socialBtn', 'exportBtn',
                'layerBtn', 'cloneBtn', 'healBtn', 'liquifyBtn', 'hdrBtn',
                'curveBtn', 'levelBtn', 'histogramBtn', 'colorBalanceBtn',
                'selectiveColorBtn', 'photoFilterBtn', 'lensBlurBtn', 'motionBlurBtn',
                'zoomBlurBtn', 'perspectiveBtn', 'distortBtn', 'warpBtn', 'memeBtn',
                'posterBtn', 'cardBtn', 'bannerBtn', 'avatarBtn', 'logoBtn', 'gifBtn',
                'colorPaletteBtn', 'eyeDropperAdvBtn', 'rulerBtn', 'guideBtn', 'alignBtn',
                'magicWandBtn', 'lassoBtn', 'penToolBtn', 'pathBtn', 'channelBtn',
                'autoEnhanceBtn', 'autoColorBtn', 'autoContrastBtn', 'autoLevelBtn',
                'redEyeBtn', 'blemishBtn', 'whiteTeethBtn', 'slimFaceBtn', 'bigEyeBtn',
                'makeupBtn', 'faceSwapBtn', 'bgBlurPortraitBtn', 'skeletonBtn',
                'outlineBtn', 'dotArtBtn', 'lowPolyBtn', 'mosaic2Btn', 'colorSplashBtn',
                'miniatureBtn', 'infraredBtn', 'crossProcessBtn', 'bleachBypassBtn',
                'splitToneBtn', 'colorGradeBtn', 'lutBtn', 'vintageBtn', 'filmBtn',
                'cinemaBtn', 'printBtn', 'shareBtn', 'cloudBtn', 'shortcutBtn',
                'themeBtn', 'selectBtn2'
            ];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = false;
            });
            
            // ÂÑ≤Â≠òÂàùÂßãÁãÄÊÖã‰æõÂæ©Âéü‰ΩøÁî®
            saveHistory();
            updateCompressInfo();
            updateImageInfo();
            initLayers();
        }
        
        // ÂàùÂßãÂåñÔºöËÆì‰∏Ä‰∫õÂü∫Êú¨ÂäüËÉΩÂßãÁµÇÂèØÁî®Ôºà‰∏çÈúÄË¶ÅËºâÂÖ•ÂúñÁâáÔºâ
        function enableBasicButtons() {
            const alwaysEnabled = [
                'helpBtn', 'shortcutBtn', 'themeBtn', 'templateBtn', 'settingsNavBtn'
            ];
            alwaysEnabled.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = false;
            });
        }
        
        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂïüÁî®Âü∫Êú¨ÊåâÈàï
        document.addEventListener('DOMContentLoaded', enableBasicButtons);
        
        // ===== AI ÂàÜÊûêÂäüËÉΩ =====
        function showAIPanel() {
            const panel = document.getElementById('aiPanel');
            panel.classList.toggle('show');
            document.getElementById('aiBtn').classList.toggle('active', panel.classList.contains('show'));
        }
        
        function getSelectedMode() {
            return document.querySelector('input[name="aiMode"]:checked').value;
        }
        
        function getPromptByMode(mode) {
            switch(mode) {
                case 'ocr':
                    return 'Ë´ãËæ®Ë≠òÈÄôÂºµÂúñÁâá‰∏≠ÁöÑÊâÄÊúâÊñáÂ≠óÔºå‰øùÊåÅÂéüÂßãÊéíÁâàÊ†ºÂºèÔºåÂè™Ëº∏Âá∫Ëæ®Ë≠òÂà∞ÁöÑÊñáÂ≠óÂÖßÂÆπÔºå‰∏çË¶ÅÂä†‰ªª‰ΩïË™™Êòé„ÄÇ';
                case 'describe':
                    return 'Ë´ãË©≥Á¥∞ÊèèËø∞ÈÄôÂºµÂúñÁâáÁöÑÂÖßÂÆπÔºåÂåÖÊã¨Â†¥ÊôØ„ÄÅÁâ©‰ª∂„ÄÅ‰∫∫Áâ©„ÄÅÈ°èËâ≤„ÄÅÊßãÂúñÁ≠âÁ¥∞ÁØÄ„ÄÇ‰ΩøÁî®ÁπÅÈ´î‰∏≠ÊñáÂõûÁ≠î„ÄÇ';
                case 'translate':
                    return 'Ë´ãËæ®Ë≠òÂúñÁâá‰∏≠ÁöÑÊñáÂ≠ó‰∏¶ÁøªË≠ØÊàêÁπÅÈ´î‰∏≠Êñá„ÄÇÂÖàÂàóÂá∫ÂéüÊñáÔºåÂÜçÂàóÂá∫ÁøªË≠Ø„ÄÇ';
                default:
                    return 'Ë´ãÂàÜÊûêÈÄôÂºµÂúñÁâá„ÄÇ';
            }
        }
        
        async function analyzeImage() {
            const model = document.getElementById('aiModel').value;
            const isGemini = model.startsWith('gemini');
            const isGroq = model.startsWith('llama');
            
            if (isGemini && !settings.geminiApiKey) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàË®≠ÂÆö Gemini API Key');
                showPage('settings');
                return;
            }
            if (isGroq && !settings.groqApiKey) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàË®≠ÂÆö Groq API Key');
                showPage('settings');
                return;
            }
            
            // ‰ªòË≤ªÊ®°ÂûãÊèêÈÜí
            if (model === 'gemini-2.5-pro' || model === 'gemini-3.0-pro') {
                if (!confirm(`‚ö†Ô∏è ${model} ÊòØ‰ªòË≤ªÊ®°ÂûãÔºåÊúÉÁî¢ÁîüË≤ªÁî®„ÄÇ\nÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü`)) {
                    return;
                }
            }
            
            const resultDiv = document.getElementById('aiResult');
            resultDiv.innerHTML = '';
            resultDiv.classList.add('loading');
            showToast('ü§ñ AI ÂàÜÊûê‰∏≠...');
            
            try {
                const imageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                const mode = getSelectedMode();
                const prompt = getPromptByMode(mode);
                
                let text = '';
                
                if (isGemini) {
                    text = await callGeminiVision(model, imageData, prompt);
                } else if (isGroq) {
                    text = await callGroqVision(model, imageData, prompt);
                }
                
                aiResultText = text;
                resultDiv.classList.remove('loading');
                resultDiv.textContent = text;
                showToast('‚úÖ ÂàÜÊûêÂÆåÊàêÔºÅ');
            } catch (e) {
                resultDiv.classList.remove('loading');
                resultDiv.innerHTML = '<span style="color:var(--danger);">‚ùå ' + e.message + '</span>';
                showToast('‚ùå ÂàÜÊûêÂ§±Êïó');
            }
        }
        
        async function callGeminiVision(model, imageData, prompt) {
            // Ê®°ÂûãÂêçÁ®±Â∞çÊáâ
            const modelMap = {
                'gemini-2.0-flash': 'gemini-2.0-flash',
                'gemini-2.5-flash': 'gemini-2.5-flash-preview-05-20',
                'gemini-2.5-pro': 'gemini-2.5-pro-preview-05-06',
                'gemini-3.0-pro': 'gemini-2.5-pro-exp-03-25'
            };
            const apiModel = modelMap[model] || 'gemini-2.0-flash';
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${apiModel}:generateContent?key=${settings.geminiApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: 'image/jpeg', data: imageData } }
                        ]
                    }]
                })
            });
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || 'Gemini API ÈåØË™§');
            }
            
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || 'ÁÑ°Ê≥ïËß£Êûê';
        }
        
        async function callGroqVision(model, imageData, prompt) {
            // Ê®°ÂûãÂêçÁ®±Â∞çÊáâ
            const modelMap = {
                'llama-4-scout': 'meta-llama/llama-4-scout-17b-16e-instruct',
                'llama-4-maverick': 'meta-llama/llama-4-maverick-17b-128e-instruct'
            };
            const apiModel = modelMap[model] || 'meta-llama/llama-4-scout-17b-16e-instruct';
            
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${settings.groqApiKey}`
                },
                body: JSON.stringify({
                    model: apiModel,
                    messages: [{
                        role: 'user',
                        content: [
                            { type: 'text', text: prompt },
                            { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${imageData}` } }
                        ]
                    }],
                    max_tokens: 2000
                })
            });
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || 'Groq API ÈåØË™§');
            }
            
            const data = await response.json();
            return data.choices?.[0]?.message?.content || 'ÁÑ°Ê≥ïËß£Êûê';
        }
        
        function copyAIResult() {
            if (!aiResultText) {
                showToast('‚ö†Ô∏è Ê≤íÊúâÂèØË§áË£ΩÁöÑÂÖßÂÆπ');
                return;
            }
            navigator.clipboard.writeText(aiResultText).then(() => {
                showToast('üìã Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ');
            }).catch(() => {
                showToast('‚ùå Ë§áË£ΩÂ§±Êïó');
            });
        }
        
        function applyAIText() {
            if (!aiResultText) {
                showToast('‚ö†Ô∏è Ê≤íÊúâÂèØÊáâÁî®ÁöÑÂÖßÂÆπ');
                return;
            }
            document.getElementById('textInput').value = aiResultText;
            showToast('‚úÖ Â∑≤ÊáâÁî®Âà∞ÊñáÂ≠óÊ°ÜÔºÅ');
        }
        
        // ===== PDF ÊãÜÂàÜÁµÑÂêàÂäüËÉΩ =====
        let selectedPdfPages = new Set();
        let pdfThumbnails = [];
        
        function showPdfToolPanel() {
            const panel = document.getElementById('pdfToolPanel');
            panel.classList.toggle('show');
            document.getElementById('pdfToolBtn').classList.toggle('active', panel.classList.contains('show'));
            
            if (panel.classList.contains('show')) {
                renderPdfThumbnails();
            }
        }
        
        async function renderPdfThumbnails() {
            if (!pdfDoc) return;
            
            const grid = document.getElementById('pdfPagesGrid');
            grid.innerHTML = '';
            pdfThumbnails = [];
            selectedPdfPages.clear();
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            for (let i = 1; i <= totalPagesNum; i++) {
                // Â¶ÇÊûúÂ∑≤ÊúâÊö´Â≠òÁöÑÁ∑®ËºØÈ†ÅÈù¢
                if (pdfPages[i - 1]) {
                    const pageData = pdfPages[i - 1];
                    tempCanvas.width = pageData.width;
                    tempCanvas.height = pageData.height;
                    tempCtx.putImageData(pageData, 0, 0);
                } else {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 0.5 });
                    tempCanvas.width = viewport.width;
                    tempCanvas.height = viewport.height;
                    await page.render({ canvasContext: tempCtx, viewport }).promise;
                    pdfPages[i - 1] = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                }
                
                const dataUrl = tempCanvas.toDataURL('image/jpeg', 0.7);
                pdfThumbnails[i - 1] = dataUrl;
                
                const thumb = document.createElement('div');
                thumb.className = 'pdf-page-thumb';
                thumb.dataset.page = i;
                thumb.innerHTML = `
                    <img src="${dataUrl}" alt="Page ${i}">
                    <div class="page-num">${i}</div>
                    <div class="check-mark">‚úì</div>
                `;
                thumb.onclick = () => togglePageSelection(i, thumb);
                grid.appendChild(thumb);
            }
        }
        
        function togglePageSelection(pageNum, element) {
            if (selectedPdfPages.has(pageNum)) {
                selectedPdfPages.delete(pageNum);
                element.classList.remove('selected');
            } else {
                selectedPdfPages.add(pageNum);
                element.classList.add('selected');
            }
        }
        
        function toggleSelectAllPages() {
            const thumbs = document.querySelectorAll('.pdf-page-thumb');
            
            if (selectedPdfPages.size === totalPagesNum) {
                // ÂÖ®ÈÉ®ÂèñÊ∂à
                selectedPdfPages.clear();
                thumbs.forEach(t => t.classList.remove('selected'));
                showToast('‚òëÔ∏è Â∑≤ÂèñÊ∂àÂÖ®ÈÅ∏');
            } else {
                // ÂÖ®ÈÅ∏
                for (let i = 1; i <= totalPagesNum; i++) {
                    selectedPdfPages.add(i);
                }
                thumbs.forEach(t => t.classList.add('selected'));
                showToast('‚òëÔ∏è Â∑≤ÂÖ®ÈÅ∏ ' + totalPagesNum + ' È†Å');
            }
        }
        
        async function exportSelectedAsImages() {
            if (selectedPdfPages.size === 0) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÈÅ∏ÂèñÈ†ÅÈù¢');
                return;
            }
            
            showToast('üñºÔ∏è ÂåØÂá∫ÂúñÁâá‰∏≠...');
            
            const sortedPages = Array.from(selectedPdfPages).sort((a, b) => a - b);
            
            for (const pageNum of sortedPages) {
                const dataUrl = pdfThumbnails[pageNum - 1];
                
                // ÂèñÂæóÈ´òËß£ÊûêÂ∫¶ÁâàÊú¨
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const pageData = pdfPages[pageNum - 1];
                tempCanvas.width = pageData.width;
                tempCanvas.height = pageData.height;
                tempCtx.putImageData(pageData, 0, 0);
                
                const link = document.createElement('a');
                link.download = `page-${pageNum}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
                
                // Âª∂ÈÅ≤ÈÅøÂÖçÁÄèË¶ΩÂô®ÈòªÊìã
                await new Promise(r => setTimeout(r, 300));
            }
            
            showToast('‚úÖ Â∑≤ÂåØÂá∫ ' + sortedPages.length + ' ÂºµÂúñÁâáÔºÅ');
        }
        
        async function exportSelectedAsPdf() {
            if (selectedPdfPages.size === 0) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÈÅ∏ÂèñÈ†ÅÈù¢');
                return;
            }
            
            showToast('üìÑ Áî¢Áîü PDF ‰∏≠...');
            
            const { jsPDF } = window.jspdf;
            const sortedPages = Array.from(selectedPdfPages).sort((a, b) => a - b);
            
            let pdf = null;
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            for (let i = 0; i < sortedPages.length; i++) {
                const pageNum = sortedPages[i];
                const pageData = pdfPages[pageNum - 1];
                
                tempCanvas.width = pageData.width;
                tempCanvas.height = pageData.height;
                tempCtx.putImageData(pageData, 0, 0);
                
                const imgData = tempCanvas.toDataURL('image/jpeg', 0.9);
                const width = pageData.width * 0.264583;
                const height = pageData.height * 0.264583;
                
                if (i === 0) {
                    pdf = new jsPDF({
                        orientation: width > height ? 'l' : 'p',
                        unit: 'mm',
                        format: [width, height]
                    });
                } else {
                    pdf.addPage([width, height], width > height ? 'l' : 'p');
                }
                
                pdf.addImage(imgData, 'JPEG', 0, 0, width, height);
            }
            
            pdf.save(`merged-${sortedPages.length}pages.pdf`);
            showToast('‚úÖ PDF Â∑≤‰∏ãËºâÔºÅÂÖ± ' + sortedPages.length + ' È†Å');
        }
        
        // ===== ÊµÆÊ∞¥Âç∞ÂäüËÉΩ =====
        let watermarkImage = null;
        let wmPosition = 'center';
        
        function showWatermarkPanel() {
            const panel = document.getElementById('watermarkPanel');
            panel.classList.toggle('show');
            document.getElementById('watermarkBtn').classList.toggle('active', panel.classList.contains('show'));
        }
        
        // ÂàùÂßãÂåñÊµÆÊ∞¥Âç∞ÊéßÂà∂È†Ö‰∫ã‰ª∂
        function initWatermarkEvents() {
            // ÊñáÂ≠ó/ÂúñÁâáÂàáÊèõ
            document.querySelectorAll('input[name="wmType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('wmTextOptions').style.display = this.value === 'text' ? 'block' : 'none';
                    document.getElementById('wmImageOptions').style.display = this.value === 'image' ? 'block' : 'none';
                });
            });
            
            // ËßíÂ∫¶È°ØÁ§∫
            const angleInput = document.getElementById('wmAngle');
            if (angleInput) {
                angleInput.addEventListener('input', function() {
                    document.getElementById('wmAngleValue').textContent = this.value + '¬∞';
                });
            }
            
            // ÂúñÁâáÂ§ßÂ∞èÈ°ØÁ§∫
            const sizeInput = document.getElementById('wmImageSize');
            if (sizeInput) {
                sizeInput.addEventListener('input', function() {
                    document.getElementById('wmImageSizeValue').textContent = this.value + '%';
                });
            }
            
            // ‰ΩçÁΩÆÈÅ∏Êìá
            document.querySelectorAll('.pos-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.pos-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    wmPosition = this.dataset.pos;
                });
            });
        }
        
        function loadWatermarkImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    watermarkImage = img;
                    document.getElementById('wmImagePreview').innerHTML = `<img src="${event.target.result}" alt="ÊµÆÊ∞¥Âç∞">`;
                    showToast('‚úÖ ÊµÆÊ∞¥Âç∞ÂúñÁâáÂ∑≤ËºâÂÖ•');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function addWatermark() {
            const wmType = document.querySelector('input[name="wmType"]:checked').value;
            const isTile = document.getElementById('wmTile').checked;
            
            if (wmType === 'text') {
                addTextWatermark(isTile);
            } else {
                addImageWatermark(isTile);
            }
        }
        
        function addTextWatermark(isTile) {
            const text = document.getElementById('wmText').value.trim();
            if (!text) {
                showToast('‚ö†Ô∏è Ë´ãËº∏ÂÖ•ÊµÆÊ∞¥Âç∞ÊñáÂ≠ó');
                return;
            }
            
            const fontSize = parseInt(document.getElementById('wmFontSize').value) || 48;
            const color = document.getElementById('wmColor').value;
            const opacity = parseFloat(document.getElementById('wmOpacity').value);
            const angle = parseInt(document.getElementById('wmAngle').value);
            
            if (isTile) {
                // Âπ≥Èã™Ê®°ÂºèÁõ¥Êé•Áπ™Ë£Ω
                saveHistory();
                
                ctx.save();
                ctx.globalAlpha = opacity;
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.fillStyle = color;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const textWidth = ctx.measureText(text).width;
                const gap = textWidth + 50;
                const rows = Math.ceil(canvas.height / (fontSize + 80));
                const cols = Math.ceil(canvas.width / gap) + 2;
                
                for (let r = -1; r <= rows; r++) {
                    for (let c = -1; c <= cols; c++) {
                        const x = c * gap;
                        const y = r * (fontSize + 80);
                        ctx.save();
                        ctx.translate(x, y);
                        ctx.rotate(angle * Math.PI / 180);
                        ctx.fillText(text, 0, 0);
                        ctx.restore();
                    }
                }
                ctx.restore();
                showToast('‚ú® ÊµÆÊ∞¥Âç∞Â∑≤Âä†‰∏äÔºÅ');
            } else {
                // ÂñÆ‰∏ÄÊ®°Âºè‰ΩøÁî®ÊãñÊõ≥Ôºå‰πùÂÆÆÊ†º‰ΩúÁÇ∫ÂàùÂßã‰ΩçÁΩÆ
                createDragObject('watermark', text, { 
                    fontSize, 
                    color, 
                    opacity, 
                    angle 
                }, wmPosition);
            }
        }
        
        function addImageWatermark(isTile) {
            if (!watermarkImage) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÈÅ∏ÊìáÊµÆÊ∞¥Âç∞ÂúñÁâá');
                return;
            }
            
            saveHistory(); // ÂÑ≤Â≠òÊ≠∑Âè≤‰æõÂæ©Âéü
            
            const sizePercent = parseInt(document.getElementById('wmImageSize').value) / 100;
            const opacity = parseFloat(document.getElementById('wmImageOpacity').value);
            
            const wmWidth = canvas.width * sizePercent;
            const wmHeight = (watermarkImage.height / watermarkImage.width) * wmWidth;
            
            ctx.save();
            ctx.globalAlpha = opacity;
            
            if (isTile) {
                // Âπ≥Èã™Ê®°Âºè
                const gapX = wmWidth + 30;
                const gapY = wmHeight + 30;
                const rows = Math.ceil(canvas.height / gapY) + 1;
                const cols = Math.ceil(canvas.width / gapX) + 1;
                
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        ctx.drawImage(watermarkImage, c * gapX, r * gapY, wmWidth, wmHeight);
                    }
                }
            } else {
                // ÂñÆ‰∏Ä‰ΩçÁΩÆ
                const pos = getWatermarkPosition(wmWidth, wmHeight);
                ctx.drawImage(watermarkImage, pos.x - wmWidth/2, pos.y - wmHeight/2, wmWidth, wmHeight);
            }
            
            ctx.restore();
            
            // Êõ¥Êñ∞ PDF Êö´Â≠ò
            if (pdfDoc && pdfPages[currentPageNum - 1]) {
                pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            showToast('‚ú® ÂúñÁâáÊµÆÊ∞¥Âç∞Â∑≤Âä†‰∏äÔºÅ');
        }
        
        function getWatermarkPosition(w, h) {
            const padding = 20;
            const positions = {
                'top-left': { x: padding + w/2, y: padding + h/2 },
                'top-center': { x: canvas.width/2, y: padding + h/2 },
                'top-right': { x: canvas.width - padding - w/2, y: padding + h/2 },
                'middle-left': { x: padding + w/2, y: canvas.height/2 },
                'center': { x: canvas.width/2, y: canvas.height/2 },
                'middle-right': { x: canvas.width - padding - w/2, y: canvas.height/2 },
                'bottom-left': { x: padding + w/2, y: canvas.height - padding - h/2 },
                'bottom-center': { x: canvas.width/2, y: canvas.height - padding - h/2 },
                'bottom-right': { x: canvas.width - padding - w/2, y: canvas.height - padding - h/2 }
            };
            return positions[wmPosition] || positions['center'];
        }
        
        // AI ÂéªÈô§ÊµÆÊ∞¥Âç∞
        async function removeWatermarkAI() {
            if (!currentSelection) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÁî®„ÄåÈÅ∏Âèñ„ÄçÂ∑•ÂÖ∑Ê°ÜÈÅ∏ÊµÆÊ∞¥Âç∞ÂçÄÂüü');
                return;
            }
            
            if (!settings.geminiApiKey) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàË®≠ÂÆö Gemini API Key');
                showPage('settings');
                return;
            }
            
            showToast('ü§ñ AI ÂàÜÊûê‰∏≠...');
            
            try {
                // ÂèñÂæóÈÅ∏ÂèñÂçÄÂüüÁöÑÂúñÁâá
                const { x, y, w, h } = currentSelection;
                const selectedData = ctx.getImageData(x, y, w, h);
                
                // Âª∫Á´ãËá®ÊôÇ canvas
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = w;
                tempCanvas.height = h;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.putImageData(selectedData, 0, 0);
                
                const imageData = tempCanvas.toDataURL('image/jpeg', 0.9).split(',')[1];
                
                const model = document.getElementById('wmRemoveModel').value;
                const apiModel = model === 'gemini-2.5-flash' ? 'gemini-2.5-flash-preview-05-20' : 'gemini-2.0-flash';
                
                // Ë´ãÊ±Ç AI ÂàÜÊûêËÉåÊôØÈ°èËâ≤
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${apiModel}:generateContent?key=${settings.geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: 'ÈÄôÂºµÂúñÁâáÊúâÊµÆÊ∞¥Âç∞„ÄÇË´ãÂàÜÊûêÊµÆÊ∞¥Âç∞ËÉåÂæåÁöÑËÉåÊôØÈ°èËâ≤„ÄÇÂè™ÂõûÁ≠î‰∏ÄÂÄã HEX È°èËâ≤‰ª£Á¢ºÔºàÂ¶Ç #FFFFFFÔºâÔºå‰∏çË¶ÅÂÖ∂‰ªñÊñáÂ≠ó„ÄÇ' },
                                { inline_data: { mime_type: 'image/jpeg', data: imageData } }
                            ]
                        }]
                    })
                });
                
                if (!response.ok) throw new Error('AI ÂàÜÊûêÂ§±Êïó');
                
                const data = await response.json();
                let bgColor = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '#FFFFFF';
                
                // Á¢∫‰øùÊòØÊúâÊïàÁöÑÈ°èËâ≤
                if (!bgColor.startsWith('#')) {
                    bgColor = '#' + bgColor;
                }
                bgColor = bgColor.substring(0, 7);
                
                // Áî®ÂàÜÊûêÂá∫ÁöÑÈ°èËâ≤Â°´ÂÖÖ
                ctx.fillStyle = bgColor;
                ctx.fillRect(x, y, w, h);
                
                // Êõ¥Êñ∞ PDF Êö´Â≠ò
                if (pdfDoc && pdfPages[currentPageNum - 1]) {
                    pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
                }
                
                // Ê∏ÖÈô§ÈÅ∏ÂèñÊ°Ü
                currentSelection = null;
                document.getElementById('selectionBox').style.display = 'none';
                
                showToast('‚úÖ ÊµÆÊ∞¥Âç∞Â∑≤ÁßªÈô§ÔºÅ(ËÉåÊôØËâ≤: ' + bgColor + ')');
            } catch (e) {
                showToast('‚ùå ' + e.message);
            }
        }
        
        // ÊâãÂãïÂ°´Ëâ≤ÂéªÈô§ÊµÆÊ∞¥Âç∞
        function removeWatermarkManual() {
            if (!currentSelection) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÁî®„ÄåÈÅ∏Âèñ„ÄçÂ∑•ÂÖ∑Ê°ÜÈÅ∏ÊµÆÊ∞¥Âç∞ÂçÄÂüü');
                return;
            }
            
            const bgColor = document.getElementById('bgColor').value;
            const { x, y, w, h } = currentSelection;
            
            ctx.fillStyle = bgColor;
            ctx.fillRect(x, y, w, h);
            
            // Êõ¥Êñ∞ PDF Êö´Â≠ò
            if (pdfDoc && pdfPages[currentPageNum - 1]) {
                pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            // Ê∏ÖÈô§ÈÅ∏ÂèñÊ°Ü
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            
            showToast('‚úÖ Â∑≤Áî®ËÉåÊôØËâ≤Ë¶ÜËìãÔºÅ');
        }
        
        // ===== Ê≠∑Âè≤Ë®òÈåÑÔºàÂæ©ÂéüÂäüËÉΩÔºâ =====
        let historyStack = [];
        const MAX_HISTORY = 20;
        
        function saveHistory() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            historyStack.push({
                data: imageData,
                width: canvas.width,
                height: canvas.height
            });
            if (historyStack.length > MAX_HISTORY) {
                historyStack.shift();
            }
        }
        
        function undoAction() {
            if (historyStack.length <= 1) {
                showToast('‚ö†Ô∏è ÁÑ°Ê≥ïÂÜçÂæ©Âéü');
                return;
            }
            historyStack.pop(); // ÁßªÈô§Áï∂ÂâçÁãÄÊÖã
            const prev = historyStack[historyStack.length - 1];
            canvas.width = prev.width;
            canvas.height = prev.height;
            ctx.putImageData(prev.data, 0, 0);
            showToast('‚Ü©Ô∏è Â∑≤Âæ©Âéü');
        }
        
        // ÈáçÁΩÆÁï´Â∏ÉÔºàÊ∏ÖÁ©∫Èáç‰æÜÔºâ
        function resetCanvas() {
            if (!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Áï´Â∏ÉÈáçÊñ∞ÈñãÂßãÂóéÔºü')) return;
            
            // Èö±ËóèÁï´Â∏É
            document.getElementById('canvasWrapper').classList.remove('show');
            document.getElementById('uploadZone').classList.remove('hidden');
            
            // Ê∏ÖÁ©∫Áï´Â∏É
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.width = 800;
            canvas.height = 600;
            
            // ÈáçÁΩÆÁãÄÊÖã
            historyStack = [];
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            
            // ÈáçÁΩÆ PDF
            pdfDoc = null;
            pdfPages = [];
            currentPageNum = 1;
            document.getElementById('pdfControls').style.display = 'none';
            document.getElementById('pdfToolBtn').style.display = 'none';
            
            // ÂÅúÁî®ÊâÄÊúâÂ∑•ÂÖ∑ÊåâÈàï
            const btns = ['selectBtn', 'clearBtn', 'undoBtn', 'resetBtn', 'aiBtn', 'watermarkBtn', 
                'mosaicBtn', 'stampBtn', 'signBtn', 'filterBtn', 'adjustBtn', 'frameBtn', 
                'stickerBtn', 'arrowBtn', 'rotateBtn', 'flipHBtn', 'flipVBtn', 'cropBtn', 
                'mergeBtn', 'qrBtn', 'compressBtn', 'brushBtn', 'shapeBtn', 'textFxBtn',
                'templateBtn', 'collageBtn', 'beautyBtn', 'removeBgBtn', 'batchBtn', 
                'effectBtn', 'overlayBtn', 'annotateBtn', 'historyBtn', 'infoBtn'];
            btns.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = true;
            });
            
            showToast('üóëÔ∏è Â∑≤Ê∏ÖÁ©∫ÔºåË´ãÈáçÊñ∞‰∏äÂÇ≥ÂúñÁâá');
        }
        
        // ===== È¶¨Ë≥ΩÂÖãÂäüËÉΩ =====
        function applyMosaic() {
            if (!currentSelection) return;
            
            saveHistory();
            // Á¢∫‰øùÂ∫ßÊ®ôÁÇ∫Êï¥Êï∏
            const x = Math.round(currentSelection.x);
            const y = Math.round(currentSelection.y);
            const w = Math.round(currentSelection.w);
            const h = Math.round(currentSelection.h);
            
            if (w < 1 || h < 1) return;
            
            const blockSize = 10;
            const imageData = ctx.getImageData(x, y, w, h);
            const data = imageData.data;
            
            for (let by = 0; by < h; by += blockSize) {
                for (let bx = 0; bx < w; bx += blockSize) {
                    let r = 0, g = 0, b = 0, count = 0;
                    
                    for (let py = by; py < Math.min(by + blockSize, h); py++) {
                        for (let px = bx; px < Math.min(bx + blockSize, w); px++) {
                            const i = (py * w + px) * 4;
                            r += data[i];
                            g += data[i + 1];
                            b += data[i + 2];
                            count++;
                        }
                    }
                    
                    r = Math.floor(r / count);
                    g = Math.floor(g / count);
                    b = Math.floor(b / count);
                    
                    for (let py = by; py < Math.min(by + blockSize, h); py++) {
                        for (let px = bx; px < Math.min(bx + blockSize, w); px++) {
                            const i = (py * w + px) * 4;
                            data[i] = r;
                            data[i + 1] = g;
                            data[i + 2] = b;
                        }
                    }
                }
            }
            
            ctx.putImageData(imageData, x, y);
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            showToast('üî≤ È¶¨Ë≥ΩÂÖãÂ∑≤Â•óÁî®');
        }
        
        // ===== ÂúñÁ´†ÂäüËÉΩ =====
        function showStampPanel() {
            const panel = document.getElementById('stampPanel');
            const isShowing = panel.classList.contains('show');
            
            // Â¶ÇÊûúÊ≠£Âú®ÈóúÈñâÈù¢ÊùøÔºåÂêåÊôÇÂèñÊ∂àÊîæÁΩÆÊ®°Âºè
            if (isShowing) {
                cancelStampPlacement();
            }
            
            togglePanel('stampPanel', 'stampBtn');
        }
        
        // ÂúñÁ´†ÁãÄÊÖã
        let stampPosition = 'center';
        let pendingStamp = null; // ÂæÖÊîæÁΩÆÁöÑÂúñÁ´†
        let stampDragMode = false;
        
        function addStamp(text) {
            if (!text) {
                showToast('‚ö†Ô∏è Ë´ãËº∏ÂÖ•ÂúñÁ´†ÊñáÂ≠ó');
                return;
            }
            
            const size = parseInt(document.getElementById('stampSize').value);
            const color = document.getElementById('stampColor').value;
            
            // ‰ΩøÁî®‰πùÂÆÆÊ†º‰ΩçÁΩÆ‰ΩúÁÇ∫ÂàùÂßã‰ΩçÁΩÆ
            createDragObject('stamp', text, { fontSize: size, color: color }, stampPosition);
        }
        
        function placeStampAt(text, clickX, clickY) {
            // ‰øùÁïôÁµ¶Ëàä‰ª£Á¢ºÂÖºÂÆπ
            const size = parseInt(document.getElementById('stampSize').value);
            const color = document.getElementById('stampColor').value;
            createDragObject('stamp', text, { fontSize: size, color: color }, stampPosition);
            pendingStamp = null;
            stampDragMode = false;
            canvas.style.cursor = 'default';
        }
        
        function setStampPosition(pos, btn) {
            stampPosition = pos;
            document.querySelectorAll('#stampPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function cancelStampPlacement() {
            // ÂèñÊ∂à‰ªª‰ΩïÊãñÊõ≥‰∏≠ÁöÑÁâ©‰ª∂
            if (currentDragObject) {
                removeDragObject();
                showToast('‚ùå ÊîæÁΩÆÂ∑≤ÂèñÊ∂à');
            }
        }
        
        // ===== Á∞ΩÂêçÂäüËÉΩ =====
        let signCtx = null;
        let isDrawingSign = false;
        let signPosition = 'bottom-right';
        
        function showSignPanel() {
            const panel = document.getElementById('signPanel');
            const isShowing = panel.classList.contains('show');
            
            // Â¶ÇÊûúÊ≠£Âú®ÈóúÈñâÈù¢ÊùøÔºåÂêåÊôÇÂèñÊ∂àÊîæÁΩÆÊ®°Âºè
            if (isShowing) {
                cancelSignPlacement();
            }
            
            togglePanel('signPanel', 'signBtn');
            if (!isShowing) {
                initSignCanvas();
            }
        }
        
        function initSignCanvas() {
            const signCanvas = document.getElementById('signCanvas');
            signCtx = signCanvas.getContext('2d');
            signCtx.fillStyle = 'white';
            signCtx.fillRect(0, 0, signCanvas.width, signCanvas.height);
            
            signCanvas.onmousedown = startSign;
            signCanvas.onmousemove = drawSign;
            signCanvas.onmouseup = () => isDrawingSign = false;
            signCanvas.onmouseleave = () => isDrawingSign = false;
            
            signCanvas.ontouchstart = (e) => { e.preventDefault(); startSign(e.touches[0]); };
            signCanvas.ontouchmove = (e) => { e.preventDefault(); drawSign(e.touches[0]); };
            signCanvas.ontouchend = () => isDrawingSign = false;
        }
        
        function startSign(e) {
            isDrawingSign = true;
            const rect = document.getElementById('signCanvas').getBoundingClientRect();
            signCtx.beginPath();
            signCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        
        function drawSign(e) {
            if (!isDrawingSign) return;
            const rect = document.getElementById('signCanvas').getBoundingClientRect();
            const lineWidth = document.getElementById('signLineWidth').value;
            const color = document.getElementById('signColor').value;
            
            signCtx.lineWidth = lineWidth;
            signCtx.strokeStyle = color;
            signCtx.lineCap = 'round';
            signCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            signCtx.stroke();
        }
        
        function clearSignature() {
            const signCanvas = document.getElementById('signCanvas');
            signCtx.fillStyle = 'white';
            signCtx.fillRect(0, 0, signCanvas.width, signCanvas.height);
        }
        
        // Á∞ΩÂêçÊãñÊõ≥Áõ∏Èóú
        let signDragMode = false;
        let pendingSign = null;
        
        function applySignature() {
            const signCanvas = document.getElementById('signCanvas');
            const signData = signCanvas.toDataURL();
            
            // ‰ΩøÁî®‰πùÂÆÆÊ†º‰ΩçÁΩÆ‰ΩúÁÇ∫ÂàùÂßã‰ΩçÁΩÆ
            createDragObject('sign', signData, {}, signPosition);
        }
        
        function placeSignAt(clickX, clickY) {
            // ‰øùÁïôÁµ¶Ëàä‰ª£Á¢ºÂÖºÂÆπ
            const signCanvas = document.getElementById('signCanvas');
            const signData = pendingSign || signCanvas.toDataURL();
            createDragObject('sign', signData, {}, signPosition);
            pendingSign = null;
            signDragMode = false;
            canvas.style.cursor = 'default';
        }
        
        function setSignPosition(pos, btn) {
            signPosition = pos;
            document.querySelectorAll('#signPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function cancelSignPlacement() {
            // ÂèñÊ∂à‰ªª‰ΩïÊãñÊõ≥‰∏≠ÁöÑÁâ©‰ª∂
            if (currentDragObject) {
                removeDragObject();
                showToast('‚ùå ÊîæÁΩÆÂ∑≤ÂèñÊ∂à');
            }
        }
        
        // ===== ÊøæÈè°ÂäüËÉΩ =====
        let originalForFilter = null;
        
        function showFilterPanel() {
            togglePanel('filterPanel', 'filterBtn');
            if (!originalForFilter) {
                originalForFilter = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            // ÂàùÂßãÂåñÈ†êË¶ΩÁï´Â∏É
            const previewCanvas = document.getElementById('filterPreview');
            if (previewCanvas) {
                const previewCtx = previewCanvas.getContext('2d');
                previewCtx.drawImage(canvas, 0, 0, previewCanvas.width, previewCanvas.height);
            }
        }
        
        // ÊøæÈè°È†êË¶ΩÂáΩÊï∏
        function previewFilter(type) {
            const previewCanvas = document.getElementById('filterPreview');
            const previewCtx = previewCanvas.getContext('2d');
            const nameSpan = document.getElementById('filterPreviewName');
            
            const filterNames = {
                'none': 'ÂéüÂúñ', 'grayscale': 'ÈªëÁôΩ', 'sepia': 'Âæ©Âè§', 'invert': 'ÂèçËΩâ',
                'blur': 'Ê®°Á≥ä', 'sharpen': 'Èä≥Âåñ', 'brightness': 'Êòé‰∫Æ', 'contrast': 'Â∞çÊØî',
                'saturate': 'ÈÆÆË±î', 'cool': 'ÂÜ∑Ëâ≤', 'warm': 'ÊöñËâ≤', 'vintage': 'Êá∑Ëàä'
            };
            nameSpan.textContent = filterNames[type] || type;
            
            // Á∏ÆÂ∞èÁπ™Ë£ΩÂà∞È†êË¶ΩÁï´Â∏É
            previewCtx.drawImage(canvas, 0, 0, previewCanvas.width, previewCanvas.height);
            
            if (type === 'none') return;
            
            const imageData = previewCtx.getImageData(0, 0, previewCanvas.width, previewCanvas.height);
            const data = imageData.data;
            
            switch(type) {
                case 'grayscale':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = data[i+1] = data[i+2] = avg;
                    }
                    break;
                case 'sepia':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i], g = data[i+1], b = data[i+2];
                        data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
                        data[i+1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                        data[i+2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
                    }
                    break;
                case 'invert':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];
                        data[i+1] = 255 - data[i+1];
                        data[i+2] = 255 - data[i+2];
                    }
                    break;
                case 'brightness':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] + 50);
                        data[i+1] = Math.min(255, data[i+1] + 50);
                        data[i+2] = Math.min(255, data[i+2] + 50);
                    }
                    break;
                case 'contrast':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, Math.max(0, (data[i] - 128) * 1.5 + 128));
                        data[i+1] = Math.min(255, Math.max(0, (data[i+1] - 128) * 1.5 + 128));
                        data[i+2] = Math.min(255, Math.max(0, (data[i+2] - 128) * 1.5 + 128));
                    }
                    break;
                case 'saturate':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = Math.min(255, avg + (data[i] - avg) * 2);
                        data[i+1] = Math.min(255, avg + (data[i+1] - avg) * 2);
                        data[i+2] = Math.min(255, avg + (data[i+2] - avg) * 2);
                    }
                    break;
                case 'cool':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.max(0, data[i] - 20);
                        data[i+2] = Math.min(255, data[i+2] + 20);
                    }
                    break;
                case 'warm':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] + 20);
                        data[i+2] = Math.max(0, data[i+2] - 20);
                    }
                    break;
                case 'vintage':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * 0.9 + 40);
                        data[i+1] = Math.min(255, data[i+1] * 0.8 + 20);
                        data[i+2] = Math.min(255, data[i+2] * 0.7);
                    }
                    break;
                case 'blur':
                    previewCtx.filter = 'blur(2px)';
                    previewCtx.drawImage(previewCanvas, 0, 0);
                    previewCtx.filter = 'none';
                    return;
            }
            
            previewCtx.putImageData(imageData, 0, 0);
        }
        
        function applyFilter(type) {
            if (!originalForFilter) {
                originalForFilter = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            saveHistory();
            
            // ÂÖàÈÇÑÂéü
            ctx.putImageData(originalForFilter, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            switch(type) {
                case 'none':
                    break;
                case 'grayscale':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = data[i+1] = data[i+2] = avg;
                    }
                    break;
                case 'sepia':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i], g = data[i+1], b = data[i+2];
                        data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
                        data[i+1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                        data[i+2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
                    }
                    break;
                case 'invert':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];
                        data[i+1] = 255 - data[i+1];
                        data[i+2] = 255 - data[i+2];
                    }
                    break;
                case 'brightness':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] + 50);
                        data[i+1] = Math.min(255, data[i+1] + 50);
                        data[i+2] = Math.min(255, data[i+2] + 50);
                    }
                    break;
                case 'contrast':
                    const factor = 1.5;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, Math.max(0, (data[i] - 128) * factor + 128));
                        data[i+1] = Math.min(255, Math.max(0, (data[i+1] - 128) * factor + 128));
                        data[i+2] = Math.min(255, Math.max(0, (data[i+2] - 128) * factor + 128));
                    }
                    break;
                case 'saturate':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = Math.min(255, avg + (data[i] - avg) * 2);
                        data[i+1] = Math.min(255, avg + (data[i+1] - avg) * 2);
                        data[i+2] = Math.min(255, avg + (data[i+2] - avg) * 2);
                    }
                    break;
                case 'cool':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.max(0, data[i] - 20);
                        data[i+2] = Math.min(255, data[i+2] + 20);
                    }
                    break;
                case 'warm':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] + 20);
                        data[i+2] = Math.max(0, data[i+2] - 20);
                    }
                    break;
                case 'vintage':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i], g = data[i+1], b = data[i+2];
                        data[i] = Math.min(255, r * 0.9 + 40);
                        data[i+1] = Math.min(255, g * 0.7 + 20);
                        data[i+2] = Math.min(255, b * 0.5);
                    }
                    break;
                case 'blur':
                    // Á∞°ÂñÆÊ®°Á≥ä
                    ctx.putImageData(imageData, 0, 0);
                    ctx.filter = 'blur(3px)';
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                    showToast('üé® ÊøæÈè°Â∑≤Â•óÁî®');
                    return;
                case 'sharpen':
                    // Èä≥ÂåñÊïàÊûú
                    ctx.putImageData(imageData, 0, 0);
                    ctx.filter = 'contrast(1.2)';
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                    showToast('üé® ÊøæÈè°Â∑≤Â•óÁî®');
                    return;
            }
            
            ctx.putImageData(imageData, 0, 0);
            originalForFilter = ctx.getImageData(0, 0, canvas.width, canvas.height);
            showToast('üé® ÊøæÈè°Â∑≤Â•óÁî®');
        }
        
        // ===== Ëâ≤ÂΩ©Ë™øÊï¥ =====
        function showAdjustPanel() {
            togglePanel('adjustPanel', 'adjustBtn');
            initAdjustSliders();
        }
        
        function initAdjustSliders() {
            ['Brightness', 'Contrast', 'Saturation', 'Hue'].forEach(name => {
                const slider = document.getElementById('adjust' + name);
                const label = document.getElementById(name.toLowerCase() + 'Val');
                if (slider && label) {
                    slider.oninput = function() {
                        label.textContent = name === 'Hue' ? this.value + '¬∞' : this.value;
                    };
                }
            });
        }
        
        function resetAdjustments() {
            document.getElementById('adjustBrightness').value = 0;
            document.getElementById('adjustContrast').value = 0;
            document.getElementById('adjustSaturation').value = 0;
            document.getElementById('adjustHue').value = 0;
            document.getElementById('brightnessVal').textContent = '0';
            document.getElementById('contrastVal').textContent = '0';
            document.getElementById('saturationVal').textContent = '0';
            document.getElementById('hueVal').textContent = '0¬∞';
        }
        
        function applyAdjustments() {
            saveHistory();
            const brightness = parseInt(document.getElementById('adjustBrightness').value);
            const contrast = parseInt(document.getElementById('adjustContrast').value);
            const saturation = parseInt(document.getElementById('adjustSaturation').value);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const contrastFactor = (contrast + 100) / 100;
            
            for (let i = 0; i < data.length; i += 4) {
                // ‰∫ÆÂ∫¶
                data[i] = Math.min(255, Math.max(0, data[i] + brightness));
                data[i+1] = Math.min(255, Math.max(0, data[i+1] + brightness));
                data[i+2] = Math.min(255, Math.max(0, data[i+2] + brightness));
                
                // Â∞çÊØî
                data[i] = Math.min(255, Math.max(0, (data[i] - 128) * contrastFactor + 128));
                data[i+1] = Math.min(255, Math.max(0, (data[i+1] - 128) * contrastFactor + 128));
                data[i+2] = Math.min(255, Math.max(0, (data[i+2] - 128) * contrastFactor + 128));
                
                // È£ΩÂíåÂ∫¶
                const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                const satFactor = (saturation + 100) / 100;
                data[i] = Math.min(255, Math.max(0, avg + (data[i] - avg) * satFactor));
                data[i+1] = Math.min(255, Math.max(0, avg + (data[i+1] - avg) * satFactor));
                data[i+2] = Math.min(255, Math.max(0, avg + (data[i+2] - avg) * satFactor));
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üåà Ë™øÊï¥Â∑≤Â•óÁî®');
        }
        
        // ===== ÈÇäÊ°ÜÂäüËÉΩ =====
        function showFramePanel() {
            togglePanel('framePanel', 'frameBtn');
        }
        
        function addFrame(type) {
            saveHistory();
            const frameWidth = parseInt(document.getElementById('frameWidth').value);
            const frameColor = document.getElementById('frameColor').value;
            
            // Âª∫Á´ãÊñ∞Áï´Â∏É
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            if (type === 'none') {
                showToast('üñºÔ∏è ÈÇäÊ°ÜÂ∑≤ÁßªÈô§');
                return;
            }
            
            const padding = type === 'polaroid' ? frameWidth * 3 : frameWidth;
            const bottomPadding = type === 'polaroid' ? frameWidth * 5 : padding;
            
            tempCanvas.width = canvas.width + padding * 2;
            tempCanvas.height = canvas.height + padding + bottomPadding;
            
            // Â°´ÂÖÖËÉåÊôØ
            tempCtx.fillStyle = frameColor;
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Âä†ÂÖ•Èô∞ÂΩ±
            if (type === 'shadow') {
                tempCtx.shadowColor = 'rgba(0,0,0,0.5)';
                tempCtx.shadowBlur = 20;
                tempCtx.shadowOffsetX = 10;
                tempCtx.shadowOffsetY = 10;
            }
            
            // ÂúìËßí
            if (type === 'rounded') {
                tempCtx.beginPath();
                const r = 20;
                tempCtx.roundRect(padding, padding, canvas.width, canvas.height, r);
                tempCtx.clip();
            }
            
            // Áï´ÂéüÂúñ
            tempCtx.drawImage(canvas, padding, padding);
            
            // Êõ¥Êñ∞‰∏ªÁï´Â∏É
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('üñºÔ∏è ÈÇäÊ°ÜÂ∑≤Âä†‰∏ä');
        }
        
        // ===== Ë≤ºÂúñÂäüËÉΩ =====
        const stickers = {
            emoji: ['üòÄ','üòÇ','ü•∞','üòé','ü§î','üò±','ü•≥','üò¥','ü§Æ','üëç','üëé','üëè','üôè','üí™','‚ù§Ô∏è','üíî','üî•','‚≠ê','üíØ','üéâ'],
            symbol: ['‚úì','‚úó','‚òÖ','‚òÜ','‚ô†','‚ô£','‚ô•','‚ô¶','‚ô™','‚ô´','‚òÄ','‚òÅ','‚òÇ','‚ö°','‚ùÑ','‚òé','‚úâ','‚úÇ','‚úè','‚åõ'],
            shape: ['‚óè','‚óã','‚ñ†','‚ñ°','‚ñ≤','‚ñ≥','‚ñº','‚ñΩ','‚óÜ','‚óá','‚òÖ','‚òÜ','‚ú¶','‚úß','‚ù§','‚ô•','‚óâ','‚óé','‚¨§','‚¨°']
        };
        
        // Ë≤ºÂúñÁãÄÊÖã
        let stickerPosition = 'center';
        let pendingSticker = null;
        let stickerDragMode = false;
        
        function showStickerPanel() {
            const panel = document.getElementById('stickerPanel');
            const isShowing = panel.classList.contains('show');
            
            // Â¶ÇÊûúÊ≠£Âú®ÈóúÈñâÈù¢ÊùøÔºåÂêåÊôÇÂèñÊ∂àÊîæÁΩÆÊ®°Âºè
            if (isShowing) {
                cancelStickerPlacement();
            }
            
            togglePanel('stickerPanel', 'stickerBtn');
            if (!isShowing) {
                showStickerTab('emoji');
            }
        }
        
        function showStickerTab(tab) {
            document.querySelectorAll('.sticker-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            const grid = document.getElementById('stickerGrid');
            grid.innerHTML = '';
            
            stickers[tab].forEach(s => {
                const item = document.createElement('button');
                item.className = 'sticker-item';
                item.textContent = s;
                item.onclick = () => addSticker(s);
                grid.appendChild(item);
            });
        }
        
        function addSticker(sticker) {
            const size = parseInt(document.getElementById('stickerSize').value);
            // ‰ΩøÁî®‰πùÂÆÆÊ†º‰ΩçÁΩÆ‰ΩúÁÇ∫ÂàùÂßã‰ΩçÁΩÆ
            createDragObject('sticker', sticker, { size }, stickerPosition);
        }
        
        function placeStickerAt(sticker, clickX, clickY) {
            // ‰øùÁïôÁµ¶Ëàä‰ª£Á¢ºÂÖºÂÆπ
            const size = parseInt(document.getElementById('stickerSize').value);
            createDragObject('sticker', sticker, { size }, stickerPosition);
            pendingSticker = null;
            stickerDragMode = false;
            canvas.style.cursor = 'default';
        }
        
        function setStickerPosition(pos, btn) {
            stickerPosition = pos;
            document.querySelectorAll('#stickerPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function cancelStickerPlacement() {
            // ÂèñÊ∂à‰ªª‰ΩïÊãñÊõ≥‰∏≠ÁöÑÁâ©‰ª∂
            if (currentDragObject) {
                removeDragObject();
                showToast('‚ùå ÊîæÁΩÆÂ∑≤ÂèñÊ∂à');
            }
        }
        
        // ===== ÊãñÊõ≥ÊîæÁΩÆÁ≥ªÁµ± =====
        
        // Ê†πÊìö‰πùÂÆÆÊ†º‰ΩçÁΩÆË®àÁÆóÂ∫ßÊ®ô
        function getPositionCoords(position, objWidth, objHeight, canvasW, canvasH) {
            const padding = 30;
            let x, y;
            
            switch(position) {
                case 'top-left': 
                    x = padding + objWidth/2; 
                    y = padding + objHeight/2; 
                    break;
                case 'top-center': 
                    x = canvasW / 2; 
                    y = padding + objHeight/2; 
                    break;
                case 'top-right': 
                    x = canvasW - padding - objWidth/2; 
                    y = padding + objHeight/2; 
                    break;
                case 'middle-left': 
                    x = padding + objWidth/2; 
                    y = canvasH / 2; 
                    break;
                case 'center': 
                    x = canvasW / 2; 
                    y = canvasH / 2; 
                    break;
                case 'middle-right': 
                    x = canvasW - padding - objWidth/2; 
                    y = canvasH / 2; 
                    break;
                case 'bottom-left': 
                    x = padding + objWidth/2; 
                    y = canvasH - padding - objHeight/2; 
                    break;
                case 'bottom-center': 
                    x = canvasW / 2; 
                    y = canvasH - padding - objHeight/2; 
                    break;
                case 'bottom-right': 
                    x = canvasW - padding - objWidth/2; 
                    y = canvasH - padding - objHeight/2; 
                    break;
                default: 
                    x = canvasW / 2; 
                    y = canvasH / 2;
            }
            
            return { x, y };
        }
        
        // ÂâµÂª∫ÂèØÊãñÊõ≥Áâ©‰ª∂
        function createDragObject(type, content, options = {}, position = 'center') {
            // ÁßªÈô§‰πãÂâçÁöÑÊãñÊõ≥Áâ©‰ª∂
            removeDragObject();
            
            const dragLayer = document.getElementById('dragLayer');
            const container = document.getElementById('canvasContainer');
            const canvasRect = canvas.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            // Ë®àÁÆóÁï´Â∏ÉÂú®ÂÆπÂô®‰∏≠ÁöÑÂÅèÁßª
            const canvasOffsetX = canvasRect.left - containerRect.left + container.scrollLeft;
            const canvasOffsetY = canvasRect.top - containerRect.top + container.scrollTop;
            
            const obj = document.createElement('div');
            obj.className = 'drag-object';
            obj.dataset.type = type;
            obj.dataset.content = content;
            obj.dataset.options = JSON.stringify(options);
            
            // Ê†πÊìöÈ°ûÂûãË®≠ÂÆöÂÖßÂÆπÂíåÂ§ßÂ∞è
            let width, height;
            switch(type) {
                case 'sticker':
                    const stickerSize = options.size || 50;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${stickerSize}px">${content}</span>`;
                    width = stickerSize * 1.2;
                    height = stickerSize * 1.2;
                    break;
                case 'stamp':
                    const stampSize = options.fontSize || 24;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${stampSize}px;color:${options.color || '#ff0000'};font-weight:bold;border:3px solid ${options.color || '#ff0000'};padding:8px 15px;border-radius:8px;transform:rotate(-15deg)">${content}</span>`;
                    width = content.length * stampSize * 0.8 + 40;
                    height = stampSize * 2.5;
                    break;
                case 'text':
                    const textSize = options.fontSize || 24;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${textSize}px;color:${options.color || '#ffffff'}">${content}</span>`;
                    width = content.length * textSize * 0.7 + 20;
                    height = textSize * 1.5;
                    break;
                case 'qr':
                    obj.innerHTML = `<img src="${content}" style="width:${options.size || 100}px;height:${options.size || 100}px">`;
                    width = options.size || 100;
                    height = options.size || 100;
                    break;
                case 'sign':
                    obj.innerHTML = `<img src="${content}" style="max-width:150px;max-height:80px">`;
                    width = 150;
                    height = 80;
                    break;
                case 'textfx':
                    // ÊñáÂ≠óÁâπÊïàÈúÄË¶ÅÁâπÊÆäËôïÁêÜ
                    const fxSize = options.fontSize || 60;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${fxSize}px;font-weight:bold;color:${options.color1 || '#ff0000'}">${content}</span>`;
                    width = content.length * fxSize * 0.7 + 30;
                    height = fxSize * 1.5;
                    break;
                case 'watermark':
                    const wmSize = options.fontSize || 48;
                    const wmOpacity = options.opacity || 0.5;
                    const wmAngle = options.angle || -30;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${wmSize}px;font-weight:bold;color:${options.color || '#ffffff'};opacity:${wmOpacity};transform:rotate(${wmAngle}deg)">${content}</span>`;
                    width = content.length * wmSize * 0.7 + 30;
                    height = wmSize * 2;
                    break;
                case 'quicktext':
                    const qtSize = options.fontSize || 24;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${qtSize}px;color:${options.color || '#ffffff'};${options.bold ? 'font-weight:bold;' : ''}${options.italic ? 'font-style:italic;' : ''}">${content}</span>`;
                    width = content.length * qtSize * 0.6 + 20;
                    height = qtSize * 1.5;
                    break;
            }
            
            // Ê†πÊìö‰πùÂÆÆÊ†º‰ΩçÁΩÆË®àÁÆóÂàùÂßãÂ∫ßÊ®ô
            const scaleX = canvasRect.width / canvas.width;
            const scaleY = canvasRect.height / canvas.height;
            
            const posCoords = getPositionCoords(position, width, height, canvasRect.width, canvasRect.height);
            const initialX = canvasOffsetX + posCoords.x - width/2;
            const initialY = canvasOffsetY + posCoords.y - height/2;
            
            obj.style.left = initialX + 'px';
            obj.style.top = initialY + 'px';
            obj.style.width = width + 'px';
            obj.style.height = height + 'px';
            
            // Ê∑ªÂä†ÊãñÊõ≥‰∫ã‰ª∂
            obj.addEventListener('mousedown', startDragObject);
            obj.addEventListener('touchstart', startDragObjectTouch, { passive: false });
            
            dragLayer.appendChild(obj);
            currentDragObject = obj;
            
            // È°ØÁ§∫ÊéßÂà∂ÊåâÈàï
            document.getElementById('dragControls').classList.add('show');
            
            showToast('üéØ ÊãñÊõ≥Âà∞ÊÉ≥Ë¶ÅÁöÑ‰ΩçÁΩÆÔºåÈªûÊìäÁ¢∫Ë™ç');
        }
        
        function startDragObject(e) {
            if (!currentDragObject) return;
            e.preventDefault();
            isDraggingObject = true;
            currentDragObject.classList.add('dragging');
            
            const rect = currentDragObject.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
            
            document.addEventListener('mousemove', moveDragObject);
            document.addEventListener('mouseup', stopDragObject);
        }
        
        function startDragObjectTouch(e) {
            if (!currentDragObject) return;
            e.preventDefault();
            isDraggingObject = true;
            currentDragObject.classList.add('dragging');
            
            const touch = e.touches[0];
            const rect = currentDragObject.getBoundingClientRect();
            dragOffsetX = touch.clientX - rect.left;
            dragOffsetY = touch.clientY - rect.top;
            
            document.addEventListener('touchmove', moveDragObjectTouch, { passive: false });
            document.addEventListener('touchend', stopDragObject);
        }
        
        function moveDragObject(e) {
            if (!isDraggingObject || !currentDragObject) return;
            
            const container = document.getElementById('canvasContainer');
            const containerRect = container.getBoundingClientRect();
            
            let newX = e.clientX - containerRect.left - dragOffsetX + container.scrollLeft;
            let newY = e.clientY - containerRect.top - dragOffsetY + container.scrollTop;
            
            currentDragObject.style.left = newX + 'px';
            currentDragObject.style.top = newY + 'px';
        }
        
        function moveDragObjectTouch(e) {
            if (!isDraggingObject || !currentDragObject) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const container = document.getElementById('canvasContainer');
            const containerRect = container.getBoundingClientRect();
            
            let newX = touch.clientX - containerRect.left - dragOffsetX + container.scrollLeft;
            let newY = touch.clientY - containerRect.top - dragOffsetY + container.scrollTop;
            
            currentDragObject.style.left = newX + 'px';
            currentDragObject.style.top = newY + 'px';
        }
        
        function stopDragObject() {
            isDraggingObject = false;
            if (currentDragObject) {
                currentDragObject.classList.remove('dragging');
            }
            document.removeEventListener('mousemove', moveDragObject);
            document.removeEventListener('mouseup', stopDragObject);
            document.removeEventListener('touchmove', moveDragObjectTouch);
            document.removeEventListener('touchend', stopDragObject);
        }
        
        // Á¢∫Ë™çÊîæÁΩÆ
        function confirmDragObject() {
            if (!currentDragObject) return;
            
            saveHistory();
            
            const container = document.getElementById('canvasContainer');
            const canvasRect = canvas.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            // Ë®àÁÆóÁï´Â∏ÉÂú®ÂÆπÂô®‰∏≠ÁöÑÂÅèÁßª
            const canvasOffsetX = canvasRect.left - containerRect.left + container.scrollLeft;
            const canvasOffsetY = canvasRect.top - containerRect.top + container.scrollTop;
            
            // Áç≤ÂèñÁâ©‰ª∂‰ΩçÁΩÆÔºàÁõ∏Â∞çÊñºÂÆπÂô®Ôºâ
            const objLeft = parseFloat(currentDragObject.style.left);
            const objTop = parseFloat(currentDragObject.style.top);
            const objWidth = parseFloat(currentDragObject.style.width);
            const objHeight = parseFloat(currentDragObject.style.height);
            
            // Ë®àÁÆó‰∏≠ÂøÉÈªûÁõ∏Â∞çÊñºÁï´Â∏ÉÁöÑ‰ΩçÁΩÆ
            const scaleX = canvas.width / canvasRect.width;
            const scaleY = canvas.height / canvasRect.height;
            
            const centerX = (objLeft + objWidth/2 - canvasOffsetX) * scaleX;
            const centerY = (objTop + objHeight/2 - canvasOffsetY) * scaleY;
            
            const type = currentDragObject.dataset.type;
            const content = currentDragObject.dataset.content;
            const options = JSON.parse(currentDragObject.dataset.options || '{}');
            
            // Áπ™Ë£ΩÂà∞Áï´Â∏É
            switch(type) {
                case 'sticker':
                    ctx.font = `${options.size || 50}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(content, centerX, centerY);
                    break;
                case 'stamp':
                    drawStampAtPosition(content, centerX, centerY, options);
                    break;
                case 'text':
                    ctx.font = `${options.fontSize || 24}px sans-serif`;
                    ctx.fillStyle = options.color || '#ffffff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(content, centerX, centerY);
                    break;
                case 'qr':
                    const qrImg = currentDragObject.querySelector('img');
                    if (qrImg) {
                        const qrSize = options.size || 100;
                        ctx.drawImage(qrImg, centerX - qrSize/2, centerY - qrSize/2, qrSize, qrSize);
                    }
                    break;
                case 'sign':
                    const signImg = currentDragObject.querySelector('img');
                    if (signImg) {
                        const signW = signImg.naturalWidth || 150;
                        const signH = signImg.naturalHeight || 80;
                        const scale = Math.min(150/signW, 80/signH, 1);
                        ctx.drawImage(signImg, centerX - signW*scale/2, centerY - signH*scale/2, signW*scale, signH*scale);
                    }
                    break;
                case 'textfx':
                    applyTextFxDirect(options.style, content, centerX, centerY, options);
                    break;
                case 'watermark':
                    ctx.save();
                    ctx.globalAlpha = options.opacity || 0.5;
                    ctx.font = `bold ${options.fontSize || 48}px sans-serif`;
                    ctx.fillStyle = options.color || '#ffffff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.translate(centerX, centerY);
                    ctx.rotate((options.angle || -30) * Math.PI / 180);
                    ctx.fillText(content, 0, 0);
                    ctx.restore();
                    break;
                case 'quicktext':
                    ctx.save();
                    let fontStyle = '';
                    if (options.bold) fontStyle += 'bold ';
                    if (options.italic) fontStyle += 'italic ';
                    ctx.font = `${fontStyle}${options.fontSize || 24}px sans-serif`;
                    ctx.fillStyle = options.color || '#ffffff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(content, centerX, centerY);
                    ctx.restore();
                    break;
            }
            
            removeDragObject();
            showToast('‚úÖ Â∑≤Á¢∫Ë™çÊîæÁΩÆ');
        }
        
        // ËºîÂä©ÂáΩÊï∏ÔºöÂú®ÊåáÂÆö‰ΩçÁΩÆÁπ™Ë£ΩÂúñÁ´†
        function drawStampAtPosition(text, x, y, options) {
            const fontSize = options.fontSize || 24;
            const color = options.color || '#ff0000';
            
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(-15 * Math.PI / 180);
            
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const textWidth = ctx.measureText(text).width;
            const padding = 15;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.strokeRect(-textWidth/2 - padding, -fontSize/2 - 8, textWidth + padding*2, fontSize + 16);
            
            ctx.fillStyle = color;
            ctx.fillText(text, 0, 0);
            
            ctx.restore();
        }
        
        // ËºîÂä©ÂáΩÊï∏ÔºöÁõ¥Êé•Áπ™Ë£ΩÊñáÂ≠óÁâπÊïà
        function applyTextFxDirect(style, text, x, y, options) {
            const fontSize = options.fontSize || 60;
            const color1 = options.color1 || '#ff0000';
            const color2 = options.color2 || '#0000ff';
            
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            switch(style) {
                case 'shadow':
                    ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetX = 5;
                    ctx.shadowOffsetY = 5;
                    ctx.fillStyle = color1;
                    ctx.fillText(text, x, y);
                    ctx.shadowColor = 'transparent';
                    break;
                case 'outline':
                    ctx.strokeStyle = color2;
                    ctx.lineWidth = 3;
                    ctx.strokeText(text, x, y);
                    ctx.fillStyle = color1;
                    ctx.fillText(text, x, y);
                    break;
                case 'gradient':
                    const gradient = ctx.createLinearGradient(x - 100, y, x + 100, y);
                    gradient.addColorStop(0, color1);
                    gradient.addColorStop(1, color2);
                    ctx.fillStyle = gradient;
                    ctx.fillText(text, x, y);
                    break;
                case 'glow':
                    ctx.shadowColor = color1;
                    ctx.shadowBlur = 20;
                    ctx.fillStyle = 'white';
                    ctx.fillText(text, x, y);
                    ctx.shadowColor = 'transparent';
                    break;
                case '3d':
                    for (let i = 10; i >= 0; i--) {
                        ctx.fillStyle = i === 0 ? color1 : color2;
                        ctx.fillText(text, x + i, y + i);
                    }
                    break;
                case 'neon':
                    ctx.shadowColor = color1;
                    ctx.shadowBlur = 30;
                    ctx.strokeStyle = color1;
                    ctx.lineWidth = 2;
                    ctx.strokeText(text, x, y);
                    ctx.fillStyle = 'white';
                    ctx.fillText(text, x, y);
                    ctx.shadowColor = 'transparent';
                    break;
                case 'retro':
                    ctx.fillStyle = color2;
                    ctx.fillText(text, x + 4, y + 4);
                    ctx.fillStyle = color1;
                    ctx.fillText(text, x, y);
                    break;
                case 'metal':
                    const metalGrad = ctx.createLinearGradient(x, y - fontSize/2, x, y + fontSize/2);
                    metalGrad.addColorStop(0, '#ccc');
                    metalGrad.addColorStop(0.5, '#fff');
                    metalGrad.addColorStop(1, '#999');
                    ctx.fillStyle = metalGrad;
                    ctx.fillText(text, x, y);
                    ctx.strokeStyle = '#666';
                    ctx.lineWidth = 1;
                    ctx.strokeText(text, x, y);
                    break;
            }
        }
        
        // ÂèñÊ∂àÊîæÁΩÆ
        function cancelDragObject() {
            removeDragObject();
            showToast('‚ùå Â∑≤ÂèñÊ∂àÊîæÁΩÆ');
        }
        
        // ÁßªÈô§ÊãñÊõ≥Áâ©‰ª∂
        function removeDragObject() {
            const dragLayer = document.getElementById('dragLayer');
            if (dragLayer) {
                dragLayer.innerHTML = '';
            }
            currentDragObject = null;
            const dragControls = document.getElementById('dragControls');
            if (dragControls) {
                dragControls.classList.remove('show');
            }
        }
        
        // ===== ÊóãËΩâÁøªËΩâ =====
        function rotateImage90() {
            saveHistory();
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = canvas.height;
            tempCanvas.height = canvas.width;
            
            tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
            tempCtx.rotate(90 * Math.PI / 180);
            tempCtx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
            
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            ctx.drawImage(tempCanvas, 0, 0);
            
            updateCanvasInfo();
            setTimeout(updateZoomInfo, 50);
            showToast('üîÑ Â∑≤ÊóãËΩâ 90¬∞');
        }
        
        function flipImage(direction) {
            saveHistory();
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            if (direction === 'h') {
                tempCtx.translate(canvas.width, 0);
                tempCtx.scale(-1, 1);
            } else {
                tempCtx.translate(0, canvas.height);
                tempCtx.scale(1, -1);
            }
            
            tempCtx.drawImage(canvas, 0, 0);
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast(direction === 'h' ? '‚ÜîÔ∏è Ê∞¥Âπ≥ÁøªËΩâ' : '‚ÜïÔ∏è ÂûÇÁõ¥ÁøªËΩâ');
        }
        
        // ===== Ë£ÅÂàáÂäüËÉΩ =====
        let cropRatio = null;
        
        function showCropPanel() {
            togglePanel('cropPanel', 'cropBtn');
        }
        
        function setCropRatio(ratio) {
            document.querySelectorAll('.crop-preset').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (ratio === 'free') {
                cropRatio = null;
            } else {
                const [w, h] = ratio.split(':').map(Number);
                cropRatio = w / h;
            }
            showToast('üìê ÊØî‰æã: ' + ratio);
        }
        
        function applyCrop() {
            if (!currentSelection) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÈÅ∏ÂèñË£ÅÂàáÂçÄÂüü');
                return;
            }
            
            saveHistory();
            const { x, y, w, h } = currentSelection;
            const imageData = ctx.getImageData(Math.round(x), Math.round(y), Math.round(w), Math.round(h));
            
            canvas.width = Math.round(w);
            canvas.height = Math.round(h);
            ctx.putImageData(imageData, 0, 0);
            
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            
            updateCanvasInfo();
            setTimeout(updateZoomInfo, 50);
            showToast('‚úÇÔ∏è Ë£ÅÂàáÂÆåÊàê');
        }
        
        // ===== ÂúñÁâáÊãºÊé• =====
        let mergeImages = [];
        
        function showMergePanel() {
            togglePanel('mergePanel', 'mergeBtn');
            updateMergeList();
        }
        
        function updateMergeList() {
            const list = document.getElementById('mergeList');
            list.innerHTML = '<div class="merge-item current">üìå ÁõÆÂâçÂúñÁâá</div>';
            
            mergeImages.forEach((img, i) => {
                const item = document.createElement('div');
                item.className = 'merge-item';
                item.innerHTML = `
                    <img src="${img.src}" alt="Image ${i+1}">
                    <span>ÂúñÁâá ${i + 1}</span>
                    <button class="remove-merge" onclick="removeMergeImage(${i})">‚úï</button>
                `;
                list.appendChild(item);
            });
        }
        
        function addMergeImages(e) {
            const files = e.target.files;
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        mergeImages.push(img);
                        updateMergeList();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeMergeImage(index) {
            mergeImages.splice(index, 1);
            updateMergeList();
        }
        
        function executeMerge() {
            if (mergeImages.length === 0) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÊ∑ªÂä†ÂúñÁâá');
                return;
            }
            
            saveHistory();
            const direction = document.querySelector('input[name="mergeDir"]:checked').value;
            
            // Ë®àÁÆóÁ∏ΩÂ∞∫ÂØ∏
            let totalWidth = canvas.width;
            let totalHeight = canvas.height;
            
            if (direction === 'vertical') {
                mergeImages.forEach(img => {
                    totalWidth = Math.max(totalWidth, img.width);
                    totalHeight += img.height;
                });
            } else {
                mergeImages.forEach(img => {
                    totalWidth += img.width;
                    totalHeight = Math.max(totalHeight, img.height);
                });
            }
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = totalWidth;
            tempCanvas.height = totalHeight;
            
            // Áï´ÂéüÂúñ
            let offsetX = 0, offsetY = 0;
            tempCtx.drawImage(canvas, 0, 0);
            
            if (direction === 'vertical') {
                offsetY = canvas.height;
                mergeImages.forEach(img => {
                    tempCtx.drawImage(img, 0, offsetY);
                    offsetY += img.height;
                });
            } else {
                offsetX = canvas.width;
                mergeImages.forEach(img => {
                    tempCtx.drawImage(img, offsetX, 0);
                    offsetX += img.width;
                });
            }
            
            canvas.width = totalWidth;
            canvas.height = totalHeight;
            ctx.drawImage(tempCanvas, 0, 0);
            
            mergeImages = [];
            updateMergeList();
            updateCanvasInfo();
            setTimeout(updateZoomInfo, 50);
            showToast('üîó ÊãºÊé•ÂÆåÊàê');
        }
        
        // ===== QR Code =====
        let qrCanvas = null;
        
        function showQRPanel() {
            togglePanel('qrPanel', 'qrBtn');
        }
        
        // QR Á¢ºÁãÄÊÖã
        let qrPosition = 'bottom-right';
        let qrDragMode = false;
        let pendingQR = null;
        
        function setQRPosition(pos, btn) {
            qrPosition = pos;
            document.querySelectorAll('#qrPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function generateQR() {
            const content = document.getElementById('qrContent').value.trim();
            if (!content) {
                showToast('‚ö†Ô∏è Ë´ãËº∏ÂÖ•ÂÖßÂÆπ');
                return;
            }
            
            const size = parseInt(document.getElementById('qrSize').value);
            const fgColor = document.getElementById('qrFgColor').value;
            const bgColor = document.getElementById('qrBgColor').value;
            
            // ‰ΩøÁî®Â§ñÈÉ® API ÁîüÊàê QR Code
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(content)}&color=${fgColor.substring(1)}&bgcolor=${bgColor.substring(1)}`;
            
            const preview = document.getElementById('qrPreview');
            preview.innerHTML = `<img src="${qrUrl}" alt="QR Code" id="qrImage">`;
            
            showToast('üì± QR Code Â∑≤ÁîüÊàê');
        }
        
        function placeQR() {
            const qrImage = document.getElementById('qrImage');
            if (!qrImage) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÁîüÊàê QR Code');
                return;
            }
            
            const size = parseInt(document.getElementById('qrSize').value);
            
            // ‰ΩøÁî®‰πùÂÆÆÊ†º‰ΩçÁΩÆ‰ΩúÁÇ∫ÂàùÂßã‰ΩçÁΩÆ
            createDragObject('qr', qrImage.src, { size }, qrPosition);
        }
        
        function placeQRAt(clickX, clickY) {
            // ‰øùÁïôÁµ¶Ëàä‰ª£Á¢ºÂÖºÂÆπ
            const qrImage = document.getElementById('qrImage');
            if (!qrImage && !pendingQR) return;
            
            const size = parseInt(document.getElementById('qrSize').value);
            createDragObject('qr', pendingQR || qrImage.src, { size }, qrPosition);
            pendingQR = null;
            qrDragMode = false;
            canvas.style.cursor = 'default';
        }
        
        function cancelQRPlacement() {
            // ÂèñÊ∂à‰ªª‰ΩïÊãñÊõ≥‰∏≠ÁöÑÁâ©‰ª∂
            if (currentDragObject) {
                removeDragObject();
                showToast('‚ùå ÊîæÁΩÆÂ∑≤ÂèñÊ∂à');
            }
        }
        
        // ===== Â£ìÁ∏ÆÂäüËÉΩ =====
        function showCompressPanel() {
            togglePanel('compressPanel', 'compressBtn');
            updateCompressInfo();
            
            document.getElementById('compressQuality').oninput = function() {
                document.getElementById('qualityVal').textContent = this.value + '%';
            };
            
            document.getElementById('enableResize').onchange = function() {
                document.getElementById('resizeOptions').style.display = this.checked ? 'block' : 'none';
            };
        }
        
        function updateCompressInfo() {
            const dataUrl = canvas.toDataURL('image/png');
            const size = Math.round((dataUrl.length * 3/4) / 1024);
            document.getElementById('originalSize').textContent = size + ' KB';
        }
        
        function previewCompress() {
            const quality = parseInt(document.getElementById('compressQuality').value) / 100;
            const enableResize = document.getElementById('enableResize').checked;
            const resizePercent = enableResize ? parseInt(document.getElementById('resizePreset').value) / 100 : 1;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width * resizePercent;
            tempCanvas.height = canvas.height * resizePercent;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
            
            const compressed = tempCanvas.toDataURL('image/jpeg', quality);
            const newSize = Math.round((compressed.length * 3/4) / 1024);
            const originalSize = parseInt(document.getElementById('originalSize').textContent);
            const ratio = Math.round((1 - newSize / originalSize) * 100);
            
            document.getElementById('compressedSize').textContent = newSize + ' KB';
            document.getElementById('compressRatio').textContent = ratio + '% Ê∏õÂ∞ë';
            
            showToast('üëÅÔ∏è Â£ìÁ∏ÆÈ†êË¶ΩÂÆåÊàê');
        }
        
        function downloadCompressed() {
            const quality = parseInt(document.getElementById('compressQuality').value) / 100;
            const enableResize = document.getElementById('enableResize').checked;
            const resizePercent = enableResize ? parseInt(document.getElementById('resizePreset').value) / 100 : 1;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width * resizePercent;
            tempCanvas.height = canvas.height * resizePercent;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
            
            const link = document.createElement('a');
            link.download = `compressed-${Date.now()}.jpg`;
            link.href = tempCanvas.toDataURL('image/jpeg', quality);
            link.click();
            
            showToast('üíæ Â£ìÁ∏ÆÊ™îÂ∑≤‰∏ãËºâ');
        }
        
        // ===== ÁÆ≠È†≠Â∑•ÂÖ∑ =====
        let arrowStart = null;
        let arrowStyle = 'solid'; // solid, dashed, double
        let arrowLineWidth = 3;
        let arrowHeadStyle = 'filled'; // filled, outline, diamond
        
        function drawArrow(fromX, fromY, toX, toY) {
            saveHistory();
            const lineWidth = parseInt(document.getElementById('arrowWidth')?.value) || arrowLineWidth;
            const headLength = lineWidth * 5;
            const angle = Math.atan2(toY - fromY, toX - fromX);
            const color = document.getElementById('arrowColor')?.value || document.getElementById('textColor').value;
            const style = document.getElementById('arrowStyle')?.value || arrowStyle;
            const headType = document.getElementById('arrowHead')?.value || arrowHeadStyle;
            
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Áï´Á∑öÊ¢ù
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            
            if (style === 'dashed') {
                ctx.setLineDash([lineWidth * 3, lineWidth * 2]);
            } else if (style === 'dotted') {
                ctx.setLineDash([lineWidth, lineWidth * 2]);
            } else {
                ctx.setLineDash([]);
            }
            
            ctx.lineTo(toX, toY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Áï´ÁÆ≠È†≠
            if (headType === 'filled') {
                // ÂØ¶ÂøÉÁÆ≠È†≠
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(toX - headLength * Math.cos(angle - Math.PI / 6), toY - headLength * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(toX - headLength * Math.cos(angle + Math.PI / 6), toY - headLength * Math.sin(angle + Math.PI / 6));
                ctx.closePath();
                ctx.fill();
            } else if (headType === 'outline') {
                // Á©∫ÂøÉÁÆ≠È†≠
                ctx.beginPath();
                ctx.moveTo(toX - headLength * Math.cos(angle - Math.PI / 6), toY - headLength * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(toX, toY);
                ctx.lineTo(toX - headLength * Math.cos(angle + Math.PI / 6), toY - headLength * Math.sin(angle + Math.PI / 6));
                ctx.stroke();
            } else if (headType === 'diamond') {
                // Ëè±ÂΩ¢ÁÆ≠È†≠
                const midX = toX - headLength * 0.5 * Math.cos(angle);
                const midY = toY - headLength * 0.5 * Math.sin(angle);
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(toX - headLength * 0.7 * Math.cos(angle - Math.PI / 4), toY - headLength * 0.7 * Math.sin(angle - Math.PI / 4));
                ctx.lineTo(toX - headLength * Math.cos(angle), toY - headLength * Math.sin(angle));
                ctx.lineTo(toX - headLength * 0.7 * Math.cos(angle + Math.PI / 4), toY - headLength * 0.7 * Math.sin(angle + Math.PI / 4));
                ctx.closePath();
                ctx.fill();
            } else if (headType === 'double') {
                // ÈõôÂêëÁÆ≠È†≠
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(toX - headLength * Math.cos(angle - Math.PI / 6), toY - headLength * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(toX - headLength * Math.cos(angle + Math.PI / 6), toY - headLength * Math.sin(angle + Math.PI / 6));
                ctx.closePath();
                ctx.fill();
                // Ëµ∑ÈªûÁÆ≠È†≠
                const angle2 = angle + Math.PI;
                ctx.beginPath();
                ctx.moveTo(fromX, fromY);
                ctx.lineTo(fromX - headLength * Math.cos(angle2 - Math.PI / 6), fromY - headLength * Math.sin(angle2 - Math.PI / 6));
                ctx.lineTo(fromX - headLength * Math.cos(angle2 + Math.PI / 6), fromY - headLength * Math.sin(angle2 + Math.PI / 6));
                ctx.closePath();
                ctx.fill();
            } else if (headType === 'circle') {
                // ÂúìÂΩ¢ÁÆ≠È†≠
                ctx.beginPath();
                ctx.arc(toX, toY, lineWidth * 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function showArrowPanel() {
            const panel = document.getElementById('arrowPanel');
            const isShowing = panel.classList.contains('show');
            
            // Toggle: Â¶ÇÊûúÈù¢ÊùøÂ∑≤Èñã‰∏îÂ∑•ÂÖ∑ÁÇ∫ arrowÔºåÂâáÂèñÊ∂à
            if (isShowing && currentTool === 'arrow') {
                currentTool = null;
                document.getElementById('arrowBtn').classList.remove('active');
                canvas.style.cursor = 'default';
                showToast('üîì ÁÆ≠È†≠Â∑•ÂÖ∑Â∑≤ÂèñÊ∂à');
            }
            
            togglePanel('arrowPanel', 'arrowBtn');
        }
        
        function activateArrowTool() {
            setTool('arrow');
            showToast('‚û°Ô∏è ÊãñÊõ≥Áï´ÁÆ≠È†≠ÔºàÂÜçÈªûÁÆ≠È†≠ÊåâÈàïÂèØÂèñÊ∂àÔºâ');
        }
        
        function cancelArrowTool() {
            if (currentTool === 'arrow') {
                currentTool = null;
                document.getElementById('arrowBtn').classList.remove('active');
                canvas.style.cursor = 'default';
                showToast('‚ùå ÁÆ≠È†≠Â∑•ÂÖ∑Â∑≤ÂèñÊ∂à');
            }
            // ÈóúÈñâÈù¢Êùø
            const panel = document.getElementById('arrowPanel');
            if (panel.classList.contains('show')) {
                togglePanel('arrowPanel', 'arrowBtn');
            }
        }
        
        // ===== Áï´Á≠ÜÂ∑•ÂÖ∑ =====
        let currentBrush = 'pen';
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        
        // ===== Â•óÁ¥¢Â∑•ÂÖ∑ =====
        let lassoPoints = [];
        let isLassoing = false;
        
        function showBrushPanel() {
            const panel = document.getElementById('brushPanel');
            const isShowing = panel.classList.contains('show');
            
            // Toggle: Â¶ÇÊûúÈù¢ÊùøÂ∑≤Èñã‰∏îÂ∑•ÂÖ∑ÁÇ∫ brushÔºåÂâáÂèñÊ∂à
            if (isShowing && currentTool === 'brush') {
                currentTool = null;
                document.getElementById('brushBtn').classList.remove('active');
                canvas.style.cursor = 'default';
                showToast('üîì Áï´Á≠ÜÂ∑•ÂÖ∑Â∑≤ÂèñÊ∂à');
            } else if (!isShowing) {
                setTool('brush');
            }
            
            togglePanel('brushPanel', 'brushBtn');
        }
        
        function setBrushType(type) {
            currentBrush = type;
            document.querySelectorAll('.brush-type').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function setBrushColor(color) {
            document.getElementById('brushColor').value = color;
        }
        
        // ===== ÂΩ¢ÁãÄÂ∑•ÂÖ∑ =====
        let currentShape = 'rect';
        
        function showShapePanel() {
            const panel = document.getElementById('shapePanel');
            const isShowing = panel.classList.contains('show');
            
            // Toggle: Â¶ÇÊûúÈù¢ÊùøÂ∑≤Èñã‰∏îÂ∑•ÂÖ∑ÁÇ∫ shapeÔºåÂâáÂèñÊ∂à
            if (isShowing && currentTool === 'shape') {
                currentTool = null;
                document.getElementById('shapeBtn').classList.remove('active');
                canvas.style.cursor = 'default';
                showToast('üîì ÂΩ¢ÁãÄÂ∑•ÂÖ∑Â∑≤ÂèñÊ∂à');
            } else if (!isShowing) {
                setTool('shape');
            }
            
            togglePanel('shapePanel', 'shapeBtn');
        }
        
        function setShapeType(type) {
            currentShape = type;
            document.querySelectorAll('.shape-type').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function drawShape(x, y, w, h) {
            saveHistory();
            const strokeColor = document.getElementById('shapeStrokeColor').value;
            const fillColor = document.getElementById('shapeFillColor').value;
            const strokeWidth = document.getElementById('shapeStroke').value;
            const filled = document.getElementById('shapeFilled').checked;
            
            ctx.strokeStyle = strokeColor;
            ctx.fillStyle = fillColor;
            ctx.lineWidth = strokeWidth;
            
            ctx.beginPath();
            switch(currentShape) {
                case 'rect':
                    if (filled) ctx.fillRect(x, y, w, h);
                    ctx.strokeRect(x, y, w, h);
                    break;
                case 'circle':
                    const radius = Math.min(Math.abs(w), Math.abs(h)) / 2;
                    ctx.arc(x + w/2, y + h/2, radius, 0, Math.PI * 2);
                    break;
                case 'ellipse':
                    ctx.ellipse(x + w/2, y + h/2, Math.abs(w/2), Math.abs(h/2), 0, 0, Math.PI * 2);
                    break;
                case 'triangle':
                    ctx.moveTo(x + w/2, y);
                    ctx.lineTo(x + w, y + h);
                    ctx.lineTo(x, y + h);
                    ctx.closePath();
                    break;
                case 'star':
                    drawStar(ctx, x + w/2, y + h/2, 5, Math.min(w, h)/2, Math.min(w, h)/4);
                    break;
                case 'heart':
                    drawHeart(ctx, x, y, w, h);
                    break;
                case 'line':
                    ctx.moveTo(x, y);
                    ctx.lineTo(x + w, y + h);
                    ctx.stroke();
                    return;
            }
            if (filled && currentShape !== 'rect') ctx.fill();
            ctx.stroke();
        }
        
        function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let step = Math.PI / spikes;
            ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius);
                rot += step;
                ctx.lineTo(cx + Math.cos(rot) * innerRadius, cy + Math.sin(rot) * innerRadius);
                rot += step;
            }
            ctx.closePath();
        }
        
        function drawHeart(ctx, x, y, w, h) {
            ctx.moveTo(x + w/2, y + h/4);
            ctx.bezierCurveTo(x + w/2, y, x, y, x, y + h/4);
            ctx.bezierCurveTo(x, y + h/2, x + w/2, y + h*3/4, x + w/2, y + h);
            ctx.bezierCurveTo(x + w/2, y + h*3/4, x + w, y + h/2, x + w, y + h/4);
            ctx.bezierCurveTo(x + w, y, x + w/2, y, x + w/2, y + h/4);
        }
        
        // ===== ÊñáÂ≠óÁâπÊïà =====
        function showTextFxPanel() {
            togglePanel('textFxPanel', 'textFxBtn');
        }
        
        // ÊñáÂ≠óÁâπÊïàÁãÄÊÖã
        let textFxPosition = 'center';
        let textFxDragMode = false;
        let pendingTextFx = null;
        
        function setTextFxPosition(pos, btn) {
            textFxPosition = pos;
            document.querySelectorAll('#textFxPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function applyTextFx(style) {
            const text = document.getElementById('fxText').value.trim();
            if (!text) {
                showToast('‚ö†Ô∏è Ë´ãËº∏ÂÖ•ÊñáÂ≠ó');
                return;
            }
            
            const fontSize = parseInt(document.getElementById('fxFontSize').value);
            const color1 = document.getElementById('fxColor1').value;
            const color2 = document.getElementById('fxColor2').value;
            
            // ‰ΩøÁî®‰πùÂÆÆÊ†º‰ΩçÁΩÆ‰ΩúÁÇ∫ÂàùÂßã‰ΩçÁΩÆ
            createDragObject('textfx', text, { 
                style, 
                fontSize, 
                color1, 
                color2 
            }, textFxPosition);
        }
        
        function applyTextFxAt(style, text, clickX, clickY) {
            // ‰øùÁïôÁµ¶Ëàä‰ª£Á¢ºÂÖºÂÆπ
            const fontSize = parseInt(document.getElementById('fxFontSize').value);
            const color1 = document.getElementById('fxColor1').value;
            const color2 = document.getElementById('fxColor2').value;
            
            createDragObject('textfx', text, { 
                style, 
                fontSize, 
                color1, 
                color2 
            }, textFxPosition);
            
            pendingTextFx = null;
            textFxDragMode = false;
            canvas.style.cursor = 'default';
        }
        
        function cancelTextFxPlacement() {
            // ÂèñÊ∂à‰ªª‰ΩïÊãñÊõ≥‰∏≠ÁöÑÁâ©‰ª∂
            if (currentDragObject) {
                removeDragObject();
                showToast('‚ùå ÊîæÁΩÆÂ∑≤ÂèñÊ∂à');
            }
        }
        
        // ===== Ê®°ÊùøÂäüËÉΩ =====
        const templates = {
            social: [
                { name: 'IG Ë≤ºÊñá', w: 1080, h: 1080 },
                { name: 'IG ÈôêÂãï', w: 1080, h: 1920 },
                { name: 'FB Ë≤ºÊñá', w: 1200, h: 630 },
                { name: 'FB Â∞ÅÈù¢', w: 820, h: 312 },
                { name: 'Twitter', w: 1200, h: 675 },
                { name: 'YouTube', w: 1280, h: 720 }
            ],
            print: [
                { name: 'A4', w: 2480, h: 3508 },
                { name: 'A5', w: 1748, h: 2480 },
                { name: '4x6 Âêã', w: 1200, h: 1800 },
                { name: 'ÂêçÁâá', w: 1050, h: 600 },
                { name: 'Êµ∑Â†± A3', w: 3508, h: 4961 }
            ],
            web: [
                { name: 'Ê©´ÂπÖ', w: 1920, h: 600 },
                { name: 'ÈÉ®ËêΩÊ†º', w: 1200, h: 800 },
                { name: 'Á∏ÆÂúñ', w: 400, h: 300 },
                { name: 'ÂúñÁ§∫', w: 512, h: 512 },
                { name: 'Logo', w: 500, h: 200 }
            ],
            video: [
                { name: '1080p', w: 1920, h: 1080 },
                { name: '4K', w: 3840, h: 2160 },
                { name: '720p', w: 1280, h: 720 },
                { name: 'Áõ¥Âºè', w: 1080, h: 1920 }
            ]
        };
        
        function showTemplatePanel() {
            togglePanel('templatePanel', 'templateBtn');
            showTemplates('social');
        }
        
        function showTemplates(category) {
            document.querySelectorAll('.template-cat').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            
            const grid = document.getElementById('templateGrid');
            grid.innerHTML = '';
            
            templates[category].forEach(t => {
                const item = document.createElement('button');
                item.className = 'template-item';
                item.innerHTML = `${t.name}<br><small>${t.w}√ó${t.h}</small>`;
                item.onclick = () => createCanvas(t.w, t.h);
                grid.appendChild(item);
            });
        }
        
        function createCanvas(w, h) {
            saveHistory();
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = w;
            tempCanvas.height = h;
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, w, h);
            
            // Â¶ÇÊûúÊúâÁèæÊúâÂúñÁâáÔºåÂ±Ö‰∏≠ÊîæÁΩÆ
            if (canvas.width > 0) {
                const scale = Math.min(w / canvas.width, h / canvas.height);
                const newW = canvas.width * scale;
                const newH = canvas.height * scale;
                const x = (w - newW) / 2;
                const y = (h - newH) / 2;
                tempCtx.drawImage(canvas, x, y, newW, newH);
            }
            
            canvas.width = w;
            canvas.height = h;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('üìã Áï´Â∏ÉÂ∑≤Âª∫Á´ã ' + w + '√ó' + h);
        }
        
        function createCustomCanvas() {
            const w = parseInt(document.getElementById('customWidth').value) || 800;
            const h = parseInt(document.getElementById('customHeight').value) || 600;
            createCanvas(w, h);
        }
        
        // ===== ÊãºË≤ºÂäüËÉΩ =====
        let collageImages = [];
        let collageLayout = { count: 4, type: 'grid' };
        
        function showCollagePanel() {
            togglePanel('collagePanel', 'collageBtn');
        }
        
        function setCollageLayout(count, type) {
            collageLayout = { count, type };
            document.querySelectorAll('.collage-layout').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function addCollageImages(e) {
            const files = e.target.files;
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        collageImages.push(img);
                        updateCollagePreview();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function updateCollagePreview() {
            const container = document.getElementById('collageImages');
            container.innerHTML = '';
            collageImages.forEach((img, i) => {
                const thumb = document.createElement('img');
                thumb.className = 'collage-thumb';
                thumb.src = img.src;
                container.appendChild(thumb);
            });
        }
        
        function generateCollage() {
            if (collageImages.length === 0) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÊ∑ªÂä†ÁÖßÁâá');
                return;
            }
            
            saveHistory();
            const gap = parseInt(document.getElementById('collageGap').value);
            const radius = parseInt(document.getElementById('collageRadius').value);
            const bgColor = document.getElementById('collageBg').value;
            const { count, type } = collageLayout;
            
            let cols = 2, rows = 2;
            if (type === 'h') { cols = count; rows = 1; }
            else if (type === 'v') { cols = 1; rows = count; }
            else { cols = Math.ceil(Math.sqrt(count)); rows = Math.ceil(count / cols); }
            
            const cellW = 300, cellH = 300;
            const totalW = cols * cellW + (cols + 1) * gap;
            const totalH = rows * cellH + (rows + 1) * gap;
            
            canvas.width = totalW;
            canvas.height = totalH;
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, totalW, totalH);
            
            for (let i = 0; i < Math.min(count, collageImages.length); i++) {
                const col = i % cols;
                const row = Math.floor(i / cols);
                const x = gap + col * (cellW + gap);
                const y = gap + row * (cellH + gap);
                
                ctx.save();
                if (radius > 0) {
                    ctx.beginPath();
                    ctx.roundRect(x, y, cellW, cellH, radius);
                    ctx.clip();
                }
                
                const img = collageImages[i];
                const scale = Math.max(cellW / img.width, cellH / img.height);
                const drawW = img.width * scale;
                const drawH = img.height * scale;
                const drawX = x + (cellW - drawW) / 2;
                const drawY = y + (cellH - drawH) / 2;
                ctx.drawImage(img, drawX, drawY, drawW, drawH);
                ctx.restore();
            }
            
            collageImages = [];
            updateCollagePreview();
            showToast('üß© ÊãºË≤ºÂÆåÊàê');
        }
        
        // ===== ÁæéÈ°èÂäüËÉΩ =====
        function showBeautyPanel() {
            togglePanel('beautyPanel', 'beautyBtn');
            initBeautySliders();
        }
        
        function initBeautySliders() {
            ['Skin', 'White', 'Rosy', 'Sharp'].forEach(name => {
                const slider = document.getElementById('beauty' + name);
                const label = document.getElementById(name.toLowerCase() + 'Val');
                if (slider && label) {
                    slider.oninput = function() {
                        label.textContent = this.value;
                    };
                }
            });
        }
        
        function applyBeautyPreset(preset) {
            const presets = {
                natural: { skin: 20, white: 10, rosy: 15, sharp: 10 },
                soft: { skin: 40, white: 20, rosy: 10, sharp: 5 },
                bright: { skin: 30, white: 40, rosy: 5, sharp: 15 },
                glamour: { skin: 50, white: 30, rosy: 25, sharp: 20 }
            };
            const p = presets[preset];
            document.getElementById('beautySkin').value = p.skin;
            document.getElementById('beautyWhite').value = p.white;
            document.getElementById('beautyRosy').value = p.rosy;
            document.getElementById('beautySharp').value = p.sharp;
            document.getElementById('skinVal').textContent = p.skin;
            document.getElementById('whiteVal').textContent = p.white;
            document.getElementById('rosyVal').textContent = p.rosy;
            document.getElementById('sharpVal').textContent = p.sharp;
        }
        
        function applyBeauty() {
            saveHistory();
            const skin = parseInt(document.getElementById('beautySkin').value) / 100;
            const white = parseInt(document.getElementById('beautyWhite').value) / 100;
            const rosy = parseInt(document.getElementById('beautyRosy').value) / 100;
            
            // Á∞°ÂñÆÁæéÈ°èÊïàÊûú
            if (skin > 0) {
                ctx.filter = `blur(${skin * 2}px)`;
                ctx.globalAlpha = skin;
                ctx.drawImage(canvas, 0, 0);
                ctx.filter = 'none';
                ctx.globalAlpha = 1;
            }
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // ÁæéÁôΩ
                data[i] = Math.min(255, data[i] + white * 30);
                data[i+1] = Math.min(255, data[i+1] + white * 30);
                data[i+2] = Math.min(255, data[i+2] + white * 30);
                
                // Á¥ÖÊΩ§
                data[i] = Math.min(255, data[i] + rosy * 20);
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('‚ú® ÁæéÈ°èÂ∑≤Â•óÁî®');
        }
        
        // ===== ÂéªËÉåÂäüËÉΩ =====
        function showRemoveBgPanel() {
            togglePanel('removeBgPanel', 'removeBgBtn');
            
            document.getElementById('bgTolerance').oninput = function() {
                document.getElementById('toleranceVal').textContent = this.value;
            };
        }
        
        function removeBackground(type) {
            saveHistory();
            const tolerance = parseInt(document.getElementById('bgTolerance').value);
            
            let targetColor;
            if (type === 'white') targetColor = { r: 255, g: 255, b: 255 };
            else if (type === 'black') targetColor = { r: 0, g: 0, b: 0 };
            else if (type === 'green') targetColor = { r: 0, g: 255, b: 0 };
            else if (type === 'color') {
                document.getElementById('bgColorPick').style.display = 'block';
                const hex = document.getElementById('removeBgColor').value;
                targetColor = hexToRgb(hex);
            }
            
            if (!targetColor) return;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const diff = Math.abs(r - targetColor.r) + Math.abs(g - targetColor.g) + Math.abs(b - targetColor.b);
                
                if (diff < tolerance * 3) {
                    data[i+3] = 0; // ÈÄèÊòé
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üé≠ ËÉåÊôØÂ∑≤ÂéªÈô§');
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        function setNewBg(type) {
            const newColor = document.getElementById('newBgColor').value;
            
            if (type === 'color') {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                tempCtx.fillStyle = newColor;
                tempCtx.fillRect(0, 0, canvas.width, canvas.height);
                tempCtx.drawImage(canvas, 0, 0);
                ctx.drawImage(tempCanvas, 0, 0);
                showToast('üñºÔ∏è ËÉåÊôØÂ∑≤ÊõøÊèõ');
            }
        }
        
        // ===== ÊâπÊ¨°ËôïÁêÜ =====
        let batchImages = [];
        
        function showBatchPanel() {
            togglePanel('batchPanel', 'batchBtn');
        }
        
        function loadBatchImages(e) {
            batchImages = [];
            const files = e.target.files;
            const list = document.getElementById('batchList');
            list.innerHTML = '';
            
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        batchImages.push({ img, name: file.name });
                        const item = document.createElement('div');
                        item.className = 'batch-item';
                        item.innerHTML = `<img src="${event.target.result}"><span>${file.name}</span>`;
                        list.appendChild(item);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        async function executeBatch() {
            if (batchImages.length === 0) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÈÅ∏ÊìáÂúñÁâá');
                return;
            }
            
            showToast('üìö ÊâπÊ¨°ËôïÁêÜ‰∏≠...');
            
            for (let i = 0; i < batchImages.length; i++) {
                const { img, name } = batchImages[i];
                
                // Âª∫Á´ãËá®ÊôÇÁï´Â∏É
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = img.width;
                tempCanvas.height = img.height;
                tempCtx.drawImage(img, 0, 0);
                
                // Âü∑Ë°åÈÅ∏‰∏≠ÁöÑÊìç‰Ωú
                // TODO: Ê†πÊìöÂãæÈÅ∏ÁöÑÈÅ∏È†ÖÂü∑Ë°å
                
                // ‰∏ãËºâ
                const link = document.createElement('a');
                link.download = `batch-${i+1}-${name}`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
                
                await new Promise(r => setTimeout(r, 300));
            }
            
            showToast('‚úÖ ÊâπÊ¨°ËôïÁêÜÂÆåÊàê');
        }
        
        // ===== ÁâπÊïàÂäüËÉΩ =====
        function showEffectPanel() {
            togglePanel('effectPanel', 'effectBtn');
        }
        
        function showEffectCategory(cat) {
            // Êõ¥Êñ∞ÂàÜÈ°ûÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.effect-cat').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // È°ØÁ§∫/Èö±ËóèÊïàÊûúÊåâÈàï
            document.querySelectorAll('#effectGrid .effect-item').forEach(item => {
                if (cat === 'all' || item.dataset.cat === cat) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function applyEffect(effect) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            switch(effect) {
                case 'emboss':
                    applyConvolution(imageData, [-2, -1, 0, -1, 1, 1, 0, 1, 2]);
                    break;
                case 'edge':
                    applyConvolution(imageData, [-1, -1, -1, -1, 8, -1, -1, -1, -1]);
                    break;
                case 'posterize':
                    const levels = 4;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.floor(data[i] / (256/levels)) * (256/levels);
                        data[i+1] = Math.floor(data[i+1] / (256/levels)) * (256/levels);
                        data[i+2] = Math.floor(data[i+2] / (256/levels)) * (256/levels);
                    }
                    break;
                case 'solarize':
                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i] > 128) data[i] = 255 - data[i];
                        if (data[i+1] > 128) data[i+1] = 255 - data[i+1];
                        if (data[i+2] > 128) data[i+2] = 255 - data[i+2];
                    }
                    break;
                case 'thermal':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        if (avg < 64) { data[i] = 0; data[i+1] = 0; data[i+2] = avg * 4; }
                        else if (avg < 128) { data[i] = 0; data[i+1] = (avg-64)*4; data[i+2] = 255; }
                        else if (avg < 192) { data[i] = (avg-128)*4; data[i+1] = 255; data[i+2] = 255-(avg-128)*4; }
                        else { data[i] = 255; data[i+1] = 255-(avg-192)*4; data[i+2] = 0; }
                    }
                    break;
                case 'xray':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = data[i+1] = data[i+2] = 255 - avg;
                        data[i+2] = Math.min(255, data[i+2] + 50);
                    }
                    break;
                case 'night':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = 0;
                        data[i+1] = Math.min(255, avg * 1.5);
                        data[i+2] = 0;
                    }
                    break;
                case 'comic':
                    applyConvolution(imageData, [0, -1, 0, -1, 5, -1, 0, -1, 0]);
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.floor(data[i] / 64) * 64;
                        data[i+1] = Math.floor(data[i+1] / 64) * 64;
                        data[i+2] = Math.floor(data[i+2] / 64) * 64;
                    }
                    break;
                case 'pop':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = data[i] > 128 ? 255 : 0;
                        data[i+1] = data[i+1] > 128 ? 255 : 0;
                        data[i+2] = data[i+2] > 128 ? 255 : 0;
                    }
                    break;
                case 'halftone':
                case 'dotscreen':
                case 'crosshatch':
                    // Á∞°ÂåñÁâà
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        const threshold = ((i / 4) % canvas.width + Math.floor((i / 4) / canvas.width)) % 8 * 32;
                        const val = avg > threshold ? 255 : 0;
                        data[i] = data[i+1] = data[i+2] = val;
                    }
                    break;
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üí´ ÁâπÊïàÂ∑≤Â•óÁî®');
        }
        
        function applyConvolution(imageData, kernel) {
            const data = imageData.data;
            const w = imageData.width;
            const h = imageData.height;
            const output = new Uint8ClampedArray(data);
            
            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    const idx = (y * w + x) * 4;
                    for (let c = 0; c < 3; c++) {
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const kidx = ((y + ky) * w + (x + kx)) * 4 + c;
                                sum += data[kidx] * kernel[(ky + 1) * 3 + (kx + 1)];
                            }
                        }
                        output[idx + c] = Math.min(255, Math.max(0, sum + 128));
                    }
                }
            }
            
            for (let i = 0; i < data.length; i++) {
                data[i] = output[i];
            }
        }
        
        // ===== ÁñäÂä†ÂäüËÉΩ =====
        function showOverlayPanel() {
            togglePanel('overlayPanel', 'overlayBtn');
        }
        
        // ===== ÊâπË®ªÂäüËÉΩ =====
        let annotateTool = 'highlight';
        let annotateNumber = 1;
        
        function showAnnotatePanel() {
            togglePanel('annotatePanel', 'annotateBtn');
            setTool('annotate');
        }
        
        function setAnnotateTool(tool) {
            annotateTool = tool;
            document.querySelectorAll('.annotate-tool').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        // ===== Ê≠∑Âè≤Ë®òÈåÑÈù¢Êùø =====
        function showHistoryPanel() {
            togglePanel('historyPanel', 'historyBtn');
            updateHistoryList();
        }
        
        function updateHistoryList() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            historyStack.forEach((state, i) => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 40;
                tempCanvas.height = 40;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(createImageFromData(state.data, state.width, state.height), 0, 0, 40, 40);
                
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<img src="${tempCanvas.toDataURL()}"><span>Ê≠•È©ü ${i + 1}</span>`;
                item.onclick = () => restoreHistory(i);
                list.appendChild(item);
            });
        }
        
        function createImageFromData(imageData, w, h) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = w;
            tempCanvas.height = h;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.putImageData(imageData, 0, 0);
            return tempCanvas;
        }
        
        function restoreHistory(index) {
            const state = historyStack[index];
            canvas.width = state.width;
            canvas.height = state.height;
            ctx.putImageData(state.data, 0, 0);
            showToast('üìú Â∑≤ÈÇÑÂéüÂà∞Ê≠•È©ü ' + (index + 1));
        }
        
        function clearHistory() {
            historyStack = [historyStack[historyStack.length - 1]];
            updateHistoryList();
            showToast('üóëÔ∏è Ê≠∑Âè≤Â∑≤Ê∏ÖÈô§');
        }
        
        // ===== ÂúñÁâáË≥áË®ä =====
        function showInfoPanel() {
            togglePanel('infoPanel', 'infoBtn');
            updateImageInfo();
        }
        
        function updateImageInfo() {
            const content = document.getElementById('infoContent');
            if (!content) return;
            
            const dataUrl = canvas.toDataURL('image/png');
            const size = Math.round((dataUrl.length * 3/4) / 1024);
            
            content.innerHTML = `
                <div class="info-row"><span>ÂØ¨Â∫¶</span><span>${canvas.width} px</span></div>
                <div class="info-row"><span>È´òÂ∫¶</span><span>${canvas.height} px</span></div>
                <div class="info-row"><span>ÊØî‰æã</span><span>${(canvas.width/canvas.height).toFixed(2)}</span></div>
                <div class="info-row"><span>ÂÉèÁ¥†Êï∏</span><span>${(canvas.width * canvas.height / 1000000).toFixed(2)} MP</span></div>
                <div class="info-row"><span>È†ê‰º∞Â§ßÂ∞è</span><span>${size} KB</span></div>
            `;
        }
        
        // ===== È°èËâ≤ÊõøÊèõ =====
        function showColorReplacePanel() {
            togglePanel('colorReplacePanel', 'colorReplaceBtn');
            
            document.getElementById('replaceTolerance').oninput = function() {
                document.getElementById('replaceToleranceVal').textContent = this.value;
            };
        }
        
        function pickBgColor() {
            showToast('üí° ÈªûÊìäÁï´Â∏ÉÈÅ∏ÂèñËÉåÊôØÈ°èËâ≤');
            eyedropperTarget = 'bgColor';
            canvas.style.cursor = 'crosshair';
        }
        
        function pickReplaceColor() {
            showToast('üí° ÈªûÊìäÁï´Â∏ÉÈÅ∏ÂèñË¶ÅÊõøÊèõÁöÑÈ°èËâ≤');
            eyedropperTarget = 'replaceFrom';
            canvas.style.cursor = 'crosshair';
        }
        
        function showOverlayType(type) {
            // È°ØÁ§∫‰∏çÂêåÈ°ûÂûãÁöÑÁñäÂä†ÈÅ∏È†Ö
            const panels = ['overlayImage', 'overlayGradient', 'overlayPattern'];
            panels.forEach(p => {
                const el = document.getElementById(p);
                if (el) el.style.display = 'none';
            });
            const target = document.getElementById('overlay' + type.charAt(0).toUpperCase() + type.slice(1));
            if (target) target.style.display = 'block';
        }
        
        function replaceColor() {
            saveHistory();
            const fromHex = document.getElementById('replaceFrom').value;
            const toHex = document.getElementById('replaceTo').value;
            const tolerance = parseInt(document.getElementById('replaceTolerance').value);
            
            const fromRgb = hexToRgb(fromHex);
            const toRgb = hexToRgb(toHex);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const diff = Math.abs(data[i] - fromRgb.r) + Math.abs(data[i+1] - fromRgb.g) + Math.abs(data[i+2] - fromRgb.b);
                
                if (diff < tolerance * 3) {
                    data[i] = toRgb.r;
                    data[i+1] = toRgb.g;
                    data[i+2] = toRgb.b;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üé® È°èËâ≤Â∑≤ÊõøÊèõ');
        }
        
        // ===== Ë≠â‰ª∂ÁÖß =====
        const idSizes = {
            '1inch': { w: 295, h: 413 },
            '2inch': { w: 413, h: 531 },
            'passport': { w: 413, h: 531 },
            'visa': { w: 390, h: 567 },
            'license': { w: 260, h: 354 }
        };
        let currentIdSize = '2inch';
        
        function showIdPhotoPanel() {
            togglePanel('idPhotoPanel', 'idPhotoBtn');
        }
        
        function setIdSize(size) {
            currentIdSize = size;
            document.querySelectorAll('.id-size').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function generateIdPhoto() {
            saveHistory();
            const size = idSizes[currentIdSize];
            const bgColor = document.getElementById('idBgColor').value;
            const count = parseInt(document.getElementById('idCount').value);
            
            // Âª∫Á´ãÂñÆÂºµË≠â‰ª∂ÁÖß
            const singleCanvas = document.createElement('canvas');
            singleCanvas.width = size.w;
            singleCanvas.height = size.h;
            const singleCtx = singleCanvas.getContext('2d');
            singleCtx.fillStyle = bgColor;
            singleCtx.fillRect(0, 0, size.w, size.h);
            
            // Á∏ÆÊîæ‰∏¶Â±Ö‰∏≠ÂéüÂúñ
            const scale = Math.max(size.w / canvas.width, size.h / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const x = (size.w - newW) / 2;
            const y = (size.h - newH) / 2;
            singleCtx.drawImage(canvas, x, y, newW, newH);
            
            // ÊéíÁâà
            const cols = count === 1 ? 1 : 4;
            const rows = Math.ceil(count / cols);
            const gap = 10;
            const totalW = cols * size.w + (cols + 1) * gap;
            const totalH = rows * size.h + (rows + 1) * gap;
            
            canvas.width = totalW;
            canvas.height = totalH;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, totalW, totalH);
            
            for (let i = 0; i < count; i++) {
                const col = i % cols;
                const row = Math.floor(i / cols);
                ctx.drawImage(singleCanvas, gap + col * (size.w + gap), gap + row * (size.h + gap));
            }
            
            showToast('ü™™ Ë≠â‰ª∂ÁÖßÂ∑≤Áî¢Áîü');
        }
        
        // ===== Êà™ÂúñÁæéÂåñ =====
        function showScreenshotPanel() {
            togglePanel('screenshotPanel', 'screenshotBtn');
        }
        
        function addDeviceFrame(device) {
            saveHistory();
            const bgType = document.getElementById('screenshotBg').value;
            const shadow = document.getElementById('screenshotShadow').checked;
            
            const padding = 60;
            const frameW = canvas.width + padding * 2;
            const frameH = canvas.height + padding * 2 + 40;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = frameW;
            tempCanvas.height = frameH;
            const tempCtx = tempCanvas.getContext('2d');
            
            // ËÉåÊôØÊº∏Â±§
            const gradients = {
                gradient1: ['#667eea', '#764ba2'],
                gradient2: ['#4facfe', '#00f2fe'],
                gradient3: ['#fa709a', '#fee140']
            };
            const colors = gradients[bgType] || ['#667eea', '#764ba2'];
            const gradient = tempCtx.createLinearGradient(0, 0, frameW, frameH);
            gradient.addColorStop(0, colors[0]);
            gradient.addColorStop(1, colors[1]);
            tempCtx.fillStyle = gradient;
            tempCtx.fillRect(0, 0, frameW, frameH);
            
            // Ë£ùÁΩÆÊ°Ü
            if (shadow) {
                tempCtx.shadowColor = 'rgba(0,0,0,0.3)';
                tempCtx.shadowBlur = 30;
                tempCtx.shadowOffsetY = 15;
            }
            
            tempCtx.fillStyle = '#1a1a1a';
            tempCtx.beginPath();
            tempCtx.roundRect(padding - 10, padding - 30, canvas.width + 20, canvas.height + 50, 20);
            tempCtx.fill();
            
            tempCtx.shadowColor = 'transparent';
            
            // Ëû¢Âπï
            tempCtx.drawImage(canvas, padding, padding);
            
            // Ë£ùÁΩÆÊ®ôË≠ò
            tempCtx.fillStyle = '#333';
            tempCtx.fillRect(padding + canvas.width/2 - 30, padding - 20, 60, 8);
            
            canvas.width = frameW;
            canvas.height = frameH;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('üì≤ Êà™ÂúñÁæéÂåñÂÆåÊàê');
        }
        
        // ===== ÂÉèÁ¥†Áï´ =====
        function showPixelArtPanel() {
            togglePanel('pixelArtPanel', 'pixelArtBtn');
            
            document.getElementById('pixelSize').oninput = function() {
                document.getElementById('pixelSizeVal').textContent = this.value;
            };
        }
        
        function applyPixelArt(size) {
            saveHistory();
            size = size || parseInt(document.getElementById('pixelSize').value);
            
            const w = canvas.width;
            const h = canvas.height;
            
            // Á∏ÆÂ∞è
            const smallCanvas = document.createElement('canvas');
            smallCanvas.width = Math.floor(w / size);
            smallCanvas.height = Math.floor(h / size);
            const smallCtx = smallCanvas.getContext('2d');
            smallCtx.imageSmoothingEnabled = false;
            smallCtx.drawImage(canvas, 0, 0, smallCanvas.width, smallCanvas.height);
            
            // ÊîæÂ§ßÂõû‰æÜ
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(smallCanvas, 0, 0, w, h);
            ctx.imageSmoothingEnabled = true;
            
            showToast('üëæ ÂÉèÁ¥†ÂåñÂÆåÊàê');
        }
        
        // ===== ASCII ËóùË°ì =====
        function showAsciiPanel() {
            togglePanel('asciiPanel', 'asciiBtn');
        }
        
        function generateAscii() {
            const density = parseInt(document.getElementById('asciiDensity').value);
            const charsets = {
                standard: '@#%*+=-:. ',
                blocks: '‚ñà‚ñì‚ñí‚ñë ',
                numbers: '9876543210 '
            };
            const charset = charsets[document.getElementById('asciiCharset').value] || charsets.standard;
            
            const step = 12 - density;
            let ascii = '';
            
            for (let y = 0; y < canvas.height; y += step * 2) {
                for (let x = 0; x < canvas.width; x += step) {
                    const pixel = ctx.getImageData(x, y, 1, 1).data;
                    const brightness = (pixel[0] + pixel[1] + pixel[2]) / 3;
                    const charIndex = Math.floor((brightness / 255) * (charset.length - 1));
                    ascii += charset[charIndex];
                }
                ascii += '\n';
            }
            
            document.getElementById('asciiOutput').value = ascii;
            showToast('üíª ASCII ËóùË°ìÂ∑≤ÁîüÊàê');
        }
        
        function copyAscii() {
            const ascii = document.getElementById('asciiOutput').value;
            navigator.clipboard.writeText(ascii).then(() => {
                showToast('üìã Â∑≤Ë§áË£Ω');
            });
        }
        
        function asciiToImage() {
            saveHistory();
            const ascii = document.getElementById('asciiOutput').value;
            const lines = ascii.split('\n');
            
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00ff00';
            ctx.font = '8px monospace';
            
            lines.forEach((line, i) => {
                ctx.fillText(line, 0, i * 8 + 8);
            });
            
            showToast('üñºÔ∏è Â∑≤ËΩâÊèõÁÇ∫ÂúñÁâá');
        }
        
        // ===== ÈõôËâ≤Ë™ø =====
        function showDuotonePanel() {
            togglePanel('duotonePanel', 'duotoneBtn');
        }
        
        function applyDuotone(dark, light) {
            saveHistory();
            const darkRgb = hexToRgb(dark);
            const lightRgb = hexToRgb(light);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const brightness = (data[i] + data[i+1] + data[i+2]) / 3 / 255;
                data[i] = darkRgb.r + (lightRgb.r - darkRgb.r) * brightness;
                data[i+1] = darkRgb.g + (lightRgb.g - darkRgb.g) * brightness;
                data[i+2] = darkRgb.b + (lightRgb.b - darkRgb.b) * brightness;
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üé≠ ÈõôËâ≤Ë™øÂ∑≤Â•óÁî®');
        }
        
        function applyDuotoneCustom() {
            const dark = document.getElementById('duotoneDark').value;
            const light = document.getElementById('duotoneLight').value;
            applyDuotone(dark, light);
        }
        
        // ===== Êº∏Â±§ÁñäÂä† =====
        function showGradientPanel() {
            togglePanel('gradientPanel', 'gradientBtn');
            
            document.getElementById('gradientAngle').oninput = function() {
                document.getElementById('gradientAngleVal').textContent = this.value + '¬∞';
            };
        }
        
        function applyGradientOverlay(color1, color2) {
            saveHistory();
            const angle = parseInt(document.getElementById('gradientAngle')?.value || 135);
            const opacity = parseFloat(document.getElementById('gradientOpacity')?.value || 0.5);
            
            const radians = angle * Math.PI / 180;
            const x1 = canvas.width/2 - Math.cos(radians) * canvas.width;
            const y1 = canvas.height/2 - Math.sin(radians) * canvas.height;
            const x2 = canvas.width/2 + Math.cos(radians) * canvas.width;
            const y2 = canvas.height/2 + Math.sin(radians) * canvas.height;
            
            const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            
            ctx.globalAlpha = opacity;
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = 1;
            
            showToast('üåÖ Êº∏Â±§Â∑≤ÁñäÂä†');
        }
        
        // ===== ÈõúË®ä =====
        function showNoisePanel() {
            togglePanel('noisePanel', 'noiseBtn');
            
            document.getElementById('noiseAmount').oninput = function() {
                document.getElementById('noiseAmountVal').textContent = this.value;
            };
        }
        
        function applyNoise() {
            saveHistory();
            const amount = parseInt(document.getElementById('noiseAmount').value);
            const isColor = document.getElementById('noiseColor').checked;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const noise = (Math.random() - 0.5) * amount * 2.55;
                if (isColor) {
                    data[i] = Math.min(255, Math.max(0, data[i] + (Math.random() - 0.5) * amount * 2.55));
                    data[i+1] = Math.min(255, Math.max(0, data[i+1] + (Math.random() - 0.5) * amount * 2.55));
                    data[i+2] = Math.min(255, Math.max(0, data[i+2] + (Math.random() - 0.5) * amount * 2.55));
                } else {
                    data[i] = Math.min(255, Math.max(0, data[i] + noise));
                    data[i+1] = Math.min(255, Math.max(0, data[i+1] + noise));
                    data[i+2] = Math.min(255, Math.max(0, data[i+2] + noise));
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üìª ÈõúË®äÂ∑≤Ê∑ªÂä†');
        }
        
        // ===== ÊôØÊ∑±Ê®°Á≥ä =====
        function showBlurBgPanel() {
            togglePanel('blurBgPanel', 'blurBgBtn');
            
            document.getElementById('blurAmount').oninput = function() {
                document.getElementById('blurAmountVal').textContent = this.value;
            };
        }
        
        function applySelectiveBlur() {
            if (!currentSelection) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÈÅ∏ÂèñË¶Å‰øùÊåÅÊ∏ÖÊô∞ÁöÑÂçÄÂüü');
                return;
            }
            
            saveHistory();
            const blurAmount = document.getElementById('blurAmount').value;
            const { x, y, w, h } = currentSelection;
            
            // ÂÑ≤Â≠òÈÅ∏ÂèñÂçÄÂüü
            const selectedArea = ctx.getImageData(x, y, w, h);
            
            // Ê®°Á≥äÊï¥ÂºµÂúñ
            ctx.filter = `blur(${blurAmount}px)`;
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'none';
            
            // ÈÇÑÂéüÈÅ∏ÂèñÂçÄÂüü
            ctx.putImageData(selectedArea, x, y);
            
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            
            showToast('üå´Ô∏è ÊôØÊ∑±ÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        // ===== Á¥ãÁêÜ =====
        function showTexturePanel() {
            togglePanel('texturePanel', 'textureBtn');
        }
        
        function applyTexture(type) {
            saveHistory();
            const amount = parseFloat(document.getElementById('textureAmount')?.value || 0.3);
            
            // Âª∫Á´ãÁ¥ãÁêÜ
            const textureCanvas = document.createElement('canvas');
            textureCanvas.width = canvas.width;
            textureCanvas.height = canvas.height;
            const textureCtx = textureCanvas.getContext('2d');
            
            // Á∞°ÂñÆÁ¥ãÁêÜÊ®°Êì¨
            const imageData = textureCtx.createImageData(canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const noise = Math.random() * 255;
                data[i] = data[i+1] = data[i+2] = noise;
                data[i+3] = 255;
            }
            
            textureCtx.putImageData(imageData, 0, 0);
            
            ctx.globalAlpha = amount;
            ctx.globalCompositeOperation = 'overlay';
            ctx.drawImage(textureCanvas, 0, 0);
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
            
            showToast('üß± Á¥ãÁêÜÂ∑≤ÁñäÂä†');
        }
        
        // ===== Êï£ÊôØ =====
        function showBokehPanel() {
            togglePanel('bokehPanel', 'bokehBtn');
        }
        
        function addBokeh() {
            saveHistory();
            const count = parseInt(document.getElementById('bokehCount').value);
            const size = parseInt(document.getElementById('bokehSize').value);
            const colorType = document.getElementById('bokehColor').value;
            
            const colors = {
                warm: ['#ff9a9e', '#fecfef', '#ffecd2', '#fcb69f'],
                cool: ['#a1c4fd', '#c2e9fb', '#d4fc79', '#96e6a1'],
                rainbow: ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#8b00ff'],
                gold: ['#ffd700', '#ffec8b', '#fff8dc', '#ffefd5']
            };
            const palette = colors[colorType] || colors.warm;
            
            for (let i = 0; i < count; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const r = Math.random() * size + 10;
                const color = palette[Math.floor(Math.random() * palette.length)];
                
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.globalAlpha = Math.random() * 0.3 + 0.1;
                ctx.fill();
            }
            ctx.globalAlpha = 1;
            
            showToast('üí° Êï£ÊôØÂ∑≤Ê∑ªÂä†');
        }
        
        // ===== Èè°ÂÉè =====
        function showMirrorPanel() {
            togglePanel('mirrorPanel', 'mirrorBtn');
        }
        
        function applyMirror(type) {
            saveHistory();
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            switch(type) {
                case 'left':
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height, 0, 0, canvas.width/2, canvas.height);
                    tempCtx.save();
                    tempCtx.translate(canvas.width, 0);
                    tempCtx.scale(-1, 1);
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height, 0, 0, canvas.width/2, canvas.height);
                    tempCtx.restore();
                    break;
                case 'right':
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    tempCtx.drawImage(canvas, canvas.width/2, 0, canvas.width/2, canvas.height, canvas.width/2, 0, canvas.width/2, canvas.height);
                    tempCtx.save();
                    tempCtx.translate(0, 0);
                    tempCtx.scale(-1, 1);
                    tempCtx.drawImage(canvas, canvas.width/2, 0, canvas.width/2, canvas.height, -canvas.width/2, 0, canvas.width/2, canvas.height);
                    tempCtx.restore();
                    break;
                case 'quad':
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    // Â∑¶‰∏ä
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height/2, 0, 0, canvas.width/2, canvas.height/2);
                    // Âè≥‰∏ä (Ê∞¥Âπ≥ÁøªËΩâ)
                    tempCtx.save();
                    tempCtx.translate(canvas.width, 0);
                    tempCtx.scale(-1, 1);
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height/2, 0, 0, canvas.width/2, canvas.height/2);
                    tempCtx.restore();
                    // Â∑¶‰∏ã (ÂûÇÁõ¥ÁøªËΩâ)
                    tempCtx.save();
                    tempCtx.translate(0, canvas.height);
                    tempCtx.scale(1, -1);
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height/2, 0, 0, canvas.width/2, canvas.height/2);
                    tempCtx.restore();
                    // Âè≥‰∏ã (ÈõôÁøªËΩâ)
                    tempCtx.save();
                    tempCtx.translate(canvas.width, canvas.height);
                    tempCtx.scale(-1, -1);
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height/2, 0, 0, canvas.width/2, canvas.height/2);
                    tempCtx.restore();
                    break;
                default:
                    return;
            }
            
            ctx.drawImage(tempCanvas, 0, 0);
            showToast('ü™û Èè°ÂÉèÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        // ===== ÂàÜÂâ≤ =====
        function showSplitPanel() {
            togglePanel('splitPanel', 'splitBtn');
        }
        
        function setSplit(rows, cols) {
            document.getElementById('splitRows').value = rows;
            document.getElementById('splitCols').value = cols;
        }
        
        async function splitImage() {
            const rows = parseInt(document.getElementById('splitRows').value);
            const cols = parseInt(document.getElementById('splitCols').value);
            
            const cellW = Math.floor(canvas.width / cols);
            const cellH = Math.floor(canvas.height / rows);
            
            showToast('üî≤ ÂàÜÂâ≤‰∏≠...');
            
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = cellW;
                    tempCanvas.height = cellH;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(canvas, c * cellW, r * cellH, cellW, cellH, 0, 0, cellW, cellH);
                    
                    const link = document.createElement('a');
                    link.download = `split-${r+1}-${c+1}.png`;
                    link.href = tempCanvas.toDataURL('image/png');
                    link.click();
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            showToast('‚úÖ ÂàÜÂâ≤ÂÆåÊàêÔºåÂÖ± ' + (rows * cols) + ' Âºµ');
        }
        
        // ===== Á§æÁæ§Â™íÈ´îÂ∞∫ÂØ∏ =====
        function showSocialPanel() {
            togglePanel('socialPanel', 'socialBtn');
        }
        
        const socialSizes = {
            'ig-post': { w: 1080, h: 1080 },
            'ig-story': { w: 1080, h: 1920 },
            'ig-reel': { w: 1080, h: 1920 },
            'fb-post': { w: 1200, h: 630 },
            'fb-cover': { w: 820, h: 312 },
            'fb-story': { w: 1080, h: 1920 },
            'tw-post': { w: 1200, h: 675 },
            'tw-header': { w: 1500, h: 500 },
            'yt-thumb': { w: 1280, h: 720 },
            'yt-banner': { w: 2560, h: 1440 },
            'li-post': { w: 1200, h: 627 },
            'li-cover': { w: 1584, h: 396 }
        };
        
        function resizeForSocial(platform) {
            const size = socialSizes[platform];
            if (!size) return;
            
            saveHistory();
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = size.w;
            tempCanvas.height = size.h;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, size.w, size.h);
            
            // Á≠âÊØî‰æãÁ∏ÆÊîæÂ±Ö‰∏≠
            const scale = Math.min(size.w / canvas.width, size.h / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const x = (size.w - newW) / 2;
            const y = (size.h - newH) / 2;
            tempCtx.drawImage(canvas, x, y, newW, newH);
            
            canvas.width = size.w;
            canvas.height = size.h;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('üì± Â∑≤Ë™øÊï¥ÁÇ∫ ' + size.w + '√ó' + size.h);
        }
        
        // ===== ÈÄ≤ÈöéÂåØÂá∫ =====
        function showExportPanel() {
            togglePanel('exportPanel', 'exportBtn');
            
            document.getElementById('exportQuality').oninput = function() {
                document.getElementById('exportQualityVal').textContent = Math.round(this.value * 100) + '%';
            };
            
            document.getElementById('exportFormat').onchange = function() {
                document.getElementById('jpegQualityOption').style.display = 
                    (this.value === 'jpeg' || this.value === 'webp') ? 'block' : 'none';
            };
        }
        
        function advancedExport() {
            const format = document.getElementById('exportFormat').value;
            const quality = parseFloat(document.getElementById('exportQuality').value);
            const scale = parseFloat(document.getElementById('exportScale').value);
            const filename = document.getElementById('exportFilename').value || 'image-magic';
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width * scale;
            tempCanvas.height = canvas.height * scale;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
            
            let mimeType = 'image/png';
            if (format === 'jpeg') mimeType = 'image/jpeg';
            else if (format === 'webp') mimeType = 'image/webp';
            else if (format === 'gif') mimeType = 'image/gif';
            else if (format === 'bmp') mimeType = 'image/bmp';
            
            const link = document.createElement('a');
            link.download = `${filename}.${format}`;
            link.href = tempCanvas.toDataURL(mimeType, quality);
            link.click();
            
            showToast('üíæ Â∑≤‰∏ãËºâ ' + filename + '.' + format);
        }
        
        // ===== ËóùË°ìÊïàÊûúÂø´Êç∑ÂäüËÉΩ =====
        function applyCartoon() {
            saveHistory();
            // Á∞°ÂåñËâ≤ÂΩ© + ÈÇäÁ∑£Âº∑Âåñ
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.floor(data[i] / 40) * 40;
                data[i+1] = Math.floor(data[i+1] / 40) * 40;
                data[i+2] = Math.floor(data[i+2] / 40) * 40;
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üé® Âç°ÈÄöÂåñÂÆåÊàê');
        }
        
        function applySketch() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // ÁÅ∞Èöé
            for (let i = 0; i < imageData.data.length; i += 4) {
                const avg = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
                imageData.data[i] = imageData.data[i+1] = imageData.data[i+2] = avg;
            }
            
            // ÂèçËΩâ‰∏¶ÁñäÂä†
            applyConvolution(imageData, [-1, -1, -1, -1, 9, -1, -1, -1, -1]);
            ctx.putImageData(imageData, 0, 0);
            
            showToast('‚úèÔ∏è Á¥†ÊèèÊïàÊûúÂÆåÊàê');
        }
        
        function applyOilPaint() {
            saveHistory();
            // Á∞°ÂåñÁöÑÊ≤πÁï´ÊïàÊûú
            ctx.filter = 'blur(2px)';
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'contrast(1.5) saturate(1.5)';
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'none';
            
            showToast('üñºÔ∏è Ê≤πÁï´ÊïàÊûúÂÆåÊàê');
        }
        
        function applyGlitch() {
            saveHistory();
            const sliceHeight = 10;
            const slices = Math.floor(canvas.height / sliceHeight);
            
            for (let i = 0; i < slices; i++) {
                if (Math.random() > 0.7) {
                    const y = i * sliceHeight;
                    const offset = (Math.random() - 0.5) * 30;
                    const slice = ctx.getImageData(0, y, canvas.width, sliceHeight);
                    ctx.putImageData(slice, offset, y);
                }
            }
            
            // RGB ÂÅèÁßª
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                if (i + 20 < data.length) {
                    data[i] = data[i + 20]; // R ÂÅèÁßª
                }
                if (i - 20 >= 0) {
                    data[i + 2] = data[i - 18]; // B ÂÅèÁßª
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üì∫ ÊïÖÈöúÊïàÊûúÂÆåÊàê');
        }
        
        function applyVignette() {
            saveHistory();
            const gradient = ctx.createRadialGradient(
                canvas.width/2, canvas.height/2, canvas.width * 0.3,
                canvas.width/2, canvas.height/2, canvas.width * 0.7
            );
            gradient.addColorStop(0, 'transparent');
            gradient.addColorStop(1, 'rgba(0,0,0,0.7)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            showToast('üîò ÊöàÂΩ±ÊïàÊûúÂÆåÊàê');
        }
        
        function applyLightLeak() {
            saveHistory();
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, 'rgba(255,200,100,0.3)');
            gradient.addColorStop(0.5, 'transparent');
            gradient.addColorStop(1, 'rgba(255,100,150,0.2)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            showToast('‚òÄÔ∏è ÊºèÂÖâÊïàÊûúÂÆåÊàê');
        }
        
        function applyTiltShift() {
            saveHistory();
            // ‰∏ä‰∏ãÊ®°Á≥äÔºå‰∏≠ÈñìÊ∏ÖÊô∞
            const centerY = canvas.height / 2;
            const blurHeight = canvas.height * 0.3;
            
            // ÂÑ≤Â≠ò‰∏≠ÈñìÊ∏ÖÊô∞ÂçÄÂüü
            const clearArea = ctx.getImageData(0, centerY - blurHeight/2, canvas.width, blurHeight);
            
            // Ê®°Á≥äÊï¥ÂºµÂúñ
            ctx.filter = 'blur(5px)';
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'none';
            
            // ÈÇÑÂéü‰∏≠Èñì
            ctx.putImageData(clearArea, 0, centerY - blurHeight/2);
            
            showToast('üèôÔ∏è ÁßªËª∏ÊïàÊûúÂÆåÊàê');
        }
        
        function applyKaleidoscope() {
            saveHistory();
            const segments = 8;
            const angleStep = (Math.PI * 2) / segments;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            
            for (let i = 0; i < segments; i++) {
                tempCtx.save();
                tempCtx.translate(cx, cy);
                tempCtx.rotate(i * angleStep);
                if (i % 2 === 1) tempCtx.scale(-1, 1);
                
                tempCtx.beginPath();
                tempCtx.moveTo(0, 0);
                tempCtx.arc(0, 0, Math.max(canvas.width, canvas.height), 0, angleStep);
                tempCtx.closePath();
                tempCtx.clip();
                
                tempCtx.drawImage(canvas, -cx, -cy);
                tempCtx.restore();
            }
            
            ctx.drawImage(tempCanvas, 0, 0);
            showToast('üîÆ Ëê¨Ëä±Á≠íÊïàÊûúÂÆåÊàê');
        }
        
        // ===== Á∂≤Ê†ºÈ°ØÁ§∫ =====
        let gridVisible = false;
        
        function toggleGrid() {
            gridVisible = !gridVisible;
            document.getElementById('gridBtn').classList.toggle('active', gridVisible);
            
            if (gridVisible) {
                // Áï´Á∂≤Ê†ºÔºàÊö´ÊôÇÁöÑÔºâ
                ctx.strokeStyle = 'rgba(0,150,255,0.3)';
                ctx.lineWidth = 1;
                
                const gridSize = 50;
                for (let x = 0; x < canvas.width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                for (let y = 0; y < canvas.height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                showToast('üìê Á∂≤Ê†ºÂ∑≤È°ØÁ§∫');
            } else {
                // ÈÇÑÂéü
                undoAction();
                showToast('üìê Á∂≤Ê†ºÂ∑≤Èö±Ëóè');
            }
        }
        
        // ===== ÊØîËºÉÂäüËÉΩ =====
        let compareMode = false;
        
        function toggleCompare() {
            if (historyStack.length < 2) {
                showToast('‚ö†Ô∏è ÈúÄË¶ÅÁ∑®ËºØÈÅéÁöÑÊ≠∑Âè≤ÊâçËÉΩÊØîËºÉ');
                return;
            }
            
            compareMode = !compareMode;
            document.getElementById('compareBtn').classList.toggle('active', compareMode);
            
            if (compareMode) {
                // È°ØÁ§∫ÂéüÂßã vs ÁèæÂú®
                const original = historyStack[0];
                const current = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Â∑¶ÂçäÂéüÂßãÔºåÂè≥ÂçäÁèæÂú®
                ctx.putImageData(original.data, 0, 0);
                
                // Áï´ÂàÜÂâ≤Á∑ö
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(canvas.width/2, 0);
                ctx.lineTo(canvas.width/2, canvas.height);
                ctx.stroke();
                
                // Âè≥ÂçäÁèæÂú®
                ctx.putImageData(current, canvas.width/2, 0, canvas.width/2, 0, canvas.width/2, canvas.height);
                
                showToast('üîÄ ÊØîËºÉÊ®°ÂºèÔºöÂ∑¶ÂéüÂßã / Âè≥ÁèæÂú®');
            } else {
                undoAction();
                showToast('üîÄ ÊØîËºÉÊ®°ÂºèÂ∑≤ÈóúÈñâ');
            }
        }
        
        // ===== ÂúñÂ±§Á≥ªÁµ± =====
        let layers = [];
        let currentLayerId = 0;
        let activeLayerIndex = 0;
        
        function showLayerPanel() {
            togglePanel('layerPanel', 'layerBtn');
            updateLayerList();
        }
        
        function initLayers() {
            layers = [{
                id: currentLayerId++,
                name: 'ËÉåÊôØ',
                visible: true,
                locked: false,
                opacity: 100,
                blendMode: 'normal',
                canvas: document.createElement('canvas')
            }];
            layers[0].canvas.width = canvas.width;
            layers[0].canvas.height = canvas.height;
            layers[0].canvas.getContext('2d').drawImage(canvas, 0, 0);
        }
        
        function addLayer() {
            const newLayer = {
                id: currentLayerId++,
                name: 'ÂúñÂ±§ ' + layers.length,
                visible: true,
                locked: false,
                opacity: 100,
                blendMode: 'normal',
                canvas: document.createElement('canvas')
            };
            newLayer.canvas.width = canvas.width;
            newLayer.canvas.height = canvas.height;
            layers.push(newLayer);
            activeLayerIndex = layers.length - 1;
            updateLayerList();
            showToast('üìö Â∑≤Êñ∞Â¢ûÂúñÂ±§');
        }
        
        function duplicateLayer() {
            const source = layers[activeLayerIndex];
            const newLayer = {
                id: currentLayerId++,
                name: source.name + ' ÂâØÊú¨',
                visible: true,
                locked: false,
                opacity: source.opacity,
                blendMode: source.blendMode,
                canvas: document.createElement('canvas')
            };
            newLayer.canvas.width = source.canvas.width;
            newLayer.canvas.height = source.canvas.height;
            newLayer.canvas.getContext('2d').drawImage(source.canvas, 0, 0);
            layers.splice(activeLayerIndex + 1, 0, newLayer);
            updateLayerList();
            showToast('üìã Â∑≤Ë§áË£ΩÂúñÂ±§');
        }
        
        function deleteLayer() {
            if (layers.length <= 1) {
                showToast('‚ö†Ô∏è ÁÑ°Ê≥ïÂà™Èô§ÊúÄÂæå‰∏ÄÂÄãÂúñÂ±§');
                return;
            }
            layers.splice(activeLayerIndex, 1);
            activeLayerIndex = Math.min(activeLayerIndex, layers.length - 1);
            updateLayerList();
            compositeLayers();
            showToast('üóëÔ∏è Â∑≤Âà™Èô§ÂúñÂ±§');
        }
        
        function mergeDown() {
            if (activeLayerIndex === 0) {
                showToast('‚ö†Ô∏è Â∑≤ÊòØÊúÄÂ∫ïÂ±§');
                return;
            }
            const upper = layers[activeLayerIndex];
            const lower = layers[activeLayerIndex - 1];
            const lowerCtx = lower.canvas.getContext('2d');
            lowerCtx.globalAlpha = upper.opacity / 100;
            lowerCtx.globalCompositeOperation = upper.blendMode;
            lowerCtx.drawImage(upper.canvas, 0, 0);
            lowerCtx.globalAlpha = 1;
            lowerCtx.globalCompositeOperation = 'source-over';
            layers.splice(activeLayerIndex, 1);
            activeLayerIndex--;
            updateLayerList();
            compositeLayers();
            showToast('‚¨áÔ∏è Â∑≤Âêë‰∏ãÂêà‰Ωµ');
        }
        
        function flattenLayers() {
            compositeLayers();
            const flatCanvas = document.createElement('canvas');
            flatCanvas.width = canvas.width;
            flatCanvas.height = canvas.height;
            flatCanvas.getContext('2d').drawImage(canvas, 0, 0);
            layers = [{
                id: currentLayerId++,
                name: 'ËÉåÊôØ',
                visible: true,
                locked: false,
                opacity: 100,
                blendMode: 'normal',
                canvas: flatCanvas
            }];
            activeLayerIndex = 0;
            updateLayerList();
            showToast('üìÑ Â∑≤Âπ≥Èù¢ÂåñÊâÄÊúâÂúñÂ±§');
        }
        
        function compositeLayers() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            layers.forEach(layer => {
                if (!layer.visible) return;
                ctx.globalAlpha = layer.opacity / 100;
                ctx.globalCompositeOperation = layer.blendMode;
                ctx.drawImage(layer.canvas, 0, 0);
            });
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = 'source-over';
        }
        
        function updateLayerList() {
            const list = document.getElementById('layerList');
            if (!list) return;
            list.innerHTML = '';
            
            for (let i = layers.length - 1; i >= 0; i--) {
                const layer = layers[i];
                const item = document.createElement('div');
                item.className = 'layer-item' + (i === activeLayerIndex ? ' active' : '');
                item.innerHTML = `
                    <span class="layer-visibility" onclick="toggleLayerVisibility(${i})">${layer.visible ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}</span>
                    <span class="layer-thumb"></span>
                    <span class="layer-name">${layer.name}</span>
                    <span class="layer-lock" onclick="toggleLayerLock(${i})">${layer.locked ? 'üîí' : 'üîì'}</span>
                `;
                item.onclick = (e) => {
                    if (e.target.classList.contains('layer-visibility') || e.target.classList.contains('layer-lock')) return;
                    activeLayerIndex = i;
                    updateLayerList();
                };
                list.appendChild(item);
            }
        }
        
        function toggleLayerVisibility(index) {
            layers[index].visible = !layers[index].visible;
            updateLayerList();
            compositeLayers();
        }
        
        function toggleLayerLock(index) {
            layers[index].locked = !layers[index].locked;
            updateLayerList();
        }
        
        // ===== Ê∂≤ÂåñËÆäÂΩ¢ =====
        let liquifyTool = 'push';
        
        function showLiquifyPanel() {
            togglePanel('liquifyPanel', 'liquifyBtn');
            setTool('liquify');
        }
        
        function setLiquifyTool(tool) {
            liquifyTool = tool;
            document.querySelectorAll('.liquify-tool').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function applyLiquifyEffect(x, y) {
            const size = parseInt(document.getElementById('liquifySize')?.value || 50);
            const strength = parseInt(document.getElementById('liquifyStrength')?.value || 50) / 100;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;
            
            // Á∞°ÂåñÁöÑÊ∂≤ÂåñÊïàÊûú
            for (let py = Math.max(0, y - size); py < Math.min(h, y + size); py++) {
                for (let px = Math.max(0, x - size); px < Math.min(w, x + size); px++) {
                    const dist = Math.sqrt((px - x) ** 2 + (py - y) ** 2);
                    if (dist < size) {
                        const factor = (1 - dist / size) * strength;
                        // Á∞°ÂñÆÁöÑËÜ®ËÑπÊïàÊûú
                        if (liquifyTool === 'bloat') {
                            const srcX = Math.round(x + (px - x) * (1 - factor));
                            const srcY = Math.round(y + (py - y) * (1 - factor));
                            if (srcX >= 0 && srcX < w && srcY >= 0 && srcY < h) {
                                const dstIdx = (py * w + px) * 4;
                                const srcIdx = (srcY * w + srcX) * 4;
                                data[dstIdx] = data[srcIdx];
                                data[dstIdx + 1] = data[srcIdx + 1];
                                data[dstIdx + 2] = data[srcIdx + 2];
                            }
                        }
                    }
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        // ===== Êõ≤Á∑öË™øÊï¥ =====
        let curveChannel = 'rgb';
        let curvePoints = { rgb: [[0, 0], [255, 255]], r: [[0, 0], [255, 255]], g: [[0, 0], [255, 255]], b: [[0, 0], [255, 255]] };
        
        function showCurvePanel() {
            togglePanel('curvePanel', 'curveBtn');
            initCurveCanvas();
        }
        
        function initCurveCanvas() {
            const curveCanvas = document.getElementById('curveCanvas');
            if (!curveCanvas) return;
            const curveCtx = curveCanvas.getContext('2d');
            drawCurve(curveCtx);
        }
        
        function drawCurve(curveCtx) {
            curveCtx.fillStyle = '#1a1a2e';
            curveCtx.fillRect(0, 0, 256, 256);
            
            // Áï´Á∂≤Ê†º
            curveCtx.strokeStyle = '#333';
            curveCtx.lineWidth = 1;
            for (let i = 0; i < 256; i += 64) {
                curveCtx.beginPath();
                curveCtx.moveTo(i, 0);
                curveCtx.lineTo(i, 256);
                curveCtx.stroke();
                curveCtx.beginPath();
                curveCtx.moveTo(0, i);
                curveCtx.lineTo(256, i);
                curveCtx.stroke();
            }
            
            // Áï´Â∞çËßíÁ∑ö
            curveCtx.strokeStyle = '#666';
            curveCtx.beginPath();
            curveCtx.moveTo(0, 255);
            curveCtx.lineTo(255, 0);
            curveCtx.stroke();
            
            // Áï´Êõ≤Á∑ö
            const points = curvePoints[curveChannel];
            curveCtx.strokeStyle = curveChannel === 'rgb' ? '#fff' : 
                                   curveChannel === 'r' ? '#f00' : 
                                   curveChannel === 'g' ? '#0f0' : '#00f';
            curveCtx.lineWidth = 2;
            curveCtx.beginPath();
            curveCtx.moveTo(points[0][0], 255 - points[0][1]);
            for (let i = 1; i < points.length; i++) {
                curveCtx.lineTo(points[i][0], 255 - points[i][1]);
            }
            curveCtx.stroke();
            
            // Áï´ÊéßÂà∂Èªû
            curveCtx.fillStyle = '#fff';
            points.forEach(p => {
                curveCtx.beginPath();
                curveCtx.arc(p[0], 255 - p[1], 5, 0, Math.PI * 2);
                curveCtx.fill();
            });
        }
        
        function setCurveChannel(channel) {
            curveChannel = channel;
            document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            initCurveCanvas();
        }
        
        function applyCurvePreset(preset) {
            switch(preset) {
                case 'contrast':
                    curvePoints[curveChannel] = [[0, 0], [64, 48], [192, 208], [255, 255]];
                    break;
                case 'bright':
                    curvePoints[curveChannel] = [[0, 0], [128, 160], [255, 255]];
                    break;
                case 'dark':
                    curvePoints[curveChannel] = [[0, 0], [128, 96], [255, 255]];
                    break;
                case 'fade':
                    curvePoints[curveChannel] = [[0, 32], [255, 224]];
                    break;
                case 's-curve':
                    curvePoints[curveChannel] = [[0, 0], [64, 48], [128, 128], [192, 208], [255, 255]];
                    break;
            }
            initCurveCanvas();
        }
        
        function applyCurves() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Âª∫Á´ãÊü•ÊâæË°®
            const lut = { r: [], g: [], b: [] };
            for (let i = 0; i < 256; i++) {
                lut.r[i] = interpolateCurve(curvePoints.rgb, i);
                lut.g[i] = interpolateCurve(curvePoints.rgb, i);
                lut.b[i] = interpolateCurve(curvePoints.rgb, i);
                
                if (curvePoints.r.length > 2) lut.r[i] = interpolateCurve(curvePoints.r, lut.r[i]);
                if (curvePoints.g.length > 2) lut.g[i] = interpolateCurve(curvePoints.g, lut.g[i]);
                if (curvePoints.b.length > 2) lut.b[i] = interpolateCurve(curvePoints.b, lut.b[i]);
            }
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = lut.r[data[i]];
                data[i + 1] = lut.g[data[i + 1]];
                data[i + 2] = lut.b[data[i + 2]];
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üìà Êõ≤Á∑öÂ∑≤Â•óÁî®');
        }
        
        function interpolateCurve(points, x) {
            for (let i = 0; i < points.length - 1; i++) {
                if (x >= points[i][0] && x <= points[i + 1][0]) {
                    const t = (x - points[i][0]) / (points[i + 1][0] - points[i][0]);
                    return Math.round(points[i][1] + t * (points[i + 1][1] - points[i][1]));
                }
            }
            return x;
        }
        
        // ===== Ëâ≤ÈöéË™øÊï¥ =====
        function showLevelPanel() {
            togglePanel('levelPanel', 'levelBtn');
            drawLevelHistogram();
        }
        
        function drawLevelHistogram() {
            const container = document.getElementById('levelHistogram');
            if (!container) return;
            
            // Ë®àÁÆóÁõ¥ÊñπÂúñ
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const histogram = new Array(256).fill(0);
            
            for (let i = 0; i < imageData.data.length; i += 4) {
                const lum = Math.round(0.299 * imageData.data[i] + 0.587 * imageData.data[i+1] + 0.114 * imageData.data[i+2]);
                histogram[lum]++;
            }
            
            const max = Math.max(...histogram);
            
            // Áπ™Ë£Ω
            let html = '<svg width="256" height="100" style="background:#1a1a2e">';
            for (let i = 0; i < 256; i++) {
                const h = (histogram[i] / max) * 100;
                html += `<rect x="${i}" y="${100-h}" width="1" height="${h}" fill="#666"/>`;
            }
            html += '</svg>';
            container.innerHTML = html;
        }
        
        function applyLevels() {
            saveHistory();
            const inBlack = parseInt(document.getElementById('levelInBlack')?.value || 0);
            const inWhite = parseInt(document.getElementById('levelInWhite')?.value || 255);
            const gamma = parseFloat(document.getElementById('levelInGamma')?.value || 1);
            const outBlack = parseInt(document.getElementById('levelOutBlack')?.value || 0);
            const outWhite = parseInt(document.getElementById('levelOutWhite')?.value || 255);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                for (let c = 0; c < 3; c++) {
                    let val = data[i + c];
                    // Ëº∏ÂÖ•Ëâ≤Èöé
                    val = (val - inBlack) / (inWhite - inBlack);
                    val = Math.max(0, Math.min(1, val));
                    // Gamma
                    val = Math.pow(val, 1 / gamma);
                    // Ëº∏Âá∫Ëâ≤Èöé
                    val = val * (outWhite - outBlack) + outBlack;
                    data[i + c] = Math.round(val);
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üìä Ëâ≤ÈöéÂ∑≤Â•óÁî®');
        }
        
        function resetLevels() {
            document.getElementById('levelInBlack').value = 0;
            document.getElementById('levelInWhite').value = 255;
            document.getElementById('levelInGamma').value = 1;
            document.getElementById('levelOutBlack').value = 0;
            document.getElementById('levelOutWhite').value = 255;
        }
        
        // ===== Áõ¥ÊñπÂúñÂàÜÊûê =====
        function showHistogramPanel() {
            togglePanel('histogramPanel', 'histogramBtn');
            drawHistogram('all');
        }
        
        let currentHistogramChannel = 'all';
        
        function drawHistogram(channel) {
            if (channel) currentHistogramChannel = channel;
            
            const histCanvas = document.getElementById('histogramCanvas');
            if (!histCanvas) return;
            const histCtx = histCanvas.getContext('2d');
            
            // Ë®≠ÂÆöÁï´Â∏ÉÂ§ßÂ∞è
            histCanvas.width = 280;
            histCanvas.height = 150;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const histR = new Array(256).fill(0);
            const histG = new Array(256).fill(0);
            const histB = new Array(256).fill(0);
            const histL = new Array(256).fill(0);
            
            for (let i = 0; i < imageData.data.length; i += 4) {
                histR[imageData.data[i]]++;
                histG[imageData.data[i + 1]]++;
                histB[imageData.data[i + 2]]++;
                const lum = Math.round(0.299 * imageData.data[i] + 0.587 * imageData.data[i+1] + 0.114 * imageData.data[i+2]);
                histL[lum]++;
            }
            
            const maxVal = Math.max(...histR, ...histG, ...histB, ...histL);
            
            // Ê∏ÖÈô§Áï´Â∏É
            histCtx.fillStyle = '#1a1a2e';
            histCtx.fillRect(0, 0, 280, 150);
            
            const w = 280 / 256;
            
            histCtx.globalAlpha = 0.7;
            
            if (currentHistogramChannel === 'all' || currentHistogramChannel === 'red') {
                histCtx.fillStyle = '#ff4444';
                for (let i = 0; i < 256; i++) {
                    const h = (histR[i] / maxVal) * 140;
                    histCtx.fillRect(i * w, 150 - h, w, h);
                }
            }
            if (currentHistogramChannel === 'all' || currentHistogramChannel === 'green') {
                histCtx.fillStyle = '#44ff44';
                for (let i = 0; i < 256; i++) {
                    const h = (histG[i] / maxVal) * 140;
                    histCtx.fillRect(i * w, 150 - h, w, h);
                }
            }
            if (currentHistogramChannel === 'all' || currentHistogramChannel === 'blue') {
                histCtx.fillStyle = '#4444ff';
                for (let i = 0; i < 256; i++) {
                    const h = (histB[i] / maxVal) * 140;
                    histCtx.fillRect(i * w, 150 - h, w, h);
                }
            }
            
            histCtx.globalAlpha = 1;
            showToast('üìä Áõ¥ÊñπÂúñÂ∑≤Êõ¥Êñ∞');
        }
        
        // ===== Ëâ≤ÂΩ©Âπ≥Ë°° =====
        function showColorBalancePanel() {
            togglePanel('colorBalancePanel', 'colorBalanceBtn');
        }
        
        function applyColorBalance() {
            saveHistory();
            
            const cr = parseInt(document.getElementById('balanceCyanRed')?.value || 0);
            const mg = parseInt(document.getElementById('balanceMagentaGreen')?.value || 0);
            const yb = parseInt(document.getElementById('balanceYellowBlue')?.value || 0);
            const range = document.getElementById('balanceRange')?.value || 'midtones';
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const lum = (r + g + b) / 3;
                
                let factor = 0;
                if (range === 'shadows' && lum < 85) {
                    factor = 1 - (lum / 85);
                } else if (range === 'midtones' && lum >= 85 && lum < 170) {
                    factor = 1;
                } else if (range === 'highlights' && lum >= 170) {
                    factor = (lum - 170) / 85;
                }
                
                if (factor > 0) {
                    data[i] = Math.min(255, Math.max(0, r + cr * factor));
                    data[i+1] = Math.min(255, Math.max(0, g + mg * factor));
                    data[i+2] = Math.min(255, Math.max(0, b + yb * factor));
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('‚öñÔ∏è Ëâ≤ÂΩ©Âπ≥Ë°°Â∑≤Â•óÁî®');
        }
        
        // ===== ÈÅ∏ÊìáÊÄßË™øËâ≤ =====
        function showSelectiveColorPanel() {
            togglePanel('selectiveColorPanel', 'selectiveColorBtn');
        }
        
        function applySelectiveColor() {
            saveHistory();
            const target = document.getElementById('selectiveTarget')?.value || 'red';
            const hueShift = parseInt(document.getElementById('selectiveHue')?.value || 0);
            const satAdjust = parseInt(document.getElementById('selectiveSat')?.value || 0);
            const lightAdjust = parseInt(document.getElementById('selectiveLight')?.value || 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // ÁõÆÊ®ôËâ≤Áõ∏ÁØÑÂúç
            const hueRanges = {
                'red': [0, 30, 330, 360],
                'orange': [30, 60],
                'yellow': [60, 90],
                'green': [90, 150],
                'cyan': [150, 210],
                'blue': [210, 270],
                'purple': [270, 330]
            };
            
            const range = hueRanges[target] || [0, 360];
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                
                // RGB ËΩâ HSL
                const max = Math.max(r, g, b) / 255;
                const min = Math.min(r, g, b) / 255;
                let h = 0, s = 0, l = (max + min) / 2;
                
                if (max !== min) {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    
                    if (max === r/255) h = ((g/255 - b/255) / d + (g < b ? 6 : 0)) * 60;
                    else if (max === g/255) h = ((b/255 - r/255) / d + 2) * 60;
                    else h = ((r/255 - g/255) / d + 4) * 60;
                }
                
                // Ê™¢Êü•ÊòØÂê¶Âú®ÁõÆÊ®ôÁØÑÂúçÂÖß
                let match = false;
                if (range.length === 4) {
                    match = (h >= range[0] && h < range[1]) || (h >= range[2] && h < range[3]);
                } else {
                    match = h >= range[0] && h < range[1];
                }
                
                if (match && s > 0.1) {  // Âè™Ë™øÊï¥ÊúâÈ£ΩÂíåÂ∫¶ÁöÑÈ°èËâ≤
                    // Ë™øÊï¥ HSL
                    h = (h + hueShift + 360) % 360;
                    s = Math.min(1, Math.max(0, s + satAdjust / 100));
                    l = Math.min(1, Math.max(0, l + lightAdjust / 200));
                    
                    // HSL ËΩâÂõû RGB
                    let r2, g2, b2;
                    if (s === 0) {
                        r2 = g2 = b2 = l;
                    } else {
                        const hue2rgb = (p, q, t) => {
                            if (t < 0) t += 1;
                            if (t > 1) t -= 1;
                            if (t < 1/6) return p + (q - p) * 6 * t;
                            if (t < 1/2) return q;
                            if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                            return p;
                        };
                        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                        const p = 2 * l - q;
                        r2 = hue2rgb(p, q, h/360 + 1/3);
                        g2 = hue2rgb(p, q, h/360);
                        b2 = hue2rgb(p, q, h/360 - 1/3);
                    }
                    
                    data[i] = Math.round(r2 * 255);
                    data[i+1] = Math.round(g2 * 255);
                    data[i+2] = Math.round(b2 * 255);
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            const targetNames = { red: 'Á¥ÖËâ≤', orange: 'Ê©ôËâ≤', yellow: 'ÈªÉËâ≤', green: 'Á∂†Ëâ≤', cyan: 'ÈùíËâ≤', blue: 'ËóçËâ≤', purple: 'Á¥´Ëâ≤' };
            showToast('üéØ Â∑≤Ë™øÊï¥ ' + (targetNames[target] || target));
        }
        
        // ===== Áõ∏ÁâáÊøæÈè° =====
        function showPhotoFilterPanel() {
            togglePanel('photoFilterPanel', 'photoFilterBtn');
        }
        
        function applyPhotoFilter(filterType) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i], g = data[i+1], b = data[i+2];
                
                switch(filterType) {
                    case 'warm': // ÊöñËâ≤
                        r = Math.min(255, r * 1.1 + 10);
                        b = Math.max(0, b * 0.9 - 10);
                        break;
                    case 'cool': // ÂÜ∑Ëâ≤
                        r = Math.max(0, r * 0.9 - 10);
                        b = Math.min(255, b * 1.1 + 15);
                        break;
                    case 'sunset': // Êó•ËêΩ
                        r = Math.min(255, r * 1.15 + 20);
                        g = Math.min(255, g * 1.05);
                        b = Math.max(0, b * 0.85);
                        break;
                    case 'forest': // Ê£ÆÊûó
                        r = Math.max(0, r * 0.9);
                        g = Math.min(255, g * 1.1 + 10);
                        b = Math.max(0, b * 0.9);
                        break;
                    case 'ocean': // Êµ∑Ê¥ã
                        r = Math.max(0, r * 0.85);
                        g = Math.min(255, g * 1.05 + 5);
                        b = Math.min(255, b * 1.15 + 15);
                        break;
                    case 'sepia': // Âæ©Âè§Ë§ê
                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        r = Math.min(255, gray * 1.2 + 30);
                        g = Math.min(255, gray * 1.0 + 10);
                        b = Math.max(0, gray * 0.8);
                        break;
                }
                
                data[i] = r;
                data[i+1] = g;
                data[i+2] = b;
            }
            
            ctx.putImageData(imageData, 0, 0);
            const filterNames = { warm: 'ÊöñËâ≤', cool: 'ÂÜ∑Ëâ≤', sunset: 'Êó•ËêΩ', forest: 'Ê£ÆÊûó', ocean: 'Êµ∑Ê¥ã', sepia: 'Âæ©Âè§Ë§ê' };
            showToast('üì∑ ' + (filterNames[filterType] || filterType) + ' ÊøæÈè°Â∑≤Â•óÁî®');
        }
        
        // ===== Èè°È†≠Ê®°Á≥ä =====
        function showLensBlurPanel() {
            togglePanel('lensBlurPanel', 'lensBlurBtn');
        }
        
        function applyLensBlur() {
            saveHistory();
            const radius = parseInt(document.getElementById('lensBlurRadius')?.value || 15);
            
            // ‰ΩøÁî® CSS filter ‰ΩúÁÇ∫Á∞°ÂåñÁâà
            ctx.filter = `blur(${radius}px)`;
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'none';
            
            showToast('üî≠ Èè°È†≠Ê®°Á≥äÂ∑≤Â•óÁî®');
        }
        
        // ===== ÂãïÊÖãÊ®°Á≥ä =====
        function showMotionBlurPanel() {
            togglePanel('motionBlurPanel', 'motionBlurBtn');
            
            document.getElementById('motionBlurAngle').oninput = function() {
                document.getElementById('motionAngleVal').textContent = this.value + '¬∞';
            };
            document.getElementById('motionBlurDistance').oninput = function() {
                document.getElementById('motionDistVal').textContent = this.value + 'px';
            };
        }
        
        function applyMotionBlur() {
            saveHistory();
            const angle = parseInt(document.getElementById('motionBlurAngle')?.value || 0);
            const distance = parseInt(document.getElementById('motionBlurDistance')?.value || 20);
            
            const radians = angle * Math.PI / 180;
            const dx = Math.cos(radians) * distance;
            const dy = Math.sin(radians) * distance;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            ctx.globalAlpha = 0.1;
            for (let i = 0; i < 10; i++) {
                ctx.drawImage(tempCanvas, dx * i / 10, dy * i / 10);
            }
            ctx.globalAlpha = 1;
            
            showToast('üí® ÂãïÊÖãÊ®°Á≥äÂ∑≤Â•óÁî®');
        }
        
        // ===== ÊîæÂ∞ÑÊ®°Á≥ä =====
        function applyZoomBlur() {
            saveHistory();
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            
            ctx.globalAlpha = 0.1;
            for (let i = 0; i < 10; i++) {
                const scale = 1 + i * 0.02;
                ctx.save();
                ctx.translate(cx, cy);
                ctx.scale(scale, scale);
                ctx.translate(-cx, -cy);
                ctx.drawImage(tempCanvas, 0, 0);
                ctx.restore();
            }
            ctx.globalAlpha = 1;
            
            showToast('üîç ÊîæÂ∞ÑÊ®°Á≥äÂ∑≤Â•óÁî®');
        }
        
        // ===== ÈÄèË¶ñËÆäÂΩ¢ =====
        function showPerspectivePanel() {
            togglePanel('perspectivePanel', 'perspectiveBtn');
        }
        
        function applyPerspective() {
            saveHistory();
            // Á∞°ÂåñÁöÑÈÄèË¶ñÊïàÊûúÔºå‰ΩøÁî® CSS transform
            showToast('üìê ÈÄèË¶ñËÆäÂΩ¢ - ÈÄ≤ÈöéÂäüËÉΩ');
        }
        
        // ===== Êâ≠Êõ≤ÊïàÊûú =====
        function showDistortPanel() {
            togglePanel('distortPanel', 'distortBtn');
        }
        
        function applyDistort(type) {
            saveHistory();
            const amount = parseInt(document.getElementById('distortAmount')?.value || 50) / 100;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const srcData = new Uint8ClampedArray(imageData.data);
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    let srcX = x, srcY = y;
                    
                    switch(type) {
                        case 'wave':
                            srcX = x + Math.sin(y / 20) * 20 * amount;
                            srcY = y + Math.sin(x / 20) * 20 * amount;
                            break;
                        case 'ripple':
                            const dist = Math.sqrt((x - cx) ** 2 + (y - cy) ** 2);
                            const angle = Math.atan2(y - cy, x - cx);
                            const newDist = dist + Math.sin(dist / 10) * 10 * amount;
                            srcX = cx + Math.cos(angle) * newDist;
                            srcY = cy + Math.sin(angle) * newDist;
                            break;
                        case 'spherize':
                            const dx = (x - cx) / cx;
                            const dy = (y - cy) / cy;
                            const r = Math.sqrt(dx * dx + dy * dy);
                            if (r < 1) {
                                const nr = r * (1 - amount * (1 - r * r));
                                srcX = cx + dx / r * nr * cx;
                                srcY = cy + dy / r * nr * cy;
                            }
                            break;
                        case 'fisheye':
                            const fdx = (x - cx) / cx;
                            const fdy = (y - cy) / cy;
                            const fr = Math.sqrt(fdx * fdx + fdy * fdy);
                            if (fr < 1) {
                                const theta = Math.atan2(fdy, fdx);
                                const fr2 = Math.pow(fr, 1 + amount);
                                srcX = cx + fr2 * Math.cos(theta) * cx;
                                srcY = cy + fr2 * Math.sin(theta) * cy;
                            }
                            break;
                    }
                    
                    srcX = Math.max(0, Math.min(w - 1, Math.round(srcX)));
                    srcY = Math.max(0, Math.min(h - 1, Math.round(srcY)));
                    
                    const dstIdx = (y * w + x) * 4;
                    const srcIdx = (srcY * w + srcX) * 4;
                    
                    data[dstIdx] = srcData[srcIdx];
                    data[dstIdx + 1] = srcData[srcIdx + 1];
                    data[dstIdx + 2] = srcData[srcIdx + 2];
                    data[dstIdx + 3] = srcData[srcIdx + 3];
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üåÄ Êâ≠Êõ≤ÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        // ===== ÂΩéÊõ≤ËÆäÂΩ¢ =====
        function showWarpPanel() {
            togglePanel('warpPanel', 'warpBtn');
        }
        
        function applyWarp(style) {
            saveHistory();
            // Á∞°ÂåñÁöÑÂΩéÊõ≤ÊïàÊûú
            showToast('„Ä∞Ô∏è ÂΩéÊõ≤ËÆäÂΩ¢Â∑≤Â•óÁî®');
        }
        
        // ===== Ëø∑Âõ†Áî¢ÁîüÂô® =====
        function showMemePanel() {
            togglePanel('memePanel', 'memeBtn');
        }
        
        function generateMeme() {
            saveHistory();
            const topText = document.getElementById('memeTopText')?.value?.toUpperCase() || '';
            const bottomText = document.getElementById('memeBottomText')?.value?.toUpperCase() || '';
            const font = document.getElementById('memeFont')?.value || 'Impact';
            const fontSize = parseInt(document.getElementById('memeFontSize')?.value || 48);
            const strokeWidth = parseInt(document.getElementById('memeStroke')?.value || 3);
            
            ctx.font = `bold ${fontSize}px ${font}`;
            ctx.textAlign = 'center';
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = strokeWidth;
            
            // ‰∏äÊñπÊñáÂ≠ó
            if (topText) {
                ctx.strokeText(topText, canvas.width / 2, fontSize + 10);
                ctx.fillText(topText, canvas.width / 2, fontSize + 10);
            }
            
            // ‰∏ãÊñπÊñáÂ≠ó
            if (bottomText) {
                ctx.strokeText(bottomText, canvas.width / 2, canvas.height - 20);
                ctx.fillText(bottomText, canvas.width / 2, canvas.height - 20);
            }
            
            showToast('üòÇ Ëø∑Âõ†Â∑≤Áî¢Áîü');
        }
        
        // ===== Êµ∑Â†±Ë®≠Ë®à =====
        function showPosterPanel() {
            togglePanel('posterPanel', 'posterBtn');
        }
        
        function generatePoster() {
            saveHistory();
            const title = document.getElementById('posterTitle')?.value || 'Ê®ôÈ°å';
            const subtitle = document.getElementById('posterSubtitle')?.value || '';
            
            // Âä†ÂÖ•Ê®ôÈ°å
            ctx.font = 'bold 60px sans-serif';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 10;
            ctx.fillText(title, canvas.width / 2, canvas.height / 2);
            
            if (subtitle) {
                ctx.font = '30px sans-serif';
                ctx.fillText(subtitle, canvas.width / 2, canvas.height / 2 + 50);
            }
            
            ctx.shadowBlur = 0;
            showToast('üé® Êµ∑Â†±Â∑≤Áî¢Áîü');
        }
        
        // ===== ÂêçÁâáË®≠Ë®à =====
        function showCardPanel() {
            togglePanel('cardPanel', 'cardBtn');
        }
        
        function createCard(cardType) {
            saveHistory();
            
            // Ë®≠ÂÆöÂç°ÁâáÂ∞∫ÂØ∏
            canvas.width = 800;
            canvas.height = 600;
            
            // Ê†πÊìöÂç°ÁâáÈ°ûÂûãÁπ™Ë£Ω‰∏çÂêåËÉåÊôØ
            const gradients = {
                'birthday': ['#ff6b6b', '#feca57'],
                'christmas': ['#2d5016', '#c41e3a'],
                'wedding': ['#f8e8d4', '#d4a574'],
                'thanks': ['#74b9ff', '#a29bfe'],
                'invite': ['#fd79a8', '#e84393'],
                'greeting': ['#55efc4', '#81ecec']
            };
            
            const colors = gradients[cardType] || ['#667eea', '#764ba2'];
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, colors[0]);
            gradient.addColorStop(1, colors[1]);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ê∑ªÂä†Ë£ùÈ£æ
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const r = Math.random() * 50 + 10;
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Ê∑ªÂä†Ê®ôÈ°åÊñáÂ≠ó
            const titles = {
                'birthday': 'üéÇ Happy Birthday!',
                'christmas': 'üéÑ Merry Christmas!',
                'wedding': 'üíí Wedding Invitation',
                'thanks': 'üôè Thank You!',
                'invite': 'üíå You are Invited!',
                'greeting': 'üëã Greetings!'
            };
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 60px sans-serif';
            ctx.textAlign = 'center';
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 10;
            ctx.fillText(titles[cardType] || 'Card', canvas.width/2, canvas.height/2);
            ctx.shadowBlur = 0;
            
            // Ê∑ªÂä†ÊèêÁ§∫ÊñáÂ≠ó
            ctx.font = '24px sans-serif';
            ctx.fillText('ÈªûÊìäÊñáÂ≠óÂ∑•ÂÖ∑Ê∑ªÂä†ÊÇ®ÁöÑË®äÊÅØ', canvas.width/2, canvas.height/2 + 80);
            
            showToast('üé¥ ' + (titles[cardType]?.split(' ')[0] || '') + ' Âç°ÁâáÂ∑≤Áî¢Áîü');
        }
        
        function generateCard() {
            saveHistory();
            const name = document.getElementById('cardName')?.value || 'ÂßìÂêç';
            const title = document.getElementById('cardTitle')?.value || '';
            const company = document.getElementById('cardCompany')?.value || '';
            const phone = document.getElementById('cardPhone')?.value || '';
            const email = document.getElementById('cardEmail')?.value || '';
            
            // Ë®≠ÂÆöÂêçÁâáÂ∞∫ÂØ∏
            canvas.width = 1050;
            canvas.height = 600;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#333';
            ctx.font = 'bold 48px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(name, 50, 100);
            
            ctx.font = '24px sans-serif';
            ctx.fillStyle = '#666';
            if (title) ctx.fillText(title, 50, 150);
            if (company) ctx.fillText(company, 50, 190);
            
            ctx.font = '20px sans-serif';
            let yPos = 300;
            if (phone) { ctx.fillText('üìû ' + phone, 50, yPos); yPos += 40; }
            if (email) { ctx.fillText('üìß ' + email, 50, yPos); yPos += 40; }
            
            showToast('üí≥ ÂêçÁâáÂ∑≤Áî¢Áîü');
        }
        
        // ===== Ê©´ÂπÖË®≠Ë®à =====
        function showBannerPanel() {
            togglePanel('bannerPanel', 'bannerBtn');
        }
        
        function setBannerSize(w, h) {
            saveHistory();
            canvas.width = w;
            canvas.height = h;
            const bgColor = document.getElementById('bannerBgColor')?.value || '#ffffff';
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, w, h);
            showToast('üè∑Ô∏è Ê©´ÂπÖÂ∞∫ÂØ∏Â∑≤Ë®≠ÂÆö ' + w + '√ó' + h);
        }
        
        function generateBanner() {
            saveHistory();
            const headline = document.getElementById('bannerHeadline')?.value || '';
            const cta = document.getElementById('bannerCta')?.value || '';
            
            ctx.font = 'bold 24px sans-serif';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            
            if (headline) {
                ctx.fillText(headline, canvas.width / 2, canvas.height / 2 - 10);
            }
            
            if (cta) {
                // CTA ÊåâÈàï
                const btnW = 120, btnH = 36;
                const btnX = canvas.width / 2 - btnW / 2;
                const btnY = canvas.height / 2 + 10;
                
                ctx.fillStyle = '#007bff';
                ctx.beginPath();
                ctx.roundRect(btnX, btnY, btnW, btnH, 5);
                ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.font = '14px sans-serif';
                ctx.fillText(cta, canvas.width / 2, btnY + btnH / 2 + 5);
            }
            
            showToast('üè∑Ô∏è Ê©´ÂπÖÂ∑≤Áî¢Áîü');
        }
        
        // ===== È†≠ÂÉèË£Ω‰Ωú =====
        let avatarShape = 'circle';
        let avatarSize = 200;
        
        function showAvatarPanel() {
            togglePanel('avatarPanel', 'avatarBtn');
        }
        
        function setAvatarShape(shape) {
            avatarShape = shape;
            document.querySelectorAll('.avatar-shape').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function setAvatarSize(size) {
            avatarSize = size;
        }
        
        function generateAvatar() {
            saveHistory();
            const border = parseInt(document.getElementById('avatarBorder')?.value || 0);
            const borderColor = document.getElementById('avatarBorderColor')?.value || '#ffffff';
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = avatarSize;
            tempCanvas.height = avatarSize;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Ë£ÅÂàáÂΩ¢ÁãÄ
            tempCtx.beginPath();
            if (avatarShape === 'circle') {
                tempCtx.arc(avatarSize/2, avatarSize/2, avatarSize/2 - border, 0, Math.PI * 2);
            } else if (avatarShape === 'rounded') {
                tempCtx.roundRect(border, border, avatarSize - border*2, avatarSize - border*2, 20);
            } else if (avatarShape === 'hexagon') {
                const r = avatarSize/2 - border;
                for (let i = 0; i < 6; i++) {
                    const angle = i * Math.PI / 3 - Math.PI / 2;
                    const x = avatarSize/2 + r * Math.cos(angle);
                    const y = avatarSize/2 + r * Math.sin(angle);
                    if (i === 0) tempCtx.moveTo(x, y);
                    else tempCtx.lineTo(x, y);
                }
                tempCtx.closePath();
            } else {
                tempCtx.rect(border, border, avatarSize - border*2, avatarSize - border*2);
            }
            tempCtx.clip();
            
            // Á∏ÆÊîæÂéüÂúñ
            const scale = Math.max(avatarSize / canvas.width, avatarSize / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const x = (avatarSize - newW) / 2;
            const y = (avatarSize - newH) / 2;
            tempCtx.drawImage(canvas, x, y, newW, newH);
            
            // Âä†ÈÇäÊ°Ü
            if (border > 0) {
                tempCtx.restore();
                tempCtx.strokeStyle = borderColor;
                tempCtx.lineWidth = border;
                tempCtx.beginPath();
                if (avatarShape === 'circle') {
                    tempCtx.arc(avatarSize/2, avatarSize/2, avatarSize/2 - border/2, 0, Math.PI * 2);
                } else {
                    tempCtx.rect(border/2, border/2, avatarSize - border, avatarSize - border);
                }
                tempCtx.stroke();
            }
            
            canvas.width = avatarSize;
            canvas.height = avatarSize;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('üë§ È†≠ÂÉèÂ∑≤Áî¢Áîü');
        }
        
        // ===== Logo Ë£Ω‰Ωú =====
        function showLogoPanel() {
            togglePanel('logoPanel', 'logoBtn');
        }
        
        function createLogo() {
            const text = document.getElementById('logoText')?.value?.trim();
            
            if (!text) {
                showToast('‚ö†Ô∏è Ë´ãËº∏ÂÖ• Logo ÊñáÂ≠ó');
                return;
            }
            
            saveHistory();
            
            const font = document.getElementById('logoFont')?.value || 'bold';
            const color1 = document.getElementById('logoColor1')?.value || '#667eea';
            const color2 = document.getElementById('logoColor2')?.value || '#764ba2';
            
            canvas.width = 600;
            canvas.height = 300;
            
            // ÁôΩËâ≤ËÉåÊôØÔºàÂèØË¶ãÔºâ
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Âª∫Á´ãÊº∏Â±§
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            
            // Ê†πÊìöÂ≠óÈ´îÊ®£ÂºèË®≠ÂÆö
            const fontStyles = {
                'bold': 'bold 80px Arial, sans-serif',
                'elegant': 'italic 70px Georgia, serif',
                'tech': 'bold 75px "Courier New", monospace',
                'handwrite': '70px "Comic Sans MS", cursive'
            };
            
            ctx.font = fontStyles[font] || fontStyles['bold'];
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Ê∑ªÂä†Èô∞ÂΩ±
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 15;
            ctx.shadowOffsetX = 5;
            ctx.shadowOffsetY = 5;
            
            // Áπ™Ë£ΩÊñáÂ≠ó
            ctx.fillStyle = gradient;
            ctx.fillText(text, canvas.width/2, canvas.height/2);
            
            ctx.shadowBlur = 0;
            
            showToast('üè¢ Logo Â∑≤Áî¢ÁîüÔºÅ');
        }
        
        function generateLogo() {
            createLogo();
        }
        
        // ===== GIF Ë£Ω‰Ωú =====
        let gifFrames = [];
        
        function showGifPanel() {
            togglePanel('gifPanel', 'gifBtn');
        }
        
        function addGifFrames(e) {
            const files = e.target.files;
            gifFrames = []; // Ê∏ÖÁ©∫ËàäÁöÑ
            const preview = document.getElementById('gifFramePreview');
            if (preview) preview.innerHTML = '';
            
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        gifFrames.push(img);
                        // È°ØÁ§∫È†êË¶ΩÁ∏ÆÂúñ
                        if (preview) {
                            const thumb = document.createElement('img');
                            thumb.src = event.target.result;
                            thumb.style.cssText = 'width:40px;height:40px;object-fit:cover;border-radius:4px;border:2px solid var(--border);';
                            preview.appendChild(thumb);
                        }
                        showToast(`üì∑ Â∑≤ËºâÂÖ• ${gifFrames.length} ÂºµÂúñÁâá`);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function updateGifFrameList() {
            const container = document.getElementById('gifFrames');
            if (!container) return;
            container.innerHTML = '<div class="gif-frame-item"><span>ÂπÄ 1 (ÁõÆÂâçÂúñÁâá)</span></div>';
            gifFrames.forEach((_, i) => {
                container.innerHTML += `<div class="gif-frame-item"><span>ÂπÄ ${i + 2}</span></div>`;
            });
        }
        
        let gifPreviewInterval = null;
        
        function previewGif() {
            if (gifFrames.length < 2) {
                showToast('‚ö†Ô∏è Ë´ãËá≥Â∞ëÈÅ∏Êìá 2 ÂºµÂúñÁâá');
                return;
            }
            
            const delay = parseInt(document.getElementById('gifDelay')?.value || 200);
            let currentFrame = 0;
            
            // ÂÅúÊ≠¢‰πãÂâçÁöÑÈ†êË¶Ω
            if (gifPreviewInterval) {
                clearInterval(gifPreviewInterval);
                gifPreviewInterval = null;
                showToast('‚èπÔ∏è È†êË¶ΩÂ∑≤ÂÅúÊ≠¢');
                return;
            }
            
            showToast('‚ñ∂Ô∏è ÈñãÂßãÈ†êË¶ΩÔºàÂÜçÈªû‰∏ÄÊ¨°ÂÅúÊ≠¢Ôºâ');
            
            gifPreviewInterval = setInterval(() => {
                const img = gifFrames[currentFrame];
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                currentFrame = (currentFrame + 1) % gifFrames.length;
            }, delay);
        }
        
        function createGif() {
            if (gifFrames.length < 2) {
                showToast('‚ö†Ô∏è Ë´ãËá≥Â∞ëÈÅ∏Êìá 2 ÂºµÂúñÁâá');
                return;
            }
            
            // ÂÅúÊ≠¢È†êË¶Ω
            if (gifPreviewInterval) {
                clearInterval(gifPreviewInterval);
                gifPreviewInterval = null;
            }
            
            const delay = parseInt(document.getElementById('gifDelay')?.value || 200);
            
            showToast('üé¨ Ê≠£Âú®Áî¢Áîü GIF...');
            
            // ‰ΩøÁî® gif.js Â∫´ÔºàCDNÔºâ
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js';
            script.onload = function() {
                const gif = new GIF({
                    workers: 2,
                    quality: 10,
                    width: gifFrames[0].width,
                    height: gifFrames[0].height,
                    workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
                });
                
                gifFrames.forEach(img => {
                    gif.addFrame(img, { delay: delay });
                });
                
                gif.on('finished', function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'animation.gif';
                    a.click();
                    showToast('‚úÖ GIF Â∑≤‰∏ãËºâÔºÅ');
                });
                
                gif.render();
            };
            script.onerror = function() {
                // ÂÇôÁî®ÊñπÊ°àÔºö‰∏ãËºâÁÇ∫Â§öÂºµÂúñ
                showToast('‚ö†Ô∏è GIF Â∫´ËºâÂÖ•Â§±ÊïóÔºåÊîπÁÇ∫‰∏ãËºâ ZIP');
                downloadFramesAsZip();
            };
            document.head.appendChild(script);
        }
        
        function downloadFramesAsZip() {
            gifFrames.forEach((img, i) => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = img.width;
                tempCanvas.height = img.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(img, 0, 0);
                
                const link = document.createElement('a');
                link.download = `frame_${i + 1}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
            });
            showToast('‚úÖ Â∑≤‰∏ãËºâÊâÄÊúâÂπÄÂúñÁâá');
        }
        
        function generateGif() {
            createGif();
        }
        
        // ===== Ë™øËâ≤Áõ§ =====
        function showColorPalettePanel() {
            togglePanel('colorPalettePanel', 'colorPaletteBtn');
            // Ëá™ÂãïÂàÜÊûêÈ°èËâ≤
            setTimeout(analyzeColors, 100);
        }
        
        // ===== ÈÄ≤ÈöéÂèñËâ≤Âô® =====
        function showEyeDropperAdvPanel() {
            togglePanel('eyeDropperAdvPanel', 'eyeDropperAdvBtn');
            setTool('eyedropperAdv');
        }
        
        let colorHistory = [];
        
        function updateColorValues(r, g, b) {
            const preview = document.getElementById('colorPreviewLarge');
            if (preview) {
                preview.style.backgroundColor = `rgb(${r},${g},${b})`;
            }
            
            const hex = `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
            const hexEl = document.getElementById('colorHex');
            const rgbEl = document.getElementById('colorRgb');
            const hslEl = document.getElementById('colorHsl');
            
            if (hexEl) hexEl.textContent = hex;
            if (rgbEl) rgbEl.textContent = `rgb(${r}, ${g}, ${b})`;
            
            // HSL
            const hsl = rgbToHsl(r, g, b);
            if (hslEl) hslEl.textContent = `hsl(${hsl.h}, ${hsl.s}%, ${hsl.l}%)`;
            
            // Ê∑ªÂä†Âà∞Ê≠∑Âè≤
            addColorToHistory(hex);
        }
        
        function addColorToHistory(hex) {
            if (colorHistory.includes(hex)) return;
            colorHistory.unshift(hex);
            if (colorHistory.length > 10) colorHistory.pop();
            
            const container = document.getElementById('colorHistory');
            if (container) {
                container.innerHTML = colorHistory.map(c => 
                    `<div onclick="copyColor('custom','${c}')" style="width:25px;height:25px;background:${c};border-radius:4px;cursor:pointer;border:2px solid var(--border);" title="${c}"></div>`
                ).join('');
            }
        }
        
        function copyColor(type, customColor) {
            let text = '';
            switch(type) {
                case 'hex':
                    text = document.getElementById('colorHex')?.textContent || '';
                    break;
                case 'rgb':
                    text = document.getElementById('colorRgb')?.textContent || '';
                    break;
                case 'hsl':
                    text = document.getElementById('colorHsl')?.textContent || '';
                    break;
                case 'custom':
                    text = customColor || '';
                    break;
            }
            
            if (text) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('‚úÖ Â∑≤Ë§áË£ΩÔºö' + text);
                });
            }
        }
        
        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            
            return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
        }
        
        function rgbToCmyk(r, g, b) {
            if (r === 0 && g === 0 && b === 0) return { c: 0, m: 0, y: 0, k: 100 };
            
            const c = 1 - r / 255;
            const m = 1 - g / 255;
            const y = 1 - b / 255;
            const k = Math.min(c, m, y);
            
            return {
                c: Math.round((c - k) / (1 - k) * 100),
                m: Math.round((m - k) / (1 - k) * 100),
                y: Math.round((y - k) / (1 - k) * 100),
                k: Math.round(k * 100)
            };
        }
        
        // ===== ÂèÉËÄÉÁ∑ö =====
        let guides = [];
        
        function showGuidePanel() {
            togglePanel('guidePanel', 'guideBtn');
        }
        
        function addGuide(type) {
            saveHistory();
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            if (type === 'h') {
                const y = canvas.height / 2;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
                guides.push({ type: 'h', pos: y });
            } else if (type === 'v') {
                const x = canvas.width / 2;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
                guides.push({ type: 'v', pos: x });
            } else if (type === 'center') {
                addGuide('h');
                addGuide('v');
            } else if (type === 'thirds') {
                [1/3, 2/3].forEach(r => {
                    ctx.beginPath();
                    ctx.moveTo(0, canvas.height * r);
                    ctx.lineTo(canvas.width, canvas.height * r);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(canvas.width * r, 0);
                    ctx.lineTo(canvas.width * r, canvas.height);
                    ctx.stroke();
                });
            } else if (type === 'golden') {
                const phi = 0.618;
                [phi, 1-phi].forEach(r => {
                    ctx.beginPath();
                    ctx.moveTo(0, canvas.height * r);
                    ctx.lineTo(canvas.width, canvas.height * r);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(canvas.width * r, 0);
                    ctx.lineTo(canvas.width * r, canvas.height);
                    ctx.stroke();
                });
            }
            
            ctx.setLineDash([]);
            showToast('üìç ÂèÉËÄÉÁ∑öÂ∑≤Âä†ÂÖ•');
        }
        
        function clearGuides() {
            guides = [];
            undoAction();
            showToast('üóëÔ∏è ÂèÉËÄÉÁ∑öÂ∑≤Ê∏ÖÈô§');
        }
        
        // ===== Â∞çÈΩäÂ∑•ÂÖ∑ =====
        function showAlignPanel() {
            togglePanel('alignPanel', 'alignBtn');
        }
        
        function alignSelection(alignment) {
            if (!currentSelection) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÈÅ∏ÂèñÂçÄÂüü');
                return;
            }
            
            // Â∞çÈΩäÈÇèËºØ
            showToast('üìê Â∞çÈΩäÂäüËÉΩ');
        }
        
        // ===== Ëâ≤Áâà =====
        function showChannelPanel() {
            togglePanel('channelPanel', 'channelBtn');
        }
        
        function showChannel(channel) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                if (channel === 'r') {
                    data[i+1] = data[i+2] = 0;
                } else if (channel === 'g') {
                    data[i] = data[i+2] = 0;
                } else if (channel === 'b') {
                    data[i] = data[i+1] = 0;
                } else if (channel === 'alpha') {
                    const a = data[i+3];
                    data[i] = data[i+1] = data[i+2] = a;
                    data[i+3] = 255;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üì∫ È°ØÁ§∫ ' + channel + ' Ëâ≤Áâà');
        }
        
        // ===== Ëá™ÂãïÂäüËÉΩ =====
        function autoEnhance() {
            saveHistory();
            autoLevel();
            autoContrast();
            showToast('‚ú® Ëá™ÂãïÂ¢ûÂº∑ÂÆåÊàê');
        }
        
        function autoColor() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let avgR = 0, avgG = 0, avgB = 0;
            const count = data.length / 4;
            
            for (let i = 0; i < data.length; i += 4) {
                avgR += data[i];
                avgG += data[i+1];
                avgB += data[i+2];
            }
            
            avgR /= count; avgG /= count; avgB /= count;
            const avg = (avgR + avgG + avgB) / 3;
            
            const scaleR = avg / avgR;
            const scaleG = avg / avgG;
            const scaleB = avg / avgB;
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, data[i] * scaleR);
                data[i+1] = Math.min(255, data[i+1] * scaleG);
                data[i+2] = Math.min(255, data[i+2] * scaleB);
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üåà Ëá™ÂãïËâ≤ÂΩ©ÂÆåÊàê');
        }
        
        function autoContrast() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let min = 255, max = 0;
            for (let i = 0; i < data.length; i += 4) {
                const lum = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                min = Math.min(min, lum);
                max = Math.max(max, lum);
            }
            
            const scale = 255 / (max - min);
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, (data[i] - min) * scale));
                data[i+1] = Math.min(255, Math.max(0, (data[i+1] - min) * scale));
                data[i+2] = Math.min(255, Math.max(0, (data[i+2] - min) * scale));
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üé≠ Ëá™ÂãïÂ∞çÊØîÂÆåÊàê');
        }
        
        function autoLevel() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Ë®àÁÆóÊØèÂÄãÈÄöÈÅìÁöÑÁõ¥ÊñπÂúñ
            let histR = new Array(256).fill(0);
            let histG = new Array(256).fill(0);
            let histB = new Array(256).fill(0);
            
            for (let i = 0; i < data.length; i += 4) {
                histR[data[i]]++;
                histG[data[i+1]]++;
                histB[data[i+2]]++;
            }
            
            // ÊâæÂá∫ 1% Âíå 99% ÁöÑÈñæÂÄº
            const pixels = data.length / 4;
            const threshold = pixels * 0.01;
            
            function findBounds(hist) {
                let sum = 0, min = 0, max = 255;
                for (let i = 0; i < 256; i++) {
                    sum += hist[i];
                    if (sum > threshold) { min = i; break; }
                }
                sum = 0;
                for (let i = 255; i >= 0; i--) {
                    sum += hist[i];
                    if (sum > threshold) { max = i; break; }
                }
                return { min, max };
            }
            
            const boundsR = findBounds(histR);
            const boundsG = findBounds(histG);
            const boundsB = findBounds(histB);
            
            // Êãâ‰º∏Ëâ≤Èöé
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, (data[i] - boundsR.min) * 255 / (boundsR.max - boundsR.min)));
                data[i+1] = Math.min(255, Math.max(0, (data[i+1] - boundsG.min) * 255 / (boundsG.max - boundsG.min)));
                data[i+2] = Math.min(255, Math.max(0, (data[i+2] - boundsB.min) * 255 / (boundsB.max - boundsB.min)));
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üìä Ëá™ÂãïËâ≤ÈöéÂÆåÊàê');
        }
        
        // ===== HDR ÊïàÊûú =====
        function applyHDR() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // Â±ÄÈÉ®Â∞çÊØîÂ¢ûÂº∑
                const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                const factor = 1.5;
                
                data[i] = Math.min(255, Math.max(0, avg + (data[i] - avg) * factor));
                data[i+1] = Math.min(255, Math.max(0, avg + (data[i+1] - avg) * factor));
                data[i+2] = Math.min(255, Math.max(0, avg + (data[i+2] - avg) * factor));
                
                // Â¢ûÂä†È£ΩÂíåÂ∫¶
                const satFactor = 1.3;
                const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                data[i] = Math.min(255, Math.max(0, gray + (data[i] - gray) * satFactor));
                data[i+1] = Math.min(255, Math.max(0, gray + (data[i+1] - gray) * satFactor));
                data[i+2] = Math.min(255, Math.max(0, gray + (data[i+2] - gray) * satFactor));
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üåü HDR ÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        // ===== Êõ¥Â§öËóùË°ìÊïàÊûú =====
        function applyOutlineEffect() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            applyConvolution(imageData, [-1, -1, -1, -1, 8, -1, -1, -1, -1]);
            ctx.putImageData(imageData, 0, 0);
            showToast('‚úèÔ∏è ÊèèÈÇäÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        function applyLowPoly() {
            saveHistory();
            // Á∞°ÂåñÁöÑ‰ΩéÂ§öÈÇäÂΩ¢ÊïàÊûú
            const blockSize = 20;
            
            for (let y = 0; y < canvas.height; y += blockSize) {
                for (let x = 0; x < canvas.width; x += blockSize) {
                    const pixel = ctx.getImageData(x + blockSize/2, y + blockSize/2, 1, 1).data;
                    ctx.fillStyle = `rgb(${pixel[0]},${pixel[1]},${pixel[2]})`;
                    
                    // Áï´‰∏âËßíÂΩ¢
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x + blockSize, y);
                    ctx.lineTo(x + blockSize/2, y + blockSize);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(x, y + blockSize);
                    ctx.lineTo(x + blockSize/2, y + blockSize);
                    ctx.lineTo(x, y);
                    ctx.closePath();
                    ctx.fill();
                }
            }
            
            showToast('üî∫ ‰ΩéÂ§öÈÇäÂΩ¢ÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        function applyMiniature() {
            saveHistory();
            // Â¢ûÂä†È£ΩÂíåÂ∫¶
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                data[i] = Math.min(255, avg + (data[i] - avg) * 1.5);
                data[i+1] = Math.min(255, avg + (data[i+1] - avg) * 1.5);
                data[i+2] = Math.min(255, avg + (data[i+2] - avg) * 1.5);
            }
            ctx.putImageData(imageData, 0, 0);
            
            // ÁßªËª∏Ê®°Á≥ä
            applyTiltShift();
            
            showToast('üè† ÂæÆÁ∏ÆÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        function applyInfrared() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // ‰∫§ÊèõÁ¥ÖËóçËâ≤‰∏¶Â¢ûÂº∑
                const r = data[i], g = data[i+1], b = data[i+2];
                data[i] = Math.min(255, b * 1.5);
                data[i+1] = g;
                data[i+2] = Math.min(255, r * 0.5);
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üî¥ Á¥ÖÂ§ñÁ∑öÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        function applyCrossProcess() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // ‰∫§ÂèâÊ≤ñÂç∞ÊïàÊûú
                data[i] = Math.min(255, data[i] * 1.1 + 20);
                data[i+1] = Math.min(255, data[i+1] * 0.9);
                data[i+2] = Math.min(255, data[i+2] * 1.2 + 30);
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üéûÔ∏è ‰∫§ÂèâÊ≤ñÂç∞ÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        function applyBleachBypass() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const lum = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                // Ê∏õÂ∞ëÈ£ΩÂíåÂ∫¶ÔºåÂ¢ûÂä†Â∞çÊØî
                data[i] = Math.min(255, lum * 0.5 + data[i] * 0.5 + (data[i] - 128) * 0.3);
                data[i+1] = Math.min(255, lum * 0.5 + data[i+1] * 0.5 + (data[i+1] - 128) * 0.3);
                data[i+2] = Math.min(255, lum * 0.5 + data[i+2] * 0.5 + (data[i+2] - 128) * 0.3);
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ü•õ ÊºÇÁôΩÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        // ===== ÂàÜÈõ¢Ëâ≤Ë™ø =====
        function showSplitTonePanel() {
            togglePanel('splitTonePanel', 'splitToneBtn');
        }
        
        function applySplitTone() {
            saveHistory();
            const highlightTone = hexToRgb(document.getElementById('highlightTone')?.value || '#ffd700');
            const shadowTone = hexToRgb(document.getElementById('shadowTone')?.value || '#4169e1');
            const highlightSat = parseInt(document.getElementById('highlightSat')?.value || 25) / 100;
            const shadowSat = parseInt(document.getElementById('shadowSat')?.value || 25) / 100;
            const balance = parseInt(document.getElementById('toneBalance')?.value || 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const lum = (data[i] + data[i+1] + data[i+2]) / 3 / 255;
                const threshold = 0.5 + balance / 200;
                
                if (lum > threshold) {
                    const factor = (lum - threshold) / (1 - threshold) * highlightSat;
                    data[i] = data[i] * (1 - factor) + highlightTone.r * factor;
                    data[i+1] = data[i+1] * (1 - factor) + highlightTone.g * factor;
                    data[i+2] = data[i+2] * (1 - factor) + highlightTone.b * factor;
                } else {
                    const factor = (threshold - lum) / threshold * shadowSat;
                    data[i] = data[i] * (1 - factor) + shadowTone.r * factor;
                    data[i+1] = data[i+1] * (1 - factor) + shadowTone.g * factor;
                    data[i+2] = data[i+2] * (1 - factor) + shadowTone.b * factor;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üé® ÂàÜÈõ¢Ëâ≤Ë™øÂ∑≤Â•óÁî®');
        }
        
        // ===== ÈõªÂΩ±Ë™øËâ≤ =====
        function showColorGradePanel() {
            togglePanel('colorGradePanel', 'colorGradeBtn');
        }
        
        function applyColorGrade(preset) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                
                switch(preset) {
                    case 'teal-orange':
                        const lum = 0.299 * r + 0.587 * g + 0.114 * b;
                        if (lum > 128) {
                            data[i] = Math.min(255, r * 1.1 + 20);
                            data[i+1] = Math.min(255, g * 0.9);
                        } else {
                            data[i+1] = Math.min(255, g * 1.1);
                            data[i+2] = Math.min(255, b * 1.2 + 10);
                        }
                        break;
                    case 'noir':
                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        const contrast = (gray - 128) * 1.5 + 128;
                        data[i] = data[i+1] = data[i+2] = Math.min(255, Math.max(0, contrast));
                        break;
                    case 'matrix':
                        data[i] = Math.min(255, r * 0.3);
                        data[i+1] = Math.min(255, g * 1.2 + 20);
                        data[i+2] = Math.min(255, b * 0.3);
                        break;
                    case 'sepia-cinema':
                        data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189 + 20);
                        data[i+1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                        data[i+2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131 - 10);
                        break;
                    case 'blade-runner':
                        data[i] = Math.min(255, r * 0.9 + 30);
                        data[i+1] = Math.min(255, g * 0.7);
                        data[i+2] = Math.min(255, b * 1.3 + 40);
                        break;
                    case 'horror':
                        data[i+1] = Math.min(255, g * 0.7);
                        data[i+2] = Math.min(255, b * 0.7);
                        break;
                    case 'romance':
                        data[i] = Math.min(255, r * 1.1 + 10);
                        data[i+1] = Math.min(255, g * 1.05);
                        data[i+2] = Math.min(255, b * 1.1 + 10);
                        break;
                    case 'action':
                        const actionContrast = 1.3;
                        data[i] = Math.min(255, (r - 128) * actionContrast + 128 + 10);
                        data[i+1] = Math.min(255, (g - 128) * actionContrast + 128);
                        data[i+2] = Math.min(255, (b - 128) * actionContrast + 128 - 10);
                        break;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üé¨ ÈõªÂΩ±Ë™øËâ≤Â∑≤Â•óÁî®');
        }
        
        // ===== LUT =====
        function showLutPanel() {
            togglePanel('lutPanel', 'lutBtn');
        }
        
        function applyLut(preset) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i], g = data[i+1], b = data[i+2];
                
                switch(preset) {
                    case 'fuji': // ÂØåÂ£´ÔºöÊüîÂíåÁ∂†Ëâ≤ÔºåËÜöËâ≤Ëá™ÁÑ∂
                        r = Math.min(255, r * 0.98);
                        g = Math.min(255, g * 1.05 + 5);
                        b = Math.min(255, b * 0.95);
                        break;
                    case 'kodak': // ÊüØÈÅîÔºöÊöñËâ≤Ë™øÔºåÈáëÈªÉ
                        r = Math.min(255, r * 1.08 + 10);
                        g = Math.min(255, g * 1.02 + 5);
                        b = Math.min(255, b * 0.9);
                        break;
                    case 'cinematic': // ÈõªÂΩ±ÊÑüÔºöÈùíÊ©ôÂàÜÈõ¢
                        const lum = 0.299 * r + 0.587 * g + 0.114 * b;
                        if (lum > 128) {
                            r = Math.min(255, r * 1.1 + 15);
                            g = Math.min(255, g * 0.95);
                        } else {
                            g = Math.min(255, g * 1.05);
                            b = Math.min(255, b * 1.15 + 10);
                        }
                        break;
                    case 'portrait': // ‰∫∫ÂÉèÔºöËÜöËâ≤ÂÑ™Âåñ
                        const warmth = 1.05;
                        r = Math.min(255, r * warmth + 8);
                        g = Math.min(255, g * 1.02 + 3);
                        b = Math.min(255, b * 0.98);
                        break;
                }
                
                data[i] = r;
                data[i+1] = g;
                data[i+2] = b;
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            const lutNames = {
                'fuji': 'Fuji ÂØåÂ£´',
                'kodak': 'Kodak ÊüØÈÅî',
                'cinematic': 'ÈõªÂΩ±ÊÑü',
                'portrait': '‰∫∫ÂÉè'
            };
            showToast('üé• ' + (lutNames[preset] || preset) + ' LUT Â∑≤Â•óÁî®');
        }
        
        // ===== Âæ©Âè§ÊïàÊûú =====
        function showVintagePanel() {
            togglePanel('vintagePanel', 'vintageBtn');
        }
        
        function applyVintagePreset(era) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                switch(era) {
                    case '60s':
                        data[i] = Math.min(255, data[i] * 1.1);
                        data[i+1] = Math.min(255, data[i+1] * 1.05);
                        data[i+2] = Math.max(0, data[i+2] * 0.8);
                        break;
                    case '70s':
                        data[i] = Math.min(255, data[i] * 1.1 + 20);
                        data[i+1] = Math.min(255, data[i+1] * 0.9 + 10);
                        data[i+2] = Math.max(0, data[i+2] * 0.7);
                        break;
                    case '80s':
                        data[i] = Math.min(255, data[i] * 1.2);
                        data[i+2] = Math.min(255, data[i+2] * 1.2);
                        break;
                    case '90s':
                        const g90 = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = data[i] * 0.8 + g90 * 0.2;
                        data[i+1] = data[i+1] * 0.8 + g90 * 0.2;
                        data[i+2] = data[i+2] * 0.8 + g90 * 0.2;
                        break;
                    case 'polaroid':
                        data[i] = Math.min(255, data[i] * 1.1 + 10);
                        data[i+1] = Math.min(255, data[i+1] * 1.05 + 5);
                        data[i+2] = Math.min(255, data[i+2] * 0.9);
                        break;
                    case 'daguerreotype':
                        const dagGray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                        data[i] = Math.min(255, dagGray * 1.1 + 20);
                        data[i+1] = Math.min(255, dagGray * 0.95 + 10);
                        data[i+2] = Math.min(255, dagGray * 0.8);
                        break;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üìª Âæ©Âè§ÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        // ===== Â∫ïÁâáÊ®°Êì¨ =====
        function showFilmPanel() {
            togglePanel('filmPanel', 'filmBtn');
        }
        
        function applyFilm(film) {
            applyFilmEffect(film);
        }
        
        function applyFilmEffect(film) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i], g = data[i+1], b = data[i+2];
                
                switch(film) {
                    case 'portra400': // ÊüîÂíåËÜöËâ≤Ôºå‰ΩéÂ∞çÊØî
                        r = Math.min(255, r * 1.05 + 5);
                        g = Math.min(255, g * 1.02);
                        b = Math.min(255, b * 0.95);
                        break;
                    case 'ektar100': // È´òÈ£ΩÂíåÔºåÈÆÆË±î
                        const satE = 1.3;
                        const grayE = 0.299 * r + 0.587 * g + 0.114 * b;
                        r = Math.min(255, grayE + (r - grayE) * satE);
                        g = Math.min(255, grayE + (g - grayE) * satE);
                        b = Math.min(255, grayE + (b - grayE) * satE);
                        break;
                    case 'velvia50': // Ë∂ÖÈ´òÈ£ΩÂíåÔºåÂÅèÁ∂†
                        const satV = 1.4;
                        const grayV = 0.299 * r + 0.587 * g + 0.114 * b;
                        r = Math.min(255, grayV + (r - grayV) * satV);
                        g = Math.min(255, grayV + (g - grayV) * satV * 1.1);
                        b = Math.min(255, grayV + (b - grayV) * satV);
                        break;
                    case 'provia100': // Ëá™ÁÑ∂Ëâ≤ÂΩ©
                        r = Math.min(255, r * 1.02);
                        g = Math.min(255, g * 1.05);
                        b = Math.min(255, b * 1.08);
                        break;
                    case 'cinestill800': // ÊöñËâ≤Ë™øÔºåÈúìËôπÂÖâÊöà
                        r = Math.min(255, r * 1.15 + 10);
                        g = Math.min(255, g * 0.95);
                        b = Math.min(255, b * 0.85);
                        break;
                    case 'trix400': // ÈªëÁôΩÈ´òÂ∞çÊØî
                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        const contrast = (gray - 128) * 1.3 + 128;
                        r = g = b = Math.min(255, Math.max(0, contrast));
                        break;
                }
                
                data[i] = r;
                data[i+1] = g;
                data[i+2] = b;
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            const filmNames = {
                'portra400': 'Portra 400',
                'ektar100': 'Ektar 100',
                'velvia50': 'Velvia 50',
                'provia100': 'Provia 100',
                'cinestill800': 'CineStill 800',
                'trix400': 'Tri-X 400'
            };
            showToast('üéûÔ∏è ' + (filmNames[film] || film) + ' Â∫ïÁâáÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        // ===== ÈõªÂΩ±ÊïàÊûú =====
        function showCinemaPanel() {
            togglePanel('cinemaPanel', 'cinemaBtn');
        }
        
        function applyCinemaEffect() {
            saveHistory();
            const letterbox = document.getElementById('cinemaLetterbox')?.checked;
            const grain = document.getElementById('cinemaGrain')?.checked;
            const vignette = document.getElementById('cinemaVignette')?.checked;
            const ratio = parseFloat(document.getElementById('cinemaRatio')?.value || 2.35);
            
            if (letterbox) {
                const targetH = canvas.width / ratio;
                const barHeight = (canvas.height - targetH) / 2;
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, canvas.width, barHeight);
                ctx.fillRect(0, canvas.height - barHeight, canvas.width, barHeight);
            }
            
            if (grain) {
                applyNoise();
            }
            
            if (vignette) {
                applyVignette();
            }
            
            showToast('üé¨ ÈõªÂΩ±ÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        // ===== ÂàóÂç∞ =====
        function showPrintPanel() {
            togglePanel('printPanel', 'printBtn');
            // Êõ¥Êñ∞È†êË¶ΩÂúñ
            updatePrintPreview();
        }
        
        function updatePrintPreview() {
            const previewImg = document.getElementById('printPreviewImg');
            if (previewImg && canvas.width > 0) {
                previewImg.src = canvas.toDataURL('image/png');
            }
        }
        
        function printImage() {
            if (!currentImage && canvas.width === 300) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàËºâÂÖ•ÂúñÁâá');
                return;
            }
            
            const printSize = document.getElementById('printSize').value;
            const fitPage = document.getElementById('printFitPage').checked;
            
            // Á¥ôÂºµÂ∞∫ÂØ∏Ôºàmm ËΩâ pxÔºåÂÅáË®≠ 96dpiÔºâ
            const sizes = {
                'a4': { w: 794, h: 1123 },
                'a3': { w: 1123, h: 1587 },
                'letter': { w: 816, h: 1056 },
                'photo4x6': { w: 384, h: 576 },
                'photo5x7': { w: 480, h: 672 }
            };
            
            const size = sizes[printSize] || sizes['a4'];
            const isLandscape = canvas.width > canvas.height;
            
            let imgStyle = 'max-width:100%; max-height:100vh;';
            if (fitPage) {
                if (isLandscape) {
                    imgStyle = `width:${size.h}px; height:auto; max-height:${size.w}px;`;
                } else {
                    imgStyle = `width:auto; height:${size.h}px; max-width:${size.w}px;`;
                }
            }
            
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ÂúñÊñáÈ≠îË°ìÂ∏´ - ÂàóÂç∞</title>
                    <style>
                        @media print {
                            @page { 
                                size: ${printSize === 'letter' ? 'letter' : printSize.toUpperCase()} ${isLandscape ? 'landscape' : 'portrait'}; 
                                margin: 10mm;
                            }
                            body { margin: 0; }
                            .no-print { display: none !important; }
                        }
                        body {
                            margin: 0;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            min-height: 100vh;
                            background: #f0f0f0;
                            font-family: sans-serif;
                        }
                        .print-container {
                            background: white;
                            padding: 20px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        }
                        .print-btn {
                            margin: 20px;
                            padding: 15px 40px;
                            font-size: 18px;
                            background: #4CAF50;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                        }
                        .print-btn:hover { background: #45a049; }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="text-align:center;margin-bottom:10px;">
                        <h2>üñ®Ô∏è ÂàóÂç∞È†êË¶Ω</h2>
                        <p>Á¥ôÂºµ: ${printSize.toUpperCase()} | ÊñπÂêë: ${isLandscape ? 'Ê©´Âêë' : 'Áõ¥Âêë'}</p>
                    </div>
                    <div class="print-container">
                        <img src="${canvas.toDataURL('image/png')}" style="${imgStyle}">
                    </div>
                    <button class="print-btn no-print" onclick="window.print()">üñ®Ô∏è ÂàóÂç∞</button>
                    <p class="no-print" style="color:#666;font-size:12px;">ÈªûÊìä‰∏äÊñπÊåâÈàïÊàñÊåâ Ctrl+P ÈñãÂïüÂàóÂç∞Â∞çË©±Ê°Ü</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            showToast('üñ®Ô∏è Â∑≤ÈñãÂïüÂàóÂç∞Ë¶ñÁ™ó');
        }
        
        // ===== ÂàÜ‰∫´ =====
        function showSharePanel() {
            togglePanel('sharePanel', 'shareBtn');
        }
        
        // Á≥ªÁµ±ÂéüÁîüÂàÜ‰∫´
        async function shareNative() {
            if (!navigator.share) {
                showToast('‚ö†Ô∏è ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Á≥ªÁµ±ÂàÜ‰∫´');
                return;
            }
            
            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const file = new File([blob], 'image.png', { type: 'image/png' });
                
                await navigator.share({
                    title: 'ÂúñÊñáÈ≠îË°ìÂ∏´',
                    text: 'ÂàÜ‰∫´ÊàëÁöÑÂúñÁâá',
                    files: [file]
                });
                showToast('‚úÖ ÂàÜ‰∫´ÊàêÂäü');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showToast('‚ùå ÂàÜ‰∫´Â§±Êïó');
                }
            }
        }
        
        // Ë§áË£ΩÂúñÁâáÂà∞Ââ™Ë≤ºÁ∞ø
        async function copyToClipboard() {
            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);
                showToast('‚úÖ Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø');
            } catch (err) {
                showToast('‚ö†Ô∏è Ë§áË£ΩÂ§±ÊïóÔºåË´ã‰ΩøÁî®‰∏ãËºâÂäüËÉΩ');
            }
        }
        
        function shareToFacebook() {
            showToast('üìò ÂàÜ‰∫´Âà∞ Facebook - ÈúÄË¶ÅÂÖà‰∏äÂÇ≥ÂúñÁâá');
        }
        
        function shareToTwitter() {
            showToast('üê¶ ÂàÜ‰∫´Âà∞ Twitter - ÈúÄË¶ÅÂÖà‰∏äÂÇ≥ÂúñÁâá');
        }
        
        function shareToLine() {
            sendToLine();
        }
        
        function shareToEmail() {
            const dataUrl = canvas.toDataURL('image/png');
            window.location.href = `mailto:?subject=ÂúñÊñáÈ≠îË°ìÂ∏´&body=Ë´ãÊü•ÁúãÈôÑ‰ª∂ÂúñÁâá`;
            showToast('üìß ÈñãÂïüÈÉµ‰ª∂Áî®Êà∂Á´Ø');
        }
        
        function copyShareLink() {
            showToast('üîó ÈúÄË¶ÅÂÖà‰∏äÂÇ≥Âà∞Èõ≤Á´Ø');
        }
        
        function downloadQrShare() {
            showToast('üì± ÈúÄË¶ÅÂÖà‰∏äÂÇ≥Âà∞Èõ≤Á´Ø');
        }
        
        // ===== Èõ≤Á´Ø =====
        function showCloudPanel() {
            togglePanel('cloudPanel', 'cloudBtn');
            // ËºâÂÖ•Â∑≤‰øùÂ≠òÁöÑ API Key
            const savedKey = localStorage.getItem('imgbbApiKey');
            if (savedKey) {
                document.getElementById('imgbbApiKey').value = savedKey;
            }
        }
        
        // ‰∏äÂÇ≥Âà∞ ImgBB
        async function uploadToImgBB() {
            const apiKey = document.getElementById('imgbbApiKey').value.trim();
            
            if (!apiKey) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàËº∏ÂÖ• ImgBB API Key');
                // ÈñãÂïüÂèñÂæó API Key ÁöÑÁ∂≤È†Å
                window.open('https://api.imgbb.com/', '_blank');
                return;
            }
            
            if (!currentImage && canvas.width === 300) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàËºâÂÖ•ÂúñÁâá');
                return;
            }
            
            // ‰øùÂ≠ò API Key
            localStorage.setItem('imgbbApiKey', apiKey);
            
            showToast('üì§ ‰∏äÂÇ≥‰∏≠...');
            
            try {
                // ËΩâÊèõÁÇ∫ base64
                const dataUrl = canvas.toDataURL('image/png');
                const base64 = dataUrl.split(',')[1];
                
                const formData = new FormData();
                formData.append('key', apiKey);
                formData.append('image', base64);
                formData.append('name', 'image_' + Date.now());
                
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const url = data.data.url;
                    const deleteUrl = data.data.delete_url;
                    const resultDiv = document.getElementById('cloudResult');
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <div style="word-break:break-all;">
                            <strong style="color:#4CAF50;">‚úÖ ‰∏äÂÇ≥ÊàêÂäüÔºÅ</strong><br><br>
                            <div style="margin-bottom:8px;">
                                <label style="font-size:11px;color:var(--text-secondary);">ÂúñÁâáÈÄ£ÁµêÔºö</label><br>
                                <a href="${url}" target="_blank" style="color:var(--primary);font-size:12px;">${url}</a>
                            </div>
                            <div style="margin-bottom:8px;">
                                <label style="font-size:11px;color:var(--text-secondary);">Áõ¥Êé•ÈÄ£ÁµêÔºö</label><br>
                                <span style="font-size:12px;color:var(--text-primary);">${data.data.display_url}</span>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
                            <button onclick="navigator.clipboard.writeText('${url}');showToast('‚úÖ Â∑≤Ë§áË£ΩÈÄ£Áµê')" style="padding:6px 12px;background:var(--primary);color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üìã Ë§áË£ΩÈÄ£Áµê</button>
                            <button onclick="navigator.clipboard.writeText('${data.data.display_url}');showToast('‚úÖ Â∑≤Ë§áË£ΩÁõ¥Êé•ÈÄ£Áµê')" style="padding:6px 12px;background:#17a2b8;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üîó Ë§áË£ΩÁõ¥ÈÄ£</button>
                            <button onclick="window.open('${url}','_blank')" style="padding:6px 12px;background:#28a745;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">üåê ÈñãÂïü</button>
                        </div>
                    `;
                    showToast('‚úÖ ‰∏äÂÇ≥ÊàêÂäüÔºÅ');
                } else {
                    throw new Error(data.error?.message || '‰∏äÂÇ≥Â§±Êïó');
                }
            } catch (err) {
                const resultDiv = document.getElementById('cloudResult');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<strong style="color:#f44336;">‚ùå ‰∏äÂÇ≥Â§±Êïó</strong><br><span style="font-size:12px;">${err.message}</span>`;
                showToast('‚ùå ‰∏äÂÇ≥Â§±ÊïóÔºö' + err.message);
            }
        }
        
        // Â≠òÂà∞ÁÄèË¶ΩÂô® LocalStorage
        function saveToLocalStorage() {
            try {
                const dataUrl = canvas.toDataURL('image/png');
                const saves = JSON.parse(localStorage.getItem('imageMagicSaves') || '[]');
                saves.unshift({
                    id: Date.now(),
                    data: dataUrl,
                    date: new Date().toLocaleString()
                });
                // ÊúÄÂ§ö‰øùÂ≠ò 5 Âºµ
                if (saves.length > 5) saves.pop();
                localStorage.setItem('imageMagicSaves', JSON.stringify(saves));
                showToast('‚úÖ Â∑≤Â≠òÂà∞ÁÄèË¶ΩÂô®ÔºàÊúÄÂ§ö‰øùÂ≠ò 5 ÂºµÔºâ');
            } catch (err) {
                showToast('‚ùå ÂÑ≤Â≠òÂ§±ÊïóÔºåÂèØËÉΩÁ©∫Èñì‰∏çË∂≥');
            }
        }
        
        // ÂæûÁÄèË¶ΩÂô®ËºâÂÖ•
        function loadFromLocalStorage() {
            const saves = JSON.parse(localStorage.getItem('imageMagicSaves') || '[]');
            if (saves.length === 0) {
                showToast('‚ö†Ô∏è Ê≤íÊúâÂ∑≤‰øùÂ≠òÁöÑÂúñÁâá');
                return;
            }
            
            const resultDiv = document.getElementById('cloudResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<strong>üìÇ Â∑≤‰øùÂ≠òÁöÑÂúñÁâáÔºö</strong><br>' + 
                saves.map((s, i) => `
                    <div style="display:flex;align-items:center;gap:10px;margin-top:8px;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;">
                        <img src="${s.data}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
                        <div style="flex:1;font-size:11px;">${s.date}</div>
                        <button onclick="loadSavedImage(${i})" style="padding:4px 8px;background:var(--primary);color:white;border:none;border-radius:4px;cursor:pointer;">ËºâÂÖ•</button>
                        <button onclick="deleteSavedImage(${i})" style="padding:4px 8px;background:#f44;color:white;border:none;border-radius:4px;cursor:pointer;">üóëÔ∏è</button>
                    </div>
                `).join('');
        }
        
        function loadSavedImage(index) {
            const saves = JSON.parse(localStorage.getItem('imageMagicSaves') || '[]');
            if (saves[index]) {
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    currentImage = img;
                    showToast('‚úÖ ÂúñÁâáÂ∑≤ËºâÂÖ•');
                };
                img.src = saves[index].data;
            }
        }
        
        function deleteSavedImage(index) {
            const saves = JSON.parse(localStorage.getItem('imageMagicSaves') || '[]');
            saves.splice(index, 1);
            localStorage.setItem('imageMagicSaves', JSON.stringify(saves));
            loadFromLocalStorage();
            showToast('üóëÔ∏è Â∑≤Âà™Èô§');
        }
        
        function saveToCloudinary() {
            showToast('‚òÅÔ∏è Cloudinary ‰∏äÂÇ≥ÈúÄË¶ÅË®≠ÂÆö');
        }
        
        // ===== Âø´Êç∑Èçµ =====
        function showShortcutPanel() {
            togglePanel('shortcutPanel', 'shortcutBtn');
        }
        
        // ===== Ë™™Êòé =====
        function showHelpPanel() {
            togglePanel('helpPanel', 'helpBtn');
        }
        
        // ===== ‰∏ªÈ°åÂàáÊèõ =====
        let darkMode = true;
        
        function toggleTheme() {
            darkMode = !darkMode;
            document.documentElement.style.setProperty('--bg-dark', darkMode ? '#0a0a1a' : '#f5f5f5');
            document.documentElement.style.setProperty('--bg-card', darkMode ? '#1a1a2e' : '#ffffff');
            document.documentElement.style.setProperty('--text-primary', darkMode ? '#ffffff' : '#333333');
            showToast('üé® ‰∏ªÈ°åÂ∑≤ÂàáÊèõ');
        }
        
        // ===== Ë™ûË®ÄÂàáÊèõ =====
        function toggleLang() {
            showToast('üåê Ë™ûË®ÄÂàáÊèõÂäüËÉΩÈñãÁôº‰∏≠');
        }
        
        // ===== Â±ÄÈÉ®ÂΩ©Ëâ≤ =====
        function showColorSplashPanel() {
            togglePanel('colorSplashPanel', 'colorSplashBtn');
        }
        
        function applyColorSplash() {
            saveHistory();
            const keepColor = hexToRgb(document.getElementById('splashColor')?.value || '#ff0000');
            const tolerance = parseInt(document.getElementById('splashTolerance')?.value || 30);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const diff = Math.abs(r - keepColor.r) + Math.abs(g - keepColor.g) + Math.abs(b - keepColor.b);
                
                if (diff > tolerance * 3) {
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    data[i] = data[i+1] = data[i+2] = gray;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üí¶ Â±ÄÈÉ®ÂΩ©Ëâ≤ÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        // ===== ÈªûÈô£ÂúñËóùË°ì =====
        function showDotArtPanel() {
            togglePanel('dotArtPanel', 'dotArtBtn');
        }
        
        function applyDotArt() {
            saveHistory();
            const dotSize = parseInt(document.getElementById('dotSize')?.value || 8);
            const spacing = parseInt(document.getElementById('dotSpacing')?.value || 10);
            const shape = document.getElementById('dotShape')?.value || 'circle';
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            for (let y = spacing/2; y < canvas.height; y += spacing) {
                for (let x = spacing/2; x < canvas.width; x += spacing) {
                    const pixel = tempCtx.getImageData(x, y, 1, 1).data;
                    ctx.fillStyle = `rgb(${pixel[0]},${pixel[1]},${pixel[2]})`;
                    
                    if (shape === 'circle') {
                        ctx.beginPath();
                        ctx.arc(x, y, dotSize/2, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (shape === 'square') {
                        ctx.fillRect(x - dotSize/2, y - dotSize/2, dotSize, dotSize);
                    } else if (shape === 'diamond') {
                        ctx.beginPath();
                        ctx.moveTo(x, y - dotSize/2);
                        ctx.lineTo(x + dotSize/2, y);
                        ctx.lineTo(x, y + dotSize/2);
                        ctx.lineTo(x - dotSize/2, y);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
            }
            
            showToast('‚ö´ ÈªûÈô£ÂúñËóùË°ìÂ∑≤Â•óÁî®');
        }
        
        // ===== ÁæéÈ°èÈÄ≤ÈöéÂäüËÉΩ =====
        function showSlimFacePanel() {
            togglePanel('slimFacePanel', 'slimFaceBtn');
        }
        
        function applySlimFace() {
            showToast('üßë Áò¶ËáâÂäüËÉΩÈúÄË¶Å‰∫∫ËáâÊ™¢Ê∏¨');
        }
        
        function showBigEyePanel() {
            togglePanel('bigEyePanel', 'bigEyeBtn');
        }
        
        function applyBigEye() {
            saveHistory();
            const amount = parseInt(document.getElementById('eyeEnlarge')?.value || 20);
            
            // Á∞°ÂåñÁöÑÊîæÂ§ßÊïàÊûúÔºàÁêÉÈù¢Âåñ‰∏≠ÂøÉÂçÄÂüüÔºâ
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 3;  // ÁúºÁùõÂ§ßÁ¥ÑÂú®‰∏ä1/3‰ΩçÁΩÆ
            const radius = Math.min(canvas.width, canvas.height) / 4;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const srcData = new Uint8ClampedArray(imageData.data);
            const data = imageData.data;
            
            const strength = amount / 100;
            
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const dx = x - centerX;
                    const dy = y - centerY;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < radius) {
                        const factor = 1 - (dist / radius) * strength * 0.5;
                        const srcX = Math.round(centerX + dx * factor);
                        const srcY = Math.round(centerY + dy * factor);
                        
                        if (srcX >= 0 && srcX < canvas.width && srcY >= 0 && srcY < canvas.height) {
                            const dstIdx = (y * canvas.width + x) * 4;
                            const srcIdx = (srcY * canvas.width + srcX) * 4;
                            data[dstIdx] = srcData[srcIdx];
                            data[dstIdx + 1] = srcData[srcIdx + 1];
                            data[dstIdx + 2] = srcData[srcIdx + 2];
                        }
                    }
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üëÄ Â§ßÁúºÊïàÊûúÂ∑≤Â•óÁî®ÔºàÊ®°Êì¨Ôºâ');
        }
        
        function showMakeupPanel() {
            togglePanel('makeupPanel', 'makeupBtn');
        }
        
        function applyMakeup(type) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Á∞°ÂåñÁöÑÂΩ©Â¶ùÊïàÊûúÔºàË™øÊï¥Ëâ≤Ë™øÔºâ
            switch(type) {
                case 'lipstick':
                    // Â¢ûÂä†Á¥ÖËâ≤È£ΩÂíåÂ∫¶ÔºàÊ®°Êì¨Âè£Á¥ÖÔºâ
                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i] > data[i+1] && data[i] > data[i+2]) {
                            data[i] = Math.min(255, data[i] * 1.3);
                        }
                    }
                    showToast('üíã Âè£Á¥ÖÊïàÊûúÂ∑≤Â•óÁî®ÔºàÊ®°Êì¨Ôºâ');
                    break;
                case 'blush':
                    // ‰∏≠ÈñìÂçÄÂüüÂä†Á≤âËâ≤
                    const cx = canvas.width / 2;
                    const cy = canvas.height / 2;
                    for (let y = 0; y < canvas.height; y++) {
                        for (let x = 0; x < canvas.width; x++) {
                            const dist = Math.sqrt((x-cx)**2 + (y-cy)**2);
                            if (dist < canvas.width/4) {
                                const idx = (y * canvas.width + x) * 4;
                                data[idx] = Math.min(255, data[idx] + 15);
                                data[idx+1] = Math.min(255, data[idx+1] + 5);
                            }
                        }
                    }
                    showToast('üå∏ ËÖÆÁ¥ÖÊïàÊûúÂ∑≤Â•óÁî®ÔºàÊ®°Êì¨Ôºâ');
                    break;
                case 'eyeshadow':
                    showToast('üëÅÔ∏è ÁúºÂΩ±ÈúÄË¶Å‰∫∫ËáâÊ™¢Ê∏¨ÂÆö‰Ωç');
                    return;
                case 'eyeliner':
                    showToast('‚úèÔ∏è ÁúºÁ∑öÈúÄË¶Å‰∫∫ËáâÊ™¢Ê∏¨ÂÆö‰Ωç');
                    return;
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        function showFaceSwapPanel() {
            togglePanel('faceSwapPanel', 'faceSwapBtn');
        }
        
        function applyFaceSwap() {
            showToast('üé≠ ÊèõËáâÂäüËÉΩÈúÄË¶ÅÈÄ≤Èöé AI Ê®°ÂûãÔºàÂ¶Ç InsightFaceÔºâ\nÁõÆÂâçÂ∞öÊú™Êï¥ÂêàÔºåÊï¨Ë´ãÊúüÂæÖÔºÅ');
        }
        
        function applyPortraitBlur() {
            showToast('üñºÔ∏è ‰∫∫ÂÉèÊ®°Á≥äÈúÄË¶Å‰∫∫È´îÊ™¢Ê∏¨');
        }
        
        function showSkeletonPanel() {
            togglePanel('skeletonPanel', 'skeletonBtn');
        }
        
        function detectSkeleton() {
            showToast('ü¶¥ È™®Êû∂Ê™¢Ê∏¨ÈúÄË¶Å AI ÂßøÊÖã‰º∞Ë®àÊ®°ÂûãÔºàÂ¶Ç PoseNetÔºâ\nÁõÆÂâçÂ∞öÊú™Êï¥ÂêàÔºåÊï¨Ë´ãÊúüÂæÖÔºÅ');
        }
        
        function showMosaicArtPanel() {
            // Áõ¥Êé•ÊáâÁî®È¶¨Ë≥ΩÂÖãËóùË°ìÊïàÊûú
            saveHistory();
            const blockSize = 10;
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let y = 0; y < canvas.height; y += blockSize) {
                for (let x = 0; x < canvas.width; x += blockSize) {
                    let r = 0, g = 0, b = 0, count = 0;
                    
                    // Ë®àÁÆóÂçÄÂ°äÂπ≥ÂùáËâ≤
                    for (let dy = 0; dy < blockSize && y + dy < canvas.height; dy++) {
                        for (let dx = 0; dx < blockSize && x + dx < canvas.width; dx++) {
                            const i = ((y + dy) * canvas.width + (x + dx)) * 4;
                            r += data[i];
                            g += data[i + 1];
                            b += data[i + 2];
                            count++;
                        }
                    }
                    
                    r = Math.round(r / count);
                    g = Math.round(g / count);
                    b = Math.round(b / count);
                    
                    // Â°´ÂÖÖÂçÄÂ°ä
                    for (let dy = 0; dy < blockSize && y + dy < canvas.height; dy++) {
                        for (let dx = 0; dx < blockSize && x + dx < canvas.width; dx++) {
                            const i = ((y + dy) * canvas.width + (x + dx)) * 4;
                            data[i] = r;
                            data[i + 1] = g;
                            data[i + 2] = b;
                        }
                    }
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üß± È¶¨Ë≥ΩÂÖãËóùË°ìÊïàÊûúÂ∑≤Â•óÁî®');
        }
        
        // ===== Â∞∫Ë¶è =====
        let rulerVisible = false;
        
        function toggleRuler() {
            rulerVisible = !rulerVisible;
            document.getElementById('rulerBtn')?.classList.toggle('active', rulerVisible);
            
            if (rulerVisible) {
                // Áï´Â∞∫Ë¶è
                ctx.strokeStyle = '#00ffff';
                ctx.lineWidth = 1;
                ctx.font = '10px sans-serif';
                ctx.fillStyle = '#00ffff';
                
                // ‰∏äÂ∞∫
                for (let x = 0; x < canvas.width; x += 50) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, 10);
                    ctx.stroke();
                    ctx.fillText(x.toString(), x + 2, 20);
                }
                
                // Â∑¶Â∞∫
                for (let y = 0; y < canvas.height; y += 50) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(10, y);
                    ctx.stroke();
                    ctx.fillText(y.toString(), 12, y + 10);
                }
                
                showToast('üìè Â∞∫Ë¶èÂ∑≤È°ØÁ§∫');
            } else {
                undoAction();
                showToast('üìè Â∞∫Ë¶èÂ∑≤Èö±Ëóè');
            }
        }
        
        // ===== ÈÄöÁî®Èù¢ÊùøÂàáÊèõ =====
        function togglePanel(panelId, btnId) {
            const panel = document.getElementById(panelId);
            const allPanels = [
                'aiPanel', 'pdfToolPanel', 'watermarkPanel', 'stampPanel', 'signPanel', 
                'filterPanel', 'adjustPanel', 'framePanel', 'stickerPanel', 'cropPanel', 
                'mergePanel', 'qrPanel', 'compressPanel', 'brushPanel', 'shapePanel',
                'textFxPanel', 'templatePanel', 'collagePanel', 'beautyPanel', 'removeBgPanel',
                'batchPanel', 'effectPanel', 'overlayPanel', 'annotatePanel', 'historyPanel',
                'infoPanel', 'colorReplacePanel', 'idPhotoPanel', 'screenshotPanel',
                'pixelArtPanel', 'asciiPanel', 'duotonePanel', 'gradientPanel', 'noisePanel',
                'blurBgPanel', 'texturePanel', 'bokehPanel', 'mirrorPanel', 'splitPanel',
                'socialPanel', 'exportPanel', 'memePanel', 'posterPanel', 'bannerPanel',
                'chartPanel', 'diagramPanel', 'timelinePanel', 'infographicPanel',
                'businessCardPanel', 'invoicePanel', 'certificatePanel', 'badgePanel',
                'avatarPanel', 'thumbnailPanel', 'coverPanel', 'mockupPanel', 'colorPalettePanel',
                'imageAnalysisPanel', 'aiEnhancePanel', 'aiStylePanel', 'aiObjectPanel',
                'aiCaptionPanel', 'drawingPanel', 'patternPanel', 'borderPanel', 'shadowPanel',
                'reflectionPanel', 'perspective3DPanel', 'warpPanel', 'liquifyPanel',
                'clonePanel', 'healPanel', 'redeyePanel', 'whiteBalancePanel', 'levelsPanel',
                'curvesPanel', 'channelMixerPanel', 'colorBalancePanel', 'vibranPanel',
                'hslPanel', 'splitTonePanel', 'lensPanel', 'chromaticPanel', 'filmGrainPanel',
                'arrowPanel', 'printPanel', 'sharePanel', 'cloudPanel', 'shortcutPanel', 'helpPanel',
                'colorGradePanel', 'lutPanel', 'vintagePanel', 'filmPanel', 'cinemaPanel',
                'splitTonePanel', 'eyeDropperAdvPanel', 'gifPanel',
                'photoFilterPanel', 'selectiveColorPanel', 'colorBalancePanel', 'histogramPanel',
                'curvePanel', 'liquifyPanel', 'layerPanel', 'channelPanel', 'alignPanel', 'guidePanel',
                'dotArtPanel', 'colorSplashPanel', 'slimFacePanel', 'bigEyePanel', 'makeupPanel',
                'faceSwapPanel', 'skeletonPanel', 'lensBlurPanel', 'motionBlurPanel', 'warpPanel',
                'perspectivePanel', 'distortPanel', 'cardPanel', 'logoPanel'
            ];
            
            // ÈóúÈñâÂÖ∂‰ªñÈù¢Êùø
            allPanels.forEach(p => {
                if (p !== panelId) {
                    const el = document.getElementById(p);
                    if (el) el.classList.remove('show');
                }
            });
            
            if (panel) {
                panel.classList.toggle('show');
                const btn = document.getElementById(btnId);
                if (btn) btn.classList.toggle('active', panel.classList.contains('show'));
            }
        }
        
        // ===== Ê¢óÂúñÁî¢ÁîüÂô® =====
        const memeTemplates = [
            { name: 'Á∂ìÂÖ∏‰∏ä‰∏ãÊñá', type: 'top-bottom', positions: ['top', 'bottom'] },
            { name: 'Â∑¶Âè≥Â∞çË©±', type: 'left-right', positions: ['left', 'right'] },
            { name: 'ÂõõÊ†ºÊº´Áï´', type: 'grid-4', positions: ['tl', 'tr', 'bl', 'br'] },
            { name: 'Â∞çÊØî', type: 'compare', positions: ['before', 'after'] },
            { name: 'ÊóÅÁôΩ', type: 'caption', positions: ['caption'] },
            { name: 'Ê≥°Ê≥°Â∞çË©±', type: 'bubble', positions: ['bubble1', 'bubble2'] }
        ];
        
        function showMemePanel() {
            togglePanel('memePanel', 'memeBtn');
            initMemeTemplates();
        }
        
        function initMemeTemplates() {
            const grid = document.getElementById('memeTemplateGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            memeTemplates.forEach((template, i) => {
                const item = document.createElement('button');
                item.className = 'meme-template';
                item.textContent = template.name;
                item.onclick = () => selectMemeTemplate(i);
                grid.appendChild(item);
            });
        }
        
        let currentMemeTemplate = null;
        
        function selectMemeTemplate(index) {
            currentMemeTemplate = memeTemplates[index];
            document.querySelectorAll('.meme-template').forEach((t, i) => {
                t.classList.toggle('active', i === index);
            });
            
            // È°ØÁ§∫ÊñáÂ≠óËº∏ÂÖ•Ê¨Ñ‰Ωç
            const inputs = document.getElementById('memeInputs');
            inputs.innerHTML = '';
            
            currentMemeTemplate.positions.forEach((pos, i) => {
                const label = document.createElement('label');
                label.textContent = `ÊñáÂ≠ó ${i + 1} (${pos})`;
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `memeText${i}`;
                input.className = 'wm-input';
                input.placeholder = `Ëº∏ÂÖ•Á¨¨ ${i + 1} ÊÆµÊñáÂ≠ó...`;
                inputs.appendChild(label);
                inputs.appendChild(input);
            });
        }
        
        function generateMeme() {
            if (!currentMemeTemplate) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÈÅ∏ÊìáÊ¢óÂúñÊ®°Êùø');
                return;
            }
            
            saveHistory();
            
            const fontSize = parseInt(document.getElementById('memeFontSize')?.value || 40);
            const fontColor = document.getElementById('memeFontColor')?.value || '#ffffff';
            const strokeColor = document.getElementById('memeStrokeColor')?.value || '#000000';
            
            ctx.font = `bold ${fontSize}px Impact, sans-serif`;
            ctx.fillStyle = fontColor;
            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = 3;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            currentMemeTemplate.positions.forEach((pos, i) => {
                const text = document.getElementById(`memeText${i}`)?.value?.toUpperCase() || '';
                if (!text) return;
                
                let x, y;
                switch(pos) {
                    case 'top':
                        x = canvas.width / 2;
                        y = fontSize + 10;
                        break;
                    case 'bottom':
                        x = canvas.width / 2;
                        y = canvas.height - fontSize - 10;
                        break;
                    case 'left':
                        x = canvas.width / 4;
                        y = canvas.height / 2;
                        break;
                    case 'right':
                        x = canvas.width * 3 / 4;
                        y = canvas.height / 2;
                        break;
                    case 'caption':
                        x = canvas.width / 2;
                        y = canvas.height - fontSize - 10;
                        break;
                    default:
                        x = canvas.width / 2;
                        y = canvas.height / 2;
                }
                
                // ÊñáÂ≠óÊèõË°åËôïÁêÜ
                const maxWidth = canvas.width * 0.9;
                const words = text.split(' ');
                let line = '';
                let lineY = y;
                
                words.forEach(word => {
                    const testLine = line + word + ' ';
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && line !== '') {
                        ctx.strokeText(line.trim(), x, lineY);
                        ctx.fillText(line.trim(), x, lineY);
                        line = word + ' ';
                        lineY += fontSize + 5;
                    } else {
                        line = testLine;
                    }
                });
                
                ctx.strokeText(line.trim(), x, lineY);
                ctx.fillText(line.trim(), x, lineY);
            });
            
            showToast('üòÇ Ê¢óÂúñÂ∑≤Áî¢ÁîüÔºÅ');
        }
        
        // ===== Êµ∑Â†±Ë£Ω‰Ωú =====
        const posterStyles = {
            movie: { bg: '#1a1a2e', accent: '#e94560', font: 'Impact' },
            concert: { bg: '#0f0f23', accent: '#ff6b6b', font: 'Arial Black' },
            sale: { bg: '#ff4757', accent: '#ffd32a', font: 'Arial Black' },
            minimalist: { bg: '#ffffff', accent: '#2d3436', font: 'Helvetica' },
            vintage: { bg: '#f5e6d3', accent: '#8b4513', font: 'Georgia' },
            neon: { bg: '#000000', accent: '#00ff88', font: 'Arial' },
            gradient: { bg: 'gradient', accent: '#ffffff', font: 'Arial Black' },
            photo: { bg: 'photo', accent: '#ffffff', font: 'Helvetica' }
        };
        
        function showPosterPanel() {
            togglePanel('posterPanel', 'posterBtn');
        }
        
        function createPoster(style) {
            saveHistory();
            
            const posterStyle = posterStyles[style] || posterStyles.minimalist;
            const title = document.getElementById('posterTitle')?.value || 'Ê®ôÈ°å';
            const subtitle = document.getElementById('posterSubtitle')?.value || '';
            const date = document.getElementById('posterDate')?.value || '';
            const location = document.getElementById('posterLocation')?.value || '';
            
            // Ë®≠ÂÆöËÉåÊôØ
            if (posterStyle.bg === 'gradient') {
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (posterStyle.bg !== 'photo') {
                ctx.fillStyle = posterStyle.bg;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Ê®ôÈ°å
            ctx.fillStyle = posterStyle.accent;
            ctx.font = `bold 60px ${posterStyle.font}`;
            ctx.textAlign = 'center';
            ctx.fillText(title, canvas.width / 2, canvas.height * 0.3);
            
            // ÂâØÊ®ôÈ°å
            if (subtitle) {
                ctx.font = `30px ${posterStyle.font}`;
                ctx.fillText(subtitle, canvas.width / 2, canvas.height * 0.45);
            }
            
            // Êó•ÊúüÂíåÂú∞Èªû
            ctx.font = `24px ${posterStyle.font}`;
            if (date) ctx.fillText(date, canvas.width / 2, canvas.height * 0.75);
            if (location) ctx.fillText(location, canvas.width / 2, canvas.height * 0.82);
            
            showToast('üì∞ Êµ∑Â†±Â∑≤Âª∫Á´ãÔºÅ');
        }
        
        // ===== Ê©´ÂπÖË£Ω‰Ωú =====
        const bannerSizes = {
            'web-leaderboard': { w: 728, h: 90, name: 'Á∂≤È†ÅÊ©´ÂπÖ' },
            'web-skyscraper': { w: 160, h: 600, name: 'Êë©Â§©Â§ßÊ®ì' },
            'web-rectangle': { w: 300, h: 250, name: 'Áü©ÂΩ¢Âª£Âëä' },
            'social-fb': { w: 1200, h: 628, name: 'FB Ê©´ÂπÖ' },
            'social-tw': { w: 1500, h: 500, name: 'Twitter Ê©´ÂπÖ' },
            'social-li': { w: 1584, h: 396, name: 'LinkedIn Ê©´ÂπÖ' },
            'email': { w: 600, h: 200, name: 'ÈõªÈÉµÊ©´ÂπÖ' },
            'blog': { w: 1200, h: 400, name: 'ÈÉ®ËêΩÊ†ºÊ©´ÂπÖ' }
        };
        
        function showBannerPanel() {
            togglePanel('bannerPanel', 'bannerBtn');
            initBannerSizes();
        }
        
        function initBannerSizes() {
            const grid = document.getElementById('bannerSizeGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            Object.entries(bannerSizes).forEach(([key, size]) => {
                const item = document.createElement('button');
                item.className = 'banner-size-item';
                item.innerHTML = `${size.name}<br><small>${size.w}√ó${size.h}</small>`;
                item.onclick = () => createBanner(key);
                grid.appendChild(item);
            });
        }
        
        function createBanner(sizeKey) {
            const size = bannerSizes[sizeKey];
            if (!size) return;
            
            saveHistory();
            
            const text = document.getElementById('bannerText')?.value || 'Ê©´ÂπÖÊ®ôÈ°å';
            const cta = document.getElementById('bannerCTA')?.value || '';
            const bgColor = document.getElementById('bannerBgColor')?.value || '#667eea';
            const textColor = document.getElementById('bannerTextColor')?.value || '#ffffff';
            
            canvas.width = size.w;
            canvas.height = size.h;
            
            // Êº∏Â±§ËÉåÊôØ
            const gradient = ctx.createLinearGradient(0, 0, size.w, 0);
            gradient.addColorStop(0, bgColor);
            gradient.addColorStop(1, adjustColor(bgColor, -30));
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, size.w, size.h);
            
            // ‰∏ªÊñáÂ≠ó
            const fontSize = Math.min(size.h * 0.4, 48);
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.fillStyle = textColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, size.w / 2, size.h * 0.4);
            
            // CTA ÊåâÈàï
            if (cta) {
                const ctaWidth = ctx.measureText(cta).width + 40;
                const ctaHeight = fontSize * 0.8;
                const ctaX = size.w / 2 - ctaWidth / 2;
                const ctaY = size.h * 0.65;
                
                ctx.fillStyle = textColor;
                ctx.beginPath();
                ctx.roundRect(ctaX, ctaY, ctaWidth, ctaHeight, 5);
                ctx.fill();
                
                ctx.fillStyle = bgColor;
                ctx.font = `bold ${fontSize * 0.5}px Arial`;
                ctx.fillText(cta, size.w / 2, ctaY + ctaHeight / 2);
            }
            
            showToast('üéØ Ê©´ÂπÖÂ∑≤Âª∫Á´ãÔºÅ');
        }
        
        function adjustColor(hex, amount) {
            const num = parseInt(hex.slice(1), 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
        }
        
        // ===== ÂúñË°®Ë£Ω‰Ωú =====
        function showChartPanel() {
            togglePanel('chartPanel', 'chartBtn');
        }
        
        function createChart(type) {
            saveHistory();
            
            const dataInput = document.getElementById('chartData')?.value || '30,50,40,60,80';
            const labelsInput = document.getElementById('chartLabels')?.value || 'A,B,C,D,E';
            const title = document.getElementById('chartTitle')?.value || 'ÂúñË°®Ê®ôÈ°å';
            
            const data = dataInput.split(',').map(v => parseFloat(v.trim()));
            const labels = labelsInput.split(',').map(l => l.trim());
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#a29bfe', '#fd79a8'];
            
            // Ê∏ÖÁ©∫Áï´Â∏É
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ê®ôÈ°å
            ctx.fillStyle = '#2d3436';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, canvas.width / 2, 40);
            
            const chartArea = {
                x: 60,
                y: 70,
                w: canvas.width - 100,
                h: canvas.height - 120
            };
            
            const maxValue = Math.max(...data);
            
            switch(type) {
                case 'bar':
                    drawBarChart(data, labels, colors, chartArea, maxValue);
                    break;
                case 'line':
                    drawLineChart(data, labels, colors[0], chartArea, maxValue);
                    break;
                case 'pie':
                    drawPieChart(data, labels, colors);
                    break;
                case 'donut':
                    drawDonutChart(data, labels, colors);
                    break;
                case 'horizontal':
                    drawHorizontalBarChart(data, labels, colors, chartArea, maxValue);
                    break;
                case 'area':
                    drawAreaChart(data, labels, colors[0], chartArea, maxValue);
                    break;
            }
            
            showToast('üìä ÂúñË°®Â∑≤Âª∫Á´ãÔºÅ');
        }
        
        function drawBarChart(data, labels, colors, area, maxValue) {
            const barWidth = area.w / data.length * 0.7;
            const gap = area.w / data.length * 0.3;
            
            data.forEach((value, i) => {
                const barHeight = (value / maxValue) * area.h;
                const x = area.x + i * (barWidth + gap) + gap / 2;
                const y = area.y + area.h - barHeight;
                
                ctx.fillStyle = colors[i % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Êï∏ÂÄºÊ®ôÁ±§
                ctx.fillStyle = '#2d3436';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value, x + barWidth / 2, y - 10);
                
                // X Ëª∏Ê®ôÁ±§
                ctx.fillText(labels[i] || '', x + barWidth / 2, area.y + area.h + 20);
            });
            
            // Áπ™Ë£ΩËª∏Á∑ö
            ctx.strokeStyle = '#dfe6e9';
            ctx.beginPath();
            ctx.moveTo(area.x, area.y);
            ctx.lineTo(area.x, area.y + area.h);
            ctx.lineTo(area.x + area.w, area.y + area.h);
            ctx.stroke();
        }
        
        function drawLineChart(data, labels, color, area, maxValue) {
            const stepX = area.w / (data.length - 1);
            
            // Áπ™Ë£ΩÁ∂≤Ê†º
            ctx.strokeStyle = '#ecf0f1';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = area.y + (area.h / 5) * i;
                ctx.beginPath();
                ctx.moveTo(area.x, y);
                ctx.lineTo(area.x + area.w, y);
                ctx.stroke();
            }
            
            // Áπ™Ë£ΩÁ∑öÊ¢ù
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            data.forEach((value, i) => {
                const x = area.x + i * stepX;
                const y = area.y + area.h - (value / maxValue) * area.h;
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Áπ™Ë£ΩÈªûÂíåÊ®ôÁ±§
            data.forEach((value, i) => {
                const x = area.x + i * stepX;
                const y = area.y + area.h - (value / maxValue) * area.h;
                
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.fillStyle = '#2d3436';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value, x, y - 15);
                ctx.fillText(labels[i] || '', x, area.y + area.h + 20);
            });
        }
        
        function drawPieChart(data, labels, colors) {
            const total = data.reduce((a, b) => a + b, 0);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 + 20;
            const radius = Math.min(canvas.width, canvas.height) * 0.35;
            
            let startAngle = -Math.PI / 2;
            
            data.forEach((value, i) => {
                const sliceAngle = (value / total) * Math.PI * 2;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Ê®ôÁ±§
                const labelAngle = startAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
                const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const percent = Math.round((value / total) * 100);
                ctx.fillText(`${percent}%`, labelX, labelY);
                
                startAngle += sliceAngle;
            });
            
            // Âúñ‰æã
            labels.forEach((label, i) => {
                const legendX = 20;
                const legendY = canvas.height - 30 - (labels.length - i - 1) * 25;
                
                ctx.fillStyle = colors[i % colors.length];
                ctx.fillRect(legendX, legendY - 10, 15, 15);
                
                ctx.fillStyle = '#2d3436';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(label, legendX + 20, legendY);
            });
        }
        
        function drawDonutChart(data, labels, colors) {
            const total = data.reduce((a, b) => a + b, 0);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 + 20;
            const outerRadius = Math.min(canvas.width, canvas.height) * 0.35;
            const innerRadius = outerRadius * 0.6;
            
            let startAngle = -Math.PI / 2;
            
            data.forEach((value, i) => {
                const sliceAngle = (value / total) * Math.PI * 2;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, outerRadius, startAngle, startAngle + sliceAngle);
                ctx.arc(centerX, centerY, innerRadius, startAngle + sliceAngle, startAngle, true);
                ctx.closePath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                startAngle += sliceAngle;
            });
            
            // ‰∏≠ÂøÉÊñáÂ≠ó
            ctx.fillStyle = '#2d3436';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Á∏ΩË®à', centerX, centerY - 10);
            ctx.font = 'bold 32px Arial';
            ctx.fillText(total, centerX, centerY + 20);
        }
        
        function drawHorizontalBarChart(data, labels, colors, area, maxValue) {
            const barHeight = area.h / data.length * 0.7;
            const gap = area.h / data.length * 0.3;
            
            data.forEach((value, i) => {
                const barWidth = (value / maxValue) * area.w;
                const x = area.x;
                const y = area.y + i * (barHeight + gap) + gap / 2;
                
                ctx.fillStyle = colors[i % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Êï∏ÂÄºÊ®ôÁ±§
                ctx.fillStyle = '#2d3436';
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(value, x + barWidth + 10, y + barHeight / 2);
                
                // Y Ëª∏Ê®ôÁ±§
                ctx.textAlign = 'right';
                ctx.fillText(labels[i] || '', area.x - 10, y + barHeight / 2);
            });
        }
        
        function drawAreaChart(data, labels, color, area, maxValue) {
            const stepX = area.w / (data.length - 1);
            
            // Â°´ÂÖÖÂçÄÂüü
            ctx.beginPath();
            ctx.moveTo(area.x, area.y + area.h);
            
            data.forEach((value, i) => {
                const x = area.x + i * stepX;
                const y = area.y + area.h - (value / maxValue) * area.h;
                ctx.lineTo(x, y);
            });
            
            ctx.lineTo(area.x + area.w, area.y + area.h);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(0, area.y, 0, area.y + area.h);
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // Áπ™Ë£ΩÁ∑öÊ¢ù
            drawLineChart(data, labels, color, area, maxValue);
        }
        
        // ===== ÊµÅÁ®ãÂúñ =====
        const diagramShapes = {
            process: { draw: drawProcessBox, label: 'ËôïÁêÜ' },
            decision: { draw: drawDecisionDiamond, label: 'Âà§Êñ∑' },
            start: { draw: drawStartEnd, label: 'ÈñãÂßã/ÁµêÊùü' },
            io: { draw: drawIOParallel, label: 'Ëº∏ÂÖ•/Ëº∏Âá∫' },
            connector: { draw: drawConnector, label: 'ÈÄ£Êé•' }
        };
        
        function showDiagramPanel() {
            togglePanel('diagramPanel', 'diagramBtn');
        }
        
        function addDiagramShape(type) {
            saveHistory();
            const shape = diagramShapes[type];
            if (!shape) return;
            
            const text = document.getElementById('diagramText')?.value || shape.label;
            const x = canvas.width / 2;
            const y = canvas.height / 2;
            const color = document.getElementById('diagramColor')?.value || '#4ecdc4';
            
            shape.draw(ctx, x, y, 150, 80, color, text);
            showToast('üìê ÊµÅÁ®ãÂúñÂΩ¢ÁãÄÂ∑≤Âä†ÂÖ•');
        }
        
        function drawProcessBox(ctx, x, y, w, h, color, text) {
            ctx.fillStyle = color;
            ctx.strokeStyle = '#2d3436';
            ctx.lineWidth = 2;
            ctx.fillRect(x - w/2, y - h/2, w, h);
            ctx.strokeRect(x - w/2, y - h/2, w, h);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
        }
        
        function drawDecisionDiamond(ctx, x, y, w, h, color, text) {
            ctx.beginPath();
            ctx.moveTo(x, y - h/2);
            ctx.lineTo(x + w/2, y);
            ctx.lineTo(x, y + h/2);
            ctx.lineTo(x - w/2, y);
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#2d3436';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
        }
        
        function drawStartEnd(ctx, x, y, w, h, color, text) {
            ctx.beginPath();
            ctx.ellipse(x, y, w/2, h/2, 0, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#2d3436';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
        }
        
        function drawIOParallel(ctx, x, y, w, h, color, text) {
            const skew = 20;
            ctx.beginPath();
            ctx.moveTo(x - w/2 + skew, y - h/2);
            ctx.lineTo(x + w/2 + skew, y - h/2);
            ctx.lineTo(x + w/2 - skew, y + h/2);
            ctx.lineTo(x - w/2 - skew, y + h/2);
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#2d3436';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
        }
        
        function drawConnector(ctx, x, y, w, h, color, text) {
            ctx.beginPath();
            ctx.arc(x, y, Math.min(w, h) / 3, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#2d3436';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
        }
        
        function addDiagramArrow() {
            setTool('diagramArrow');
            showToast('‚û°Ô∏è ÊãñÊõ≥Áï´ÁÆ≠È†≠ÈÄ£Êé•');
        }
        
        // ===== ÊôÇÈñìËª∏ =====
        function showTimelinePanel() {
            togglePanel('timelinePanel', 'timelineBtn');
        }
        
        function createTimeline() {
            saveHistory();
            
            const events = document.getElementById('timelineEvents')?.value?.split('\n') || [];
            const dates = document.getElementById('timelineDates')?.value?.split('\n') || [];
            const title = document.getElementById('timelineTitle')?.value || 'ÊôÇÈñìËª∏';
            const color = document.getElementById('timelineColor')?.value || '#4ecdc4';
            
            // ËÉåÊôØ
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ê®ôÈ°å
            ctx.fillStyle = '#2d3436';
            ctx.font = 'bold 28px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, canvas.width / 2, 50);
            
            // ÊôÇÈñìËª∏Á∑ö
            const lineY = canvas.height / 2;
            const startX = 80;
            const endX = canvas.width - 80;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(startX, lineY);
            ctx.lineTo(endX, lineY);
            ctx.stroke();
            
            // ‰∫ã‰ª∂Èªû
            const eventCount = Math.max(events.length, 1);
            const stepX = (endX - startX) / (eventCount + 1);
            
            events.forEach((event, i) => {
                const x = startX + stepX * (i + 1);
                const isTop = i % 2 === 0;
                
                // Èªû
                ctx.beginPath();
                ctx.arc(x, lineY, 10, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // ÈÄ£Êé•Á∑ö
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x, lineY);
                ctx.lineTo(x, isTop ? lineY - 60 : lineY + 60);
                ctx.stroke();
                
                // Êó•Êúü
                ctx.fillStyle = color;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(dates[i] || '', x, isTop ? lineY - 70 : lineY + 80);
                
                // ‰∫ã‰ª∂ÊñáÂ≠ó
                ctx.fillStyle = '#2d3436';
                ctx.font = '12px Arial';
                const textY = isTop ? lineY - 90 : lineY + 100;
                wrapText(ctx, event, x, textY, 100, 16);
            });
            
            showToast('üìÖ ÊôÇÈñìËª∏Â∑≤Âª∫Á´ãÔºÅ');
        }
        
        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split('');
            let line = '';
            let testLine = '';
            
            for (let i = 0; i < words.length; i++) {
                testLine = line + words[i];
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && i > 0) {
                    ctx.fillText(line, x, y);
                    line = words[i];
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, y);
        }
        
        // ===== Ë≥áË®äÂúñË°® =====
        function showInfographicPanel() {
            togglePanel('infographicPanel', 'infographicBtn');
        }
        
        function createInfographic(type) {
            saveHistory();
            
            const title = document.getElementById('infoTitle')?.value || 'Ë≥áË®äÂúñË°®';
            const stats = document.getElementById('infoStats')?.value?.split('\n') || [];
            const values = document.getElementById('infoValues')?.value?.split('\n') || [];
            
            // ËÉåÊôØ
            const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            bgGradient.addColorStop(0, '#667eea');
            bgGradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ê®ôÈ°å
            ctx.fillStyle = 'white';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, canvas.width / 2, 60);
            
            switch(type) {
                case 'stats':
                    drawStatsInfographic(stats, values);
                    break;
                case 'comparison':
                    drawComparisonInfographic(stats, values);
                    break;
                case 'steps':
                    drawStepsInfographic(stats);
                    break;
                case 'icons':
                    drawIconsInfographic(stats, values);
                    break;
            }
            
            showToast('üìä Ë≥áË®äÂúñË°®Â∑≤Âª∫Á´ãÔºÅ');
        }
        
        function drawStatsInfographic(stats, values) {
            const cols = Math.min(stats.length, 4);
            const colWidth = (canvas.width - 80) / cols;
            
            stats.forEach((stat, i) => {
                const x = 40 + colWidth * i + colWidth / 2;
                const y = canvas.height / 2;
                
                // Êï∏ÂÄº
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(values[i] || '0', x, y);
                
                // Ê®ôÁ±§
                ctx.font = '16px Arial';
                ctx.fillText(stat, x, y + 40);
            });
        }
        
        function drawComparisonInfographic(stats, values) {
            const numValues = values.map(v => parseFloat(v) || 0);
            const maxValue = Math.max(...numValues);
            
            stats.forEach((stat, i) => {
                const y = 120 + i * 80;
                const barWidth = (numValues[i] / maxValue) * (canvas.width - 200);
                
                // ËÉåÊôØÊ¢ù
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.fillRect(100, y, canvas.width - 200, 40);
                
                // Êï∏ÂÄºÊ¢ù
                ctx.fillStyle = 'white';
                ctx.fillRect(100, y, barWidth, 40);
                
                // Ê®ôÁ±§
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(stat, 100, y - 10);
                
                // Êï∏ÂÄº
                ctx.textAlign = 'right';
                ctx.fillText(values[i] || '', canvas.width - 100, y + 25);
            });
        }
        
        function drawStepsInfographic(stats) {
            stats.forEach((stat, i) => {
                const y = 120 + i * 100;
                
                // Êï∏Â≠óÂúìÂúà
                ctx.beginPath();
                ctx.arc(60, y, 25, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(i + 1, 60, y);
                
                // ÈÄ£Êé•Á∑ö
                if (i < stats.length - 1) {
                    ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(60, y + 30);
                    ctx.lineTo(60, y + 70);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                
                // ÊñáÂ≠ó
                ctx.fillStyle = 'white';
                ctx.font = '18px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(stat, 100, y);
            });
        }
        
        function drawIconsInfographic(stats, values) {
            const icons = ['üìä', 'üìà', 'üí∞', 'üë•', 'üéØ', '‚≠ê', 'üî•', 'üí°'];
            const cols = Math.min(stats.length, 4);
            const colWidth = (canvas.width - 80) / cols;
            
            stats.forEach((stat, i) => {
                const x = 40 + colWidth * i + colWidth / 2;
                const y = canvas.height / 2 - 40;
                
                // ÂúñÁ§∫
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(icons[i % icons.length], x, y);
                
                // Êï∏ÂÄº
                ctx.fillStyle = 'white';
                ctx.font = 'bold 32px Arial';
                ctx.fillText(values[i] || '0', x, y + 60);
                
                // Ê®ôÁ±§
                ctx.font = '14px Arial';
                ctx.fillText(stat, x, y + 90);
            });
        }
        
        // ===== ÂêçÁâáË£Ω‰Ωú =====
        function showBusinessCardPanel() {
            togglePanel('businessCardPanel', 'businessCardBtn');
        }
        
        function createBusinessCard(style) {
            saveHistory();
            
            const name = document.getElementById('cardName')?.value || 'ÂßìÂêç';
            const title = document.getElementById('cardTitle')?.value || 'ËÅ∑Á®±';
            const company = document.getElementById('cardCompany')?.value || 'ÂÖ¨Âè∏ÂêçÁ®±';
            const phone = document.getElementById('cardPhone')?.value || '';
            const email = document.getElementById('cardEmail')?.value || '';
            const website = document.getElementById('cardWebsite')?.value || '';
            
            // ÂêçÁâáÂ∞∫ÂØ∏ (90mm x 54mm @ 300dpi)
            canvas.width = 1063;
            canvas.height = 638;
            
            const styles = {
                minimal: { bg: '#ffffff', text: '#2d3436', accent: '#667eea' },
                dark: { bg: '#1a1a2e', text: '#ffffff', accent: '#4ecdc4' },
                gradient: { bg: 'gradient', text: '#ffffff', accent: '#ffffff' },
                creative: { bg: '#f8f9fa', text: '#2d3436', accent: '#ff6b6b' }
            };
            
            const s = styles[style] || styles.minimal;
            
            // ËÉåÊôØ
            if (s.bg === 'gradient') {
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
            } else {
                ctx.fillStyle = s.bg;
            }
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ë£ùÈ£æÂÖÉÁ¥†
            if (style === 'creative') {
                ctx.fillStyle = s.accent;
                ctx.beginPath();
                ctx.arc(canvas.width - 100, 100, 200, 0, Math.PI * 2);
                ctx.globalAlpha = 0.1;
                ctx.fill();
                ctx.globalAlpha = 1;
            }
            
            // ÂêçÂ≠ó
            ctx.fillStyle = s.text;
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(name, 60, 150);
            
            // ËÅ∑Á®±
            ctx.fillStyle = s.accent;
            ctx.font = '24px Arial';
            ctx.fillText(title, 60, 190);
            
            // ÂÖ¨Âè∏
            ctx.fillStyle = s.text;
            ctx.font = '20px Arial';
            ctx.fillText(company, 60, 230);
            
            // ËÅØÁµ°Ë≥áË®ä
            ctx.font = '16px Arial';
            let infoY = 350;
            
            if (phone) {
                ctx.fillText('üìû ' + phone, 60, infoY);
                infoY += 30;
            }
            if (email) {
                ctx.fillText('üìß ' + email, 60, infoY);
                infoY += 30;
            }
            if (website) {
                ctx.fillText('üåê ' + website, 60, infoY);
            }
            
            // Ë£ùÈ£æÁ∑ö
            ctx.strokeStyle = s.accent;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(60, 260);
            ctx.lineTo(200, 260);
            ctx.stroke();
            
            showToast('ü™™ ÂêçÁâáÂ∑≤Âª∫Á´ãÔºÅ');
        }
        
        // ===== ÁôºÁ•®/Êî∂ÊìöË£Ω‰Ωú =====
        function showInvoicePanel() {
            togglePanel('invoicePanel', 'invoiceBtn');
        }
        
        function createInvoice() {
            saveHistory();
            
            const companyName = document.getElementById('invoiceCompany')?.value || 'ÂÖ¨Âè∏ÂêçÁ®±';
            const invoiceNo = document.getElementById('invoiceNo')?.value || 'INV-001';
            const date = document.getElementById('invoiceDate')?.value || new Date().toLocaleDateString();
            const items = document.getElementById('invoiceItems')?.value?.split('\n') || [];
            const prices = document.getElementById('invoicePrices')?.value?.split('\n') || [];
            
            canvas.width = 800;
            canvas.height = 600;
            
            // ËÉåÊôØ
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // È†≠ÈÉ®
            ctx.fillStyle = '#667eea';
            ctx.fillRect(0, 0, canvas.width, 100);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(companyName, 30, 60);
            
            // ÁôºÁ•®Ë≥áË®ä
            ctx.fillStyle = '#2d3436';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('ÁôºÁ•®', canvas.width - 30, 150);
            
            ctx.font = '14px Arial';
            ctx.fillText(`ÁôºÁ•®Á∑®Ëôü: ${invoiceNo}`, canvas.width - 30, 180);
            ctx.fillText(`Êó•Êúü: ${date}`, canvas.width - 30, 200);
            
            // Ë°®Ê†ºÊ®ôÈ†≠
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(30, 250, canvas.width - 60, 40);
            
            ctx.fillStyle = '#2d3436';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('È†ÖÁõÆ', 50, 275);
            ctx.textAlign = 'right';
            ctx.fillText('ÈáëÈ°ç', canvas.width - 50, 275);
            
            // È†ÖÁõÆÂàóË°®
            ctx.font = '14px Arial';
            let total = 0;
            items.forEach((item, i) => {
                const y = 310 + i * 35;
                const price = parseFloat(prices[i]) || 0;
                total += price;
                
                ctx.textAlign = 'left';
                ctx.fillText(item, 50, y);
                ctx.textAlign = 'right';
                ctx.fillText('$' + price.toFixed(2), canvas.width - 50, y);
                
                // ÂàÜÈöîÁ∑ö
                ctx.strokeStyle = '#ecf0f1';
                ctx.beginPath();
                ctx.moveTo(30, y + 15);
                ctx.lineTo(canvas.width - 30, y + 15);
                ctx.stroke();
            });
            
            // Á∏ΩË®à
            const totalY = 320 + items.length * 35 + 30;
            ctx.fillStyle = '#667eea';
            ctx.fillRect(canvas.width - 250, totalY - 25, 220, 40);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Á∏ΩË®à:', canvas.width - 240, totalY);
            ctx.textAlign = 'right';
            ctx.fillText('$' + total.toFixed(2), canvas.width - 50, totalY);
            
            showToast('üßæ ÁôºÁ•®Â∑≤Âª∫Á´ãÔºÅ');
        }
        
        // ===== Ë≠âÊõ∏Ë£Ω‰Ωú =====
        function showCertificatePanel() {
            togglePanel('certificatePanel', 'certificateBtn');
        }
        
        function createCertificate(style) {
            saveHistory();
            
            const recipient = document.getElementById('certRecipient')?.value || 'ÂèóÁçé‰∫∫';
            const achievement = document.getElementById('certAchievement')?.value || 'ÂÑ™Áï∞Ë°®Áèæ';
            const issuer = document.getElementById('certIssuer')?.value || 'È†íÁôºÂñÆ‰Ωç';
            const date = document.getElementById('certDate')?.value || new Date().toLocaleDateString();
            
            canvas.width = 1200;
            canvas.height = 850;
            
            // ËÉåÊôØ
            ctx.fillStyle = '#fffef7';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ë£ùÈ£æÈÇäÊ°Ü
            ctx.strokeStyle = '#d4af37';
            ctx.lineWidth = 15;
            ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);
            
            ctx.lineWidth = 3;
            ctx.strokeRect(60, 60, canvas.width - 120, canvas.height - 120);
            
            // ËßíËêΩË£ùÈ£æ
            const corners = [[80, 80], [canvas.width - 80, 80], [80, canvas.height - 80], [canvas.width - 80, canvas.height - 80]];
            corners.forEach(([x, y]) => {
                ctx.beginPath();
                ctx.arc(x, y, 20, 0, Math.PI * 2);
                ctx.fillStyle = '#d4af37';
                ctx.fill();
            });
            
            // Ê®ôÈ°å
            ctx.fillStyle = '#1a1a2e';
            ctx.font = 'bold 60px "Times New Roman", serif';
            ctx.textAlign = 'center';
            ctx.fillText('Ê¶ÆË≠ΩË≠âÊõ∏', canvas.width / 2, 180);
            
            // Ë£ùÈ£æÁ∑ö
            ctx.strokeStyle = '#d4af37';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 150, 210);
            ctx.lineTo(canvas.width / 2 + 150, 210);
            ctx.stroke();
            
            // ÂÖßÂÆπ
            ctx.fillStyle = '#333';
            ctx.font = '24px "Times New Roman", serif';
            ctx.fillText('Ëå≤Ë≠âÊòé', canvas.width / 2, 300);
            
            ctx.fillStyle = '#1a1a2e';
            ctx.font = 'bold 48px "Times New Roman", serif';
            ctx.fillText(recipient, canvas.width / 2, 380);
            
            ctx.fillStyle = '#333';
            ctx.font = '24px "Times New Roman", serif';
            ctx.fillText('Âõ†', canvas.width / 2, 450);
            
            ctx.fillStyle = '#d4af37';
            ctx.font = 'bold 36px "Times New Roman", serif';
            ctx.fillText(achievement, canvas.width / 2, 510);
            
            ctx.fillStyle = '#333';
            ctx.font = '24px "Times New Roman", serif';
            ctx.fillText('ÁâπÈ†íÊ≠§Ë≠âÔºå‰ª•Ë≥áÈºìÂãµ', canvas.width / 2, 580);
            
            // Á∞ΩÂêçÂçÄ
            ctx.fillStyle = '#666';
            ctx.font = '18px Arial';
            ctx.fillText(issuer, canvas.width / 2 - 200, 720);
            ctx.fillText(date, canvas.width / 2 + 200, 720);
            
            // Á∞ΩÂêçÁ∑ö
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 300, 700);
            ctx.lineTo(canvas.width / 2 - 100, 700);
            ctx.moveTo(canvas.width / 2 + 100, 700);
            ctx.lineTo(canvas.width / 2 + 300, 700);
            ctx.stroke();
            
            showToast('üèÜ Ë≠âÊõ∏Â∑≤Âª∫Á´ãÔºÅ');
        }
        
        // ===== ÂæΩÁ´†Ë£Ω‰Ωú =====
        function showBadgePanel() {
            togglePanel('badgePanel', 'badgeBtn');
        }
        
        function createBadge(style) {
            saveHistory();
            
            const text = document.getElementById('badgeText')?.value || 'BADGE';
            const subtext = document.getElementById('badgeSubtext')?.value || '';
            const color1 = document.getElementById('badgeColor1')?.value || '#667eea';
            const color2 = document.getElementById('badgeColor2')?.value || '#764ba2';
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.35;
            
            switch(style) {
                case 'circle':
                    drawCircleBadge(centerX, centerY, radius, color1, color2, text, subtext);
                    break;
                case 'shield':
                    drawShieldBadge(centerX, centerY, radius, color1, color2, text, subtext);
                    break;
                case 'ribbon':
                    drawRibbonBadge(centerX, centerY, radius, color1, color2, text, subtext);
                    break;
                case 'star':
                    drawStarBadge(centerX, centerY, radius, color1, color2, text, subtext);
                    break;
                case 'hexagon':
                    drawHexagonBadge(centerX, centerY, radius, color1, color2, text, subtext);
                    break;
            }
            
            showToast('üèÖ ÂæΩÁ´†Â∑≤Âª∫Á´ãÔºÅ');
        }
        
        function drawCircleBadge(cx, cy, r, color1, color2, text, subtext) {
            // Â§ñÂúà
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            const gradient = ctx.createLinearGradient(cx - r, cy - r, cx + r, cy + r);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // ÂÖßÂúà
            ctx.beginPath();
            ctx.arc(cx, cy, r * 0.85, 0, Math.PI * 2);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            // ÊñáÂ≠ó
            ctx.fillStyle = 'white';
            ctx.font = `bold ${r * 0.4}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, cx, cy);
            
            if (subtext) {
                ctx.font = `${r * 0.15}px Arial`;
                ctx.fillText(subtext, cx, cy + r * 0.3);
            }
        }
        
        function drawShieldBadge(cx, cy, r, color1, color2, text, subtext) {
            ctx.beginPath();
            ctx.moveTo(cx, cy - r);
            ctx.lineTo(cx + r * 0.8, cy - r * 0.5);
            ctx.lineTo(cx + r * 0.8, cy + r * 0.3);
            ctx.quadraticCurveTo(cx + r * 0.4, cy + r, cx, cy + r);
            ctx.quadraticCurveTo(cx - r * 0.4, cy + r, cx - r * 0.8, cy + r * 0.3);
            ctx.lineTo(cx - r * 0.8, cy - r * 0.5);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(cx, cy - r, cx, cy + r);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            ctx.fillStyle = gradient;
            ctx.fill();
            
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = `bold ${r * 0.35}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, cx, cy);
            
            if (subtext) {
                ctx.font = `${r * 0.12}px Arial`;
                ctx.fillText(subtext, cx, cy + r * 0.35);
            }
        }
        
        function drawRibbonBadge(cx, cy, r, color1, color2, text, subtext) {
            // ÂúìÂΩ¢
            drawCircleBadge(cx, cy, r * 0.8, color1, color2, text, '');
            
            // Á∑ûÂ∏∂
            ctx.fillStyle = color2;
            ctx.beginPath();
            ctx.moveTo(cx - r * 0.5, cy + r * 0.5);
            ctx.lineTo(cx - r * 0.8, cy + r * 1.2);
            ctx.lineTo(cx - r * 0.5, cy + r);
            ctx.lineTo(cx - r * 0.2, cy + r * 1.2);
            ctx.lineTo(cx, cy + r * 0.6);
            ctx.closePath();
            ctx.fill();
            
            ctx.beginPath();
            ctx.moveTo(cx + r * 0.5, cy + r * 0.5);
            ctx.lineTo(cx + r * 0.8, cy + r * 1.2);
            ctx.lineTo(cx + r * 0.5, cy + r);
            ctx.lineTo(cx + r * 0.2, cy + r * 1.2);
            ctx.lineTo(cx, cy + r * 0.6);
            ctx.closePath();
            ctx.fill();
        }
        
        function drawStarBadge(cx, cy, r, color1, color2, text, subtext) {
            const spikes = 5;
            const outerRadius = r;
            const innerRadius = r * 0.5;
            
            ctx.beginPath();
            let rot = Math.PI / 2 * 3;
            let step = Math.PI / spikes;
            
            ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius);
                rot += step;
                ctx.lineTo(cx + Math.cos(rot) * innerRadius, cy + Math.sin(rot) * innerRadius);
                rot += step;
            }
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(cx, cy - r, cx, cy + r);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            ctx.fillStyle = gradient;
            ctx.fill();
            
            ctx.fillStyle = 'white';
            ctx.font = `bold ${r * 0.3}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, cx, cy);
        }
        
        function drawHexagonBadge(cx, cy, r, color1, color2, text, subtext) {
            ctx.beginPath();
            for (let i = 0; i < 6; i++) {
                const angle = (Math.PI / 3) * i - Math.PI / 2;
                const x = cx + r * Math.cos(angle);
                const y = cy + r * Math.sin(angle);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(cx, cy - r, cx, cy + r);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            ctx.fillStyle = gradient;
            ctx.fill();
            
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = `bold ${r * 0.35}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, cx, cy);
            
            if (subtext) {
                ctx.font = `${r * 0.12}px Arial`;
                ctx.fillText(subtext, cx, cy + r * 0.3);
            }
        }
        
        // ===== Â§ßÈ†≠Ë≤ºË£Ω‰Ωú =====
        function showAvatarPanel() {
            togglePanel('avatarPanel', 'avatarBtn');
        }
        
        function createAvatar(shape) {
            saveHistory();
            
            const bgColor = document.getElementById('avatarBgColor')?.value || '#667eea';
            const borderWidth = parseInt(document.getElementById('avatarBorder')?.value || 5);
            const borderColor = document.getElementById('avatarBorderColor')?.value || '#ffffff';
            
            const size = Math.min(canvas.width, canvas.height);
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = size;
            tempCanvas.height = size;
            const tempCtx = tempCanvas.getContext('2d');
            
            // ËÉåÊôØ
            tempCtx.fillStyle = bgColor;
            tempCtx.fillRect(0, 0, size, size);
            
            // Ë£ÅÂàáÂΩ¢ÁãÄ
            tempCtx.globalCompositeOperation = 'destination-in';
            
            switch(shape) {
                case 'circle':
                    tempCtx.beginPath();
                    tempCtx.arc(size/2, size/2, size/2 - borderWidth, 0, Math.PI * 2);
                    tempCtx.fill();
                    break;
                case 'rounded':
                    tempCtx.beginPath();
                    tempCtx.roundRect(borderWidth, borderWidth, size - borderWidth*2, size - borderWidth*2, 30);
                    tempCtx.fill();
                    break;
                case 'hexagon':
                    tempCtx.beginPath();
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI / 3) * i - Math.PI / 2;
                        const x = size/2 + (size/2 - borderWidth) * Math.cos(angle);
                        const y = size/2 + (size/2 - borderWidth) * Math.sin(angle);
                        if (i === 0) tempCtx.moveTo(x, y);
                        else tempCtx.lineTo(x, y);
                    }
                    tempCtx.closePath();
                    tempCtx.fill();
                    break;
            }
            
            tempCtx.globalCompositeOperation = 'destination-over';
            
            // Á∏ÆÊîæÂéüÂúñ
            const scale = Math.max(size / canvas.width, size / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const x = (size - newW) / 2;
            const y = (size - newH) / 2;
            tempCtx.drawImage(canvas, x, y, newW, newH);
            
            // ÈÇäÊ°Ü
            tempCtx.globalCompositeOperation = 'source-over';
            tempCtx.strokeStyle = borderColor;
            tempCtx.lineWidth = borderWidth;
            
            switch(shape) {
                case 'circle':
                    tempCtx.beginPath();
                    tempCtx.arc(size/2, size/2, size/2 - borderWidth/2, 0, Math.PI * 2);
                    tempCtx.stroke();
                    break;
                case 'rounded':
                    tempCtx.beginPath();
                    tempCtx.roundRect(borderWidth/2, borderWidth/2, size - borderWidth, size - borderWidth, 30);
                    tempCtx.stroke();
                    break;
                case 'hexagon':
                    tempCtx.beginPath();
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI / 3) * i - Math.PI / 2;
                        const xx = size/2 + (size/2 - borderWidth/2) * Math.cos(angle);
                        const yy = size/2 + (size/2 - borderWidth/2) * Math.sin(angle);
                        if (i === 0) tempCtx.moveTo(xx, yy);
                        else tempCtx.lineTo(xx, yy);
                    }
                    tempCtx.closePath();
                    tempCtx.stroke();
                    break;
            }
            
            canvas.width = size;
            canvas.height = size;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('üé≠ Â§ßÈ†≠Ë≤ºÂ∑≤Âª∫Á´ãÔºÅ');
        }
        
        // ===== Á∏ÆÂúñË£Ω‰Ωú =====
        function showThumbnailPanel() {
            togglePanel('thumbnailPanel', 'thumbnailBtn');
        }
        
        function createThumbnail(platform) {
            saveHistory();
            
            const title = document.getElementById('thumbTitle')?.value || 'Ê®ôÈ°å';
            const subtitle = document.getElementById('thumbSubtitle')?.value || '';
            
            const sizes = {
                youtube: { w: 1280, h: 720 },
                twitch: { w: 1920, h: 1080 },
                facebook: { w: 1200, h: 628 },
                instagram: { w: 1080, h: 1080 }
            };
            
            const size = sizes[platform] || sizes.youtube;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = size.w;
            tempCanvas.height = size.h;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Á∏ÆÊîæÂéüÂúñ‰ΩúÁÇ∫ËÉåÊôØ
            const scale = Math.max(size.w / canvas.width, size.h / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const x = (size.w - newW) / 2;
            const y = (size.h - newH) / 2;
            tempCtx.drawImage(canvas, x, y, newW, newH);
            
            // Êº∏Â±§ÈÅÆÁΩ©
            const gradient = tempCtx.createLinearGradient(0, size.h * 0.5, 0, size.h);
            gradient.addColorStop(0, 'rgba(0,0,0,0)');
            gradient.addColorStop(1, 'rgba(0,0,0,0.8)');
            tempCtx.fillStyle = gradient;
            tempCtx.fillRect(0, 0, size.w, size.h);
            
            // Ê®ôÈ°å
            const fontSize = size.w * 0.06;
            tempCtx.fillStyle = 'white';
            tempCtx.font = `bold ${fontSize}px Arial`;
            tempCtx.textAlign = 'center';
            tempCtx.textBaseline = 'bottom';
            
            // ÊñáÂ≠óÈô∞ÂΩ±
            tempCtx.shadowColor = 'rgba(0,0,0,0.8)';
            tempCtx.shadowBlur = 10;
            tempCtx.shadowOffsetX = 3;
            tempCtx.shadowOffsetY = 3;
            
            tempCtx.fillText(title, size.w / 2, size.h - 60);
            
            if (subtitle) {
                tempCtx.font = `${fontSize * 0.5}px Arial`;
                tempCtx.fillText(subtitle, size.w / 2, size.h - 20);
            }
            
            canvas.width = size.w;
            canvas.height = size.h;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('üñºÔ∏è Á∏ÆÂúñÂ∑≤Âª∫Á´ãÔºÅ');
        }
        
        // ===== Â∞ÅÈù¢Ë£Ω‰Ωú =====
        function showCoverPanel() {
            togglePanel('coverPanel', 'coverBtn');
        }
        
        function createCover(type) {
            saveHistory();
            
            const title = document.getElementById('coverTitle')?.value || 'Ê®ôÈ°å';
            const author = document.getElementById('coverAuthor')?.value || '‰ΩúËÄÖ';
            
            const sizes = {
                book: { w: 1600, h: 2400 },
                album: { w: 1400, h: 1400 },
                magazine: { w: 1200, h: 1600 },
                ebook: { w: 1600, h: 2560 }
            };
            
            const size = sizes[type] || sizes.book;
            
            canvas.width = size.w;
            canvas.height = size.h;
            
            // Êº∏Â±§ËÉåÊôØ
            const gradient = ctx.createLinearGradient(0, 0, size.w, size.h);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#16213e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, size.w, size.h);
            
            // Ë£ùÈ£æÂÖÉÁ¥†
            ctx.fillStyle = 'rgba(255,255,255,0.05)';
            ctx.beginPath();
            ctx.arc(size.w * 0.8, size.h * 0.2, size.w * 0.4, 0, Math.PI * 2);
            ctx.fill();
            
            // Ê®ôÈ°å
            const titleSize = size.w * 0.08;
            ctx.fillStyle = 'white';
            ctx.font = `bold ${titleSize}px "Times New Roman", serif`;
            ctx.textAlign = 'center';
            ctx.fillText(title, size.w / 2, size.h * 0.45);
            
            // ‰ΩúËÄÖ
            ctx.fillStyle = '#d4af37';
            ctx.font = `${titleSize * 0.4}px Arial`;
            ctx.fillText(author, size.w / 2, size.h * 0.55);
            
            // Ë£ùÈ£æÁ∑ö
            ctx.strokeStyle = '#d4af37';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(size.w * 0.3, size.h * 0.48);
            ctx.lineTo(size.w * 0.7, size.h * 0.48);
            ctx.stroke();
            
            showToast('üìö Â∞ÅÈù¢Â∑≤Âª∫Á´ãÔºÅ');
        }
        
        // ===== Áî¢ÂìÅ Mockup =====
        function showMockupPanel() {
            togglePanel('mockupPanel', 'mockupBtn');
        }
        
        function createMockup(device) {
            saveHistory();
            
            const mockups = {
                iphone: { w: 400, h: 800, screenX: 30, screenY: 80, screenW: 340, screenH: 640, radius: 40 },
                macbook: { w: 1200, h: 750, screenX: 140, screenY: 40, screenW: 920, screenH: 575, radius: 10 },
                ipad: { w: 600, h: 800, screenX: 40, screenY: 60, screenW: 520, screenH: 680, radius: 20 },
                monitor: { w: 1000, h: 700, screenX: 50, screenY: 40, screenW: 900, screenH: 520, radius: 10 }
            };
            
            const m = mockups[device] || mockups.iphone;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = m.w + 100;
            tempCanvas.height = m.h + 150;
            const tempCtx = tempCanvas.getContext('2d');
            
            // ËÉåÊôØÊº∏Â±§
            const bgGradient = tempCtx.createLinearGradient(0, 0, tempCanvas.width, tempCanvas.height);
            bgGradient.addColorStop(0, '#667eea');
            bgGradient.addColorStop(1, '#764ba2');
            tempCtx.fillStyle = bgGradient;
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            const offsetX = 50;
            const offsetY = 50;
            
            // Ë£ùÁΩÆÈô∞ÂΩ±
            tempCtx.shadowColor = 'rgba(0,0,0,0.3)';
            tempCtx.shadowBlur = 30;
            tempCtx.shadowOffsetY = 20;
            
            // Ë£ùÁΩÆÂ§ñÊ°Ü
            tempCtx.fillStyle = '#1a1a1a';
            tempCtx.beginPath();
            tempCtx.roundRect(offsetX, offsetY, m.w, m.h, m.radius);
            tempCtx.fill();
            
            tempCtx.shadowColor = 'transparent';
            
            // Ëû¢ÂπïÂçÄÂüü
            tempCtx.save();
            tempCtx.beginPath();
            tempCtx.roundRect(offsetX + m.screenX, offsetY + m.screenY, m.screenW, m.screenH, m.radius / 2);
            tempCtx.clip();
            
            // Á∏ÆÊîæÂéüÂúñÂ°´ÂÖ•Ëû¢Âπï
            const scale = Math.max(m.screenW / canvas.width, m.screenH / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const imgX = offsetX + m.screenX + (m.screenW - newW) / 2;
            const imgY = offsetY + m.screenY + (m.screenH - newH) / 2;
            tempCtx.drawImage(canvas, imgX, imgY, newW, newH);
            tempCtx.restore();
            
            // iPhone ÁâπÊúâÂÖÉÁ¥†
            if (device === 'iphone') {
                // ÁÄèÊµ∑
                tempCtx.fillStyle = '#1a1a1a';
                tempCtx.beginPath();
                tempCtx.roundRect(offsetX + m.w/2 - 60, offsetY + 10, 120, 30, 15);
                tempCtx.fill();
                
                // Home ÊåáÁ§∫Ê¢ù
                tempCtx.fillStyle = '#666';
                tempCtx.beginPath();
                tempCtx.roundRect(offsetX + m.w/2 - 50, offsetY + m.h - 30, 100, 5, 3);
                tempCtx.fill();
            }
            
            // MacBook ÁâπÊúâÂÖÉÁ¥†
            if (device === 'macbook') {
                // Â∫ïÂ∫ß
                tempCtx.fillStyle = '#2a2a2a';
                tempCtx.beginPath();
                tempCtx.moveTo(offsetX - 20, offsetY + m.h);
                tempCtx.lineTo(offsetX + m.w + 20, offsetY + m.h);
                tempCtx.lineTo(offsetX + m.w + 40, offsetY + m.h + 20);
                tempCtx.lineTo(offsetX - 40, offsetY + m.h + 20);
                tempCtx.closePath();
                tempCtx.fill();
            }
            
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('üì± Mockup Â∑≤Âª∫Á´ãÔºÅ');
        }
        
        // ===== Ëâ≤ÂΩ©ÂàÜÊûê =====
        function showColorPalettePanel() {
            togglePanel('colorPalettePanel', 'colorPaletteBtn');
            analyzeColors();
        }
        
        function analyzeColors() {
            if (!currentImage && canvas.width === 300) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàËºâÂÖ•ÂúñÁâá');
                return;
            }
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const colorCounts = {};
            
            // ÂèñÊ®£ÂàÜÊûê
            const sampleStep = 10;
            for (let i = 0; i < data.length; i += 4 * sampleStep) {
                const r = Math.round(data[i] / 32) * 32;
                const g = Math.round(data[i+1] / 32) * 32;
                const b = Math.round(data[i+2] / 32) * 32;
                const key = `${r},${g},${b}`;
                colorCounts[key] = (colorCounts[key] || 0) + 1;
            }
            
            // ÊéíÂ∫èÂèñÂâç 8 ÂÄã‰∏ªË¶ÅÈ°èËâ≤
            const sortedColors = Object.entries(colorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8)
                .map(([key]) => {
                    const [r, g, b] = key.split(',').map(Number);
                    const hex = `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
                    return { rgb: `rgb(${r},${g},${b})`, hex: hex };
                });
            
            // È°ØÁ§∫Ëâ≤ÂΩ©
            const container = document.getElementById('colorPaletteDisplay');
            if (container) {
                container.innerHTML = sortedColors.map(c => `
                    <div onclick="copyColorToClipboard('${c.hex}')" title="${c.hex}" style="
                        width:50px;height:50px;background:${c.rgb};border-radius:8px;cursor:pointer;
                        border:3px solid rgba(255,255,255,0.3);box-shadow:0 2px 8px rgba(0,0,0,0.3);
                        transition:transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"></div>
                `).join('');
            }
            
            showToast('üé® Â∑≤ÂàÜÊûê ' + sortedColors.length + ' ÂÄã‰∏ªË¶ÅÈ°èËâ≤');
        }
        
        function copyColorToClipboard(color) {
            navigator.clipboard.writeText(color).then(() => {
                showToast('üìã È°èËâ≤Â∑≤Ë§áË£Ω: ' + color);
            });
        }
        
        function extractPalette() {
            analyzeColors();
        }
        
        // ===== AI Â¢ûÂº∑ =====
        function showAiEnhancePanel() {
            togglePanel('aiEnhancePanel', 'aiEnhanceBtn');
        }
        
        async function aiEnhance(type) {
            if (!settings.geminiApiKey) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàË®≠ÂÆö Gemini API Key');
                showPage('settings');
                return;
            }
            
            showToast('ü§ñ AI ËôïÁêÜ‰∏≠...');
            
            try {
                // Á∞°ÂñÆÁöÑÊú¨Âú∞Â¢ûÂº∑ÔºàÊ®°Êì¨ AI ÊïàÊûúÔºâ
                saveHistory();
                
                switch(type) {
                    case 'enhance':
                        // Ëá™ÂãïÂ¢ûÂº∑
                        ctx.filter = 'contrast(1.1) saturate(1.1) brightness(1.05)';
                        ctx.drawImage(canvas, 0, 0);
                        ctx.filter = 'none';
                        break;
                    case 'denoise':
                        // ÂéªÂô™ÔºàËºïÂæÆÊ®°Á≥äÔºâ
                        ctx.filter = 'blur(0.5px)';
                        ctx.drawImage(canvas, 0, 0);
                        ctx.filter = 'none';
                        break;
                    case 'sharpen':
                        // Èä≥Âåñ
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        applyConvolution(imageData, [0, -1, 0, -1, 5, -1, 0, -1, 0]);
                        ctx.putImageData(imageData, 0, 0);
                        break;
                    case 'upscale':
                        // ÊîæÂ§ßÔºàÁ∞°ÂñÆÊèíÂÄºÔºâ
                        const scale = 2;
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = canvas.width * scale;
                        tempCanvas.height = canvas.height * scale;
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.imageSmoothingEnabled = true;
                        tempCtx.imageSmoothingQuality = 'high';
                        tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
                        canvas.width = tempCanvas.width;
                        canvas.height = tempCanvas.height;
                        ctx.drawImage(tempCanvas, 0, 0);
                        break;
                    case 'restore':
                        // ‰øÆÂæ©ÔºàÊèêÈ´òÂ∞çÊØîÂíåÊ∏ÖÊô∞Â∫¶Ôºâ
                        ctx.filter = 'contrast(1.2) brightness(1.1)';
                        ctx.drawImage(canvas, 0, 0);
                        ctx.filter = 'none';
                        break;
                }
                
                showToast('‚ú® AI Â¢ûÂº∑ÂÆåÊàêÔºÅ');
            } catch(e) {
                showToast('‚ùå ËôïÁêÜÂ§±Êïó: ' + e.message);
            }
        }
        
        // ===== AI È¢®Ê†ºËΩâÊèõ =====
        function showAiStylePanel() {
            togglePanel('aiStylePanel', 'aiStyleBtn');
        }
        
        function aiStyleTransfer(style) {
            saveHistory();
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            switch(style) {
                case 'anime':
                    // ÂãïÊº´È¢®Ê†ºÔºàÁ∞°ÂåñËâ≤ÂΩ© + ÈÇäÁ∑£Ôºâ
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.floor(data[i] / 32) * 32;
                        data[i+1] = Math.floor(data[i+1] / 32) * 32;
                        data[i+2] = Math.floor(data[i+2] / 32) * 32;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    ctx.filter = 'contrast(1.3) saturate(1.2)';
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                    break;
                case 'watercolor':
                    // Ê∞¥ÂΩ©È¢®Ê†º
                    ctx.filter = 'blur(2px) saturate(1.5)';
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                    break;
                case 'pencil':
                    // ÈâõÁ≠ÜÁ¥†Êèè
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = data[i+1] = data[i+2] = avg;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    applyConvolution(ctx.getImageData(0, 0, canvas.width, canvas.height), [-1, -1, -1, -1, 8, -1, -1, -1, -1]);
                    break;
                case 'impressionist':
                    // Âç∞Ë±°Ê¥æ
                    ctx.filter = 'blur(1px) saturate(1.8) contrast(1.1)';
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                    break;
                case 'pop_art':
                    // ÊôÆÊôÆËóùË°ì
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = data[i] > 128 ? 255 : 0;
                        data[i+1] = data[i+1] > 128 ? 255 : 0;
                        data[i+2] = data[i+2] > 128 ? 255 : 0;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    break;
                case 'cyberpunk':
                    // Ë≥ΩÂçöÈæêÂÖã
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * 0.8 + 50);
                        data[i+1] = data[i+1] * 0.9;
                        data[i+2] = Math.min(255, data[i+2] * 1.2 + 30);
                    }
                    ctx.putImageData(imageData, 0, 0);
                    break;
            }
            
            showToast('üé® È¢®Ê†ºËΩâÊèõÂÆåÊàêÔºÅ');
        }
        
        // ===== Â∞àÊ•≠Ë™øÊï¥Èù¢Êùø =====
        function showLevelsPanel() {
            togglePanel('levelsPanel', 'levelsBtn');
        }
        
        function applyLevels() {
            saveHistory();
            
            const inputBlack = parseInt(document.getElementById('levelsInputBlack')?.value || 0);
            const inputWhite = parseInt(document.getElementById('levelsInputWhite')?.value || 255);
            const gamma = parseFloat(document.getElementById('levelsGamma')?.value || 1);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                for (let c = 0; c < 3; c++) {
                    let value = data[i + c];
                    // Ëº∏ÂÖ•ÁØÑÂúçË™øÊï¥
                    value = (value - inputBlack) / (inputWhite - inputBlack) * 255;
                    // Gamma Ê†°Ê≠£
                    value = Math.pow(value / 255, 1 / gamma) * 255;
                    data[i + c] = Math.min(255, Math.max(0, value));
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üìä Ëâ≤ÈöéÂ∑≤Ë™øÊï¥');
        }
        
        function showCurvesPanel() {
            togglePanel('curvesPanel', 'curvesBtn');
        }
        
        function showHslPanel() {
            togglePanel('hslPanel', 'hslBtn');
        }
        
        function applyHsl() {
            saveHistory();
            
            const hue = parseInt(document.getElementById('hslHue')?.value || 0);
            const saturation = parseInt(document.getElementById('hslSaturation')?.value || 0);
            const lightness = parseInt(document.getElementById('hslLightness')?.value || 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                let [h, s, l] = rgbToHsl(data[i], data[i+1], data[i+2]);
                
                h = (h + hue / 360) % 1;
                s = Math.min(1, Math.max(0, s + saturation / 100));
                l = Math.min(1, Math.max(0, l + lightness / 100));
                
                const [r, g, b] = hslToRgb(h, s, l);
                data[i] = r;
                data[i+1] = g;
                data[i+2] = b;
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('üåà HSL Â∑≤Ë™øÊï¥');
        }
        
        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return [h, s, l];
        }
        
        function hslToRgb(h, s, l) {
            let r, g, b;
            
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }
        
        // ===== Ê∏¨ÈáèÂ∑•ÂÖ∑ =====
        let measureStart = null;
        
        function handleMeasure(start, end) {
            const dx = end.x - start.x;
            const dy = end.y - start.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            // Áï´Ê∏¨ÈáèÁ∑ö
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(start.x, start.y);
            ctx.lineTo(end.x, end.y);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // È°ØÁ§∫Êï∏ÂÄº
            const midX = (start.x + end.x) / 2;
            const midY = (start.y + end.y) / 2;
            ctx.fillStyle = 'white';
            ctx.fillRect(midX - 50, midY - 20, 100, 40);
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${Math.round(distance)} px`, midX, midY - 5);
            ctx.fillText(`${Math.round(angle)}¬∞`, midX, midY + 12);
            
            showToast(`üìè Ë∑ùÈõ¢: ${Math.round(distance)}px, ËßíÂ∫¶: ${Math.round(angle)}¬∞`);
        }
        
        // ===== Áï´Â∏É‰∫ã‰ª∂ =====
        function initCanvasEvents() {
            const container = document.getElementById('canvasContainer');
            
            canvas.addEventListener('mousedown', startSelection);
            canvas.addEventListener('mousemove', updateSelection);
            canvas.addEventListener('mouseup', endSelection);
            
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd);
            
            canvas.addEventListener('click', handleCanvasClick);
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            startSelection({ clientX: touch.clientX, clientY: touch.clientY, target: canvas });
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            updateSelection({ clientX: touch.clientX, clientY: touch.clientY });
        }
        
        function handleTouchEnd(e) {
            endSelection(e);
        }
        
        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: Math.round((e.clientX - rect.left) * (canvas.width / rect.width)),
                y: Math.round((e.clientY - rect.top) * (canvas.height / rect.height))
            };
        }
        
        function setTool(tool) {
            // Toggle ÂàáÊèõÔºöÂÜçÈªû‰∏ÄÊ¨°ÂèñÊ∂à
            if (currentTool === tool) {
                currentTool = null;
                document.getElementById('selectBtn').classList.remove('active');
                document.getElementById('mosaicBtn').classList.remove('active');
                document.getElementById('arrowBtn').classList.remove('active');
                document.getElementById('brushBtn').classList.remove('active');
                document.getElementById('shapeBtn').classList.remove('active');
                document.getElementById('selectBtn2')?.classList.remove('active');
                document.getElementById('eyeDropperAdvBtn')?.classList.remove('active');
                document.getElementById('lassoBtn')?.classList.remove('active');
                document.getElementById('magicWandBtn')?.classList.remove('active');
                canvas.style.cursor = 'default';
                showToast('üîì Â∑•ÂÖ∑Â∑≤ÂèñÊ∂à');
                return;
            }
            
            currentTool = tool;
            
            // Êõ¥Êñ∞ÊâÄÊúâÂ∑•ÂÖ∑ÊåâÈàïÁãÄÊÖã
            document.getElementById('selectBtn').classList.toggle('active', tool === 'select');
            document.getElementById('selectBtn2')?.classList.toggle('active', tool === 'select');
            document.getElementById('mosaicBtn').classList.toggle('active', tool === 'mosaic');
            document.getElementById('arrowBtn').classList.toggle('active', tool === 'arrow');
            document.getElementById('brushBtn').classList.toggle('active', tool === 'brush');
            document.getElementById('shapeBtn').classList.toggle('active', tool === 'shape');
            document.getElementById('eyeDropperAdvBtn')?.classList.toggle('active', tool === 'eyedropperAdv');
            document.getElementById('lassoBtn')?.classList.toggle('active', tool === 'lasso');
            document.getElementById('magicWandBtn')?.classList.toggle('active', tool === 'magicWand');
            
            const cursorTools = ['select', 'mosaic', 'arrow', 'brush', 'shape', 'eyedropperAdv', 'lasso', 'magicWand'];
            canvas.style.cursor = cursorTools.includes(tool) ? 'crosshair' : 'default';
            
            // È°ØÁ§∫ÊèêÁ§∫
            const tips = {
                'select': '‚úÇÔ∏è ÊãñÊõ≥ÈÅ∏ÂèñÂçÄÂüüÔºàÂÜçÈªû‰∏ÄÊ¨°ÂèñÊ∂àÔºâ',
                'mosaic': 'üî≤ ÊãñÊõ≥ÊâìÈ¶¨Ë≥ΩÂÖãÔºàÂÜçÈªû‰∏ÄÊ¨°ÂèñÊ∂àÔºâ',
                'arrow': '‚û°Ô∏è ÊãñÊõ≥Áï´ÁÆ≠È†≠ÔºàÂÜçÈªû‰∏ÄÊ¨°ÂèñÊ∂àÔºâ',
                'brush': 'üñåÔ∏è Âú®Áï´Â∏É‰∏äÁπ™Ë£ΩÔºàÂÜçÈªû‰∏ÄÊ¨°ÂèñÊ∂àÔºâ',
                'shape': '‚≠ï ÊãñÊõ≥Áπ™Ë£ΩÂΩ¢ÁãÄÔºàÂÜçÈªû‰∏ÄÊ¨°ÂèñÊ∂àÔºâ',
                'eyedropperAdv': 'üíâ ÈªûÊìäÁï´Â∏ÉÂèñËâ≤',
                'lasso': 'üîó ÊãñÊõ≥Áπ™Ë£ΩÈÅ∏ÂèñÂçÄÂüü',
                'magicWand': 'ü™Ñ ÈªûÊìäÈÅ∏ÂèñÁõ∏‰ººÈ°èËâ≤ÂçÄÂüü'
            };
            if (tips[tool]) {
                showToast(tips[tool]);
            }
            
            // ÈáçÁΩÆÁÆ≠È†≠Ëµ∑Èªû
            if (tool === 'arrow') {
                arrowStart = null;
            }
        }
        
        function startSelection(e) {
            const coords = getCanvasCoords(e);
            
            // Âê∏Ëâ≤Âô®
            if (eyedropperTarget) {
                pickColor(coords);
                return;
            }
            
            // Áï´Á≠ÜÂ∑•ÂÖ∑
            if (currentTool === 'brush') {
                isDrawing = true;
                lastX = coords.x;
                lastY = coords.y;
                saveHistory();
                return;
            }
            
            // ÂèñËâ≤Âô®Â∑•ÂÖ∑
            if (currentTool === 'eyedropperAdv') {
                const pixel = ctx.getImageData(coords.x, coords.y, 1, 1).data;
                updateColorValues(pixel[0], pixel[1], pixel[2]);
                return;
            }
            
            // È≠îË°ìÊ£íÂ∑•ÂÖ∑
            if (currentTool === 'magicWand') {
                magicWandSelect(coords.x, coords.y);
                return;
            }
            
            // Â•óÁ¥¢Â∑•ÂÖ∑
            if (currentTool === 'lasso') {
                isLassoing = true;
                lassoPoints = [coords];
                saveHistory();
                return;
            }
            
            // ÂΩ¢ÁãÄÂ∑•ÂÖ∑
            if (currentTool === 'shape') {
                isSelecting = true;
                selectionStart = coords;
                selectionEnd = coords;
                saveHistory();
                return;
            }
            
            // ÁÆ≠È†≠Â∑•ÂÖ∑
            if (currentTool === 'arrow') {
                arrowStart = coords;
                return;
            }
            
            // ÂÖ∂‰ªñÂ∑•ÂÖ∑ÈúÄË¶Å select Êàñ mosaic
            if (currentTool !== 'select' && currentTool !== 'mosaic') return;
            
            isSelecting = true;
            selectionStart = coords;
            selectionEnd = coords;
            
            const box = document.getElementById('selectionBox');
            box.style.display = 'block';
            updateSelectionBox();
        }
        
        function updateSelection(e) {
            const coords = getCanvasCoords(e);
            
            // Áï´Á≠ÜÁπ™Ë£Ω
            if (currentTool === 'brush' && isDrawing) {
                drawBrushStroke(lastX, lastY, coords.x, coords.y);
                lastX = coords.x;
                lastY = coords.y;
                return;
            }
            
            // Â•óÁ¥¢Áπ™Ë£Ω
            if (currentTool === 'lasso' && isLassoing) {
                lassoPoints.push(coords);
                // Âç≥ÊôÇÁπ™Ë£ΩÂ•óÁ¥¢Ë∑ØÂæë
                drawLassoPath();
                return;
            }
            
            // ÂΩ¢ÁãÄÈ†êË¶ΩÔºàÂèØÈÅ∏Ôºâ
            if (currentTool === 'shape' && isSelecting) {
                selectionEnd = coords;
                return;
            }
            
            if (!isSelecting) return;
            selectionEnd = coords;
            updateSelectionBox();
        }
        
        function drawLassoPath() {
            if (lassoPoints.length < 2) return;
            
            // Áπ™Ë£ΩËôõÁ∑öË∑ØÂæë
            ctx.save();
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(lassoPoints[0].x, lassoPoints[0].y);
            for (let i = 1; i < lassoPoints.length; i++) {
                ctx.lineTo(lassoPoints[i].x, lassoPoints[i].y);
            }
            ctx.stroke();
            ctx.restore();
        }
        
        function endSelection(e) {
            const coords = getCanvasCoords(e);
            
            // Áï´Á≠ÜÁµêÊùü
            if (currentTool === 'brush' && isDrawing) {
                isDrawing = false;
                return;
            }
            
            // Â•óÁ¥¢ÂÆåÊàê
            if (currentTool === 'lasso' && isLassoing) {
                isLassoing = false;
                if (lassoPoints.length > 2) {
                    completeLassoSelection();
                }
                return;
            }
            
            // ÂΩ¢ÁãÄÁπ™Ë£Ω
            if (currentTool === 'shape' && isSelecting) {
                isSelecting = false;
                const x = Math.min(selectionStart.x, coords.x);
                const y = Math.min(selectionStart.y, coords.y);
                const w = Math.abs(coords.x - selectionStart.x);
                const h = Math.abs(coords.y - selectionStart.y);
                if (w > 5 || h > 5) {
                    drawShape(x, y, w, h);
                }
                return;
            }
            
            // ËôïÁêÜÁÆ≠È†≠
            if (currentTool === 'arrow' && arrowStart) {
                if (Math.abs(coords.x - arrowStart.x) > 10 || Math.abs(coords.y - arrowStart.y) > 10) {
                    drawArrow(arrowStart.x, arrowStart.y, coords.x, coords.y);
                }
                arrowStart = null;
                return;
            }
            
            if (!isSelecting) return;
            isSelecting = false;
            
            const x = Math.min(selectionStart.x, selectionEnd.x);
            const y = Math.min(selectionStart.y, selectionEnd.y);
            const w = Math.abs(selectionEnd.x - selectionStart.x);
            const h = Math.abs(selectionEnd.y - selectionStart.y);
            
            if (w > 5 && h > 5) {
                currentSelection = { x, y, w, h };
                
                // È¶¨Ë≥ΩÂÖãÂ∑•ÂÖ∑Áõ¥Êé•Â•óÁî®
                if (currentTool === 'mosaic') {
                    applyMosaic();
                } else {
                    showToast('‚úÖ Â∑≤ÈÅ∏ÂèñÂçÄÂüü');
                }
            } else {
                currentSelection = null;
                document.getElementById('selectionBox').style.display = 'none';
            }
        }
        
        function completeLassoSelection() {
            // Ë®àÁÆóÂ•óÁ¥¢ÂçÄÂüüÁöÑÈÇäÁïåÊ°Ü
            const xs = lassoPoints.map(p => p.x);
            const ys = lassoPoints.map(p => p.y);
            const minX = Math.min(...xs);
            const minY = Math.min(...ys);
            const maxX = Math.max(...xs);
            const maxY = Math.max(...ys);
            
            // ÂÑ≤Â≠òÈÅ∏ÂèñÂçÄÂüü
            currentSelection = {
                x: minX,
                y: minY,
                w: maxX - minX,
                h: maxY - minY,
                isLasso: true,
                points: [...lassoPoints]
            };
            
            // Áπ™Ë£ΩÂ∞ÅÈñâË∑ØÂæë
            ctx.save();
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(lassoPoints[0].x, lassoPoints[0].y);
            for (let i = 1; i < lassoPoints.length; i++) {
                ctx.lineTo(lassoPoints[i].x, lassoPoints[i].y);
            }
            ctx.closePath();
            ctx.stroke();
            ctx.restore();
            
            showToast(`üîó Â•óÁ¥¢ÈÅ∏ÂèñÂÆåÊàêÔºà${lassoPoints.length} ÈªûÔºâ`);
            lassoPoints = [];
        }
        
        // Áï´Á≠ÜÁπ™Ë£Ω
        function drawBrushStroke(x1, y1, x2, y2) {
            const size = parseInt(document.getElementById('brushSize').value);
            const opacity = parseFloat(document.getElementById('brushOpacity').value);
            const color = document.getElementById('brushColor').value;
            
            ctx.save();
            ctx.globalAlpha = opacity;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            switch(currentBrush) {
                case 'pen':
                    ctx.strokeStyle = color;
                    ctx.lineWidth = size;
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    break;
                    
                case 'marker':
                    ctx.strokeStyle = color;
                    ctx.lineWidth = size * 2;
                    ctx.globalAlpha = opacity * 0.7;
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    break;
                    
                case 'highlighter':
                    ctx.strokeStyle = color;
                    ctx.lineWidth = size * 3;
                    ctx.globalAlpha = 0.3;
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    break;
                    
                case 'spray':
                    ctx.fillStyle = color;
                    for (let i = 0; i < 20; i++) {
                        const offsetX = (Math.random() - 0.5) * size * 2;
                        const offsetY = (Math.random() - 0.5) * size * 2;
                        ctx.fillRect(x2 + offsetX, y2 + offsetY, 1, 1);
                    }
                    break;
                    
                case 'eraser':
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.strokeStyle = 'rgba(0,0,0,1)';
                    ctx.lineWidth = size * 2;
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    ctx.globalCompositeOperation = 'source-over';
                    break;
            }
            
            ctx.restore();
        }
        
        function updateSelectionBox() {
            const container = document.getElementById('canvasContainer');
            const containerRect = container.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            
            // Ë®àÁÆóÁï´Â∏ÉÂú®ÂÆπÂô®‰∏≠ÁöÑÂÅèÁßª
            const offsetX = canvasRect.left - containerRect.left + container.scrollLeft;
            const offsetY = canvasRect.top - containerRect.top + container.scrollTop;
            
            const scaleX = canvasRect.width / canvas.width;
            const scaleY = canvasRect.height / canvas.height;
            
            const x = Math.min(selectionStart.x, selectionEnd.x) * scaleX + offsetX;
            const y = Math.min(selectionStart.y, selectionEnd.y) * scaleY + offsetY;
            const w = Math.abs(selectionEnd.x - selectionStart.x) * scaleX;
            const h = Math.abs(selectionEnd.y - selectionStart.y) * scaleY;
            
            const box = document.getElementById('selectionBox');
            box.style.left = x + 'px';
            box.style.top = y + 'px';
            box.style.width = w + 'px';
            box.style.height = h + 'px';
        }
        
        // ===== È≠îË°ìÊ£íÈÅ∏Âèñ =====
        function magicWandSelect(startX, startY, tolerance = 32) {
            // Á¢∫‰øùÂ∫ßÊ®ôÁÇ∫Êï¥Êï∏
            startX = Math.round(startX);
            startY = Math.round(startY);
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâÂúñÁâá
            if (!currentImage && canvas.width === 300) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàËºâÂÖ•ÂúñÁâá');
                return;
            }
            
            // Ê™¢Êü•Â∫ßÊ®ôÁØÑÂúç
            if (startX < 0 || startX >= canvas.width || startY < 0 || startY >= canvas.height) {
                showToast('‚ö†Ô∏è Ë´ãÈªûÊìäÂúñÁâáÂçÄÂüü');
                return;
            }
            
            saveHistory();
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const width = canvas.width;
            const height = canvas.height;
            
            // ÂèñÂæóËµ∑ÂßãÈªûÈ°èËâ≤
            const startIdx = (startY * width + startX) * 4;
            const targetR = data[startIdx];
            const targetG = data[startIdx + 1];
            const targetB = data[startIdx + 2];
            
            // Ê®ôË®òÂ∑≤Ë®™ÂïèÔºà‰ΩøÁî® Uint8Array Êõ¥Âø´Ôºâ
            const visited = new Uint8Array(width * height);
            const selected = [];
            const queue = [[startX, startY]];
            
            // ‰ΩøÁî®ËºÉÂ§ßÁöÑÂÆπÂ∑Æ
            const actualTolerance = tolerance * 3;
            
            while (queue.length > 0 && selected.length < 500000) {  // ÈôêÂà∂ÊúÄÂ§ßÈÅ∏ÂèñÊï∏
                const [x, y] = queue.shift();
                const pixelIdx = y * width + x;
                
                if (visited[pixelIdx] || x < 0 || x >= width || y < 0 || y >= height) continue;
                visited[pixelIdx] = 1;
                
                const idx = pixelIdx * 4;
                const r = data[idx], g = data[idx + 1], b = data[idx + 2];
                
                // Ê™¢Êü•È°èËâ≤ÊòØÂê¶Áõ∏‰ºº
                const diff = Math.abs(r - targetR) + Math.abs(g - targetG) + Math.abs(b - targetB);
                if (diff <= actualTolerance) {
                    selected.push([x, y]);
                    // Âè™Ê∑ªÂä†Êú™Ë®™ÂïèÁöÑÈÑ∞Â±Ö
                    if (x + 1 < width && !visited[pixelIdx + 1]) queue.push([x + 1, y]);
                    if (x - 1 >= 0 && !visited[pixelIdx - 1]) queue.push([x - 1, y]);
                    if (y + 1 < height && !visited[pixelIdx + width]) queue.push([x, y + 1]);
                    if (y - 1 >= 0 && !visited[pixelIdx - width]) queue.push([x, y - 1]);
                }
            }
            
            if (selected.length === 0) {
                showToast('‚ö†Ô∏è Ê≤íÊúâÈÅ∏ÂèñÂà∞ÂÉèÁ¥†ÔºåË´ãÂòóË©¶ÈªûÊìäÂÖ∂‰ªñÂçÄÂüü');
                return;
            }
            
            // Ê®ôË®òÈÅ∏‰∏≠ÂçÄÂüüÔºàÁî®ËûûËüªÁ∑öÈÇäÊ°ÜËÄåÈùûÊîπËÆäÈ°èËâ≤Ôºâ
            // ÂÖàÁï´ÈÇäÁïå
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            // Áπ™Ë£ΩÈÅ∏ÂèñÈÅÆÁΩ©
            tempCtx.fillStyle = 'rgba(0, 150, 255, 0.3)';
            selected.forEach(([x, y]) => {
                tempCtx.fillRect(x, y, 1, 1);
            });
            
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast(`ü™Ñ Â∑≤ÈÅ∏Âèñ ${selected.length.toLocaleString()} ÂÄãÂÉèÁ¥†`);
            
            // ÂÑ≤Â≠òÈÅ∏ÂèñÂçÄÂüüÁöÑÈÇäÁïå
            if (selected.length > 0) {
                const xs = selected.map(p => p[0]);
                const ys = selected.map(p => p[1]);
                currentSelection = {
                    x: Math.min(...xs),
                    y: Math.min(...ys),
                    w: Math.max(...xs) - Math.min(...xs) + 1,
                    h: Math.max(...ys) - Math.min(...ys) + 1,
                    isMagicWand: true,
                    pixels: selected
                };
            }
        }
        
        // ===== Ê∏ÖÈô§ÈÅ∏ÂèñÂçÄÂüü =====
        function clearSelection() {
            if (!currentSelection) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÈÅ∏ÂèñÂçÄÂüü');
                return;
            }
            
            saveHistory(); // ÂÑ≤Â≠òÊ≠∑Âè≤‰æõÂæ©Âéü
            
            const bgColor = document.getElementById('bgColor').value;
            ctx.fillStyle = bgColor;
            ctx.fillRect(currentSelection.x, currentSelection.y, currentSelection.w, currentSelection.h);
            
            // Êõ¥Êñ∞ PDF Êö´Â≠ò
            if (pdfDoc && pdfPages[currentPageNum - 1]) {
                pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            showToast('üßπ Â∑≤Ê∏ÖÈô§ÔºÅ');
        }
        
        // ===== Âê∏ÁÆ°Â∑•ÂÖ∑ =====
        function startEyedropper(target) {
            eyedropperTarget = target;
            document.getElementById('textEyedropper').classList.toggle('active', target === 'text');
            document.getElementById('bgEyedropper').classList.toggle('active', target === 'bg');
            canvas.style.cursor = 'crosshair';
            showToast('üíß ÈªûÊìäÂúñÁâáÂê∏ÂèñÈ°èËâ≤');
        }
        
        function handleCanvasClick(e) {
            const coords = getCanvasCoords(e);
            
            // ÂúñÁ´†ÊîæÁΩÆÊ®°Âºè
            if (stampDragMode && pendingStamp) {
                placeStampAt(pendingStamp, coords.x, coords.y);
                pendingStamp = null;
                stampDragMode = false;
                canvas.style.cursor = 'default';
                return;
            }
            
            // Á∞ΩÂêçÊîæÁΩÆÊ®°Âºè
            if (signDragMode && pendingSign) {
                placeSignAt(coords.x, coords.y);
                return;
            }
            
            // Ë≤ºÂúñÊîæÁΩÆÊ®°Âºè
            if (stickerDragMode && pendingSticker) {
                placeStickerAt(pendingSticker, coords.x, coords.y);
                return;
            }
            
            // QR Á¢ºÊîæÁΩÆÊ®°Âºè
            if (qrDragMode && pendingQR) {
                placeQRAt(coords.x, coords.y);
                return;
            }
            
            // ÊñáÂ≠óÁâπÊïàÊîæÁΩÆÊ®°Âºè
            if (textFxDragMode && pendingTextFx) {
                applyTextFxAt(pendingTextFx.style, pendingTextFx.text, coords.x, coords.y);
                return;
            }
            
            // Âê∏Ëâ≤Âô®
            if (eyedropperTarget) {
                pickColor(coords);
            }
        }
        
        function pickColor(coords) {
            const pixel = ctx.getImageData(coords.x, coords.y, 1, 1).data;
            const hex = '#' + [pixel[0], pixel[1], pixel[2]].map(x => x.toString(16).padStart(2, '0')).join('');
            
            if (eyedropperTarget === 'text') {
                document.getElementById('textColor').value = hex;
            } else {
                document.getElementById('bgColor').value = hex;
            }
            
            document.getElementById('textEyedropper').classList.remove('active');
            document.getElementById('bgEyedropper').classList.remove('active');
            eyedropperTarget = null;
            canvas.style.cursor = currentTool === 'select' ? 'crosshair' : 'default';
            showToast('üé® Â∑≤Âê∏ÂèñÈ°èËâ≤ ' + hex);
        }
        
        // ===== ÊñáÂ≠óÊ®£Âºè =====
        function toggleStyle(style) {
            textStyle[style] = !textStyle[style];
            document.getElementById(style + 'Btn').classList.toggle('active', textStyle[style]);
        }
        
        function setAlign(align) {
            textStyle.align = align;
        }
        
        // ===== Âø´ÈÄüÊ∑ªÂä†ÊñáÂ≠óÔºàÊãñÊõ≥Ê®°ÂºèÔºâ=====
        function addQuickText() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                showToast('‚ö†Ô∏è Ë´ãËº∏ÂÖ•ÊñáÂ≠ó');
                return;
            }
            
            const fontSize = parseInt(document.getElementById('fontSize').value) || 24;
            const color = document.getElementById('textColor').value;
            
            createDragObject('quicktext', text, {
                fontSize,
                color,
                bold: textStyle.bold,
                italic: textStyle.italic
            }, quickTextPosition);
        }
        
        function setQuickTextPosition(pos, btn) {
            quickTextPosition = pos;
            document.querySelectorAll('#textPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        // ===== ÊáâÁî®ÊñáÂ≠óÔºàÈÅ∏ÂèñÂçÄÊ®°ÂºèÔºâ=====
        function applyText() {
            if (!currentSelection) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÁî® ‚úÇÔ∏è ÈÅ∏ÂèñÂçÄÂüü');
                return;
            }
            
            const text = document.getElementById('textInput').value;
            if (!text.trim()) {
                showToast('‚ö†Ô∏è Ë´ãËº∏ÂÖ•ÊñáÂ≠ó');
                return;
            }
            
            const fontSize = parseInt(document.getElementById('fontSize').value) || 16;
            const textColor = document.getElementById('textColor').value;
            const bgColor = document.getElementById('bgColor').value;
            
            // Â°´ÂÖÖËÉåÊôØ
            ctx.fillStyle = bgColor;
            ctx.fillRect(currentSelection.x, currentSelection.y, currentSelection.w, currentSelection.h);
            
            // Ë®≠ÂÆöÊñáÂ≠óÊ®£Âºè
            let fontStyle = '';
            if (textStyle.bold) fontStyle += 'bold ';
            if (textStyle.italic) fontStyle += 'italic ';
            ctx.font = `${fontStyle}${fontSize}px sans-serif`;
            ctx.fillStyle = textColor;
            ctx.textBaseline = 'top';
            
            // ÊñáÂ≠óÊèõË°åËôïÁêÜ
            const lines = text.split('\n');
            const lineHeight = fontSize * 1.3;
            let y = currentSelection.y + 5;
            
            lines.forEach(line => {
                let x = currentSelection.x + 5;
                if (textStyle.align === 'center') {
                    const textWidth = ctx.measureText(line).width;
                    x = currentSelection.x + (currentSelection.w - textWidth) / 2;
                } else if (textStyle.align === 'right') {
                    const textWidth = ctx.measureText(line).width;
                    x = currentSelection.x + currentSelection.w - textWidth - 5;
                }
                
                ctx.fillText(line, x, y);
                
                // Â∫ïÁ∑ö
                if (textStyle.underline) {
                    const textWidth = ctx.measureText(line).width;
                    ctx.beginPath();
                    ctx.moveTo(x, y + fontSize);
                    ctx.lineTo(x + textWidth, y + fontSize);
                    ctx.strokeStyle = textColor;
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
                
                y += lineHeight;
            });
            
            // Êõ¥Êñ∞ PDF Êö´Â≠ò
            if (pdfDoc && pdfPages[currentPageNum - 1]) {
                pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            // Ê∏ÖÈô§ÈÅ∏Âèñ
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            document.getElementById('textInput').value = '';
            
            showToast('‚úÖ ÊñáÂ≠óÂ∑≤ÊáâÁî®ÔºÅ');
        }
        
        // ===== ÈçµÁõ§‰∫ã‰ª∂ =====
        function initKeyboardEvents() {
            document.getElementById('textInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    applyText();
                }
            });
        }
        
        // ===== ‰∏ãËºâÂäüËÉΩ =====
        function downloadPNG() {
            const link = document.createElement('a');
            link.download = `magic-edit-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('üñºÔ∏è PNG ‰∏ãËºâ‰∏≠...');
        }
        
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            
            // ÂÑ≤Â≠òÁï∂ÂâçÈ†Å
            if (pdfDoc) {
                pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            showToast('üìÑ Áî¢Áîü PDF ‰∏≠...');
            
            // Âª∫Á´ãËá®ÊôÇ canvas
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            let pdf = null;
            
            if (pdfDoc && pdfPages.length > 0) {
                // Â§öÈ†Å PDF
                for (let i = 0; i < pdfPages.length; i++) {
                    if (!pdfPages[i]) {
                        await renderPdfPage(i + 1);
                    }
                    
                    const pageData = pdfPages[i];
                    tempCanvas.width = pageData.width;
                    tempCanvas.height = pageData.height;
                    tempCtx.putImageData(pageData, 0, 0);
                    
                    const imgData = tempCanvas.toDataURL('image/jpeg', 0.9);
                    const width = pageData.width * 0.264583;
                    const height = pageData.height * 0.264583;
                    
                    if (i === 0) {
                        pdf = new jsPDF({
                            orientation: width > height ? 'l' : 'p',
                            unit: 'mm',
                            format: [width, height]
                        });
                    } else {
                        pdf.addPage([width, height], width > height ? 'l' : 'p');
                    }
                    
                    pdf.addImage(imgData, 'JPEG', 0, 0, width, height);
                }
            } else {
                // ÂñÆÂºµÂúñÁâá
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const width = canvas.width * 0.264583;
                const height = canvas.height * 0.264583;
                
                pdf = new jsPDF({
                    orientation: width > height ? 'l' : 'p',
                    unit: 'mm',
                    format: [width, height]
                });
                
                pdf.addImage(imgData, 'JPEG', 0, 0, width, height);
            }
            
            pdf.save(`magic-edit-${Date.now()}.pdf`);
            showToast('üìÑ PDF ‰∏ãËºâÂÆåÊàêÔºÅ');
        }
        
        // ===== LINE ÂàÜ‰∫´ =====
        async function sendToLine() {
            if (!settings.gasUrl) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàË®≠ÂÆö GAS URL');
                showPage('settings');
                return;
            }
            
            showToast('üí¨ ÂÇ≥ÈÄÅ‰∏≠...');
            
            const imageData = canvas.toDataURL('image/png');
            
            try {
                const payload = {
                    action: 'sendImage',
                    image: imageData
                };
                
                if (settings.lineUserId) {
                    payload.userId = settings.lineUserId;
                }
                
                await fetch(settings.gasUrl, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    mode: 'no-cors'
                });
                showToast('‚úÖ Â∑≤ÂÇ≥ÈÄÅÂà∞ LINEÔºÅ');
            } catch (e) {
                showToast('‚ùå ÂÇ≥ÈÄÅÂ§±Êïó');
            }
        }
        
        // ===== Ë®≠ÂÆö =====
        function loadSettings() {
            const s = localStorage.getItem('imageMagicSettings');
            if (s) {
                settings = { ...settings, ...JSON.parse(s) };
                document.getElementById('gasUrl').value = settings.gasUrl || '';
                document.getElementById('lineUserId').value = settings.lineUserId || '';
                document.getElementById('geminiApiKey').value = settings.geminiApiKey || '';
                document.getElementById('groqApiKey').value = settings.groqApiKey || '';
            }
        }
        
        function saveSettings() {
            settings.gasUrl = document.getElementById('gasUrl').value.trim();
            settings.lineUserId = document.getElementById('lineUserId').value.trim();
            settings.geminiApiKey = document.getElementById('geminiApiKey').value.trim();
            settings.groqApiKey = document.getElementById('groqApiKey').value.trim();
            localStorage.setItem('imageMagicSettings', JSON.stringify(settings));
            showToast('üíæ Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠òÔºÅ');
        }
        
        function clearSettings() {
            if (!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâË®≠ÂÆöÂóéÔºü')) return;
            settings = { gasUrl: '', lineUserId: '', geminiApiKey: '', groqApiKey: '' };
            document.getElementById('gasUrl').value = '';
            document.getElementById('lineUserId').value = '';
            document.getElementById('geminiApiKey').value = '';
            document.getElementById('groqApiKey').value = '';
            localStorage.removeItem('imageMagicSettings');
            showToast('üóëÔ∏è Ë®≠ÂÆöÂ∑≤Ê∏ÖÈô§ÔºÅ');
        }
        
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }
        
        async function testLineNotify() {
            // ÂÖàÂèñÂæóÁï∂ÂâçËº∏ÂÖ•ÂÄº
            const gasUrl = document.getElementById('gasUrl').value.trim();
            const lineUserId = document.getElementById('lineUserId').value.trim();
            
            if (!gasUrl) {
                showToast('‚ö†Ô∏è Ë´ãÂÖàÂ°´ÂØ´ GAS ÈÉ®ÁΩ≤ URL');
                return;
            }
            
            showToast('üì° Ê≠£Âú®Ê∏¨Ë©¶ LINE ÈÄ£Á∑ö...');
            
            try {
                const payload = { action: 'testNotify' };
                if (lineUserId) {
                    payload.userId = lineUserId;
                }
                
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'no-cors'
                });
                
                showToast('‚úÖ Ê∏¨Ë©¶Ë®äÊÅØÂ∑≤ÁôºÈÄÅÔºåË´ãÊ™¢Êü• LINEÔºÅ');
            } catch (error) {
                showToast('‚ùå Ê∏¨Ë©¶Â§±ÊïóÔºö' + error.message);
            }
        }
        
        // ===== Toast =====
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
