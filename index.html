<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ğŸ© åœ–æ–‡é­”è¡“å¸« V2.0 çµ‚æ¥µç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --primary-dark: #7c3aed;
            --secondary: #06b6d4;
            --accent: #f472b6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-input: #0f3460;
            --text-primary: #ffffff;
            --text-secondary: #a0aec0;
            --border: #4a5568;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ===== é–‹æ©Ÿå‹•ç•« ===== */
        #splashScreen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s, visibility 0.5s;
        }
        #splashScreen.fade-out { opacity: 0; visibility: hidden; }
        .splash-logo {
            font-size: 120px;
            animation: spinMagic 2s ease-in-out infinite;
            text-shadow: 0 0 50px rgba(255,255,255,0.5);
        }
        @keyframes spinMagic {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.1); }
            100% { transform: rotateY(360deg) scale(1); }
        }
        .splash-title {
            font-size: 32px;
            font-weight: bold;
            margin-top: 20px;
            background: linear-gradient(90deg, #fff, #f0abfc, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .splash-version { color: rgba(255,255,255,0.8); margin-top: 10px; }
        .splash-loading {
            margin-top: 30px;
            width: 150px; height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        .splash-loading::after {
            content: '';
            display: block;
            width: 50%; height: 100%;
            background: white;
            animation: loading 1s ease-in-out infinite;
        }
        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(300%); }
        }
        
        /* ===== ç¯€æ…¶æ•ˆæœ ===== */
        #festivalEffect {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        .festival-item {
            position: absolute;
            top: -60px;
            animation: festivalFall linear infinite;
            font-size: 24px;
            opacity: 0.7;
        }
        @keyframes festivalFall {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(110vh) rotate(360deg); }
        }
        
        /* ===== ä¸»å®¹å™¨ ===== */
        .app-container {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* ===== Header ===== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .header-left { display: flex; align-items: center; gap: 8px; }
        .header-logo { font-size: 28px; animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .header-title { font-size: 18px; font-weight: bold; }
        .header-version {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .header-time { font-size: 11px; opacity: 0.9; }
        .header-festival { font-size: 22px; }
        
        /* ===== å·¥å…·åˆ— ===== */
        .toolbar {
            background: var(--bg-card);
            padding: 8px 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            border-bottom: 1px solid var(--border);
        }
        .toolbar-categories {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .toolbar-categories::-webkit-scrollbar { height: 4px; }
        .toolbar-categories::-webkit-scrollbar-track { background: var(--bg-input); border-radius: 2px; }
        .toolbar-categories::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 2px; }
        .category-btn {
            flex-shrink: 0;
            padding: 8px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .category-btn:hover { background: var(--bg-dark); border-color: var(--primary); }
        .category-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .category-btn .cat-icon { font-size: 14px; }
        .toolbar-tools {
            display: none;
            gap: 6px;
            overflow-x: auto;
            padding: 5px 0;
            animation: slideDown 0.2s ease;
        }
        .toolbar-tools.show { display: flex; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* é›»è…¦ç‰ˆé¡¯ç¤ºç´°ç·»æ»¾å‹•æ¢ */
        .toolbar-tools::-webkit-scrollbar { height: 6px; }
        .toolbar-tools::-webkit-scrollbar-track { background: var(--bg-input); border-radius: 3px; }
        .toolbar-tools::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
        .toolbar-tools::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        .tool-btn {
            flex-shrink: 0;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            white-space: nowrap;
            position: relative;
        }
        .tool-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: scale(1.05);
        }
        .tool-btn.active {
            background: var(--primary);
            border-color: var(--primary-light);
            transform: scale(1.05);
            box-shadow: 0 0 12px var(--primary), 0 0 24px rgba(139, 92, 246, 0.4);
            animation: toolPulse 1.5s ease-in-out infinite;
        }
        .tool-btn.active::after {
            content: 'âœ“';
            position: absolute;
            top: -6px;
            right: -6px;
            width: 16px;
            height: 16px;
            background: var(--success);
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        @keyframes toolPulse {
            0%, 100% { box-shadow: 0 0 12px var(--primary), 0 0 24px rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 0 18px var(--primary), 0 0 36px rgba(139, 92, 246, 0.6); }
        }
        .tool-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .tool-btn .icon { font-size: 14px; }
        
        /* ===== PDF æ§åˆ¶åˆ— ===== */
        .pdf-controls {
            background: var(--bg-card);
            padding: 8px 15px;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }
        .pdf-controls.show { display: flex; }
        .pdf-nav-btn {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        .pdf-nav-btn:disabled { opacity: 0.3; }
        .pdf-page-info { font-size: 13px; min-width: 70px; text-align: center; }
        
        /* ===== ä¸»ç·¨è¼¯å€ ===== */
        .editor-area { padding: 15px; }
        
        /* ===== ä¸Šå‚³å€ ===== */
        .upload-zone {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-input));
            border: 2px dashed var(--primary);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            transition: all 0.3s;
        }
        .upload-zone.dragover {
            border-color: var(--accent);
            transform: scale(1.02);
        }
        .upload-zone.hidden { display: none; }
        .upload-icon { font-size: 50px; margin-bottom: 10px; animation: bounce 2s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .upload-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .upload-subtitle { color: var(--text-secondary); font-size: 12px; margin-bottom: 15px; }
        
        /* é¦–é èªªæ˜å€å¡Š */
        .home-guide {
            margin-top: 20px;
            padding: 15px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 15px;
            border: 1px solid var(--primary);
            text-align: left;
        }
        .guide-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .guide-intro {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .guide-steps {
            margin-bottom: 12px;
        }
        .guide-step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 12px;
            color: var(--text-primary);
        }
        .step-icon {
            font-size: 14px;
        }
        .guide-features {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .feature-tag {
            padding: 6px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .feature-tag:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }
        .guide-hint {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 10px;
            opacity: 0.7;
        }
        
        @keyframes highlight {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 15px 5px var(--primary); transform: scale(1.1); }
        }
        
        .upload-buttons { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
        .upload-btn {
            padding: 10px 16px;
            border-radius: 20px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .upload-btn.primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; }
        .upload-btn.secondary { background: var(--bg-input); color: white; border: 1px solid var(--border); }
        .upload-btn:hover { transform: scale(1.05); }
        
        /* ===== ç•«å¸ƒå€ ===== */
        .canvas-wrapper {
            display: none;
            position: relative;
            background: #2d2d2d;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .canvas-wrapper.show { display: block; }
        .canvas-container {
            position: relative;
            overflow: auto;
            max-height: 65vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: repeating-conic-gradient(#1a1a2e 0% 25%, #252540 0% 50%) 50% / 20px 20px;
            border-radius: 10px;
            padding: 10px;
        }
        #mainCanvas { 
            display: block; 
            max-width: 100%; 
            max-height: calc(65vh - 20px);
            width: auto;
            height: auto;
            cursor: crosshair;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .canvas-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            flex-wrap: wrap;
            gap: 8px;
        }
        .canvas-info-bar span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #canvasInfo::before { content: 'ğŸ“ '; }
        
        /* å·¥å…·ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        .tool-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            animation: toolStatusPulse 2s ease-in-out infinite;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
        }
        @keyframes toolStatusPulse {
            0%, 100% { box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 2px 16px rgba(139, 92, 246, 0.7); }
        }
        .tool-status-icon { font-size: 14px; }
        .tool-status-name { white-space: nowrap; }
        .tool-status-cancel {
            width: 18px;
            height: 18px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            margin-left: 2px;
        }
        .tool-status-cancel:hover {
            background: rgba(255,255,255,0.4);
            transform: scale(1.1);
        }
        
        #zoomInfo { 
            cursor: pointer; 
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 50px;
            text-align: center;
        }
        #zoomInfo:hover { background: var(--bg-input); }
        #zoomInfo::before { content: 'ğŸ” '; }
        .canvas-quick-tools {
            display: flex;
            gap: 5px;
        }
        .quick-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .quick-btn:hover { background: var(--primary); transform: scale(1.05); }
        .quick-btn:active { transform: scale(0.95); }
        .quick-btn.active { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .quick-btn.danger:hover { background: #ef4444; }
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .zoom-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .zoom-btn:hover { background: var(--primary); }
        .zoom-btn:active { transform: scale(0.95); }
        .zoom-btn.fit { font-size: 14px; }
        .zoom-hint {
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
            padding: 5px;
            opacity: 0.7;
        }
        .selection-box {
            position: absolute;
            border: 2px dashed var(--accent);
            background: rgba(244, 114, 182, 0.2);
            pointer-events: none;
            display: none;
        }
        
        /* æ‹–æ›³åœ–å±¤ */
        .drag-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .drag-object {
            position: absolute;
            cursor: move;
            pointer-events: auto;
            border: 3px dashed var(--primary);
            border-radius: 8px;
            background: rgba(99, 102, 241, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            touch-action: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4), 0 0 30px rgba(139, 92, 246, 0.3);
            animation: dragPulse 1.5s infinite;
            transition: box-shadow 0.2s;
        }
        .drag-object::before {
            content: 'âŠ•';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            color: var(--primary);
            opacity: 0.3;
            pointer-events: none;
        }
        .drag-object:hover {
            border-color: var(--accent);
            box-shadow: 0 0 30px var(--primary), 0 8px 25px rgba(0,0,0,0.5);
        }
        .drag-object.dragging {
            opacity: 0.9;
            transform: scale(1.05);
            border-style: solid;
            box-shadow: 0 0 40px var(--accent), 0 10px 30px rgba(0,0,0,0.5);
        }
        .drag-object img {
            max-width: 100%;
            max-height: 100%;
            pointer-events: none;
        }
        .drag-object-text {
            white-space: nowrap;
            pointer-events: none;
        }
        @keyframes dragPulse {
            0%, 100% { border-color: var(--primary); }
            50% { border-color: var(--accent); }
        }
        .drag-controls {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-top: 10px;
            border: 1px solid var(--border);
        }
        .drag-controls.show { display: flex; }
        .drag-controls-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        .drag-hint {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }
        .drag-position-info {
            font-size: 11px;
            color: var(--primary);
            background: var(--bg-input);
            padding: 4px 10px;
            border-radius: 12px;
            font-family: monospace;
        }
        .drag-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            font-weight: bold;
        }
        .drag-btn.confirm {
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }
        .drag-btn.cancel {
            background: var(--bg-input);
            color: var(--text-primary);
        }
        .drag-btn:hover { transform: scale(1.05); }
        .drag-btn:active { transform: scale(0.95); }
        
        /* å¾®èª¿æ§åˆ¶ */
        .drag-nudge-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .drag-nudge-row {
            display: flex;
            gap: 2px;
        }
        .drag-nudge-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .drag-nudge-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }
        .drag-nudge-btn:active {
            transform: scale(0.9);
        }
        .drag-nudge-btn.center {
            background: var(--primary);
            color: white;
        }
        
        /* ===== AI åˆ†æé¢æ¿ ===== */
        .ai-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--primary);
        }
        .ai-panel.show { display: block; }
        .ai-model-select {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .ai-model-select label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .ai-model-select select {
            flex: 1;
            padding: 8px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 12px;
        }
        .ai-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .ai-option {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: var(--bg-input);
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ai-option:has(input:checked) {
            background: var(--primary);
        }
        .ai-option input { display: none; }
        .ai-analyze-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        .ai-analyze-btn:hover { transform: scale(1.02); }
        .ai-analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .ai-result {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 12px;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 12px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .ai-result-placeholder {
            color: var(--text-secondary);
            text-align: center;
            padding: 30px 0;
        }
        .ai-result.loading {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ai-result.loading::after {
            content: '';
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .ai-actions {
            display: flex;
            gap: 8px;
        }
        
        /* ===== PDF å·¥å…·é¢æ¿ ===== */
        .pdf-tool-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--secondary);
        }
        .pdf-tool-panel.show { display: block; }
        .pdf-pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 12px 0;
            max-height: 250px;
            overflow-y: auto;
            padding: 5px;
        }
        .pdf-page-thumb {
            position: relative;
            aspect-ratio: 3/4;
            background: var(--bg-input);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .pdf-page-thumb:hover { border-color: var(--primary); }
        .pdf-page-thumb.selected { border-color: var(--accent); }
        .pdf-page-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .pdf-page-thumb .page-num {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 10px;
            text-align: center;
            padding: 2px;
        }
        .pdf-page-thumb .check-mark {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .pdf-page-thumb.selected .check-mark { display: flex; }
        .pdf-tool-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .pdf-tool-btn {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .pdf-tool-btn:hover { transform: scale(1.02); }
        .pdf-tool-btn.select-all { background: var(--bg-input); color: white; border: 1px solid var(--border); }
        .pdf-tool-btn.export-images { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
        .pdf-tool-btn.export-pdf { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        
        /* ===== æµ®æ°´å°å·¥å…·é¢æ¿ ===== */
        .watermark-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--accent);
        }
        .watermark-panel.show { display: block; }
        .watermark-section { margin-bottom: 15px; }
        .section-subtitle {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--accent);
        }
        .watermark-type-select {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .watermark-type {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .watermark-type:has(input:checked) { background: var(--primary); }
        .watermark-type input { display: none; }
        .wm-input {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .wm-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .wm-option {
            flex: 1;
            min-width: 80px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .wm-option label {
            font-size: 10px;
            color: var(--text-secondary);
        }
        .wm-option input[type="number"] {
            width: 100%;
            padding: 6px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 12px;
        }
        .wm-option input[type="range"] {
            width: 100%;
            accent-color: var(--primary);
        }
        .wm-option input[type="color"] {
            width: 100%;
            height: 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .wm-upload-btn {
            width: 100%;
            padding: 12px;
            background: var(--bg-input);
            border: 2px dashed var(--border);
            border-radius: 10px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .wm-upload-btn:hover { border-color: var(--primary); }
        .wm-image-preview {
            width: 100%;
            height: 80px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .wm-image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .wm-position {
            margin-bottom: 12px;
        }
        .wm-position > label {
            font-size: 11px;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 8px;
        }
        .position-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            max-width: 150px;
            margin-bottom: 10px;
        }
        .pos-btn {
            aspect-ratio: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pos-btn:hover, .pos-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        .tile-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .tile-option input {
            accent-color: var(--primary);
        }
        .wm-action-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }
        .wm-action-btn:hover { transform: scale(1.02); }
        .wm-action-btn.add {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
        }
        .wm-action-btn.remove {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
        }
        .wm-action-btn.remove-manual {
            background: var(--bg-input);
            color: white;
            border: 1px solid var(--border);
        }
        .wm-divider {
            height: 1px;
            background: var(--border);
            margin: 15px 0;
        }
        .wm-remove-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .wm-model-select {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .wm-model-select label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .wm-model-select select {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 12px;
        }
        
        /* ===== æ–‡å­—ç·¨è¼¯é¢æ¿ ===== */
        .text-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
        .text-panel.show { display: block; }
        
        /* ===== é€šç”¨åŠŸèƒ½é¢æ¿ ===== */
        .stamp-panel, .sign-panel, .filter-panel, .adjust-panel, 
        .frame-panel, .sticker-panel, .crop-panel, .merge-panel, 
        .qr-panel, .compress-panel, .arrow-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .stamp-panel.show, .sign-panel.show, .filter-panel.show, .adjust-panel.show,
        .frame-panel.show, .sticker-panel.show, .crop-panel.show, .merge-panel.show,
        .qr-panel.show, .compress-panel.show, .arrow-panel.show { display: block; }
        
        /* é€²éšåŠŸèƒ½é¢æ¿ï¼ˆé è¨­éš±è—ï¼‰ */
        .photo-filter-panel, .selective-color-panel, .color-balance-panel, .histogram-panel,
        .curve-panel, .liquify-panel, .layer-panel, .channel-panel, .align-panel, .guide-panel,
        .dot-art-panel, .color-splash-panel, .slim-face-panel, .big-eye-panel, .makeup-panel,
        .face-swap-panel, .skeleton-panel, .lens-blur-panel, .motion-blur-panel, .warp-panel,
        .perspective-panel, .distort-panel, .card-panel, .logo-panel, .cinema-panel, .film-panel,
        .vintage-panel, .lut-panel, .color-grade-panel, .split-tone-panel, .eyedropper-panel,
        .gif-panel, .level-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .photo-filter-panel.show, .selective-color-panel.show, .color-balance-panel.show, .histogram-panel.show,
        .curve-panel.show, .liquify-panel.show, .layer-panel.show, .channel-panel.show, .align-panel.show, .guide-panel.show,
        .dot-art-panel.show, .color-splash-panel.show, .slim-face-panel.show, .big-eye-panel.show, .makeup-panel.show,
        .face-swap-panel.show, .skeleton-panel.show, .lens-blur-panel.show, .motion-blur-panel.show, .warp-panel.show,
        .perspective-panel.show, .distort-panel.show, .card-panel.show, .logo-panel.show, .cinema-panel.show, .film-panel.show,
        .vintage-panel.show, .lut-panel.show, .color-grade-panel.show, .split-tone-panel.show, .eyedropper-panel.show,
        .gif-panel.show, .level-panel.show { display: block; }
        
        /* å·¥å…·æç¤º */
        .tool-tip {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 10px 15px;
            margin-top: 10px;
            border-left: 3px solid var(--primary);
        }
        .tip-content { font-size: 12px; color: var(--text-secondary); }
        
        /* åœ–ç« é¢æ¿ */
        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .stamp-item {
            padding: 10px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .stamp-item:hover { background: var(--primary); transform: scale(1.05); }
        .stamp-custom {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .stamp-custom input {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 12px;
        }
        .stamp-custom button {
            padding: 8px 15px;
            background: var(--primary);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }
        .stamp-options { display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* ç°½åé¢æ¿ */
        #signCanvas {
            width: 100%;
            height: 150px;
            background: white;
            border-radius: 10px;
            cursor: crosshair;
            touch-action: none;
        }
        .sign-options {
            display: flex;
            gap: 15px;
            margin: 12px 0;
        }
        .sign-actions {
            display: flex;
            gap: 10px;
        }
        
        /* æ¿¾é¡é¢æ¿ */
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .filter-preview-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 12px;
        }
        .filter-preview-area canvas {
            border-radius: 8px;
            border: 2px solid var(--border);
            margin-bottom: 8px;
        }
        .filter-preview-area span {
            font-size: 12px;
            color: var(--accent);
            font-weight: bold;
        }
        .filter-item {
            padding: 12px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-item:hover { background: var(--primary); }
        
        /* èª¿æ•´é¢æ¿ */
        .adjust-sliders { margin-bottom: 15px; }
        .adjust-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .adjust-item label {
            min-width: 50px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .adjust-item input[type="range"] {
            flex: 1;
            accent-color: var(--primary);
        }
        .adjust-item span {
            min-width: 35px;
            font-size: 11px;
            text-align: right;
        }
        .adjust-actions { display: flex; gap: 10px; }
        
        /* é‚Šæ¡†é¢æ¿ */
        .frame-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .frame-item {
            padding: 12px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .frame-item:hover { background: var(--primary); }
        .frame-options { display: flex; gap: 15px; flex-wrap: wrap; }
        
        /* è²¼åœ–é¢æ¿ */
        .sticker-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }
        .sticker-tab {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        .sticker-tab.active { background: var(--primary); }
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .sticker-item {
            aspect-ratio: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .sticker-item:hover { transform: scale(1.2); }
        .sticker-options { display: flex; gap: 15px; }
        
        /* è£åˆ‡é¢æ¿ */
        .crop-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .crop-preset {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .crop-preset:hover, .crop-preset.active { background: var(--primary); }
        .crop-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 8px;
        }
        
        /* æ‹¼æ¥é¢æ¿ */
        .merge-direction {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        .merge-dir {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .merge-dir:has(input:checked) { background: var(--primary); }
        .merge-dir input { accent-color: var(--primary); }
        .merge-list {
            margin-bottom: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        .merge-item {
            padding: 8px 12px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .merge-item.current { border-left: 3px solid var(--primary); }
        .merge-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
        }
        .merge-item .remove-merge {
            margin-left: auto;
            background: var(--danger);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            color: white;
            cursor: pointer;
            font-size: 10px;
        }
        
        /* QR Code é¢æ¿ */
        .qr-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 12px 0;
        }
        .qr-preview {
            width: 100%;
            min-height: 120px;
            background: var(--bg-input);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }
        .qr-preview canvas { max-width: 100%; }
        
        /* å£“ç¸®é¢æ¿ */
        .compress-info {
            background: var(--bg-input);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 12px;
        }
        .compress-info div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .compress-info div:last-child { margin-bottom: 0; }
        .compress-slider {
            margin-bottom: 12px;
        }
        .compress-slider label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .compress-slider input {
            width: 100%;
            accent-color: var(--primary);
        }
        .compress-resize {
            margin-bottom: 12px;
        }
        .compress-resize > label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .compress-resize input[type="checkbox"] { accent-color: var(--primary); }
        .resize-options {
            margin-top: 8px;
        }
        .resize-options select {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        
        /* ===== æ–°åŠŸèƒ½é¢æ¿é€šç”¨æ¨£å¼ ===== */
        .brush-panel, .shape-panel, .textfx-panel, .template-panel, .collage-panel,
        .beauty-panel, .removebg-panel, .batch-panel, .effect-panel, .overlay-panel,
        .annotate-panel, .history-panel, .info-panel, .colorreplace-panel, .idphoto-panel,
        .screenshot-panel, .pixelart-panel, .ascii-panel, .duotone-panel, .gradient-panel,
        .noise-panel, .blurbg-panel, .texture-panel, .bokeh-panel, .mirror-panel,
        .split-panel, .social-panel, .export-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .brush-panel.show, .shape-panel.show, .textfx-panel.show, .template-panel.show,
        .collage-panel.show, .beauty-panel.show, .removebg-panel.show, .batch-panel.show,
        .effect-panel.show, .overlay-panel.show, .annotate-panel.show, .history-panel.show,
        .info-panel.show, .colorreplace-panel.show, .idphoto-panel.show, .screenshot-panel.show,
        .pixelart-panel.show, .ascii-panel.show, .duotone-panel.show, .gradient-panel.show,
        .noise-panel.show, .blurbg-panel.show, .texture-panel.show, .bokeh-panel.show,
        .mirror-panel.show, .split-panel.show, .social-panel.show, .export-panel.show { display: block; }
        
        /* ç•«ç­†é¢æ¿ */
        .brush-types, .shape-types, .textfx-styles, .mirror-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .brush-type, .shape-type, .fx-style, .mirror-type {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .brush-type.active, .shape-type.active, .fx-style.active, .mirror-type.active {
            background: var(--primary);
        }
        .brush-colors {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .color-preset {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--border);
            cursor: pointer;
        }
        .color-preset:hover { transform: scale(1.1); }
        
        /* æ¨¡æ¿é¢æ¿ */
        .template-categories, .sticker-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }
        .template-cat, .collage-layout {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .template-cat.active, .collage-layout.active { background: var(--primary); }
        .template-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .template-item {
            padding: 10px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 10px;
            text-align: center;
            cursor: pointer;
        }
        .template-item:hover { background: var(--primary); }
        .custom-size { margin-top: 12px; }
        .size-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }
        .size-inputs input {
            width: 80px;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            text-align: center;
        }
        
        /* æ‹¼è²¼é¢æ¿ */
        .collage-layouts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .collage-images {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            min-height: 60px;
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
        }
        .collage-thumb {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            object-fit: cover;
        }
        
        /* ç¾é¡é¢æ¿ */
        .beauty-sliders { margin-bottom: 12px; }
        .beauty-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .beauty-preset {
            flex: 1;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .beauty-preset:hover { background: var(--primary); }
        
        /* å»èƒŒé¢æ¿ */
        .removebg-options, .newbg-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .removebg-btn, .newbg-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .removebg-btn:hover, .newbg-btn:hover { background: var(--primary); }
        .color-pick-row, .tolerance-row {
            margin-bottom: 12px;
        }
        .new-bg-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        
        /* æ‰¹æ¬¡è™•ç†é¢æ¿ */
        .batch-list {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            margin: 12px 0;
            max-height: 150px;
            overflow-y: auto;
        }
        .batch-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
            font-size: 12px;
        }
        .batch-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            font-size: 12px;
        }
        .batch-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
        }
        .batch-actions { margin-bottom: 12px; }
        .batch-action {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* ç‰¹æ•ˆé¢æ¿ */
        .effect-grid, .texture-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .effect-categories {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .effect-cat {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .effect-cat:hover, .effect-cat.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        .effect-tip {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: var(--bg-input);
            border-radius: 8px;
        }
        .effect-item, .texture-item {
            padding: 12px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .effect-item:hover, .texture-item:hover { background: var(--primary); }
        
        /* ç–ŠåŠ é¢æ¿ */
        .overlay-types {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .overlay-type {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .overlay-type.active { background: var(--primary); }
        .overlay-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .overlay-item {
            aspect-ratio: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
        }
        
        /* æ‰¹è¨»é¢æ¿ */
        .annotate-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .annotate-tool {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .annotate-tool.active { background: var(--primary); }
        
        /* æ­·å²è¨˜éŒ„é¢æ¿ */
        .history-list {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        .history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .history-item:hover { background: var(--primary); }
        .history-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        /* åœ–ç‰‡è³‡è¨Šé¢æ¿ */
        .info-content {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 12px;
            font-size: 12px;
            line-height: 1.8;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            padding: 5px 0;
        }
        .info-row:last-child { border-bottom: none; }
        
        /* é¡è‰²æ›¿æ›é¢æ¿ */
        .color-replace-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .color-replace-row .arrow {
            font-size: 20px;
            color: var(--primary);
        }
        
        /* è­‰ä»¶ç…§é¢æ¿ */
        .id-sizes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .id-size {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .id-size:hover, .id-size.active { background: var(--primary); }
        .id-options {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .id-options select {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        
        /* æˆªåœ–ç¾åŒ–é¢æ¿ */
        .device-frames {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .device-frame {
            padding: 10px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .device-frame:hover { background: var(--primary); }
        
        /* åƒç´ ç•«/ASCII é¢æ¿ */
        .pixel-presets, .split-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .pixel-preset, .split-preset {
            flex: 1;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        .pixel-preset:hover, .split-preset:hover { background: var(--primary); }
        .ascii-output {
            width: 100%;
            height: 150px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--primary);
            font-family: monospace;
            font-size: 8px;
            padding: 10px;
            margin-bottom: 12px;
            resize: none;
        }
        .ascii-actions {
            display: flex;
            gap: 8px;
        }
        
        /* é›™è‰²èª¿/æ¼¸å±¤é¢æ¿ */
        .duotone-presets, .gradient-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .duotone-preset, .gradient-preset {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
        }
        .duotone-preset:hover, .gradient-preset:hover {
            transform: scale(1.1);
            border-color: white;
        }
        .duotone-custom {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
        }
        
        /* ç¤¾ç¾¤åª’é«”é¢æ¿ */
        .social-platforms {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .social-platform {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
        }
        .platform-name {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .social-platform button {
            padding: 6px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 10px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .social-platform button:hover { background: var(--primary); }
        
        /* åŒ¯å‡ºé¢æ¿ */
        .export-options {
            margin-bottom: 12px;
        }
        .export-options select, .export-options input[type="text"] {
            width: 100%;
            margin-top: 5px;
        }
        .export-info {
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 12px;
            text-align: center;
        }
        
        /* é¢æ¿å‰¯æ¨™é¡Œ */
        .panel-subtitle {
            font-size: 12px;
            font-weight: bold;
            color: var(--accent);
            margin: 10px 0;
        }
        
        /* æç¤ºæ–‡å­— */
        .shape-tip, .blur-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        /* ===== é¦–é ä½¿ç”¨èªªæ˜æ¨£å¼ ===== */
        .help-guide {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(99,102,241,0.1) 100%);
            border-radius: 20px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid var(--border);
            display: block !important;
        }
        .help-guide .help-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .help-guide .help-intro {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 12px;
        }
        .help-guide .help-section {
            margin-bottom: 20px;
        }
        .help-guide .help-section-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }
        .help-guide .help-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .help-guide .help-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 12px;
            transition: transform 0.2s;
        }
        .help-guide .help-step:hover {
            transform: translateX(5px);
        }
        .help-guide .step-num {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        .help-guide .step-text {
            font-size: 12px;
            color: var(--text-primary);
        }
        .help-guide .help-detail {
            background: var(--bg-input);
            border-radius: 12px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .help-guide .help-detail summary {
            padding: 12px 15px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .help-guide .help-detail summary:hover {
            background: rgba(99,102,241,0.2);
        }
        .help-guide .help-detail p {
            padding: 0 15px 15px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin: 0;
        }
        .help-guide .help-tips {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .help-guide .help-tip {
            font-size: 11px;
            color: var(--text-secondary);
            padding: 10px 12px;
            background: var(--bg-input);
            border-radius: 10px;
            border-left: 3px solid var(--primary);
        }
        .help-guide .help-tip b {
            color: var(--text-primary);
        }
        .help-guide .help-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding-top: 15px;
            margin-top: 15px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-secondary);
        }
        .help-guide .help-footer span:first-child {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary);
        }
        
        /* ===== ä½¿ç”¨èªªæ˜é¢æ¿æ¨£å¼ ===== */
        .help-panel {
            display: none;
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(99,102,241,0.1) 100%);
            border-radius: 20px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .help-panel.show { display: block; }
        .help-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .help-intro {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 12px;
        }
        .help-section {
            margin-bottom: 20px;
        }
        .help-section-title {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }
        .help-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .help-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 12px;
            transition: transform 0.2s;
        }
        .help-step:hover {
            transform: translateX(5px);
        }
        .step-num {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        .step-text {
            font-size: 12px;
            color: var(--text-primary);
        }
        .help-detail {
            background: var(--bg-input);
            border-radius: 12px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .help-detail summary {
            padding: 12px 15px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .help-detail summary:hover {
            background: rgba(99,102,241,0.2);
        }
        .help-detail summary::marker {
            color: var(--primary);
        }
        .help-detail p {
            padding: 0 15px 15px;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin: 0;
        }
        .help-tips {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .help-tip {
            font-size: 11px;
            color: var(--text-secondary);
            padding: 10px 12px;
            background: var(--bg-input);
            border-radius: 10px;
            border-left: 3px solid var(--primary);
        }
        .help-tip b {
            color: var(--text-primary);
        }
        .help-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding-top: 15px;
            margin-top: 15px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-secondary);
        }
        .help-footer span:first-child {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary);
        }
        
        /* ===== æ›´å¤šé¢æ¿æ¨£å¼ ===== */
        .layer-panel, .liquify-panel, .curve-panel, .level-panel, .histogram-panel,
        .color-balance-panel, .selective-color-panel, .photo-filter-panel, .lens-blur-panel,
        .motion-blur-panel, .perspective-panel, .distort-panel, .warp-panel, .meme-panel,
        .poster-panel, .card-panel, .banner-panel, .avatar-panel, .logo-panel, .gif-panel,
        .palette-panel, .eyedropper-panel, .guide-panel, .align-panel, .path-panel,
        .channel-panel, .slim-face-panel, .big-eye-panel, .makeup-panel, .split-tone-panel,
        .color-grade-panel, .lut-panel, .vintage-panel, .film-panel, .cinema-panel,
        .print-panel, .share-panel, .cloud-panel, .shortcut-panel,
        .color-splash-panel, .dot-art-panel, .face-swap-panel, .skeleton-panel,
        .levels-panel, .hsl-panel, .text-panel, .download-panel,
        .chart-panel, .diagram-panel, .timeline-panel, .infographic-panel,
        .businesscard-panel, .invoice-panel, .certificate-panel, .badge-panel,
        .thumbnail-panel, .cover-panel, .mockup-panel, .colorpalette-panel,
        .aienhance-panel, .aistyle-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .layer-panel.show, .liquify-panel.show, .curve-panel.show, .level-panel.show,
        .histogram-panel.show, .color-balance-panel.show, .selective-color-panel.show,
        .photo-filter-panel.show, .lens-blur-panel.show, .motion-blur-panel.show,
        .perspective-panel.show, .distort-panel.show, .warp-panel.show, .meme-panel.show,
        .poster-panel.show, .card-panel.show, .banner-panel.show, .avatar-panel.show,
        .logo-panel.show, .gif-panel.show, .palette-panel.show, .eyedropper-panel.show,
        .guide-panel.show, .align-panel.show, .path-panel.show, .channel-panel.show,
        .slim-face-panel.show, .big-eye-panel.show, .makeup-panel.show, .split-tone-panel.show,
        .color-grade-panel.show, .lut-panel.show, .vintage-panel.show, .film-panel.show,
        .cinema-panel.show, .print-panel.show, .share-panel.show, .cloud-panel.show,
        .shortcut-panel.show, .color-splash-panel.show, .dot-art-panel.show,
        .face-swap-panel.show, .skeleton-panel.show, .levels-panel.show, .hsl-panel.show,
        .text-panel.show, .download-panel.show, .chart-panel.show, .diagram-panel.show,
        .timeline-panel.show, .infographic-panel.show, .businesscard-panel.show,
        .invoice-panel.show, .certificate-panel.show, .badge-panel.show,
        .thumbnail-panel.show, .cover-panel.show, .mockup-panel.show,
        .colorpalette-panel.show, .aienhance-panel.show, .aistyle-panel.show { display: block; }
        
        /* åœ–å±¤é¢æ¿ */
        .layer-list {
            background: var(--bg-input);
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        .layer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            font-size: 12px;
        }
        .layer-item:last-child { border-bottom: none; }
        .layer-item:hover { background: rgba(255,255,255,0.05); }
        .layer-item.active { background: var(--primary); }
        .layer-visibility, .layer-lock { cursor: pointer; }
        .layer-thumb {
            width: 30px;
            height: 30px;
            background: var(--bg-dark);
            border-radius: 5px;
        }
        .layer-name { flex: 1; }
        .layer-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
        }
        .layer-actions button {
            flex: 1;
            min-width: 60px;
            padding: 6px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .layer-actions button:hover { background: var(--primary); }
        .layer-blend, .layer-opacity { margin-bottom: 10px; }
        .layer-blend select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        
        /* æ¶²åŒ–é¢æ¿ */
        .liquify-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .liquify-tool {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .liquify-tool.active { background: var(--primary); }
        .liquify-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        /* æ›²ç·šé¢æ¿ */
        .curve-channel {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }
        .channel-btn {
            flex: 1;
            padding: 6px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .channel-btn.active { background: var(--primary); }
        .curve-canvas {
            width: 100%;
            height: 200px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: crosshair;
        }
        .curve-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
        }
        .curve-presets button {
            flex: 1;
            padding: 6px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .curve-presets button:hover { background: var(--primary); }
        
        /* è‰²éšé¢æ¿ */
        .level-histogram {
            width: 100%;
            height: 100px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .level-inputs { margin-bottom: 12px; }
        .level-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .level-row span { width: 70px; }
        .level-row input[type="number"] {
            width: 50px;
            padding: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            text-align: center;
        }
        .level-row input[type="range"] { flex: 1; }
        .level-presets {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .level-presets button {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }
        .level-presets button:hover { background: var(--primary); }
        
        /* ç›´æ–¹åœ–é¢æ¿ */
        .histogram-canvas {
            width: 100%;
            height: 150px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 12px;
        }
        .histogram-channels {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
            font-size: 12px;
        }
        .histogram-channels label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .histogram-stats {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            font-size: 11px;
        }
        
        /* è‰²å½©å¹³è¡¡é¢æ¿ */
        .balance-section {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 10px;
        }
        .balance-label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent);
        }
        .balance-slider {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 11px;
        }
        .balance-slider span { width: 40px; text-align: center; }
        .balance-slider input[type="range"] { flex: 1; }
        
        /* é¸æ“‡æ€§èª¿è‰²é¢æ¿ */
        .selective-color-select {
            margin-bottom: 12px;
        }
        .selective-color-select select {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        .selective-sliders .adjust-item {
            margin-bottom: 10px;
        }
        
        /* ç›¸ç‰‡æ¿¾é¡é¢æ¿ */
        .photofilter-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .pf-item {
            padding: 8px;
            border-radius: 8px;
            color: white;
            font-size: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .pf-item:hover { border-color: white; }
        .pf-options { margin-top: 12px; }
        
        /* æ‰­æ›²/å½æ›²é¢æ¿ */
        .distort-types, .warp-styles {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .distort-type, .warp-style {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .distort-type:hover, .warp-style:hover { background: var(--primary); }
        
        /* è¿·å› /æµ·å ±/åç‰‡é¢æ¿ */
        .meme-templates, .poster-templates, .card-templates, .logo-templates {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .meme-template, .poster-template, .card-template, .logo-template {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .meme-template:hover, .poster-template:hover, .card-template:hover, .logo-template:hover { background: var(--primary); }
        .card-fields {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        /* æ©«å¹…é¢æ¿ */
        .banner-sizes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .banner-sizes button {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .banner-sizes button:hover { background: var(--primary); }
        
        /* é ­åƒé¢æ¿ */
        .avatar-shapes, .avatar-sizes {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .avatar-shape, .avatar-sizes button {
            flex: 1;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .avatar-shape:hover, .avatar-shape.active, .avatar-sizes button:hover { background: var(--primary); }
        
        /* GIF é¢æ¿ */
        .gif-frames {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        .gif-frame-item {
            padding: 8px;
            background: var(--bg-dark);
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        /* èª¿è‰²ç›¤é¢æ¿ */
        .palette-colors {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 12px 0;
            min-height: 50px;
        }
        .palette-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .palette-preset {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .palette-preset:hover { background: var(--primary); }
        
        /* å–è‰²å™¨é¢æ¿ */
        .color-preview-large {
            width: 100%;
            height: 60px;
            border-radius: 10px;
            margin-bottom: 12px;
            background: #666;
        }
        .color-values { margin-bottom: 12px; }
        .color-value-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .color-value-row span { width: 50px; }
        .color-value-row input {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-family: monospace;
        }
        .color-value-row button {
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }
        .color-history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        /* åƒè€ƒç·šé¢æ¿ */
        .guide-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .guide-actions button {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .guide-actions button:hover { background: var(--primary); }
        .guide-list {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            min-height: 50px;
        }
        
        /* å°é½Šé¢æ¿ */
        .align-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .align-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .align-buttons button {
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .align-buttons button:hover { background: var(--primary); }
        
        /* è‰²ç‰ˆé¢æ¿ */
        .channel-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .channel-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .channel-item:hover { background: var(--primary); }
        .channel-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        /* å½©å¦é¢æ¿ */
        .makeup-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .makeup-type {
            padding: 10px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .makeup-type:hover, .makeup-type.active { background: var(--primary); }
        
        /* é›»å½±èª¿è‰²é¢æ¿ */
        .colorgrade-presets, .lut-presets, .vintage-presets, .film-presets {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .cg-preset, .lut-preset, .vintage-preset, .film-preset {
            padding: 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .cg-preset:hover, .lut-preset:hover, .vintage-preset:hover, .film-preset:hover { background: var(--primary); }
        
        /* é›»å½±æ•ˆæœé¢æ¿ */
        .cinema-options {
            margin-bottom: 12px;
        }
        .cinema-options .tile-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .cinema-ratio {
            margin-bottom: 12px;
        }
        .cinema-ratio select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        
        /* åˆ—å°é¢æ¿ */
        .print-options {
            margin-bottom: 12px;
        }
        .print-options select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        
        /* åˆ†äº«é¢æ¿ */
        .share-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .share-btn {
            padding: 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        .share-btn:hover { background: var(--primary); }
        
        /* é›²ç«¯é¢æ¿ */
        .cloud-services {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .cloud-btn {
            flex: 1;
            padding: 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        .cloud-btn:hover { background: var(--primary); }
        .cloud-result {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 15px;
            min-height: 50px;
        }
        
        /* å¿«æ·éµé¢æ¿ */
        .shortcut-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-input);
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .shortcut-item span:first-child {
            font-family: monospace;
            background: var(--bg-dark);
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        /* èªªæ˜é¢æ¿ */
        .help-sections {
            margin-bottom: 15px;
        }
        .help-sections details {
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        .help-sections summary {
            padding: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
        }
        .help-sections p {
            padding: 0 12px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0;
        }
        .help-links {
            display: flex;
            gap: 15px;
        }
        .help-links a {
            color: var(--primary);
            text-decoration: none;
            font-size: 12px;
        }
        .help-links a:hover { text-decoration: underline; }
        
        /* å±€éƒ¨å½©è‰²é¢æ¿ */
        .colorsplash-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        /* é»é™£åœ–é¢æ¿ */
        .dotart-options {
            margin-bottom: 12px;
        }
        
        /* ===== åœ–å±¤é¢æ¿æ¨£å¼ ===== */
        .layer-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .layer-panel.show { display: block; }
        
        .layer-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        .layer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .layer-item:hover { background: var(--bg-dark); }
        .layer-item.active { background: var(--primary); }
        .layer-visibility, .layer-lock {
            cursor: pointer;
            font-size: 14px;
        }
        .layer-thumb {
            width: 30px;
            height: 30px;
            background: var(--bg-dark);
            border-radius: 4px;
        }
        .layer-name {
            flex: 1;
            font-size: 12px;
        }
        .layer-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
        }
        .layer-actions button {
            flex: 1;
            min-width: 60px;
            padding: 6px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .layer-actions button:hover { background: var(--primary); }
        .layer-blend, .layer-opacity {
            margin-bottom: 10px;
        }
        .layer-blend select {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            margin-top: 5px;
        }
        
        /* ===== æ¶²åŒ–é¢æ¿æ¨£å¼ ===== */
        .liquify-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .liquify-panel.show { display: block; }
        
        .liquify-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .liquify-tool {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .liquify-tool.active { background: var(--primary); }
        .liquify-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            text-align: center;
        }
        
        /* ===== æ›²ç·šé¢æ¿æ¨£å¼ ===== */
        .curve-panel, .level-panel, .histogram-panel, .colorbalance-panel,
        .selectivecolor-panel, .photofilter-panel, .lensblur-panel, .motionblur-panel,
        .perspective-panel, .distort-panel, .warp-panel, .meme-panel, .poster-panel,
        .card-panel, .banner-panel, .avatar-panel, .logo-panel, .gif-panel,
        .palette-panel, .eyedropper-adv-panel, .guide-panel, .align-panel,
        .path-panel, .channel-panel, .slimface-panel, .bigeye-panel, .makeup-panel,
        .splittone-panel, .colorgrade-panel, .lut-panel, .vintage-panel, .film-panel,
        .cinema-panel, .print-panel, .share-panel, .cloud-panel, .shortcut-panel,
        .help-panel, .colorsplash-panel, .dotart-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .curve-panel.show, .level-panel.show, .histogram-panel.show, .colorbalance-panel.show,
        .selectivecolor-panel.show, .photofilter-panel.show, .lensblur-panel.show, .motionblur-panel.show,
        .perspective-panel.show, .distort-panel.show, .warp-panel.show, .meme-panel.show, .poster-panel.show,
        .card-panel.show, .banner-panel.show, .avatar-panel.show, .logo-panel.show, .gif-panel.show,
        .palette-panel.show, .eyedropper-adv-panel.show, .guide-panel.show, .align-panel.show,
        .path-panel.show, .channel-panel.show, .slimface-panel.show, .bigeye-panel.show, .makeup-panel.show,
        .splittone-panel.show, .colorgrade-panel.show, .lut-panel.show, .vintage-panel.show, .film-panel.show,
        .cinema-panel.show, .print-panel.show, .share-panel.show, .cloud-panel.show, .shortcut-panel.show,
        .help-panel.show, .colorsplash-panel.show, .dotart-panel.show { display: block; }
        
        .curve-channel {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .channel-btn {
            flex: 1;
            padding: 6px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .channel-btn.active { background: var(--primary); }
        .curve-canvas, .histogram-canvas {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .curve-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        .curve-presets button {
            padding: 5px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .curve-presets button:hover { background: var(--primary); }
        
        /* ===== è‰²éšé¢æ¿æ¨£å¼ ===== */
        .level-histogram {
            margin-bottom: 12px;
        }
        .level-inputs {
            margin-bottom: 12px;
        }
        .level-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 11px;
        }
        .level-row span { min-width: 60px; }
        .level-row input[type="number"] {
            width: 50px;
            padding: 5px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            text-align: center;
        }
        .level-row input[type="range"] { flex: 1; }
        .level-presets {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .level-presets button {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .level-presets button:hover { background: var(--primary); }
        
        /* ===== ç›´æ–¹åœ–é¢æ¿æ¨£å¼ ===== */
        .histogram-channels {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 12px;
        }
        .histogram-channels label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        .histogram-stats {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 10px;
            font-size: 11px;
        }
        
        /* ===== è‰²å½©å¹³è¡¡é¢æ¿æ¨£å¼ ===== */
        .balance-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        .balance-section:last-of-type {
            border-bottom: none;
            margin-bottom: 10px;
        }
        .balance-label {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent);
        }
        .balance-slider {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .balance-slider span {
            font-size: 10px;
            min-width: 30px;
            text-align: center;
        }
        .balance-slider input[type="range"] { flex: 1; }
        
        /* ===== é¸æ“‡æ€§èª¿è‰²é¢æ¿æ¨£å¼ ===== */
        .selective-color-select {
            margin-bottom: 12px;
        }
        .selective-color-select select {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
        }
        .selective-sliders { margin-bottom: 12px; }
        
        /* ===== ç›¸ç‰‡æ¿¾é¡é¢æ¿æ¨£å¼ ===== */
        .photofilter-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .pf-item {
            padding: 8px;
            border-radius: 8px;
            color: white;
            font-size: 10px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .pf-item:hover { border-color: white; }
        .pf-options { margin-bottom: 12px; }
        
        /* ===== æ¨¡ç³Šé¢æ¿æ¨£å¼ ===== */
        .lensblur-options, .motionblur-options, .perspective-options {
            margin-bottom: 12px;
        }
        
        /* ===== æ‰­æ›²é¢æ¿æ¨£å¼ ===== */
        .distort-types, .warp-styles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .distort-type, .warp-style {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .distort-type:hover, .warp-style:hover { background: var(--primary); }
        .distort-options, .warp-options { margin-bottom: 12px; }
        
        /* ===== è¿·å› é¢æ¿æ¨£å¼ ===== */
        .meme-options { margin-bottom: 12px; }
        
        /* ===== æµ·å ±é¢æ¿æ¨£å¼ ===== */
        .poster-templates, .card-templates, .logo-templates {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .poster-template, .card-template, .logo-template {
            padding: 10px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .poster-template:hover, .card-template:hover, .logo-template:hover { background: var(--primary); }
        .poster-options { margin-bottom: 12px; }
        
        /* ===== åç‰‡é¢æ¿æ¨£å¼ ===== */
        .card-fields {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        /* ===== æ©«å¹…é¢æ¿æ¨£å¼ ===== */
        .banner-sizes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .banner-sizes button {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .banner-sizes button:hover { background: var(--primary); }
        .banner-options { margin-bottom: 12px; }
        
        /* ===== é ­åƒé¢æ¿æ¨£å¼ ===== */
        .avatar-shapes, .avatar-sizes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .avatar-shape {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .avatar-shape.active { background: var(--primary); }
        .avatar-sizes button {
            padding: 8px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .avatar-sizes button:hover { background: var(--primary); }
        .avatar-options { margin-bottom: 12px; }
        
        /* ===== GIF é¢æ¿æ¨£å¼ ===== */
        .gif-frames {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        .gif-frame-item {
            padding: 8px;
            background: var(--bg-dark);
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .gif-options { margin-bottom: 12px; }
        
        /* ===== èª¿è‰²ç›¤é¢æ¿æ¨£å¼ ===== */
        .palette-extract { margin-bottom: 12px; }
        .palette-colors {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
            min-height: 50px;
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
        }
        .palette-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .palette-preset {
            padding: 8px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .palette-preset:hover { background: var(--primary); }
        
        /* ===== å–è‰²å™¨é¢æ¿æ¨£å¼ ===== */
        .color-preview-large {
            width: 100%;
            height: 60px;
            border-radius: 10px;
            margin-bottom: 12px;
            background: #666;
        }
        .color-values {
            margin-bottom: 12px;
        }
        .color-value-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .color-value-row span {
            min-width: 45px;
            font-size: 11px;
        }
        .color-value-row input {
            flex: 1;
            padding: 6px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 11px;
            font-family: monospace;
        }
        .color-value-row button {
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .color-value-row button:hover { background: var(--primary); }
        .color-history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .color-history-item {
            width: 25px;
            height: 25px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* ===== åƒè€ƒç·šé¢æ¿æ¨£å¼ ===== */
        .guide-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .guide-actions button {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .guide-actions button:hover { background: var(--primary); }
        .guide-list {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 12px;
            min-height: 50px;
        }
        
        /* ===== å°é½Šé¢æ¿æ¨£å¼ ===== */
        .align-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .align-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .align-buttons button {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .align-buttons button:hover { background: var(--primary); }
        
        /* ===== è‰²ç‰ˆé¢æ¿æ¨£å¼ ===== */
        .channel-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .channel-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-input);
            border-radius: 8px;
            cursor: pointer;
        }
        .channel-item:hover { background: var(--primary); }
        .channel-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        /* ===== ç¾é¡é€²éšé¢æ¿æ¨£å¼ ===== */
        .slimface-info, .bigeye-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-input);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .slimface-options, .bigeye-options { margin-bottom: 12px; }
        
        /* ===== å½©å¦é¢æ¿æ¨£å¼ ===== */
        .makeup-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .makeup-type {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .makeup-type:hover { background: var(--primary); }
        .makeup-options { margin-bottom: 12px; }
        
        /* ===== åˆ†é›¢è‰²èª¿é¢æ¿æ¨£å¼ ===== */
        .splittone-options { margin-bottom: 12px; }
        
        /* ===== é›»å½±èª¿è‰²é¢æ¿æ¨£å¼ ===== */
        .colorgrade-presets {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .cg-preset {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 10px;
            cursor: pointer;
        }
        .cg-preset:hover { background: var(--primary); }
        
        /* ===== LUT é¢æ¿æ¨£å¼ ===== */
        .lut-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        .lut-preset {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .lut-preset:hover { background: var(--primary); }
        .lut-options { margin-bottom: 12px; }
        
        /* ===== å¾©å¤/åº•ç‰‡é¢æ¿æ¨£å¼ ===== */
        .vintage-presets, .film-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .vintage-preset, .film-preset {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .vintage-preset:hover, .film-preset:hover { background: var(--primary); }
        
        /* ===== é›»å½±æ•ˆæœé¢æ¿æ¨£å¼ ===== */
        .cinema-options {
            margin-bottom: 12px;
        }
        .cinema-ratio {
            margin-bottom: 12px;
        }
        .cinema-ratio select {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            margin-top: 5px;
        }
        
        /* ===== åˆ—å°é¢æ¿æ¨£å¼ ===== */
        .print-options { margin-bottom: 12px; }
        .print-options select {
            width: 100%;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            margin-top: 5px;
        }
        
        /* ===== åˆ†äº«é¢æ¿æ¨£å¼ ===== */
        .share-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .share-btn {
            padding: 15px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
        }
        .share-btn:hover { background: var(--primary); }
        
        /* ===== é›²ç«¯é¢æ¿æ¨£å¼ ===== */
        .cloud-services {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .cloud-btn {
            flex: 1;
            padding: 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        .cloud-btn:hover { background: var(--primary); }
        .cloud-result {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 15px;
            min-height: 50px;
        }
        
        /* ===== å¿«æ·éµé¢æ¿æ¨£å¼ ===== */
        .shortcut-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-input);
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .shortcut-item span:first-child {
            background: var(--bg-dark);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* ===== èªªæ˜é¢æ¿æ¨£å¼ ===== */
        .help-sections {
            margin-bottom: 15px;
        }
        .help-sections details {
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .help-sections summary {
            padding: 12px;
            cursor: pointer;
            font-size: 13px;
        }
        .help-sections summary:hover { background: var(--bg-dark); }
        .help-sections p {
            padding: 0 12px 12px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        .help-links {
            display: flex;
            gap: 15px;
        }
        .help-links a {
            color: var(--primary);
            text-decoration: none;
            font-size: 12px;
        }
        .help-links a:hover { text-decoration: underline; }
        
        /* ===== å±€éƒ¨å½©è‰²é¢æ¿æ¨£å¼ ===== */
        .colorsplash-info {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .colorsplash-options { margin-bottom: 12px; }
        
        /* ===== é»é™£åœ–é¢æ¿æ¨£å¼ ===== */
        .dotart-options { margin-bottom: 12px; }
        
        /* ===== éŸ¿æ‡‰å¼é€²éšèª¿æ•´ ===== */
        @media (max-width: 768px) {
            .photofilter-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .colorgrade-presets {
                grid-template-columns: repeat(2, 1fr);
            }
            .share-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            .align-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .photofilter-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .lut-presets, .vintage-presets, .film-presets {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* ===== å‹•ç•«æ•ˆæœ ===== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .panel-title {
            animation: slideIn 0.3s ease;
        }
        
        .layer-item, .history-item, .batch-item {
            animation: fadeIn 0.2s ease;
        }
        
        /* ===== æ»¾å‹•æ¢ç¾åŒ– ===== */
        .layer-list::-webkit-scrollbar,
        .history-list::-webkit-scrollbar,
        .batch-list::-webkit-scrollbar,
        .shortcut-list::-webkit-scrollbar,
        .sticker-grid::-webkit-scrollbar {
            width: 6px;
        }
        
        .layer-list::-webkit-scrollbar-track,
        .history-list::-webkit-scrollbar-track,
        .batch-list::-webkit-scrollbar-track,
        .shortcut-list::-webkit-scrollbar-track,
        .sticker-grid::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 3px;
        }
        
        .layer-list::-webkit-scrollbar-thumb,
        .history-list::-webkit-scrollbar-thumb,
        .batch-list::-webkit-scrollbar-thumb,
        .shortcut-list::-webkit-scrollbar-thumb,
        .sticker-grid::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
        
        /* ===== å·¥å…·æç¤º ===== */
        .tool-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-dark);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }
        
        .tool-btn:hover .tool-tooltip {
            opacity: 1;
        }
        
        /* ===== é€²åº¦æŒ‡ç¤ºå™¨ ===== */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-dark);
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* ===== è¼‰å…¥å‹•ç•« ===== */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== æ‹–æ›³å€åŸŸæ¨£å¼ ===== */
        .drop-zone-active {
            border-color: var(--primary) !important;
            background: rgba(99, 102, 241, 0.1) !important;
        }
        
        /* ===== é¸é …å¡æ¨£å¼ ===== */
        .tab-container {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }
        
        .tab-item {
            padding: 8px 15px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px 8px 0 0;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-item:hover {
            background: var(--bg-dark);
            color: white;
        }
        
        .tab-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        /* ===== æ•¸å€¼è¼¸å…¥æ¨£å¼ ===== */
        .number-input-group {
            display: flex;
            align-items: center;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .number-input-group button {
            width: 30px;
            height: 30px;
            background: var(--bg-dark);
            border: none;
            color: white;
            cursor: pointer;
        }
        
        .number-input-group button:hover {
            background: var(--primary);
        }
        
        .number-input-group input {
            flex: 1;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            padding: 5px;
        }
        
        /* ===== é–‹é—œåˆ‡æ›æ¨£å¼ ===== */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-input);
            transition: 0.3s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* ===== æ¨™ç±¤æ¨£å¼ ===== */
        .tag {
            display: inline-block;
            padding: 3px 10px;
            background: var(--primary);
            color: white;
            border-radius: 15px;
            font-size: 10px;
            margin-right: 5px;
        }
        
        .tag.success { background: #10b981; }
        .tag.warning { background: #f59e0b; }
        .tag.danger { background: #ef4444; }
        .tag.info { background: #3b82f6; }
        
        /* ===== å¡ç‰‡ç¶²æ ¼æ¨£å¼ ===== */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
        }
        
        .card-item {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .card-item:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }
        
        .card-item-icon {
            font-size: 30px;
            margin-bottom: 8px;
        }
        
        .card-item-label {
            font-size: 11px;
        }
        
        /* ===== çµ±è¨ˆæ•¸æ“šæ¨£å¼ ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat-item {
            background: var(--bg-input);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        /* ===== æ™‚é–“è»¸æ¨£å¼ ===== */
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 15px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary);
        }
        
        .timeline-time {
            font-size: 10px;
            color: var(--text-secondary);
        }
        
        .timeline-content {
            font-size: 12px;
            margin-top: 3px;
        }
        
        /* ===== æ›´å¤šåŠŸèƒ½é¢æ¿æ¨£å¼ ===== */
        .meme-panel, .poster-panel, .banner-panel, .chart-panel, .diagram-panel,
        .timeline-panel, .infographic-panel, .businesscard-panel, .invoice-panel,
        .certificate-panel, .badge-panel, .avatar-panel, .thumbnail-panel,
        .cover-panel, .mockup-panel, .colorpalette-panel, .aienhance-panel,
        .aistyle-panel, .hsl-panel, .levels-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--border);
        }
        .meme-panel.show, .poster-panel.show, .banner-panel.show, .chart-panel.show,
        .diagram-panel.show, .timeline-panel.show, .infographic-panel.show,
        .businesscard-panel.show, .invoice-panel.show, .certificate-panel.show,
        .badge-panel.show, .avatar-panel.show, .thumbnail-panel.show, .cover-panel.show,
        .mockup-panel.show, .colorpalette-panel.show, .aienhance-panel.show,
        .aistyle-panel.show, .hsl-panel.show, .levels-panel.show { display: block; }
        
        /* æ¢—åœ–é¢æ¿ */
        .meme-templates {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .meme-template {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
        }
        .meme-template.active { background: var(--primary); }
        .meme-inputs {
            margin-bottom: 12px;
        }
        .meme-inputs label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin: 8px 0 4px;
        }
        .meme-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        
        /* æµ·å ±é¢æ¿ */
        .poster-styles, .card-styles, .cert-styles, .badge-shapes, .avatar-shapes,
        .thumbnail-platforms, .cover-types, .mockup-devices, .ai-enhance-options,
        .ai-styles {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .poster-style, .card-style, .cert-style, .badge-shape, .avatar-shape,
        .thumb-platform, .cover-type, .mockup-device, .ai-enhance-btn, .ai-style-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
        }
        .poster-style:hover, .card-style:hover, .cert-style:hover, .badge-shape:hover,
        .avatar-shape:hover, .thumb-platform:hover, .cover-type:hover, .mockup-device:hover,
        .ai-enhance-btn:hover, .ai-style-btn:hover { background: var(--primary); }
        
        /* æ©«å¹…é¢æ¿ */
        .banner-colors {
            display: flex;
            gap: 15px;
            margin: 12px 0;
        }
        .banner-sizes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .banner-size-item {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
        }
        .banner-size-item:hover { background: var(--primary); }
        
        /* åœ–è¡¨é¢æ¿ */
        .chart-types, .diagram-shapes, .infographic-types {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }
        .chart-type, .diagram-shape, .info-type {
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
        }
        .chart-type:hover, .diagram-shape:hover, .info-type:hover { background: var(--primary); }
        
        /* è‰²å½©åˆ†æ */
        .palette-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .palette-color {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .palette-color:hover { transform: scale(1.1); }
        .palette-info {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
        }
        
        /* HSL/è‰²éšé¢æ¿ */
        .hsl-sliders, .levels-sliders {
            margin-bottom: 15px;
        }
        .panel-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .text-input-area {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            margin-bottom: 10px;
        }
        .text-input-area:focus { outline: none; border-color: var(--primary); }
        .text-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .option-group {
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-input);
            padding: 5px 10px;
            border-radius: 8px;
        }
        .option-group label { font-size: 11px; color: var(--text-secondary); }
        .option-group input[type="number"] {
            width: 50px;
            padding: 4px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: white;
            font-size: 12px;
        }
        .option-group input[type="color"] {
            width: 30px; height: 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .style-btn {
            width: 32px; height: 32px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        .style-btn.active { background: var(--primary); border-color: var(--primary); }
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .eyedropper-btn {
            width: 32px; height: 32px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .eyedropper-btn.active { background: var(--warning); }
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .action-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .action-btn.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
        .action-btn.danger { background: linear-gradient(135deg, var(--danger), #dc2626); color: white; }
        .action-btn.success { background: linear-gradient(135deg, var(--success), #16a34a); color: white; }
        
        /* ===== ä¸‹è¼‰é¢æ¿ ===== */
        .download-panel {
            display: none;
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
        .download-panel.show { display: block; }
        .download-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .download-btn {
            flex: 1;
            min-width: 140px;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .download-btn:hover { transform: translateY(-3px); }
        .download-btn .icon { font-size: 24px; }
        .download-btn.png { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; }
        .download-btn.pdf { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        .download-btn.line { background: linear-gradient(135deg, #00c300, #00e000); color: white; }
        
        /* ===== ä½¿ç”¨èªªæ˜ ===== */
        .help-panel {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }
        .help-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .help-list { list-style: none; }
        .help-list li {
            padding: 8px 0;
            font-size: 12px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .help-list li:last-child { border-bottom: none; }
        .help-list .icon { font-size: 16px; flex-shrink: 0; }
        
        /* ===== åº•éƒ¨å°èˆª ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 5px 15px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 10px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-item .icon { font-size: 22px; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active .icon { transform: scale(1.1); }
        
        /* ===== é é¢åˆ‡æ› ===== */
        .page { display: none; }
        .page.active { display: block; }
        
        /* ===== è¨­å®šé  ===== */
        .settings-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .settings-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .setting-item:last-child { border-bottom: none; }
        .setting-item label { font-size: 12px; color: var(--text-secondary); }
        .setting-item input {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 13px;
        }
        .save-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .clear-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        .toggle-pwd-btn {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-line-btn {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #00C300, #00a000);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* ===== Toast ===== */
        #toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 13px;
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s;
            white-space: nowrap;
        }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        /* ===== éŸ¿æ‡‰å¼ ===== */
        @media (min-width: 768px) {
            .app-container { max-width: 800px; margin: 0 auto; }
            .canvas-container { max-height: 75vh; }
            #mainCanvas { max-height: calc(75vh - 20px); }
        }
        @media (min-width: 1024px) {
            .app-container { max-width: 1000px; }
            .canvas-container { max-height: 80vh; }
            #mainCanvas { max-height: calc(80vh - 20px); }
        }
    </style>
</head>
<body>
    <!-- é–‹æ©Ÿå‹•ç•« -->
    <div id="splashScreen">
        <div class="splash-logo">ğŸ©</div>
        <div class="splash-title">åœ–æ–‡é­”è¡“å¸«</div>
        <div class="splash-version">V2.0 çµ‚æ¥µç‰ˆ</div>
        <div class="splash-loading"></div>
    </div>
    
    <!-- ç¯€æ…¶æ•ˆæœå®¹å™¨ -->
    <div id="festivalEffect"></div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <span class="header-logo">ğŸ©</span>
                <span class="header-title">åœ–æ–‡é­”è¡“å¸«<span class="header-version">V2.0</span></span>
            </div>
            <div class="header-right">
                <span class="header-time" id="headerTime">--:--</span>
                <span class="header-festival" id="headerFestival">ğŸŠ</span>
            </div>
        </header>
        
        <!-- é¦–é  -->
        <div class="page active" id="page-home">
            <!-- å·¥å…·åˆ— -->
            <div class="toolbar">
                <!-- åˆ†é¡æŒ‰éˆ• -->
                <div class="toolbar-categories">
                    <button class="category-btn active" onclick="showToolCategory('basic')"><span class="cat-icon">ğŸ“</span>åŸºæœ¬</button>
                    <button class="category-btn" onclick="showToolCategory('select')"><span class="cat-icon">âœ‚ï¸</span>é¸å–</button>
                    <button class="category-btn" onclick="showToolCategory('adjust')"><span class="cat-icon">ğŸ¨</span>èª¿è‰²</button>
                    <button class="category-btn" onclick="showToolCategory('filter')"><span class="cat-icon">ğŸ­</span>æ¿¾é¡</button>
                    <button class="category-btn" onclick="showToolCategory('draw')"><span class="cat-icon">ğŸ–Œï¸</span>ç¹ªåœ–</button>
                    <button class="category-btn" onclick="showToolCategory('text')"><span class="cat-icon">âœï¸</span>æ–‡å­—</button>
                    <button class="category-btn" onclick="showToolCategory('retouch')"><span class="cat-icon">ğŸ”§</span>ä¿®åœ–</button>
                    <button class="category-btn" onclick="showToolCategory('transform')"><span class="cat-icon">ğŸ”„</span>è®Šå½¢</button>
                    <button class="category-btn" onclick="showToolCategory('creative')"><span class="cat-icon">ğŸ¬</span>å‰µæ„</button>
                    <button class="category-btn" onclick="showToolCategory('output')"><span class="cat-icon">ğŸ’¾</span>è¼¸å‡º</button>
                    <button class="category-btn" onclick="showToolCategory('tools')"><span class="cat-icon">ğŸ› ï¸</span>å·¥å…·</button>
                    <button class="category-btn" onclick="showToolCategory('ai')"><span class="cat-icon">ğŸ¤–</span>AI</button>
                </div>
                
                <!-- åŸºæœ¬å·¥å…· -->
                <div class="toolbar-tools show" id="tools-basic">
                    <button class="tool-btn" onclick="triggerUpload('image')"><span class="icon">ğŸ–¼ï¸</span>åœ–ç‰‡</button>
                    <button class="tool-btn" onclick="triggerUpload('pdf')"><span class="icon">ğŸ“„</span>PDF</button>
                    <button class="tool-btn" onclick="pasteFromClipboard()"><span class="icon">ğŸ“‹</span>è²¼ä¸Š</button>
                    <button class="tool-btn" onclick="takePhoto()"><span class="icon">ğŸ“·</span>æ‹ç…§</button>
                    <button class="tool-btn" id="undoBtn" onclick="undoAction()" disabled><span class="icon">â†©ï¸</span>å¾©åŸ</button>
                    <button class="tool-btn" id="resetBtn" onclick="resetCanvas()" disabled><span class="icon">ğŸ—‘ï¸</span>é‡ç½®</button>
                    <button class="tool-btn" id="templateBtn" onclick="showTemplatePanel()"><span class="icon">ğŸ“‹</span>æ¨¡æ¿</button>
                    <button class="tool-btn" id="shortcutBtn" onclick="showShortcutPanel()"><span class="icon">âŒ¨ï¸</span>å¿«æ·éµ</button>
                    <button class="tool-btn" id="themeBtn" onclick="toggleTheme()"><span class="icon">ğŸ¨</span>ä¸»é¡Œ</button>
                    <button class="tool-btn" id="helpBtn" onclick="showHelpPanel()"><span class="icon">â“</span>èªªæ˜</button>
                </div>
                
                <!-- é¸å–å·¥å…· -->
                <div class="toolbar-tools" id="tools-select">
                    <button class="tool-btn" id="selectBtn" onclick="setTool('select')" disabled><span class="icon">âœ‚ï¸</span>é¸å–</button>
                    <button class="tool-btn" id="clearBtn" onclick="clearSelection()" disabled><span class="icon">ğŸ§¹</span>æ¸…é™¤</button>
                    <button class="tool-btn" id="lassoBtn" onclick="setTool('lasso')" disabled><span class="icon">ğŸ”—</span>å¥—ç´¢</button>
                    <button class="tool-btn" id="magicWandBtn" onclick="setTool('magicWand')" disabled><span class="icon">ğŸª„</span>é­”è¡“æ£’</button>
                    <button class="tool-btn" id="eyeDropperAdvBtn" onclick="showEyeDropperAdvPanel()" disabled><span class="icon">ğŸ’‰</span>å–è‰²å™¨</button>
                    <button class="tool-btn" id="colorPaletteBtn" onclick="showColorPalettePanel()" disabled><span class="icon">ğŸ¨</span>èª¿è‰²ç›¤</button>
                </div>
                
                <!-- èª¿è‰²å·¥å…· -->
                <div class="toolbar-tools" id="tools-adjust">
                    <button class="tool-btn" id="adjustBtn" onclick="showAdjustPanel()" disabled><span class="icon">ğŸŒˆ</span>èª¿æ•´</button>
                    <button class="tool-btn" id="curveBtn" onclick="showCurvePanel()" disabled><span class="icon">ğŸ“ˆ</span>æ›²ç·š</button>
                    <button class="tool-btn" id="levelBtn" onclick="showLevelPanel()" disabled><span class="icon">ğŸ“Š</span>è‰²éš</button>
                    <button class="tool-btn" id="histogramBtn" onclick="showHistogramPanel()" disabled><span class="icon">ğŸ“‰</span>ç›´æ–¹åœ–</button>
                    <button class="tool-btn" id="colorBalanceBtn" onclick="showColorBalancePanel()" disabled><span class="icon">âš–ï¸</span>è‰²å½©å¹³è¡¡</button>
                    <button class="tool-btn" id="selectiveColorBtn" onclick="showSelectiveColorPanel()" disabled><span class="icon">ğŸ¯</span>é¸æ“‡æ€§èª¿è‰²</button>
                    <button class="tool-btn" id="photoFilterBtn" onclick="showPhotoFilterPanel()" disabled><span class="icon">ğŸ“·</span>ç›¸ç‰‡æ¿¾é¡</button>
                    <button class="tool-btn" id="colorReplaceBtn" onclick="showColorReplacePanel()" disabled><span class="icon">ğŸ¨</span>æ›è‰²</button>
                    <button class="tool-btn" id="hdrBtn" onclick="applyHDR()" disabled><span class="icon">ğŸŒŸ</span>HDR</button>
                    <button class="tool-btn" id="autoEnhanceBtn" onclick="autoEnhance()" disabled><span class="icon">âœ¨</span>è‡ªå‹•å¢å¼·</button>
                    <button class="tool-btn" id="autoColorBtn" onclick="autoColor()" disabled><span class="icon">ğŸŒˆ</span>è‡ªå‹•è‰²å½©</button>
                    <button class="tool-btn" id="autoContrastBtn" onclick="autoContrast()" disabled><span class="icon">ğŸ­</span>è‡ªå‹•å°æ¯”</button>
                </div>
                
                <!-- æ¿¾é¡å·¥å…· -->
                <div class="toolbar-tools" id="tools-filter">
                    <button class="tool-btn" id="filterBtn" onclick="showFilterPanel()" disabled><span class="icon">ğŸ¨</span>æ¿¾é¡</button>
                    <button class="tool-btn" id="effectBtn" onclick="showEffectPanel()" disabled><span class="icon">ğŸ’«</span>ç‰¹æ•ˆ</button>
                    <button class="tool-btn" id="lutBtn" onclick="showLutPanel()" disabled><span class="icon">ğŸ¥</span>LUT</button>
                    <button class="tool-btn" id="vintageBtn" onclick="showVintagePanel()" disabled><span class="icon">ğŸ“»</span>å¾©å¤</button>
                    <button class="tool-btn" id="filmBtn" onclick="showFilmPanel()" disabled><span class="icon">ğŸï¸</span>åº•ç‰‡</button>
                    <button class="tool-btn" id="cinemaBtn" onclick="showCinemaPanel()" disabled><span class="icon">ğŸ¬</span>é›»å½±</button>
                    <button class="tool-btn" id="splitToneBtn" onclick="showSplitTonePanel()" disabled><span class="icon">ğŸ¨</span>åˆ†é›¢è‰²èª¿</button>
                    <button class="tool-btn" id="colorGradeBtn" onclick="showColorGradePanel()" disabled><span class="icon">ğŸ¬</span>èª¿è‰²</button>
                    <button class="tool-btn" id="duotoneBtn" onclick="showDuotonePanel()" disabled><span class="icon">ğŸ­</span>é›™è‰²èª¿</button>
                    <button class="tool-btn" id="gradientBtn" onclick="showGradientPanel()" disabled><span class="icon">ğŸŒ…</span>æ¼¸å±¤</button>
                    <button class="tool-btn" id="vignetteBtn" onclick="applyVignette()" disabled><span class="icon">ğŸ”˜</span>æšˆå½±</button>
                    <button class="tool-btn" id="noiseBtn" onclick="showNoisePanel()" disabled><span class="icon">ğŸ“»</span>é›œè¨Š</button>
                    <button class="tool-btn" id="glitchBtn" onclick="applyGlitch()" disabled><span class="icon">ğŸ“º</span>æ•…éšœ</button>
                </div>
                
                <!-- ç¹ªåœ–å·¥å…· -->
                <div class="toolbar-tools" id="tools-draw">
                    <button class="tool-btn" id="brushBtn" onclick="showBrushPanel()" disabled><span class="icon">ğŸ–Œï¸</span>ç•«ç­†</button>
                    <button class="tool-btn" id="shapeBtn" onclick="showShapePanel()" disabled><span class="icon">â­•</span>å½¢ç‹€</button>
                    <button class="tool-btn" id="arrowBtn" onclick="showArrowPanel()" disabled><span class="icon">â¡ï¸</span>ç®­é ­</button>
                    <button class="tool-btn" id="penToolBtn" onclick="setTool('penTool')" disabled><span class="icon">ğŸ–Šï¸</span>é‹¼ç­†</button>
                    <button class="tool-btn" id="annotateBtn" onclick="showAnnotatePanel()" disabled><span class="icon">ğŸ“</span>æ‰¹è¨»</button>
                    <button class="tool-btn" id="frameBtn" onclick="showFramePanel()" disabled><span class="icon">ğŸ–¼ï¸</span>é‚Šæ¡†</button>
                    <button class="tool-btn" id="overlayBtn" onclick="showOverlayPanel()" disabled><span class="icon">ğŸ´</span>ç–ŠåŠ </button>
                    <button class="tool-btn" id="textureBtn" onclick="showTexturePanel()" disabled><span class="icon">ğŸ§±</span>ç´‹ç†</button>
                </div>
                
                <!-- æ–‡å­—å·¥å…· -->
                <div class="toolbar-tools" id="tools-text">
                    <button class="tool-btn" id="textFxBtn" onclick="showTextFxPanel()" disabled><span class="icon">ğŸ”¤</span>æ–‡å­—ç‰¹æ•ˆ</button>
                    <button class="tool-btn" id="watermarkBtn" onclick="showWatermarkPanel()" disabled><span class="icon">ğŸ’¦</span>æµ®æ°´å°</button>
                    <button class="tool-btn" id="logoBtn" onclick="showLogoPanel()" disabled><span class="icon">ğŸ¢</span>Logo</button>
                    <button class="tool-btn" id="stampBtn" onclick="showStampPanel()" disabled><span class="icon">ğŸ”–</span>åœ–ç« </button>
                    <button class="tool-btn" id="signBtn" onclick="showSignPanel()" disabled><span class="icon">âœï¸</span>ç°½å</button>
                    <button class="tool-btn" id="qrBtn" onclick="showQRPanel()" disabled><span class="icon">ğŸ“±</span>QRç¢¼</button>
                    <button class="tool-btn" id="stickerBtn" onclick="showStickerPanel()" disabled><span class="icon">ğŸ˜€</span>è²¼åœ–</button>
                </div>
                
                <!-- ä¿®åœ–å·¥å…· -->
                <div class="toolbar-tools" id="tools-retouch">
                    <button class="tool-btn" id="mosaicBtn" onclick="setTool('mosaic')" disabled><span class="icon">ğŸ”²</span>é¦¬è³½å…‹</button>
                    <button class="tool-btn" id="removeBgBtn" onclick="showRemoveBgPanel()" disabled><span class="icon">ğŸ­</span>å»èƒŒ</button>
                    <button class="tool-btn" id="healBtn" onclick="setTool('heal')" disabled><span class="icon">ğŸ©¹</span>ä¿®å¾©</button>
                    <button class="tool-btn" id="cloneBtn" onclick="setTool('clone')" disabled><span class="icon">ğŸ”„</span>ä»¿è£½</button>
                    <button class="tool-btn" id="liquifyBtn" onclick="showLiquifyPanel()" disabled><span class="icon">ğŸ’§</span>æ¶²åŒ–</button>
                    <button class="tool-btn" id="beautyBtn" onclick="showBeautyPanel()" disabled><span class="icon">âœ¨</span>ç¾é¡</button>
                    <button class="tool-btn" id="slimFaceBtn" onclick="showSlimFacePanel()" disabled><span class="icon">ğŸ§‘</span>ç˜¦è‡‰</button>
                    <button class="tool-btn" id="bigEyeBtn" onclick="showBigEyePanel()" disabled><span class="icon">ğŸ‘€</span>å¤§çœ¼</button>
                    <button class="tool-btn" id="makeupBtn" onclick="showMakeupPanel()" disabled><span class="icon">ğŸ’„</span>å½©å¦</button>
                    <button class="tool-btn" id="redEyeBtn" onclick="setTool('redEye')" disabled><span class="icon">ğŸ‘ï¸</span>ç´…çœ¼</button>
                    <button class="tool-btn" id="blemishBtn" onclick="setTool('blemish')" disabled><span class="icon">âœ¨</span>å»æ–‘</button>
                    <button class="tool-btn" id="blurBgBtn" onclick="showBlurBgPanel()" disabled><span class="icon">ğŸŒ«ï¸</span>èƒŒæ™¯æ¨¡ç³Š</button>
                </div>
                
                <!-- è®Šå½¢å·¥å…· -->
                <div class="toolbar-tools" id="tools-transform">
                    <button class="tool-btn" id="rotateBtn" onclick="rotateImage90()" disabled><span class="icon">ğŸ”„</span>æ—‹è½‰</button>
                    <button class="tool-btn" id="flipHBtn" onclick="flipImage('h')" disabled><span class="icon">â†”ï¸</span>æ°´å¹³ç¿»</button>
                    <button class="tool-btn" id="flipVBtn" onclick="flipImage('v')" disabled><span class="icon">â†•ï¸</span>å‚ç›´ç¿»</button>
                    <button class="tool-btn" id="cropBtn" onclick="showCropPanel()" disabled><span class="icon">â¬œ</span>è£åˆ‡</button>
                    <button class="tool-btn" id="perspectiveBtn" onclick="showPerspectivePanel()" disabled><span class="icon">ğŸ“</span>é€è¦–</button>
                    <button class="tool-btn" id="distortBtn" onclick="showDistortPanel()" disabled><span class="icon">ğŸŒ€</span>æ‰­æ›²</button>
                    <button class="tool-btn" id="warpBtn" onclick="showWarpPanel()" disabled><span class="icon">ã€°ï¸</span>å½æ›²</button>
                    <button class="tool-btn" id="mirrorBtn" onclick="showMirrorPanel()" disabled><span class="icon">ğŸª</span>é¡åƒ</button>
                    <button class="tool-btn" id="lensBlurBtn" onclick="showLensBlurPanel()" disabled><span class="icon">ğŸ”­</span>é¡é ­æ¨¡ç³Š</button>
                    <button class="tool-btn" id="motionBlurBtn" onclick="showMotionBlurPanel()" disabled><span class="icon">ğŸ’¨</span>å‹•æ…‹æ¨¡ç³Š</button>
                    <button class="tool-btn" id="tiltShiftBtn" onclick="applyTiltShift()" disabled><span class="icon">ğŸ™ï¸</span>ç§»è»¸</button>
                </div>
                
                <!-- å‰µæ„å·¥å…· -->
                <div class="toolbar-tools" id="tools-creative">
                    <button class="tool-btn" id="collageBtn" onclick="showCollagePanel()" disabled><span class="icon">ğŸ§©</span>æ‹¼è²¼</button>
                    <button class="tool-btn" id="mergeBtn" onclick="showMergePanel()" disabled><span class="icon">ğŸ“</span>æ‹¼æ¥</button>
                    <button class="tool-btn" id="memeBtn" onclick="showMemePanel()" disabled><span class="icon">ğŸ˜‚</span>è¿·å› </button>
                    <button class="tool-btn" id="posterBtn" onclick="showPosterPanel()" disabled><span class="icon">ğŸ¨</span>æµ·å ±</button>
                    <button class="tool-btn" id="cardBtn" onclick="showCardPanel()" disabled><span class="icon">ğŸ’³</span>åç‰‡</button>
                    <button class="tool-btn" id="bannerBtn" onclick="showBannerPanel()" disabled><span class="icon">ğŸ·ï¸</span>æ©«å¹…</button>
                    <button class="tool-btn" id="avatarBtn" onclick="showAvatarPanel()" disabled><span class="icon">ğŸ‘¤</span>é ­åƒ</button>
                    <button class="tool-btn" id="gifBtn" onclick="showGifPanel()" disabled><span class="icon">ğŸ¬</span>GIF</button>
                    <button class="tool-btn" id="socialBtn" onclick="showSocialPanel()" disabled><span class="icon">ğŸ“±</span>ç¤¾ç¾¤</button>
                    <button class="tool-btn" id="cartoonBtn" onclick="applyCartoon()" disabled><span class="icon">ğŸ¨</span>å¡é€šåŒ–</button>
                    <button class="tool-btn" id="sketchBtn" onclick="applySketch()" disabled><span class="icon">âœï¸</span>ç´ æ</button>
                    <button class="tool-btn" id="oilPaintBtn" onclick="applyOilPaint()" disabled><span class="icon">ğŸ–¼ï¸</span>æ²¹ç•«</button>
                    <button class="tool-btn" id="pixelArtBtn" onclick="showPixelArtPanel()" disabled><span class="icon">ğŸ‘¾</span>åƒç´ ç•«</button>
                    <button class="tool-btn" id="asciiBtn" onclick="showAsciiPanel()" disabled><span class="icon">ğŸ’»</span>ASCII</button>
                    <button class="tool-btn" id="kaleidoBtn" onclick="applyKaleidoscope()" disabled><span class="icon">ğŸ”®</span>è¬èŠ±ç­’</button>
                    <button class="tool-btn" id="dotArtBtn" onclick="showDotArtPanel()" disabled><span class="icon">âš«</span>é»é™£åœ–</button>
                    <button class="tool-btn" id="bokehBtn" onclick="showBokehPanel()" disabled><span class="icon">ğŸ’¡</span>æ•£æ™¯</button>
                    <button class="tool-btn" id="lightLeakBtn" onclick="applyLightLeak()" disabled><span class="icon">â˜€ï¸</span>æ¼å…‰</button>
                </div>
                
                <!-- è¼¸å‡ºå·¥å…· -->
                <div class="toolbar-tools" id="tools-output">
                    <button class="tool-btn" id="compressBtn" onclick="showCompressPanel()" disabled><span class="icon">ğŸ“¦</span>å£“ç¸®</button>
                    <button class="tool-btn" id="exportBtn" onclick="showExportPanel()" disabled><span class="icon">ğŸ’¾</span>åŒ¯å‡º</button>
                    <button class="tool-btn" id="printBtn" onclick="showPrintPanel()" disabled><span class="icon">ğŸ–¨ï¸</span>åˆ—å°</button>
                    <button class="tool-btn" id="shareBtn" onclick="showSharePanel()" disabled><span class="icon">ğŸ“¤</span>åˆ†äº«</button>
                    <button class="tool-btn" id="cloudBtn" onclick="showCloudPanel()" disabled><span class="icon">â˜ï¸</span>é›²ç«¯</button>
                    <button class="tool-btn" id="splitBtn" onclick="showSplitPanel()" disabled><span class="icon">ğŸ”²</span>åˆ†å‰²</button>
                    <button class="tool-btn" id="batchBtn" onclick="showBatchPanel()" disabled><span class="icon">ğŸ“š</span>æ‰¹æ¬¡</button>
                </div>
                
                <!-- è¼”åŠ©å·¥å…· -->
                <div class="toolbar-tools" id="tools-tools">
                    <button class="tool-btn" id="measureBtn" onclick="setTool('measure')" disabled><span class="icon">ğŸ“</span>æ¸¬é‡</button>
                    <button class="tool-btn" id="gridBtn" onclick="toggleGrid()" disabled><span class="icon">ğŸ“</span>ç¶²æ ¼</button>
                    <button class="tool-btn" id="rulerBtn" onclick="toggleRuler()" disabled><span class="icon">ğŸ“</span>å°ºè¦</button>
                    <button class="tool-btn" id="guideBtn" onclick="showGuidePanel()" disabled><span class="icon">ğŸ“</span>åƒè€ƒç·š</button>
                    <button class="tool-btn" id="alignBtn" onclick="showAlignPanel()" disabled><span class="icon">ğŸ“</span>å°é½Š</button>
                    <button class="tool-btn" id="layerBtn" onclick="showLayerPanel()" disabled><span class="icon">ğŸ“š</span>åœ–å±¤</button>
                    <button class="tool-btn" id="channelBtn" onclick="showChannelPanel()" disabled><span class="icon">ğŸ“º</span>è‰²ç‰ˆ</button>
                    <button class="tool-btn" id="infoBtn" onclick="showInfoPanel()" disabled><span class="icon">â„¹ï¸</span>è³‡è¨Š</button>
                    <button class="tool-btn" id="historyBtn" onclick="showHistoryPanel()" disabled><span class="icon">ğŸ“œ</span>æ­·å²</button>
                    <button class="tool-btn" id="compareBtn" onclick="toggleCompare()" disabled><span class="icon">ğŸ”€</span>æ¯”è¼ƒ</button>
                </div>
                
                <!-- AI å·¥å…· -->
                <div class="toolbar-tools" id="tools-ai">
                    <button class="tool-btn" id="aiBtn" onclick="showAIPanel()" disabled><span class="icon">ğŸ¤–</span>AIåˆ†æ</button>
                    <button class="tool-btn" id="idPhotoBtn" onclick="showIdPhotoPanel()" disabled><span class="icon">ğŸªª</span>è­‰ä»¶ç…§</button>
                    <button class="tool-btn" id="screenshotBtn" onclick="showScreenshotPanel()" disabled><span class="icon">ğŸ“²</span>æˆªåœ–ç¾åŒ–</button>
                    <button class="tool-btn" id="faceSwapBtn" onclick="showFaceSwapPanel()" disabled><span class="icon">ğŸ­</span>æ›è‡‰</button>
                    <button class="tool-btn" id="skeletonBtn" onclick="showSkeletonPanel()" disabled><span class="icon">ğŸ¦´</span>éª¨æ¶</button>
                    <button class="tool-btn" id="colorSplashBtn" onclick="showColorSplashPanel()" disabled><span class="icon">ğŸ’¦</span>å±€éƒ¨å½©è‰²</button>
                    <button class="tool-btn" id="pdfToolBtn" onclick="showPdfToolPanel()" style="display:none"><span class="icon">ğŸ“‘</span>PDFæ‹†åˆ†</button>
                </div>
            </div>
            
            <!-- PDF æ§åˆ¶åˆ— -->
            <div class="pdf-controls" id="pdfControls">
                <button class="pdf-nav-btn" id="prevPage" onclick="changePage(-1)">â—€</button>
                <span class="pdf-page-info"><span id="currentPage">1</span> / <span id="totalPages">1</span></span>
                <button class="pdf-nav-btn" id="nextPage" onclick="changePage(1)">â–¶</button>
            </div>
            
            <!-- ç·¨è¼¯å€ -->
            <div class="editor-area">
                <!-- ä¸Šå‚³å€ -->
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">âœ¨</div>
                    <div class="upload-title">é–‹å§‹ä½ çš„é­”æ³•ä¿®åœ–</div>
                    <div class="upload-subtitle">æ”¯æ´ JPGã€PNGã€PDFï½œå¯ç›´æ¥è²¼ä¸Šæˆªåœ–</div>
                    <div class="upload-buttons">
                        <button class="upload-btn primary" onclick="triggerUpload('image')">ğŸ–¼ï¸ é¸æ“‡åœ–ç‰‡</button>
                        <button class="upload-btn primary" onclick="triggerUpload('pdf')">ğŸ“„ é¸æ“‡ PDF</button>
                        <button class="upload-btn secondary" onclick="pasteFromClipboard()">ğŸ“‹ è²¼ä¸Šæˆªåœ–</button>
                        <button class="upload-btn secondary" onclick="takePhoto()">ğŸ“· æ‹ç…§</button>
                    </div>
                    
                    <!-- é¦–é ä½¿ç”¨èªªæ˜ï¼ˆåœ¨ä¸Šå‚³å€å…§ï¼Œé è¨­é¡¯ç¤ºï¼‰ -->
                    <div class="home-guide" id="homeGuide">
                        <div class="guide-title">ğŸ© æ­¡è¿ä¾†åˆ°åœ–æ–‡é­”è¡“å¸«ï¼</div>
                        <div class="guide-intro">
                            è¶…å¼·ç€è¦½å™¨åœ–ç‰‡ç·¨è¼¯å™¨ï¼Œä¸ç”¨è£è»Ÿé«”ï¼Œæ‰“é–‹å°±èƒ½ç”¨ï¼
                        </div>
                        
                        <div class="guide-steps">
                            <div class="guide-step"><span class="step-icon">1ï¸âƒ£</span> ä¸Šå‚³åœ–ç‰‡æˆ– PDFï¼Œä¹Ÿå¯ä»¥ Ctrl+V è²¼ä¸Šæˆªåœ–</div>
                            <div class="guide-step"><span class="step-icon">2ï¸âƒ£</span> ç”¨ä¸Šæ–¹ 133 å€‹å·¥å…·ç›¡æƒ…ç·¨è¼¯</div>
                            <div class="guide-step"><span class="step-icon">3ï¸âƒ£</span> å®Œæˆå¾Œä¸‹è¼‰æˆ–æ¨é€åˆ° LINE</div>
                        </div>
                        
                        <div class="guide-features">
                            <button class="feature-tag" onclick="scrollToTool('brushBtn')">ğŸ–Œï¸ ç¹ªåœ–</button>
                            <button class="feature-tag" onclick="scrollToTool('filterBtn')">ğŸ¨ æ¿¾é¡</button>
                            <button class="feature-tag" onclick="scrollToTool('beautyBtn')">âœ¨ ç¾é¡</button>
                            <button class="feature-tag" onclick="scrollToTool('watermarkBtn')">ğŸ’¦ æµ®æ°´å°</button>
                            <button class="feature-tag" onclick="scrollToTool('idPhotoBtn')">ğŸªª è­‰ä»¶ç…§</button>
                            <button class="feature-tag" onclick="scrollToTool('aiBtn')">ğŸ¤– AI è§£æ</button>
                            <button class="feature-tag" onclick="scrollToTool('pdfToolBtn')">ğŸ“‘ PDF</button>
                            <button class="feature-tag" onclick="scrollToTool('curveBtn')">ğŸ“ˆ æ›²ç·š</button>
                        </div>
                        <div class="guide-hint">ğŸ‘† é»æ“Šä¸Šæ–¹æ¨™ç±¤å¯å¿«é€Ÿè·³åˆ°å°æ‡‰å·¥å…·ï¼ˆéœ€å…ˆä¸Šå‚³åœ–ç‰‡ï¼‰</div>
                    </div>
                </div>
                
                <!-- ç•«å¸ƒå€ -->
                <div class="canvas-wrapper" id="canvasWrapper">
                    <div class="canvas-info-bar">
                        <span id="canvasInfo">0 x 0</span>
                        <div class="tool-status" id="toolStatus" style="display:none;">
                            <span class="tool-status-icon">ğŸ”§</span>
                            <span class="tool-status-name" id="toolStatusName">ç„¡</span>
                            <button class="tool-status-cancel" onclick="cancelCurrentTool()" title="å–æ¶ˆå·¥å…· (ESC)">âœ•</button>
                        </div>
                        <div class="canvas-quick-tools">
                            <button class="quick-btn" id="selectBtn2" onclick="setTool('select')" title="é¸å–">âœ‚ï¸</button>
                            <button class="quick-btn" id="clearBtn2" onclick="clearSelection()" title="æ¸…é™¤é¸å–">ğŸ§¹</button>
                            <button class="quick-btn" id="undoBtn2" onclick="undoAction()" title="å¾©åŸ">â†©ï¸</button>
                            <button class="quick-btn danger" id="resetBtn2" onclick="resetCanvas()" title="é‡ç½®">ğŸ—‘ï¸</button>
                        </div>
                        <div class="zoom-controls">
                            <button class="zoom-btn" onclick="zoomCanvas(-0.1)" title="ç¸®å°">â–</button>
                            <span id="zoomInfo" onclick="resetZoom()" title="é»æ“Šé‡ç½®">100%</span>
                            <button class="zoom-btn" onclick="zoomCanvas(0.1)" title="æ”¾å¤§">â•</button>
                            <button class="zoom-btn fit" onclick="fitToScreen()" title="é©åˆè¢å¹•">ğŸ”²</button>
                        </div>
                    </div>
                    <div class="canvas-container" id="canvasContainer">
                        <canvas id="mainCanvas"></canvas>
                        <div class="drag-layer" id="dragLayer"></div>
                        <div class="selection-box" id="selectionBox"></div>
                    </div>
                    <div class="drag-controls" id="dragControls">
                        <div class="drag-controls-row">
                            <span class="drag-hint">ğŸ¯ æ‹–æ›³ç‰©ä»¶èª¿æ•´ä½ç½®ï¼Œæˆ–ä½¿ç”¨æ–¹å‘éµå¾®èª¿</span>
                        </div>
                        <div class="drag-controls-row">
                            <span class="drag-position-info" id="dragPositionInfo">X: 0, Y: 0</span>
                        </div>
                        <div class="drag-controls-row">
                            <div class="drag-nudge-controls">
                                <div class="drag-nudge-row">
                                    <button class="drag-nudge-btn" onclick="nudgeDragObject(0, -10)" title="ä¸Šç§» 10px">â–²</button>
                                </div>
                                <div class="drag-nudge-row">
                                    <button class="drag-nudge-btn" onclick="nudgeDragObject(-10, 0)" title="å·¦ç§» 10px">â—€</button>
                                    <button class="drag-nudge-btn center" onclick="centerDragObject()" title="ç½®ä¸­">âŠ•</button>
                                    <button class="drag-nudge-btn" onclick="nudgeDragObject(10, 0)" title="å³ç§» 10px">â–¶</button>
                                </div>
                                <div class="drag-nudge-row">
                                    <button class="drag-nudge-btn" onclick="nudgeDragObject(0, 10)" title="ä¸‹ç§» 10px">â–¼</button>
                                </div>
                            </div>
                            <button class="drag-btn confirm" onclick="confirmDragObject()">âœ… ç¢ºèªæ”¾ç½®</button>
                            <button class="drag-btn cancel" onclick="cancelDragObject()">âŒ å–æ¶ˆ</button>
                        </div>
                        <div class="drag-controls-row">
                            <small style="color:var(--text-secondary);font-size:10px;">ğŸ’¡ æŒ‰ä½ Shift + æ–¹å‘éµå¯å¾®èª¿ 1px</small>
                        </div>
                    </div>
                    <div class="zoom-hint">ğŸ’¡ é›™æŒ‡ç¸®æ”¾ | æ»¾è¼ªç¸®æ”¾ | é›™æ“Šé‡ç½®</div>
                </div>
                
                <!-- AI åˆ†æé¢æ¿ -->
                <div class="ai-panel" id="aiPanel">
                    <div class="panel-title">ğŸ¤– AI åœ–æ–‡è§£æ</div>
                    <div class="ai-model-select">
                        <label>é¸æ“‡æ¨¡å‹ï¼š</label>
                        <select id="aiModel">
                            <optgroup label="ğŸ’ Geminiï¼ˆå…è²»ï¼‰">
                                <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                            </optgroup>
                            <optgroup label="ğŸ’ Geminiï¼ˆä»˜è²»ï¼‰">
                                <option value="gemini-2.5-pro">ğŸ’° Gemini 2.5 Pro</option>
                                <option value="gemini-3.0-pro">ğŸ’° Gemini 3.0 Pro</option>
                            </optgroup>
                            <optgroup label="âš¡ Groqï¼ˆå…è²»ï¼‰">
                                <option value="llama-4-scout">Llama 4 Scout</option>
                                <option value="llama-4-maverick">Llama 4 Maverick</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="ai-options">
                        <label class="ai-option">
                            <input type="radio" name="aiMode" value="ocr" checked>
                            <span>ğŸ“ æ–‡å­—è¾¨è­˜</span>
                        </label>
                        <label class="ai-option">
                            <input type="radio" name="aiMode" value="describe">
                            <span>ğŸ” åœ–ç‰‡æè¿°</span>
                        </label>
                        <label class="ai-option">
                            <input type="radio" name="aiMode" value="translate">
                            <span>ğŸŒ ç¿»è­¯å…§å®¹</span>
                        </label>
                    </div>
                    <button class="ai-analyze-btn" onclick="analyzeImage()">ğŸš€ é–‹å§‹åˆ†æ</button>
                    <div class="ai-result" id="aiResult">
                        <div class="ai-result-placeholder">AI åˆ†æçµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...</div>
                    </div>
                    <div class="ai-actions">
                        <button class="action-btn primary" onclick="copyAIResult()">ğŸ“‹ è¤‡è£½çµæœ</button>
                        <button class="action-btn success" onclick="applyAIText()">âœ… æ‡‰ç”¨æ–‡å­—</button>
                    </div>
                </div>
                
                <!-- PDF æ‹†åˆ†çµ„åˆå·¥å…· -->
                <div class="pdf-tool-panel" id="pdfToolPanel">
                    <div class="panel-title">ğŸ“‘ PDF æ‹†åˆ†çµ„åˆ</div>
                    <div style="font-size:11px;color:var(--text-secondary);margin-bottom:10px;">
                        é»é¸é é¢é€²è¡Œé¸å–ï¼Œå¯å¤šé¸å¾ŒåŒ¯å‡º
                    </div>
                    <div class="pdf-pages-grid" id="pdfPagesGrid"></div>
                    <div class="pdf-tool-actions">
                        <button class="pdf-tool-btn select-all" onclick="toggleSelectAllPages()">â˜‘ï¸ å…¨é¸/å–æ¶ˆ</button>
                        <button class="pdf-tool-btn export-images" onclick="exportSelectedAsImages()">ğŸ–¼ï¸ åŒ¯å‡ºåœ–ç‰‡</button>
                        <button class="pdf-tool-btn export-pdf" onclick="exportSelectedAsPdf()">ğŸ“„ åˆä½µ PDF</button>
                    </div>
                </div>
                
                <!-- æµ®æ°´å°å·¥å…·é¢æ¿ -->
                <div class="watermark-panel" id="watermarkPanel">
                    <div class="panel-title">ğŸ’¦ æµ®æ°´å°å·¥å…·</div>
                    
                    <!-- åŠ ä¸Šæµ®æ°´å° -->
                    <div class="watermark-section">
                        <div class="section-subtitle">â• åŠ ä¸Šæµ®æ°´å°</div>
                        <div class="watermark-type-select">
                            <label class="watermark-type">
                                <input type="radio" name="wmType" value="text" checked>
                                <span>ğŸ“ æ–‡å­—æµ®æ°´å°</span>
                            </label>
                            <label class="watermark-type">
                                <input type="radio" name="wmType" value="image">
                                <span>ğŸ–¼ï¸ åœ–ç‰‡æµ®æ°´å°</span>
                            </label>
                        </div>
                        
                        <!-- æ–‡å­—æµ®æ°´å°è¨­å®š -->
                        <div class="wm-text-options" id="wmTextOptions">
                            <input type="text" id="wmText" placeholder="è¼¸å…¥æµ®æ°´å°æ–‡å­—..." class="wm-input">
                            <div class="wm-row">
                                <div class="wm-option">
                                    <label>å¤§å°</label>
                                    <input type="number" id="wmFontSize" value="48" min="12" max="200">
                                </div>
                                <div class="wm-option">
                                    <label>é¡è‰²</label>
                                    <input type="color" id="wmColor" value="#000000">
                                </div>
                                <div class="wm-option">
                                    <label>é€æ˜åº¦</label>
                                    <input type="range" id="wmOpacity" min="0.05" max="1" step="0.05" value="0.3" oninput="document.getElementById('wmOpacityValue').textContent=Math.round(this.value*100)+'%'">
                                    <span id="wmOpacityValue">30%</span>
                                </div>
                            </div>
                            <div class="wm-row">
                                <div class="wm-option">
                                    <label>è§’åº¦</label>
                                    <input type="range" id="wmAngle" min="-90" max="90" value="-30">
                                    <span id="wmAngleValue">-30Â°</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- åœ–ç‰‡æµ®æ°´å°è¨­å®š -->
                        <div class="wm-image-options" id="wmImageOptions" style="display:none;">
                            <button class="wm-upload-btn" onclick="document.getElementById('wmImageInput').click()">
                                ğŸ“¤ é¸æ“‡æµ®æ°´å°åœ–ç‰‡
                            </button>
                            <input type="file" id="wmImageInput" accept="image/*" style="display:none" onchange="loadWatermarkImage(event)">
                            <div id="wmImagePreview" class="wm-image-preview"></div>
                            <div class="wm-row">
                                <div class="wm-option">
                                    <label>å¤§å° %</label>
                                    <input type="range" id="wmImageSize" min="5" max="50" value="20">
                                    <span id="wmImageSizeValue">20%</span>
                                </div>
                                <div class="wm-option">
                                    <label>é€æ˜åº¦</label>
                                    <input type="range" id="wmImageOpacity" min="0.05" max="1" step="0.05" value="0.5" oninput="document.getElementById('wmImageOpacityValue').textContent=Math.round(this.value*100)+'%'">
                                    <span id="wmImageOpacityValue">50%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä½ç½®é¸æ“‡ -->
                        <div class="wm-position">
                            <label>ä½ç½®ï¼š</label>
                            <div class="position-grid">
                                <button class="pos-btn" data-pos="top-left">â†–</button>
                                <button class="pos-btn" data-pos="top-center">â†‘</button>
                                <button class="pos-btn" data-pos="top-right">â†—</button>
                                <button class="pos-btn" data-pos="middle-left">â†</button>
                                <button class="pos-btn active" data-pos="center">â¬¤</button>
                                <button class="pos-btn" data-pos="middle-right">â†’</button>
                                <button class="pos-btn" data-pos="bottom-left">â†™</button>
                                <button class="pos-btn" data-pos="bottom-center">â†“</button>
                                <button class="pos-btn" data-pos="bottom-right">â†˜</button>
                            </div>
                            <label class="tile-option">
                                <input type="checkbox" id="wmTile">
                                <span>å¹³é‹ªæ•´å¼µåœ–ç‰‡</span>
                            </label>
                        </div>
                        
                        <button class="wm-action-btn add" onclick="addWatermark()">âœ¨ åŠ ä¸Šæµ®æ°´å°</button>
                    </div>
                    
                    <!-- åˆ†éš”ç·š -->
                    <div class="wm-divider"></div>
                    
                    <!-- å»é™¤æµ®æ°´å° -->
                    <div class="watermark-section">
                        <div class="section-subtitle">ğŸ§¹ AI å»é™¤æµ®æ°´å°</div>
                        <div class="wm-remove-info">
                            å…ˆç”¨ã€Œé¸å–ã€å·¥å…·æ¡†é¸æµ®æ°´å°å€åŸŸï¼Œå†é»æ“Šä¸‹æ–¹æŒ‰éˆ•
                        </div>
                        <div class="wm-model-select">
                            <label>AI æ¨¡å‹ï¼š</label>
                            <select id="wmRemoveModel">
                                <optgroup label="ğŸ’ Gemini">
                                    <option value="gemini-2.0-flash">Gemini 2.0 Flashï¼ˆå…è²»ï¼‰</option>
                                    <option value="gemini-2.5-flash">Gemini 2.5 Flashï¼ˆå…è²»ï¼‰</option>
                                </optgroup>
                            </select>
                        </div>
                        <button class="wm-action-btn remove" onclick="removeWatermarkAI()">ğŸ¤– AI æ™ºæ…§å»é™¤</button>
                        <button class="wm-action-btn remove-manual" onclick="removeWatermarkManual()">ğŸ§¹ æ‰‹å‹•å¡«è‰²å»é™¤</button>
                    </div>
                </div>
                
                <!-- é¦¬è³½å…‹æç¤º -->
                <div class="tool-tip" id="mosaicTip" style="display:none;">
                    <div class="tip-content">ğŸ”² æ‹–æ›³é¸å–è¦æ‰“é¦¬è³½å…‹çš„å€åŸŸ</div>
                </div>
                
                <!-- åœ–ç« é¢æ¿ -->
                <div class="stamp-panel" id="stampPanel">
                    <div class="panel-title">ğŸ”– åœ–ç« å·¥å…·</div>
                    <div class="stamp-grid">
                        <button class="stamp-item" onclick="addStamp('æ©Ÿå¯†')">ğŸ”´ æ©Ÿå¯†</button>
                        <button class="stamp-item" onclick="addStamp('æ€¥ä»¶')">ğŸŸ  æ€¥ä»¶</button>
                        <button class="stamp-item" onclick="addStamp('å·²å¯©æ ¸')">ğŸŸ¢ å·²å¯©æ ¸</button>
                        <button class="stamp-item" onclick="addStamp('å·²ä»˜æ¬¾')">ğŸ’° å·²ä»˜æ¬¾</button>
                        <button class="stamp-item" onclick="addStamp('ä½œå»¢')">âŒ ä½œå»¢</button>
                        <button class="stamp-item" onclick="addStamp('COPY')">ğŸ“‹ COPY</button>
                        <button class="stamp-item" onclick="addStamp('DRAFT')">ğŸ“ DRAFT</button>
                        <button class="stamp-item" onclick="addStamp('APPROVED')">âœ… APPROVED</button>
                        <button class="stamp-item" onclick="addStamp('REJECTED')">ğŸš« REJECTED</button>
                        <button class="stamp-item" onclick="addStamp('CONFIDENTIAL')">ğŸ”’ CONFIDENTIAL</button>
                        <button class="stamp-item" onclick="addStamp('SAMPLE')">ğŸ“¦ SAMPLE</button>
                        <button class="stamp-item" onclick="addStamp('VOID')">â›” VOID</button>
                    </div>
                    <div class="stamp-custom">
                        <input type="text" id="customStamp" placeholder="è‡ªè¨‚åœ–ç« æ–‡å­—...">
                        <button onclick="addStamp(document.getElementById('customStamp').value)">æ–°å¢</button>
                    </div>
                    <div class="stamp-options">
                        <div class="wm-option">
                            <label>å¤§å°</label>
                            <input type="range" id="stampSize" min="30" max="150" value="60">
                        </div>
                        <div class="wm-option">
                            <label>é¡è‰²</label>
                            <input type="color" id="stampColor" value="#ff0000">
                        </div>
                        <div class="wm-option">
                            <label>è§’åº¦</label>
                            <input type="range" id="stampAngle" min="-45" max="45" value="-15">
                        </div>
                    </div>
                    <div class="wm-position" style="margin-top:10px;" id="stampPositionGrid">
                        <label>åˆå§‹ä½ç½®ï¼š</label>
                        <div class="position-grid">
                            <button class="pos-btn" onclick="setStampPosition('top-left', this)">â†–</button>
                            <button class="pos-btn" onclick="setStampPosition('top-center', this)">â†‘</button>
                            <button class="pos-btn" onclick="setStampPosition('top-right', this)">â†—</button>
                            <button class="pos-btn" onclick="setStampPosition('middle-left', this)">â†</button>
                            <button class="pos-btn active" onclick="setStampPosition('center', this)">â¬¤</button>
                            <button class="pos-btn" onclick="setStampPosition('middle-right', this)">â†’</button>
                            <button class="pos-btn" onclick="setStampPosition('bottom-left', this)">â†™</button>
                            <button class="pos-btn" onclick="setStampPosition('bottom-center', this)">â†“</button>
                            <button class="pos-btn" onclick="setStampPosition('bottom-right', this)">â†˜</button>
                        </div>
                    </div>
                    <button class="wm-action-btn" onclick="cancelStampPlacement()" style="margin-top:10px;background:var(--bg-input);">âŒ å–æ¶ˆæ”¾ç½®</button>
                </div>
                <div class="sign-panel" id="signPanel">
                    <div class="panel-title">âœï¸ é›»å­ç°½å</div>
                    <canvas id="signCanvas" width="300" height="150"></canvas>
                    <div class="sign-options">
                        <div class="wm-option">
                            <label>ç­†è§¸</label>
                            <input type="range" id="signLineWidth" min="1" max="8" value="3">
                        </div>
                        <div class="wm-option">
                            <label>é¡è‰²</label>
                            <input type="color" id="signColor" value="#000000">
                        </div>
                    </div>
                    <div class="wm-position" style="margin-top:10px;" id="signPositionGrid">
                        <label>åˆå§‹ä½ç½®ï¼š</label>
                        <div class="position-grid">
                            <button class="pos-btn" onclick="setSignPosition('top-left', this)">â†–</button>
                            <button class="pos-btn" onclick="setSignPosition('top-center', this)">â†‘</button>
                            <button class="pos-btn" onclick="setSignPosition('top-right', this)">â†—</button>
                            <button class="pos-btn" onclick="setSignPosition('middle-left', this)">â†</button>
                            <button class="pos-btn" onclick="setSignPosition('center', this)">â¬¤</button>
                            <button class="pos-btn" onclick="setSignPosition('middle-right', this)">â†’</button>
                            <button class="pos-btn" onclick="setSignPosition('bottom-left', this)">â†™</button>
                            <button class="pos-btn" onclick="setSignPosition('bottom-center', this)">â†“</button>
                            <button class="pos-btn active" onclick="setSignPosition('bottom-right', this)">â†˜</button>
                        </div>
                    </div>
                    <div class="sign-actions">
                        <button class="action-btn danger" onclick="clearSignature()">ğŸ—‘ï¸ æ¸…é™¤</button>
                        <button class="action-btn primary" onclick="applySignature()">âœ… å¥—ç”¨ç°½å</button>
                        <button class="action-btn" onclick="cancelSignPlacement()" style="background:var(--bg-input);margin-top:5px;width:100%;">âŒ å–æ¶ˆæ”¾ç½®</button>
                    </div>
                </div>
                
                <!-- æ¿¾é¡é¢æ¿ -->
                <div class="filter-panel" id="filterPanel">
                    <div class="panel-title">ğŸ¨ æ¿¾é¡æ•ˆæœ</div>
                    <div class="filter-preview-area">
                        <canvas id="filterPreview" width="120" height="80"></canvas>
                        <span id="filterPreviewName">åŸåœ–</span>
                    </div>
                    <div class="filter-grid">
                        <button class="filter-item" onmouseover="previewFilter('none')" onclick="applyFilter('none')">ğŸ”„ åŸåœ–</button>
                        <button class="filter-item" onmouseover="previewFilter('grayscale')" onclick="applyFilter('grayscale')">â¬› é»‘ç™½</button>
                        <button class="filter-item" onmouseover="previewFilter('sepia')" onclick="applyFilter('sepia')">ğŸŸ¤ å¾©å¤</button>
                        <button class="filter-item" onmouseover="previewFilter('invert')" onclick="applyFilter('invert')">ğŸ”ƒ åè½‰</button>
                        <button class="filter-item" onmouseover="previewFilter('blur')" onclick="applyFilter('blur')">ğŸŒ«ï¸ æ¨¡ç³Š</button>
                        <button class="filter-item" onmouseover="previewFilter('sharpen')" onclick="applyFilter('sharpen')">ğŸ”ª éŠ³åŒ–</button>
                        <button class="filter-item" onmouseover="previewFilter('brightness')" onclick="applyFilter('brightness')">â˜€ï¸ æ˜äº®</button>
                        <button class="filter-item" onmouseover="previewFilter('contrast')" onclick="applyFilter('contrast')">ğŸ­ å°æ¯”</button>
                        <button class="filter-item" onmouseover="previewFilter('saturate')" onclick="applyFilter('saturate')">ğŸŒˆ é®®è±”</button>
                        <button class="filter-item" onmouseover="previewFilter('cool')" onclick="applyFilter('cool')">â„ï¸ å†·è‰²</button>
                        <button class="filter-item" onmouseover="previewFilter('warm')" onclick="applyFilter('warm')">ğŸ”¥ æš–è‰²</button>
                        <button class="filter-item" onmouseover="previewFilter('vintage')" onclick="applyFilter('vintage')">ğŸ“· æ‡·èˆŠ</button>
                    </div>
                </div>
                
                <!-- èª¿æ•´é¢æ¿ -->
                <div class="adjust-panel" id="adjustPanel">
                    <div class="panel-title">ğŸŒˆ è‰²å½©èª¿æ•´</div>
                    <div class="adjust-sliders">
                        <div class="adjust-item">
                            <label>äº®åº¦</label>
                            <input type="range" id="adjustBrightness" min="-100" max="100" value="0">
                            <span id="brightnessVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>å°æ¯”</label>
                            <input type="range" id="adjustContrast" min="-100" max="100" value="0">
                            <span id="contrastVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>é£½å’Œåº¦</label>
                            <input type="range" id="adjustSaturation" min="-100" max="100" value="0">
                            <span id="saturationVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>è‰²ç›¸</label>
                            <input type="range" id="adjustHue" min="0" max="360" value="0">
                            <span id="hueVal">0Â°</span>
                        </div>
                    </div>
                    <div class="adjust-actions">
                        <button class="action-btn danger" onclick="resetAdjustments()">ğŸ”„ é‡ç½®</button>
                        <button class="action-btn primary" onclick="applyAdjustments()">âœ… å¥—ç”¨</button>
                    </div>
                </div>
                
                <!-- é‚Šæ¡†é¢æ¿ -->
                <div class="frame-panel" id="framePanel">
                    <div class="panel-title">ğŸ–¼ï¸ é‚Šæ¡†è£é£¾</div>
                    <div class="frame-grid">
                        <button class="frame-item" onclick="addFrame('none')">âŒ ç„¡</button>
                        <button class="frame-item" onclick="addFrame('simple')">â¬œ ç°¡ç´„ç™½</button>
                        <button class="frame-item" onclick="addFrame('black')">â¬› ç¶“å…¸é»‘</button>
                        <button class="frame-item" onclick="addFrame('rounded')">ğŸ”² åœ“è§’</button>
                        <button class="frame-item" onclick="addFrame('shadow')">ğŸŒ‘ é™°å½±</button>
                        <button class="frame-item" onclick="addFrame('polaroid')">ğŸ“¸ æ‹ç«‹å¾—</button>
                        <button class="frame-item" onclick="addFrame('film')">ğŸï¸ è† æ²</button>
                        <button class="frame-item" onclick="addFrame('torn')">ğŸ“ƒ æ’•ç´™</button>
                    </div>
                    <div class="frame-options">
                        <div class="wm-option">
                            <label>é‚Šæ¡†å¯¬åº¦</label>
                            <input type="range" id="frameWidth" min="5" max="50" value="20">
                        </div>
                        <div class="wm-option">
                            <label>é‚Šæ¡†é¡è‰²</label>
                            <input type="color" id="frameColor" value="#ffffff">
                        </div>
                    </div>
                </div>
                
                <!-- è²¼åœ–é¢æ¿ -->
                <div class="sticker-panel" id="stickerPanel">
                    <div class="panel-title">ğŸ˜€ è¡¨æƒ…è²¼åœ–</div>
                    <div class="sticker-tabs">
                        <button class="sticker-tab active" onclick="showStickerTab('emoji')">ğŸ˜€ è¡¨æƒ…</button>
                        <button class="sticker-tab" onclick="showStickerTab('symbol')">â­ ç¬¦è™Ÿ</button>
                        <button class="sticker-tab" onclick="showStickerTab('shape')">ğŸ”· å½¢ç‹€</button>
                    </div>
                    <div class="sticker-grid" id="stickerGrid">
                        <!-- å‹•æ…‹å¡«å…… -->
                    </div>
                    <div class="sticker-options">
                        <div class="wm-option">
                            <label>å¤§å°</label>
                            <input type="range" id="stickerSize" min="30" max="200" value="80">
                        </div>
                    </div>
                    <div class="wm-position" style="margin-top:10px;" id="stickerPositionGrid">
                        <label>åˆå§‹ä½ç½®ï¼š</label>
                        <div class="position-grid">
                            <button class="pos-btn" onclick="setStickerPosition('top-left', this)">â†–</button>
                            <button class="pos-btn" onclick="setStickerPosition('top-center', this)">â†‘</button>
                            <button class="pos-btn" onclick="setStickerPosition('top-right', this)">â†—</button>
                            <button class="pos-btn" onclick="setStickerPosition('middle-left', this)">â†</button>
                            <button class="pos-btn active" onclick="setStickerPosition('center', this)">â¬¤</button>
                            <button class="pos-btn" onclick="setStickerPosition('middle-right', this)">â†’</button>
                            <button class="pos-btn" onclick="setStickerPosition('bottom-left', this)">â†™</button>
                            <button class="pos-btn" onclick="setStickerPosition('bottom-center', this)">â†“</button>
                            <button class="pos-btn" onclick="setStickerPosition('bottom-right', this)">â†˜</button>
                        </div>
                    </div>
                    <button class="wm-action-btn" onclick="cancelStickerPlacement()" style="margin-top:10px;background:var(--bg-input);">âŒ å–æ¶ˆæ”¾ç½®</button>
                </div>
                
                <!-- ç®­é ­é¢æ¿ -->
                <div class="arrow-panel" id="arrowPanel">
                    <div class="panel-title">â¡ï¸ ç®­é ­å·¥å…·</div>
                    <div class="arrow-info" style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;">
                        è¨­å®šå®Œæˆå¾Œï¼Œåœ¨ç•«å¸ƒä¸Šæ‹–æ›³å³å¯ç•«ç®­é ­
                    </div>
                    <div class="stamp-options">
                        <div class="wm-option">
                            <label>ç²—ç´°</label>
                            <input type="range" id="arrowWidth" min="1" max="15" value="3" oninput="document.getElementById('arrowWidthValue').textContent=this.value+'px'">
                            <span id="arrowWidthValue">3px</span>
                        </div>
                        <div class="wm-option">
                            <label>é¡è‰²</label>
                            <input type="color" id="arrowColor" value="#ff0000">
                        </div>
                    </div>
                    <div class="wm-option" style="margin-top:10px;">
                        <label>ç·šæ¢æ¨£å¼</label>
                        <select id="arrowStyle" style="width:100%;padding:8px;border-radius:8px;background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border);">
                            <option value="solid">â”â” å¯¦ç·š</option>
                            <option value="dashed">â”„â”„ è™›ç·š</option>
                            <option value="dotted">Â·Â·Â·Â· é»ç·š</option>
                        </select>
                    </div>
                    <div class="wm-option" style="margin-top:10px;">
                        <label>ç®­é ­æ¨£å¼</label>
                        <select id="arrowHead" style="width:100%;padding:8px;border-radius:8px;background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border);">
                            <option value="filled">â–¶ å¯¦å¿ƒ</option>
                            <option value="outline">â–· ç©ºå¿ƒ</option>
                            <option value="diamond">â—† è±å½¢</option>
                            <option value="double">â—€â–¶ é›™å‘</option>
                            <option value="circle">â— åœ“é»</option>
                        </select>
                    </div>
                    <button class="wm-action-btn add" onclick="activateArrowTool()" style="margin-top:15px;">âœï¸ é–‹å§‹ç•«ç®­é ­</button>
                    <button class="wm-action-btn" onclick="cancelArrowTool()" style="margin-top:5px;background:var(--bg-input);">âŒ å–æ¶ˆ</button>
                </div>
                
                <!-- è£åˆ‡é¢æ¿ -->
                <div class="crop-panel" id="cropPanel">
                    <div class="panel-title">â¬œ è£åˆ‡åœ–ç‰‡</div>
                    <div class="crop-presets">
                        <button class="crop-preset" onclick="setCropRatio('free')">ğŸ”“ è‡ªç”±</button>
                        <button class="crop-preset" onclick="setCropRatio('1:1')">â¬œ 1:1</button>
                        <button class="crop-preset" onclick="setCropRatio('4:3')">ğŸ“º 4:3</button>
                        <button class="crop-preset" onclick="setCropRatio('16:9')">ğŸ–¥ï¸ 16:9</button>
                        <button class="crop-preset" onclick="setCropRatio('3:4')">ğŸ“± 3:4</button>
                        <button class="crop-preset" onclick="setCropRatio('9:16')">ğŸ“± 9:16</button>
                    </div>
                    <div class="crop-info">å…ˆç”¨ã€Œé¸å–ã€å·¥å…·æ¡†é¸è£åˆ‡å€åŸŸ</div>
                    <button class="wm-action-btn add" onclick="applyCrop()">âœ‚ï¸ åŸ·è¡Œè£åˆ‡</button>
                </div>
                
                <!-- æ‹¼æ¥é¢æ¿ -->
                <div class="merge-panel" id="mergePanel">
                    <div class="panel-title">ğŸ“ åœ–ç‰‡æ‹¼æ¥</div>
                    <div class="merge-direction">
                        <label class="merge-dir">
                            <input type="radio" name="mergeDir" value="vertical" checked>
                            <span>ğŸ“ å‚ç›´æ‹¼æ¥ï¼ˆä¸Šä¸‹ï¼‰</span>
                        </label>
                        <label class="merge-dir">
                            <input type="radio" name="mergeDir" value="horizontal">
                            <span>ğŸ“ æ°´å¹³æ‹¼æ¥ï¼ˆå·¦å³ï¼‰</span>
                        </label>
                    </div>
                    <div class="merge-list" id="mergeList">
                        <div class="merge-item current">ğŸ“Œ ç›®å‰åœ–ç‰‡</div>
                    </div>
                    <button class="wm-upload-btn" onclick="document.getElementById('mergeInput').click()">
                        â• æ·»åŠ åœ–ç‰‡
                    </button>
                    <input type="file" id="mergeInput" accept="image/*" multiple style="display:none" onchange="addMergeImages(event)">
                    <button class="wm-action-btn add" onclick="executeMerge()">ğŸ”— åŸ·è¡Œæ‹¼æ¥</button>
                </div>
                
                <!-- QR Code é¢æ¿ -->
                <div class="qr-panel" id="qrPanel">
                    <div class="panel-title">ğŸ“± QR Code åŠŸèƒ½</div>
                    
                    <!-- åˆ†é æ¨™ç±¤ -->
                    <div style="display:flex;gap:5px;margin-bottom:15px;">
                        <button class="qr-tab active" onclick="switchQRTab('generate', this)" style="flex:1;padding:8px;border-radius:8px;background:var(--primary);border:none;color:white;cursor:pointer;">ğŸ“ ç”Ÿæˆ QR</button>
                        <button class="qr-tab" onclick="switchQRTab('download', this)" style="flex:1;padding:8px;border-radius:8px;background:var(--bg-input);border:1px solid var(--border);color:white;cursor:pointer;">ğŸ“² æ‰‹æ©Ÿä¸‹è¼‰åœ–ç‰‡</button>
                    </div>
                    
                    <!-- ç”Ÿæˆ QR Code å€å¡Š -->
                    <div id="qrGenerateSection">
                        <input type="text" id="qrContent" class="wm-input" placeholder="è¼¸å…¥ç¶²å€æˆ–æ–‡å­—...">
                        <div class="qr-options">
                            <div class="wm-option">
                                <label>å¤§å°</label>
                                <input type="range" id="qrSize" min="50" max="200" value="100">
                            </div>
                            <div class="wm-option">
                                <label>å‰æ™¯è‰²</label>
                                <input type="color" id="qrFgColor" value="#000000">
                            </div>
                            <div class="wm-option">
                                <label>èƒŒæ™¯è‰²</label>
                                <input type="color" id="qrBgColor" value="#ffffff">
                            </div>
                        </div>
                        <div id="qrPreview" class="qr-preview"></div>
                        <button class="wm-action-btn add" onclick="generateQR()">ğŸ“± ç”Ÿæˆ QR Code</button>
                        <div class="wm-position" style="margin-top:10px;">
                            <label>åˆå§‹ä½ç½®ï¼š</label>
                            <div class="position-grid">
                                <button class="pos-btn" onclick="setQRPosition('top-left', this)">â†–</button>
                                <button class="pos-btn" onclick="setQRPosition('top-center', this)">â†‘</button>
                                <button class="pos-btn" onclick="setQRPosition('top-right', this)">â†—</button>
                                <button class="pos-btn" onclick="setQRPosition('middle-left', this)">â†</button>
                                <button class="pos-btn" onclick="setQRPosition('center', this)">â¬¤</button>
                                <button class="pos-btn" onclick="setQRPosition('middle-right', this)">â†’</button>
                                <button class="pos-btn" onclick="setQRPosition('bottom-left', this)">â†™</button>
                                <button class="pos-btn" onclick="setQRPosition('bottom-center', this)">â†“</button>
                                <button class="pos-btn active" onclick="setQRPosition('bottom-right', this)">â†˜</button>
                            </div>
                        </div>
                        <button class="wm-action-btn remove" onclick="placeQR()">ğŸ“ æ”¾ç½®åˆ°åœ–ç‰‡</button>
                        <button class="wm-action-btn" onclick="cancelQRPlacement()" style="margin-top:10px;background:var(--bg-input);">âŒ å–æ¶ˆæ”¾ç½®</button>
                    </div>
                    
                    <!-- æ‰‹æ©Ÿä¸‹è¼‰åœ–ç‰‡å€å¡Š -->
                    <div id="qrDownloadSection" style="display:none;">
                        <div style="background:var(--bg-input);border-radius:12px;padding:15px;margin-bottom:15px;">
                            <div style="font-size:14px;margin-bottom:10px;">ğŸ“² å‚³è¼¸åœ–ç‰‡åˆ°æ‰‹æ©Ÿ</div>
                            <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
                                å¤šç¨®æ–¹å¼å°‡ç·¨è¼¯å®Œæˆçš„åœ–ç‰‡å‚³åˆ°æ‰‹æ©Ÿï¼š<br>
                                ğŸ“¤ åˆ†äº«ã€ğŸ’¾ ä¸‹è¼‰ã€ğŸ“‹ è¤‡è£½ã€ğŸ’¬ LINE
                            </div>
                        </div>
                        <div id="downloadQrPreview" style="text-align:center;margin:15px 0;min-height:150px;display:flex;align-items:center;justify-content:center;background:var(--bg-input);border-radius:12px;">
                            <span style="color:var(--text-secondary);">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹</span>
                        </div>
                        <button class="wm-action-btn add" onclick="generateDownloadQR()">ğŸ“± é¡¯ç¤ºå‚³è¼¸é¸é …</button>
                        <div id="downloadLinkInfo" style="display:none;margin-top:10px;padding:10px;background:var(--bg-input);border-radius:8px;font-size:11px;word-break:break-all;">
                            <div style="color:var(--accent);margin-bottom:5px;">âœ… é€£çµå·²ç”Ÿæˆï¼</div>
                            <a id="downloadLinkUrl" href="#" target="_blank" style="color:var(--primary);text-decoration:underline;"></a>
                            <button onclick="copyDownloadLink()" style="margin-top:8px;padding:5px 10px;background:var(--primary);border:none;border-radius:4px;color:white;cursor:pointer;font-size:11px;">ğŸ“‹ è¤‡è£½é€£çµ</button>
                        </div>
                    </div>
                </div>
                
                <!-- å£“ç¸®é¢æ¿ -->
                <div class="compress-panel" id="compressPanel">
                    <div class="panel-title">ğŸ“¦ åœ–ç‰‡å£“ç¸®</div>
                    <div class="compress-info">
                        <div>åŸå§‹å¤§å°ï¼š<span id="originalSize">--</span></div>
                        <div>å£“ç¸®å¾Œï¼š<span id="compressedSize">--</span></div>
                        <div>å£“ç¸®ç‡ï¼š<span id="compressRatio">--</span></div>
                    </div>
                    <div class="compress-slider">
                        <label>å“è³ªï¼š<span id="qualityVal">80%</span></label>
                        <input type="range" id="compressQuality" min="10" max="100" value="80">
                    </div>
                    <div class="compress-resize">
                        <label>
                            <input type="checkbox" id="enableResize">
                            ç¸®å°å°ºå¯¸
                        </label>
                        <div class="resize-options" id="resizeOptions" style="display:none;">
                            <select id="resizePreset">
                                <option value="100">åŸå§‹å¤§å°</option>
                                <option value="75">75%</option>
                                <option value="50" selected>50%</option>
                                <option value="25">25%</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="previewCompress()">ğŸ‘ï¸ é è¦½å£“ç¸®</button>
                    <button class="wm-action-btn remove" onclick="downloadCompressed()">ğŸ’¾ ä¸‹è¼‰å£“ç¸®æª”</button>
                </div>
                
                <!-- ç•«ç­†é¢æ¿ -->
                <div class="brush-panel" id="brushPanel">
                    <div class="panel-title">ğŸ–Œï¸ ç•«ç­†å·¥å…·</div>
                    <div class="brush-types">
                        <button class="brush-type active" data-brush="pen" onclick="setBrushType('pen')">âœï¸ é‹¼ç­†</button>
                        <button class="brush-type" data-brush="marker" onclick="setBrushType('marker')">ğŸ–ï¸ éº¥å…‹ç­†</button>
                        <button class="brush-type" data-brush="highlighter" onclick="setBrushType('highlighter')">ğŸ“ è¢å…‰ç­†</button>
                        <button class="brush-type" data-brush="spray" onclick="setBrushType('spray')">ğŸ’¨ å™´æ§</button>
                        <button class="brush-type" data-brush="eraser" onclick="setBrushType('eraser')">ğŸ§½ æ©¡çš®æ“¦</button>
                    </div>
                    <div class="brush-options">
                        <div class="wm-option">
                            <label>å¤§å°</label>
                            <input type="range" id="brushSize" min="1" max="50" value="5" oninput="document.getElementById('brushSizeVal').textContent=this.value">
                            <span id="brushSizeVal">5</span>
                        </div>
                        <div class="wm-option">
                            <label>é€æ˜åº¦</label>
                            <input type="range" id="brushOpacity" min="0.1" max="1" step="0.1" value="1">
                        </div>
                        <div class="wm-option">
                            <label>é¡è‰²</label>
                            <input type="color" id="brushColor" value="#ff0000">
                        </div>
                    </div>
                    <div class="brush-colors">
                        <button class="color-preset" style="background:#000" onclick="setBrushColor('#000000')"></button>
                        <button class="color-preset" style="background:#fff" onclick="setBrushColor('#ffffff')"></button>
                        <button class="color-preset" style="background:#f00" onclick="setBrushColor('#ff0000')"></button>
                        <button class="color-preset" style="background:#0f0" onclick="setBrushColor('#00ff00')"></button>
                        <button class="color-preset" style="background:#00f" onclick="setBrushColor('#0000ff')"></button>
                        <button class="color-preset" style="background:#ff0" onclick="setBrushColor('#ffff00')"></button>
                        <button class="color-preset" style="background:#f0f" onclick="setBrushColor('#ff00ff')"></button>
                        <button class="color-preset" style="background:#0ff" onclick="setBrushColor('#00ffff')"></button>
                    </div>
                </div>
                
                <!-- å½¢ç‹€é¢æ¿ -->
                <div class="shape-panel" id="shapePanel">
                    <div class="panel-title">â­• å½¢ç‹€å·¥å…·</div>
                    <div class="shape-types">
                        <button class="shape-type active" onclick="setShapeType('rect')">â¬œ çŸ©å½¢</button>
                        <button class="shape-type" onclick="setShapeType('circle')">â­• åœ“å½¢</button>
                        <button class="shape-type" onclick="setShapeType('ellipse')">ğŸ”´ æ©¢åœ“</button>
                        <button class="shape-type" onclick="setShapeType('triangle')">ğŸ”º ä¸‰è§’</button>
                        <button class="shape-type" onclick="setShapeType('star')">â­ æ˜Ÿå½¢</button>
                        <button class="shape-type" onclick="setShapeType('heart')">â¤ï¸ æ„›å¿ƒ</button>
                        <button class="shape-type" onclick="setShapeType('line')">â– ç·šæ¢</button>
                        <button class="shape-type" onclick="setShapeType('polygon')">â¬¡ å¤šé‚Šå½¢</button>
                    </div>
                    <div class="shape-options">
                        <div class="wm-option">
                            <label>é‚Šæ¡†å¯¬åº¦</label>
                            <input type="range" id="shapeStroke" min="0" max="20" value="2">
                        </div>
                        <div class="wm-option">
                            <label>é‚Šæ¡†è‰²</label>
                            <input type="color" id="shapeStrokeColor" value="#000000">
                        </div>
                        <div class="wm-option">
                            <label>å¡«å……è‰²</label>
                            <input type="color" id="shapeFillColor" value="#ffffff">
                        </div>
                        <label class="tile-option">
                            <input type="checkbox" id="shapeFilled" checked>
                            <span>å¡«å……å½¢ç‹€</span>
                        </label>
                    </div>
                    <div class="shape-tip">æ‹–æ›³ç•«å¸ƒç¹ªè£½å½¢ç‹€</div>
                </div>
                
                <!-- æ–‡å­—ç‰¹æ•ˆé¢æ¿ -->
                <div class="textfx-panel" id="textFxPanel">
                    <div class="panel-title">ğŸ”¤ æ–‡å­—ç‰¹æ•ˆ</div>
                    <input type="text" id="fxText" class="wm-input" placeholder="è¼¸å…¥æ–‡å­—...">
                    <div class="textfx-styles">
                        <button class="fx-style" onclick="applyTextFx('shadow')">ğŸŒ‘ é™°å½±</button>
                        <button class="fx-style" onclick="applyTextFx('outline')">â­• æé‚Š</button>
                        <button class="fx-style" onclick="applyTextFx('gradient')">ğŸŒˆ æ¼¸å±¤</button>
                        <button class="fx-style" onclick="applyTextFx('glow')">âœ¨ ç™¼å…‰</button>
                        <button class="fx-style" onclick="applyTextFx('3d')">ğŸ² 3D</button>
                        <button class="fx-style" onclick="applyTextFx('neon')">ğŸ’¡ éœ“è™¹</button>
                        <button class="fx-style" onclick="applyTextFx('retro')">ğŸ“º å¾©å¤</button>
                        <button class="fx-style" onclick="applyTextFx('metal')">ğŸ”© é‡‘å±¬</button>
                    </div>
                    <div class="textfx-options">
                        <div class="wm-option">
                            <label>å¤§å°</label>
                            <input type="range" id="fxFontSize" min="20" max="150" value="60">
                        </div>
                        <div class="wm-option">
                            <label>ä¸»è‰²</label>
                            <input type="color" id="fxColor1" value="#ff0000">
                        </div>
                        <div class="wm-option">
                            <label>å‰¯è‰²</label>
                            <input type="color" id="fxColor2" value="#0000ff">
                        </div>
                    </div>
                    <div class="wm-position" style="margin-top:10px;">
                        <label>åˆå§‹ä½ç½®ï¼š</label>
                        <div class="position-grid">
                            <button class="pos-btn" onclick="setTextFxPosition('top-left', this)">â†–</button>
                            <button class="pos-btn" onclick="setTextFxPosition('top-center', this)">â†‘</button>
                            <button class="pos-btn" onclick="setTextFxPosition('top-right', this)">â†—</button>
                            <button class="pos-btn" onclick="setTextFxPosition('middle-left', this)">â†</button>
                            <button class="pos-btn active" onclick="setTextFxPosition('center', this)">â¬¤</button>
                            <button class="pos-btn" onclick="setTextFxPosition('middle-right', this)">â†’</button>
                            <button class="pos-btn" onclick="setTextFxPosition('bottom-left', this)">â†™</button>
                            <button class="pos-btn" onclick="setTextFxPosition('bottom-center', this)">â†“</button>
                            <button class="pos-btn" onclick="setTextFxPosition('bottom-right', this)">â†˜</button>
                        </div>
                    </div>
                    <button class="wm-action-btn" onclick="cancelTextFxPlacement()" style="margin-top:10px;background:var(--bg-input);">âŒ å–æ¶ˆæ”¾ç½®</button>
                </div>
                
                <!-- æ¨¡æ¿é¢æ¿ -->
                <div class="template-panel" id="templatePanel">
                    <div class="panel-title">ğŸ“‹ å°ºå¯¸æ¨¡æ¿</div>
                    <div class="template-categories">
                        <button class="template-cat active" onclick="showTemplates('social')">ğŸ“± ç¤¾ç¾¤</button>
                        <button class="template-cat" onclick="showTemplates('print')">ğŸ–¨ï¸ å°åˆ·</button>
                        <button class="template-cat" onclick="showTemplates('web')">ğŸŒ ç¶²é </button>
                        <button class="template-cat" onclick="showTemplates('video')">ğŸ¬ å½±ç‰‡</button>
                    </div>
                    <div class="template-grid" id="templateGrid">
                        <!-- å‹•æ…‹å¡«å…… -->
                    </div>
                    <div class="custom-size">
                        <div class="panel-subtitle">ğŸ“ è‡ªè¨‚å°ºå¯¸</div>
                        <div class="size-inputs">
                            <input type="number" id="customWidth" placeholder="å¯¬åº¦" value="800">
                            <span>Ã—</span>
                            <input type="number" id="customHeight" placeholder="é«˜åº¦" value="600">
                            <span>px</span>
                        </div>
                        <button class="wm-action-btn add" onclick="createCustomCanvas()">å»ºç«‹ç•«å¸ƒ</button>
                    </div>
                </div>
                
                <!-- æ‹¼è²¼é¢æ¿ -->
                <div class="collage-panel" id="collagePanel">
                    <div class="panel-title">ğŸ§© ç…§ç‰‡æ‹¼è²¼</div>
                    <div class="collage-layouts">
                        <button class="collage-layout" onclick="setCollageLayout(2, 'h')">â—« 2æ ¼æ©«</button>
                        <button class="collage-layout" onclick="setCollageLayout(2, 'v')">â—§ 2æ ¼ç›´</button>
                        <button class="collage-layout" onclick="setCollageLayout(3, 'h')">âŠŸ 3æ ¼æ©«</button>
                        <button class="collage-layout" onclick="setCollageLayout(4, 'grid')">âŠ 4æ ¼</button>
                        <button class="collage-layout" onclick="setCollageLayout(6, 'grid')">âŠ 6æ ¼</button>
                        <button class="collage-layout" onclick="setCollageLayout(9, 'grid')">âŠ 9æ ¼</button>
                    </div>
                    <div class="collage-options">
                        <div class="wm-option">
                            <label>é–“è·</label>
                            <input type="range" id="collageGap" min="0" max="30" value="10">
                        </div>
                        <div class="wm-option">
                            <label>åœ“è§’</label>
                            <input type="range" id="collageRadius" min="0" max="30" value="0">
                        </div>
                        <div class="wm-option">
                            <label>èƒŒæ™¯</label>
                            <input type="color" id="collageBg" value="#ffffff">
                        </div>
                    </div>
                    <div class="collage-images" id="collageImages">
                        <!-- å‹•æ…‹å¡«å……åœ–ç‰‡ -->
                    </div>
                    <button class="wm-upload-btn" onclick="document.getElementById('collageInput').click()">
                        â• æ·»åŠ ç…§ç‰‡
                    </button>
                    <input type="file" id="collageInput" accept="image/*" multiple style="display:none" onchange="addCollageImages(event)">
                    <button class="wm-action-btn add" onclick="generateCollage()">ğŸ§© ç”¢ç”Ÿæ‹¼è²¼</button>
                </div>
                
                <!-- ç¾é¡é¢æ¿ -->
                <div class="beauty-panel" id="beautyPanel">
                    <div class="panel-title">âœ¨ ç¾é¡ç¾åŒ–</div>
                    <div class="beauty-sliders">
                        <div class="adjust-item">
                            <label>ç£¨çš®</label>
                            <input type="range" id="beautySkin" min="0" max="100" value="0">
                            <span id="skinVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>ç¾ç™½</label>
                            <input type="range" id="beautyWhite" min="0" max="100" value="0">
                            <span id="whiteVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>ç´…æ½¤</label>
                            <input type="range" id="beautyRosy" min="0" max="100" value="0">
                            <span id="rosyVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>éŠ³åŒ–</label>
                            <input type="range" id="beautySharp" min="0" max="100" value="0">
                            <span id="sharpVal">0</span>
                        </div>
                    </div>
                    <div class="beauty-presets">
                        <button class="beauty-preset" onclick="applyBeautyPreset('natural')">ğŸŒ¿ è‡ªç„¶</button>
                        <button class="beauty-preset" onclick="applyBeautyPreset('soft')">ğŸŒ¸ æŸ”è†š</button>
                        <button class="beauty-preset" onclick="applyBeautyPreset('bright')">â˜€ï¸ äº®ç™½</button>
                        <button class="beauty-preset" onclick="applyBeautyPreset('glamour')">ğŸ’ é­…åŠ›</button>
                    </div>
                    <button class="wm-action-btn add" onclick="applyBeauty()">âœ¨ å¥—ç”¨ç¾é¡</button>
                </div>
                
                <!-- å»èƒŒé¢æ¿ -->
                <div class="removebg-panel" id="removeBgPanel">
                    <div class="panel-title">ğŸ­ èƒŒæ™¯è™•ç†</div>
                    <div class="removebg-options">
                        <button class="removebg-btn" onclick="removeBackground('white')">â¬œ å»ç™½èƒŒæ™¯</button>
                        <button class="removebg-btn" onclick="removeBackground('black')">â¬› å»é»‘èƒŒæ™¯</button>
                        <button class="removebg-btn" onclick="removeBackground('green')">ğŸŸ© å»ç¶ å¹•</button>
                        <button class="removebg-btn" onclick="removeBackground('color')">ğŸ¨ å»æŒ‡å®šè‰²</button>
                    </div>
                    <div class="color-pick-row" id="bgColorPick" style="display:none;">
                        <label>é¸æ“‡è¦å»é™¤çš„é¡è‰²ï¼š</label>
                        <input type="color" id="removeBgColor" value="#00ff00">
                        <button class="eyedropper-btn" onclick="pickBgColor()">ğŸ’§ å¸å–</button>
                    </div>
                    <div class="tolerance-row">
                        <label>å®¹å·®ï¼š<span id="toleranceVal">30</span></label>
                        <input type="range" id="bgTolerance" min="0" max="100" value="30">
                    </div>
                    <div class="new-bg-section">
                        <div class="panel-subtitle">ğŸ–¼ï¸ æ›¿æ›èƒŒæ™¯</div>
                        <div class="new-bg-options">
                            <button class="newbg-btn" onclick="setNewBg('transparent')">ğŸ”³ é€æ˜</button>
                            <button class="newbg-btn" onclick="setNewBg('color')">ğŸ¨ ç´”è‰²</button>
                            <button class="newbg-btn" onclick="setNewBg('gradient')">ğŸŒ… æ¼¸å±¤</button>
                            <button class="newbg-btn" onclick="setNewBg('image')">ğŸ–¼ï¸ åœ–ç‰‡</button>
                        </div>
                        <input type="color" id="newBgColor" value="#ffffff" style="margin-top:10px;">
                    </div>
                </div>
                
                <!-- æ‰¹æ¬¡è™•ç†é¢æ¿ -->
                <div class="batch-panel" id="batchPanel">
                    <div class="panel-title">ğŸ“š æ‰¹æ¬¡è™•ç†</div>
                    <div class="batch-upload">
                        <button class="wm-upload-btn" onclick="document.getElementById('batchInput').click()">
                            ğŸ“¤ é¸æ“‡å¤šå¼µåœ–ç‰‡
                        </button>
                        <input type="file" id="batchInput" accept="image/*" multiple style="display:none" onchange="loadBatchImages(event)">
                    </div>
                    <div class="batch-list" id="batchList">
                        <div class="batch-placeholder">å°šæœªé¸æ“‡åœ–ç‰‡</div>
                    </div>
                    <div class="batch-actions">
                        <div class="panel-subtitle">ğŸ“‹ æ‰¹æ¬¡æ“ä½œ</div>
                        <label class="batch-action"><input type="checkbox" id="batchResize"> ğŸ“ çµ±ä¸€å°ºå¯¸</label>
                        <label class="batch-action"><input type="checkbox" id="batchWatermark"> ğŸ’¦ åŠ æµ®æ°´å°</label>
                        <label class="batch-action"><input type="checkbox" id="batchFilter"> ğŸ¨ å¥—ç”¨æ¿¾é¡</label>
                        <label class="batch-action"><input type="checkbox" id="batchCompress"> ğŸ“¦ å£“ç¸®åœ–ç‰‡</label>
                        <label class="batch-action"><input type="checkbox" id="batchRename"> ğŸ“ æ‰¹æ¬¡å‘½å</label>
                    </div>
                    <button class="wm-action-btn add" onclick="executeBatch()">ğŸš€ åŸ·è¡Œæ‰¹æ¬¡è™•ç†</button>
                </div>
                
                <!-- ç‰¹æ•ˆé¢æ¿ -->
                <div class="effect-panel" id="effectPanel">
                    <div class="panel-title">ğŸ’« åœ–ç‰‡ç‰¹æ•ˆ</div>
                    <div class="effect-categories">
                        <button class="effect-cat active" onclick="showEffectCategory('all')">å…¨éƒ¨</button>
                        <button class="effect-cat" onclick="showEffectCategory('art')">ğŸ¨ è—è¡“</button>
                        <button class="effect-cat" onclick="showEffectCategory('film')">ğŸ¬ é›»å½±</button>
                        <button class="effect-cat" onclick="showEffectCategory('retro')">ğŸ“» å¾©å¤</button>
                    </div>
                    <div class="effect-grid" id="effectGrid">
                        <button class="effect-item" data-cat="art" onclick="applyEffect('emboss')">ğŸ”² æµ®é›•</button>
                        <button class="effect-item" data-cat="art" onclick="applyEffect('edge')">ğŸ“Š é‚Šç·£</button>
                        <button class="effect-item" data-cat="art" onclick="applyEffect('posterize')">ğŸ¨ è‰²èª¿åˆ†é›¢</button>
                        <button class="effect-item" data-cat="film" onclick="applyEffect('solarize')">â˜€ï¸ æ›å…‰</button>
                        <button class="effect-item" data-cat="film" onclick="applyEffect('thermal')">ğŸŒ¡ï¸ ç†±æˆåƒ</button>
                        <button class="effect-item" data-cat="film" onclick="applyEffect('xray')">ğŸ’€ Xå…‰</button>
                        <button class="effect-item" data-cat="film" onclick="applyEffect('night')">ğŸŒ™ å¤œè¦–</button>
                        <button class="effect-item" data-cat="art" onclick="applyEffect('comic')">ğŸ’¥ æ¼«ç•«</button>
                        <button class="effect-item" data-cat="retro" onclick="applyEffect('pop')">ğŸª æ™®æ™®</button>
                        <button class="effect-item" data-cat="retro" onclick="applyEffect('halftone')">ğŸ“° åŠè‰²èª¿</button>
                        <button class="effect-item" data-cat="art" onclick="applyEffect('crosshatch')">ğŸ“ äº¤å‰ç·š</button>
                        <button class="effect-item" data-cat="retro" onclick="applyEffect('dotscreen')">âš« ç¶²é»</button>
                    </div>
                    <div class="effect-tip">ğŸ’¡ æ»‘é¼ ç§»åˆ°æ•ˆæœä¸Šå¯é è¦½ï¼Œé»æ“Šå¥—ç”¨</div>
                </div>
                
                <!-- ç–ŠåŠ é¢æ¿ -->
                <div class="overlay-panel" id="overlayPanel">
                    <div class="panel-title">ğŸ´ åœ–å±¤ç–ŠåŠ </div>
                    <div class="overlay-types">
                        <button class="overlay-type" onclick="showOverlayType('light')">â˜€ï¸ å…‰æ•ˆ</button>
                        <button class="overlay-type" onclick="showOverlayType('texture')">ğŸ§± ç´‹ç†</button>
                        <button class="overlay-type" onclick="showOverlayType('pattern')">ğŸ”² åœ–æ¡ˆ</button>
                        <button class="overlay-type" onclick="showOverlayType('gradient')">ğŸŒ… æ¼¸å±¤</button>
                    </div>
                    <div class="overlay-grid" id="overlayGrid">
                        <!-- å‹•æ…‹å¡«å…… -->
                    </div>
                    <div class="overlay-options">
                        <div class="wm-option">
                            <label>æ··åˆæ¨¡å¼</label>
                            <select id="blendMode">
                                <option value="normal">æ­£å¸¸</option>
                                <option value="multiply">æ­£ç‰‡ç–Šåº•</option>
                                <option value="screen">æ¿¾è‰²</option>
                                <option value="overlay">è¦†è“‹</option>
                                <option value="soft-light">æŸ”å…‰</option>
                                <option value="hard-light">å¼·å…‰</option>
                                <option value="color-dodge">é¡è‰²æ¸›æ·¡</option>
                                <option value="color-burn">é¡è‰²åŠ æ·±</option>
                            </select>
                        </div>
                        <div class="wm-option">
                            <label>é€æ˜åº¦</label>
                            <input type="range" id="overlayOpacity" min="0" max="1" step="0.1" value="0.5">
                        </div>
                    </div>
                </div>
                
                <!-- æ‰¹è¨»é¢æ¿ -->
                <div class="annotate-panel" id="annotatePanel">
                    <div class="panel-title">ğŸ“ æ‰¹è¨»å·¥å…·</div>
                    <div class="annotate-tools">
                        <button class="annotate-tool" onclick="setAnnotateTool('highlight')">ğŸ“ è¢å…‰æ¨™è¨˜</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('underline')">ğŸ“ åº•ç·š</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('strikethrough')">âŒ åˆªé™¤ç·š</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('circle')">â­• åœˆé¸</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('box')">ğŸ”² æ–¹æ¡†</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('check')">âœ… æ‰“å‹¾</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('cross')">âŒ æ‰“å‰</button>
                        <button class="annotate-tool" onclick="setAnnotateTool('number')">ğŸ”¢ ç·¨è™Ÿ</button>
                    </div>
                    <div class="annotate-options">
                        <div class="wm-option">
                            <label>é¡è‰²</label>
                            <input type="color" id="annotateColor" value="#ff0000">
                        </div>
                        <div class="wm-option">
                            <label>ç²—ç´°</label>
                            <input type="range" id="annotateWidth" min="1" max="10" value="3">
                        </div>
                    </div>
                </div>
                
                <!-- æ­·å²è¨˜éŒ„é¢æ¿ -->
                <div class="history-panel" id="historyPanel">
                    <div class="panel-title">ğŸ“œ æ­·å²è¨˜éŒ„</div>
                    <div class="history-list" id="historyList">
                        <!-- å‹•æ…‹å¡«å…… -->
                    </div>
                    <div class="history-actions">
                        <button class="action-btn danger" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤æ­·å²</button>
                    </div>
                </div>
                
                <!-- åœ–ç‰‡è³‡è¨Šé¢æ¿ -->
                <div class="info-panel" id="infoPanel">
                    <div class="panel-title">â„¹ï¸ åœ–ç‰‡è³‡è¨Š</div>
                    <div class="info-content" id="infoContent">
                        <!-- å‹•æ…‹å¡«å…… -->
                    </div>
                </div>
                
                <!-- é¡è‰²æ›¿æ›é¢æ¿ -->
                <div class="colorreplace-panel" id="colorReplacePanel">
                    <div class="panel-title">ğŸ¨ é¡è‰²æ›¿æ›</div>
                    <div class="color-replace-row">
                        <div class="wm-option">
                            <label>åŸå§‹é¡è‰²</label>
                            <input type="color" id="replaceFrom" value="#ff0000">
                            <button class="eyedropper-btn" onclick="pickReplaceColor('from')">ğŸ’§</button>
                        </div>
                        <span class="arrow">â†’</span>
                        <div class="wm-option">
                            <label>æ›¿æ›ç‚º</label>
                            <input type="color" id="replaceTo" value="#0000ff">
                        </div>
                    </div>
                    <div class="wm-option">
                        <label>å®¹å·®ï¼š<span id="replaceToleranceVal">30</span></label>
                        <input type="range" id="replaceTolerance" min="0" max="100" value="30">
                    </div>
                    <button class="wm-action-btn add" onclick="replaceColor()">ğŸ”„ åŸ·è¡Œæ›¿æ›</button>
                </div>
                
                <!-- è­‰ä»¶ç…§é¢æ¿ -->
                <div class="idphoto-panel" id="idPhotoPanel">
                    <div class="panel-title">ğŸªª è­‰ä»¶ç…§è£½ä½œ</div>
                    <div class="id-sizes">
                        <button class="id-size" onclick="setIdSize('1inch')">1å‹ (25Ã—35mm)</button>
                        <button class="id-size" onclick="setIdSize('2inch')">2å‹ (35Ã—45mm)</button>
                        <button class="id-size" onclick="setIdSize('passport')">è­·ç…§ (35Ã—45mm)</button>
                        <button class="id-size" onclick="setIdSize('visa')">ç°½è­‰ (33Ã—48mm)</button>
                        <button class="id-size" onclick="setIdSize('license')">é§•ç…§ (22Ã—30mm)</button>
                    </div>
                    <div class="id-options">
                        <div class="wm-option">
                            <label>èƒŒæ™¯è‰²</label>
                            <select id="idBgColor">
                                <option value="#ffffff">ç™½è‰²</option>
                                <option value="#438edb">è—è‰²</option>
                                <option value="#ff0000">ç´…è‰²</option>
                                <option value="#cccccc">ç°è‰²</option>
                            </select>
                        </div>
                        <div class="wm-option">
                            <label>æ’ç‰ˆæ•¸é‡</label>
                            <select id="idCount">
                                <option value="1">1å¼µ</option>
                                <option value="4">4å¼µ</option>
                                <option value="8" selected>8å¼µ</option>
                                <option value="12">12å¼µ</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="generateIdPhoto()">ğŸªª ç”¢ç”Ÿè­‰ä»¶ç…§</button>
                </div>
                
                <!-- æˆªåœ–ç¾åŒ–é¢æ¿ -->
                <div class="screenshot-panel" id="screenshotPanel">
                    <div class="panel-title">ğŸ“² æˆªåœ–ç¾åŒ–</div>
                    <div class="device-frames">
                        <button class="device-frame" onclick="addDeviceFrame('iphone')">ğŸ“± iPhone</button>
                        <button class="device-frame" onclick="addDeviceFrame('android')">ğŸ“± Android</button>
                        <button class="device-frame" onclick="addDeviceFrame('ipad')">ğŸ“± iPad</button>
                        <button class="device-frame" onclick="addDeviceFrame('macbook')">ğŸ’» MacBook</button>
                        <button class="device-frame" onclick="addDeviceFrame('imac')">ğŸ–¥ï¸ iMac</button>
                        <button class="device-frame" onclick="addDeviceFrame('browser')">ğŸŒ ç€è¦½å™¨</button>
                    </div>
                    <div class="screenshot-options">
                        <div class="wm-option">
                            <label>èƒŒæ™¯</label>
                            <select id="screenshotBg">
                                <option value="gradient1">æ¼¸å±¤ç´«ç²‰</option>
                                <option value="gradient2">æ¼¸å±¤è—ç¶ </option>
                                <option value="gradient3">æ¼¸å±¤æ©˜ç´…</option>
                                <option value="solid">ç´”è‰²</option>
                                <option value="pattern">åœ–æ¡ˆ</option>
                            </select>
                        </div>
                        <label class="tile-option">
                            <input type="checkbox" id="screenshotShadow" checked>
                            <span>è£ç½®é™°å½±</span>
                        </label>
                    </div>
                </div>
                
                <!-- åƒç´ ç•«é¢æ¿ -->
                <div class="pixelart-panel" id="pixelArtPanel">
                    <div class="panel-title">ğŸ‘¾ åƒç´ åŒ–</div>
                    <div class="pixel-options">
                        <div class="wm-option">
                            <label>åƒç´ å¤§å°</label>
                            <input type="range" id="pixelSize" min="2" max="30" value="10">
                            <span id="pixelSizeVal">10</span>
                        </div>
                    </div>
                    <div class="pixel-presets">
                        <button class="pixel-preset" onclick="applyPixelArt(5)">ç´°ç·»</button>
                        <button class="pixel-preset" onclick="applyPixelArt(10)">ä¸­ç­‰</button>
                        <button class="pixel-preset" onclick="applyPixelArt(20)">ç²—ç³™</button>
                        <button class="pixel-preset" onclick="applyPixelArt(30)">è¶…å¤§</button>
                    </div>
                </div>
                
                <!-- ASCII é¢æ¿ -->
                <div class="ascii-panel" id="asciiPanel">
                    <div class="panel-title">ğŸ’» ASCII è—è¡“</div>
                    <div class="ascii-options">
                        <div class="wm-option">
                            <label>å­—å…ƒå¯†åº¦</label>
                            <input type="range" id="asciiDensity" min="1" max="10" value="5">
                        </div>
                        <div class="wm-option">
                            <label>å­—å…ƒé›†</label>
                            <select id="asciiCharset">
                                <option value="standard">æ¨™æº– (@#%*+-:.)</option>
                                <option value="blocks">æ–¹å¡Š (â–ˆâ–“â–’â–‘)</option>
                                <option value="numbers">æ•¸å­— (0-9)</option>
                                <option value="custom">è‡ªè¨‚</option>
                            </select>
                        </div>
                    </div>
                    <textarea id="asciiOutput" class="ascii-output" readonly></textarea>
                    <div class="ascii-actions">
                        <button class="action-btn primary" onclick="generateAscii()">ğŸ”„ ç”Ÿæˆ</button>
                        <button class="action-btn success" onclick="copyAscii()">ğŸ“‹ è¤‡è£½</button>
                        <button class="action-btn" onclick="asciiToImage()">ğŸ–¼ï¸ è½‰åœ–ç‰‡</button>
                    </div>
                </div>
                
                <!-- é›™è‰²èª¿é¢æ¿ -->
                <div class="duotone-panel" id="duotonePanel">
                    <div class="panel-title">ğŸ­ é›™è‰²èª¿</div>
                    <div class="duotone-presets">
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#ff6b6b,#4ecdc4)" onclick="applyDuotone('#ff6b6b','#4ecdc4')"></button>
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#6c5ce7,#ffeaa7)" onclick="applyDuotone('#6c5ce7','#ffeaa7')"></button>
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#e17055,#0984e3)" onclick="applyDuotone('#e17055','#0984e3')"></button>
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#00b894,#fd79a8)" onclick="applyDuotone('#00b894','#fd79a8')"></button>
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#fdcb6e,#e84393)" onclick="applyDuotone('#fdcb6e','#e84393')"></button>
                        <button class="duotone-preset" style="background:linear-gradient(135deg,#55efc4,#a29bfe)" onclick="applyDuotone('#55efc4','#a29bfe')"></button>
                    </div>
                    <div class="duotone-custom">
                        <div class="wm-option">
                            <label>æš—éƒ¨</label>
                            <input type="color" id="duotoneDark" value="#000000">
                        </div>
                        <div class="wm-option">
                            <label>äº®éƒ¨</label>
                            <input type="color" id="duotoneLight" value="#ffffff">
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyDuotoneCustom()">ğŸ­ å¥—ç”¨é›™è‰²èª¿</button>
                </div>
                
                <!-- æ¼¸å±¤ç–ŠåŠ é¢æ¿ -->
                <div class="gradient-panel" id="gradientPanel">
                    <div class="panel-title">ğŸŒ… æ¼¸å±¤ç–ŠåŠ </div>
                    <div class="gradient-presets">
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#667eea,#764ba2)" onclick="applyGradientOverlay('#667eea','#764ba2')"></button>
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#f093fb,#f5576c)" onclick="applyGradientOverlay('#f093fb','#f5576c')"></button>
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#4facfe,#00f2fe)" onclick="applyGradientOverlay('#4facfe','#00f2fe')"></button>
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#43e97b,#38f9d7)" onclick="applyGradientOverlay('#43e97b','#38f9d7')"></button>
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#fa709a,#fee140)" onclick="applyGradientOverlay('#fa709a','#fee140')"></button>
                        <button class="gradient-preset" style="background:linear-gradient(135deg,#a8edea,#fed6e3)" onclick="applyGradientOverlay('#a8edea','#fed6e3')"></button>
                    </div>
                    <div class="gradient-options">
                        <div class="wm-option">
                            <label>è§’åº¦</label>
                            <input type="range" id="gradientAngle" min="0" max="360" value="135">
                            <span id="gradientAngleVal">135Â°</span>
                        </div>
                        <div class="wm-option">
                            <label>é€æ˜åº¦</label>
                            <input type="range" id="gradientOpacity" min="0.1" max="1" step="0.1" value="0.5">
                        </div>
                    </div>
                </div>
                
                <!-- é›œè¨Šé¢æ¿ -->
                <div class="noise-panel" id="noisePanel">
                    <div class="panel-title">ğŸ“» é›œè¨Š/é¡†ç²’</div>
                    <div class="noise-options">
                        <div class="wm-option">
                            <label>å¼·åº¦</label>
                            <input type="range" id="noiseAmount" min="0" max="100" value="20">
                            <span id="noiseAmountVal">20</span>
                        </div>
                        <div class="wm-option">
                            <label>é¡å‹</label>
                            <select id="noiseType">
                                <option value="gaussian">é«˜æ–¯é›œè¨Š</option>
                                <option value="uniform">å‡å‹»é›œè¨Š</option>
                                <option value="film">åº•ç‰‡é¡†ç²’</option>
                            </select>
                        </div>
                        <label class="tile-option">
                            <input type="checkbox" id="noiseColor">
                            <span>å½©è‰²é›œè¨Š</span>
                        </label>
                    </div>
                    <button class="wm-action-btn add" onclick="applyNoise()">ğŸ“» æ·»åŠ é›œè¨Š</button>
                </div>
                
                <!-- èƒŒæ™¯æ¨¡ç³Šé¢æ¿ -->
                <div class="blurbg-panel" id="blurBgPanel">
                    <div class="panel-title">ğŸŒ«ï¸ æ™¯æ·±æ¨¡ç³Š</div>
                    <div class="blur-info">å…ˆç”¨ã€Œé¸å–ã€å·¥å…·æ¡†é¸è¦ä¿æŒæ¸…æ™°çš„å€åŸŸ</div>
                    <div class="blur-options">
                        <div class="wm-option">
                            <label>æ¨¡ç³Šç¨‹åº¦</label>
                            <input type="range" id="blurAmount" min="1" max="20" value="10">
                            <span id="blurAmountVal">10</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applySelectiveBlur()">ğŸŒ«ï¸ å¥—ç”¨æ™¯æ·±</button>
                </div>
                
                <!-- ç´‹ç†é¢æ¿ -->
                <div class="texture-panel" id="texturePanel">
                    <div class="panel-title">ğŸ§± ç´‹ç†ç–ŠåŠ </div>
                    <div class="texture-grid">
                        <button class="texture-item" onclick="applyTexture('paper')">ğŸ“œ ç´™å¼µ</button>
                        <button class="texture-item" onclick="applyTexture('canvas')">ğŸ¨ ç•«å¸ƒ</button>
                        <button class="texture-item" onclick="applyTexture('leather')">ğŸ‘œ çš®é©</button>
                        <button class="texture-item" onclick="applyTexture('wood')">ğŸªµ æœ¨ç´‹</button>
                        <button class="texture-item" onclick="applyTexture('fabric')">ğŸ§µ å¸ƒæ–™</button>
                        <button class="texture-item" onclick="applyTexture('metal')">ğŸ”© é‡‘å±¬</button>
                        <button class="texture-item" onclick="applyTexture('concrete')">ğŸ§± æ°´æ³¥</button>
                        <button class="texture-item" onclick="applyTexture('noise')">ğŸ“º é›œè¨Š</button>
                    </div>
                    <div class="texture-options">
                        <div class="wm-option">
                            <label>å¼·åº¦</label>
                            <input type="range" id="textureAmount" min="0.1" max="1" step="0.1" value="0.3">
                        </div>
                    </div>
                </div>
                
                <!-- æ•£æ™¯é¢æ¿ -->
                <div class="bokeh-panel" id="bokehPanel">
                    <div class="panel-title">ğŸ’¡ æ•£æ™¯å…‰æ–‘</div>
                    <div class="bokeh-options">
                        <div class="wm-option">
                            <label>æ•¸é‡</label>
                            <input type="range" id="bokehCount" min="5" max="50" value="20">
                        </div>
                        <div class="wm-option">
                            <label>å¤§å°</label>
                            <input type="range" id="bokehSize" min="10" max="100" value="40">
                        </div>
                        <div class="wm-option">
                            <label>é¡è‰²</label>
                            <select id="bokehColor">
                                <option value="warm">æš–è‰²ç³»</option>
                                <option value="cool">å†·è‰²ç³»</option>
                                <option value="rainbow">å½©è™¹</option>
                                <option value="gold">é‡‘è‰²</option>
                                <option value="custom">è‡ªè¨‚</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="addBokeh()">ğŸ’¡ æ·»åŠ æ•£æ™¯</button>
                </div>
                
                <!-- é¡åƒé¢æ¿ -->
                <div class="mirror-panel" id="mirrorPanel">
                    <div class="panel-title">ğŸª é¡åƒæ•ˆæœ</div>
                    <div class="mirror-types">
                        <button class="mirror-type" onclick="applyMirror('left')">â—§ å·¦é¡åƒ</button>
                        <button class="mirror-type" onclick="applyMirror('right')">â—¨ å³é¡åƒ</button>
                        <button class="mirror-type" onclick="applyMirror('top')">â¬’ ä¸Šé¡åƒ</button>
                        <button class="mirror-type" onclick="applyMirror('bottom')">â¬“ ä¸‹é¡åƒ</button>
                        <button class="mirror-type" onclick="applyMirror('quad')">âŠ å››è±¡é™</button>
                    </div>
                </div>
                
                <!-- åˆ†å‰²é¢æ¿ -->
                <div class="split-panel" id="splitPanel">
                    <div class="panel-title">ğŸ”² åœ–ç‰‡åˆ†å‰²</div>
                    <div class="split-options">
                        <div class="wm-option">
                            <label>åˆ—æ•¸</label>
                            <input type="number" id="splitRows" min="1" max="10" value="3">
                        </div>
                        <div class="wm-option">
                            <label>æ¬„æ•¸</label>
                            <input type="number" id="splitCols" min="1" max="10" value="3">
                        </div>
                    </div>
                    <div class="split-presets">
                        <button class="split-preset" onclick="setSplit(2,2)">2Ã—2</button>
                        <button class="split-preset" onclick="setSplit(3,3)">3Ã—3</button>
                        <button class="split-preset" onclick="setSplit(4,4)">4Ã—4</button>
                        <button class="split-preset" onclick="setSplit(1,3)">1Ã—3</button>
                        <button class="split-preset" onclick="setSplit(3,1)">3Ã—1</button>
                    </div>
                    <button class="wm-action-btn add" onclick="splitImage()">ğŸ”² åˆ†å‰²ä¸¦ä¸‹è¼‰</button>
                </div>
                
                <!-- ç¤¾ç¾¤åª’é«”é¢æ¿ -->
                <div class="social-panel" id="socialPanel">
                    <div class="panel-title">ğŸ“± ç¤¾ç¾¤åª’é«”å°ºå¯¸</div>
                    <div class="social-platforms">
                        <div class="social-platform">
                            <div class="platform-name">ğŸ“¸ Instagram</div>
                            <button onclick="resizeForSocial('ig-post')">è²¼æ–‡ 1:1</button>
                            <button onclick="resizeForSocial('ig-story')">é™å‹• 9:16</button>
                            <button onclick="resizeForSocial('ig-reel')">Reels 9:16</button>
                        </div>
                        <div class="social-platform">
                            <div class="platform-name">ğŸ“˜ Facebook</div>
                            <button onclick="resizeForSocial('fb-post')">è²¼æ–‡</button>
                            <button onclick="resizeForSocial('fb-cover')">å°é¢</button>
                            <button onclick="resizeForSocial('fb-story')">é™å‹•</button>
                        </div>
                        <div class="social-platform">
                            <div class="platform-name">ğŸ¦ Twitter/X</div>
                            <button onclick="resizeForSocial('tw-post')">æ¨æ–‡</button>
                            <button onclick="resizeForSocial('tw-header')">æ©«å¹…</button>
                        </div>
                        <div class="social-platform">
                            <div class="platform-name">â–¶ï¸ YouTube</div>
                            <button onclick="resizeForSocial('yt-thumb')">ç¸®åœ–</button>
                            <button onclick="resizeForSocial('yt-banner')">æ©«å¹…</button>
                        </div>
                        <div class="social-platform">
                            <div class="platform-name">ğŸ’¼ LinkedIn</div>
                            <button onclick="resizeForSocial('li-post')">è²¼æ–‡</button>
                            <button onclick="resizeForSocial('li-cover')">æ©«å¹…</button>
                        </div>
                    </div>
                </div>
                
                <!-- åŒ¯å‡ºé¢æ¿ -->
                <div class="export-panel" id="exportPanel">
                    <div class="panel-title">ğŸ’¾ é€²éšåŒ¯å‡º</div>
                    <div class="export-options">
                        <div class="wm-option">
                            <label>æ ¼å¼</label>
                            <select id="exportFormat">
                                <option value="png">PNGï¼ˆç„¡æï¼‰</option>
                                <option value="jpeg">JPEGï¼ˆæœ‰æï¼‰</option>
                                <option value="webp">WebPï¼ˆé«˜æ•ˆï¼‰</option>
                                <option value="gif">GIF</option>
                                <option value="bmp">BMP</option>
                            </select>
                        </div>
                        <div class="wm-option" id="jpegQualityOption">
                            <label>å“è³ª</label>
                            <input type="range" id="exportQuality" min="0.1" max="1" step="0.1" value="0.9">
                            <span id="exportQualityVal">90%</span>
                        </div>
                        <div class="wm-option">
                            <label>ç¸®æ”¾</label>
                            <select id="exportScale">
                                <option value="1">100%</option>
                                <option value="0.75">75%</option>
                                <option value="0.5">50%</option>
                                <option value="0.25">25%</option>
                                <option value="2">200%</option>
                            </select>
                        </div>
                        <div class="wm-option">
                            <label>æª”å</label>
                            <input type="text" id="exportFilename" value="image-magic" class="wm-input">
                        </div>
                    </div>
                    <div class="export-info" id="exportInfo">
                        é ä¼°å¤§å°ï¼šè¨ˆç®—ä¸­...
                    </div>
                    <button class="wm-action-btn add" onclick="advancedExport()">ğŸ’¾ ä¸‹è¼‰</button>
                </div>
                
                <!-- æ¢—åœ–é¢æ¿ -->
                <div class="meme-panel" id="memePanel">
                    <div class="panel-title">ğŸ˜‚ æ¢—åœ–ç”¢ç”Ÿå™¨</div>
                    <div class="meme-templates" id="memeTemplateGrid"></div>
                    <div class="meme-inputs" id="memeInputs"></div>
                    <div class="meme-options">
                        <div class="wm-option">
                            <label>å­—å‹å¤§å°</label>
                            <input type="range" id="memeFontSize" min="20" max="80" value="40">
                        </div>
                        <div class="wm-option">
                            <label>æ–‡å­—è‰²</label>
                            <input type="color" id="memeFontColor" value="#ffffff">
                        </div>
                        <div class="wm-option">
                            <label>æé‚Šè‰²</label>
                            <input type="color" id="memeStrokeColor" value="#000000">
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="generateMeme()">ğŸ˜‚ ç”¢ç”Ÿæ¢—åœ–</button>
                </div>
                
                <!-- æµ·å ±é¢æ¿ -->
                <div class="poster-panel" id="posterPanel">
                    <div class="panel-title">ğŸ“° æµ·å ±è£½ä½œ</div>
                    <input type="text" id="posterTitle" class="wm-input" placeholder="æ¨™é¡Œ">
                    <input type="text" id="posterSubtitle" class="wm-input" placeholder="å‰¯æ¨™é¡Œ">
                    <input type="text" id="posterDate" class="wm-input" placeholder="æ—¥æœŸ">
                    <input type="text" id="posterLocation" class="wm-input" placeholder="åœ°é»">
                    <div class="poster-styles">
                        <button class="poster-style" onclick="createPoster('movie')">ğŸ¬ é›»å½±</button>
                        <button class="poster-style" onclick="createPoster('concert')">ğŸ¤ æ¼”å”±æœƒ</button>
                        <button class="poster-style" onclick="createPoster('sale')">ğŸ›’ ç‰¹è³£</button>
                        <button class="poster-style" onclick="createPoster('minimalist')">â¬œ æ¥µç°¡</button>
                        <button class="poster-style" onclick="createPoster('vintage')">ğŸ“· å¾©å¤</button>
                        <button class="poster-style" onclick="createPoster('neon')">ğŸ’¡ éœ“è™¹</button>
                    </div>
                </div>
                
                <!-- æ©«å¹…é¢æ¿ -->
                <div class="banner-panel" id="bannerPanel">
                    <div class="panel-title">ğŸ¯ æ©«å¹…è£½ä½œ</div>
                    <input type="text" id="bannerText" class="wm-input" placeholder="æ©«å¹…æ¨™é¡Œ">
                    <input type="text" id="bannerCTA" class="wm-input" placeholder="æŒ‰éˆ•æ–‡å­—ï¼ˆå¦‚ï¼šç«‹å³è³¼è²·ï¼‰">
                    <div class="banner-colors">
                        <div class="wm-option">
                            <label>èƒŒæ™¯è‰²</label>
                            <input type="color" id="bannerBgColor" value="#667eea">
                        </div>
                        <div class="wm-option">
                            <label>æ–‡å­—è‰²</label>
                            <input type="color" id="bannerTextColor" value="#ffffff">
                        </div>
                    </div>
                    <div class="banner-sizes" id="bannerSizeGrid"></div>
                </div>
                
                <!-- åœ–è¡¨é¢æ¿ -->
                <div class="chart-panel" id="chartPanel">
                    <div class="panel-title">ğŸ“Š åœ–è¡¨è£½ä½œ</div>
                    <input type="text" id="chartTitle" class="wm-input" placeholder="åœ–è¡¨æ¨™é¡Œ">
                    <textarea id="chartData" class="wm-input" placeholder="æ•¸æ“šï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼š30,50,40,60ï¼‰" rows="2"></textarea>
                    <textarea id="chartLabels" class="wm-input" placeholder="æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼Œå¦‚ï¼šA,B,C,Dï¼‰" rows="2"></textarea>
                    <div class="chart-types">
                        <button class="chart-type" onclick="createChart('bar')">ğŸ“Š é•·æ¢åœ–</button>
                        <button class="chart-type" onclick="createChart('line')">ğŸ“ˆ æŠ˜ç·šåœ–</button>
                        <button class="chart-type" onclick="createChart('pie')">ğŸ¥§ åœ“é¤…åœ–</button>
                        <button class="chart-type" onclick="createChart('donut')">ğŸ© ç”œç”œåœˆ</button>
                        <button class="chart-type" onclick="createChart('horizontal')">ğŸ“ æ©«æ¢åœ–</button>
                        <button class="chart-type" onclick="createChart('area')">ğŸ“‰ é¢ç©åœ–</button>
                    </div>
                </div>
                
                <!-- æµç¨‹åœ–é¢æ¿ -->
                <div class="diagram-panel" id="diagramPanel">
                    <div class="panel-title">ğŸ“ æµç¨‹åœ–</div>
                    <input type="text" id="diagramText" class="wm-input" placeholder="å½¢ç‹€æ–‡å­—">
                    <div class="wm-option">
                        <label>é¡è‰²</label>
                        <input type="color" id="diagramColor" value="#4ecdc4">
                    </div>
                    <div class="diagram-shapes">
                        <button class="diagram-shape" onclick="addDiagramShape('process')">â¬œ è™•ç†</button>
                        <button class="diagram-shape" onclick="addDiagramShape('decision')">â—‡ åˆ¤æ–·</button>
                        <button class="diagram-shape" onclick="addDiagramShape('start')">â­• é–‹å§‹/çµæŸ</button>
                        <button class="diagram-shape" onclick="addDiagramShape('io')">â–± è¼¸å…¥/è¼¸å‡º</button>
                        <button class="diagram-shape" onclick="addDiagramShape('connector')">â—‹ é€£æ¥</button>
                    </div>
                    <button class="wm-action-btn add" onclick="addDiagramArrow()">â¡ï¸ ç•«ç®­é ­é€£æ¥</button>
                </div>
                
                <!-- æ™‚é–“è»¸é¢æ¿ -->
                <div class="timeline-panel" id="timelinePanel">
                    <div class="panel-title">ğŸ“… æ™‚é–“è»¸</div>
                    <input type="text" id="timelineTitle" class="wm-input" placeholder="æ™‚é–“è»¸æ¨™é¡Œ">
                    <textarea id="timelineEvents" class="wm-input" placeholder="äº‹ä»¶ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰" rows="4"></textarea>
                    <textarea id="timelineDates" class="wm-input" placeholder="æ—¥æœŸï¼ˆæ¯è¡Œä¸€å€‹ï¼‰" rows="4"></textarea>
                    <div class="wm-option">
                        <label>ä¸»é¡Œè‰²</label>
                        <input type="color" id="timelineColor" value="#4ecdc4">
                    </div>
                    <button class="wm-action-btn add" onclick="createTimeline()">ğŸ“… å»ºç«‹æ™‚é–“è»¸</button>
                </div>
                
                <!-- è³‡è¨Šåœ–è¡¨é¢æ¿ -->
                <div class="infographic-panel" id="infographicPanel">
                    <div class="panel-title">ğŸ“Š è³‡è¨Šåœ–è¡¨</div>
                    <input type="text" id="infoTitle" class="wm-input" placeholder="æ¨™é¡Œ">
                    <textarea id="infoStats" class="wm-input" placeholder="é …ç›®ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰" rows="3"></textarea>
                    <textarea id="infoValues" class="wm-input" placeholder="æ•¸å€¼ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰" rows="3"></textarea>
                    <div class="infographic-types">
                        <button class="info-type" onclick="createInfographic('stats')">ğŸ“Š æ•¸æ“šçµ±è¨ˆ</button>
                        <button class="info-type" onclick="createInfographic('comparison')">âš–ï¸ æ¯”è¼ƒåœ–</button>
                        <button class="info-type" onclick="createInfographic('steps')">ğŸ”¢ æ­¥é©Ÿåœ–</button>
                        <button class="info-type" onclick="createInfographic('icons')">ğŸ¯ åœ–ç¤ºçµ±è¨ˆ</button>
                    </div>
                </div>
                
                <!-- åç‰‡é¢æ¿ -->
                <div class="businesscard-panel" id="businessCardPanel">
                    <div class="panel-title">ğŸªª åç‰‡è£½ä½œ</div>
                    <input type="text" id="cardName" class="wm-input" placeholder="å§“å">
                    <input type="text" id="cardTitle" class="wm-input" placeholder="è·ç¨±">
                    <input type="text" id="cardCompany" class="wm-input" placeholder="å…¬å¸åç¨±">
                    <input type="text" id="cardPhone" class="wm-input" placeholder="é›»è©±">
                    <input type="text" id="cardEmail" class="wm-input" placeholder="Email">
                    <input type="text" id="cardWebsite" class="wm-input" placeholder="ç¶²ç«™">
                    <div class="card-styles">
                        <button class="card-style" onclick="createBusinessCard('minimal')">â¬œ æ¥µç°¡</button>
                        <button class="card-style" onclick="createBusinessCard('dark')">â¬› æ·±è‰²</button>
                        <button class="card-style" onclick="createBusinessCard('gradient')">ğŸŒˆ æ¼¸å±¤</button>
                        <button class="card-style" onclick="createBusinessCard('creative')">ğŸ¨ å‰µæ„</button>
                    </div>
                </div>
                
                <!-- ç™¼ç¥¨é¢æ¿ -->
                <div class="invoice-panel" id="invoicePanel">
                    <div class="panel-title">ğŸ§¾ ç™¼ç¥¨/æ”¶æ“š</div>
                    <input type="text" id="invoiceCompany" class="wm-input" placeholder="å…¬å¸åç¨±">
                    <input type="text" id="invoiceNo" class="wm-input" placeholder="ç™¼ç¥¨ç·¨è™Ÿ">
                    <input type="text" id="invoiceDate" class="wm-input" placeholder="æ—¥æœŸ">
                    <textarea id="invoiceItems" class="wm-input" placeholder="é …ç›®ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰" rows="4"></textarea>
                    <textarea id="invoicePrices" class="wm-input" placeholder="é‡‘é¡ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰" rows="4"></textarea>
                    <button class="wm-action-btn add" onclick="createInvoice()">ğŸ§¾ å»ºç«‹ç™¼ç¥¨</button>
                </div>
                
                <!-- è­‰æ›¸é¢æ¿ -->
                <div class="certificate-panel" id="certificatePanel">
                    <div class="panel-title">ğŸ† è­‰æ›¸è£½ä½œ</div>
                    <input type="text" id="certRecipient" class="wm-input" placeholder="å—çäººå§“å">
                    <input type="text" id="certAchievement" class="wm-input" placeholder="ç²çé …ç›®">
                    <input type="text" id="certIssuer" class="wm-input" placeholder="é ’ç™¼å–®ä½">
                    <input type="text" id="certDate" class="wm-input" placeholder="æ—¥æœŸ">
                    <div class="cert-styles">
                        <button class="cert-style" onclick="createCertificate('classic')">ğŸ“œ ç¶“å…¸</button>
                        <button class="cert-style" onclick="createCertificate('modern')">ğŸ¨ ç¾ä»£</button>
                        <button class="cert-style" onclick="createCertificate('elegant')">âœ¨ å„ªé›…</button>
                    </div>
                </div>
                
                <!-- å¾½ç« é¢æ¿ -->
                <div class="badge-panel" id="badgePanel">
                    <div class="panel-title">ğŸ… å¾½ç« è£½ä½œ</div>
                    <input type="text" id="badgeText" class="wm-input" placeholder="ä¸»è¦æ–‡å­—">
                    <input type="text" id="badgeSubtext" class="wm-input" placeholder="å‰¯æ¨™æ–‡å­—">
                    <div class="badge-colors">
                        <div class="wm-option">
                            <label>é¡è‰² 1</label>
                            <input type="color" id="badgeColor1" value="#667eea">
                        </div>
                        <div class="wm-option">
                            <label>é¡è‰² 2</label>
                            <input type="color" id="badgeColor2" value="#764ba2">
                        </div>
                    </div>
                    <div class="badge-shapes">
                        <button class="badge-shape" onclick="createBadge('circle')">â­• åœ“å½¢</button>
                        <button class="badge-shape" onclick="createBadge('shield')">ğŸ›¡ï¸ ç›¾ç‰Œ</button>
                        <button class="badge-shape" onclick="createBadge('ribbon')">ğŸ€ ç·å¸¶</button>
                        <button class="badge-shape" onclick="createBadge('star')">â­ æ˜Ÿå½¢</button>
                        <button class="badge-shape" onclick="createBadge('hexagon')">â¬¡ å…­è§’</button>
                    </div>
                </div>
                
                <!-- å¤§é ­è²¼é¢æ¿ -->
                <div class="avatar-panel" id="avatarPanel">
                    <div class="panel-title">ğŸ­ å¤§é ­è²¼è£½ä½œ</div>
                    <div class="avatar-options">
                        <div class="wm-option">
                            <label>èƒŒæ™¯è‰²</label>
                            <input type="color" id="avatarBgColor" value="#667eea">
                        </div>
                        <div class="wm-option">
                            <label>é‚Šæ¡†å¯¬åº¦</label>
                            <input type="range" id="avatarBorder" min="0" max="20" value="5">
                        </div>
                        <div class="wm-option">
                            <label>é‚Šæ¡†è‰²</label>
                            <input type="color" id="avatarBorderColor" value="#ffffff">
                        </div>
                    </div>
                    <div class="avatar-shapes">
                        <button class="avatar-shape" onclick="createAvatar('circle')">â­• åœ“å½¢</button>
                        <button class="avatar-shape" onclick="createAvatar('rounded')">ğŸ”² åœ“è§’</button>
                        <button class="avatar-shape" onclick="createAvatar('hexagon')">â¬¡ å…­è§’</button>
                    </div>
                </div>
                
                <!-- ç¸®åœ–é¢æ¿ -->
                <div class="thumbnail-panel" id="thumbnailPanel">
                    <div class="panel-title">ğŸ–¼ï¸ ç¸®åœ–è£½ä½œ</div>
                    <input type="text" id="thumbTitle" class="wm-input" placeholder="æ¨™é¡Œ">
                    <input type="text" id="thumbSubtitle" class="wm-input" placeholder="å‰¯æ¨™é¡Œ">
                    <div class="thumbnail-platforms">
                        <button class="thumb-platform" onclick="createThumbnail('youtube')">â–¶ï¸ YouTube</button>
                        <button class="thumb-platform" onclick="createThumbnail('twitch')">ğŸŸ£ Twitch</button>
                        <button class="thumb-platform" onclick="createThumbnail('facebook')">ğŸ“˜ Facebook</button>
                        <button class="thumb-platform" onclick="createThumbnail('instagram')">ğŸ“¸ Instagram</button>
                    </div>
                </div>
                
                <!-- å°é¢é¢æ¿ -->
                <div class="cover-panel" id="coverPanel">
                    <div class="panel-title">ğŸ“š å°é¢è£½ä½œ</div>
                    <input type="text" id="coverTitle" class="wm-input" placeholder="æ¨™é¡Œ">
                    <input type="text" id="coverAuthor" class="wm-input" placeholder="ä½œè€…">
                    <div class="cover-types">
                        <button class="cover-type" onclick="createCover('book')">ğŸ“– æ›¸ç±</button>
                        <button class="cover-type" onclick="createCover('album')">ğŸ’¿ å°ˆè¼¯</button>
                        <button class="cover-type" onclick="createCover('magazine')">ğŸ“° é›œèªŒ</button>
                        <button class="cover-type" onclick="createCover('ebook')">ğŸ“± é›»å­æ›¸</button>
                    </div>
                </div>
                
                <!-- Mockup é¢æ¿ -->
                <div class="mockup-panel" id="mockupPanel">
                    <div class="panel-title">ğŸ“± ç”¢å“ Mockup</div>
                    <div class="mockup-devices">
                        <button class="mockup-device" onclick="createMockup('iphone')">ğŸ“± iPhone</button>
                        <button class="mockup-device" onclick="createMockup('macbook')">ğŸ’» MacBook</button>
                        <button class="mockup-device" onclick="createMockup('ipad')">ğŸ“± iPad</button>
                        <button class="mockup-device" onclick="createMockup('monitor')">ğŸ–¥ï¸ è¢å¹•</button>
                    </div>
                </div>
                
                <!-- è‰²å½©åˆ†æé¢æ¿ -->
                <div class="colorpalette-panel" id="colorPalettePanel">
                    <div class="panel-title">ğŸ¨ è‰²å½©åˆ†æ</div>
                    <div class="palette-display" id="colorPaletteDisplay" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:10px;"></div>
                    <button class="wm-action-btn add" onclick="analyzeColors()">ğŸ”„ é‡æ–°åˆ†æ</button>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">ğŸ’¡ é»æ“Šé¡è‰²è¤‡è£½è‰²ç¢¼</small>
                </div>
                
                <!-- AI å¢å¼·é¢æ¿ -->
                <div class="aienhance-panel" id="aiEnhancePanel">
                    <div class="panel-title">âœ¨ AI å¢å¼·</div>
                    <div class="ai-enhance-options">
                        <button class="ai-enhance-btn" onclick="aiEnhance('enhance')">âœ¨ è‡ªå‹•å¢å¼·</button>
                        <button class="ai-enhance-btn" onclick="aiEnhance('denoise')">ğŸ”‡ å»å™ªé»</button>
                        <button class="ai-enhance-btn" onclick="aiEnhance('sharpen')">ğŸ”ª éŠ³åŒ–</button>
                        <button class="ai-enhance-btn" onclick="aiEnhance('upscale')">ğŸ“ æ”¾å¤§ 2x</button>
                        <button class="ai-enhance-btn" onclick="aiEnhance('restore')">ğŸ”§ ä¿®å¾©è€ç…§ç‰‡</button>
                    </div>
                </div>
                
                <!-- AI é¢¨æ ¼é¢æ¿ -->
                <div class="aistyle-panel" id="aiStylePanel">
                    <div class="panel-title">ğŸ¨ AI é¢¨æ ¼è½‰æ›</div>
                    <div class="ai-styles">
                        <button class="ai-style-btn" onclick="aiStyleTransfer('anime')">ğŸŒ å‹•æ¼«</button>
                        <button class="ai-style-btn" onclick="aiStyleTransfer('watercolor')">ğŸ¨ æ°´å½©</button>
                        <button class="ai-style-btn" onclick="aiStyleTransfer('pencil')">âœï¸ ç´ æ</button>
                        <button class="ai-style-btn" onclick="aiStyleTransfer('impressionist')">ğŸ–¼ï¸ å°è±¡æ´¾</button>
                        <button class="ai-style-btn" onclick="aiStyleTransfer('pop_art')">ğŸª æ™®æ™®</button>
                        <button class="ai-style-btn" onclick="aiStyleTransfer('cyberpunk')">ğŸ¤– è³½åšé¾å…‹</button>
                    </div>
                </div>
                
                <!-- HSL é¢æ¿ -->
                <div class="hsl-panel" id="hslPanel">
                    <div class="panel-title">ğŸŒˆ HSL èª¿æ•´</div>
                    <div class="hsl-sliders">
                        <div class="adjust-item">
                            <label>è‰²ç›¸</label>
                            <input type="range" id="hslHue" min="-180" max="180" value="0">
                            <span id="hslHueVal">0Â°</span>
                        </div>
                        <div class="adjust-item">
                            <label>é£½å’Œåº¦</label>
                            <input type="range" id="hslSaturation" min="-100" max="100" value="0">
                            <span id="hslSatVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>æ˜åº¦</label>
                            <input type="range" id="hslLightness" min="-100" max="100" value="0">
                            <span id="hslLightVal">0</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyHsl()">ğŸŒˆ å¥—ç”¨ HSL</button>
                </div>
                
                <!-- è‰²éšé¢æ¿ -->
                <div class="levels-panel" id="levelsPanel">
                    <div class="panel-title">ğŸ“Š è‰²éšèª¿æ•´</div>
                    <div class="levels-sliders">
                        <div class="adjust-item">
                            <label>è¼¸å…¥é»‘é»</label>
                            <input type="range" id="levelsInputBlack" min="0" max="255" value="0">
                            <span>0</span>
                        </div>
                        <div class="adjust-item">
                            <label>è¼¸å…¥ç™½é»</label>
                            <input type="range" id="levelsInputWhite" min="0" max="255" value="255">
                            <span>255</span>
                        </div>
                        <div class="adjust-item">
                            <label>Gamma</label>
                            <input type="range" id="levelsGamma" min="0.1" max="3" step="0.1" value="1">
                            <span>1.0</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyLevels()">ğŸ“Š å¥—ç”¨è‰²éš</button>
                </div>
                
                <!-- ç›¸ç‰‡æ¿¾é¡é¢æ¿ -->
                <div class="photo-filter-panel" id="photoFilterPanel">
                    <div class="panel-title">ğŸ“· ç›¸ç‰‡æ¿¾é¡</div>
                    <div class="filter-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyPhotoFilter('warm')" style="background:linear-gradient(135deg,#ff9966,#ff5e62);">ğŸŒ… æš–è‰²</button>
                        <button class="wm-action-btn" onclick="applyPhotoFilter('cool')" style="background:linear-gradient(135deg,#667eea,#764ba2);">â„ï¸ å†·è‰²</button>
                        <button class="wm-action-btn" onclick="applyPhotoFilter('sunset')" style="background:linear-gradient(135deg,#f093fb,#f5576c);">ğŸŒ‡ æ—¥è½</button>
                        <button class="wm-action-btn" onclick="applyPhotoFilter('forest')" style="background:linear-gradient(135deg,#11998e,#38ef7d);">ğŸŒ² æ£®æ—</button>
                        <button class="wm-action-btn" onclick="applyPhotoFilter('ocean')" style="background:linear-gradient(135deg,#2193b0,#6dd5ed);">ğŸŒŠ æµ·æ´‹</button>
                        <button class="wm-action-btn" onclick="applyPhotoFilter('sepia')" style="background:linear-gradient(135deg,#c79081,#dfa579);">ğŸ“œ å¾©å¤è¤</button>
                    </div>
                </div>
                
                <!-- é¸æ“‡æ€§èª¿è‰²é¢æ¿ -->
                <div class="selective-color-panel" id="selectiveColorPanel">
                    <div class="panel-title">ğŸ¯ é¸æ“‡æ€§èª¿è‰²</div>
                    <div class="selective-options">
                        <div class="wm-option">
                            <label>ç›®æ¨™é¡è‰²</label>
                            <select id="selectiveTarget" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="red">ğŸ”´ ç´…è‰²</option>
                                <option value="orange">ğŸŸ  æ©™è‰²</option>
                                <option value="yellow">ğŸŸ¡ é»ƒè‰²</option>
                                <option value="green">ğŸŸ¢ ç¶ è‰²</option>
                                <option value="cyan">ğŸ”µ é’è‰²</option>
                                <option value="blue">ğŸ’™ è—è‰²</option>
                                <option value="purple">ğŸ’œ ç´«è‰²</option>
                            </select>
                        </div>
                        <div class="adjust-item">
                            <label>è‰²ç›¸åç§»</label>
                            <input type="range" id="selectiveHue" min="-30" max="30" value="0">
                            <span id="selectiveHueVal">0Â°</span>
                        </div>
                        <div class="adjust-item">
                            <label>é£½å’Œåº¦</label>
                            <input type="range" id="selectiveSat" min="-100" max="100" value="0">
                            <span id="selectiveSatVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>æ˜åº¦</label>
                            <input type="range" id="selectiveLight" min="-100" max="100" value="0">
                            <span id="selectiveLightVal">0</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applySelectiveColor()">ğŸ¯ å¥—ç”¨é¸æ“‡æ€§èª¿è‰²</button>
                </div>
                
                <!-- è‰²å½©å¹³è¡¡é¢æ¿ -->
                <div class="color-balance-panel" id="colorBalancePanel">
                    <div class="panel-title">âš–ï¸ è‰²å½©å¹³è¡¡</div>
                    <div class="balance-sliders">
                        <div class="adjust-item">
                            <label>é’è‰² â†” ç´…è‰²</label>
                            <input type="range" id="balanceCyanRed" min="-100" max="100" value="0">
                            <span id="balanceCRVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>æ´‹ç´… â†” ç¶ è‰²</label>
                            <input type="range" id="balanceMagentaGreen" min="-100" max="100" value="0">
                            <span id="balanceMGVal">0</span>
                        </div>
                        <div class="adjust-item">
                            <label>é»ƒè‰² â†” è—è‰²</label>
                            <input type="range" id="balanceYellowBlue" min="-100" max="100" value="0">
                            <span id="balanceYBVal">0</span>
                        </div>
                        <div class="wm-option" style="margin-top:10px;">
                            <label>èª¿æ•´ç¯„åœ</label>
                            <select id="balanceRange" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="shadows">æš—éƒ¨</option>
                                <option value="midtones" selected>ä¸­é–“èª¿</option>
                                <option value="highlights">äº®éƒ¨</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyColorBalance()">âš–ï¸ å¥—ç”¨è‰²å½©å¹³è¡¡</button>
                </div>
                
                <!-- ç›´æ–¹åœ–é¢æ¿ -->
                <div class="histogram-panel" id="histogramPanel">
                    <div class="panel-title">ğŸ“Š ç›´æ–¹åœ–</div>
                    <canvas id="histogramCanvas" width="280" height="150" style="width:100%;background:#1a1a2e;border-radius:8px;"></canvas>
                    <div style="display:flex;gap:5px;margin-top:10px;">
                        <button class="wm-action-btn" onclick="drawHistogram('all')" style="flex:1;font-size:11px;">å…¨éƒ¨</button>
                        <button class="wm-action-btn" onclick="drawHistogram('red')" style="flex:1;font-size:11px;background:#f44;">ç´…</button>
                        <button class="wm-action-btn" onclick="drawHistogram('green')" style="flex:1;font-size:11px;background:#4f4;">ç¶ </button>
                        <button class="wm-action-btn" onclick="drawHistogram('blue')" style="flex:1;font-size:11px;background:#44f;">è—</button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">ğŸ’¡ é¡¯ç¤ºåœ–ç‰‡çš„è‰²èª¿åˆ†ä½ˆ</small>
                </div>
                
                <!-- æ›²ç·šé¢æ¿ -->
                <div class="curve-panel" id="curvePanel">
                    <div class="panel-title">ğŸ“ˆ æ›²ç·šèª¿æ•´</div>
                    <canvas id="curveCanvas" width="200" height="200" style="width:100%;background:#1a1a2e;border-radius:8px;cursor:crosshair;"></canvas>
                    <div style="display:flex;gap:5px;margin-top:10px;">
                        <button class="wm-action-btn" onclick="setCurveChannel('rgb')" style="flex:1;font-size:11px;">RGB</button>
                        <button class="wm-action-btn" onclick="setCurveChannel('red')" style="flex:1;font-size:11px;background:#f44;">R</button>
                        <button class="wm-action-btn" onclick="setCurveChannel('green')" style="flex:1;font-size:11px;background:#4f4;">G</button>
                        <button class="wm-action-btn" onclick="setCurveChannel('blue')" style="flex:1;font-size:11px;background:#44f;">B</button>
                    </div>
                    <button class="wm-action-btn add" onclick="applyCurve()" style="margin-top:10px;">ğŸ“ˆ å¥—ç”¨æ›²ç·š</button>
                </div>
                
                <!-- æ¶²åŒ–é¢æ¿ -->
                <div class="liquify-panel" id="liquifyPanel">
                    <div class="panel-title">ğŸ’§ æ¶²åŒ–å·¥å…·</div>
                    <div class="liquify-tools" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="setLiquifyTool('push')">ğŸ‘† æ¨ç§»</button>
                        <button class="wm-action-btn" onclick="setLiquifyTool('bloat')">ğŸ”´ è†¨è„¹</button>
                        <button class="wm-action-btn" onclick="setLiquifyTool('pucker')">âš« æ”¶ç¸®</button>
                        <button class="wm-action-btn" onclick="setLiquifyTool('twirl')">ğŸŒ€ æ‰­è½‰</button>
                    </div>
                    <div class="adjust-item" style="margin-top:10px;">
                        <label>ç­†åˆ·å¤§å°</label>
                        <input type="range" id="liquifySize" min="10" max="100" value="30">
                        <span id="liquifySizeVal">30</span>
                    </div>
                    <div class="adjust-item">
                        <label>å¼·åº¦</label>
                        <input type="range" id="liquifyStrength" min="1" max="100" value="50">
                        <span id="liquifyStrengthVal">50</span>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">ğŸ’¡ åœ¨ç•«å¸ƒä¸Šæ‹–æ›³é€²è¡Œæ¶²åŒ–</small>
                </div>
                
                <!-- åœ–å±¤é¢æ¿ -->
                <div class="layer-panel" id="layerPanel">
                    <div class="panel-title">ğŸ“š åœ–å±¤</div>
                    <div id="layerList" style="max-height:200px;overflow-y:auto;"></div>
                    <div style="display:flex;gap:8px;margin-top:10px;">
                        <button class="wm-action-btn" onclick="addLayer()" style="flex:1;">â• æ–°å¢</button>
                        <button class="wm-action-btn" onclick="duplicateLayer()" style="flex:1;">ğŸ“‹ è¤‡è£½</button>
                        <button class="wm-action-btn" onclick="deleteLayer()" style="flex:1;">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                    <div class="adjust-item" style="margin-top:10px;">
                        <label>ä¸é€æ˜åº¦</label>
                        <input type="range" id="layerOpacity" min="0" max="100" value="100">
                        <span id="layerOpacityVal">100%</span>
                    </div>
                </div>
                
                <!-- è‰²ç‰ˆé¢æ¿ -->
                <div class="channel-panel" id="channelPanel">
                    <div class="panel-title">ğŸ“º è‰²ç‰ˆ</div>
                    <div class="channel-list" style="display:flex;flex-direction:column;gap:8px;">
                        <button class="wm-action-btn" onclick="showChannel('rgb')">ğŸ¨ RGB å…¨å½©</button>
                        <button class="wm-action-btn" onclick="showChannel('red')" style="background:#c44;">ğŸ”´ ç´…è‰²è‰²ç‰ˆ</button>
                        <button class="wm-action-btn" onclick="showChannel('green')" style="background:#4c4;">ğŸŸ¢ ç¶ è‰²è‰²ç‰ˆ</button>
                        <button class="wm-action-btn" onclick="showChannel('blue')" style="background:#44c;">ğŸ”µ è—è‰²è‰²ç‰ˆ</button>
                        <button class="wm-action-btn" onclick="showChannel('alpha')" style="background:#888;">â¬œ Alpha è‰²ç‰ˆ</button>
                    </div>
                </div>
                
                <!-- å°é½Šé¢æ¿ -->
                <div class="align-panel" id="alignPanel">
                    <div class="panel-title">ğŸ“ å°é½Šå·¥å…·</div>
                    <div class="align-grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="alignSelection('left')">â¬…ï¸</button>
                        <button class="wm-action-btn" onclick="alignSelection('centerH')">â†”ï¸</button>
                        <button class="wm-action-btn" onclick="alignSelection('right')">â¡ï¸</button>
                        <button class="wm-action-btn" onclick="alignSelection('top')">â¬†ï¸</button>
                        <button class="wm-action-btn" onclick="alignSelection('centerV')">â†•ï¸</button>
                        <button class="wm-action-btn" onclick="alignSelection('bottom')">â¬‡ï¸</button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">ğŸ’¡ å…ˆé¸å–å€åŸŸå†å°é½Š</small>
                </div>
                
                <!-- åƒè€ƒç·šé¢æ¿ -->
                <div class="guide-panel" id="guidePanel">
                    <div class="panel-title">ğŸ“ åƒè€ƒç·š</div>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <button class="wm-action-btn" onclick="addGuide('horizontal')">â– æ–°å¢æ°´å¹³ç·š</button>
                        <button class="wm-action-btn" onclick="addGuide('vertical')">| æ–°å¢å‚ç›´ç·š</button>
                        <button class="wm-action-btn" onclick="addGuide('center')">â• ä¸­å¿ƒåå­—ç·š</button>
                        <button class="wm-action-btn" onclick="addGuide('thirds')">ğŸ”² ä¸‰åˆ†æ³•æ ¼ç·š</button>
                        <button class="wm-action-btn" onclick="clearGuides()" style="background:#f44;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
                    </div>
                </div>
                
                <!-- é»é™£åœ–é¢æ¿ -->
                <div class="dot-art-panel" id="dotArtPanel">
                    <div class="panel-title">âš« é»é™£åœ–æ•ˆæœ</div>
                    <div class="dot-options">
                        <div class="adjust-item">
                            <label>é»å¤§å°</label>
                            <input type="range" id="dotSize" min="2" max="20" value="5">
                            <span id="dotSizeVal">5</span>
                        </div>
                        <div class="adjust-item">
                            <label>é»é–“è·</label>
                            <input type="range" id="dotSpacing" min="3" max="30" value="8">
                            <span id="dotSpacingVal">8</span>
                        </div>
                        <div class="wm-option">
                            <label>é»æ¨£å¼</label>
                            <select id="dotStyle" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="circle">âš« åœ“å½¢</option>
                                <option value="square">â¬› æ–¹å½¢</option>
                                <option value="diamond">ğŸ”· è±å½¢</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyDotArt()">âš« å¥—ç”¨é»é™£æ•ˆæœ</button>
                </div>
                
                <!-- å±€éƒ¨å½©è‰²é¢æ¿ -->
                <div class="color-splash-panel" id="colorSplashPanel">
                    <div class="panel-title">ğŸ’¦ å±€éƒ¨å½©è‰²</div>
                    <div class="splash-options">
                        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;">ä¿ç•™é¸å–çš„é¡è‰²ï¼Œå…¶é¤˜è½‰ç‚ºé»‘ç™½</p>
                        <div class="wm-option">
                            <label>ä¿ç•™é¡è‰²</label>
                            <input type="color" id="splashColor" value="#ff0000" style="width:100%;height:40px;border:none;cursor:pointer;">
                        </div>
                        <div class="adjust-item">
                            <label>å®¹å·®</label>
                            <input type="range" id="splashTolerance" min="10" max="100" value="30">
                            <span id="splashToleranceVal">30</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyColorSplash()">ğŸ’¦ å¥—ç”¨å±€éƒ¨å½©è‰²</button>
                </div>
                
                <!-- ç˜¦è‡‰é¢æ¿ -->
                <div class="slim-face-panel" id="slimFacePanel">
                    <div class="panel-title">ğŸ§‘ ç˜¦è‡‰å·¥å…·</div>
                    <div class="face-options">
                        <div class="adjust-item">
                            <label>ç˜¦è‡‰ç¨‹åº¦</label>
                            <input type="range" id="slimAmount" min="0" max="100" value="30">
                            <span id="slimAmountVal">30%</span>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">ğŸ’¡ æ­¤åŠŸèƒ½éœ€è¦ AI æ¨¡å‹æ”¯æ´ï¼Œç›®å‰æä¾›æ¨¡æ“¬æ•ˆæœ</small>
                    </div>
                    <button class="wm-action-btn add" onclick="applySlimFace()">ğŸ§‘ å¥—ç”¨ç˜¦è‡‰</button>
                </div>
                
                <!-- å¤§çœ¼é¢æ¿ -->
                <div class="big-eye-panel" id="bigEyePanel">
                    <div class="panel-title">ğŸ‘€ å¤§çœ¼å·¥å…·</div>
                    <div class="eye-options">
                        <div class="adjust-item">
                            <label>æ”¾å¤§ç¨‹åº¦</label>
                            <input type="range" id="eyeEnlarge" min="0" max="100" value="20">
                            <span id="eyeEnlargeVal">20%</span>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">ğŸ’¡ æ­¤åŠŸèƒ½éœ€è¦ AI æ¨¡å‹æ”¯æ´ï¼Œç›®å‰æä¾›æ¨¡æ“¬æ•ˆæœ</small>
                    </div>
                    <button class="wm-action-btn add" onclick="applyBigEye()">ğŸ‘€ å¥—ç”¨å¤§çœ¼</button>
                </div>
                
                <!-- å½©å¦é¢æ¿ -->
                <div class="makeup-panel" id="makeupPanel">
                    <div class="panel-title">ğŸ’„ å½©å¦å·¥å…·</div>
                    <div class="makeup-options" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyMakeup('lipstick')">ğŸ’‹ å£ç´…</button>
                        <button class="wm-action-btn" onclick="applyMakeup('blush')">ğŸŒ¸ è…®ç´…</button>
                        <button class="wm-action-btn" onclick="applyMakeup('eyeshadow')">ğŸ‘ï¸ çœ¼å½±</button>
                        <button class="wm-action-btn" onclick="applyMakeup('eyeliner')">âœï¸ çœ¼ç·š</button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">ğŸ’¡ æ­¤åŠŸèƒ½éœ€è¦ AI äººè‡‰æª¢æ¸¬</small>
                </div>
                
                <!-- æ›è‡‰é¢æ¿ -->
                <div class="face-swap-panel" id="faceSwapPanel">
                    <div class="panel-title">ğŸ­ æ›è‡‰å·¥å…·</div>
                    <div class="swap-options">
                        <input type="file" id="faceSwapInput" accept="image/*" style="margin-bottom:10px;">
                        <small style="color:var(--text-secondary);font-size:10px;display:block;">é¸æ“‡è¦æ›¿æ›çš„è‡‰éƒ¨åœ–ç‰‡</small>
                    </div>
                    <button class="wm-action-btn add" onclick="applyFaceSwap()">ğŸ­ é–‹å§‹æ›è‡‰</button>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">âš ï¸ æ­¤åŠŸèƒ½éœ€è¦é€²éš AI æ¨¡å‹</small>
                </div>
                
                <!-- éª¨æ¶é¢æ¿ -->
                <div class="skeleton-panel" id="skeletonPanel">
                    <div class="panel-title">ğŸ¦´ éª¨æ¶æª¢æ¸¬</div>
                    <div class="skeleton-options">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="showSkeleton" style="width:18px;height:18px;">
                            <span>é¡¯ç¤ºéª¨æ¶ç·šæ¢</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-top:8px;">
                            <input type="checkbox" id="showKeypoints" checked style="width:18px;height:18px;">
                            <span>é¡¯ç¤ºé—œç¯€é»</span>
                        </label>
                    </div>
                    <button class="wm-action-btn add" onclick="detectSkeleton()">ğŸ¦´ æª¢æ¸¬éª¨æ¶</button>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">ğŸ’¡ éœ€è¦ AI å§¿æ…‹æª¢æ¸¬æ¨¡å‹</small>
                </div>
                
                <!-- é¡é ­æ¨¡ç³Šé¢æ¿ -->
                <div class="lens-blur-panel" id="lensBlurPanel">
                    <div class="panel-title">ğŸ“· é¡é ­æ¨¡ç³Š</div>
                    <div class="blur-options">
                        <div class="adjust-item">
                            <label>æ¨¡ç³ŠåŠå¾‘</label>
                            <input type="range" id="lensBlurRadius" min="1" max="50" value="10">
                            <span id="lensBlurRadiusVal">10</span>
                        </div>
                        <div class="adjust-item">
                            <label>æ•£æ™¯å½¢ç‹€</label>
                            <select id="bokehShape" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="circle">âšª åœ“å½¢</option>
                                <option value="hexagon">â¬¡ å…­é‚Šå½¢</option>
                                <option value="octagon">â¯ƒ å…«é‚Šå½¢</option>
                            </select>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyLensBlur()">ğŸ“· å¥—ç”¨é¡é ­æ¨¡ç³Š</button>
                </div>
                
                <!-- å‹•æ…‹æ¨¡ç³Šé¢æ¿ -->
                <div class="motion-blur-panel" id="motionBlurPanel">
                    <div class="panel-title">ğŸ’¨ å‹•æ…‹æ¨¡ç³Š</div>
                    <div class="motion-options">
                        <div class="adjust-item">
                            <label>æ¨¡ç³Šè·é›¢</label>
                            <input type="range" id="motionDistance" min="5" max="100" value="20">
                            <span id="motionDistanceVal">20</span>
                        </div>
                        <div class="adjust-item">
                            <label>è§’åº¦</label>
                            <input type="range" id="motionAngle" min="0" max="360" value="0">
                            <span id="motionAngleVal">0Â°</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyMotionBlur()">ğŸ’¨ å¥—ç”¨å‹•æ…‹æ¨¡ç³Š</button>
                </div>
                
                <!-- è®Šå½¢é¢æ¿ -->
                <div class="warp-panel" id="warpPanel">
                    <div class="panel-title">ğŸ”„ è®Šå½¢å·¥å…·</div>
                    <div class="warp-options" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyWarp('arc')">ğŸŒ™ å¼§å½¢</button>
                        <button class="wm-action-btn" onclick="applyWarp('bulge')">ğŸ”´ å‡¸èµ·</button>
                        <button class="wm-action-btn" onclick="applyWarp('pinch')">âš« æ“ å£“</button>
                        <button class="wm-action-btn" onclick="applyWarp('twist')">ğŸŒ€ æ‰­è½‰</button>
                        <button class="wm-action-btn" onclick="applyWarp('wave')">ã€°ï¸ æ³¢æµª</button>
                        <button class="wm-action-btn" onclick="applyWarp('fisheye')">ğŸŸ é­šçœ¼</button>
                    </div>
                </div>
                
                <!-- é€è¦–é¢æ¿ -->
                <div class="perspective-panel" id="perspectivePanel">
                    <div class="panel-title">ğŸ”² é€è¦–è®Šæ›</div>
                    <div class="perspective-options">
                        <div class="adjust-item">
                            <label>æ°´å¹³å‚¾æ–œ</label>
                            <input type="range" id="perspectiveH" min="-45" max="45" value="0">
                            <span id="perspectiveHVal">0Â°</span>
                        </div>
                        <div class="adjust-item">
                            <label>å‚ç›´å‚¾æ–œ</label>
                            <input type="range" id="perspectiveV" min="-45" max="45" value="0">
                            <span id="perspectiveVVal">0Â°</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyPerspective()">ğŸ”² å¥—ç”¨é€è¦–</button>
                </div>
                
                <!-- æ‰­æ›²é¢æ¿ -->
                <div class="distort-panel" id="distortPanel">
                    <div class="panel-title">ğŸŒŠ æ‰­æ›²æ•ˆæœ</div>
                    <div class="distort-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyDistort('spherize')">ğŸ”® çƒé¢åŒ–</button>
                        <button class="wm-action-btn" onclick="applyDistort('ripple')">ğŸŒŠ æ¼£æ¼ª</button>
                        <button class="wm-action-btn" onclick="applyDistort('zigzag')">âš¡ é‹¸é½’</button>
                        <button class="wm-action-btn" onclick="applyDistort('polar')">ğŸ¯ æ¥µåº§æ¨™</button>
                    </div>
                </div>
                
                <!-- å¡ç‰‡é¢æ¿ -->
                <div class="card-panel" id="cardPanel">
                    <div class="panel-title">ğŸ´ å¡ç‰‡æ¨¡æ¿</div>
                    <div class="card-templates" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="createCard('birthday')">ğŸ‚ ç”Ÿæ—¥å¡</button>
                        <button class="wm-action-btn" onclick="createCard('christmas')">ğŸ„ è–èª•å¡</button>
                        <button class="wm-action-btn" onclick="createCard('wedding')">ğŸ’’ å©šç¦®å¡</button>
                        <button class="wm-action-btn" onclick="createCard('thanks')">ğŸ™ æ„Ÿè¬å¡</button>
                        <button class="wm-action-btn" onclick="createCard('invite')">ğŸ’Œ é‚€è«‹å‡½</button>
                        <button class="wm-action-btn" onclick="createCard('greeting')">ğŸ‘‹ å•å€™å¡</button>
                    </div>
                </div>
                
                <!-- Logo é¢æ¿ -->
                <div class="logo-panel" id="logoPanel">
                    <div class="panel-title">ğŸ¢ Logo æ–‡å­—</div>
                    <div class="logo-options">
                        <input type="text" id="logoText" placeholder="è¼¸å…¥ Logo æ–‡å­—..." value="LOGO" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);margin-bottom:10px;background:var(--bg-input);color:var(--text-primary);font-size:16px;">
                        <div class="wm-option">
                            <label>å­—é«”æ¨£å¼</label>
                            <select id="logoFont" style="padding:8px;border-radius:4px;width:100%;background:var(--bg-input);color:var(--text-primary);">
                                <option value="bold">ç²—é«”</option>
                                <option value="elegant">å„ªé›…</option>
                                <option value="tech">ç§‘æŠ€</option>
                                <option value="handwrite">æ‰‹å¯«</option>
                            </select>
                        </div>
                        <div style="margin-top:10px;">
                            <label style="font-size:12px;color:var(--text-secondary);">æ¼¸å±¤é¡è‰²</label>
                            <div style="display:flex;gap:10px;margin-top:5px;">
                                <input type="color" id="logoColor1" value="#667eea" style="flex:1;height:40px;border:none;cursor:pointer;border-radius:4px;">
                                <input type="color" id="logoColor2" value="#764ba2" style="flex:1;height:40px;border:none;cursor:pointer;border-radius:4px;">
                            </div>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="createLogo()" style="margin-top:10px;">ğŸ¢ æ·»åŠ  Logo åˆ°åœ–ç‰‡</button>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">ğŸ’¡ Logo æœƒæ·»åŠ åˆ°åœ–ç‰‡ä¸­å¤®ï¼Œå¯ç”¨ Ctrl+Z å¾©åŸ</small>
                </div>
                
                <!-- åˆ—å°é¢æ¿ -->
                <div class="print-panel" id="printPanel">
                    <div class="panel-title">ğŸ–¨ï¸ åˆ—å°è¨­å®š</div>
                    <div class="print-preview" style="background:#fff;padding:10px;border-radius:8px;margin-bottom:10px;text-align:center;">
                        <img id="printPreviewImg" style="max-width:100%;max-height:150px;border:1px solid #ddd;">
                    </div>
                    <div class="print-options">
                        <div class="wm-option">
                            <label>ç´™å¼µå¤§å°</label>
                            <select id="printSize" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="a4">A4 (210Ã—297mm)</option>
                                <option value="a3">A3 (297Ã—420mm)</option>
                                <option value="letter">Letter (8.5Ã—11")</option>
                                <option value="photo4x6">4Ã—6 ç›¸ç‰‡</option>
                                <option value="photo5x7">5Ã—7 ç›¸ç‰‡</option>
                            </select>
                        </div>
                        <div class="wm-option">
                            <label>åˆ—å°å“è³ª</label>
                            <select id="printQuality" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="high">é«˜å“è³ª</option>
                                <option value="normal" selected>æ¨™æº–</option>
                                <option value="draft">è‰ç¨¿</option>
                            </select>
                        </div>
                        <div class="wm-option" style="display:flex;align-items:center;gap:10px;">
                            <input type="checkbox" id="printFitPage" checked style="width:18px;height:18px;">
                            <label for="printFitPage">è‡ªå‹•ç¸®æ”¾è‡³ç´™å¼µå¤§å°</label>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="printImage()">ğŸ–¨ï¸ é–‹å•Ÿåˆ—å°å°è©±æ¡†</button>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:8px;">ğŸ’¡ æœƒé–‹å•Ÿç³»çµ±åˆ—å°è¦–çª—ï¼Œå¯é¸æ“‡å°è¡¨æ©Ÿ</small>
                </div>
                
                <!-- åˆ†äº«é¢æ¿ -->
                <div class="share-panel" id="sharePanel">
                    <div class="panel-title">ğŸ“¤ åˆ†äº«åœ–ç‰‡</div>
                    <div class="share-buttons" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <button class="wm-action-btn" onclick="shareNative()" style="background:linear-gradient(135deg,#667eea,#764ba2);">
                            ğŸ“± ç³»çµ±åˆ†äº«
                        </button>
                        <button class="wm-action-btn" onclick="shareToEmail()" style="background:linear-gradient(135deg,#f093fb,#f5576c);">
                            ğŸ“§ Email
                        </button>
                        <button class="wm-action-btn" onclick="copyToClipboard()" style="background:linear-gradient(135deg,#4facfe,#00f2fe);">
                            ğŸ“‹ è¤‡è£½åœ–ç‰‡
                        </button>
                        <button class="wm-action-btn" onclick="sendToLine()" style="background:#06c755;">
                            ğŸ’¬ LINE
                        </button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">ğŸ’¡ ç³»çµ±åˆ†äº«æ”¯æ´æ‰€æœ‰å·²å®‰è£çš„æ‡‰ç”¨ç¨‹å¼</small>
                </div>
                
                <!-- é›²ç«¯é¢æ¿ -->
                <div class="cloud-panel" id="cloudPanel">
                    <div class="panel-title">â˜ï¸ é›²ç«¯åœ–åºŠ</div>
                    <div class="cloud-api-setting" style="margin-bottom:15px;padding:10px;background:rgba(99,102,241,0.1);border-radius:8px;">
                        <label style="font-size:12px;display:block;margin-bottom:5px;">ğŸ”‘ ImgBB API Key</label>
                        <div style="display:flex;gap:5px;">
                            <input type="password" id="imgbbApiKey" placeholder="è¼¸å…¥ API Key..." style="flex:1;padding:8px;border-radius:4px;border:1px solid var(--border);background:var(--bg-input);">
                            <button onclick="togglePassword('imgbbApiKey', this)" style="padding:8px;border-radius:4px;border:none;background:var(--bg-input);cursor:pointer;">ğŸ‘ï¸</button>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:5px;">
                            å¾ <a href="https://api.imgbb.com/" target="_blank" style="color:var(--primary);">api.imgbb.com</a> å…è²»å–å¾—
                        </small>
                    </div>
                    <div class="cloud-buttons" style="display:flex;flex-direction:column;gap:10px;">
                        <button class="wm-action-btn" onclick="uploadToImgBB()" style="background:linear-gradient(135deg,#3498db,#2980b9);">
                            ğŸŒ ä¸Šå‚³è‡³ ImgBB
                        </button>
                        <button class="wm-action-btn" onclick="saveToLocalStorage()" style="background:linear-gradient(135deg,#667eea,#764ba2);">
                            ğŸ’¾ å­˜åˆ°ç€è¦½å™¨ï¼ˆé›¢ç·šï¼‰
                        </button>
                        <button class="wm-action-btn" onclick="loadFromLocalStorage()" style="background:linear-gradient(135deg,#f093fb,#f5576c);">
                            ğŸ“‚ å¾ç€è¦½å™¨è¼‰å…¥
                        </button>
                    </div>
                    <div id="cloudResult" style="margin-top:10px;padding:10px;background:var(--bg-input);border-radius:8px;display:none;">
                        <small>ä¸Šå‚³çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡</small>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">ğŸ’¡ ImgBB æä¾›å…è²»æ°¸ä¹…åœ–åºŠï¼Œä¸Šå‚³å¾Œå¯å–å¾—åˆ†äº«é€£çµ</small>
                </div>
                
                <!-- å¿«æ·éµé¢æ¿ -->
                <div class="shortcut-panel" id="shortcutPanel">
                    <div class="panel-title">âŒ¨ï¸ å¿«æ·éµä¸€è¦½</div>
                    <div class="shortcut-list" style="font-size:12px;line-height:2;">
                        <div><kbd>Ctrl+Z</kbd> å¾©åŸ</div>
                        <div><kbd>Ctrl+S</kbd> å„²å­˜</div>
                        <div><kbd>Ctrl+C</kbd> è¤‡è£½</div>
                        <div><kbd>Ctrl+V</kbd> è²¼ä¸Š</div>
                        <div><kbd>ESC</kbd> å–æ¶ˆå·¥å…·</div>
                        <div><kbd>Delete</kbd> æ¸…é™¤é¸å–</div>
                        <div><kbd>+/-</kbd> ç¸®æ”¾</div>
                        <div><kbd>0</kbd> é‡ç½®ç¸®æ”¾</div>
                        <div><kbd>R</kbd> æ—‹è½‰ 90Â°</div>
                        <div><kbd>H</kbd> æ°´å¹³ç¿»è½‰</div>
                        <div><kbd>V</kbd> å‚ç›´ç¿»è½‰</div>
                    </div>
                </div>
                
                <!-- èªªæ˜é¢æ¿ -->
                <div class="help-panel" id="helpPanel">
                    <div class="panel-title">â“ ä½¿ç”¨èªªæ˜</div>
                    <div style="font-size:12px;line-height:1.8;">
                        <p><strong>ğŸ“· è¼‰å…¥åœ–ç‰‡</strong><br>é»æ“Šä¸Šå‚³æˆ–æ‹–æ”¾åœ–ç‰‡åˆ°ç•«å¸ƒ</p>
                        <p><strong>âœ‚ï¸ é¸å–å·¥å…·</strong><br>æ¡†é¸å€åŸŸå¾Œå¯è£åˆ‡ã€æ¨¡ç³Šã€è¤‡è£½</p>
                        <p><strong>ğŸ”² é¦¬è³½å…‹</strong><br>åœ¨ç•«å¸ƒä¸Šå¡—æŠ¹æ‰“ç¢¼</p>
                        <p><strong>ğŸ’¦ æµ®æ°´å°</strong><br>æ·»åŠ æ–‡å­—æˆ–åœ–ç‰‡æµ®æ°´å°</p>
                        <p><strong>ğŸ”– åœ–ç« </strong><br>æ·»åŠ æ—¥æœŸã€æ ¸å‡†ç­‰å°ç« </p>
                        <p><strong>ğŸ“± QRç¢¼</strong><br>ç”Ÿæˆä¸¦æ”¾ç½® QR Code</p>
                        <p><strong>ğŸ¨ æ¿¾é¡</strong><br>å¥—ç”¨å„ç¨®ç›¸ç‰‡æ¿¾é¡</p>
                        <p><strong>ğŸ’¾ å„²å­˜</strong><br>ä¸‹è¼‰ç‚º PNG/JPG/PDF</p>
                    </div>
                </div>
                
                <!-- èª¿è‰²é¢æ¿ -->
                <div class="color-grade-panel" id="colorGradePanel">
                    <div class="panel-title">ğŸ¬ é›»å½±èª¿è‰²</div>
                    <div class="preset-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyColorGrade('teal-orange')" style="background:linear-gradient(135deg,#008080,#ff6600);">ğŸŒŠ é’æ©™</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('noir')" style="background:linear-gradient(135deg,#1a1a1a,#4a4a4a);">ğŸ¬ é»‘è‰²é›»å½±</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('matrix')" style="background:linear-gradient(135deg,#003300,#00ff00);">ğŸ’š é§­å®¢ä»»å‹™</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('sepia-cinema')" style="background:linear-gradient(135deg,#704214,#c4a35a);">ğŸ“œ å¾©å¤è¤</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('blade-runner')" style="background:linear-gradient(135deg,#ff6b00,#0066ff);">ğŸŒƒ éŠ€ç¿¼æ®ºæ‰‹</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('horror')" style="background:linear-gradient(135deg,#8b0000,#2d0000);">ğŸ‘» ææ€–ç‰‡</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('romance')" style="background:linear-gradient(135deg,#ffb6c1,#ff69b4);">ğŸ’• æµªæ¼«</button>
                        <button class="wm-action-btn" onclick="applyColorGrade('action')" style="background:linear-gradient(135deg,#ff4500,#1e90ff);">ğŸ’¥ å‹•ä½œç‰‡</button>
                    </div>
                </div>
                
                <!-- LUT é¢æ¿ -->
                <div class="lut-panel" id="lutPanel">
                    <div class="panel-title">ğŸ¥ LUT æ¿¾é¡</div>
                    <div class="preset-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyLut('fuji')" style="background:linear-gradient(135deg,#2e8b57,#98fb98);">ğŸï¸ Fuji å¯Œå£«</button>
                        <button class="wm-action-btn" onclick="applyLut('kodak')" style="background:linear-gradient(135deg,#daa520,#ffd700);">ğŸï¸ Kodak æŸ¯é”</button>
                        <button class="wm-action-btn" onclick="applyLut('cinematic')" style="background:linear-gradient(135deg,#483d8b,#7b68ee);">ğŸ¬ é›»å½±æ„Ÿ</button>
                        <button class="wm-action-btn" onclick="applyLut('portrait')" style="background:linear-gradient(135deg,#deb887,#f5deb3);">ğŸ‘¤ äººåƒ</button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">ğŸ’¡ LUT æ˜¯å°ˆæ¥­èª¿è‰²é è¨­ï¼Œå¯å¿«é€Ÿå¥—ç”¨é›»å½±è³ªæ„Ÿ</small>
                </div>
                
                <!-- å¾©å¤é¢æ¿ -->
                <div class="vintage-panel" id="vintagePanel">
                    <div class="panel-title">ğŸ“» å¾©å¤æ•ˆæœ</div>
                    <div class="preset-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyVintagePreset('60s')" style="background:linear-gradient(135deg,#cd853f,#f4a460);">ğŸ“º 60å¹´ä»£</button>
                        <button class="wm-action-btn" onclick="applyVintagePreset('70s')" style="background:linear-gradient(135deg,#d2691e,#ff8c00);">ğŸ•º 70å¹´ä»£</button>
                        <button class="wm-action-btn" onclick="applyVintagePreset('80s')" style="background:linear-gradient(135deg,#ff1493,#00ffff);">ğŸ¸ 80å¹´ä»£</button>
                        <button class="wm-action-btn" onclick="applyVintagePreset('90s')" style="background:linear-gradient(135deg,#808080,#c0c0c0);">ğŸ’¾ 90å¹´ä»£</button>
                        <button class="wm-action-btn" onclick="applyVintagePreset('polaroid')" style="background:linear-gradient(135deg,#f5f5dc,#fffacd);">ğŸ“¸ æ‹ç«‹å¾—</button>
                        <button class="wm-action-btn" onclick="applyVintagePreset('daguerreotype')" style="background:linear-gradient(135deg,#696969,#a9a9a9);">ğŸ–¼ï¸ éŠ€ç‰ˆæ”å½±</button>
                    </div>
                </div>
                
                <!-- åº•ç‰‡é¢æ¿ -->
                <div class="film-panel" id="filmPanel">
                    <div class="panel-title">ğŸï¸ åº•ç‰‡æ¨¡æ“¬</div>
                    <div class="preset-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                        <button class="wm-action-btn" onclick="applyFilmEffect('portra400')" style="background:linear-gradient(135deg,#deb887,#f5deb3);">ğŸ“· Portra 400</button>
                        <button class="wm-action-btn" onclick="applyFilmEffect('ektar100')" style="background:linear-gradient(135deg,#ff6347,#ffa07a);">ğŸ“· Ektar 100</button>
                        <button class="wm-action-btn" onclick="applyFilmEffect('velvia50')" style="background:linear-gradient(135deg,#228b22,#32cd32);">ğŸ“· Velvia 50</button>
                        <button class="wm-action-btn" onclick="applyFilmEffect('provia100')" style="background:linear-gradient(135deg,#4682b4,#87ceeb);">ğŸ“· Provia 100</button>
                        <button class="wm-action-btn" onclick="applyFilmEffect('cinestill800')" style="background:linear-gradient(135deg,#ff4500,#ffd700);">ğŸ“· CineStill 800</button>
                        <button class="wm-action-btn" onclick="applyFilmEffect('trix400')" style="background:linear-gradient(135deg,#2f2f2f,#5f5f5f);">ğŸ“· Tri-X 400</button>
                    </div>
                </div>
                
                <!-- é›»å½±æ•ˆæœé¢æ¿ -->
                <div class="cinema-panel" id="cinemaPanel">
                    <div class="panel-title">ğŸ¬ é›»å½±æ•ˆæœ</div>
                    <div class="cinema-options" style="display:flex;flex-direction:column;gap:10px;">
                        <div class="wm-option">
                            <label>ç•«é¢æ¯”ä¾‹</label>
                            <select id="cinemaRatio" style="padding:8px;border-radius:4px;width:100%;">
                                <option value="2.35">2.35:1 å¯¬éŠ€å¹•</option>
                                <option value="2.39">2.39:1 è®Šå½¢å¯¬éŠ€å¹•</option>
                                <option value="1.85">1.85:1 æ¨™æº–å¯¬éŠ€å¹•</option>
                                <option value="1.33">4:3 ç¶“å…¸</option>
                            </select>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:8px;">
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                <input type="checkbox" id="cinemaLetterbox" checked style="width:18px;height:18px;">
                                <span>ğŸ¬ é›»å½±é»‘é‚Š (Letterbox)</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                <input type="checkbox" id="cinemaGrain" style="width:18px;height:18px;">
                                <span>ğŸï¸ åº•ç‰‡é¡†ç²’</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                <input type="checkbox" id="cinemaVignette" style="width:18px;height:18px;">
                                <span>ğŸ”² æš—è§’æ•ˆæœ</span>
                            </label>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applyCinemaEffect()" style="margin-top:10px;">ğŸ¬ å¥—ç”¨é›»å½±æ•ˆæœ</button>
                </div>
                
                <!-- åˆ†é›¢è‰²èª¿é¢æ¿ -->
                <div class="split-tone-panel" id="splitTonePanel">
                    <div class="panel-title">ğŸ¨ åˆ†é›¢è‰²èª¿</div>
                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <div class="tone-section">
                            <label style="display:flex;align-items:center;gap:8px;">
                                <span>â˜€ï¸ äº®éƒ¨è‰²èª¿</span>
                                <input type="color" id="highlightTone" value="#ffd700" style="width:40px;height:30px;border:none;cursor:pointer;">
                            </label>
                            <div class="adjust-item" style="margin-top:5px;">
                                <label>é£½å’Œåº¦</label>
                                <input type="range" id="highlightSat" min="0" max="100" value="25">
                                <span id="highlightSatVal">25%</span>
                            </div>
                        </div>
                        <div class="tone-section">
                            <label style="display:flex;align-items:center;gap:8px;">
                                <span>ğŸŒ™ æš—éƒ¨è‰²èª¿</span>
                                <input type="color" id="shadowTone" value="#4169e1" style="width:40px;height:30px;border:none;cursor:pointer;">
                            </label>
                            <div class="adjust-item" style="margin-top:5px;">
                                <label>é£½å’Œåº¦</label>
                                <input type="range" id="shadowSat" min="0" max="100" value="25">
                                <span id="shadowSatVal">25%</span>
                            </div>
                        </div>
                        <div class="adjust-item">
                            <label>å¹³è¡¡</label>
                            <input type="range" id="toneBalance" min="-100" max="100" value="0">
                            <span id="toneBalanceVal">0</span>
                        </div>
                    </div>
                    <button class="wm-action-btn add" onclick="applySplitTone()" style="margin-top:10px;">ğŸ¨ å¥—ç”¨åˆ†é›¢è‰²èª¿</button>
                </div>
                
                <!-- å–è‰²å™¨é¢æ¿ -->
                <div class="eyedropper-panel" id="eyeDropperAdvPanel">
                    <div class="panel-title">ğŸ’‰ å–è‰²å™¨</div>
                    <div id="colorPreviewLarge" style="width:100%;height:60px;background:#888;border-radius:8px;margin-bottom:10px;"></div>
                    <div style="display:flex;flex-direction:column;gap:8px;font-size:12px;">
                        <div style="display:flex;justify-content:space-between;">
                            <span>HEX:</span>
                            <span id="colorHex">#888888</span>
                            <button onclick="copyColor('hex')" style="padding:2px 8px;font-size:10px;cursor:pointer;">è¤‡è£½</button>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>RGB:</span>
                            <span id="colorRgb">rgb(136, 136, 136)</span>
                            <button onclick="copyColor('rgb')" style="padding:2px 8px;font-size:10px;cursor:pointer;">è¤‡è£½</button>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span>HSL:</span>
                            <span id="colorHsl">hsl(0, 0%, 53%)</span>
                            <button onclick="copyColor('hsl')" style="padding:2px 8px;font-size:10px;cursor:pointer;">è¤‡è£½</button>
                        </div>
                    </div>
                    <div id="colorHistory" style="display:flex;gap:5px;flex-wrap:wrap;margin-top:10px;"></div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">ğŸ’¡ é»æ“Šç•«å¸ƒä»»æ„ä½ç½®å–è‰²</small>
                </div>
                
                <!-- GIF é¢æ¿ -->
                <div class="gif-panel" id="gifPanel">
                    <div class="panel-title">ğŸ¬ GIF å‹•åœ–</div>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <div class="wm-option">
                            <label>é¸æ“‡å¤šå¼µåœ–ç‰‡è£½ä½œ GIF</label>
                            <input type="file" id="gifFrameInput" multiple accept="image/*" onchange="addGifFrames(event)" style="margin-top:5px;">
                        </div>
                        <div class="wm-option">
                            <label>æ¯å¹€é–“éš” (æ¯«ç§’)</label>
                            <input type="range" id="gifDelay" min="50" max="1000" value="200" oninput="document.getElementById('gifDelayVal').textContent=this.value+'ms'">
                            <span id="gifDelayVal">200ms</span>
                        </div>
                        <div id="gifFramePreview" style="display:flex;gap:5px;flex-wrap:wrap;max-height:100px;overflow-y:auto;"></div>
                        <div style="display:flex;gap:8px;">
                            <button class="wm-action-btn" onclick="previewGif()" style="flex:1;">ğŸ‘ï¸ é è¦½</button>
                            <button class="wm-action-btn add" onclick="createGif()" style="flex:1;">ğŸ¬ ç”¢ç”Ÿ GIF</button>
                        </div>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:10px;">ğŸ’¡ é¸æ“‡ 2 å¼µä»¥ä¸Šåœ–ç‰‡ï¼Œè¨­å®šé–“éš”æ™‚é–“å¾Œç”¢ç”Ÿ</small>
                </div>
                
                <!-- æ–‡å­—ç·¨è¼¯é¢æ¿ -->
                <div class="text-panel" id="textPanel">
                    <div class="panel-title">âœï¸ æ–‡å­—ç·¨è¼¯</div>
                    <textarea class="text-input-area" id="textInput" placeholder="è¼¸å…¥æ–‡å­—..."></textarea>
                    <div class="text-options">
                        <div class="option-group">
                            <label>å¤§å°</label>
                            <input type="number" id="fontSize" value="24" min="8" max="200">
                        </div>
                        <div class="option-group">
                            <label>æ–‡å­—è‰²</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="textColor" value="#ffffff">
                                <button class="eyedropper-btn" id="textEyedropper" onclick="startEyedropper('text')" title="å¸å–é¡è‰²">ğŸ’§</button>
                            </div>
                        </div>
                        <div class="option-group">
                            <label>èƒŒæ™¯è‰²</label>
                            <div class="color-picker-wrapper">
                                <input type="color" id="bgColor" value="#000000">
                                <button class="eyedropper-btn" id="bgEyedropper" onclick="startEyedropper('bg')" title="å¸å–é¡è‰²">ğŸ’§</button>
                            </div>
                        </div>
                    </div>
                    <div class="text-options">
                        <button class="style-btn" id="boldBtn" onclick="toggleStyle('bold')"><b>B</b></button>
                        <button class="style-btn" id="italicBtn" onclick="toggleStyle('italic')"><i>I</i></button>
                        <button class="style-btn" id="underlineBtn" onclick="toggleStyle('underline')"><u>U</u></button>
                        <button class="style-btn" onclick="setAlign('left')">â¬…ï¸</button>
                        <button class="style-btn" onclick="setAlign('center')">â¬›</button>
                        <button class="style-btn" onclick="setAlign('right')">â¡ï¸</button>
                    </div>
                    <div class="wm-position" style="margin-top:10px;">
                        <label>åˆå§‹ä½ç½®ï¼š</label>
                        <div class="position-grid">
                            <button class="pos-btn" onclick="setQuickTextPosition('top-left', this)">â†–</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('top-center', this)">â†‘</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('top-right', this)">â†—</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('middle-left', this)">â†</button>
                            <button class="pos-btn active" onclick="setQuickTextPosition('center', this)">â¬¤</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('middle-right', this)">â†’</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('bottom-left', this)">â†™</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('bottom-center', this)">â†“</button>
                            <button class="pos-btn" onclick="setQuickTextPosition('bottom-right', this)">â†˜</button>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="addQuickText()">ğŸ¯ æ‹–æ›³æ”¾ç½®æ–‡å­—</button>
                        <button class="action-btn" onclick="applyText()">ğŸ“¦ å¡«å…¥é¸å–å€</button>
                    </div>
                    <small style="color:var(--text-secondary);font-size:10px;display:block;margin-top:5px;">ğŸ’¡ ä¹å®®æ ¼è¨­å®šåˆå§‹ä½ç½®ï¼Œæ”¾ç½®å¾Œå¯æ‹–æ›³å¾®èª¿</small>
                </div>
                
                <!-- ä¸‹è¼‰é¢æ¿ -->
                <div class="download-panel" id="downloadPanel">
                    <div class="panel-title">ğŸ’¾ ä¸‹è¼‰èˆ‡åˆ†äº«</div>
                    <div class="download-buttons">
                        <button class="download-btn png" onclick="downloadPNG()">
                            <span class="icon">ğŸ–¼ï¸</span>
                            <span>ä¸‹è¼‰ PNG</span>
                        </button>
                        <button class="download-btn pdf" onclick="downloadPDF()" id="downloadPdfBtn">
                            <span class="icon">ğŸ“„</span>
                            <span>ä¸‹è¼‰ PDF</span>
                        </button>
                        <button class="download-btn line" onclick="sendToLine()">
                            <span class="icon">ğŸ’¬</span>
                            <span>LINE åˆ†äº«</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- è¨­å®šé  -->
        <div class="page" id="page-settings">
            <div class="editor-area">
                <div class="settings-section">
                    <div class="settings-title">ğŸ¤– AI è§£æè¨­å®š</div>
                    <div class="setting-item">
                        <label>ğŸ’ Gemini API Key</label>
                        <div style="display:flex;gap:5px;">
                            <input type="password" id="geminiApiKey" placeholder="AIza..." style="flex:1;">
                            <button class="toggle-pwd-btn" onclick="togglePassword('geminiApiKey', this)">ğŸ‘ï¸</button>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;">å¾ <a href="https://aistudio.google.com/" target="_blank" style="color:var(--secondary);">Google AI Studio</a> å…è²»å–å¾—</small>
                    </div>
                    <div class="setting-item">
                        <label>âš¡ Groq API Key</label>
                        <div style="display:flex;gap:5px;">
                            <input type="password" id="groqApiKey" placeholder="gsk_..." style="flex:1;">
                            <button class="toggle-pwd-btn" onclick="togglePassword('groqApiKey', this)">ğŸ‘ï¸</button>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;">å¾ <a href="https://console.groq.com/" target="_blank" style="color:var(--secondary);">Groq Console</a> å…è²»å–å¾—</small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">ğŸ’¬ LINE æ¨æ’­è¨­å®šï¼ˆMessaging APIï¼‰</div>
                    <div class="setting-item">
                        <label>GAS éƒ¨ç½² URL</label>
                        <div style="display:flex;gap:5px;">
                            <input type="password" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec" style="flex:1;">
                            <button class="toggle-pwd-btn" onclick="togglePassword('gasUrl', this)">ğŸ‘ï¸</button>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;">éƒ¨ç½² Google Apps Script å¾Œå–å¾—çš„ç¶²å€</small>
                    </div>
                    <div class="setting-item">
                        <label>LINE User ID</label>
                        <div style="display:flex;gap:5px;">
                            <input type="password" id="lineUserId" placeholder="Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" style="flex:1;">
                            <button class="toggle-pwd-btn" onclick="togglePassword('lineUserId', this)">ğŸ‘ï¸</button>
                        </div>
                        <small style="color:var(--text-secondary);font-size:10px;">33 å­—å…ƒï¼Œä»¥ U é–‹é ­ã€‚åŠ å…¥ Bot å¾Œè¼¸å…¥ã€ŒIDã€å¯å–å¾—</small>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:10px;">
                        <button class="test-line-btn" onclick="testLineNotify()">ğŸ§ª æ¸¬è©¦ LINE å‚³é€</button>
                    </div>
                </div>
                
                <div style="display:flex;gap:10px;margin-top:15px;">
                    <button class="save-btn" onclick="saveSettings()" style="flex:1;">ğŸ’¾ å„²å­˜è¨­å®š</button>
                    <button class="clear-btn" onclick="clearSettings()">ğŸ—‘ï¸ æ¸…é™¤</button>
                </div>
                
                <div class="settings-section" style="margin-top:15px;">
                    <div class="settings-title">ğŸ“– LINE Messaging API è¨­å®šæ•™å­¸</div>
                    <div style="font-size:11px;color:var(--text-secondary);line-height:1.8;">
                        <p style="color:#f59e0b;margin-bottom:8px;">âš ï¸ LINE Notify å·²æ–¼ 2025/3/31 åœæ­¢æœå‹™ï¼Œè«‹æ”¹ç”¨ Messaging API</p>
                        <p><b>Step 1ï¼š</b>å‰å¾€ <a href="https://developers.line.biz/console/" target="_blank" style="color:var(--secondary);">LINE Developers Console</a></p>
                        <p><b>Step 2ï¼š</b>å»ºç«‹ Provider â†’ å»ºç«‹ Messaging API Channel</p>
                        <p><b>Step 3ï¼š</b>åœ¨ Channel è¨­å®šé é¢å–å¾— <b>Channel Access Token</b></p>
                        <p><b>Step 4ï¼š</b>å‰å¾€ <a href="https://script.google.com/" target="_blank" style="color:var(--secondary);">Google Apps Script</a> æ–°å»ºå°ˆæ¡ˆ</p>
                        <p><b>Step 5ï¼š</b>è²¼ä¸Š gas-line-messaging.js ç¨‹å¼ç¢¼ï¼Œå¡«å…¥ Token</p>
                        <p><b>Step 6ï¼š</b>éƒ¨ç½² â†’ æ–°å¢éƒ¨ç½² â†’ ç¶²é æ‡‰ç”¨ç¨‹å¼</p>
                        <p><b>Step 7ï¼š</b>åŸ·è¡Œèº«åˆ†é¸ã€Œæˆ‘ã€ï¼Œå­˜å–æ¬Šé¸ã€Œæ‰€æœ‰äººã€</p>
                        <p><b>Step 8ï¼š</b>æŠŠéƒ¨ç½²ç¶²å€è²¼åˆ°ä¸Šé¢çš„æ¬„ä½</p>
                        <p><b>Step 9ï¼š</b>ç”¨ LINE åŠ å…¥ä½ çš„ Botï¼Œè¼¸å…¥ã€ŒIDã€å–å¾— User ID</p>
                        <p style="color:var(--accent);margin-top:8px;">âœ… å®Œæˆï¼ç¾åœ¨å¯ä»¥æ¨é€åœ–ç‰‡åˆ° LINE äº†</p>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-title">â„¹ï¸ é—œæ–¼æœ¬å·¥å…·</div>
                    <div style="font-size:12px;color:var(--text-secondary);line-height:1.8;">
                        <p>ğŸ© <b>åœ–æ–‡é­”è¡“å¸« V2.0 çµ‚æ¥µç‰ˆ</b></p>
                        <p>ğŸ“ å²ä¸Šæœ€å¼·ç€è¦½å™¨åœ–ç‰‡ç·¨è¼¯å™¨</p>
                        <p>ğŸ”§ 121 å€‹å·¥å…·æŒ‰éˆ• | 18,000+ è¡Œä»£ç¢¼</p>
                        <p>ğŸ“„ æ”¯æ´ PNG / JPG / WebP / PDF</p>
                        <p>ğŸ¤– æ•´åˆ Gemini + Groq é›™ AI å¼•æ“</p>
                        <p>ğŸ’¬ å¯æ¨é€åˆ° LINE å³æ™‚åˆ†äº«</p>
                        <p style="margin-top:10px;">Made with ğŸ’œ by Sone Wang</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åº•éƒ¨å°èˆª -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showPage('home')">
            <span class="icon">ğŸ </span>
            <span>é¦–é </span>
        </div>
        <div class="nav-item" onclick="showPage('settings')">
            <span class="icon">âš™ï¸</span>
            <span>è¨­å®š</span>
        </div>
    </nav>
    
    <!-- Toast -->
    <div id="toast"></div>
    
    <!-- éš±è—çš„ input -->
    <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
    <input type="file" id="pdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(event)">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleImageUpload(event)">
    
    <script>
        // ===== å…¨åŸŸè®Šæ•¸ =====
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let currentImage = null;
        let originalImageData = null;
        let pdfDoc = null;
        let pdfPages = [];
        let currentPageNum = 1;
        let totalPagesNum = 1;
        let isSelecting = false;
        let selectionStart = { x: 0, y: 0 };
        let selectionEnd = { x: 0, y: 0 };
        let currentSelection = null;
        let currentTool = null;
        let eyedropperTarget = null;
        let textStyle = { bold: false, italic: false, underline: false, align: 'left' };
        let quickTextPosition = 'center';
        let settings = { gasUrl: '', lineUserId: '', geminiApiKey: '', groqApiKey: '' };
        let aiResultText = '';
        
        // æ‹–æ›³ç³»çµ±è®Šæ•¸ï¼ˆæå‰å®šç¾©ï¼‰
        let currentDragObject = null;
        let dragOffsetX = 0, dragOffsetY = 0;
        let isDraggingObject = false;
        
        // ===== ç¯€æ…¶è¨­å®š =====
        const festivals = {
            1: { emoji: 'ğŸŠ', items: ['ğŸ‰', 'ğŸŠ', 'ğŸ§§', 'ğŸ’°', 'ğŸ†'], name: 'æ–°å¹´' },
            2: { emoji: 'ğŸ’•', items: ['ğŸ’•', 'â¤ï¸', 'ğŸ’–', 'ğŸ’', 'ğŸŒ¹'], name: 'æƒ…äººç¯€' },
            3: { emoji: 'ğŸŒ¸', items: ['ğŸŒ¸', 'ğŸŒ·', 'ğŸŒº', 'ğŸ’®', 'ğŸŒ¼'], name: 'æ˜¥å¤©' },
            4: { emoji: 'ğŸ£', items: ['ğŸ£', 'ğŸ¥š', 'ğŸ°', 'ğŸŒ·', 'ğŸ¦‹'], name: 'å¾©æ´»ç¯€' },
            5: { emoji: 'ğŸŒ¹', items: ['ğŸŒ¹', 'ğŸ’', 'ğŸŒ·', 'ğŸŒ¸', 'ğŸ’•'], name: 'æ¯è¦ªç¯€' },
            6: { emoji: 'ğŸ²', items: ['ğŸ²', 'ğŸ', 'ğŸ®', 'ğŸŒŠ', 'â›µ'], name: 'ç«¯åˆç¯€' },
            7: { emoji: 'ğŸŒŠ', items: ['ğŸŒŠ', 'â˜€ï¸', 'ğŸ–ï¸', 'ğŸ‰', 'ğŸŒ´'], name: 'å¤æ—¥' },
            8: { emoji: 'ğŸ‘”', items: ['ğŸ‘”', 'ğŸ†', 'â­', 'ğŸ–ï¸', 'ğŸ’ª'], name: 'çˆ¶è¦ªç¯€' },
            9: { emoji: 'ğŸ¥®', items: ['ğŸ¥®', 'ğŸŒ•', 'ğŸ®', 'ğŸ°', 'âœ¨'], name: 'ä¸­ç§‹ç¯€' },
            10: { emoji: 'ğŸƒ', items: ['ğŸƒ', 'ğŸ‘»', 'ğŸ¦‡', 'ğŸ•·ï¸', 'ğŸ’€'], name: 'è¬è–ç¯€' },
            11: { emoji: 'ğŸ‚', items: ['ğŸ‚', 'ğŸ', 'ğŸ¦ƒ', 'ğŸŒ½', 'ğŸ¥§'], name: 'æ„Ÿæ©ç¯€' },
            12: { emoji: 'ğŸ„', items: ['â„ï¸', 'ğŸ„', 'ğŸ…', 'â­', 'ğŸ'], name: 'è–èª•ç¯€' }
        };
        
        // ===== åˆå§‹åŒ– =====
        window.onload = function() {
            loadSettings();
            updateTime();
            setInterval(updateTime, 1000);
            initFestival();
            initCanvasEvents();
            initKeyboardEvents();
            initPasteEvent();
            initWatermarkEvents();
            
            // é–‹æ©Ÿå‹•ç•«
            setTimeout(() => {
                document.getElementById('splashScreen').classList.add('fade-out');
            }, 2000);
        };
        
        // ===== æ™‚é–“æ›´æ–° =====
        function updateTime() {
            const now = new Date();
            document.getElementById('headerTime').textContent = 
                now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        }
        
        // ===== ç¯€æ…¶æ•ˆæœ =====
        function initFestival() {
            const month = new Date().getMonth() + 1;
            const festival = festivals[month];
            document.getElementById('headerFestival').textContent = festival.emoji;
            
            const container = document.getElementById('festivalEffect');
            for (let i = 0; i < 15; i++) {
                setTimeout(() => createFestivalItem(container, festival.items), i * 500);
            }
            setInterval(() => createFestivalItem(container, festival.items), 2000);
        }
        
        function createFestivalItem(container, items) {
            const item = document.createElement('div');
            item.className = 'festival-item';
            item.textContent = items[Math.floor(Math.random() * items.length)];
            item.style.left = Math.random() * 100 + '%';
            item.style.animationDuration = (5 + Math.random() * 5) + 's';
            item.style.fontSize = (16 + Math.random() * 16) + 'px';
            container.appendChild(item);
            setTimeout(() => item.remove(), 10000);
        }
        
        // ===== é é¢åˆ‡æ› =====
        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            // å®‰å…¨è™•ç†ï¼šç•¶ç›´æ¥èª¿ç”¨å‡½æ•¸æ™‚ event å¯èƒ½æœªå®šç¾©
            if (typeof event !== 'undefined' && event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                // æ ¹æ“šé é¢åç¨±æ¿€æ´»å°æ‡‰çš„å°èˆªé …
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    if (item.getAttribute('onclick')?.includes(page)) {
                        item.classList.add('active');
                    }
                });
            }
        }
        
        // ===== å·¥å…·åˆ†é¡åˆ‡æ› =====
        let currentToolCategory = 'basic';
        
        function showToolCategory(category) {
            // æ›´æ–°åˆ†é¡æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // å®‰å…¨è™•ç†ï¼šç•¶ç›´æ¥èª¿ç”¨å‡½æ•¸æ™‚ event å¯èƒ½æœªå®šç¾©
            if (typeof event !== 'undefined' && event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                // æ ¹æ“šåˆ†é¡åç¨±æ¿€æ´»å°æ‡‰çš„æŒ‰éˆ•
                document.querySelectorAll('.category-btn').forEach(btn => {
                    if (btn.getAttribute('onclick')?.includes(category)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // éš±è—æ‰€æœ‰å·¥å…·çµ„
            document.querySelectorAll('.toolbar-tools').forEach(tools => {
                tools.classList.remove('show');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„å·¥å…·çµ„
            const toolsDiv = document.getElementById('tools-' + category);
            if (toolsDiv) {
                toolsDiv.classList.add('show');
            }
            
            currentToolCategory = category;
        }
        
        // å¿«é€Ÿè·³åˆ°å·¥å…·æŒ‰éˆ•
        function scrollToTool(btnId) {
            const btn = document.getElementById(btnId);
            if (btn) {
                // æ‰¾åˆ°æŒ‰éˆ•æ‰€åœ¨çš„åˆ†é¡ä¸¦å±•é–‹
                const toolsContainer = btn.closest('.toolbar-tools');
                if (toolsContainer) {
                    const categoryId = toolsContainer.id.replace('tools-', '');
                    // åˆ‡æ›åˆ°å°æ‡‰åˆ†é¡
                    document.querySelectorAll('.category-btn').forEach(catBtn => {
                        catBtn.classList.remove('active');
                        if (catBtn.getAttribute('onclick')?.includes(categoryId)) {
                            catBtn.classList.add('active');
                        }
                    });
                    document.querySelectorAll('.toolbar-tools').forEach(tools => {
                        tools.classList.remove('show');
                    });
                    toolsContainer.classList.add('show');
                }
                
                btn.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                // é–ƒçˆæç¤º
                btn.style.animation = 'none';
                btn.offsetHeight; // è§¸ç™¼é‡ç¹ª
                btn.style.animation = 'highlight 1s ease';
                setTimeout(() => { btn.style.animation = ''; }, 1000);
                
                if (btn.disabled) {
                    showToast('è«‹å…ˆä¸Šå‚³åœ–ç‰‡å†ä½¿ç”¨æ­¤åŠŸèƒ½ ğŸ“¤');
                }
            }
        }
        
        // ===== ä¸Šå‚³åŠŸèƒ½ =====
        function triggerUpload(type) {
            if (type === 'image') {
                document.getElementById('imageInput').click();
            } else if (type === 'pdf') {
                document.getElementById('pdfInput').click();
            }
        }
        
        function takePhoto() {
            document.getElementById('cameraInput').click();
        }
        
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                loadImage(event.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        function loadImage(src) {
            const img = new Image();
            img.onload = function() {
                currentImage = img;
                pdfDoc = null;
                pdfPages = [];
                
                // éš±è— PDF ç›¸é—œ UI
                document.getElementById('pdfControls').classList.remove('show');
                document.getElementById('pdfToolBtn').style.display = 'none';
                document.getElementById('pdfToolPanel').classList.remove('show');
                
                // ä¿æŒåŸå§‹å°ºå¯¸ï¼ˆç¢ºä¿è¼¸å‡ºå“è³ªï¼‰
                // ä½†å¦‚æœåœ–ç‰‡å¤ªå¤§ï¼ˆè¶…é 4000pxï¼‰ï¼Œå‰‡ç¸®å°ä»¥é¿å…æ•ˆèƒ½å•é¡Œ
                const maxDimension = 4000;
                let width = img.width;
                let height = img.height;
                
                if (width > maxDimension || height > maxDimension) {
                    if (width > height) {
                        height = (maxDimension / width) * height;
                        width = maxDimension;
                    } else {
                        width = (maxDimension / height) * width;
                        height = maxDimension;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                originalImageData = ctx.getImageData(0, 0, width, height);
                
                // é‡ç½®ç¸®æ”¾ä¸¦é©æ‡‰è¢å¹•
                currentZoom = 1;
                
                // æ›´æ–°ç•«å¸ƒé¡¯ç¤ºè³‡è¨Š
                updateCanvasInfo();
                
                showEditor();
                
                // å»¶é²åŸ·è¡Œé©æ‡‰è¢å¹•ï¼Œç¢ºä¿ DOM å·²æ›´æ–°
                setTimeout(() => {
                    fitToScreen();
                }, 100);
                
                showToast(`âœ¨ åœ–ç‰‡è¼‰å…¥æˆåŠŸï¼(${Math.round(width)} x ${Math.round(height)})`);
            };
            img.src = src;
        }
        
        function updateCanvasInfo() {
            const info = document.getElementById('canvasInfo');
            if (info) {
                info.textContent = `${canvas.width} x ${canvas.height}`;
            }
        }
        
        // ===== ç•«å¸ƒç¸®æ”¾åŠŸèƒ½ =====
        let currentZoom = 1;
        const minZoom = 0.1;
        const maxZoom = 5;
        
        function updateZoomInfo() {
            const zoomInfo = document.getElementById('zoomInfo');
            if (zoomInfo) {
                zoomInfo.textContent = `${Math.round(currentZoom * 100)}%`;
            }
            applyZoom();
        }
        
        function applyZoom() {
            canvas.style.transform = `scale(${currentZoom})`;
            canvas.style.transformOrigin = 'center top';
            
            // èª¿æ•´å®¹å™¨é«˜åº¦ä»¥é©æ‡‰ç¸®æ”¾å¾Œçš„ç•«å¸ƒ
            const container = document.getElementById('canvasContainer');
            if (container && canvas.height > 0) {
                const scaledHeight = canvas.height * currentZoom;
                container.style.minHeight = `${Math.min(scaledHeight + 20, window.innerHeight * 0.8)}px`;
            }
        }
        
        function zoomCanvas(delta) {
            const newZoom = Math.max(minZoom, Math.min(maxZoom, currentZoom + delta));
            if (newZoom !== currentZoom) {
                currentZoom = newZoom;
                updateZoomInfo();
            }
        }
        
        function setZoom(zoom) {
            currentZoom = Math.max(minZoom, Math.min(maxZoom, zoom));
            updateZoomInfo();
        }
        
        function resetZoom() {
            currentZoom = 1;
            updateZoomInfo();
            showToast('ğŸ” ç¸®æ”¾å·²é‡ç½®ç‚º 100%');
        }
        
        function fitToScreen() {
            const container = document.getElementById('canvasContainer');
            if (!container || canvas.width === 0) return;
            
            const containerWidth = container.clientWidth - 40;
            const containerHeight = window.innerHeight * 0.65;
            
            const scaleX = containerWidth / canvas.width;
            const scaleY = containerHeight / canvas.height;
            
            currentZoom = Math.min(scaleX, scaleY, 1);
            updateZoomInfo();
            showToast('ğŸ”² å·²é©æ‡‰è¢å¹•å¤§å°');
        }
        
        // æ»¾è¼ªç¸®æ”¾
        function initZoomEvents() {
            const container = document.getElementById('canvasContainer');
            if (!container) return;
            
            // æ»¾è¼ªç¸®æ”¾ï¼ˆCtrl + æ»¾è¼ªï¼‰
            container.addEventListener('wheel', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    zoomCanvas(delta);
                }
            }, { passive: false });
            
            // é›™æ“Šé‡ç½®ç¸®æ”¾
            canvas.addEventListener('dblclick', (e) => {
                // é‹¼ç­†å·¥å…·é›™æ“Šå®Œæˆè·¯å¾‘
                if (currentTool === 'penTool' && penPoints.length >= 2) {
                    completePenPath();
                    return;
                }
                
                if (!currentTool && !eyedropperTarget && !stampDragMode && !stickerDragMode && !signDragMode) {
                    resetZoom();
                }
            });
            
            // è§¸æ§ç¸®æ”¾ï¼ˆé›™æŒ‡ï¼‰
            let initialDistance = 0;
            let initialZoom = 1;
            
            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    initialDistance = getTouchDistance(e.touches);
                    initialZoom = currentZoom;
                }
            }, { passive: false });
            
            container.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = getTouchDistance(e.touches);
                    const scale = currentDistance / initialDistance;
                    setZoom(initialZoom * scale);
                }
            }, { passive: false });
        }
        
        function getTouchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–ç¸®æ”¾äº‹ä»¶
        document.addEventListener('DOMContentLoaded', initZoomEvents);
        
        // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
        window.addEventListener('resize', () => {
            if (document.getElementById('canvasWrapper').classList.contains('show')) {
                updateZoomInfo();
            }
        });
        
        // ç›£è¯ ESC éµå–æ¶ˆæ‰€æœ‰å·¥å…·å’Œæ”¾ç½®æ¨¡å¼
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                let cancelled = false;
                
                // å–æ¶ˆæ‹–æ›³ç‰©ä»¶
                if (currentDragObject) {
                    removeDragObject();
                    showToast('âŒ æ”¾ç½®å·²å–æ¶ˆ');
                    cancelled = true;
                }
                
                // å–æ¶ˆç•¶å‰å·¥å…·
                if (currentTool) {
                    cancelCurrentTool();
                    cancelled = true;
                }
                
                // å–æ¶ˆé¸å–æ¡†
                if (currentSelection) {
                    currentSelection = null;
                    document.getElementById('selectionBox').style.display = 'none';
                    if (!cancelled) showToast('ğŸ”“ é¸å–å·²å–æ¶ˆ');
                    cancelled = true;
                }
                
                // é—œé–‰æ‰€æœ‰é¢æ¿
                if (!cancelled) {
                    const openPanels = document.querySelectorAll('.panel.show, [class*="-panel"].show');
                    if (openPanels.length > 0) {
                        openPanels.forEach(panel => panel.classList.remove('show'));
                        showToast('ğŸ”“ é¢æ¿å·²é—œé–‰');
                    }
                }
                
                canvas.style.cursor = 'default';
            }
        });
        
        // ===== PDF è™•ç† =====
        async function handlePdfUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            showToast('ğŸ“„ è¼‰å…¥ PDF ä¸­...');
            
            const arrayBuffer = await file.arrayBuffer();
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            try {
                pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                totalPagesNum = pdfDoc.numPages;
                pdfPages = new Array(totalPagesNum).fill(null);
                
                document.getElementById('totalPages').textContent = totalPagesNum;
                document.getElementById('pdfControls').classList.add('show');
                
                await renderPdfPage(1);
                showToast(`âœ¨ PDF è¼‰å…¥æˆåŠŸï¼å…± ${totalPagesNum} é `);
            } catch (err) {
                showToast('âŒ PDF è¼‰å…¥å¤±æ•—');
                console.error(err);
            }
        }
        
        async function renderPdfPage(pageNum) {
            if (!pdfDoc) return;
            
            currentPageNum = pageNum;
            document.getElementById('currentPage').textContent = pageNum;
            document.getElementById('prevPage').disabled = pageNum <= 1;
            document.getElementById('nextPage').disabled = pageNum >= totalPagesNum;
            
            // é¡¯ç¤º PDF æ‹†åˆ†æŒ‰éˆ•
            document.getElementById('pdfToolBtn').style.display = 'flex';
            
            // å¦‚æœæœ‰æš«å­˜å°±ç”¨æš«å­˜
            if (pdfPages[pageNum - 1]) {
                canvas.width = pdfPages[pageNum - 1].width;
                canvas.height = pdfPages[pageNum - 1].height;
                ctx.putImageData(pdfPages[pageNum - 1], 0, 0);
                originalImageData = pdfPages[pageNum - 1];
                showEditor();
                return;
            }
            
            const page = await pdfDoc.getPage(pageNum);
            // ä½¿ç”¨è¼ƒé«˜çš„ scale ä»¥ä¿æŒå“è³ªï¼ŒCSS æœƒè‡ªå‹•ç¸®æ”¾é¡¯ç¤º
            let viewport = page.getViewport({ scale: 1 });
            // æœ€å¤§å°ºå¯¸é™åˆ¶ç‚º 3000px
            const maxDimension = 3000;
            let scale = 2; // é è¨­ 2x å“è³ª
            
            if (viewport.width * scale > maxDimension || viewport.height * scale > maxDimension) {
                scale = Math.min(maxDimension / viewport.width, maxDimension / viewport.height);
            }
            
            viewport = page.getViewport({ scale });
            
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await page.render({
                canvasContext: ctx,
                viewport: viewport
            }).promise;
            
            originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            pdfPages[pageNum - 1] = originalImageData;
            showEditor();
        }
        
        function changePage(delta) {
            // å„²å­˜ç•¶å‰é é¢
            pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            const newPage = currentPageNum + delta;
            if (newPage >= 1 && newPage <= totalPagesNum) {
                renderPdfPage(newPage);
            }
        }
        
        // ===== å‰ªè²¼ç°¿è²¼ä¸Š =====
        function initPasteEvent() {
            document.addEventListener('paste', async (e) => {
                const items = e.clipboardData?.items;
                if (!items) return;
                
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (e) => loadImage(e.target.result);
                        reader.readAsDataURL(blob);
                        showToast('ğŸ“‹ å·²è²¼ä¸Šåœ–ç‰‡ï¼');
                        break;
                    }
                }
            });
        }
        
        async function pasteFromClipboard() {
            try {
                const clipboardItems = await navigator.clipboard.read();
                for (const item of clipboardItems) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            const blob = await item.getType(type);
                            const reader = new FileReader();
                            reader.onload = (e) => loadImage(e.target.result);
                            reader.readAsDataURL(blob);
                            showToast('ğŸ“‹ å·²è²¼ä¸Šåœ–ç‰‡ï¼');
                            return;
                        }
                    }
                }
                showToast('âš ï¸ å‰ªè²¼ç°¿æ²’æœ‰åœ–ç‰‡');
            } catch (err) {
                showToast('âš ï¸ è«‹å…è¨±å­˜å–å‰ªè²¼ç°¿');
            }
        }
        
        // ===== é¡¯ç¤ºç·¨è¼¯å™¨ =====
        function showEditor() {
            document.getElementById('uploadZone').classList.add('hidden');
            document.getElementById('canvasWrapper').classList.add('show');
            document.getElementById('textPanel').classList.add('show');
            document.getElementById('downloadPanel').classList.add('show');
            
            // æ›´æ–°ç•«å¸ƒè³‡è¨Š
            updateCanvasInfo();
            
            // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–ï¼Œæ›´æ–°ç¸®æ”¾æ¯”ä¾‹
            setTimeout(updateZoomInfo, 100);
            
            // å•Ÿç”¨æ‰€æœ‰å·¥å…·æŒ‰éˆ•
            const buttons = [
                'selectBtn', 'clearBtn', 'aiBtn', 'watermarkBtn', 'mosaicBtn',
                'stampBtn', 'signBtn', 'filterBtn', 'adjustBtn', 'frameBtn',
                'stickerBtn', 'arrowBtn', 'rotateBtn', 'flipHBtn', 'flipVBtn',
                'cropBtn', 'mergeBtn', 'qrBtn', 'compressBtn', 'undoBtn', 'resetBtn',
                'brushBtn', 'shapeBtn', 'textFxBtn', 'templateBtn', 'collageBtn',
                'beautyBtn', 'removeBgBtn', 'batchBtn', 'effectBtn', 'overlayBtn',
                'annotateBtn', 'measureBtn', 'gridBtn', 'historyBtn', 'infoBtn',
                'colorReplaceBtn', 'compareBtn', 'idPhotoBtn', 'screenshotBtn',
                'pixelArtBtn', 'asciiBtn', 'cartoonBtn', 'sketchBtn', 'oilPaintBtn',
                'glitchBtn', 'duotoneBtn', 'gradientBtn', 'vignetteBtn', 'noiseBtn',
                'blurBgBtn', 'textureBtn', 'lightLeakBtn', 'bokehBtn', 'tiltShiftBtn',
                'mirrorBtn', 'kaleidoBtn', 'splitBtn', 'socialBtn', 'exportBtn',
                'layerBtn', 'cloneBtn', 'healBtn', 'liquifyBtn', 'hdrBtn',
                'curveBtn', 'levelBtn', 'histogramBtn', 'colorBalanceBtn',
                'selectiveColorBtn', 'photoFilterBtn', 'lensBlurBtn', 'motionBlurBtn',
                'zoomBlurBtn', 'perspectiveBtn', 'distortBtn', 'warpBtn', 'memeBtn',
                'posterBtn', 'cardBtn', 'bannerBtn', 'avatarBtn', 'logoBtn', 'gifBtn',
                'colorPaletteBtn', 'eyeDropperAdvBtn', 'rulerBtn', 'guideBtn', 'alignBtn',
                'magicWandBtn', 'lassoBtn', 'penToolBtn', 'pathBtn', 'channelBtn',
                'autoEnhanceBtn', 'autoColorBtn', 'autoContrastBtn', 'autoLevelBtn',
                'redEyeBtn', 'blemishBtn', 'whiteTeethBtn', 'slimFaceBtn', 'bigEyeBtn',
                'makeupBtn', 'faceSwapBtn', 'bgBlurPortraitBtn', 'skeletonBtn',
                'outlineBtn', 'dotArtBtn', 'lowPolyBtn', 'mosaic2Btn', 'colorSplashBtn',
                'miniatureBtn', 'infraredBtn', 'crossProcessBtn', 'bleachBypassBtn',
                'splitToneBtn', 'colorGradeBtn', 'lutBtn', 'vintageBtn', 'filmBtn',
                'cinemaBtn', 'printBtn', 'shareBtn', 'cloudBtn', 'shortcutBtn',
                'themeBtn', 'selectBtn2'
            ];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = false;
            });
            
            // å„²å­˜åˆå§‹ç‹€æ…‹ä¾›å¾©åŸä½¿ç”¨
            saveHistory();
            updateCompressInfo();
            updateImageInfo();
            initLayers();
        }
        
        // åˆå§‹åŒ–ï¼šè®“ä¸€äº›åŸºæœ¬åŠŸèƒ½å§‹çµ‚å¯ç”¨ï¼ˆä¸éœ€è¦è¼‰å…¥åœ–ç‰‡ï¼‰
        function enableBasicButtons() {
            const alwaysEnabled = [
                'helpBtn', 'shortcutBtn', 'themeBtn', 'templateBtn', 'settingsNavBtn'
            ];
            alwaysEnabled.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = false;
            });
        }
        
        // é é¢è¼‰å…¥æ™‚å•Ÿç”¨åŸºæœ¬æŒ‰éˆ•
        document.addEventListener('DOMContentLoaded', enableBasicButtons);
        
        // ===== AI åˆ†æåŠŸèƒ½ =====
        function showAIPanel() {
            const panel = document.getElementById('aiPanel');
            panel.classList.toggle('show');
            document.getElementById('aiBtn').classList.toggle('active', panel.classList.contains('show'));
        }
        
        function getSelectedMode() {
            return document.querySelector('input[name="aiMode"]:checked').value;
        }
        
        function getPromptByMode(mode) {
            switch(mode) {
                case 'ocr':
                    return 'è«‹è¾¨è­˜é€™å¼µåœ–ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—ï¼Œä¿æŒåŸå§‹æ’ç‰ˆæ ¼å¼ï¼Œåªè¼¸å‡ºè¾¨è­˜åˆ°çš„æ–‡å­—å…§å®¹ï¼Œä¸è¦åŠ ä»»ä½•èªªæ˜ã€‚';
                case 'describe':
                    return 'è«‹è©³ç´°æè¿°é€™å¼µåœ–ç‰‡çš„å…§å®¹ï¼ŒåŒ…æ‹¬å ´æ™¯ã€ç‰©ä»¶ã€äººç‰©ã€é¡è‰²ã€æ§‹åœ–ç­‰ç´°ç¯€ã€‚ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚';
                case 'translate':
                    return 'è«‹è¾¨è­˜åœ–ç‰‡ä¸­çš„æ–‡å­—ä¸¦ç¿»è­¯æˆç¹é«”ä¸­æ–‡ã€‚å…ˆåˆ—å‡ºåŸæ–‡ï¼Œå†åˆ—å‡ºç¿»è­¯ã€‚';
                default:
                    return 'è«‹åˆ†æé€™å¼µåœ–ç‰‡ã€‚';
            }
        }
        
        async function analyzeImage() {
            const model = document.getElementById('aiModel').value;
            const isGemini = model.startsWith('gemini');
            const isGroq = model.startsWith('llama');
            
            if (isGemini && !settings.geminiApiKey) {
                showToast('âš ï¸ è«‹å…ˆè¨­å®š Gemini API Key');
                showPage('settings');
                return;
            }
            if (isGroq && !settings.groqApiKey) {
                showToast('âš ï¸ è«‹å…ˆè¨­å®š Groq API Key');
                showPage('settings');
                return;
            }
            
            // ä»˜è²»æ¨¡å‹æé†’
            if (model === 'gemini-2.5-pro' || model === 'gemini-3.0-pro') {
                if (!confirm(`âš ï¸ ${model} æ˜¯ä»˜è²»æ¨¡å‹ï¼Œæœƒç”¢ç”Ÿè²»ç”¨ã€‚\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
                    return;
                }
            }
            
            const resultDiv = document.getElementById('aiResult');
            resultDiv.innerHTML = '';
            resultDiv.classList.add('loading');
            showToast('ğŸ¤– AI åˆ†æä¸­...');
            
            try {
                const imageData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                const mode = getSelectedMode();
                const prompt = getPromptByMode(mode);
                
                let text = '';
                
                if (isGemini) {
                    text = await callGeminiVision(model, imageData, prompt);
                } else if (isGroq) {
                    text = await callGroqVision(model, imageData, prompt);
                }
                
                aiResultText = text;
                resultDiv.classList.remove('loading');
                resultDiv.textContent = text;
                showToast('âœ… åˆ†æå®Œæˆï¼');
            } catch (e) {
                resultDiv.classList.remove('loading');
                resultDiv.innerHTML = '<span style="color:var(--danger);">âŒ ' + e.message + '</span>';
                showToast('âŒ åˆ†æå¤±æ•—');
            }
        }
        
        async function callGeminiVision(model, imageData, prompt) {
            // æ¨¡å‹åç¨±å°æ‡‰
            const modelMap = {
                'gemini-2.0-flash': 'gemini-2.0-flash',
                'gemini-2.5-flash': 'gemini-2.5-flash-preview-05-20',
                'gemini-2.5-pro': 'gemini-2.5-pro-preview-05-06',
                'gemini-3.0-pro': 'gemini-2.5-pro-exp-03-25'
            };
            const apiModel = modelMap[model] || 'gemini-2.0-flash';
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${apiModel}:generateContent?key=${settings.geminiApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: 'image/jpeg', data: imageData } }
                        ]
                    }]
                })
            });
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || 'Gemini API éŒ¯èª¤');
            }
            
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || 'ç„¡æ³•è§£æ';
        }
        
        async function callGroqVision(model, imageData, prompt) {
            // æ¨¡å‹åç¨±å°æ‡‰
            const modelMap = {
                'llama-4-scout': 'meta-llama/llama-4-scout-17b-16e-instruct',
                'llama-4-maverick': 'meta-llama/llama-4-maverick-17b-128e-instruct'
            };
            const apiModel = modelMap[model] || 'meta-llama/llama-4-scout-17b-16e-instruct';
            
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${settings.groqApiKey}`
                },
                body: JSON.stringify({
                    model: apiModel,
                    messages: [{
                        role: 'user',
                        content: [
                            { type: 'text', text: prompt },
                            { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${imageData}` } }
                        ]
                    }],
                    max_tokens: 2000
                })
            });
            
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || 'Groq API éŒ¯èª¤');
            }
            
            const data = await response.json();
            return data.choices?.[0]?.message?.content || 'ç„¡æ³•è§£æ';
        }
        
        function copyAIResult() {
            if (!aiResultText) {
                showToast('âš ï¸ æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹');
                return;
            }
            navigator.clipboard.writeText(aiResultText).then(() => {
                showToast('ğŸ“‹ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }).catch(() => {
                showToast('âŒ è¤‡è£½å¤±æ•—');
            });
        }
        
        function applyAIText() {
            if (!aiResultText) {
                showToast('âš ï¸ æ²’æœ‰å¯æ‡‰ç”¨çš„å…§å®¹');
                return;
            }
            document.getElementById('textInput').value = aiResultText;
            showToast('âœ… å·²æ‡‰ç”¨åˆ°æ–‡å­—æ¡†ï¼');
        }
        
        // ===== PDF æ‹†åˆ†çµ„åˆåŠŸèƒ½ =====
        let selectedPdfPages = new Set();
        let pdfThumbnails = [];
        
        function showPdfToolPanel() {
            const panel = document.getElementById('pdfToolPanel');
            panel.classList.toggle('show');
            document.getElementById('pdfToolBtn').classList.toggle('active', panel.classList.contains('show'));
            
            if (panel.classList.contains('show')) {
                renderPdfThumbnails();
            }
        }
        
        async function renderPdfThumbnails() {
            if (!pdfDoc) return;
            
            const grid = document.getElementById('pdfPagesGrid');
            grid.innerHTML = '';
            pdfThumbnails = [];
            selectedPdfPages.clear();
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            for (let i = 1; i <= totalPagesNum; i++) {
                // å¦‚æœå·²æœ‰æš«å­˜çš„ç·¨è¼¯é é¢
                if (pdfPages[i - 1]) {
                    const pageData = pdfPages[i - 1];
                    tempCanvas.width = pageData.width;
                    tempCanvas.height = pageData.height;
                    tempCtx.putImageData(pageData, 0, 0);
                } else {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 0.5 });
                    tempCanvas.width = viewport.width;
                    tempCanvas.height = viewport.height;
                    await page.render({ canvasContext: tempCtx, viewport }).promise;
                    pdfPages[i - 1] = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                }
                
                const dataUrl = tempCanvas.toDataURL('image/jpeg', 0.7);
                pdfThumbnails[i - 1] = dataUrl;
                
                const thumb = document.createElement('div');
                thumb.className = 'pdf-page-thumb';
                thumb.dataset.page = i;
                thumb.innerHTML = `
                    <img src="${dataUrl}" alt="Page ${i}">
                    <div class="page-num">${i}</div>
                    <div class="check-mark">âœ“</div>
                `;
                thumb.onclick = () => togglePageSelection(i, thumb);
                grid.appendChild(thumb);
            }
        }
        
        function togglePageSelection(pageNum, element) {
            if (selectedPdfPages.has(pageNum)) {
                selectedPdfPages.delete(pageNum);
                element.classList.remove('selected');
            } else {
                selectedPdfPages.add(pageNum);
                element.classList.add('selected');
            }
        }
        
        function toggleSelectAllPages() {
            const thumbs = document.querySelectorAll('.pdf-page-thumb');
            
            if (selectedPdfPages.size === totalPagesNum) {
                // å…¨éƒ¨å–æ¶ˆ
                selectedPdfPages.clear();
                thumbs.forEach(t => t.classList.remove('selected'));
                showToast('â˜‘ï¸ å·²å–æ¶ˆå…¨é¸');
            } else {
                // å…¨é¸
                for (let i = 1; i <= totalPagesNum; i++) {
                    selectedPdfPages.add(i);
                }
                thumbs.forEach(t => t.classList.add('selected'));
                showToast('â˜‘ï¸ å·²å…¨é¸ ' + totalPagesNum + ' é ');
            }
        }
        
        async function exportSelectedAsImages() {
            if (selectedPdfPages.size === 0) {
                showToast('âš ï¸ è«‹å…ˆé¸å–é é¢');
                return;
            }
            
            showToast('ğŸ–¼ï¸ åŒ¯å‡ºåœ–ç‰‡ä¸­...');
            
            const sortedPages = Array.from(selectedPdfPages).sort((a, b) => a - b);
            
            for (const pageNum of sortedPages) {
                const dataUrl = pdfThumbnails[pageNum - 1];
                
                // å–å¾—é«˜è§£æåº¦ç‰ˆæœ¬
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                const pageData = pdfPages[pageNum - 1];
                tempCanvas.width = pageData.width;
                tempCanvas.height = pageData.height;
                tempCtx.putImageData(pageData, 0, 0);
                
                const link = document.createElement('a');
                link.download = `page-${pageNum}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
                
                // å»¶é²é¿å…ç€è¦½å™¨é˜»æ“‹
                await new Promise(r => setTimeout(r, 300));
            }
            
            showToast('âœ… å·²åŒ¯å‡º ' + sortedPages.length + ' å¼µåœ–ç‰‡ï¼');
        }
        
        async function exportSelectedAsPdf() {
            if (selectedPdfPages.size === 0) {
                showToast('âš ï¸ è«‹å…ˆé¸å–é é¢');
                return;
            }
            
            showToast('ğŸ“„ ç”¢ç”Ÿ PDF ä¸­...');
            
            const { jsPDF } = window.jspdf;
            const sortedPages = Array.from(selectedPdfPages).sort((a, b) => a - b);
            
            let pdf = null;
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            for (let i = 0; i < sortedPages.length; i++) {
                const pageNum = sortedPages[i];
                const pageData = pdfPages[pageNum - 1];
                
                tempCanvas.width = pageData.width;
                tempCanvas.height = pageData.height;
                tempCtx.putImageData(pageData, 0, 0);
                
                const imgData = tempCanvas.toDataURL('image/jpeg', 0.9);
                const width = pageData.width * 0.264583;
                const height = pageData.height * 0.264583;
                
                if (i === 0) {
                    pdf = new jsPDF({
                        orientation: width > height ? 'l' : 'p',
                        unit: 'mm',
                        format: [width, height]
                    });
                } else {
                    pdf.addPage([width, height], width > height ? 'l' : 'p');
                }
                
                pdf.addImage(imgData, 'JPEG', 0, 0, width, height);
            }
            
            pdf.save(`merged-${sortedPages.length}pages.pdf`);
            showToast('âœ… PDF å·²ä¸‹è¼‰ï¼å…± ' + sortedPages.length + ' é ');
        }
        
        // ===== æµ®æ°´å°åŠŸèƒ½ =====
        let watermarkImage = null;
        let wmPosition = 'center';
        
        function showWatermarkPanel() {
            const panel = document.getElementById('watermarkPanel');
            panel.classList.toggle('show');
            document.getElementById('watermarkBtn').classList.toggle('active', panel.classList.contains('show'));
        }
        
        // åˆå§‹åŒ–æµ®æ°´å°æ§åˆ¶é …äº‹ä»¶
        function initWatermarkEvents() {
            // æ–‡å­—/åœ–ç‰‡åˆ‡æ›
            document.querySelectorAll('input[name="wmType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('wmTextOptions').style.display = this.value === 'text' ? 'block' : 'none';
                    document.getElementById('wmImageOptions').style.display = this.value === 'image' ? 'block' : 'none';
                });
            });
            
            // è§’åº¦é¡¯ç¤º
            const angleInput = document.getElementById('wmAngle');
            if (angleInput) {
                angleInput.addEventListener('input', function() {
                    document.getElementById('wmAngleValue').textContent = this.value + 'Â°';
                });
            }
            
            // åœ–ç‰‡å¤§å°é¡¯ç¤º
            const sizeInput = document.getElementById('wmImageSize');
            if (sizeInput) {
                sizeInput.addEventListener('input', function() {
                    document.getElementById('wmImageSizeValue').textContent = this.value + '%';
                });
            }
            
            // ä½ç½®é¸æ“‡
            document.querySelectorAll('.pos-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.pos-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    wmPosition = this.dataset.pos;
                });
            });
        }
        
        function loadWatermarkImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    watermarkImage = img;
                    document.getElementById('wmImagePreview').innerHTML = `<img src="${event.target.result}" alt="æµ®æ°´å°">`;
                    showToast('âœ… æµ®æ°´å°åœ–ç‰‡å·²è¼‰å…¥');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function addWatermark() {
            const wmType = document.querySelector('input[name="wmType"]:checked').value;
            const isTile = document.getElementById('wmTile').checked;
            
            if (wmType === 'text') {
                addTextWatermark(isTile);
            } else {
                addImageWatermark(isTile);
            }
        }
        
        function addTextWatermark(isTile) {
            const text = document.getElementById('wmText').value.trim();
            if (!text) {
                showToast('âš ï¸ è«‹è¼¸å…¥æµ®æ°´å°æ–‡å­—');
                return;
            }
            
            const fontSize = parseInt(document.getElementById('wmFontSize').value) || 48;
            const color = document.getElementById('wmColor').value;
            const opacity = parseFloat(document.getElementById('wmOpacity').value);
            const angle = parseInt(document.getElementById('wmAngle').value);
            
            if (isTile) {
                // å¹³é‹ªæ¨¡å¼ç›´æ¥ç¹ªè£½
                saveHistory();
                
                ctx.save();
                ctx.globalAlpha = opacity;
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.fillStyle = color;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const textWidth = ctx.measureText(text).width;
                const gap = textWidth + 50;
                const rows = Math.ceil(canvas.height / (fontSize + 80));
                const cols = Math.ceil(canvas.width / gap) + 2;
                
                for (let r = -1; r <= rows; r++) {
                    for (let c = -1; c <= cols; c++) {
                        const x = c * gap;
                        const y = r * (fontSize + 80);
                        ctx.save();
                        ctx.translate(x, y);
                        ctx.rotate(angle * Math.PI / 180);
                        ctx.fillText(text, 0, 0);
                        ctx.restore();
                    }
                }
                ctx.restore();
                showToast('âœ¨ æµ®æ°´å°å·²åŠ ä¸Šï¼');
            } else {
                // å–®ä¸€æ¨¡å¼ä½¿ç”¨æ‹–æ›³ï¼Œä¹å®®æ ¼ä½œç‚ºåˆå§‹ä½ç½®
                createDragObject('watermark', text, { 
                    fontSize, 
                    color, 
                    opacity, 
                    angle 
                }, wmPosition);
            }
        }
        
        function addImageWatermark(isTile) {
            if (!watermarkImage) {
                showToast('âš ï¸ è«‹å…ˆé¸æ“‡æµ®æ°´å°åœ–ç‰‡');
                return;
            }
            
            saveHistory(); // å„²å­˜æ­·å²ä¾›å¾©åŸ
            
            const sizePercent = parseInt(document.getElementById('wmImageSize').value) / 100;
            const opacity = parseFloat(document.getElementById('wmImageOpacity').value);
            
            const wmWidth = canvas.width * sizePercent;
            const wmHeight = (watermarkImage.height / watermarkImage.width) * wmWidth;
            
            ctx.save();
            ctx.globalAlpha = opacity;
            
            if (isTile) {
                // å¹³é‹ªæ¨¡å¼
                const gapX = wmWidth + 30;
                const gapY = wmHeight + 30;
                const rows = Math.ceil(canvas.height / gapY) + 1;
                const cols = Math.ceil(canvas.width / gapX) + 1;
                
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        ctx.drawImage(watermarkImage, c * gapX, r * gapY, wmWidth, wmHeight);
                    }
                }
            } else {
                // å–®ä¸€ä½ç½®
                const pos = getWatermarkPosition(wmWidth, wmHeight);
                ctx.drawImage(watermarkImage, pos.x - wmWidth/2, pos.y - wmHeight/2, wmWidth, wmHeight);
            }
            
            ctx.restore();
            
            // æ›´æ–° PDF æš«å­˜
            if (pdfDoc && pdfPages[currentPageNum - 1]) {
                pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            showToast('âœ¨ åœ–ç‰‡æµ®æ°´å°å·²åŠ ä¸Šï¼');
        }
        
        function getWatermarkPosition(w, h) {
            const padding = 20;
            const positions = {
                'top-left': { x: padding + w/2, y: padding + h/2 },
                'top-center': { x: canvas.width/2, y: padding + h/2 },
                'top-right': { x: canvas.width - padding - w/2, y: padding + h/2 },
                'middle-left': { x: padding + w/2, y: canvas.height/2 },
                'center': { x: canvas.width/2, y: canvas.height/2 },
                'middle-right': { x: canvas.width - padding - w/2, y: canvas.height/2 },
                'bottom-left': { x: padding + w/2, y: canvas.height - padding - h/2 },
                'bottom-center': { x: canvas.width/2, y: canvas.height - padding - h/2 },
                'bottom-right': { x: canvas.width - padding - w/2, y: canvas.height - padding - h/2 }
            };
            return positions[wmPosition] || positions['center'];
        }
        
        // AI å»é™¤æµ®æ°´å°
        async function removeWatermarkAI() {
            if (!currentSelection) {
                showToast('âš ï¸ è«‹å…ˆç”¨ã€Œé¸å–ã€å·¥å…·æ¡†é¸æµ®æ°´å°å€åŸŸ');
                return;
            }
            
            if (!settings.geminiApiKey) {
                showToast('âš ï¸ è«‹å…ˆè¨­å®š Gemini API Key');
                showPage('settings');
                return;
            }
            
            showToast('ğŸ¤– AI åˆ†æä¸­...');
            
            try {
                // å–å¾—é¸å–å€åŸŸçš„åœ–ç‰‡
                const { x, y, w, h } = currentSelection;
                const selectedData = ctx.getImageData(x, y, w, h);
                
                // å»ºç«‹è‡¨æ™‚ canvas
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = w;
                tempCanvas.height = h;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.putImageData(selectedData, 0, 0);
                
                const imageData = tempCanvas.toDataURL('image/jpeg', 0.9).split(',')[1];
                
                const model = document.getElementById('wmRemoveModel').value;
                const apiModel = model === 'gemini-2.5-flash' ? 'gemini-2.5-flash-preview-05-20' : 'gemini-2.0-flash';
                
                // è«‹æ±‚ AI åˆ†æèƒŒæ™¯é¡è‰²
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${apiModel}:generateContent?key=${settings.geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: 'é€™å¼µåœ–ç‰‡æœ‰æµ®æ°´å°ã€‚è«‹åˆ†ææµ®æ°´å°èƒŒå¾Œçš„èƒŒæ™¯é¡è‰²ã€‚åªå›ç­”ä¸€å€‹ HEX é¡è‰²ä»£ç¢¼ï¼ˆå¦‚ #FFFFFFï¼‰ï¼Œä¸è¦å…¶ä»–æ–‡å­—ã€‚' },
                                { inline_data: { mime_type: 'image/jpeg', data: imageData } }
                            ]
                        }]
                    })
                });
                
                if (!response.ok) throw new Error('AI åˆ†æå¤±æ•—');
                
                const data = await response.json();
                let bgColor = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '#FFFFFF';
                
                // ç¢ºä¿æ˜¯æœ‰æ•ˆçš„é¡è‰²
                if (!bgColor.startsWith('#')) {
                    bgColor = '#' + bgColor;
                }
                bgColor = bgColor.substring(0, 7);
                
                // ç”¨åˆ†æå‡ºçš„é¡è‰²å¡«å……
                ctx.fillStyle = bgColor;
                ctx.fillRect(x, y, w, h);
                
                // æ›´æ–° PDF æš«å­˜
                if (pdfDoc && pdfPages[currentPageNum - 1]) {
                    pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
                }
                
                // æ¸…é™¤é¸å–æ¡†
                currentSelection = null;
                document.getElementById('selectionBox').style.display = 'none';
                
                showToast('âœ… æµ®æ°´å°å·²ç§»é™¤ï¼(èƒŒæ™¯è‰²: ' + bgColor + ')');
            } catch (e) {
                showToast('âŒ ' + e.message);
            }
        }
        
        // æ‰‹å‹•å¡«è‰²å»é™¤æµ®æ°´å°
        function removeWatermarkManual() {
            if (!currentSelection) {
                showToast('âš ï¸ è«‹å…ˆç”¨ã€Œé¸å–ã€å·¥å…·æ¡†é¸æµ®æ°´å°å€åŸŸ');
                return;
            }
            
            const bgColor = document.getElementById('bgColor').value;
            const { x, y, w, h } = currentSelection;
            
            ctx.fillStyle = bgColor;
            ctx.fillRect(x, y, w, h);
            
            // æ›´æ–° PDF æš«å­˜
            if (pdfDoc && pdfPages[currentPageNum - 1]) {
                pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            // æ¸…é™¤é¸å–æ¡†
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            
            showToast('âœ… å·²ç”¨èƒŒæ™¯è‰²è¦†è“‹ï¼');
        }
        
        // ===== æ­·å²è¨˜éŒ„ï¼ˆå¾©åŸåŠŸèƒ½ï¼‰ =====
        let historyStack = [];
        const MAX_HISTORY = 20;
        
        function saveHistory() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            historyStack.push({
                data: imageData,
                width: canvas.width,
                height: canvas.height
            });
            if (historyStack.length > MAX_HISTORY) {
                historyStack.shift();
            }
        }
        
        function undoAction() {
            if (historyStack.length <= 1) {
                showToast('âš ï¸ ç„¡æ³•å†å¾©åŸ');
                return;
            }
            historyStack.pop(); // ç§»é™¤ç•¶å‰ç‹€æ…‹
            const prev = historyStack[historyStack.length - 1];
            canvas.width = prev.width;
            canvas.height = prev.height;
            ctx.putImageData(prev.data, 0, 0);
            showToast('â†©ï¸ å·²å¾©åŸ');
        }
        
        // é‡ç½®ç•«å¸ƒï¼ˆæ¸…ç©ºé‡ä¾†ï¼‰
        function resetCanvas() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºç•«å¸ƒé‡æ–°é–‹å§‹å—ï¼Ÿ')) return;
            
            // éš±è—ç•«å¸ƒ
            document.getElementById('canvasWrapper').classList.remove('show');
            document.getElementById('uploadZone').classList.remove('hidden');
            
            // æ¸…ç©ºç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.width = 800;
            canvas.height = 600;
            
            // é‡ç½®ç‹€æ…‹
            historyStack = [];
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            
            // é‡ç½® PDF
            pdfDoc = null;
            pdfPages = [];
            currentPageNum = 1;
            document.getElementById('pdfControls').style.display = 'none';
            document.getElementById('pdfToolBtn').style.display = 'none';
            
            // åœç”¨æ‰€æœ‰å·¥å…·æŒ‰éˆ•
            const btns = ['selectBtn', 'clearBtn', 'undoBtn', 'resetBtn', 'aiBtn', 'watermarkBtn', 
                'mosaicBtn', 'stampBtn', 'signBtn', 'filterBtn', 'adjustBtn', 'frameBtn', 
                'stickerBtn', 'arrowBtn', 'rotateBtn', 'flipHBtn', 'flipVBtn', 'cropBtn', 
                'mergeBtn', 'qrBtn', 'compressBtn', 'brushBtn', 'shapeBtn', 'textFxBtn',
                'templateBtn', 'collageBtn', 'beautyBtn', 'removeBgBtn', 'batchBtn', 
                'effectBtn', 'overlayBtn', 'annotateBtn', 'historyBtn', 'infoBtn'];
            btns.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = true;
            });
            
            showToast('ğŸ—‘ï¸ å·²æ¸…ç©ºï¼Œè«‹é‡æ–°ä¸Šå‚³åœ–ç‰‡');
        }
        
        // ===== é¦¬è³½å…‹åŠŸèƒ½ =====
        function applyMosaic() {
            if (!currentSelection) return;
            
            saveHistory();
            // ç¢ºä¿åº§æ¨™ç‚ºæ•´æ•¸
            const x = Math.round(currentSelection.x);
            const y = Math.round(currentSelection.y);
            const w = Math.round(currentSelection.w);
            const h = Math.round(currentSelection.h);
            
            if (w < 1 || h < 1) return;
            
            const blockSize = 10;
            const imageData = ctx.getImageData(x, y, w, h);
            const data = imageData.data;
            
            for (let by = 0; by < h; by += blockSize) {
                for (let bx = 0; bx < w; bx += blockSize) {
                    let r = 0, g = 0, b = 0, count = 0;
                    
                    for (let py = by; py < Math.min(by + blockSize, h); py++) {
                        for (let px = bx; px < Math.min(bx + blockSize, w); px++) {
                            const i = (py * w + px) * 4;
                            r += data[i];
                            g += data[i + 1];
                            b += data[i + 2];
                            count++;
                        }
                    }
                    
                    r = Math.floor(r / count);
                    g = Math.floor(g / count);
                    b = Math.floor(b / count);
                    
                    for (let py = by; py < Math.min(by + blockSize, h); py++) {
                        for (let px = bx; px < Math.min(bx + blockSize, w); px++) {
                            const i = (py * w + px) * 4;
                            data[i] = r;
                            data[i + 1] = g;
                            data[i + 2] = b;
                        }
                    }
                }
            }
            
            ctx.putImageData(imageData, x, y);
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            showToast('ğŸ”² é¦¬è³½å…‹å·²å¥—ç”¨');
        }
        
        // ===== åœ–ç« åŠŸèƒ½ =====
        function showStampPanel() {
            const panel = document.getElementById('stampPanel');
            const isShowing = panel.classList.contains('show');
            
            // å¦‚æœæ­£åœ¨é—œé–‰é¢æ¿ï¼ŒåŒæ™‚å–æ¶ˆæ”¾ç½®æ¨¡å¼
            if (isShowing) {
                cancelStampPlacement();
            }
            
            togglePanel('stampPanel', 'stampBtn');
        }
        
        // åœ–ç« ç‹€æ…‹
        let stampPosition = 'center';
        let pendingStamp = null; // å¾…æ”¾ç½®çš„åœ–ç« 
        let stampDragMode = false;
        
        function addStamp(text) {
            if (!text) {
                showToast('âš ï¸ è«‹è¼¸å…¥åœ–ç« æ–‡å­—');
                return;
            }
            
            const size = parseInt(document.getElementById('stampSize').value);
            const color = document.getElementById('stampColor').value;
            
            // ä½¿ç”¨ä¹å®®æ ¼ä½ç½®ä½œç‚ºåˆå§‹ä½ç½®
            createDragObject('stamp', text, { fontSize: size, color: color }, stampPosition);
        }
        
        function placeStampAt(text, clickX, clickY) {
            // ä¿ç•™çµ¦èˆŠä»£ç¢¼å…¼å®¹
            const size = parseInt(document.getElementById('stampSize').value);
            const color = document.getElementById('stampColor').value;
            createDragObject('stamp', text, { fontSize: size, color: color }, stampPosition);
            pendingStamp = null;
            stampDragMode = false;
            canvas.style.cursor = 'default';
        }
        
        function setStampPosition(pos, btn) {
            stampPosition = pos;
            document.querySelectorAll('#stampPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function cancelStampPlacement() {
            // å–æ¶ˆä»»ä½•æ‹–æ›³ä¸­çš„ç‰©ä»¶
            if (currentDragObject) {
                removeDragObject();
                showToast('âŒ æ”¾ç½®å·²å–æ¶ˆ');
            }
        }
        
        // ===== ç°½ååŠŸèƒ½ =====
        let signCtx = null;
        let isDrawingSign = false;
        let signPosition = 'bottom-right';
        
        function showSignPanel() {
            const panel = document.getElementById('signPanel');
            const isShowing = panel.classList.contains('show');
            
            // å¦‚æœæ­£åœ¨é—œé–‰é¢æ¿ï¼ŒåŒæ™‚å–æ¶ˆæ”¾ç½®æ¨¡å¼
            if (isShowing) {
                cancelSignPlacement();
            }
            
            togglePanel('signPanel', 'signBtn');
            if (!isShowing) {
                initSignCanvas();
            }
        }
        
        function initSignCanvas() {
            const signCanvas = document.getElementById('signCanvas');
            signCtx = signCanvas.getContext('2d');
            signCtx.fillStyle = 'white';
            signCtx.fillRect(0, 0, signCanvas.width, signCanvas.height);
            
            signCanvas.onmousedown = startSign;
            signCanvas.onmousemove = drawSign;
            signCanvas.onmouseup = () => isDrawingSign = false;
            signCanvas.onmouseleave = () => isDrawingSign = false;
            
            signCanvas.ontouchstart = (e) => { e.preventDefault(); startSign(e.touches[0]); };
            signCanvas.ontouchmove = (e) => { e.preventDefault(); drawSign(e.touches[0]); };
            signCanvas.ontouchend = () => isDrawingSign = false;
        }
        
        function startSign(e) {
            isDrawingSign = true;
            const rect = document.getElementById('signCanvas').getBoundingClientRect();
            signCtx.beginPath();
            signCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        
        function drawSign(e) {
            if (!isDrawingSign) return;
            const rect = document.getElementById('signCanvas').getBoundingClientRect();
            const lineWidth = document.getElementById('signLineWidth').value;
            const color = document.getElementById('signColor').value;
            
            signCtx.lineWidth = lineWidth;
            signCtx.strokeStyle = color;
            signCtx.lineCap = 'round';
            signCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            signCtx.stroke();
        }
        
        function clearSignature() {
            const signCanvas = document.getElementById('signCanvas');
            signCtx.fillStyle = 'white';
            signCtx.fillRect(0, 0, signCanvas.width, signCanvas.height);
        }
        
        // ç°½åæ‹–æ›³ç›¸é—œ
        let signDragMode = false;
        let pendingSign = null;
        
        function applySignature() {
            const signCanvas = document.getElementById('signCanvas');
            const signData = signCanvas.toDataURL();
            
            // ä½¿ç”¨ä¹å®®æ ¼ä½ç½®ä½œç‚ºåˆå§‹ä½ç½®
            createDragObject('sign', signData, {}, signPosition);
        }
        
        function placeSignAt(clickX, clickY) {
            // ä¿ç•™çµ¦èˆŠä»£ç¢¼å…¼å®¹
            const signCanvas = document.getElementById('signCanvas');
            const signData = pendingSign || signCanvas.toDataURL();
            createDragObject('sign', signData, {}, signPosition);
            pendingSign = null;
            signDragMode = false;
            canvas.style.cursor = 'default';
        }
        
        function setSignPosition(pos, btn) {
            signPosition = pos;
            document.querySelectorAll('#signPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function cancelSignPlacement() {
            // å–æ¶ˆä»»ä½•æ‹–æ›³ä¸­çš„ç‰©ä»¶
            if (currentDragObject) {
                removeDragObject();
                showToast('âŒ æ”¾ç½®å·²å–æ¶ˆ');
            }
        }
        
        // ===== æ¿¾é¡åŠŸèƒ½ =====
        let originalForFilter = null;
        
        function showFilterPanel() {
            togglePanel('filterPanel', 'filterBtn');
            if (!originalForFilter) {
                originalForFilter = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            // åˆå§‹åŒ–é è¦½ç•«å¸ƒ
            const previewCanvas = document.getElementById('filterPreview');
            if (previewCanvas) {
                const previewCtx = previewCanvas.getContext('2d');
                previewCtx.drawImage(canvas, 0, 0, previewCanvas.width, previewCanvas.height);
            }
        }
        
        // æ¿¾é¡é è¦½å‡½æ•¸
        function previewFilter(type) {
            const previewCanvas = document.getElementById('filterPreview');
            const previewCtx = previewCanvas.getContext('2d');
            const nameSpan = document.getElementById('filterPreviewName');
            
            const filterNames = {
                'none': 'åŸåœ–', 'grayscale': 'é»‘ç™½', 'sepia': 'å¾©å¤', 'invert': 'åè½‰',
                'blur': 'æ¨¡ç³Š', 'sharpen': 'éŠ³åŒ–', 'brightness': 'æ˜äº®', 'contrast': 'å°æ¯”',
                'saturate': 'é®®è±”', 'cool': 'å†·è‰²', 'warm': 'æš–è‰²', 'vintage': 'æ‡·èˆŠ'
            };
            nameSpan.textContent = filterNames[type] || type;
            
            // ç¸®å°ç¹ªè£½åˆ°é è¦½ç•«å¸ƒ
            previewCtx.drawImage(canvas, 0, 0, previewCanvas.width, previewCanvas.height);
            
            if (type === 'none') return;
            
            const imageData = previewCtx.getImageData(0, 0, previewCanvas.width, previewCanvas.height);
            const data = imageData.data;
            
            switch(type) {
                case 'grayscale':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = data[i+1] = data[i+2] = avg;
                    }
                    break;
                case 'sepia':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i], g = data[i+1], b = data[i+2];
                        data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
                        data[i+1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                        data[i+2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
                    }
                    break;
                case 'invert':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];
                        data[i+1] = 255 - data[i+1];
                        data[i+2] = 255 - data[i+2];
                    }
                    break;
                case 'brightness':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] + 50);
                        data[i+1] = Math.min(255, data[i+1] + 50);
                        data[i+2] = Math.min(255, data[i+2] + 50);
                    }
                    break;
                case 'contrast':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, Math.max(0, (data[i] - 128) * 1.5 + 128));
                        data[i+1] = Math.min(255, Math.max(0, (data[i+1] - 128) * 1.5 + 128));
                        data[i+2] = Math.min(255, Math.max(0, (data[i+2] - 128) * 1.5 + 128));
                    }
                    break;
                case 'saturate':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = Math.min(255, avg + (data[i] - avg) * 2);
                        data[i+1] = Math.min(255, avg + (data[i+1] - avg) * 2);
                        data[i+2] = Math.min(255, avg + (data[i+2] - avg) * 2);
                    }
                    break;
                case 'cool':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.max(0, data[i] - 20);
                        data[i+2] = Math.min(255, data[i+2] + 20);
                    }
                    break;
                case 'warm':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] + 20);
                        data[i+2] = Math.max(0, data[i+2] - 20);
                    }
                    break;
                case 'vintage':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * 0.9 + 40);
                        data[i+1] = Math.min(255, data[i+1] * 0.8 + 20);
                        data[i+2] = Math.min(255, data[i+2] * 0.7);
                    }
                    break;
                case 'blur':
                    previewCtx.filter = 'blur(2px)';
                    previewCtx.drawImage(previewCanvas, 0, 0);
                    previewCtx.filter = 'none';
                    return;
            }
            
            previewCtx.putImageData(imageData, 0, 0);
        }
        
        function applyFilter(type) {
            if (!originalForFilter) {
                originalForFilter = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            saveHistory();
            
            // å…ˆé‚„åŸ
            ctx.putImageData(originalForFilter, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            switch(type) {
                case 'none':
                    break;
                case 'grayscale':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = data[i+1] = data[i+2] = avg;
                    }
                    break;
                case 'sepia':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i], g = data[i+1], b = data[i+2];
                        data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
                        data[i+1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                        data[i+2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
                    }
                    break;
                case 'invert':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];
                        data[i+1] = 255 - data[i+1];
                        data[i+2] = 255 - data[i+2];
                    }
                    break;
                case 'brightness':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] + 50);
                        data[i+1] = Math.min(255, data[i+1] + 50);
                        data[i+2] = Math.min(255, data[i+2] + 50);
                    }
                    break;
                case 'contrast':
                    const factor = 1.5;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, Math.max(0, (data[i] - 128) * factor + 128));
                        data[i+1] = Math.min(255, Math.max(0, (data[i+1] - 128) * factor + 128));
                        data[i+2] = Math.min(255, Math.max(0, (data[i+2] - 128) * factor + 128));
                    }
                    break;
                case 'saturate':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = Math.min(255, avg + (data[i] - avg) * 2);
                        data[i+1] = Math.min(255, avg + (data[i+1] - avg) * 2);
                        data[i+2] = Math.min(255, avg + (data[i+2] - avg) * 2);
                    }
                    break;
                case 'cool':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.max(0, data[i] - 20);
                        data[i+2] = Math.min(255, data[i+2] + 20);
                    }
                    break;
                case 'warm':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] + 20);
                        data[i+2] = Math.max(0, data[i+2] - 20);
                    }
                    break;
                case 'vintage':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i], g = data[i+1], b = data[i+2];
                        data[i] = Math.min(255, r * 0.9 + 40);
                        data[i+1] = Math.min(255, g * 0.7 + 20);
                        data[i+2] = Math.min(255, b * 0.5);
                    }
                    break;
                case 'blur':
                    // ç°¡å–®æ¨¡ç³Š
                    ctx.putImageData(imageData, 0, 0);
                    ctx.filter = 'blur(3px)';
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                    showToast('ğŸ¨ æ¿¾é¡å·²å¥—ç”¨');
                    return;
                case 'sharpen':
                    // éŠ³åŒ–æ•ˆæœ
                    ctx.putImageData(imageData, 0, 0);
                    ctx.filter = 'contrast(1.2)';
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                    showToast('ğŸ¨ æ¿¾é¡å·²å¥—ç”¨');
                    return;
            }
            
            ctx.putImageData(imageData, 0, 0);
            originalForFilter = ctx.getImageData(0, 0, canvas.width, canvas.height);
            showToast('ğŸ¨ æ¿¾é¡å·²å¥—ç”¨');
        }
        
        // ===== è‰²å½©èª¿æ•´ =====
        function showAdjustPanel() {
            togglePanel('adjustPanel', 'adjustBtn');
            initAdjustSliders();
        }
        
        function initAdjustSliders() {
            ['Brightness', 'Contrast', 'Saturation', 'Hue'].forEach(name => {
                const slider = document.getElementById('adjust' + name);
                const label = document.getElementById(name.toLowerCase() + 'Val');
                if (slider && label) {
                    slider.oninput = function() {
                        label.textContent = name === 'Hue' ? this.value + 'Â°' : this.value;
                    };
                }
            });
        }
        
        function resetAdjustments() {
            document.getElementById('adjustBrightness').value = 0;
            document.getElementById('adjustContrast').value = 0;
            document.getElementById('adjustSaturation').value = 0;
            document.getElementById('adjustHue').value = 0;
            document.getElementById('brightnessVal').textContent = '0';
            document.getElementById('contrastVal').textContent = '0';
            document.getElementById('saturationVal').textContent = '0';
            document.getElementById('hueVal').textContent = '0Â°';
        }
        
        function applyAdjustments() {
            saveHistory();
            const brightness = parseInt(document.getElementById('adjustBrightness').value);
            const contrast = parseInt(document.getElementById('adjustContrast').value);
            const saturation = parseInt(document.getElementById('adjustSaturation').value);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            const contrastFactor = (contrast + 100) / 100;
            
            for (let i = 0; i < data.length; i += 4) {
                // äº®åº¦
                data[i] = Math.min(255, Math.max(0, data[i] + brightness));
                data[i+1] = Math.min(255, Math.max(0, data[i+1] + brightness));
                data[i+2] = Math.min(255, Math.max(0, data[i+2] + brightness));
                
                // å°æ¯”
                data[i] = Math.min(255, Math.max(0, (data[i] - 128) * contrastFactor + 128));
                data[i+1] = Math.min(255, Math.max(0, (data[i+1] - 128) * contrastFactor + 128));
                data[i+2] = Math.min(255, Math.max(0, (data[i+2] - 128) * contrastFactor + 128));
                
                // é£½å’Œåº¦
                const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                const satFactor = (saturation + 100) / 100;
                data[i] = Math.min(255, Math.max(0, avg + (data[i] - avg) * satFactor));
                data[i+1] = Math.min(255, Math.max(0, avg + (data[i+1] - avg) * satFactor));
                data[i+2] = Math.min(255, Math.max(0, avg + (data[i+2] - avg) * satFactor));
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸŒˆ èª¿æ•´å·²å¥—ç”¨');
        }
        
        // ===== é‚Šæ¡†åŠŸèƒ½ =====
        function showFramePanel() {
            togglePanel('framePanel', 'frameBtn');
        }
        
        function addFrame(type) {
            saveHistory();
            const frameWidth = parseInt(document.getElementById('frameWidth').value);
            const frameColor = document.getElementById('frameColor').value;
            
            // å»ºç«‹æ–°ç•«å¸ƒ
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            if (type === 'none') {
                showToast('ğŸ–¼ï¸ é‚Šæ¡†å·²ç§»é™¤');
                return;
            }
            
            const padding = type === 'polaroid' ? frameWidth * 3 : frameWidth;
            const bottomPadding = type === 'polaroid' ? frameWidth * 5 : padding;
            
            tempCanvas.width = canvas.width + padding * 2;
            tempCanvas.height = canvas.height + padding + bottomPadding;
            
            // å¡«å……èƒŒæ™¯
            tempCtx.fillStyle = frameColor;
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // åŠ å…¥é™°å½±
            if (type === 'shadow') {
                tempCtx.shadowColor = 'rgba(0,0,0,0.5)';
                tempCtx.shadowBlur = 20;
                tempCtx.shadowOffsetX = 10;
                tempCtx.shadowOffsetY = 10;
            }
            
            // åœ“è§’
            if (type === 'rounded') {
                tempCtx.beginPath();
                const r = 20;
                tempCtx.roundRect(padding, padding, canvas.width, canvas.height, r);
                tempCtx.clip();
            }
            
            // ç•«åŸåœ–
            tempCtx.drawImage(canvas, padding, padding);
            
            // æ›´æ–°ä¸»ç•«å¸ƒ
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('ğŸ–¼ï¸ é‚Šæ¡†å·²åŠ ä¸Š');
        }
        
        // ===== è²¼åœ–åŠŸèƒ½ =====
        const stickers = {
            emoji: ['ğŸ˜€','ğŸ˜‚','ğŸ¥°','ğŸ˜','ğŸ¤”','ğŸ˜±','ğŸ¥³','ğŸ˜´','ğŸ¤®','ğŸ‘','ğŸ‘','ğŸ‘','ğŸ™','ğŸ’ª','â¤ï¸','ğŸ’”','ğŸ”¥','â­','ğŸ’¯','ğŸ‰'],
            symbol: ['âœ“','âœ—','â˜…','â˜†','â™ ','â™£','â™¥','â™¦','â™ª','â™«','â˜€','â˜','â˜‚','âš¡','â„','â˜','âœ‰','âœ‚','âœ','âŒ›'],
            shape: ['â—','â—‹','â– ','â–¡','â–²','â–³','â–¼','â–½','â—†','â—‡','â˜…','â˜†','âœ¦','âœ§','â¤','â™¥','â—‰','â—','â¬¤','â¬¡']
        };
        
        // è²¼åœ–ç‹€æ…‹
        let stickerPosition = 'center';
        let pendingSticker = null;
        let stickerDragMode = false;
        
        function showStickerPanel() {
            const panel = document.getElementById('stickerPanel');
            const isShowing = panel.classList.contains('show');
            
            // å¦‚æœæ­£åœ¨é—œé–‰é¢æ¿ï¼ŒåŒæ™‚å–æ¶ˆæ”¾ç½®æ¨¡å¼
            if (isShowing) {
                cancelStickerPlacement();
            }
            
            togglePanel('stickerPanel', 'stickerBtn');
            if (!isShowing) {
                showStickerTab('emoji');
            }
        }
        
        function showStickerTab(tab) {
            document.querySelectorAll('.sticker-tab').forEach(t => t.classList.remove('active'));
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            }
            
            const grid = document.getElementById('stickerGrid');
            grid.innerHTML = '';
            
            stickers[tab].forEach(s => {
                const item = document.createElement('button');
                item.className = 'sticker-item';
                item.textContent = s;
                item.onclick = () => addSticker(s);
                grid.appendChild(item);
            });
        }
        
        function addSticker(sticker) {
            const size = parseInt(document.getElementById('stickerSize').value);
            // ä½¿ç”¨ä¹å®®æ ¼ä½ç½®ä½œç‚ºåˆå§‹ä½ç½®
            createDragObject('sticker', sticker, { size }, stickerPosition);
        }
        
        function placeStickerAt(sticker, clickX, clickY) {
            // ä¿ç•™çµ¦èˆŠä»£ç¢¼å…¼å®¹
            const size = parseInt(document.getElementById('stickerSize').value);
            createDragObject('sticker', sticker, { size }, stickerPosition);
            pendingSticker = null;
            stickerDragMode = false;
            canvas.style.cursor = 'default';
        }
        
        function setStickerPosition(pos, btn) {
            stickerPosition = pos;
            document.querySelectorAll('#stickerPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function cancelStickerPlacement() {
            // å–æ¶ˆä»»ä½•æ‹–æ›³ä¸­çš„ç‰©ä»¶
            if (currentDragObject) {
                removeDragObject();
                showToast('âŒ æ”¾ç½®å·²å–æ¶ˆ');
            }
        }
        
        // ===== æ‹–æ›³æ”¾ç½®ç³»çµ± =====
        
        // æ ¹æ“šä¹å®®æ ¼ä½ç½®è¨ˆç®—åº§æ¨™
        function getPositionCoords(position, objWidth, objHeight, canvasW, canvasH) {
            const padding = 30;
            let x, y;
            
            switch(position) {
                case 'top-left': 
                    x = padding + objWidth/2; 
                    y = padding + objHeight/2; 
                    break;
                case 'top-center': 
                    x = canvasW / 2; 
                    y = padding + objHeight/2; 
                    break;
                case 'top-right': 
                    x = canvasW - padding - objWidth/2; 
                    y = padding + objHeight/2; 
                    break;
                case 'middle-left': 
                    x = padding + objWidth/2; 
                    y = canvasH / 2; 
                    break;
                case 'center': 
                    x = canvasW / 2; 
                    y = canvasH / 2; 
                    break;
                case 'middle-right': 
                    x = canvasW - padding - objWidth/2; 
                    y = canvasH / 2; 
                    break;
                case 'bottom-left': 
                    x = padding + objWidth/2; 
                    y = canvasH - padding - objHeight/2; 
                    break;
                case 'bottom-center': 
                    x = canvasW / 2; 
                    y = canvasH - padding - objHeight/2; 
                    break;
                case 'bottom-right': 
                    x = canvasW - padding - objWidth/2; 
                    y = canvasH - padding - objHeight/2; 
                    break;
                default: 
                    x = canvasW / 2; 
                    y = canvasH / 2;
            }
            
            return { x, y };
        }
        
        // å‰µå»ºå¯æ‹–æ›³ç‰©ä»¶
        function createDragObject(type, content, options = {}, position = 'center') {
            // ç§»é™¤ä¹‹å‰çš„æ‹–æ›³ç‰©ä»¶
            removeDragObject();
            
            const dragLayer = document.getElementById('dragLayer');
            const container = document.getElementById('canvasContainer');
            const canvasRect = canvas.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            // è¨ˆç®—ç•«å¸ƒåœ¨å®¹å™¨ä¸­çš„åç§»
            const canvasOffsetX = canvasRect.left - containerRect.left + container.scrollLeft;
            const canvasOffsetY = canvasRect.top - containerRect.top + container.scrollTop;
            
            const obj = document.createElement('div');
            obj.className = 'drag-object';
            obj.dataset.type = type;
            obj.dataset.content = content;
            obj.dataset.options = JSON.stringify(options);
            
            // æ ¹æ“šé¡å‹è¨­å®šå…§å®¹å’Œå¤§å°
            let width, height;
            switch(type) {
                case 'sticker':
                    const stickerSize = options.size || 50;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${stickerSize}px">${content}</span>`;
                    width = stickerSize * 1.2;
                    height = stickerSize * 1.2;
                    break;
                case 'stamp':
                    const stampSize = options.fontSize || 24;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${stampSize}px;color:${options.color || '#ff0000'};font-weight:bold;border:3px solid ${options.color || '#ff0000'};padding:8px 15px;border-radius:8px;transform:rotate(-15deg)">${content}</span>`;
                    width = content.length * stampSize * 0.8 + 40;
                    height = stampSize * 2.5;
                    break;
                case 'text':
                    const textSize = options.fontSize || 24;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${textSize}px;color:${options.color || '#ffffff'}">${content}</span>`;
                    width = content.length * textSize * 0.7 + 20;
                    height = textSize * 1.5;
                    break;
                case 'qr':
                    obj.innerHTML = `<img src="${content}" style="width:${options.size || 100}px;height:${options.size || 100}px" crossorigin="anonymous">`;
                    width = options.size || 100;
                    height = options.size || 100;
                    break;
                case 'sign':
                    obj.innerHTML = `<img src="${content}" style="max-width:150px;max-height:80px">`;
                    width = 150;
                    height = 80;
                    break;
                case 'textfx':
                    // æ–‡å­—ç‰¹æ•ˆéœ€è¦ç‰¹æ®Šè™•ç†
                    const fxSize = options.fontSize || 60;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${fxSize}px;font-weight:bold;color:${options.color1 || '#ff0000'}">${content}</span>`;
                    width = content.length * fxSize * 0.7 + 30;
                    height = fxSize * 1.5;
                    break;
                case 'watermark':
                    const wmSize = options.fontSize || 48;
                    const wmOpacity = options.opacity || 0.5;
                    const wmAngle = options.angle || -30;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${wmSize}px;font-weight:bold;color:${options.color || '#ffffff'};opacity:${wmOpacity};transform:rotate(${wmAngle}deg)">${content}</span>`;
                    width = content.length * wmSize * 0.7 + 30;
                    height = wmSize * 2;
                    break;
                case 'quicktext':
                    const qtSize = options.fontSize || 24;
                    obj.innerHTML = `<span class="drag-object-text" style="font-size:${qtSize}px;color:${options.color || '#ffffff'};${options.bold ? 'font-weight:bold;' : ''}${options.italic ? 'font-style:italic;' : ''}">${content}</span>`;
                    width = content.length * qtSize * 0.6 + 20;
                    height = qtSize * 1.5;
                    break;
            }
            
            // æ ¹æ“šä¹å®®æ ¼ä½ç½®è¨ˆç®—åˆå§‹åº§æ¨™
            const scaleX = canvasRect.width / canvas.width;
            const scaleY = canvasRect.height / canvas.height;
            
            const posCoords = getPositionCoords(position, width, height, canvasRect.width, canvasRect.height);
            const initialX = canvasOffsetX + posCoords.x - width/2;
            const initialY = canvasOffsetY + posCoords.y - height/2;
            
            obj.style.left = initialX + 'px';
            obj.style.top = initialY + 'px';
            obj.style.width = width + 'px';
            obj.style.height = height + 'px';
            
            // æ·»åŠ æ‹–æ›³äº‹ä»¶
            obj.addEventListener('mousedown', startDragObject);
            obj.addEventListener('touchstart', startDragObjectTouch, { passive: false });
            
            dragLayer.appendChild(obj);
            currentDragObject = obj;
            
            // é¡¯ç¤ºæ§åˆ¶æŒ‰éˆ•
            document.getElementById('dragControls').classList.add('show');
            
            // æ›´æ–°ä½ç½®é¡¯ç¤º
            setTimeout(updateDragPositionInfo, 10);
            
            showToast('ğŸ¯ è‡ªç”±æ‹–æ›³èª¿æ•´ä½ç½® | æ–¹å‘éµå¾®èª¿ | Enter ç¢ºèª | ESC å–æ¶ˆ');
        }
        
        function startDragObject(e) {
            if (!currentDragObject) return;
            e.preventDefault();
            isDraggingObject = true;
            currentDragObject.classList.add('dragging');
            
            const rect = currentDragObject.getBoundingClientRect();
            dragOffsetX = e.clientX - rect.left;
            dragOffsetY = e.clientY - rect.top;
            
            document.addEventListener('mousemove', moveDragObject);
            document.addEventListener('mouseup', stopDragObject);
        }
        
        function startDragObjectTouch(e) {
            if (!currentDragObject) return;
            e.preventDefault();
            isDraggingObject = true;
            currentDragObject.classList.add('dragging');
            
            const touch = e.touches[0];
            const rect = currentDragObject.getBoundingClientRect();
            dragOffsetX = touch.clientX - rect.left;
            dragOffsetY = touch.clientY - rect.top;
            
            document.addEventListener('touchmove', moveDragObjectTouch, { passive: false });
            document.addEventListener('touchend', stopDragObject);
        }
        
        function moveDragObject(e) {
            if (!isDraggingObject || !currentDragObject) return;
            
            const container = document.getElementById('canvasContainer');
            const containerRect = container.getBoundingClientRect();
            
            let newX = e.clientX - containerRect.left - dragOffsetX + container.scrollLeft;
            let newY = e.clientY - containerRect.top - dragOffsetY + container.scrollTop;
            
            currentDragObject.style.left = newX + 'px';
            currentDragObject.style.top = newY + 'px';
            
            // å³æ™‚æ›´æ–°ä½ç½®é¡¯ç¤º
            updateDragPositionInfo();
        }
        
        function moveDragObjectTouch(e) {
            if (!isDraggingObject || !currentDragObject) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const container = document.getElementById('canvasContainer');
            const containerRect = container.getBoundingClientRect();
            
            let newX = touch.clientX - containerRect.left - dragOffsetX + container.scrollLeft;
            let newY = touch.clientY - containerRect.top - dragOffsetY + container.scrollTop;
            
            currentDragObject.style.left = newX + 'px';
            currentDragObject.style.top = newY + 'px';
            
            // å³æ™‚æ›´æ–°ä½ç½®é¡¯ç¤º
            updateDragPositionInfo();
        }
        
        function stopDragObject() {
            isDraggingObject = false;
            if (currentDragObject) {
                currentDragObject.classList.remove('dragging');
            }
            document.removeEventListener('mousemove', moveDragObject);
            document.removeEventListener('mouseup', stopDragObject);
            document.removeEventListener('touchmove', moveDragObjectTouch);
            document.removeEventListener('touchend', stopDragObject);
        }
        
        // ç¢ºèªæ”¾ç½®
        function confirmDragObject() {
            if (!currentDragObject) return;
            
            saveHistory();
            
            const container = document.getElementById('canvasContainer');
            const canvasRect = canvas.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            // è¨ˆç®—ç•«å¸ƒåœ¨å®¹å™¨ä¸­çš„åç§»
            const canvasOffsetX = canvasRect.left - containerRect.left + container.scrollLeft;
            const canvasOffsetY = canvasRect.top - containerRect.top + container.scrollTop;
            
            // ç²å–ç‰©ä»¶ä½ç½®ï¼ˆç›¸å°æ–¼å®¹å™¨ï¼‰
            const objLeft = parseFloat(currentDragObject.style.left);
            const objTop = parseFloat(currentDragObject.style.top);
            const objWidth = parseFloat(currentDragObject.style.width);
            const objHeight = parseFloat(currentDragObject.style.height);
            
            // è¨ˆç®—ä¸­å¿ƒé»ç›¸å°æ–¼ç•«å¸ƒçš„ä½ç½®
            const scaleX = canvas.width / canvasRect.width;
            const scaleY = canvas.height / canvasRect.height;
            
            const centerX = (objLeft + objWidth/2 - canvasOffsetX) * scaleX;
            const centerY = (objTop + objHeight/2 - canvasOffsetY) * scaleY;
            
            const type = currentDragObject.dataset.type;
            const content = currentDragObject.dataset.content;
            const options = JSON.parse(currentDragObject.dataset.options || '{}');
            
            // ç¹ªè£½åˆ°ç•«å¸ƒ
            switch(type) {
                case 'sticker':
                    ctx.font = `${options.size || 50}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(content, centerX, centerY);
                    break;
                case 'stamp':
                    drawStampAtPosition(content, centerX, centerY, options);
                    break;
                case 'text':
                    ctx.font = `${options.fontSize || 24}px sans-serif`;
                    ctx.fillStyle = options.color || '#ffffff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(content, centerX, centerY);
                    break;
                case 'qr':
                    const qrImg = currentDragObject.querySelector('img');
                    if (qrImg) {
                        const qrSize = options.size || 100;
                        ctx.drawImage(qrImg, centerX - qrSize/2, centerY - qrSize/2, qrSize, qrSize);
                    }
                    break;
                case 'sign':
                    const signImg = currentDragObject.querySelector('img');
                    if (signImg) {
                        const signW = signImg.naturalWidth || 150;
                        const signH = signImg.naturalHeight || 80;
                        const scale = Math.min(150/signW, 80/signH, 1);
                        ctx.drawImage(signImg, centerX - signW*scale/2, centerY - signH*scale/2, signW*scale, signH*scale);
                    }
                    break;
                case 'textfx':
                    applyTextFxDirect(options.style, content, centerX, centerY, options);
                    break;
                case 'watermark':
                    ctx.save();
                    ctx.globalAlpha = options.opacity || 0.5;
                    ctx.font = `bold ${options.fontSize || 48}px sans-serif`;
                    ctx.fillStyle = options.color || '#ffffff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.translate(centerX, centerY);
                    ctx.rotate((options.angle || -30) * Math.PI / 180);
                    ctx.fillText(content, 0, 0);
                    ctx.restore();
                    break;
                case 'quicktext':
                    ctx.save();
                    let fontStyle = '';
                    if (options.bold) fontStyle += 'bold ';
                    if (options.italic) fontStyle += 'italic ';
                    ctx.font = `${fontStyle}${options.fontSize || 24}px sans-serif`;
                    ctx.fillStyle = options.color || '#ffffff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(content, centerX, centerY);
                    ctx.restore();
                    break;
            }
            
            removeDragObject();
            showToast('âœ… å·²ç¢ºèªæ”¾ç½®');
        }
        
        // è¼”åŠ©å‡½æ•¸ï¼šåœ¨æŒ‡å®šä½ç½®ç¹ªè£½åœ–ç« 
        function drawStampAtPosition(text, x, y, options) {
            const fontSize = options.fontSize || 24;
            const color = options.color || '#ff0000';
            
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(-15 * Math.PI / 180);
            
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const textWidth = ctx.measureText(text).width;
            const padding = 15;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.strokeRect(-textWidth/2 - padding, -fontSize/2 - 8, textWidth + padding*2, fontSize + 16);
            
            ctx.fillStyle = color;
            ctx.fillText(text, 0, 0);
            
            ctx.restore();
        }
        
        // è¼”åŠ©å‡½æ•¸ï¼šç›´æ¥ç¹ªè£½æ–‡å­—ç‰¹æ•ˆ
        function applyTextFxDirect(style, text, x, y, options) {
            const fontSize = options.fontSize || 60;
            const color1 = options.color1 || '#ff0000';
            const color2 = options.color2 || '#0000ff';
            
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            switch(style) {
                case 'shadow':
                    ctx.shadowColor = 'rgba(0,0,0,0.5)';
                    ctx.shadowBlur = 10;
                    ctx.shadowOffsetX = 5;
                    ctx.shadowOffsetY = 5;
                    ctx.fillStyle = color1;
                    ctx.fillText(text, x, y);
                    ctx.shadowColor = 'transparent';
                    break;
                case 'outline':
                    ctx.strokeStyle = color2;
                    ctx.lineWidth = 3;
                    ctx.strokeText(text, x, y);
                    ctx.fillStyle = color1;
                    ctx.fillText(text, x, y);
                    break;
                case 'gradient':
                    const gradient = ctx.createLinearGradient(x - 100, y, x + 100, y);
                    gradient.addColorStop(0, color1);
                    gradient.addColorStop(1, color2);
                    ctx.fillStyle = gradient;
                    ctx.fillText(text, x, y);
                    break;
                case 'glow':
                    ctx.shadowColor = color1;
                    ctx.shadowBlur = 20;
                    ctx.fillStyle = 'white';
                    ctx.fillText(text, x, y);
                    ctx.shadowColor = 'transparent';
                    break;
                case '3d':
                    for (let i = 10; i >= 0; i--) {
                        ctx.fillStyle = i === 0 ? color1 : color2;
                        ctx.fillText(text, x + i, y + i);
                    }
                    break;
                case 'neon':
                    ctx.shadowColor = color1;
                    ctx.shadowBlur = 30;
                    ctx.strokeStyle = color1;
                    ctx.lineWidth = 2;
                    ctx.strokeText(text, x, y);
                    ctx.fillStyle = 'white';
                    ctx.fillText(text, x, y);
                    ctx.shadowColor = 'transparent';
                    break;
                case 'retro':
                    ctx.fillStyle = color2;
                    ctx.fillText(text, x + 4, y + 4);
                    ctx.fillStyle = color1;
                    ctx.fillText(text, x, y);
                    break;
                case 'metal':
                    const metalGrad = ctx.createLinearGradient(x, y - fontSize/2, x, y + fontSize/2);
                    metalGrad.addColorStop(0, '#ccc');
                    metalGrad.addColorStop(0.5, '#fff');
                    metalGrad.addColorStop(1, '#999');
                    ctx.fillStyle = metalGrad;
                    ctx.fillText(text, x, y);
                    ctx.strokeStyle = '#666';
                    ctx.lineWidth = 1;
                    ctx.strokeText(text, x, y);
                    break;
            }
        }
        
        // å–æ¶ˆæ”¾ç½®
        function cancelDragObject() {
            removeDragObject();
            showToast('âŒ å·²å–æ¶ˆæ”¾ç½®');
        }
        
        // ç§»é™¤æ‹–æ›³ç‰©ä»¶
        function removeDragObject() {
            const dragLayer = document.getElementById('dragLayer');
            if (dragLayer) {
                dragLayer.innerHTML = '';
            }
            currentDragObject = null;
            const dragControls = document.getElementById('dragControls');
            if (dragControls) {
                dragControls.classList.remove('show');
            }
        }
        
        // å¾®èª¿æ‹–æ›³ç‰©ä»¶ä½ç½®
        function nudgeDragObject(dx, dy) {
            if (!currentDragObject) return;
            
            const currentLeft = parseFloat(currentDragObject.style.left) || 0;
            const currentTop = parseFloat(currentDragObject.style.top) || 0;
            
            currentDragObject.style.left = (currentLeft + dx) + 'px';
            currentDragObject.style.top = (currentTop + dy) + 'px';
            
            updateDragPositionInfo();
        }
        
        // ç½®ä¸­æ‹–æ›³ç‰©ä»¶
        function centerDragObject() {
            if (!currentDragObject) return;
            
            const container = document.getElementById('canvasContainer');
            const canvasRect = canvas.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            const canvasOffsetX = canvasRect.left - containerRect.left + container.scrollLeft;
            const canvasOffsetY = canvasRect.top - containerRect.top + container.scrollTop;
            
            const objWidth = parseFloat(currentDragObject.style.width) || 100;
            const objHeight = parseFloat(currentDragObject.style.height) || 100;
            
            const centerX = canvasOffsetX + (canvasRect.width - objWidth) / 2;
            const centerY = canvasOffsetY + (canvasRect.height - objHeight) / 2;
            
            currentDragObject.style.left = centerX + 'px';
            currentDragObject.style.top = centerY + 'px';
            
            updateDragPositionInfo();
            showToast('âŠ• å·²ç½®ä¸­');
        }
        
        // æ›´æ–°ä½ç½®é¡¯ç¤º
        function updateDragPositionInfo() {
            if (!currentDragObject) return;
            
            const container = document.getElementById('canvasContainer');
            const canvasRect = canvas.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();
            
            const canvasOffsetX = canvasRect.left - containerRect.left + container.scrollLeft;
            const canvasOffsetY = canvasRect.top - containerRect.top + container.scrollTop;
            
            const objLeft = parseFloat(currentDragObject.style.left) || 0;
            const objTop = parseFloat(currentDragObject.style.top) || 0;
            const objWidth = parseFloat(currentDragObject.style.width) || 0;
            const objHeight = parseFloat(currentDragObject.style.height) || 0;
            
            // è¨ˆç®—åœ¨ç•«å¸ƒä¸Šçš„å¯¦éš›ä½ç½®
            const scaleX = canvas.width / canvasRect.width;
            const scaleY = canvas.height / canvasRect.height;
            
            const canvasX = Math.round((objLeft + objWidth/2 - canvasOffsetX) * scaleX);
            const canvasY = Math.round((objTop + objHeight/2 - canvasOffsetY) * scaleY);
            
            const posInfo = document.getElementById('dragPositionInfo');
            if (posInfo) {
                posInfo.textContent = `X: ${canvasX}, Y: ${canvasY}`;
            }
        }
        
        // éµç›¤æ§åˆ¶æ‹–æ›³ç‰©ä»¶
        document.addEventListener('keydown', (e) => {
            if (!currentDragObject) return;
            
            // æ–¹å‘éµæ§åˆ¶
            const step = e.shiftKey ? 1 : 10; // Shift æŒ‰ä½æ™‚å¾®èª¿ 1px
            
            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    nudgeDragObject(0, -step);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    nudgeDragObject(0, step);
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    nudgeDragObject(-step, 0);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nudgeDragObject(step, 0);
                    break;
                case 'Enter':
                    e.preventDefault();
                    confirmDragObject();
                    break;
                case 'c':
                case 'C':
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        centerDragObject();
                    }
                    break;
            }
        });
        
        // ===== æ—‹è½‰ç¿»è½‰ =====
        function rotateImage90() {
            saveHistory();
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = canvas.height;
            tempCanvas.height = canvas.width;
            
            tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
            tempCtx.rotate(90 * Math.PI / 180);
            tempCtx.drawImage(canvas, -canvas.width / 2, -canvas.height / 2);
            
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            ctx.drawImage(tempCanvas, 0, 0);
            
            updateCanvasInfo();
            setTimeout(updateZoomInfo, 50);
            showToast('ğŸ”„ å·²æ—‹è½‰ 90Â°');
        }
        
        function flipImage(direction) {
            saveHistory();
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            if (direction === 'h') {
                tempCtx.translate(canvas.width, 0);
                tempCtx.scale(-1, 1);
            } else {
                tempCtx.translate(0, canvas.height);
                tempCtx.scale(1, -1);
            }
            
            tempCtx.drawImage(canvas, 0, 0);
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast(direction === 'h' ? 'â†”ï¸ æ°´å¹³ç¿»è½‰' : 'â†•ï¸ å‚ç›´ç¿»è½‰');
        }
        
        // ===== è£åˆ‡åŠŸèƒ½ =====
        let cropRatio = null;
        
        function showCropPanel() {
            togglePanel('cropPanel', 'cropBtn');
        }
        
        function setCropRatio(ratio) {
            document.querySelectorAll('.crop-preset').forEach(b => b.classList.remove('active'));
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            }
            
            if (ratio === 'free') {
                cropRatio = null;
            } else {
                const [w, h] = ratio.split(':').map(Number);
                cropRatio = w / h;
            }
            showToast('ğŸ“ æ¯”ä¾‹: ' + ratio);
        }
        
        function applyCrop() {
            if (!currentSelection) {
                showToast('âš ï¸ è«‹å…ˆé¸å–è£åˆ‡å€åŸŸ');
                return;
            }
            
            saveHistory();
            const { x, y, w, h } = currentSelection;
            const imageData = ctx.getImageData(Math.round(x), Math.round(y), Math.round(w), Math.round(h));
            
            canvas.width = Math.round(w);
            canvas.height = Math.round(h);
            ctx.putImageData(imageData, 0, 0);
            
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            
            updateCanvasInfo();
            setTimeout(updateZoomInfo, 50);
            showToast('âœ‚ï¸ è£åˆ‡å®Œæˆ');
        }
        
        // ===== åœ–ç‰‡æ‹¼æ¥ =====
        let mergeImages = [];
        
        function showMergePanel() {
            togglePanel('mergePanel', 'mergeBtn');
            updateMergeList();
        }
        
        function updateMergeList() {
            const list = document.getElementById('mergeList');
            list.innerHTML = '<div class="merge-item current">ğŸ“Œ ç›®å‰åœ–ç‰‡</div>';
            
            mergeImages.forEach((img, i) => {
                const item = document.createElement('div');
                item.className = 'merge-item';
                item.innerHTML = `
                    <img src="${img.src}" alt="Image ${i+1}">
                    <span>åœ–ç‰‡ ${i + 1}</span>
                    <button class="remove-merge" onclick="removeMergeImage(${i})">âœ•</button>
                `;
                list.appendChild(item);
            });
        }
        
        function addMergeImages(e) {
            const files = e.target.files;
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        mergeImages.push(img);
                        updateMergeList();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeMergeImage(index) {
            mergeImages.splice(index, 1);
            updateMergeList();
        }
        
        function executeMerge() {
            if (mergeImages.length === 0) {
                showToast('âš ï¸ è«‹å…ˆæ·»åŠ åœ–ç‰‡');
                return;
            }
            
            saveHistory();
            const direction = document.querySelector('input[name="mergeDir"]:checked').value;
            
            // è¨ˆç®—ç¸½å°ºå¯¸
            let totalWidth = canvas.width;
            let totalHeight = canvas.height;
            
            if (direction === 'vertical') {
                mergeImages.forEach(img => {
                    totalWidth = Math.max(totalWidth, img.width);
                    totalHeight += img.height;
                });
            } else {
                mergeImages.forEach(img => {
                    totalWidth += img.width;
                    totalHeight = Math.max(totalHeight, img.height);
                });
            }
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = totalWidth;
            tempCanvas.height = totalHeight;
            
            // ç•«åŸåœ–
            let offsetX = 0, offsetY = 0;
            tempCtx.drawImage(canvas, 0, 0);
            
            if (direction === 'vertical') {
                offsetY = canvas.height;
                mergeImages.forEach(img => {
                    tempCtx.drawImage(img, 0, offsetY);
                    offsetY += img.height;
                });
            } else {
                offsetX = canvas.width;
                mergeImages.forEach(img => {
                    tempCtx.drawImage(img, offsetX, 0);
                    offsetX += img.width;
                });
            }
            
            canvas.width = totalWidth;
            canvas.height = totalHeight;
            ctx.drawImage(tempCanvas, 0, 0);
            
            mergeImages = [];
            updateMergeList();
            updateCanvasInfo();
            setTimeout(updateZoomInfo, 50);
            showToast('ğŸ”— æ‹¼æ¥å®Œæˆ');
        }
        
        // ===== QR Code =====
        let qrCanvas = null;
        
        function showQRPanel() {
            togglePanel('qrPanel', 'qrBtn');
        }
        
        // QR ç¢¼ç‹€æ…‹
        let qrPosition = 'bottom-right';
        let qrDragMode = false;
        let pendingQR = null;
        
        function setQRPosition(pos, btn) {
            qrPosition = pos;
            document.querySelectorAll('#qrPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function generateQR() {
            const content = document.getElementById('qrContent').value.trim();
            if (!content) {
                showToast('âš ï¸ è«‹è¼¸å…¥å…§å®¹');
                return;
            }
            
            const size = parseInt(document.getElementById('qrSize').value);
            const fgColor = document.getElementById('qrFgColor').value;
            const bgColor = document.getElementById('qrBgColor').value;
            
            // ä½¿ç”¨å¤–éƒ¨ API ç”Ÿæˆ QR Code
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(content)}&color=${fgColor.substring(1)}&bgcolor=${bgColor.substring(1)}`;
            
            const preview = document.getElementById('qrPreview');
            preview.innerHTML = `<img src="${qrUrl}" alt="QR Code" id="qrImage" crossorigin="anonymous">`;
            
            showToast('ğŸ“± QR Code å·²ç”Ÿæˆ');
        }
        
        function placeQR() {
            const qrImage = document.getElementById('qrImage');
            if (!qrImage) {
                showToast('âš ï¸ è«‹å…ˆç”Ÿæˆ QR Code');
                return;
            }
            
            const size = parseInt(document.getElementById('qrSize').value);
            
            // ä½¿ç”¨ä¹å®®æ ¼ä½ç½®ä½œç‚ºåˆå§‹ä½ç½®
            createDragObject('qr', qrImage.src, { size }, qrPosition);
        }
        
        function placeQRAt(clickX, clickY) {
            // ä¿ç•™çµ¦èˆŠä»£ç¢¼å…¼å®¹
            const qrImage = document.getElementById('qrImage');
            if (!qrImage && !pendingQR) return;
            
            const size = parseInt(document.getElementById('qrSize').value);
            createDragObject('qr', pendingQR || qrImage.src, { size }, qrPosition);
            pendingQR = null;
            qrDragMode = false;
            canvas.style.cursor = 'default';
        }
        
        function cancelQRPlacement() {
            // å–æ¶ˆä»»ä½•æ‹–æ›³ä¸­çš„ç‰©ä»¶
            if (currentDragObject) {
                removeDragObject();
                showToast('âŒ æ”¾ç½®å·²å–æ¶ˆ');
            }
        }
        
        // ===== QR Code åˆ†é åˆ‡æ› =====
        function switchQRTab(tab, btn) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('#qrPanel .qr-tab').forEach(b => {
                b.style.background = 'var(--bg-input)';
                b.style.border = '1px solid var(--border)';
            });
            btn.style.background = 'var(--primary)';
            btn.style.border = 'none';
            
            // åˆ‡æ›å€å¡Šé¡¯ç¤º
            document.getElementById('qrGenerateSection').style.display = tab === 'generate' ? 'block' : 'none';
            document.getElementById('qrDownloadSection').style.display = tab === 'download' ? 'block' : 'none';
        }
        
        // ===== ç”Ÿæˆåœ–ç‰‡ä¸‹è¼‰ QR Code =====
        let downloadImageUrl = '';
        
        async function generateDownloadQR() {
            if (!currentImage && canvas.width === 300) {
                showToast('âš ï¸ è«‹å…ˆè¼‰å…¥åœ–ç‰‡');
                return;
            }
            
            // ç›´æ¥é¡¯ç¤ºæœ¬åœ°åˆ†äº«é¸é …ï¼ˆæ›´å¯é ï¼‰
            const preview = document.getElementById('downloadQrPreview');
            preview.innerHTML = `
                <div style="padding:15px;text-align:center;">
                    <div style="font-size:36px;margin-bottom:10px;">ğŸ“±</div>
                    <div style="font-size:13px;color:var(--accent);margin-bottom:15px;">
                        é¸æ“‡å‚³è¼¸æ–¹å¼
                    </div>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <button onclick="shareImageNative()" style="padding:12px 20px;background:var(--primary);border:none;border-radius:8px;color:white;cursor:pointer;font-size:14px;">
                            ğŸ“¤ åˆ†äº«åˆ°æ‰‹æ©Ÿ (æ¨è–¦)
                        </button>
                        <button onclick="downloadImageDirect()" style="padding:12px 20px;background:var(--secondary);border:none;border-radius:8px;color:white;cursor:pointer;font-size:14px;">
                            ğŸ’¾ ä¸‹è¼‰åˆ°æœ¬æ©Ÿ
                        </button>
                        <button onclick="copyImageToClipboard()" style="padding:12px 20px;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:white;cursor:pointer;font-size:14px;">
                            ğŸ“‹ è¤‡è£½åˆ°å‰ªè²¼ç°¿
                        </button>
                        <button onclick="sendToLine()" style="padding:12px 20px;background:#06C755;border:none;border-radius:8px;color:white;cursor:pointer;font-size:14px;">
                            ğŸ’¬ æ¨é€åˆ° LINE Bot
                        </button>
                    </div>
                    <div style="margin-top:15px;padding:10px;background:var(--bg-input);border-radius:8px;font-size:11px;color:var(--text-secondary);">
                        ğŸ’¡ <b>å‚³è¼¸æ–¹å¼èªªæ˜ï¼š</b><br>
                        â€¢ åˆ†äº«ï¼šé–‹å•Ÿç³»çµ±åˆ†äº«é¸å–®ï¼ˆAirDropç­‰ï¼‰<br>
                        â€¢ ä¸‹è¼‰ï¼šå„²å­˜åˆ°æœ¬æ©Ÿï¼Œå†å‚³é›²ç«¯<br>
                        â€¢ LINEï¼šéœ€å…ˆè¨­å®š Messaging APIï¼ˆè¨­å®šé ï¼‰
                    </div>
                </div>
            `;
            
            document.getElementById('downloadLinkInfo').style.display = 'none';
            showToast('ğŸ“± è«‹é¸æ“‡å‚³è¼¸æ–¹å¼');
        }
        
        function generateQRForUrl(url) {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
            
            const preview = document.getElementById('downloadQrPreview');
            preview.innerHTML = `<img src="${qrUrl}" alt="Download QR" style="max-width:180px;border-radius:8px;">`;
            
            // é¡¯ç¤ºé€£çµè³‡è¨Š
            const linkInfo = document.getElementById('downloadLinkInfo');
            linkInfo.style.display = 'block';
            document.getElementById('downloadLinkUrl').href = url;
            document.getElementById('downloadLinkUrl').textContent = url.length > 50 ? url.substring(0, 50) + '...' : url;
            
            showToast('âœ… QR Code å·²ç”Ÿæˆï¼ç”¨æ‰‹æ©Ÿæƒæä¸‹è¼‰');
        }
        
        function useBackupDownloadMethod() {
            // å‚™ç”¨æ–¹æ¡ˆï¼šæä¾›å¤šç¨®ä¸‹è¼‰æ–¹å¼
            const preview = document.getElementById('downloadQrPreview');
            preview.innerHTML = `
                <div style="padding:15px;text-align:center;">
                    <div style="font-size:36px;margin-bottom:10px;">ğŸ“±ğŸ’»</div>
                    <div style="font-size:13px;color:var(--accent);margin-bottom:15px;">
                        é›²ç«¯ä¸Šå‚³æš«æ™‚ä¸å¯ç”¨<br>è«‹ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š
                    </div>
                    <div style="display:flex;flex-direction:column;gap:10px;">
                        <button onclick="downloadImageDirect()" style="padding:12px 20px;background:var(--primary);border:none;border-radius:8px;color:white;cursor:pointer;font-size:14px;">
                            ğŸ’¾ ä¸‹è¼‰åˆ°æœ¬æ©Ÿ
                        </button>
                        <button onclick="shareImageNative()" style="padding:12px 20px;background:var(--secondary);border:none;border-radius:8px;color:white;cursor:pointer;font-size:14px;">
                            ğŸ“¤ åˆ†äº«åˆ°å…¶ä»– App
                        </button>
                        <button onclick="copyImageToClipboard()" style="padding:12px 20px;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:white;cursor:pointer;font-size:14px;">
                            ğŸ“‹ è¤‡è£½åœ–ç‰‡
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('downloadLinkInfo').style.display = 'none';
        }
        
        function downloadImageDirect() {
            const link = document.createElement('a');
            link.download = 'åœ–æ–‡é­”è¡“å¸«_' + Date.now() + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('ğŸ’¾ åœ–ç‰‡å·²ä¸‹è¼‰ï¼');
        }
        
        async function shareImageNative() {
            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const file = new File([blob], 'åœ–æ–‡é­”è¡“å¸«.png', { type: 'image/png' });
                
                if (navigator.share && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: 'åœ–æ–‡é­”è¡“å¸« - åœ–ç‰‡åˆ†äº«',
                        files: [file]
                    });
                    showToast('âœ… å·²é–‹å•Ÿåˆ†äº«é¸å–®');
                } else {
                    // ä¸æ”¯æ´ Web Share API
                    downloadImageDirect();
                    showToast('ğŸ“± æ­¤ç€è¦½å™¨ä¸æ”¯æ´åˆ†äº«ï¼Œå·²æ”¹ç‚ºä¸‹è¼‰');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    downloadImageDirect();
                }
            }
        }
        
        async function copyImageToClipboard() {
            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);
                showToast('ğŸ“‹ åœ–ç‰‡å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            } catch (error) {
                showToast('âš ï¸ è¤‡è£½å¤±æ•—ï¼Œè«‹ä½¿ç”¨ä¸‹è¼‰åŠŸèƒ½');
            }
        }
        
        function copyDownloadLink() {
            if (downloadImageUrl) {
                navigator.clipboard.writeText(downloadImageUrl).then(() => {
                    showToast('ğŸ“‹ é€£çµå·²è¤‡è£½ï¼');
                }).catch(() => {
                    // é™ç´šæ–¹æ¡ˆ
                    const input = document.createElement('input');
                    input.value = downloadImageUrl;
                    document.body.appendChild(input);
                    input.select();
                    document.execCommand('copy');
                    document.body.removeChild(input);
                    showToast('ğŸ“‹ é€£çµå·²è¤‡è£½ï¼');
                });
            }
        }
        
        // ===== å£“ç¸®åŠŸèƒ½ =====
        function showCompressPanel() {
            togglePanel('compressPanel', 'compressBtn');
            updateCompressInfo();
            
            document.getElementById('compressQuality').oninput = function() {
                document.getElementById('qualityVal').textContent = this.value + '%';
            };
            
            document.getElementById('enableResize').onchange = function() {
                document.getElementById('resizeOptions').style.display = this.checked ? 'block' : 'none';
            };
        }
        
        function updateCompressInfo() {
            const dataUrl = canvas.toDataURL('image/png');
            const size = Math.round((dataUrl.length * 3/4) / 1024);
            document.getElementById('originalSize').textContent = size + ' KB';
        }
        
        function previewCompress() {
            const quality = parseInt(document.getElementById('compressQuality').value) / 100;
            const enableResize = document.getElementById('enableResize').checked;
            const resizePercent = enableResize ? parseInt(document.getElementById('resizePreset').value) / 100 : 1;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width * resizePercent;
            tempCanvas.height = canvas.height * resizePercent;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
            
            const compressed = tempCanvas.toDataURL('image/jpeg', quality);
            const newSize = Math.round((compressed.length * 3/4) / 1024);
            const originalSize = parseInt(document.getElementById('originalSize').textContent);
            const ratio = Math.round((1 - newSize / originalSize) * 100);
            
            document.getElementById('compressedSize').textContent = newSize + ' KB';
            document.getElementById('compressRatio').textContent = ratio + '% æ¸›å°‘';
            
            showToast('ğŸ‘ï¸ å£“ç¸®é è¦½å®Œæˆ');
        }
        
        function downloadCompressed() {
            const quality = parseInt(document.getElementById('compressQuality').value) / 100;
            const enableResize = document.getElementById('enableResize').checked;
            const resizePercent = enableResize ? parseInt(document.getElementById('resizePreset').value) / 100 : 1;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width * resizePercent;
            tempCanvas.height = canvas.height * resizePercent;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
            
            const link = document.createElement('a');
            link.download = `compressed-${Date.now()}.jpg`;
            link.href = tempCanvas.toDataURL('image/jpeg', quality);
            link.click();
            
            showToast('ğŸ’¾ å£“ç¸®æª”å·²ä¸‹è¼‰');
        }
        
        // ===== ç®­é ­å·¥å…· =====
        let arrowStart = null;
        let arrowStyle = 'solid'; // solid, dashed, double
        let arrowLineWidth = 3;
        let arrowHeadStyle = 'filled'; // filled, outline, diamond
        
        function drawArrow(fromX, fromY, toX, toY) {
            saveHistory();
            const lineWidth = parseInt(document.getElementById('arrowWidth')?.value) || arrowLineWidth;
            const headLength = lineWidth * 5;
            const angle = Math.atan2(toY - fromY, toX - fromX);
            const color = document.getElementById('arrowColor')?.value || document.getElementById('textColor').value;
            const style = document.getElementById('arrowStyle')?.value || arrowStyle;
            const headType = document.getElementById('arrowHead')?.value || arrowHeadStyle;
            
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = lineWidth;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // ç•«ç·šæ¢
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            
            if (style === 'dashed') {
                ctx.setLineDash([lineWidth * 3, lineWidth * 2]);
            } else if (style === 'dotted') {
                ctx.setLineDash([lineWidth, lineWidth * 2]);
            } else {
                ctx.setLineDash([]);
            }
            
            ctx.lineTo(toX, toY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // ç•«ç®­é ­
            if (headType === 'filled') {
                // å¯¦å¿ƒç®­é ­
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(toX - headLength * Math.cos(angle - Math.PI / 6), toY - headLength * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(toX - headLength * Math.cos(angle + Math.PI / 6), toY - headLength * Math.sin(angle + Math.PI / 6));
                ctx.closePath();
                ctx.fill();
            } else if (headType === 'outline') {
                // ç©ºå¿ƒç®­é ­
                ctx.beginPath();
                ctx.moveTo(toX - headLength * Math.cos(angle - Math.PI / 6), toY - headLength * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(toX, toY);
                ctx.lineTo(toX - headLength * Math.cos(angle + Math.PI / 6), toY - headLength * Math.sin(angle + Math.PI / 6));
                ctx.stroke();
            } else if (headType === 'diamond') {
                // è±å½¢ç®­é ­
                const midX = toX - headLength * 0.5 * Math.cos(angle);
                const midY = toY - headLength * 0.5 * Math.sin(angle);
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(toX - headLength * 0.7 * Math.cos(angle - Math.PI / 4), toY - headLength * 0.7 * Math.sin(angle - Math.PI / 4));
                ctx.lineTo(toX - headLength * Math.cos(angle), toY - headLength * Math.sin(angle));
                ctx.lineTo(toX - headLength * 0.7 * Math.cos(angle + Math.PI / 4), toY - headLength * 0.7 * Math.sin(angle + Math.PI / 4));
                ctx.closePath();
                ctx.fill();
            } else if (headType === 'double') {
                // é›™å‘ç®­é ­
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(toX - headLength * Math.cos(angle - Math.PI / 6), toY - headLength * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(toX - headLength * Math.cos(angle + Math.PI / 6), toY - headLength * Math.sin(angle + Math.PI / 6));
                ctx.closePath();
                ctx.fill();
                // èµ·é»ç®­é ­
                const angle2 = angle + Math.PI;
                ctx.beginPath();
                ctx.moveTo(fromX, fromY);
                ctx.lineTo(fromX - headLength * Math.cos(angle2 - Math.PI / 6), fromY - headLength * Math.sin(angle2 - Math.PI / 6));
                ctx.lineTo(fromX - headLength * Math.cos(angle2 + Math.PI / 6), fromY - headLength * Math.sin(angle2 + Math.PI / 6));
                ctx.closePath();
                ctx.fill();
            } else if (headType === 'circle') {
                // åœ“å½¢ç®­é ­
                ctx.beginPath();
                ctx.arc(toX, toY, lineWidth * 2, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function showArrowPanel() {
            const panel = document.getElementById('arrowPanel');
            const isShowing = panel.classList.contains('show');
            
            // Toggle: å¦‚æœé¢æ¿å·²é–‹ä¸”å·¥å…·ç‚º arrowï¼Œå‰‡å–æ¶ˆ
            if (isShowing && currentTool === 'arrow') {
                currentTool = null;
                document.getElementById('arrowBtn').classList.remove('active');
                canvas.style.cursor = 'default';
                showToast('ğŸ”“ ç®­é ­å·¥å…·å·²å–æ¶ˆ');
            }
            
            togglePanel('arrowPanel', 'arrowBtn');
        }
        
        function activateArrowTool() {
            setTool('arrow');
            showToast('â¡ï¸ æ‹–æ›³ç•«ç®­é ­ï¼ˆå†é»ç®­é ­æŒ‰éˆ•å¯å–æ¶ˆï¼‰');
        }
        
        function cancelArrowTool() {
            if (currentTool === 'arrow') {
                currentTool = null;
                document.getElementById('arrowBtn').classList.remove('active');
                canvas.style.cursor = 'default';
                showToast('âŒ ç®­é ­å·¥å…·å·²å–æ¶ˆ');
            }
            // é—œé–‰é¢æ¿
            const panel = document.getElementById('arrowPanel');
            if (panel.classList.contains('show')) {
                togglePanel('arrowPanel', 'arrowBtn');
            }
        }
        
        // ===== ç•«ç­†å·¥å…· =====
        let currentBrush = 'pen';
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        
        // ===== å¥—ç´¢å·¥å…· =====
        let lassoPoints = [];
        let isLassoing = false;
        
        function showBrushPanel() {
            const panel = document.getElementById('brushPanel');
            const isShowing = panel.classList.contains('show');
            
            // Toggle: å¦‚æœé¢æ¿å·²é–‹ä¸”å·¥å…·ç‚º brushï¼Œå‰‡å–æ¶ˆ
            if (isShowing && currentTool === 'brush') {
                currentTool = null;
                document.getElementById('brushBtn').classList.remove('active');
                canvas.style.cursor = 'default';
                showToast('ğŸ”“ ç•«ç­†å·¥å…·å·²å–æ¶ˆ');
            } else if (!isShowing) {
                setTool('brush');
            }
            
            togglePanel('brushPanel', 'brushBtn');
        }
        
        function setBrushType(type) {
            currentBrush = type;
            document.querySelectorAll('.brush-type').forEach(b => b.classList.remove('active'));
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            }
        }
        
        function setBrushColor(color) {
            document.getElementById('brushColor').value = color;
        }
        
        // ===== å½¢ç‹€å·¥å…· =====
        let currentShape = 'rect';
        
        function showShapePanel() {
            const panel = document.getElementById('shapePanel');
            const isShowing = panel.classList.contains('show');
            
            // Toggle: å¦‚æœé¢æ¿å·²é–‹ä¸”å·¥å…·ç‚º shapeï¼Œå‰‡å–æ¶ˆ
            if (isShowing && currentTool === 'shape') {
                currentTool = null;
                document.getElementById('shapeBtn').classList.remove('active');
                canvas.style.cursor = 'default';
                showToast('ğŸ”“ å½¢ç‹€å·¥å…·å·²å–æ¶ˆ');
            } else if (!isShowing) {
                setTool('shape');
            }
            
            togglePanel('shapePanel', 'shapeBtn');
        }
        
        function setShapeType(type) {
            currentShape = type;
            document.querySelectorAll('.shape-type').forEach(b => b.classList.remove('active'));
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            }
        }
        
        function drawShape(x, y, w, h) {
            saveHistory();
            const strokeColor = document.getElementById('shapeStrokeColor').value;
            const fillColor = document.getElementById('shapeFillColor').value;
            const strokeWidth = document.getElementById('shapeStroke').value;
            const filled = document.getElementById('shapeFilled').checked;
            
            ctx.strokeStyle = strokeColor;
            ctx.fillStyle = fillColor;
            ctx.lineWidth = strokeWidth;
            
            ctx.beginPath();
            switch(currentShape) {
                case 'rect':
                    if (filled) ctx.fillRect(x, y, w, h);
                    ctx.strokeRect(x, y, w, h);
                    break;
                case 'circle':
                    const radius = Math.min(Math.abs(w), Math.abs(h)) / 2;
                    ctx.arc(x + w/2, y + h/2, radius, 0, Math.PI * 2);
                    break;
                case 'ellipse':
                    ctx.ellipse(x + w/2, y + h/2, Math.abs(w/2), Math.abs(h/2), 0, 0, Math.PI * 2);
                    break;
                case 'triangle':
                    ctx.moveTo(x + w/2, y);
                    ctx.lineTo(x + w, y + h);
                    ctx.lineTo(x, y + h);
                    ctx.closePath();
                    break;
                case 'star':
                    drawStar(ctx, x + w/2, y + h/2, 5, Math.min(w, h)/2, Math.min(w, h)/4);
                    break;
                case 'heart':
                    drawHeart(ctx, x, y, w, h);
                    break;
                case 'line':
                    ctx.moveTo(x, y);
                    ctx.lineTo(x + w, y + h);
                    ctx.stroke();
                    return;
            }
            if (filled && currentShape !== 'rect') ctx.fill();
            ctx.stroke();
        }
        
        function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
            let rot = Math.PI / 2 * 3;
            let step = Math.PI / spikes;
            ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius);
                rot += step;
                ctx.lineTo(cx + Math.cos(rot) * innerRadius, cy + Math.sin(rot) * innerRadius);
                rot += step;
            }
            ctx.closePath();
        }
        
        function drawHeart(ctx, x, y, w, h) {
            ctx.moveTo(x + w/2, y + h/4);
            ctx.bezierCurveTo(x + w/2, y, x, y, x, y + h/4);
            ctx.bezierCurveTo(x, y + h/2, x + w/2, y + h*3/4, x + w/2, y + h);
            ctx.bezierCurveTo(x + w/2, y + h*3/4, x + w, y + h/2, x + w, y + h/4);
            ctx.bezierCurveTo(x + w, y, x + w/2, y, x + w/2, y + h/4);
        }
        
        // ===== æ–‡å­—ç‰¹æ•ˆ =====
        function showTextFxPanel() {
            togglePanel('textFxPanel', 'textFxBtn');
        }
        
        // æ–‡å­—ç‰¹æ•ˆç‹€æ…‹
        let textFxPosition = 'center';
        let textFxDragMode = false;
        let pendingTextFx = null;
        
        function setTextFxPosition(pos, btn) {
            textFxPosition = pos;
            document.querySelectorAll('#textFxPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function applyTextFx(style) {
            const text = document.getElementById('fxText').value.trim();
            if (!text) {
                showToast('âš ï¸ è«‹è¼¸å…¥æ–‡å­—');
                return;
            }
            
            const fontSize = parseInt(document.getElementById('fxFontSize').value);
            const color1 = document.getElementById('fxColor1').value;
            const color2 = document.getElementById('fxColor2').value;
            
            // ä½¿ç”¨ä¹å®®æ ¼ä½ç½®ä½œç‚ºåˆå§‹ä½ç½®
            createDragObject('textfx', text, { 
                style, 
                fontSize, 
                color1, 
                color2 
            }, textFxPosition);
        }
        
        function applyTextFxAt(style, text, clickX, clickY) {
            // ä¿ç•™çµ¦èˆŠä»£ç¢¼å…¼å®¹
            const fontSize = parseInt(document.getElementById('fxFontSize').value);
            const color1 = document.getElementById('fxColor1').value;
            const color2 = document.getElementById('fxColor2').value;
            
            createDragObject('textfx', text, { 
                style, 
                fontSize, 
                color1, 
                color2 
            }, textFxPosition);
            
            pendingTextFx = null;
            textFxDragMode = false;
            canvas.style.cursor = 'default';
        }
        
        function cancelTextFxPlacement() {
            // å–æ¶ˆä»»ä½•æ‹–æ›³ä¸­çš„ç‰©ä»¶
            if (currentDragObject) {
                removeDragObject();
                showToast('âŒ æ”¾ç½®å·²å–æ¶ˆ');
            }
        }
        
        // ===== æ¨¡æ¿åŠŸèƒ½ =====
        const templates = {
            social: [
                { name: 'IG è²¼æ–‡', w: 1080, h: 1080 },
                { name: 'IG é™å‹•', w: 1080, h: 1920 },
                { name: 'FB è²¼æ–‡', w: 1200, h: 630 },
                { name: 'FB å°é¢', w: 820, h: 312 },
                { name: 'Twitter', w: 1200, h: 675 },
                { name: 'YouTube', w: 1280, h: 720 }
            ],
            print: [
                { name: 'A4', w: 2480, h: 3508 },
                { name: 'A5', w: 1748, h: 2480 },
                { name: '4x6 å‹', w: 1200, h: 1800 },
                { name: 'åç‰‡', w: 1050, h: 600 },
                { name: 'æµ·å ± A3', w: 3508, h: 4961 }
            ],
            web: [
                { name: 'æ©«å¹…', w: 1920, h: 600 },
                { name: 'éƒ¨è½æ ¼', w: 1200, h: 800 },
                { name: 'ç¸®åœ–', w: 400, h: 300 },
                { name: 'åœ–ç¤º', w: 512, h: 512 },
                { name: 'Logo', w: 500, h: 200 }
            ],
            video: [
                { name: '1080p', w: 1920, h: 1080 },
                { name: '4K', w: 3840, h: 2160 },
                { name: '720p', w: 1280, h: 720 },
                { name: 'ç›´å¼', w: 1080, h: 1920 }
            ]
        };
        
        function showTemplatePanel() {
            togglePanel('templatePanel', 'templateBtn');
            showTemplates('social');
        }
        
        function showTemplates(category) {
            document.querySelectorAll('.template-cat').forEach(c => c.classList.remove('active'));
            // å®‰å…¨åœ°è™•ç† active ç‹€æ…‹
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            } else {
                // ç›´æ¥èª¿ç”¨æ™‚ï¼Œæ ¹æ“š category æ‰¾åˆ°å°æ‡‰çš„æŒ‰éˆ•
                document.querySelectorAll('.template-cat').forEach(c => {
                    if (c.getAttribute('onclick')?.includes(`'${category}'`)) {
                        c.classList.add('active');
                    }
                });
            }
            
            const grid = document.getElementById('templateGrid');
            grid.innerHTML = '';
            
            templates[category].forEach(t => {
                const item = document.createElement('button');
                item.className = 'template-item';
                item.innerHTML = `${t.name}<br><small>${t.w}Ã—${t.h}</small>`;
                item.onclick = () => createCanvas(t.w, t.h);
                grid.appendChild(item);
            });
        }
        
        function createCanvas(w, h) {
            saveHistory();
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = w;
            tempCanvas.height = h;
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, w, h);
            
            // å¦‚æœæœ‰ç¾æœ‰åœ–ç‰‡ï¼Œå±…ä¸­æ”¾ç½®
            if (canvas.width > 0) {
                const scale = Math.min(w / canvas.width, h / canvas.height);
                const newW = canvas.width * scale;
                const newH = canvas.height * scale;
                const x = (w - newW) / 2;
                const y = (h - newH) / 2;
                tempCtx.drawImage(canvas, x, y, newW, newH);
            }
            
            canvas.width = w;
            canvas.height = h;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('ğŸ“‹ ç•«å¸ƒå·²å»ºç«‹ ' + w + 'Ã—' + h);
        }
        
        function createCustomCanvas() {
            const w = parseInt(document.getElementById('customWidth').value) || 800;
            const h = parseInt(document.getElementById('customHeight').value) || 600;
            createCanvas(w, h);
        }
        
        // ===== æ‹¼è²¼åŠŸèƒ½ =====
        let collageImages = [];
        let collageLayout = { count: 4, type: 'grid' };
        
        function showCollagePanel() {
            togglePanel('collagePanel', 'collageBtn');
        }
        
        function setCollageLayout(count, type) {
            collageLayout = { count, type };
            document.querySelectorAll('.collage-layout').forEach(b => b.classList.remove('active'));
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            }
        }
        
        function addCollageImages(e) {
            const files = e.target.files;
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        collageImages.push(img);
                        updateCollagePreview();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function updateCollagePreview() {
            const container = document.getElementById('collageImages');
            container.innerHTML = '';
            collageImages.forEach((img, i) => {
                const thumb = document.createElement('img');
                thumb.className = 'collage-thumb';
                thumb.src = img.src;
                container.appendChild(thumb);
            });
        }
        
        function generateCollage() {
            if (collageImages.length === 0) {
                showToast('âš ï¸ è«‹å…ˆæ·»åŠ ç…§ç‰‡');
                return;
            }
            
            saveHistory();
            const gap = parseInt(document.getElementById('collageGap').value);
            const radius = parseInt(document.getElementById('collageRadius').value);
            const bgColor = document.getElementById('collageBg').value;
            const { count, type } = collageLayout;
            
            let cols = 2, rows = 2;
            if (type === 'h') { cols = count; rows = 1; }
            else if (type === 'v') { cols = 1; rows = count; }
            else { cols = Math.ceil(Math.sqrt(count)); rows = Math.ceil(count / cols); }
            
            const cellW = 300, cellH = 300;
            const totalW = cols * cellW + (cols + 1) * gap;
            const totalH = rows * cellH + (rows + 1) * gap;
            
            canvas.width = totalW;
            canvas.height = totalH;
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, totalW, totalH);
            
            for (let i = 0; i < Math.min(count, collageImages.length); i++) {
                const col = i % cols;
                const row = Math.floor(i / cols);
                const x = gap + col * (cellW + gap);
                const y = gap + row * (cellH + gap);
                
                ctx.save();
                if (radius > 0) {
                    ctx.beginPath();
                    ctx.roundRect(x, y, cellW, cellH, radius);
                    ctx.clip();
                }
                
                const img = collageImages[i];
                const scale = Math.max(cellW / img.width, cellH / img.height);
                const drawW = img.width * scale;
                const drawH = img.height * scale;
                const drawX = x + (cellW - drawW) / 2;
                const drawY = y + (cellH - drawH) / 2;
                ctx.drawImage(img, drawX, drawY, drawW, drawH);
                ctx.restore();
            }
            
            collageImages = [];
            updateCollagePreview();
            showToast('ğŸ§© æ‹¼è²¼å®Œæˆ');
        }
        
        // ===== ç¾é¡åŠŸèƒ½ =====
        function showBeautyPanel() {
            togglePanel('beautyPanel', 'beautyBtn');
            initBeautySliders();
        }
        
        function initBeautySliders() {
            ['Skin', 'White', 'Rosy', 'Sharp'].forEach(name => {
                const slider = document.getElementById('beauty' + name);
                const label = document.getElementById(name.toLowerCase() + 'Val');
                if (slider && label) {
                    slider.oninput = function() {
                        label.textContent = this.value;
                    };
                }
            });
        }
        
        function applyBeautyPreset(preset) {
            const presets = {
                natural: { skin: 20, white: 10, rosy: 15, sharp: 10 },
                soft: { skin: 40, white: 20, rosy: 10, sharp: 5 },
                bright: { skin: 30, white: 40, rosy: 5, sharp: 15 },
                glamour: { skin: 50, white: 30, rosy: 25, sharp: 20 }
            };
            const p = presets[preset];
            document.getElementById('beautySkin').value = p.skin;
            document.getElementById('beautyWhite').value = p.white;
            document.getElementById('beautyRosy').value = p.rosy;
            document.getElementById('beautySharp').value = p.sharp;
            document.getElementById('skinVal').textContent = p.skin;
            document.getElementById('whiteVal').textContent = p.white;
            document.getElementById('rosyVal').textContent = p.rosy;
            document.getElementById('sharpVal').textContent = p.sharp;
        }
        
        function applyBeauty() {
            saveHistory();
            const skin = parseInt(document.getElementById('beautySkin').value) / 100;
            const white = parseInt(document.getElementById('beautyWhite').value) / 100;
            const rosy = parseInt(document.getElementById('beautyRosy').value) / 100;
            
            // ç°¡å–®ç¾é¡æ•ˆæœ
            if (skin > 0) {
                ctx.filter = `blur(${skin * 2}px)`;
                ctx.globalAlpha = skin;
                ctx.drawImage(canvas, 0, 0);
                ctx.filter = 'none';
                ctx.globalAlpha = 1;
            }
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // ç¾ç™½
                data[i] = Math.min(255, data[i] + white * 30);
                data[i+1] = Math.min(255, data[i+1] + white * 30);
                data[i+2] = Math.min(255, data[i+2] + white * 30);
                
                // ç´…æ½¤
                data[i] = Math.min(255, data[i] + rosy * 20);
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('âœ¨ ç¾é¡å·²å¥—ç”¨');
        }
        
        // ===== å»èƒŒåŠŸèƒ½ =====
        function showRemoveBgPanel() {
            togglePanel('removeBgPanel', 'removeBgBtn');
            
            document.getElementById('bgTolerance').oninput = function() {
                document.getElementById('toleranceVal').textContent = this.value;
            };
        }
        
        function removeBackground(type) {
            saveHistory();
            const tolerance = parseInt(document.getElementById('bgTolerance').value);
            
            let targetColor;
            if (type === 'white') targetColor = { r: 255, g: 255, b: 255 };
            else if (type === 'black') targetColor = { r: 0, g: 0, b: 0 };
            else if (type === 'green') targetColor = { r: 0, g: 255, b: 0 };
            else if (type === 'color') {
                document.getElementById('bgColorPick').style.display = 'block';
                const hex = document.getElementById('removeBgColor').value;
                targetColor = hexToRgb(hex);
            }
            
            if (!targetColor) return;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const diff = Math.abs(r - targetColor.r) + Math.abs(g - targetColor.g) + Math.abs(b - targetColor.b);
                
                if (diff < tolerance * 3) {
                    data[i+3] = 0; // é€æ˜
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ­ èƒŒæ™¯å·²å»é™¤');
        }
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }
        
        function setNewBg(type) {
            const newColor = document.getElementById('newBgColor').value;
            
            if (type === 'color') {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                tempCtx.fillStyle = newColor;
                tempCtx.fillRect(0, 0, canvas.width, canvas.height);
                tempCtx.drawImage(canvas, 0, 0);
                ctx.drawImage(tempCanvas, 0, 0);
                showToast('ğŸ–¼ï¸ èƒŒæ™¯å·²æ›¿æ›');
            }
        }
        
        // ===== æ‰¹æ¬¡è™•ç† =====
        let batchImages = [];
        
        function showBatchPanel() {
            togglePanel('batchPanel', 'batchBtn');
        }
        
        function loadBatchImages(e) {
            batchImages = [];
            const files = e.target.files;
            const list = document.getElementById('batchList');
            list.innerHTML = '';
            
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        batchImages.push({ img, name: file.name });
                        const item = document.createElement('div');
                        item.className = 'batch-item';
                        item.innerHTML = `<img src="${event.target.result}"><span>${file.name}</span>`;
                        list.appendChild(item);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        async function executeBatch() {
            if (batchImages.length === 0) {
                showToast('âš ï¸ è«‹å…ˆé¸æ“‡åœ–ç‰‡');
                return;
            }
            
            showToast('ğŸ“š æ‰¹æ¬¡è™•ç†ä¸­...');
            
            for (let i = 0; i < batchImages.length; i++) {
                const { img, name } = batchImages[i];
                
                // å»ºç«‹è‡¨æ™‚ç•«å¸ƒ
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = img.width;
                tempCanvas.height = img.height;
                tempCtx.drawImage(img, 0, 0);
                
                // åŸ·è¡Œé¸ä¸­çš„æ“ä½œ
                // TODO: æ ¹æ“šå‹¾é¸çš„é¸é …åŸ·è¡Œ
                
                // ä¸‹è¼‰
                const link = document.createElement('a');
                link.download = `batch-${i+1}-${name}`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
                
                await new Promise(r => setTimeout(r, 300));
            }
            
            showToast('âœ… æ‰¹æ¬¡è™•ç†å®Œæˆ');
        }
        
        // ===== ç‰¹æ•ˆåŠŸèƒ½ =====
        function showEffectPanel() {
            togglePanel('effectPanel', 'effectBtn');
        }
        
        function showEffectCategory(cat) {
            // æ›´æ–°åˆ†é¡æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.effect-cat').forEach(btn => btn.classList.remove('active'));
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            }
            
            // é¡¯ç¤º/éš±è—æ•ˆæœæŒ‰éˆ•
            document.querySelectorAll('#effectGrid .effect-item').forEach(item => {
                if (cat === 'all' || item.dataset.cat === cat) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function applyEffect(effect) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            switch(effect) {
                case 'emboss':
                    applyConvolution(imageData, [-2, -1, 0, -1, 1, 1, 0, 1, 2]);
                    break;
                case 'edge':
                    applyConvolution(imageData, [-1, -1, -1, -1, 8, -1, -1, -1, -1]);
                    break;
                case 'posterize':
                    const levels = 4;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.floor(data[i] / (256/levels)) * (256/levels);
                        data[i+1] = Math.floor(data[i+1] / (256/levels)) * (256/levels);
                        data[i+2] = Math.floor(data[i+2] / (256/levels)) * (256/levels);
                    }
                    break;
                case 'solarize':
                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i] > 128) data[i] = 255 - data[i];
                        if (data[i+1] > 128) data[i+1] = 255 - data[i+1];
                        if (data[i+2] > 128) data[i+2] = 255 - data[i+2];
                    }
                    break;
                case 'thermal':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        if (avg < 64) { data[i] = 0; data[i+1] = 0; data[i+2] = avg * 4; }
                        else if (avg < 128) { data[i] = 0; data[i+1] = (avg-64)*4; data[i+2] = 255; }
                        else if (avg < 192) { data[i] = (avg-128)*4; data[i+1] = 255; data[i+2] = 255-(avg-128)*4; }
                        else { data[i] = 255; data[i+1] = 255-(avg-192)*4; data[i+2] = 0; }
                    }
                    break;
                case 'xray':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = data[i+1] = data[i+2] = 255 - avg;
                        data[i+2] = Math.min(255, data[i+2] + 50);
                    }
                    break;
                case 'night':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = 0;
                        data[i+1] = Math.min(255, avg * 1.5);
                        data[i+2] = 0;
                    }
                    break;
                case 'comic':
                    applyConvolution(imageData, [0, -1, 0, -1, 5, -1, 0, -1, 0]);
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.floor(data[i] / 64) * 64;
                        data[i+1] = Math.floor(data[i+1] / 64) * 64;
                        data[i+2] = Math.floor(data[i+2] / 64) * 64;
                    }
                    break;
                case 'pop':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = data[i] > 128 ? 255 : 0;
                        data[i+1] = data[i+1] > 128 ? 255 : 0;
                        data[i+2] = data[i+2] > 128 ? 255 : 0;
                    }
                    break;
                case 'halftone':
                case 'dotscreen':
                case 'crosshatch':
                    // ç°¡åŒ–ç‰ˆ
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        const threshold = ((i / 4) % canvas.width + Math.floor((i / 4) / canvas.width)) % 8 * 32;
                        const val = avg > threshold ? 255 : 0;
                        data[i] = data[i+1] = data[i+2] = val;
                    }
                    break;
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ’« ç‰¹æ•ˆå·²å¥—ç”¨');
        }
        
        function applyConvolution(imageData, kernel) {
            const data = imageData.data;
            const w = imageData.width;
            const h = imageData.height;
            const output = new Uint8ClampedArray(data);
            
            for (let y = 1; y < h - 1; y++) {
                for (let x = 1; x < w - 1; x++) {
                    const idx = (y * w + x) * 4;
                    for (let c = 0; c < 3; c++) {
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const kidx = ((y + ky) * w + (x + kx)) * 4 + c;
                                sum += data[kidx] * kernel[(ky + 1) * 3 + (kx + 1)];
                            }
                        }
                        output[idx + c] = Math.min(255, Math.max(0, sum + 128));
                    }
                }
            }
            
            for (let i = 0; i < data.length; i++) {
                data[i] = output[i];
            }
        }
        
        // ===== ç–ŠåŠ åŠŸèƒ½ =====
        function showOverlayPanel() {
            togglePanel('overlayPanel', 'overlayBtn');
        }
        
        // ===== æ‰¹è¨»åŠŸèƒ½ =====
        let annotateTool = 'highlight';
        let annotateNumber = 1;
        
        function showAnnotatePanel() {
            togglePanel('annotatePanel', 'annotateBtn');
            setTool('annotate');
        }
        
        function setAnnotateTool(tool) {
            annotateTool = tool;
            document.querySelectorAll('.annotate-tool').forEach(t => t.classList.remove('active'));
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            }
        }
        
        // ===== æ­·å²è¨˜éŒ„é¢æ¿ =====
        function showHistoryPanel() {
            togglePanel('historyPanel', 'historyBtn');
            updateHistoryList();
        }
        
        function updateHistoryList() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            historyStack.forEach((state, i) => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = 40;
                tempCanvas.height = 40;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(createImageFromData(state.data, state.width, state.height), 0, 0, 40, 40);
                
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `<img src="${tempCanvas.toDataURL()}"><span>æ­¥é©Ÿ ${i + 1}</span>`;
                item.onclick = () => restoreHistory(i);
                list.appendChild(item);
            });
        }
        
        function createImageFromData(imageData, w, h) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = w;
            tempCanvas.height = h;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.putImageData(imageData, 0, 0);
            return tempCanvas;
        }
        
        function restoreHistory(index) {
            const state = historyStack[index];
            canvas.width = state.width;
            canvas.height = state.height;
            ctx.putImageData(state.data, 0, 0);
            showToast('ğŸ“œ å·²é‚„åŸåˆ°æ­¥é©Ÿ ' + (index + 1));
        }
        
        function clearHistory() {
            historyStack = [historyStack[historyStack.length - 1]];
            updateHistoryList();
            showToast('ğŸ—‘ï¸ æ­·å²å·²æ¸…é™¤');
        }
        
        // ===== åœ–ç‰‡è³‡è¨Š =====
        function showInfoPanel() {
            togglePanel('infoPanel', 'infoBtn');
            updateImageInfo();
        }
        
        function updateImageInfo() {
            const content = document.getElementById('infoContent');
            if (!content) return;
            
            const dataUrl = canvas.toDataURL('image/png');
            const size = Math.round((dataUrl.length * 3/4) / 1024);
            
            content.innerHTML = `
                <div class="info-row"><span>å¯¬åº¦</span><span>${canvas.width} px</span></div>
                <div class="info-row"><span>é«˜åº¦</span><span>${canvas.height} px</span></div>
                <div class="info-row"><span>æ¯”ä¾‹</span><span>${(canvas.width/canvas.height).toFixed(2)}</span></div>
                <div class="info-row"><span>åƒç´ æ•¸</span><span>${(canvas.width * canvas.height / 1000000).toFixed(2)} MP</span></div>
                <div class="info-row"><span>é ä¼°å¤§å°</span><span>${size} KB</span></div>
            `;
        }
        
        // ===== é¡è‰²æ›¿æ› =====
        function showColorReplacePanel() {
            togglePanel('colorReplacePanel', 'colorReplaceBtn');
            
            document.getElementById('replaceTolerance').oninput = function() {
                document.getElementById('replaceToleranceVal').textContent = this.value;
            };
        }
        
        function pickBgColor() {
            showToast('ğŸ’¡ é»æ“Šç•«å¸ƒé¸å–èƒŒæ™¯é¡è‰²');
            eyedropperTarget = 'bgColor';
            canvas.style.cursor = 'crosshair';
        }
        
        function pickReplaceColor() {
            showToast('ğŸ’¡ é»æ“Šç•«å¸ƒé¸å–è¦æ›¿æ›çš„é¡è‰²');
            eyedropperTarget = 'replaceFrom';
            canvas.style.cursor = 'crosshair';
        }
        
        function showOverlayType(type) {
            // é¡¯ç¤ºä¸åŒé¡å‹çš„ç–ŠåŠ é¸é …
            const panels = ['overlayImage', 'overlayGradient', 'overlayPattern'];
            panels.forEach(p => {
                const el = document.getElementById(p);
                if (el) el.style.display = 'none';
            });
            const target = document.getElementById('overlay' + type.charAt(0).toUpperCase() + type.slice(1));
            if (target) target.style.display = 'block';
        }
        
        function replaceColor() {
            saveHistory();
            const fromHex = document.getElementById('replaceFrom').value;
            const toHex = document.getElementById('replaceTo').value;
            const tolerance = parseInt(document.getElementById('replaceTolerance').value);
            
            const fromRgb = hexToRgb(fromHex);
            const toRgb = hexToRgb(toHex);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const diff = Math.abs(data[i] - fromRgb.r) + Math.abs(data[i+1] - fromRgb.g) + Math.abs(data[i+2] - fromRgb.b);
                
                if (diff < tolerance * 3) {
                    data[i] = toRgb.r;
                    data[i+1] = toRgb.g;
                    data[i+2] = toRgb.b;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ¨ é¡è‰²å·²æ›¿æ›');
        }
        
        // ===== è­‰ä»¶ç…§ =====
        const idSizes = {
            '1inch': { w: 295, h: 413 },
            '2inch': { w: 413, h: 531 },
            'passport': { w: 413, h: 531 },
            'visa': { w: 390, h: 567 },
            'license': { w: 260, h: 354 }
        };
        let currentIdSize = '2inch';
        
        function showIdPhotoPanel() {
            togglePanel('idPhotoPanel', 'idPhotoBtn');
        }
        
        function setIdSize(size) {
            currentIdSize = size;
            document.querySelectorAll('.id-size').forEach(b => b.classList.remove('active'));
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            }
        }
        
        function generateIdPhoto() {
            saveHistory();
            const size = idSizes[currentIdSize];
            const bgColor = document.getElementById('idBgColor').value;
            const count = parseInt(document.getElementById('idCount').value);
            
            // å»ºç«‹å–®å¼µè­‰ä»¶ç…§
            const singleCanvas = document.createElement('canvas');
            singleCanvas.width = size.w;
            singleCanvas.height = size.h;
            const singleCtx = singleCanvas.getContext('2d');
            singleCtx.fillStyle = bgColor;
            singleCtx.fillRect(0, 0, size.w, size.h);
            
            // ç¸®æ”¾ä¸¦å±…ä¸­åŸåœ–
            const scale = Math.max(size.w / canvas.width, size.h / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const x = (size.w - newW) / 2;
            const y = (size.h - newH) / 2;
            singleCtx.drawImage(canvas, x, y, newW, newH);
            
            // æ’ç‰ˆ
            const cols = count === 1 ? 1 : 4;
            const rows = Math.ceil(count / cols);
            const gap = 10;
            const totalW = cols * size.w + (cols + 1) * gap;
            const totalH = rows * size.h + (rows + 1) * gap;
            
            canvas.width = totalW;
            canvas.height = totalH;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, totalW, totalH);
            
            for (let i = 0; i < count; i++) {
                const col = i % cols;
                const row = Math.floor(i / cols);
                ctx.drawImage(singleCanvas, gap + col * (size.w + gap), gap + row * (size.h + gap));
            }
            
            showToast('ğŸªª è­‰ä»¶ç…§å·²ç”¢ç”Ÿ');
        }
        
        // ===== æˆªåœ–ç¾åŒ– =====
        function showScreenshotPanel() {
            togglePanel('screenshotPanel', 'screenshotBtn');
        }
        
        function addDeviceFrame(device) {
            saveHistory();
            const bgType = document.getElementById('screenshotBg').value;
            const shadow = document.getElementById('screenshotShadow').checked;
            
            const padding = 60;
            const frameW = canvas.width + padding * 2;
            const frameH = canvas.height + padding * 2 + 40;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = frameW;
            tempCanvas.height = frameH;
            const tempCtx = tempCanvas.getContext('2d');
            
            // èƒŒæ™¯æ¼¸å±¤
            const gradients = {
                gradient1: ['#667eea', '#764ba2'],
                gradient2: ['#4facfe', '#00f2fe'],
                gradient3: ['#fa709a', '#fee140']
            };
            const colors = gradients[bgType] || ['#667eea', '#764ba2'];
            const gradient = tempCtx.createLinearGradient(0, 0, frameW, frameH);
            gradient.addColorStop(0, colors[0]);
            gradient.addColorStop(1, colors[1]);
            tempCtx.fillStyle = gradient;
            tempCtx.fillRect(0, 0, frameW, frameH);
            
            // è£ç½®æ¡†
            if (shadow) {
                tempCtx.shadowColor = 'rgba(0,0,0,0.3)';
                tempCtx.shadowBlur = 30;
                tempCtx.shadowOffsetY = 15;
            }
            
            tempCtx.fillStyle = '#1a1a1a';
            tempCtx.beginPath();
            tempCtx.roundRect(padding - 10, padding - 30, canvas.width + 20, canvas.height + 50, 20);
            tempCtx.fill();
            
            tempCtx.shadowColor = 'transparent';
            
            // è¢å¹•
            tempCtx.drawImage(canvas, padding, padding);
            
            // è£ç½®æ¨™è­˜
            tempCtx.fillStyle = '#333';
            tempCtx.fillRect(padding + canvas.width/2 - 30, padding - 20, 60, 8);
            
            canvas.width = frameW;
            canvas.height = frameH;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('ğŸ“² æˆªåœ–ç¾åŒ–å®Œæˆ');
        }
        
        // ===== åƒç´ ç•« =====
        function showPixelArtPanel() {
            togglePanel('pixelArtPanel', 'pixelArtBtn');
            
            document.getElementById('pixelSize').oninput = function() {
                document.getElementById('pixelSizeVal').textContent = this.value;
            };
        }
        
        function applyPixelArt(size) {
            saveHistory();
            size = size || parseInt(document.getElementById('pixelSize').value);
            
            const w = canvas.width;
            const h = canvas.height;
            
            // ç¸®å°
            const smallCanvas = document.createElement('canvas');
            smallCanvas.width = Math.floor(w / size);
            smallCanvas.height = Math.floor(h / size);
            const smallCtx = smallCanvas.getContext('2d');
            smallCtx.imageSmoothingEnabled = false;
            smallCtx.drawImage(canvas, 0, 0, smallCanvas.width, smallCanvas.height);
            
            // æ”¾å¤§å›ä¾†
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(smallCanvas, 0, 0, w, h);
            ctx.imageSmoothingEnabled = true;
            
            showToast('ğŸ‘¾ åƒç´ åŒ–å®Œæˆ');
        }
        
        // ===== ASCII è—è¡“ =====
        function showAsciiPanel() {
            togglePanel('asciiPanel', 'asciiBtn');
        }
        
        function generateAscii() {
            const density = parseInt(document.getElementById('asciiDensity').value);
            const charsets = {
                standard: '@#%*+=-:. ',
                blocks: 'â–ˆâ–“â–’â–‘ ',
                numbers: '9876543210 '
            };
            const charset = charsets[document.getElementById('asciiCharset').value] || charsets.standard;
            
            const step = 12 - density;
            let ascii = '';
            
            for (let y = 0; y < canvas.height; y += step * 2) {
                for (let x = 0; x < canvas.width; x += step) {
                    const pixel = ctx.getImageData(x, y, 1, 1).data;
                    const brightness = (pixel[0] + pixel[1] + pixel[2]) / 3;
                    const charIndex = Math.floor((brightness / 255) * (charset.length - 1));
                    ascii += charset[charIndex];
                }
                ascii += '\n';
            }
            
            document.getElementById('asciiOutput').value = ascii;
            showToast('ğŸ’» ASCII è—è¡“å·²ç”Ÿæˆ');
        }
        
        function copyAscii() {
            const ascii = document.getElementById('asciiOutput').value;
            navigator.clipboard.writeText(ascii).then(() => {
                showToast('ğŸ“‹ å·²è¤‡è£½');
            });
        }
        
        function asciiToImage() {
            saveHistory();
            const ascii = document.getElementById('asciiOutput').value;
            const lines = ascii.split('\n');
            
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00ff00';
            ctx.font = '8px monospace';
            
            lines.forEach((line, i) => {
                ctx.fillText(line, 0, i * 8 + 8);
            });
            
            showToast('ğŸ–¼ï¸ å·²è½‰æ›ç‚ºåœ–ç‰‡');
        }
        
        // ===== é›™è‰²èª¿ =====
        function showDuotonePanel() {
            togglePanel('duotonePanel', 'duotoneBtn');
        }
        
        function applyDuotone(dark, light) {
            saveHistory();
            const darkRgb = hexToRgb(dark);
            const lightRgb = hexToRgb(light);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const brightness = (data[i] + data[i+1] + data[i+2]) / 3 / 255;
                data[i] = darkRgb.r + (lightRgb.r - darkRgb.r) * brightness;
                data[i+1] = darkRgb.g + (lightRgb.g - darkRgb.g) * brightness;
                data[i+2] = darkRgb.b + (lightRgb.b - darkRgb.b) * brightness;
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ­ é›™è‰²èª¿å·²å¥—ç”¨');
        }
        
        function applyDuotoneCustom() {
            const dark = document.getElementById('duotoneDark').value;
            const light = document.getElementById('duotoneLight').value;
            applyDuotone(dark, light);
        }
        
        // ===== æ¼¸å±¤ç–ŠåŠ  =====
        function showGradientPanel() {
            togglePanel('gradientPanel', 'gradientBtn');
            
            document.getElementById('gradientAngle').oninput = function() {
                document.getElementById('gradientAngleVal').textContent = this.value + 'Â°';
            };
        }
        
        function applyGradientOverlay(color1, color2) {
            saveHistory();
            const angle = parseInt(document.getElementById('gradientAngle')?.value || 135);
            const opacity = parseFloat(document.getElementById('gradientOpacity')?.value || 0.5);
            
            const radians = angle * Math.PI / 180;
            const x1 = canvas.width/2 - Math.cos(radians) * canvas.width;
            const y1 = canvas.height/2 - Math.sin(radians) * canvas.height;
            const x2 = canvas.width/2 + Math.cos(radians) * canvas.width;
            const y2 = canvas.height/2 + Math.sin(radians) * canvas.height;
            
            const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            
            ctx.globalAlpha = opacity;
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalAlpha = 1;
            
            showToast('ğŸŒ… æ¼¸å±¤å·²ç–ŠåŠ ');
        }
        
        // ===== é›œè¨Š =====
        function showNoisePanel() {
            togglePanel('noisePanel', 'noiseBtn');
            
            document.getElementById('noiseAmount').oninput = function() {
                document.getElementById('noiseAmountVal').textContent = this.value;
            };
        }
        
        function applyNoise() {
            saveHistory();
            const amount = parseInt(document.getElementById('noiseAmount').value);
            const isColor = document.getElementById('noiseColor').checked;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const noise = (Math.random() - 0.5) * amount * 2.55;
                if (isColor) {
                    data[i] = Math.min(255, Math.max(0, data[i] + (Math.random() - 0.5) * amount * 2.55));
                    data[i+1] = Math.min(255, Math.max(0, data[i+1] + (Math.random() - 0.5) * amount * 2.55));
                    data[i+2] = Math.min(255, Math.max(0, data[i+2] + (Math.random() - 0.5) * amount * 2.55));
                } else {
                    data[i] = Math.min(255, Math.max(0, data[i] + noise));
                    data[i+1] = Math.min(255, Math.max(0, data[i+1] + noise));
                    data[i+2] = Math.min(255, Math.max(0, data[i+2] + noise));
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ“» é›œè¨Šå·²æ·»åŠ ');
        }
        
        // ===== æ™¯æ·±æ¨¡ç³Š =====
        function showBlurBgPanel() {
            togglePanel('blurBgPanel', 'blurBgBtn');
            
            document.getElementById('blurAmount').oninput = function() {
                document.getElementById('blurAmountVal').textContent = this.value;
            };
        }
        
        function applySelectiveBlur() {
            if (!currentSelection) {
                showToast('âš ï¸ è«‹å…ˆé¸å–è¦ä¿æŒæ¸…æ™°çš„å€åŸŸ');
                return;
            }
            
            saveHistory();
            const blurAmount = document.getElementById('blurAmount').value;
            const { x, y, w, h } = currentSelection;
            
            // å„²å­˜é¸å–å€åŸŸ
            const selectedArea = ctx.getImageData(x, y, w, h);
            
            // æ¨¡ç³Šæ•´å¼µåœ–
            ctx.filter = `blur(${blurAmount}px)`;
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'none';
            
            // é‚„åŸé¸å–å€åŸŸ
            ctx.putImageData(selectedArea, x, y);
            
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            
            showToast('ğŸŒ«ï¸ æ™¯æ·±æ•ˆæœå·²å¥—ç”¨');
        }
        
        // ===== ç´‹ç† =====
        function showTexturePanel() {
            togglePanel('texturePanel', 'textureBtn');
        }
        
        function applyTexture(type) {
            saveHistory();
            const amount = parseFloat(document.getElementById('textureAmount')?.value || 0.3);
            
            // å»ºç«‹ç´‹ç†
            const textureCanvas = document.createElement('canvas');
            textureCanvas.width = canvas.width;
            textureCanvas.height = canvas.height;
            const textureCtx = textureCanvas.getContext('2d');
            
            // ç°¡å–®ç´‹ç†æ¨¡æ“¬
            const imageData = textureCtx.createImageData(canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const noise = Math.random() * 255;
                data[i] = data[i+1] = data[i+2] = noise;
                data[i+3] = 255;
            }
            
            textureCtx.putImageData(imageData, 0, 0);
            
            ctx.globalAlpha = amount;
            ctx.globalCompositeOperation = 'overlay';
            ctx.drawImage(textureCanvas, 0, 0);
            ctx.globalCompositeOperation = 'source-over';
            ctx.globalAlpha = 1;
            
            showToast('ğŸ§± ç´‹ç†å·²ç–ŠåŠ ');
        }
        
        // ===== æ•£æ™¯ =====
        function showBokehPanel() {
            togglePanel('bokehPanel', 'bokehBtn');
        }
        
        function addBokeh() {
            saveHistory();
            const count = parseInt(document.getElementById('bokehCount').value);
            const size = parseInt(document.getElementById('bokehSize').value);
            const colorType = document.getElementById('bokehColor').value;
            
            const colors = {
                warm: ['#ff9a9e', '#fecfef', '#ffecd2', '#fcb69f'],
                cool: ['#a1c4fd', '#c2e9fb', '#d4fc79', '#96e6a1'],
                rainbow: ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#8b00ff'],
                gold: ['#ffd700', '#ffec8b', '#fff8dc', '#ffefd5']
            };
            const palette = colors[colorType] || colors.warm;
            
            for (let i = 0; i < count; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const r = Math.random() * size + 10;
                const color = palette[Math.floor(Math.random() * palette.length)];
                
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.globalAlpha = Math.random() * 0.3 + 0.1;
                ctx.fill();
            }
            ctx.globalAlpha = 1;
            
            showToast('ğŸ’¡ æ•£æ™¯å·²æ·»åŠ ');
        }
        
        // ===== é¡åƒ =====
        function showMirrorPanel() {
            togglePanel('mirrorPanel', 'mirrorBtn');
        }
        
        function applyMirror(type) {
            saveHistory();
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            switch(type) {
                case 'left':
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height, 0, 0, canvas.width/2, canvas.height);
                    tempCtx.save();
                    tempCtx.translate(canvas.width, 0);
                    tempCtx.scale(-1, 1);
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height, 0, 0, canvas.width/2, canvas.height);
                    tempCtx.restore();
                    break;
                case 'right':
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    tempCtx.drawImage(canvas, canvas.width/2, 0, canvas.width/2, canvas.height, canvas.width/2, 0, canvas.width/2, canvas.height);
                    tempCtx.save();
                    tempCtx.translate(0, 0);
                    tempCtx.scale(-1, 1);
                    tempCtx.drawImage(canvas, canvas.width/2, 0, canvas.width/2, canvas.height, -canvas.width/2, 0, canvas.width/2, canvas.height);
                    tempCtx.restore();
                    break;
                case 'quad':
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    // å·¦ä¸Š
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height/2, 0, 0, canvas.width/2, canvas.height/2);
                    // å³ä¸Š (æ°´å¹³ç¿»è½‰)
                    tempCtx.save();
                    tempCtx.translate(canvas.width, 0);
                    tempCtx.scale(-1, 1);
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height/2, 0, 0, canvas.width/2, canvas.height/2);
                    tempCtx.restore();
                    // å·¦ä¸‹ (å‚ç›´ç¿»è½‰)
                    tempCtx.save();
                    tempCtx.translate(0, canvas.height);
                    tempCtx.scale(1, -1);
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height/2, 0, 0, canvas.width/2, canvas.height/2);
                    tempCtx.restore();
                    // å³ä¸‹ (é›™ç¿»è½‰)
                    tempCtx.save();
                    tempCtx.translate(canvas.width, canvas.height);
                    tempCtx.scale(-1, -1);
                    tempCtx.drawImage(canvas, 0, 0, canvas.width/2, canvas.height/2, 0, 0, canvas.width/2, canvas.height/2);
                    tempCtx.restore();
                    break;
                default:
                    return;
            }
            
            ctx.drawImage(tempCanvas, 0, 0);
            showToast('ğŸª é¡åƒæ•ˆæœå·²å¥—ç”¨');
        }
        
        // ===== åˆ†å‰² =====
        function showSplitPanel() {
            togglePanel('splitPanel', 'splitBtn');
        }
        
        function setSplit(rows, cols) {
            document.getElementById('splitRows').value = rows;
            document.getElementById('splitCols').value = cols;
        }
        
        async function splitImage() {
            const rows = parseInt(document.getElementById('splitRows').value);
            const cols = parseInt(document.getElementById('splitCols').value);
            
            const cellW = Math.floor(canvas.width / cols);
            const cellH = Math.floor(canvas.height / rows);
            
            showToast('ğŸ”² åˆ†å‰²ä¸­...');
            
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = cellW;
                    tempCanvas.height = cellH;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(canvas, c * cellW, r * cellH, cellW, cellH, 0, 0, cellW, cellH);
                    
                    const link = document.createElement('a');
                    link.download = `split-${r+1}-${c+1}.png`;
                    link.href = tempCanvas.toDataURL('image/png');
                    link.click();
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            showToast('âœ… åˆ†å‰²å®Œæˆï¼Œå…± ' + (rows * cols) + ' å¼µ');
        }
        
        // ===== ç¤¾ç¾¤åª’é«”å°ºå¯¸ =====
        function showSocialPanel() {
            togglePanel('socialPanel', 'socialBtn');
        }
        
        const socialSizes = {
            'ig-post': { w: 1080, h: 1080 },
            'ig-story': { w: 1080, h: 1920 },
            'ig-reel': { w: 1080, h: 1920 },
            'fb-post': { w: 1200, h: 630 },
            'fb-cover': { w: 820, h: 312 },
            'fb-story': { w: 1080, h: 1920 },
            'tw-post': { w: 1200, h: 675 },
            'tw-header': { w: 1500, h: 500 },
            'yt-thumb': { w: 1280, h: 720 },
            'yt-banner': { w: 2560, h: 1440 },
            'li-post': { w: 1200, h: 627 },
            'li-cover': { w: 1584, h: 396 }
        };
        
        function resizeForSocial(platform) {
            const size = socialSizes[platform];
            if (!size) return;
            
            saveHistory();
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = size.w;
            tempCanvas.height = size.h;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, size.w, size.h);
            
            // ç­‰æ¯”ä¾‹ç¸®æ”¾å±…ä¸­
            const scale = Math.min(size.w / canvas.width, size.h / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const x = (size.w - newW) / 2;
            const y = (size.h - newH) / 2;
            tempCtx.drawImage(canvas, x, y, newW, newH);
            
            canvas.width = size.w;
            canvas.height = size.h;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('ğŸ“± å·²èª¿æ•´ç‚º ' + size.w + 'Ã—' + size.h);
        }
        
        // ===== é€²éšåŒ¯å‡º =====
        function showExportPanel() {
            togglePanel('exportPanel', 'exportBtn');
            
            document.getElementById('exportQuality').oninput = function() {
                document.getElementById('exportQualityVal').textContent = Math.round(this.value * 100) + '%';
            };
            
            document.getElementById('exportFormat').onchange = function() {
                document.getElementById('jpegQualityOption').style.display = 
                    (this.value === 'jpeg' || this.value === 'webp') ? 'block' : 'none';
            };
        }
        
        function advancedExport() {
            const format = document.getElementById('exportFormat').value;
            const quality = parseFloat(document.getElementById('exportQuality').value);
            const scale = parseFloat(document.getElementById('exportScale').value);
            const filename = document.getElementById('exportFilename').value || 'image-magic';
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width * scale;
            tempCanvas.height = canvas.height * scale;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
            
            let mimeType = 'image/png';
            if (format === 'jpeg') mimeType = 'image/jpeg';
            else if (format === 'webp') mimeType = 'image/webp';
            else if (format === 'gif') mimeType = 'image/gif';
            else if (format === 'bmp') mimeType = 'image/bmp';
            
            const link = document.createElement('a');
            link.download = `${filename}.${format}`;
            link.href = tempCanvas.toDataURL(mimeType, quality);
            link.click();
            
            showToast('ğŸ’¾ å·²ä¸‹è¼‰ ' + filename + '.' + format);
        }
        
        // ===== è—è¡“æ•ˆæœå¿«æ·åŠŸèƒ½ =====
        function applyCartoon() {
            saveHistory();
            // ç°¡åŒ–è‰²å½© + é‚Šç·£å¼·åŒ–
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.floor(data[i] / 40) * 40;
                data[i+1] = Math.floor(data[i+1] / 40) * 40;
                data[i+2] = Math.floor(data[i+2] / 40) * 40;
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ¨ å¡é€šåŒ–å®Œæˆ');
        }
        
        function applySketch() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // ç°éš
            for (let i = 0; i < imageData.data.length; i += 4) {
                const avg = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
                imageData.data[i] = imageData.data[i+1] = imageData.data[i+2] = avg;
            }
            
            // åè½‰ä¸¦ç–ŠåŠ 
            applyConvolution(imageData, [-1, -1, -1, -1, 9, -1, -1, -1, -1]);
            ctx.putImageData(imageData, 0, 0);
            
            showToast('âœï¸ ç´ ææ•ˆæœå®Œæˆ');
        }
        
        function applyOilPaint() {
            saveHistory();
            // ç°¡åŒ–çš„æ²¹ç•«æ•ˆæœ
            ctx.filter = 'blur(2px)';
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'contrast(1.5) saturate(1.5)';
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'none';
            
            showToast('ğŸ–¼ï¸ æ²¹ç•«æ•ˆæœå®Œæˆ');
        }
        
        function applyGlitch() {
            saveHistory();
            const sliceHeight = 10;
            const slices = Math.floor(canvas.height / sliceHeight);
            
            for (let i = 0; i < slices; i++) {
                if (Math.random() > 0.7) {
                    const y = i * sliceHeight;
                    const offset = (Math.random() - 0.5) * 30;
                    const slice = ctx.getImageData(0, y, canvas.width, sliceHeight);
                    ctx.putImageData(slice, offset, y);
                }
            }
            
            // RGB åç§»
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                if (i + 20 < data.length) {
                    data[i] = data[i + 20]; // R åç§»
                }
                if (i - 20 >= 0) {
                    data[i + 2] = data[i - 18]; // B åç§»
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ“º æ•…éšœæ•ˆæœå®Œæˆ');
        }
        
        function applyVignette() {
            saveHistory();
            const gradient = ctx.createRadialGradient(
                canvas.width/2, canvas.height/2, canvas.width * 0.3,
                canvas.width/2, canvas.height/2, canvas.width * 0.7
            );
            gradient.addColorStop(0, 'transparent');
            gradient.addColorStop(1, 'rgba(0,0,0,0.7)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            showToast('ğŸ”˜ æšˆå½±æ•ˆæœå®Œæˆ');
        }
        
        function applyLightLeak() {
            saveHistory();
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, 'rgba(255,200,100,0.3)');
            gradient.addColorStop(0.5, 'transparent');
            gradient.addColorStop(1, 'rgba(255,100,150,0.2)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            showToast('â˜€ï¸ æ¼å…‰æ•ˆæœå®Œæˆ');
        }
        
        function applyTiltShift() {
            saveHistory();
            // ä¸Šä¸‹æ¨¡ç³Šï¼Œä¸­é–“æ¸…æ™°
            const centerY = canvas.height / 2;
            const blurHeight = canvas.height * 0.3;
            
            // å„²å­˜ä¸­é–“æ¸…æ™°å€åŸŸ
            const clearArea = ctx.getImageData(0, centerY - blurHeight/2, canvas.width, blurHeight);
            
            // æ¨¡ç³Šæ•´å¼µåœ–
            ctx.filter = 'blur(5px)';
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'none';
            
            // é‚„åŸä¸­é–“
            ctx.putImageData(clearArea, 0, centerY - blurHeight/2);
            
            showToast('ğŸ™ï¸ ç§»è»¸æ•ˆæœå®Œæˆ');
        }
        
        function applyKaleidoscope() {
            saveHistory();
            const segments = 8;
            const angleStep = (Math.PI * 2) / segments;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            
            for (let i = 0; i < segments; i++) {
                tempCtx.save();
                tempCtx.translate(cx, cy);
                tempCtx.rotate(i * angleStep);
                if (i % 2 === 1) tempCtx.scale(-1, 1);
                
                tempCtx.beginPath();
                tempCtx.moveTo(0, 0);
                tempCtx.arc(0, 0, Math.max(canvas.width, canvas.height), 0, angleStep);
                tempCtx.closePath();
                tempCtx.clip();
                
                tempCtx.drawImage(canvas, -cx, -cy);
                tempCtx.restore();
            }
            
            ctx.drawImage(tempCanvas, 0, 0);
            showToast('ğŸ”® è¬èŠ±ç­’æ•ˆæœå®Œæˆ');
        }
        
        // ===== ç¶²æ ¼é¡¯ç¤º =====
        let gridVisible = false;
        
        function toggleGrid() {
            gridVisible = !gridVisible;
            document.getElementById('gridBtn').classList.toggle('active', gridVisible);
            
            if (gridVisible) {
                // ç•«ç¶²æ ¼ï¼ˆæš«æ™‚çš„ï¼‰
                ctx.strokeStyle = 'rgba(0,150,255,0.3)';
                ctx.lineWidth = 1;
                
                const gridSize = 50;
                for (let x = 0; x < canvas.width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                for (let y = 0; y < canvas.height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                showToast('ğŸ“ ç¶²æ ¼å·²é¡¯ç¤º');
            } else {
                // é‚„åŸ
                undoAction();
                showToast('ğŸ“ ç¶²æ ¼å·²éš±è—');
            }
        }
        
        // ===== æ¯”è¼ƒåŠŸèƒ½ =====
        let compareMode = false;
        
        function toggleCompare() {
            if (historyStack.length < 2) {
                showToast('âš ï¸ éœ€è¦ç·¨è¼¯éçš„æ­·å²æ‰èƒ½æ¯”è¼ƒ');
                return;
            }
            
            compareMode = !compareMode;
            document.getElementById('compareBtn').classList.toggle('active', compareMode);
            
            if (compareMode) {
                // é¡¯ç¤ºåŸå§‹ vs ç¾åœ¨
                const original = historyStack[0];
                const current = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // å·¦åŠåŸå§‹ï¼Œå³åŠç¾åœ¨
                ctx.putImageData(original.data, 0, 0);
                
                // ç•«åˆ†å‰²ç·š
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(canvas.width/2, 0);
                ctx.lineTo(canvas.width/2, canvas.height);
                ctx.stroke();
                
                // å³åŠç¾åœ¨
                ctx.putImageData(current, canvas.width/2, 0, canvas.width/2, 0, canvas.width/2, canvas.height);
                
                showToast('ğŸ”€ æ¯”è¼ƒæ¨¡å¼ï¼šå·¦åŸå§‹ / å³ç¾åœ¨');
            } else {
                undoAction();
                showToast('ğŸ”€ æ¯”è¼ƒæ¨¡å¼å·²é—œé–‰');
            }
        }
        
        // ===== åœ–å±¤ç³»çµ± =====
        let layers = [];
        let currentLayerId = 0;
        let activeLayerIndex = 0;
        
        function showLayerPanel() {
            togglePanel('layerPanel', 'layerBtn');
            updateLayerList();
        }
        
        function initLayers() {
            layers = [{
                id: currentLayerId++,
                name: 'èƒŒæ™¯',
                visible: true,
                locked: false,
                opacity: 100,
                blendMode: 'normal',
                canvas: document.createElement('canvas')
            }];
            layers[0].canvas.width = canvas.width;
            layers[0].canvas.height = canvas.height;
            layers[0].canvas.getContext('2d').drawImage(canvas, 0, 0);
        }
        
        function addLayer() {
            const newLayer = {
                id: currentLayerId++,
                name: 'åœ–å±¤ ' + layers.length,
                visible: true,
                locked: false,
                opacity: 100,
                blendMode: 'normal',
                canvas: document.createElement('canvas')
            };
            newLayer.canvas.width = canvas.width;
            newLayer.canvas.height = canvas.height;
            layers.push(newLayer);
            activeLayerIndex = layers.length - 1;
            updateLayerList();
            showToast('ğŸ“š å·²æ–°å¢åœ–å±¤');
        }
        
        function duplicateLayer() {
            const source = layers[activeLayerIndex];
            const newLayer = {
                id: currentLayerId++,
                name: source.name + ' å‰¯æœ¬',
                visible: true,
                locked: false,
                opacity: source.opacity,
                blendMode: source.blendMode,
                canvas: document.createElement('canvas')
            };
            newLayer.canvas.width = source.canvas.width;
            newLayer.canvas.height = source.canvas.height;
            newLayer.canvas.getContext('2d').drawImage(source.canvas, 0, 0);
            layers.splice(activeLayerIndex + 1, 0, newLayer);
            updateLayerList();
            showToast('ğŸ“‹ å·²è¤‡è£½åœ–å±¤');
        }
        
        function deleteLayer() {
            if (layers.length <= 1) {
                showToast('âš ï¸ ç„¡æ³•åˆªé™¤æœ€å¾Œä¸€å€‹åœ–å±¤');
                return;
            }
            layers.splice(activeLayerIndex, 1);
            activeLayerIndex = Math.min(activeLayerIndex, layers.length - 1);
            updateLayerList();
            compositeLayers();
            showToast('ğŸ—‘ï¸ å·²åˆªé™¤åœ–å±¤');
        }
        
        function mergeDown() {
            if (activeLayerIndex === 0) {
                showToast('âš ï¸ å·²æ˜¯æœ€åº•å±¤');
                return;
            }
            const upper = layers[activeLayerIndex];
            const lower = layers[activeLayerIndex - 1];
            const lowerCtx = lower.canvas.getContext('2d');
            lowerCtx.globalAlpha = upper.opacity / 100;
            lowerCtx.globalCompositeOperation = upper.blendMode;
            lowerCtx.drawImage(upper.canvas, 0, 0);
            lowerCtx.globalAlpha = 1;
            lowerCtx.globalCompositeOperation = 'source-over';
            layers.splice(activeLayerIndex, 1);
            activeLayerIndex--;
            updateLayerList();
            compositeLayers();
            showToast('â¬‡ï¸ å·²å‘ä¸‹åˆä½µ');
        }
        
        function flattenLayers() {
            compositeLayers();
            const flatCanvas = document.createElement('canvas');
            flatCanvas.width = canvas.width;
            flatCanvas.height = canvas.height;
            flatCanvas.getContext('2d').drawImage(canvas, 0, 0);
            layers = [{
                id: currentLayerId++,
                name: 'èƒŒæ™¯',
                visible: true,
                locked: false,
                opacity: 100,
                blendMode: 'normal',
                canvas: flatCanvas
            }];
            activeLayerIndex = 0;
            updateLayerList();
            showToast('ğŸ“„ å·²å¹³é¢åŒ–æ‰€æœ‰åœ–å±¤');
        }
        
        function compositeLayers() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            layers.forEach(layer => {
                if (!layer.visible) return;
                ctx.globalAlpha = layer.opacity / 100;
                ctx.globalCompositeOperation = layer.blendMode;
                ctx.drawImage(layer.canvas, 0, 0);
            });
            ctx.globalAlpha = 1;
            ctx.globalCompositeOperation = 'source-over';
        }
        
        function updateLayerList() {
            const list = document.getElementById('layerList');
            if (!list) return;
            list.innerHTML = '';
            
            for (let i = layers.length - 1; i >= 0; i--) {
                const layer = layers[i];
                const item = document.createElement('div');
                item.className = 'layer-item' + (i === activeLayerIndex ? ' active' : '');
                item.innerHTML = `
                    <span class="layer-visibility" onclick="toggleLayerVisibility(${i})">${layer.visible ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸'}</span>
                    <span class="layer-thumb"></span>
                    <span class="layer-name">${layer.name}</span>
                    <span class="layer-lock" onclick="toggleLayerLock(${i})">${layer.locked ? 'ğŸ”’' : 'ğŸ”“'}</span>
                `;
                item.onclick = (e) => {
                    if (e.target.classList.contains('layer-visibility') || e.target.classList.contains('layer-lock')) return;
                    activeLayerIndex = i;
                    updateLayerList();
                };
                list.appendChild(item);
            }
        }
        
        function toggleLayerVisibility(index) {
            layers[index].visible = !layers[index].visible;
            updateLayerList();
            compositeLayers();
        }
        
        function toggleLayerLock(index) {
            layers[index].locked = !layers[index].locked;
            updateLayerList();
        }
        
        // ===== æ¶²åŒ–è®Šå½¢ =====
        let liquifyTool = 'push';
        
        function showLiquifyPanel() {
            togglePanel('liquifyPanel', 'liquifyBtn');
            setTool('liquify');
        }
        
        function setLiquifyTool(tool) {
            liquifyTool = tool;
            document.querySelectorAll('.liquify-tool').forEach(t => t.classList.remove('active'));
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            }
        }
        
        function applyLiquifyEffect(x, y) {
            const size = parseInt(document.getElementById('liquifySize')?.value || 50);
            const strength = parseInt(document.getElementById('liquifyStrength')?.value || 50) / 100;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;
            
            // ç°¡åŒ–çš„æ¶²åŒ–æ•ˆæœ
            for (let py = Math.max(0, y - size); py < Math.min(h, y + size); py++) {
                for (let px = Math.max(0, x - size); px < Math.min(w, x + size); px++) {
                    const dist = Math.sqrt((px - x) ** 2 + (py - y) ** 2);
                    if (dist < size) {
                        const factor = (1 - dist / size) * strength;
                        // ç°¡å–®çš„è†¨è„¹æ•ˆæœ
                        if (liquifyTool === 'bloat') {
                            const srcX = Math.round(x + (px - x) * (1 - factor));
                            const srcY = Math.round(y + (py - y) * (1 - factor));
                            if (srcX >= 0 && srcX < w && srcY >= 0 && srcY < h) {
                                const dstIdx = (py * w + px) * 4;
                                const srcIdx = (srcY * w + srcX) * 4;
                                data[dstIdx] = data[srcIdx];
                                data[dstIdx + 1] = data[srcIdx + 1];
                                data[dstIdx + 2] = data[srcIdx + 2];
                            }
                        }
                    }
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        // ===== æ›²ç·šèª¿æ•´ =====
        let curveChannel = 'rgb';
        let curvePoints = { rgb: [[0, 0], [255, 255]], r: [[0, 0], [255, 255]], g: [[0, 0], [255, 255]], b: [[0, 0], [255, 255]] };
        
        function showCurvePanel() {
            togglePanel('curvePanel', 'curveBtn');
            initCurveCanvas();
        }
        
        function initCurveCanvas() {
            const curveCanvas = document.getElementById('curveCanvas');
            if (!curveCanvas) return;
            const curveCtx = curveCanvas.getContext('2d');
            drawCurve(curveCtx);
        }
        
        function drawCurve(curveCtx) {
            curveCtx.fillStyle = '#1a1a2e';
            curveCtx.fillRect(0, 0, 256, 256);
            
            // ç•«ç¶²æ ¼
            curveCtx.strokeStyle = '#333';
            curveCtx.lineWidth = 1;
            for (let i = 0; i < 256; i += 64) {
                curveCtx.beginPath();
                curveCtx.moveTo(i, 0);
                curveCtx.lineTo(i, 256);
                curveCtx.stroke();
                curveCtx.beginPath();
                curveCtx.moveTo(0, i);
                curveCtx.lineTo(256, i);
                curveCtx.stroke();
            }
            
            // ç•«å°è§’ç·š
            curveCtx.strokeStyle = '#666';
            curveCtx.beginPath();
            curveCtx.moveTo(0, 255);
            curveCtx.lineTo(255, 0);
            curveCtx.stroke();
            
            // ç•«æ›²ç·š
            const points = curvePoints[curveChannel];
            curveCtx.strokeStyle = curveChannel === 'rgb' ? '#fff' : 
                                   curveChannel === 'r' ? '#f00' : 
                                   curveChannel === 'g' ? '#0f0' : '#00f';
            curveCtx.lineWidth = 2;
            curveCtx.beginPath();
            curveCtx.moveTo(points[0][0], 255 - points[0][1]);
            for (let i = 1; i < points.length; i++) {
                curveCtx.lineTo(points[i][0], 255 - points[i][1]);
            }
            curveCtx.stroke();
            
            // ç•«æ§åˆ¶é»
            curveCtx.fillStyle = '#fff';
            points.forEach(p => {
                curveCtx.beginPath();
                curveCtx.arc(p[0], 255 - p[1], 5, 0, Math.PI * 2);
                curveCtx.fill();
            });
        }
        
        function setCurveChannel(channel) {
            curveChannel = channel;
            document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active'));
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            }
            initCurveCanvas();
        }
        
        function applyCurvePreset(preset) {
            switch(preset) {
                case 'contrast':
                    curvePoints[curveChannel] = [[0, 0], [64, 48], [192, 208], [255, 255]];
                    break;
                case 'bright':
                    curvePoints[curveChannel] = [[0, 0], [128, 160], [255, 255]];
                    break;
                case 'dark':
                    curvePoints[curveChannel] = [[0, 0], [128, 96], [255, 255]];
                    break;
                case 'fade':
                    curvePoints[curveChannel] = [[0, 32], [255, 224]];
                    break;
                case 's-curve':
                    curvePoints[curveChannel] = [[0, 0], [64, 48], [128, 128], [192, 208], [255, 255]];
                    break;
            }
            initCurveCanvas();
        }
        
        function applyCurves() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // å»ºç«‹æŸ¥æ‰¾è¡¨
            const lut = { r: [], g: [], b: [] };
            for (let i = 0; i < 256; i++) {
                lut.r[i] = interpolateCurve(curvePoints.rgb, i);
                lut.g[i] = interpolateCurve(curvePoints.rgb, i);
                lut.b[i] = interpolateCurve(curvePoints.rgb, i);
                
                if (curvePoints.r.length > 2) lut.r[i] = interpolateCurve(curvePoints.r, lut.r[i]);
                if (curvePoints.g.length > 2) lut.g[i] = interpolateCurve(curvePoints.g, lut.g[i]);
                if (curvePoints.b.length > 2) lut.b[i] = interpolateCurve(curvePoints.b, lut.b[i]);
            }
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = lut.r[data[i]];
                data[i + 1] = lut.g[data[i + 1]];
                data[i + 2] = lut.b[data[i + 2]];
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ“ˆ æ›²ç·šå·²å¥—ç”¨');
        }
        
        function interpolateCurve(points, x) {
            for (let i = 0; i < points.length - 1; i++) {
                if (x >= points[i][0] && x <= points[i + 1][0]) {
                    const t = (x - points[i][0]) / (points[i + 1][0] - points[i][0]);
                    return Math.round(points[i][1] + t * (points[i + 1][1] - points[i][1]));
                }
            }
            return x;
        }
        
        // ===== è‰²éšèª¿æ•´ =====
        function showLevelPanel() {
            togglePanel('levelPanel', 'levelBtn');
            drawLevelHistogram();
        }
        
        function drawLevelHistogram() {
            const container = document.getElementById('levelHistogram');
            if (!container) return;
            
            // è¨ˆç®—ç›´æ–¹åœ–
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const histogram = new Array(256).fill(0);
            
            for (let i = 0; i < imageData.data.length; i += 4) {
                const lum = Math.round(0.299 * imageData.data[i] + 0.587 * imageData.data[i+1] + 0.114 * imageData.data[i+2]);
                histogram[lum]++;
            }
            
            const max = Math.max(...histogram);
            
            // ç¹ªè£½
            let html = '<svg width="256" height="100" style="background:#1a1a2e">';
            for (let i = 0; i < 256; i++) {
                const h = (histogram[i] / max) * 100;
                html += `<rect x="${i}" y="${100-h}" width="1" height="${h}" fill="#666"/>`;
            }
            html += '</svg>';
            container.innerHTML = html;
        }
        
        function applyLevels() {
            saveHistory();
            const inBlack = parseInt(document.getElementById('levelInBlack')?.value || 0);
            const inWhite = parseInt(document.getElementById('levelInWhite')?.value || 255);
            const gamma = parseFloat(document.getElementById('levelInGamma')?.value || 1);
            const outBlack = parseInt(document.getElementById('levelOutBlack')?.value || 0);
            const outWhite = parseInt(document.getElementById('levelOutWhite')?.value || 255);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                for (let c = 0; c < 3; c++) {
                    let val = data[i + c];
                    // è¼¸å…¥è‰²éš
                    val = (val - inBlack) / (inWhite - inBlack);
                    val = Math.max(0, Math.min(1, val));
                    // Gamma
                    val = Math.pow(val, 1 / gamma);
                    // è¼¸å‡ºè‰²éš
                    val = val * (outWhite - outBlack) + outBlack;
                    data[i + c] = Math.round(val);
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ“Š è‰²éšå·²å¥—ç”¨');
        }
        
        function resetLevels() {
            document.getElementById('levelInBlack').value = 0;
            document.getElementById('levelInWhite').value = 255;
            document.getElementById('levelInGamma').value = 1;
            document.getElementById('levelOutBlack').value = 0;
            document.getElementById('levelOutWhite').value = 255;
        }
        
        // ===== ç›´æ–¹åœ–åˆ†æ =====
        function showHistogramPanel() {
            togglePanel('histogramPanel', 'histogramBtn');
            drawHistogram('all');
        }
        
        let currentHistogramChannel = 'all';
        
        function drawHistogram(channel) {
            if (channel) currentHistogramChannel = channel;
            
            const histCanvas = document.getElementById('histogramCanvas');
            if (!histCanvas) return;
            const histCtx = histCanvas.getContext('2d');
            
            // è¨­å®šç•«å¸ƒå¤§å°
            histCanvas.width = 280;
            histCanvas.height = 150;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const histR = new Array(256).fill(0);
            const histG = new Array(256).fill(0);
            const histB = new Array(256).fill(0);
            const histL = new Array(256).fill(0);
            
            for (let i = 0; i < imageData.data.length; i += 4) {
                histR[imageData.data[i]]++;
                histG[imageData.data[i + 1]]++;
                histB[imageData.data[i + 2]]++;
                const lum = Math.round(0.299 * imageData.data[i] + 0.587 * imageData.data[i+1] + 0.114 * imageData.data[i+2]);
                histL[lum]++;
            }
            
            const maxVal = Math.max(...histR, ...histG, ...histB, ...histL);
            
            // æ¸…é™¤ç•«å¸ƒ
            histCtx.fillStyle = '#1a1a2e';
            histCtx.fillRect(0, 0, 280, 150);
            
            const w = 280 / 256;
            
            histCtx.globalAlpha = 0.7;
            
            if (currentHistogramChannel === 'all' || currentHistogramChannel === 'red') {
                histCtx.fillStyle = '#ff4444';
                for (let i = 0; i < 256; i++) {
                    const h = (histR[i] / maxVal) * 140;
                    histCtx.fillRect(i * w, 150 - h, w, h);
                }
            }
            if (currentHistogramChannel === 'all' || currentHistogramChannel === 'green') {
                histCtx.fillStyle = '#44ff44';
                for (let i = 0; i < 256; i++) {
                    const h = (histG[i] / maxVal) * 140;
                    histCtx.fillRect(i * w, 150 - h, w, h);
                }
            }
            if (currentHistogramChannel === 'all' || currentHistogramChannel === 'blue') {
                histCtx.fillStyle = '#4444ff';
                for (let i = 0; i < 256; i++) {
                    const h = (histB[i] / maxVal) * 140;
                    histCtx.fillRect(i * w, 150 - h, w, h);
                }
            }
            
            histCtx.globalAlpha = 1;
            showToast('ğŸ“Š ç›´æ–¹åœ–å·²æ›´æ–°');
        }
        
        // ===== è‰²å½©å¹³è¡¡ =====
        function showColorBalancePanel() {
            togglePanel('colorBalancePanel', 'colorBalanceBtn');
        }
        
        function applyColorBalance() {
            saveHistory();
            
            const cr = parseInt(document.getElementById('balanceCyanRed')?.value || 0);
            const mg = parseInt(document.getElementById('balanceMagentaGreen')?.value || 0);
            const yb = parseInt(document.getElementById('balanceYellowBlue')?.value || 0);
            const range = document.getElementById('balanceRange')?.value || 'midtones';
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const lum = (r + g + b) / 3;
                
                let factor = 0;
                if (range === 'shadows' && lum < 85) {
                    factor = 1 - (lum / 85);
                } else if (range === 'midtones' && lum >= 85 && lum < 170) {
                    factor = 1;
                } else if (range === 'highlights' && lum >= 170) {
                    factor = (lum - 170) / 85;
                }
                
                if (factor > 0) {
                    data[i] = Math.min(255, Math.max(0, r + cr * factor));
                    data[i+1] = Math.min(255, Math.max(0, g + mg * factor));
                    data[i+2] = Math.min(255, Math.max(0, b + yb * factor));
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('âš–ï¸ è‰²å½©å¹³è¡¡å·²å¥—ç”¨');
        }
        
        // ===== é¸æ“‡æ€§èª¿è‰² =====
        function showSelectiveColorPanel() {
            togglePanel('selectiveColorPanel', 'selectiveColorBtn');
        }
        
        function applySelectiveColor() {
            saveHistory();
            const target = document.getElementById('selectiveTarget')?.value || 'red';
            const hueShift = parseInt(document.getElementById('selectiveHue')?.value || 0);
            const satAdjust = parseInt(document.getElementById('selectiveSat')?.value || 0);
            const lightAdjust = parseInt(document.getElementById('selectiveLight')?.value || 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // ç›®æ¨™è‰²ç›¸ç¯„åœ
            const hueRanges = {
                'red': [0, 30, 330, 360],
                'orange': [30, 60],
                'yellow': [60, 90],
                'green': [90, 150],
                'cyan': [150, 210],
                'blue': [210, 270],
                'purple': [270, 330]
            };
            
            const range = hueRanges[target] || [0, 360];
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                
                // RGB è½‰ HSL
                const max = Math.max(r, g, b) / 255;
                const min = Math.min(r, g, b) / 255;
                let h = 0, s = 0, l = (max + min) / 2;
                
                if (max !== min) {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    
                    if (max === r/255) h = ((g/255 - b/255) / d + (g < b ? 6 : 0)) * 60;
                    else if (max === g/255) h = ((b/255 - r/255) / d + 2) * 60;
                    else h = ((r/255 - g/255) / d + 4) * 60;
                }
                
                // æª¢æŸ¥æ˜¯å¦åœ¨ç›®æ¨™ç¯„åœå…§
                let match = false;
                if (range.length === 4) {
                    match = (h >= range[0] && h < range[1]) || (h >= range[2] && h < range[3]);
                } else {
                    match = h >= range[0] && h < range[1];
                }
                
                if (match && s > 0.1) {  // åªèª¿æ•´æœ‰é£½å’Œåº¦çš„é¡è‰²
                    // èª¿æ•´ HSL
                    h = (h + hueShift + 360) % 360;
                    s = Math.min(1, Math.max(0, s + satAdjust / 100));
                    l = Math.min(1, Math.max(0, l + lightAdjust / 200));
                    
                    // HSL è½‰å› RGB
                    let r2, g2, b2;
                    if (s === 0) {
                        r2 = g2 = b2 = l;
                    } else {
                        const hue2rgb = (p, q, t) => {
                            if (t < 0) t += 1;
                            if (t > 1) t -= 1;
                            if (t < 1/6) return p + (q - p) * 6 * t;
                            if (t < 1/2) return q;
                            if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                            return p;
                        };
                        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                        const p = 2 * l - q;
                        r2 = hue2rgb(p, q, h/360 + 1/3);
                        g2 = hue2rgb(p, q, h/360);
                        b2 = hue2rgb(p, q, h/360 - 1/3);
                    }
                    
                    data[i] = Math.round(r2 * 255);
                    data[i+1] = Math.round(g2 * 255);
                    data[i+2] = Math.round(b2 * 255);
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            const targetNames = { red: 'ç´…è‰²', orange: 'æ©™è‰²', yellow: 'é»ƒè‰²', green: 'ç¶ è‰²', cyan: 'é’è‰²', blue: 'è—è‰²', purple: 'ç´«è‰²' };
            showToast('ğŸ¯ å·²èª¿æ•´ ' + (targetNames[target] || target));
        }
        
        // ===== ç›¸ç‰‡æ¿¾é¡ =====
        function showPhotoFilterPanel() {
            togglePanel('photoFilterPanel', 'photoFilterBtn');
        }
        
        function applyPhotoFilter(filterType) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i], g = data[i+1], b = data[i+2];
                
                switch(filterType) {
                    case 'warm': // æš–è‰²
                        r = Math.min(255, r * 1.1 + 10);
                        b = Math.max(0, b * 0.9 - 10);
                        break;
                    case 'cool': // å†·è‰²
                        r = Math.max(0, r * 0.9 - 10);
                        b = Math.min(255, b * 1.1 + 15);
                        break;
                    case 'sunset': // æ—¥è½
                        r = Math.min(255, r * 1.15 + 20);
                        g = Math.min(255, g * 1.05);
                        b = Math.max(0, b * 0.85);
                        break;
                    case 'forest': // æ£®æ—
                        r = Math.max(0, r * 0.9);
                        g = Math.min(255, g * 1.1 + 10);
                        b = Math.max(0, b * 0.9);
                        break;
                    case 'ocean': // æµ·æ´‹
                        r = Math.max(0, r * 0.85);
                        g = Math.min(255, g * 1.05 + 5);
                        b = Math.min(255, b * 1.15 + 15);
                        break;
                    case 'sepia': // å¾©å¤è¤
                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        r = Math.min(255, gray * 1.2 + 30);
                        g = Math.min(255, gray * 1.0 + 10);
                        b = Math.max(0, gray * 0.8);
                        break;
                }
                
                data[i] = r;
                data[i+1] = g;
                data[i+2] = b;
            }
            
            ctx.putImageData(imageData, 0, 0);
            const filterNames = { warm: 'æš–è‰²', cool: 'å†·è‰²', sunset: 'æ—¥è½', forest: 'æ£®æ—', ocean: 'æµ·æ´‹', sepia: 'å¾©å¤è¤' };
            showToast('ğŸ“· ' + (filterNames[filterType] || filterType) + ' æ¿¾é¡å·²å¥—ç”¨');
        }
        
        // ===== é¡é ­æ¨¡ç³Š =====
        function showLensBlurPanel() {
            togglePanel('lensBlurPanel', 'lensBlurBtn');
        }
        
        function applyLensBlur() {
            saveHistory();
            const radius = parseInt(document.getElementById('lensBlurRadius')?.value || 15);
            
            // ä½¿ç”¨ CSS filter ä½œç‚ºç°¡åŒ–ç‰ˆ
            ctx.filter = `blur(${radius}px)`;
            ctx.drawImage(canvas, 0, 0);
            ctx.filter = 'none';
            
            showToast('ğŸ”­ é¡é ­æ¨¡ç³Šå·²å¥—ç”¨');
        }
        
        // ===== å‹•æ…‹æ¨¡ç³Š =====
        function showMotionBlurPanel() {
            togglePanel('motionBlurPanel', 'motionBlurBtn');
            
            document.getElementById('motionBlurAngle').oninput = function() {
                document.getElementById('motionAngleVal').textContent = this.value + 'Â°';
            };
            document.getElementById('motionBlurDistance').oninput = function() {
                document.getElementById('motionDistVal').textContent = this.value + 'px';
            };
        }
        
        function applyMotionBlur() {
            saveHistory();
            const angle = parseInt(document.getElementById('motionBlurAngle')?.value || 0);
            const distance = parseInt(document.getElementById('motionBlurDistance')?.value || 20);
            
            const radians = angle * Math.PI / 180;
            const dx = Math.cos(radians) * distance;
            const dy = Math.sin(radians) * distance;
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            ctx.globalAlpha = 0.1;
            for (let i = 0; i < 10; i++) {
                ctx.drawImage(tempCanvas, dx * i / 10, dy * i / 10);
            }
            ctx.globalAlpha = 1;
            
            showToast('ğŸ’¨ å‹•æ…‹æ¨¡ç³Šå·²å¥—ç”¨');
        }
        
        // ===== æ”¾å°„æ¨¡ç³Š =====
        function applyZoomBlur() {
            saveHistory();
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            
            ctx.globalAlpha = 0.1;
            for (let i = 0; i < 10; i++) {
                const scale = 1 + i * 0.02;
                ctx.save();
                ctx.translate(cx, cy);
                ctx.scale(scale, scale);
                ctx.translate(-cx, -cy);
                ctx.drawImage(tempCanvas, 0, 0);
                ctx.restore();
            }
            ctx.globalAlpha = 1;
            
            showToast('ğŸ” æ”¾å°„æ¨¡ç³Šå·²å¥—ç”¨');
        }
        
        // ===== é€è¦–è®Šå½¢ =====
        function showPerspectivePanel() {
            togglePanel('perspectivePanel', 'perspectiveBtn');
        }
        
        function applyPerspective() {
            saveHistory();
            // ç°¡åŒ–çš„é€è¦–æ•ˆæœï¼Œä½¿ç”¨ CSS transform
            showToast('ğŸ“ é€è¦–è®Šå½¢ - é€²éšåŠŸèƒ½');
        }
        
        // ===== æ‰­æ›²æ•ˆæœ =====
        function showDistortPanel() {
            togglePanel('distortPanel', 'distortBtn');
        }
        
        function applyDistort(type) {
            saveHistory();
            const amount = parseInt(document.getElementById('distortAmount')?.value || 50) / 100;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const srcData = new Uint8ClampedArray(imageData.data);
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;
            const cx = w / 2;
            const cy = h / 2;
            
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    let srcX = x, srcY = y;
                    
                    switch(type) {
                        case 'wave':
                            srcX = x + Math.sin(y / 20) * 20 * amount;
                            srcY = y + Math.sin(x / 20) * 20 * amount;
                            break;
                        case 'ripple':
                            const dist = Math.sqrt((x - cx) ** 2 + (y - cy) ** 2);
                            const angle = Math.atan2(y - cy, x - cx);
                            const newDist = dist + Math.sin(dist / 10) * 10 * amount;
                            srcX = cx + Math.cos(angle) * newDist;
                            srcY = cy + Math.sin(angle) * newDist;
                            break;
                        case 'spherize':
                            const dx = (x - cx) / cx;
                            const dy = (y - cy) / cy;
                            const r = Math.sqrt(dx * dx + dy * dy);
                            if (r < 1) {
                                const nr = r * (1 - amount * (1 - r * r));
                                srcX = cx + dx / r * nr * cx;
                                srcY = cy + dy / r * nr * cy;
                            }
                            break;
                        case 'fisheye':
                            const fdx = (x - cx) / cx;
                            const fdy = (y - cy) / cy;
                            const fr = Math.sqrt(fdx * fdx + fdy * fdy);
                            if (fr < 1) {
                                const theta = Math.atan2(fdy, fdx);
                                const fr2 = Math.pow(fr, 1 + amount);
                                srcX = cx + fr2 * Math.cos(theta) * cx;
                                srcY = cy + fr2 * Math.sin(theta) * cy;
                            }
                            break;
                    }
                    
                    srcX = Math.max(0, Math.min(w - 1, Math.round(srcX)));
                    srcY = Math.max(0, Math.min(h - 1, Math.round(srcY)));
                    
                    const dstIdx = (y * w + x) * 4;
                    const srcIdx = (srcY * w + srcX) * 4;
                    
                    data[dstIdx] = srcData[srcIdx];
                    data[dstIdx + 1] = srcData[srcIdx + 1];
                    data[dstIdx + 2] = srcData[srcIdx + 2];
                    data[dstIdx + 3] = srcData[srcIdx + 3];
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸŒ€ æ‰­æ›²æ•ˆæœå·²å¥—ç”¨');
        }
        
        // ===== å½æ›²è®Šå½¢ =====
        function showWarpPanel() {
            togglePanel('warpPanel', 'warpBtn');
        }
        
        function applyWarp(style) {
            saveHistory();
            // ç°¡åŒ–çš„å½æ›²æ•ˆæœ
            showToast('ã€°ï¸ å½æ›²è®Šå½¢å·²å¥—ç”¨');
        }
        
        // ===== è¿·å› ç”¢ç”Ÿå™¨ =====
        function showMemePanel() {
            togglePanel('memePanel', 'memeBtn');
        }
        
        function generateMeme() {
            saveHistory();
            const topText = document.getElementById('memeTopText')?.value?.toUpperCase() || '';
            const bottomText = document.getElementById('memeBottomText')?.value?.toUpperCase() || '';
            const font = document.getElementById('memeFont')?.value || 'Impact';
            const fontSize = parseInt(document.getElementById('memeFontSize')?.value || 48);
            const strokeWidth = parseInt(document.getElementById('memeStroke')?.value || 3);
            
            ctx.font = `bold ${fontSize}px ${font}`;
            ctx.textAlign = 'center';
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = strokeWidth;
            
            // ä¸Šæ–¹æ–‡å­—
            if (topText) {
                ctx.strokeText(topText, canvas.width / 2, fontSize + 10);
                ctx.fillText(topText, canvas.width / 2, fontSize + 10);
            }
            
            // ä¸‹æ–¹æ–‡å­—
            if (bottomText) {
                ctx.strokeText(bottomText, canvas.width / 2, canvas.height - 20);
                ctx.fillText(bottomText, canvas.width / 2, canvas.height - 20);
            }
            
            showToast('ğŸ˜‚ è¿·å› å·²ç”¢ç”Ÿ');
        }
        
        // ===== æµ·å ±è¨­è¨ˆ =====
        function showPosterPanel() {
            togglePanel('posterPanel', 'posterBtn');
        }
        
        function generatePoster() {
            saveHistory();
            const title = document.getElementById('posterTitle')?.value || 'æ¨™é¡Œ';
            const subtitle = document.getElementById('posterSubtitle')?.value || '';
            
            // åŠ å…¥æ¨™é¡Œ
            ctx.font = 'bold 60px sans-serif';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 10;
            ctx.fillText(title, canvas.width / 2, canvas.height / 2);
            
            if (subtitle) {
                ctx.font = '30px sans-serif';
                ctx.fillText(subtitle, canvas.width / 2, canvas.height / 2 + 50);
            }
            
            ctx.shadowBlur = 0;
            showToast('ğŸ¨ æµ·å ±å·²ç”¢ç”Ÿ');
        }
        
        // ===== åç‰‡è¨­è¨ˆ =====
        function showCardPanel() {
            togglePanel('cardPanel', 'cardBtn');
        }
        
        function createCard(cardType) {
            saveHistory();
            
            // è¨­å®šå¡ç‰‡å°ºå¯¸
            canvas.width = 800;
            canvas.height = 600;
            
            // æ ¹æ“šå¡ç‰‡é¡å‹ç¹ªè£½ä¸åŒèƒŒæ™¯
            const gradients = {
                'birthday': ['#ff6b6b', '#feca57'],
                'christmas': ['#2d5016', '#c41e3a'],
                'wedding': ['#f8e8d4', '#d4a574'],
                'thanks': ['#74b9ff', '#a29bfe'],
                'invite': ['#fd79a8', '#e84393'],
                'greeting': ['#55efc4', '#81ecec']
            };
            
            const colors = gradients[cardType] || ['#667eea', '#764ba2'];
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, colors[0]);
            gradient.addColorStop(1, colors[1]);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ·»åŠ è£é£¾
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const r = Math.random() * 50 + 10;
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // æ·»åŠ æ¨™é¡Œæ–‡å­—
            const titles = {
                'birthday': 'ğŸ‚ Happy Birthday!',
                'christmas': 'ğŸ„ Merry Christmas!',
                'wedding': 'ğŸ’’ Wedding Invitation',
                'thanks': 'ğŸ™ Thank You!',
                'invite': 'ğŸ’Œ You are Invited!',
                'greeting': 'ğŸ‘‹ Greetings!'
            };
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 60px sans-serif';
            ctx.textAlign = 'center';
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 10;
            ctx.fillText(titles[cardType] || 'Card', canvas.width/2, canvas.height/2);
            ctx.shadowBlur = 0;
            
            // æ·»åŠ æç¤ºæ–‡å­—
            ctx.font = '24px sans-serif';
            ctx.fillText('é»æ“Šæ–‡å­—å·¥å…·æ·»åŠ æ‚¨çš„è¨Šæ¯', canvas.width/2, canvas.height/2 + 80);
            
            showToast('ğŸ´ ' + (titles[cardType]?.split(' ')[0] || '') + ' å¡ç‰‡å·²ç”¢ç”Ÿ');
        }
        
        function generateCard() {
            saveHistory();
            const name = document.getElementById('cardName')?.value || 'å§“å';
            const title = document.getElementById('cardTitle')?.value || '';
            const company = document.getElementById('cardCompany')?.value || '';
            const phone = document.getElementById('cardPhone')?.value || '';
            const email = document.getElementById('cardEmail')?.value || '';
            
            // è¨­å®šåç‰‡å°ºå¯¸
            canvas.width = 1050;
            canvas.height = 600;
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#333';
            ctx.font = 'bold 48px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(name, 50, 100);
            
            ctx.font = '24px sans-serif';
            ctx.fillStyle = '#666';
            if (title) ctx.fillText(title, 50, 150);
            if (company) ctx.fillText(company, 50, 190);
            
            ctx.font = '20px sans-serif';
            let yPos = 300;
            if (phone) { ctx.fillText('ğŸ“ ' + phone, 50, yPos); yPos += 40; }
            if (email) { ctx.fillText('ğŸ“§ ' + email, 50, yPos); yPos += 40; }
            
            showToast('ğŸ’³ åç‰‡å·²ç”¢ç”Ÿ');
        }
        
        // ===== æ©«å¹…è¨­è¨ˆ =====
        function showBannerPanel() {
            togglePanel('bannerPanel', 'bannerBtn');
        }
        
        function setBannerSize(w, h) {
            saveHistory();
            canvas.width = w;
            canvas.height = h;
            const bgColor = document.getElementById('bannerBgColor')?.value || '#ffffff';
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, w, h);
            showToast('ğŸ·ï¸ æ©«å¹…å°ºå¯¸å·²è¨­å®š ' + w + 'Ã—' + h);
        }
        
        function generateBanner() {
            saveHistory();
            const headline = document.getElementById('bannerHeadline')?.value || '';
            const cta = document.getElementById('bannerCta')?.value || '';
            
            ctx.font = 'bold 24px sans-serif';
            ctx.fillStyle = '#333';
            ctx.textAlign = 'center';
            
            if (headline) {
                ctx.fillText(headline, canvas.width / 2, canvas.height / 2 - 10);
            }
            
            if (cta) {
                // CTA æŒ‰éˆ•
                const btnW = 120, btnH = 36;
                const btnX = canvas.width / 2 - btnW / 2;
                const btnY = canvas.height / 2 + 10;
                
                ctx.fillStyle = '#007bff';
                ctx.beginPath();
                ctx.roundRect(btnX, btnY, btnW, btnH, 5);
                ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.font = '14px sans-serif';
                ctx.fillText(cta, canvas.width / 2, btnY + btnH / 2 + 5);
            }
            
            showToast('ğŸ·ï¸ æ©«å¹…å·²ç”¢ç”Ÿ');
        }
        
        // ===== é ­åƒè£½ä½œ =====
        let avatarShape = 'circle';
        let avatarSize = 200;
        
        function showAvatarPanel() {
            togglePanel('avatarPanel', 'avatarBtn');
        }
        
        function setAvatarShape(shape) {
            avatarShape = shape;
            document.querySelectorAll('.avatar-shape').forEach(b => b.classList.remove('active'));
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            }
        }
        
        function setAvatarSize(size) {
            avatarSize = size;
        }
        
        function generateAvatar() {
            saveHistory();
            const border = parseInt(document.getElementById('avatarBorder')?.value || 0);
            const borderColor = document.getElementById('avatarBorderColor')?.value || '#ffffff';
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = avatarSize;
            tempCanvas.height = avatarSize;
            const tempCtx = tempCanvas.getContext('2d');
            
            // è£åˆ‡å½¢ç‹€
            tempCtx.beginPath();
            if (avatarShape === 'circle') {
                tempCtx.arc(avatarSize/2, avatarSize/2, avatarSize/2 - border, 0, Math.PI * 2);
            } else if (avatarShape === 'rounded') {
                tempCtx.roundRect(border, border, avatarSize - border*2, avatarSize - border*2, 20);
            } else if (avatarShape === 'hexagon') {
                const r = avatarSize/2 - border;
                for (let i = 0; i < 6; i++) {
                    const angle = i * Math.PI / 3 - Math.PI / 2;
                    const x = avatarSize/2 + r * Math.cos(angle);
                    const y = avatarSize/2 + r * Math.sin(angle);
                    if (i === 0) tempCtx.moveTo(x, y);
                    else tempCtx.lineTo(x, y);
                }
                tempCtx.closePath();
            } else {
                tempCtx.rect(border, border, avatarSize - border*2, avatarSize - border*2);
            }
            tempCtx.clip();
            
            // ç¸®æ”¾åŸåœ–
            const scale = Math.max(avatarSize / canvas.width, avatarSize / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const x = (avatarSize - newW) / 2;
            const y = (avatarSize - newH) / 2;
            tempCtx.drawImage(canvas, x, y, newW, newH);
            
            // åŠ é‚Šæ¡†
            if (border > 0) {
                tempCtx.restore();
                tempCtx.strokeStyle = borderColor;
                tempCtx.lineWidth = border;
                tempCtx.beginPath();
                if (avatarShape === 'circle') {
                    tempCtx.arc(avatarSize/2, avatarSize/2, avatarSize/2 - border/2, 0, Math.PI * 2);
                } else {
                    tempCtx.rect(border/2, border/2, avatarSize - border, avatarSize - border);
                }
                tempCtx.stroke();
            }
            
            canvas.width = avatarSize;
            canvas.height = avatarSize;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('ğŸ‘¤ é ­åƒå·²ç”¢ç”Ÿ');
        }
        
        // ===== Logo è£½ä½œ =====
        function showLogoPanel() {
            togglePanel('logoPanel', 'logoBtn');
        }
        
        function createLogo() {
            const text = document.getElementById('logoText')?.value?.trim();
            
            if (!text) {
                showToast('âš ï¸ è«‹è¼¸å…¥ Logo æ–‡å­—');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰åœ–ç‰‡
            if (!currentImage && canvas.width === 300) {
                showToast('âš ï¸ è«‹å…ˆè¼‰å…¥åœ–ç‰‡ï¼Œæˆ–ä½¿ç”¨ã€Œæ¨¡æ¿ã€åŠŸèƒ½å»ºç«‹ç©ºç™½ç•«å¸ƒ');
                return;
            }
            
            saveHistory();
            
            const font = document.getElementById('logoFont')?.value || 'bold';
            const color1 = document.getElementById('logoColor1')?.value || '#667eea';
            const color2 = document.getElementById('logoColor2')?.value || '#764ba2';
            
            // æ ¹æ“šå­—é«”æ¨£å¼è¨­å®šï¼ˆæ ¹æ“šç•«å¸ƒå¤§å°èª¿æ•´å­—é«”ï¼‰
            const fontSize = Math.min(canvas.width, canvas.height) / 6;
            const fontStyles = {
                'bold': `bold ${fontSize}px Arial, sans-serif`,
                'elegant': `italic ${fontSize * 0.9}px Georgia, serif`,
                'tech': `bold ${fontSize * 0.95}px "Courier New", monospace`,
                'handwrite': `${fontSize * 0.9}px "Comic Sans MS", cursive`
            };
            
            ctx.font = fontStyles[font] || fontStyles['bold'];
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // å»ºç«‹æ¼¸å±¤ï¼ˆæ°´å¹³æ–¹å‘ï¼‰
            const textWidth = ctx.measureText(text).width;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            const gradient = ctx.createLinearGradient(centerX - textWidth/2, 0, centerX + textWidth/2, 0);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            
            // æ·»åŠ é™°å½±ï¼ˆè®“æ–‡å­—æ›´æ˜é¡¯ï¼‰
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 3;
            ctx.shadowOffsetY = 3;
            
            // ç¹ªè£½æ–‡å­—åˆ°åœ–ç‰‡ä¸­å¤®
            ctx.fillStyle = gradient;
            ctx.fillText(text, centerX, centerY);
            
            // æ¸…é™¤é™°å½±è¨­å®š
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            
            showToast('ğŸ¢ Logo å·²æ·»åŠ åˆ°åœ–ç‰‡ï¼å¯æ‹–æ›³èª¿æ•´ä½ç½®');
        }
        
        function generateLogo() {
            createLogo();
        }
        
        // ===== GIF è£½ä½œ =====
        let gifFrames = [];
        
        function showGifPanel() {
            togglePanel('gifPanel', 'gifBtn');
        }
        
        function addGifFrames(e) {
            const files = e.target.files;
            gifFrames = []; // æ¸…ç©ºèˆŠçš„
            const preview = document.getElementById('gifFramePreview');
            if (preview) preview.innerHTML = '';
            
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        gifFrames.push(img);
                        // é¡¯ç¤ºé è¦½ç¸®åœ–
                        if (preview) {
                            const thumb = document.createElement('img');
                            thumb.src = event.target.result;
                            thumb.style.cssText = 'width:40px;height:40px;object-fit:cover;border-radius:4px;border:2px solid var(--border);';
                            preview.appendChild(thumb);
                        }
                        showToast(`ğŸ“· å·²è¼‰å…¥ ${gifFrames.length} å¼µåœ–ç‰‡`);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
        
        function updateGifFrameList() {
            const container = document.getElementById('gifFrames');
            if (!container) return;
            container.innerHTML = '<div class="gif-frame-item"><span>å¹€ 1 (ç›®å‰åœ–ç‰‡)</span></div>';
            gifFrames.forEach((_, i) => {
                container.innerHTML += `<div class="gif-frame-item"><span>å¹€ ${i + 2}</span></div>`;
            });
        }
        
        let gifPreviewInterval = null;
        
        function previewGif() {
            if (gifFrames.length < 2) {
                showToast('âš ï¸ è«‹è‡³å°‘é¸æ“‡ 2 å¼µåœ–ç‰‡');
                return;
            }
            
            const delay = parseInt(document.getElementById('gifDelay')?.value || 200);
            let currentFrame = 0;
            
            // åœæ­¢ä¹‹å‰çš„é è¦½
            if (gifPreviewInterval) {
                clearInterval(gifPreviewInterval);
                gifPreviewInterval = null;
                showToast('â¹ï¸ é è¦½å·²åœæ­¢');
                return;
            }
            
            showToast('â–¶ï¸ é–‹å§‹é è¦½ï¼ˆå†é»ä¸€æ¬¡åœæ­¢ï¼‰');
            
            gifPreviewInterval = setInterval(() => {
                const img = gifFrames[currentFrame];
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                currentFrame = (currentFrame + 1) % gifFrames.length;
            }, delay);
        }
        
        function createGif() {
            if (gifFrames.length < 2) {
                showToast('âš ï¸ è«‹è‡³å°‘é¸æ“‡ 2 å¼µåœ–ç‰‡');
                return;
            }
            
            // åœæ­¢é è¦½
            if (gifPreviewInterval) {
                clearInterval(gifPreviewInterval);
                gifPreviewInterval = null;
            }
            
            const delay = parseInt(document.getElementById('gifDelay')?.value || 200);
            
            showToast('ğŸ¬ æ­£åœ¨ç”¢ç”Ÿ GIF...');
            
            // ä½¿ç”¨ gif.js åº«ï¼ˆCDNï¼‰
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js';
            script.onload = function() {
                const gif = new GIF({
                    workers: 2,
                    quality: 10,
                    width: gifFrames[0].width,
                    height: gifFrames[0].height,
                    workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
                });
                
                gifFrames.forEach(img => {
                    gif.addFrame(img, { delay: delay });
                });
                
                gif.on('finished', function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'animation.gif';
                    a.click();
                    showToast('âœ… GIF å·²ä¸‹è¼‰ï¼');
                });
                
                gif.render();
            };
            script.onerror = function() {
                // å‚™ç”¨æ–¹æ¡ˆï¼šä¸‹è¼‰ç‚ºå¤šå¼µåœ–
                showToast('âš ï¸ GIF åº«è¼‰å…¥å¤±æ•—ï¼Œæ”¹ç‚ºä¸‹è¼‰ ZIP');
                downloadFramesAsZip();
            };
            document.head.appendChild(script);
        }
        
        function downloadFramesAsZip() {
            gifFrames.forEach((img, i) => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = img.width;
                tempCanvas.height = img.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(img, 0, 0);
                
                const link = document.createElement('a');
                link.download = `frame_${i + 1}.png`;
                link.href = tempCanvas.toDataURL('image/png');
                link.click();
            });
            showToast('âœ… å·²ä¸‹è¼‰æ‰€æœ‰å¹€åœ–ç‰‡');
        }
        
        function generateGif() {
            createGif();
        }
        
        // ===== èª¿è‰²ç›¤ =====
        function showColorPalettePanel() {
            togglePanel('colorPalettePanel', 'colorPaletteBtn');
            // è‡ªå‹•åˆ†æé¡è‰²
            setTimeout(analyzeColors, 100);
        }
        
        // ===== é€²éšå–è‰²å™¨ =====
        function showEyeDropperAdvPanel() {
            togglePanel('eyeDropperAdvPanel', 'eyeDropperAdvBtn');
            setTool('eyedropperAdv');
        }
        
        let colorHistory = [];
        
        function updateColorValues(r, g, b) {
            const preview = document.getElementById('colorPreviewLarge');
            if (preview) {
                preview.style.backgroundColor = `rgb(${r},${g},${b})`;
            }
            
            const hex = `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
            const hexEl = document.getElementById('colorHex');
            const rgbEl = document.getElementById('colorRgb');
            const hslEl = document.getElementById('colorHsl');
            
            if (hexEl) hexEl.textContent = hex;
            if (rgbEl) rgbEl.textContent = `rgb(${r}, ${g}, ${b})`;
            
            // HSL
            const hsl = rgbToHsl(r, g, b);
            if (hslEl) hslEl.textContent = `hsl(${hsl.h}, ${hsl.s}%, ${hsl.l}%)`;
            
            // æ·»åŠ åˆ°æ­·å²
            addColorToHistory(hex);
        }
        
        function addColorToHistory(hex) {
            if (colorHistory.includes(hex)) return;
            colorHistory.unshift(hex);
            if (colorHistory.length > 10) colorHistory.pop();
            
            const container = document.getElementById('colorHistory');
            if (container) {
                container.innerHTML = colorHistory.map(c => 
                    `<div onclick="copyColor('custom','${c}')" style="width:25px;height:25px;background:${c};border-radius:4px;cursor:pointer;border:2px solid var(--border);" title="${c}"></div>`
                ).join('');
            }
        }
        
        function copyColor(type, customColor) {
            let text = '';
            switch(type) {
                case 'hex':
                    text = document.getElementById('colorHex')?.textContent || '';
                    break;
                case 'rgb':
                    text = document.getElementById('colorRgb')?.textContent || '';
                    break;
                case 'hsl':
                    text = document.getElementById('colorHsl')?.textContent || '';
                    break;
                case 'custom':
                    text = customColor || '';
                    break;
            }
            
            if (text) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('âœ… å·²è¤‡è£½ï¼š' + text);
                });
            }
        }
        
        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            
            return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
        }
        
        function rgbToCmyk(r, g, b) {
            if (r === 0 && g === 0 && b === 0) return { c: 0, m: 0, y: 0, k: 100 };
            
            const c = 1 - r / 255;
            const m = 1 - g / 255;
            const y = 1 - b / 255;
            const k = Math.min(c, m, y);
            
            return {
                c: Math.round((c - k) / (1 - k) * 100),
                m: Math.round((m - k) / (1 - k) * 100),
                y: Math.round((y - k) / (1 - k) * 100),
                k: Math.round(k * 100)
            };
        }
        
        // ===== åƒè€ƒç·š =====
        let guides = [];
        
        function showGuidePanel() {
            togglePanel('guidePanel', 'guideBtn');
        }
        
        function addGuide(type) {
            saveHistory();
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            
            if (type === 'h') {
                const y = canvas.height / 2;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
                guides.push({ type: 'h', pos: y });
            } else if (type === 'v') {
                const x = canvas.width / 2;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
                guides.push({ type: 'v', pos: x });
            } else if (type === 'center') {
                addGuide('h');
                addGuide('v');
            } else if (type === 'thirds') {
                [1/3, 2/3].forEach(r => {
                    ctx.beginPath();
                    ctx.moveTo(0, canvas.height * r);
                    ctx.lineTo(canvas.width, canvas.height * r);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(canvas.width * r, 0);
                    ctx.lineTo(canvas.width * r, canvas.height);
                    ctx.stroke();
                });
            } else if (type === 'golden') {
                const phi = 0.618;
                [phi, 1-phi].forEach(r => {
                    ctx.beginPath();
                    ctx.moveTo(0, canvas.height * r);
                    ctx.lineTo(canvas.width, canvas.height * r);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(canvas.width * r, 0);
                    ctx.lineTo(canvas.width * r, canvas.height);
                    ctx.stroke();
                });
            }
            
            ctx.setLineDash([]);
            showToast('ğŸ“ åƒè€ƒç·šå·²åŠ å…¥');
        }
        
        function clearGuides() {
            guides = [];
            undoAction();
            showToast('ğŸ—‘ï¸ åƒè€ƒç·šå·²æ¸…é™¤');
        }
        
        // ===== å°é½Šå·¥å…· =====
        function showAlignPanel() {
            togglePanel('alignPanel', 'alignBtn');
        }
        
        function alignSelection(alignment) {
            if (!currentSelection) {
                showToast('âš ï¸ è«‹å…ˆé¸å–å€åŸŸ');
                return;
            }
            
            // å°é½Šé‚è¼¯
            showToast('ğŸ“ å°é½ŠåŠŸèƒ½');
        }
        
        // ===== è‰²ç‰ˆ =====
        function showChannelPanel() {
            togglePanel('channelPanel', 'channelBtn');
        }
        
        function showChannel(channel) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                if (channel === 'r') {
                    data[i+1] = data[i+2] = 0;
                } else if (channel === 'g') {
                    data[i] = data[i+2] = 0;
                } else if (channel === 'b') {
                    data[i] = data[i+1] = 0;
                } else if (channel === 'alpha') {
                    const a = data[i+3];
                    data[i] = data[i+1] = data[i+2] = a;
                    data[i+3] = 255;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ“º é¡¯ç¤º ' + channel + ' è‰²ç‰ˆ');
        }
        
        // ===== è‡ªå‹•åŠŸèƒ½ =====
        function autoEnhance() {
            saveHistory();
            autoLevel();
            autoContrast();
            showToast('âœ¨ è‡ªå‹•å¢å¼·å®Œæˆ');
        }
        
        function autoColor() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let avgR = 0, avgG = 0, avgB = 0;
            const count = data.length / 4;
            
            for (let i = 0; i < data.length; i += 4) {
                avgR += data[i];
                avgG += data[i+1];
                avgB += data[i+2];
            }
            
            avgR /= count; avgG /= count; avgB /= count;
            const avg = (avgR + avgG + avgB) / 3;
            
            const scaleR = avg / avgR;
            const scaleG = avg / avgG;
            const scaleB = avg / avgB;
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, data[i] * scaleR);
                data[i+1] = Math.min(255, data[i+1] * scaleG);
                data[i+2] = Math.min(255, data[i+2] * scaleB);
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸŒˆ è‡ªå‹•è‰²å½©å®Œæˆ');
        }
        
        function autoContrast() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let min = 255, max = 0;
            for (let i = 0; i < data.length; i += 4) {
                const lum = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                min = Math.min(min, lum);
                max = Math.max(max, lum);
            }
            
            const scale = 255 / (max - min);
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, (data[i] - min) * scale));
                data[i+1] = Math.min(255, Math.max(0, (data[i+1] - min) * scale));
                data[i+2] = Math.min(255, Math.max(0, (data[i+2] - min) * scale));
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ­ è‡ªå‹•å°æ¯”å®Œæˆ');
        }
        
        function autoLevel() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // è¨ˆç®—æ¯å€‹é€šé“çš„ç›´æ–¹åœ–
            let histR = new Array(256).fill(0);
            let histG = new Array(256).fill(0);
            let histB = new Array(256).fill(0);
            
            for (let i = 0; i < data.length; i += 4) {
                histR[data[i]]++;
                histG[data[i+1]]++;
                histB[data[i+2]]++;
            }
            
            // æ‰¾å‡º 1% å’Œ 99% çš„é–¾å€¼
            const pixels = data.length / 4;
            const threshold = pixels * 0.01;
            
            function findBounds(hist) {
                let sum = 0, min = 0, max = 255;
                for (let i = 0; i < 256; i++) {
                    sum += hist[i];
                    if (sum > threshold) { min = i; break; }
                }
                sum = 0;
                for (let i = 255; i >= 0; i--) {
                    sum += hist[i];
                    if (sum > threshold) { max = i; break; }
                }
                return { min, max };
            }
            
            const boundsR = findBounds(histR);
            const boundsG = findBounds(histG);
            const boundsB = findBounds(histB);
            
            // æ‹‰ä¼¸è‰²éš
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, (data[i] - boundsR.min) * 255 / (boundsR.max - boundsR.min)));
                data[i+1] = Math.min(255, Math.max(0, (data[i+1] - boundsG.min) * 255 / (boundsG.max - boundsG.min)));
                data[i+2] = Math.min(255, Math.max(0, (data[i+2] - boundsB.min) * 255 / (boundsB.max - boundsB.min)));
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ“Š è‡ªå‹•è‰²éšå®Œæˆ');
        }
        
        // ===== HDR æ•ˆæœ =====
        function applyHDR() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // å±€éƒ¨å°æ¯”å¢å¼·
                const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                const factor = 1.5;
                
                data[i] = Math.min(255, Math.max(0, avg + (data[i] - avg) * factor));
                data[i+1] = Math.min(255, Math.max(0, avg + (data[i+1] - avg) * factor));
                data[i+2] = Math.min(255, Math.max(0, avg + (data[i+2] - avg) * factor));
                
                // å¢åŠ é£½å’Œåº¦
                const satFactor = 1.3;
                const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                data[i] = Math.min(255, Math.max(0, gray + (data[i] - gray) * satFactor));
                data[i+1] = Math.min(255, Math.max(0, gray + (data[i+1] - gray) * satFactor));
                data[i+2] = Math.min(255, Math.max(0, gray + (data[i+2] - gray) * satFactor));
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸŒŸ HDR æ•ˆæœå·²å¥—ç”¨');
        }
        
        // ===== æ›´å¤šè—è¡“æ•ˆæœ =====
        function applyOutlineEffect() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            applyConvolution(imageData, [-1, -1, -1, -1, 8, -1, -1, -1, -1]);
            ctx.putImageData(imageData, 0, 0);
            showToast('âœï¸ æé‚Šæ•ˆæœå·²å¥—ç”¨');
        }
        
        function applyLowPoly() {
            saveHistory();
            // ç°¡åŒ–çš„ä½å¤šé‚Šå½¢æ•ˆæœ
            const blockSize = 20;
            
            for (let y = 0; y < canvas.height; y += blockSize) {
                for (let x = 0; x < canvas.width; x += blockSize) {
                    const pixel = ctx.getImageData(x + blockSize/2, y + blockSize/2, 1, 1).data;
                    ctx.fillStyle = `rgb(${pixel[0]},${pixel[1]},${pixel[2]})`;
                    
                    // ç•«ä¸‰è§’å½¢
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                    ctx.lineTo(x + blockSize, y);
                    ctx.lineTo(x + blockSize/2, y + blockSize);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.beginPath();
                    ctx.moveTo(x, y + blockSize);
                    ctx.lineTo(x + blockSize/2, y + blockSize);
                    ctx.lineTo(x, y);
                    ctx.closePath();
                    ctx.fill();
                }
            }
            
            showToast('ğŸ”º ä½å¤šé‚Šå½¢æ•ˆæœå·²å¥—ç”¨');
        }
        
        function applyMiniature() {
            saveHistory();
            // å¢åŠ é£½å’Œåº¦
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                data[i] = Math.min(255, avg + (data[i] - avg) * 1.5);
                data[i+1] = Math.min(255, avg + (data[i+1] - avg) * 1.5);
                data[i+2] = Math.min(255, avg + (data[i+2] - avg) * 1.5);
            }
            ctx.putImageData(imageData, 0, 0);
            
            // ç§»è»¸æ¨¡ç³Š
            applyTiltShift();
            
            showToast('ğŸ  å¾®ç¸®æ•ˆæœå·²å¥—ç”¨');
        }
        
        function applyInfrared() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // äº¤æ›ç´…è—è‰²ä¸¦å¢å¼·
                const r = data[i], g = data[i+1], b = data[i+2];
                data[i] = Math.min(255, b * 1.5);
                data[i+1] = g;
                data[i+2] = Math.min(255, r * 0.5);
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ”´ ç´…å¤–ç·šæ•ˆæœå·²å¥—ç”¨');
        }
        
        function applyCrossProcess() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // äº¤å‰æ²–å°æ•ˆæœ
                data[i] = Math.min(255, data[i] * 1.1 + 20);
                data[i+1] = Math.min(255, data[i+1] * 0.9);
                data[i+2] = Math.min(255, data[i+2] * 1.2 + 30);
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸï¸ äº¤å‰æ²–å°æ•ˆæœå·²å¥—ç”¨');
        }
        
        function applyBleachBypass() {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const lum = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                // æ¸›å°‘é£½å’Œåº¦ï¼Œå¢åŠ å°æ¯”
                data[i] = Math.min(255, lum * 0.5 + data[i] * 0.5 + (data[i] - 128) * 0.3);
                data[i+1] = Math.min(255, lum * 0.5 + data[i+1] * 0.5 + (data[i+1] - 128) * 0.3);
                data[i+2] = Math.min(255, lum * 0.5 + data[i+2] * 0.5 + (data[i+2] - 128) * 0.3);
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ¥› æ¼‚ç™½æ•ˆæœå·²å¥—ç”¨');
        }
        
        // ===== åˆ†é›¢è‰²èª¿ =====
        function showSplitTonePanel() {
            togglePanel('splitTonePanel', 'splitToneBtn');
        }
        
        function applySplitTone() {
            saveHistory();
            const highlightTone = hexToRgb(document.getElementById('highlightTone')?.value || '#ffd700');
            const shadowTone = hexToRgb(document.getElementById('shadowTone')?.value || '#4169e1');
            const highlightSat = parseInt(document.getElementById('highlightSat')?.value || 25) / 100;
            const shadowSat = parseInt(document.getElementById('shadowSat')?.value || 25) / 100;
            const balance = parseInt(document.getElementById('toneBalance')?.value || 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const lum = (data[i] + data[i+1] + data[i+2]) / 3 / 255;
                const threshold = 0.5 + balance / 200;
                
                if (lum > threshold) {
                    const factor = (lum - threshold) / (1 - threshold) * highlightSat;
                    data[i] = data[i] * (1 - factor) + highlightTone.r * factor;
                    data[i+1] = data[i+1] * (1 - factor) + highlightTone.g * factor;
                    data[i+2] = data[i+2] * (1 - factor) + highlightTone.b * factor;
                } else {
                    const factor = (threshold - lum) / threshold * shadowSat;
                    data[i] = data[i] * (1 - factor) + shadowTone.r * factor;
                    data[i+1] = data[i+1] * (1 - factor) + shadowTone.g * factor;
                    data[i+2] = data[i+2] * (1 - factor) + shadowTone.b * factor;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ¨ åˆ†é›¢è‰²èª¿å·²å¥—ç”¨');
        }
        
        // ===== é›»å½±èª¿è‰² =====
        function showColorGradePanel() {
            togglePanel('colorGradePanel', 'colorGradeBtn');
        }
        
        function applyColorGrade(preset) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                
                switch(preset) {
                    case 'teal-orange':
                        const lum = 0.299 * r + 0.587 * g + 0.114 * b;
                        if (lum > 128) {
                            data[i] = Math.min(255, r * 1.1 + 20);
                            data[i+1] = Math.min(255, g * 0.9);
                        } else {
                            data[i+1] = Math.min(255, g * 1.1);
                            data[i+2] = Math.min(255, b * 1.2 + 10);
                        }
                        break;
                    case 'noir':
                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        const contrast = (gray - 128) * 1.5 + 128;
                        data[i] = data[i+1] = data[i+2] = Math.min(255, Math.max(0, contrast));
                        break;
                    case 'matrix':
                        data[i] = Math.min(255, r * 0.3);
                        data[i+1] = Math.min(255, g * 1.2 + 20);
                        data[i+2] = Math.min(255, b * 0.3);
                        break;
                    case 'sepia-cinema':
                        data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189 + 20);
                        data[i+1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                        data[i+2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131 - 10);
                        break;
                    case 'blade-runner':
                        data[i] = Math.min(255, r * 0.9 + 30);
                        data[i+1] = Math.min(255, g * 0.7);
                        data[i+2] = Math.min(255, b * 1.3 + 40);
                        break;
                    case 'horror':
                        data[i+1] = Math.min(255, g * 0.7);
                        data[i+2] = Math.min(255, b * 0.7);
                        break;
                    case 'romance':
                        data[i] = Math.min(255, r * 1.1 + 10);
                        data[i+1] = Math.min(255, g * 1.05);
                        data[i+2] = Math.min(255, b * 1.1 + 10);
                        break;
                    case 'action':
                        const actionContrast = 1.3;
                        data[i] = Math.min(255, (r - 128) * actionContrast + 128 + 10);
                        data[i+1] = Math.min(255, (g - 128) * actionContrast + 128);
                        data[i+2] = Math.min(255, (b - 128) * actionContrast + 128 - 10);
                        break;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ¬ é›»å½±èª¿è‰²å·²å¥—ç”¨');
        }
        
        // ===== LUT =====
        function showLutPanel() {
            togglePanel('lutPanel', 'lutBtn');
        }
        
        function applyLut(preset) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i], g = data[i+1], b = data[i+2];
                
                switch(preset) {
                    case 'fuji': // å¯Œå£«ï¼šæŸ”å’Œç¶ è‰²ï¼Œè†šè‰²è‡ªç„¶
                        r = Math.min(255, r * 0.98);
                        g = Math.min(255, g * 1.05 + 5);
                        b = Math.min(255, b * 0.95);
                        break;
                    case 'kodak': // æŸ¯é”ï¼šæš–è‰²èª¿ï¼Œé‡‘é»ƒ
                        r = Math.min(255, r * 1.08 + 10);
                        g = Math.min(255, g * 1.02 + 5);
                        b = Math.min(255, b * 0.9);
                        break;
                    case 'cinematic': // é›»å½±æ„Ÿï¼šé’æ©™åˆ†é›¢
                        const lum = 0.299 * r + 0.587 * g + 0.114 * b;
                        if (lum > 128) {
                            r = Math.min(255, r * 1.1 + 15);
                            g = Math.min(255, g * 0.95);
                        } else {
                            g = Math.min(255, g * 1.05);
                            b = Math.min(255, b * 1.15 + 10);
                        }
                        break;
                    case 'portrait': // äººåƒï¼šè†šè‰²å„ªåŒ–
                        const warmth = 1.05;
                        r = Math.min(255, r * warmth + 8);
                        g = Math.min(255, g * 1.02 + 3);
                        b = Math.min(255, b * 0.98);
                        break;
                }
                
                data[i] = r;
                data[i+1] = g;
                data[i+2] = b;
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            const lutNames = {
                'fuji': 'Fuji å¯Œå£«',
                'kodak': 'Kodak æŸ¯é”',
                'cinematic': 'é›»å½±æ„Ÿ',
                'portrait': 'äººåƒ'
            };
            showToast('ğŸ¥ ' + (lutNames[preset] || preset) + ' LUT å·²å¥—ç”¨');
        }
        
        // ===== å¾©å¤æ•ˆæœ =====
        function showVintagePanel() {
            togglePanel('vintagePanel', 'vintageBtn');
        }
        
        function applyVintagePreset(era) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                switch(era) {
                    case '60s':
                        data[i] = Math.min(255, data[i] * 1.1);
                        data[i+1] = Math.min(255, data[i+1] * 1.05);
                        data[i+2] = Math.max(0, data[i+2] * 0.8);
                        break;
                    case '70s':
                        data[i] = Math.min(255, data[i] * 1.1 + 20);
                        data[i+1] = Math.min(255, data[i+1] * 0.9 + 10);
                        data[i+2] = Math.max(0, data[i+2] * 0.7);
                        break;
                    case '80s':
                        data[i] = Math.min(255, data[i] * 1.2);
                        data[i+2] = Math.min(255, data[i+2] * 1.2);
                        break;
                    case '90s':
                        const g90 = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = data[i] * 0.8 + g90 * 0.2;
                        data[i+1] = data[i+1] * 0.8 + g90 * 0.2;
                        data[i+2] = data[i+2] * 0.8 + g90 * 0.2;
                        break;
                    case 'polaroid':
                        data[i] = Math.min(255, data[i] * 1.1 + 10);
                        data[i+1] = Math.min(255, data[i+1] * 1.05 + 5);
                        data[i+2] = Math.min(255, data[i+2] * 0.9);
                        break;
                    case 'daguerreotype':
                        const dagGray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                        data[i] = Math.min(255, dagGray * 1.1 + 20);
                        data[i+1] = Math.min(255, dagGray * 0.95 + 10);
                        data[i+2] = Math.min(255, dagGray * 0.8);
                        break;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ“» å¾©å¤æ•ˆæœå·²å¥—ç”¨');
        }
        
        // ===== åº•ç‰‡æ¨¡æ“¬ =====
        function showFilmPanel() {
            togglePanel('filmPanel', 'filmBtn');
        }
        
        function applyFilm(film) {
            applyFilmEffect(film);
        }
        
        function applyFilmEffect(film) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i], g = data[i+1], b = data[i+2];
                
                switch(film) {
                    case 'portra400': // æŸ”å’Œè†šè‰²ï¼Œä½å°æ¯”
                        r = Math.min(255, r * 1.05 + 5);
                        g = Math.min(255, g * 1.02);
                        b = Math.min(255, b * 0.95);
                        break;
                    case 'ektar100': // é«˜é£½å’Œï¼Œé®®è±”
                        const satE = 1.3;
                        const grayE = 0.299 * r + 0.587 * g + 0.114 * b;
                        r = Math.min(255, grayE + (r - grayE) * satE);
                        g = Math.min(255, grayE + (g - grayE) * satE);
                        b = Math.min(255, grayE + (b - grayE) * satE);
                        break;
                    case 'velvia50': // è¶…é«˜é£½å’Œï¼Œåç¶ 
                        const satV = 1.4;
                        const grayV = 0.299 * r + 0.587 * g + 0.114 * b;
                        r = Math.min(255, grayV + (r - grayV) * satV);
                        g = Math.min(255, grayV + (g - grayV) * satV * 1.1);
                        b = Math.min(255, grayV + (b - grayV) * satV);
                        break;
                    case 'provia100': // è‡ªç„¶è‰²å½©
                        r = Math.min(255, r * 1.02);
                        g = Math.min(255, g * 1.05);
                        b = Math.min(255, b * 1.08);
                        break;
                    case 'cinestill800': // æš–è‰²èª¿ï¼Œéœ“è™¹å…‰æšˆ
                        r = Math.min(255, r * 1.15 + 10);
                        g = Math.min(255, g * 0.95);
                        b = Math.min(255, b * 0.85);
                        break;
                    case 'trix400': // é»‘ç™½é«˜å°æ¯”
                        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                        const contrast = (gray - 128) * 1.3 + 128;
                        r = g = b = Math.min(255, Math.max(0, contrast));
                        break;
                }
                
                data[i] = r;
                data[i+1] = g;
                data[i+2] = b;
            }
            
            ctx.putImageData(imageData, 0, 0);
            
            const filmNames = {
                'portra400': 'Portra 400',
                'ektar100': 'Ektar 100',
                'velvia50': 'Velvia 50',
                'provia100': 'Provia 100',
                'cinestill800': 'CineStill 800',
                'trix400': 'Tri-X 400'
            };
            showToast('ğŸï¸ ' + (filmNames[film] || film) + ' åº•ç‰‡æ•ˆæœå·²å¥—ç”¨');
        }
        
        // ===== é›»å½±æ•ˆæœ =====
        function showCinemaPanel() {
            togglePanel('cinemaPanel', 'cinemaBtn');
        }
        
        function applyCinemaEffect() {
            saveHistory();
            const letterbox = document.getElementById('cinemaLetterbox')?.checked;
            const grain = document.getElementById('cinemaGrain')?.checked;
            const vignette = document.getElementById('cinemaVignette')?.checked;
            const ratio = parseFloat(document.getElementById('cinemaRatio')?.value || 2.35);
            
            if (letterbox) {
                const targetH = canvas.width / ratio;
                const barHeight = (canvas.height - targetH) / 2;
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, canvas.width, barHeight);
                ctx.fillRect(0, canvas.height - barHeight, canvas.width, barHeight);
            }
            
            if (grain) {
                applyNoise();
            }
            
            if (vignette) {
                applyVignette();
            }
            
            showToast('ğŸ¬ é›»å½±æ•ˆæœå·²å¥—ç”¨');
        }
        
        // ===== åˆ—å° =====
        function showPrintPanel() {
            togglePanel('printPanel', 'printBtn');
            // æ›´æ–°é è¦½åœ–
            updatePrintPreview();
        }
        
        function updatePrintPreview() {
            const previewImg = document.getElementById('printPreviewImg');
            if (previewImg && canvas.width > 0) {
                previewImg.src = canvas.toDataURL('image/png');
            }
        }
        
        function printImage() {
            if (!currentImage && canvas.width === 300) {
                showToast('âš ï¸ è«‹å…ˆè¼‰å…¥åœ–ç‰‡');
                return;
            }
            
            const printSize = document.getElementById('printSize').value;
            const fitPage = document.getElementById('printFitPage').checked;
            
            // ç´™å¼µå°ºå¯¸ï¼ˆmm è½‰ pxï¼Œå‡è¨­ 96dpiï¼‰
            const sizes = {
                'a4': { w: 794, h: 1123 },
                'a3': { w: 1123, h: 1587 },
                'letter': { w: 816, h: 1056 },
                'photo4x6': { w: 384, h: 576 },
                'photo5x7': { w: 480, h: 672 }
            };
            
            const size = sizes[printSize] || sizes['a4'];
            const isLandscape = canvas.width > canvas.height;
            
            let imgStyle = 'max-width:100%; max-height:100vh;';
            if (fitPage) {
                if (isLandscape) {
                    imgStyle = `width:${size.h}px; height:auto; max-height:${size.w}px;`;
                } else {
                    imgStyle = `width:auto; height:${size.h}px; max-width:${size.w}px;`;
                }
            }
            
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>åœ–æ–‡é­”è¡“å¸« - åˆ—å°</title>
                    <style>
                        @media print {
                            @page { 
                                size: ${printSize === 'letter' ? 'letter' : printSize.toUpperCase()} ${isLandscape ? 'landscape' : 'portrait'}; 
                                margin: 10mm;
                            }
                            body { margin: 0; }
                            .no-print { display: none !important; }
                        }
                        body {
                            margin: 0;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            min-height: 100vh;
                            background: #f0f0f0;
                            font-family: sans-serif;
                        }
                        .print-container {
                            background: white;
                            padding: 20px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        }
                        .print-btn {
                            margin: 20px;
                            padding: 15px 40px;
                            font-size: 18px;
                            background: #4CAF50;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                        }
                        .print-btn:hover { background: #45a049; }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="text-align:center;margin-bottom:10px;">
                        <h2>ğŸ–¨ï¸ åˆ—å°é è¦½</h2>
                        <p>ç´™å¼µ: ${printSize.toUpperCase()} | æ–¹å‘: ${isLandscape ? 'æ©«å‘' : 'ç›´å‘'}</p>
                    </div>
                    <div class="print-container">
                        <img src="${canvas.toDataURL('image/png')}" style="${imgStyle}">
                    </div>
                    <button class="print-btn no-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°</button>
                    <p class="no-print" style="color:#666;font-size:12px;">é»æ“Šä¸Šæ–¹æŒ‰éˆ•æˆ–æŒ‰ Ctrl+P é–‹å•Ÿåˆ—å°å°è©±æ¡†</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            showToast('ğŸ–¨ï¸ å·²é–‹å•Ÿåˆ—å°è¦–çª—');
        }
        
        // ===== åˆ†äº« =====
        function showSharePanel() {
            togglePanel('sharePanel', 'shareBtn');
        }
        
        // ç³»çµ±åŸç”Ÿåˆ†äº«
        async function shareNative() {
            if (!navigator.share) {
                showToast('âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç³»çµ±åˆ†äº«');
                return;
            }
            
            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const file = new File([blob], 'image.png', { type: 'image/png' });
                
                await navigator.share({
                    title: 'åœ–æ–‡é­”è¡“å¸«',
                    text: 'åˆ†äº«æˆ‘çš„åœ–ç‰‡',
                    files: [file]
                });
                showToast('âœ… åˆ†äº«æˆåŠŸ');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    showToast('âŒ åˆ†äº«å¤±æ•—');
                }
            }
        }
        
        // è¤‡è£½åœ–ç‰‡åˆ°å‰ªè²¼ç°¿
        async function copyToClipboard() {
            try {
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                await navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]);
                showToast('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            } catch (err) {
                showToast('âš ï¸ è¤‡è£½å¤±æ•—ï¼Œè«‹ä½¿ç”¨ä¸‹è¼‰åŠŸèƒ½');
            }
        }
        
        function shareToFacebook() {
            showToast('ğŸ“˜ åˆ†äº«åˆ° Facebook - éœ€è¦å…ˆä¸Šå‚³åœ–ç‰‡');
        }
        
        function shareToTwitter() {
            showToast('ğŸ¦ åˆ†äº«åˆ° Twitter - éœ€è¦å…ˆä¸Šå‚³åœ–ç‰‡');
        }
        
        function shareToLine() {
            sendToLine();
        }
        
        function shareToEmail() {
            const dataUrl = canvas.toDataURL('image/png');
            window.location.href = `mailto:?subject=åœ–æ–‡é­”è¡“å¸«&body=è«‹æŸ¥çœ‹é™„ä»¶åœ–ç‰‡`;
            showToast('ğŸ“§ é–‹å•Ÿéƒµä»¶ç”¨æˆ¶ç«¯');
        }
        
        function copyShareLink() {
            showToast('ğŸ”— éœ€è¦å…ˆä¸Šå‚³åˆ°é›²ç«¯');
        }
        
        function downloadQrShare() {
            showToast('ğŸ“± éœ€è¦å…ˆä¸Šå‚³åˆ°é›²ç«¯');
        }
        
        // ===== é›²ç«¯ =====
        function showCloudPanel() {
            togglePanel('cloudPanel', 'cloudBtn');
            // è¼‰å…¥å·²ä¿å­˜çš„ API Key
            const savedKey = localStorage.getItem('imgbbApiKey');
            if (savedKey) {
                document.getElementById('imgbbApiKey').value = savedKey;
            }
        }
        
        // ä¸Šå‚³åˆ° ImgBB
        async function uploadToImgBB() {
            const apiKey = document.getElementById('imgbbApiKey').value.trim();
            
            if (!apiKey) {
                showToast('âš ï¸ è«‹å…ˆè¼¸å…¥ ImgBB API Key');
                // é–‹å•Ÿå–å¾— API Key çš„ç¶²é 
                window.open('https://api.imgbb.com/', '_blank');
                return;
            }
            
            if (!currentImage && canvas.width === 300) {
                showToast('âš ï¸ è«‹å…ˆè¼‰å…¥åœ–ç‰‡');
                return;
            }
            
            // ä¿å­˜ API Key
            localStorage.setItem('imgbbApiKey', apiKey);
            
            showToast('ğŸ“¤ ä¸Šå‚³ä¸­...');
            
            try {
                // è½‰æ›ç‚º base64
                const dataUrl = canvas.toDataURL('image/png');
                const base64 = dataUrl.split(',')[1];
                
                const formData = new FormData();
                formData.append('key', apiKey);
                formData.append('image', base64);
                formData.append('name', 'image_' + Date.now());
                
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const url = data.data.url;
                    const deleteUrl = data.data.delete_url;
                    const resultDiv = document.getElementById('cloudResult');
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <div style="word-break:break-all;">
                            <strong style="color:#4CAF50;">âœ… ä¸Šå‚³æˆåŠŸï¼</strong><br><br>
                            <div style="margin-bottom:8px;">
                                <label style="font-size:11px;color:var(--text-secondary);">åœ–ç‰‡é€£çµï¼š</label><br>
                                <a href="${url}" target="_blank" style="color:var(--primary);font-size:12px;">${url}</a>
                            </div>
                            <div style="margin-bottom:8px;">
                                <label style="font-size:11px;color:var(--text-secondary);">ç›´æ¥é€£çµï¼š</label><br>
                                <span style="font-size:12px;color:var(--text-primary);">${data.data.display_url}</span>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
                            <button onclick="navigator.clipboard.writeText('${url}');showToast('âœ… å·²è¤‡è£½é€£çµ')" style="padding:6px 12px;background:var(--primary);color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">ğŸ“‹ è¤‡è£½é€£çµ</button>
                            <button onclick="navigator.clipboard.writeText('${data.data.display_url}');showToast('âœ… å·²è¤‡è£½ç›´æ¥é€£çµ')" style="padding:6px 12px;background:#17a2b8;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">ğŸ”— è¤‡è£½ç›´é€£</button>
                            <button onclick="window.open('${url}','_blank')" style="padding:6px 12px;background:#28a745;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">ğŸŒ é–‹å•Ÿ</button>
                        </div>
                    `;
                    showToast('âœ… ä¸Šå‚³æˆåŠŸï¼');
                } else {
                    throw new Error(data.error?.message || 'ä¸Šå‚³å¤±æ•—');
                }
            } catch (err) {
                const resultDiv = document.getElementById('cloudResult');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<strong style="color:#f44336;">âŒ ä¸Šå‚³å¤±æ•—</strong><br><span style="font-size:12px;">${err.message}</span>`;
                showToast('âŒ ä¸Šå‚³å¤±æ•—ï¼š' + err.message);
            }
        }
        
        // å­˜åˆ°ç€è¦½å™¨ LocalStorage
        function saveToLocalStorage() {
            try {
                const dataUrl = canvas.toDataURL('image/png');
                const saves = JSON.parse(localStorage.getItem('imageMagicSaves') || '[]');
                saves.unshift({
                    id: Date.now(),
                    data: dataUrl,
                    date: new Date().toLocaleString()
                });
                // æœ€å¤šä¿å­˜ 5 å¼µ
                if (saves.length > 5) saves.pop();
                localStorage.setItem('imageMagicSaves', JSON.stringify(saves));
                showToast('âœ… å·²å­˜åˆ°ç€è¦½å™¨ï¼ˆæœ€å¤šä¿å­˜ 5 å¼µï¼‰');
            } catch (err) {
                showToast('âŒ å„²å­˜å¤±æ•—ï¼Œå¯èƒ½ç©ºé–“ä¸è¶³');
            }
        }
        
        // å¾ç€è¦½å™¨è¼‰å…¥
        function loadFromLocalStorage() {
            const saves = JSON.parse(localStorage.getItem('imageMagicSaves') || '[]');
            if (saves.length === 0) {
                showToast('âš ï¸ æ²’æœ‰å·²ä¿å­˜çš„åœ–ç‰‡');
                return;
            }
            
            const resultDiv = document.getElementById('cloudResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<strong>ğŸ“‚ å·²ä¿å­˜çš„åœ–ç‰‡ï¼š</strong><br>' + 
                saves.map((s, i) => `
                    <div style="display:flex;align-items:center;gap:10px;margin-top:8px;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;">
                        <img src="${s.data}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;">
                        <div style="flex:1;font-size:11px;">${s.date}</div>
                        <button onclick="loadSavedImage(${i})" style="padding:4px 8px;background:var(--primary);color:white;border:none;border-radius:4px;cursor:pointer;">è¼‰å…¥</button>
                        <button onclick="deleteSavedImage(${i})" style="padding:4px 8px;background:#f44;color:white;border:none;border-radius:4px;cursor:pointer;">ğŸ—‘ï¸</button>
                    </div>
                `).join('');
        }
        
        function loadSavedImage(index) {
            const saves = JSON.parse(localStorage.getItem('imageMagicSaves') || '[]');
            if (saves[index]) {
                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    currentImage = img;
                    showToast('âœ… åœ–ç‰‡å·²è¼‰å…¥');
                };
                img.src = saves[index].data;
            }
        }
        
        function deleteSavedImage(index) {
            const saves = JSON.parse(localStorage.getItem('imageMagicSaves') || '[]');
            saves.splice(index, 1);
            localStorage.setItem('imageMagicSaves', JSON.stringify(saves));
            loadFromLocalStorage();
            showToast('ğŸ—‘ï¸ å·²åˆªé™¤');
        }
        
        function saveToCloudinary() {
            showToast('â˜ï¸ Cloudinary ä¸Šå‚³éœ€è¦è¨­å®š');
        }
        
        // ===== å¿«æ·éµ =====
        function showShortcutPanel() {
            togglePanel('shortcutPanel', 'shortcutBtn');
        }
        
        // ===== èªªæ˜ =====
        function showHelpPanel() {
            togglePanel('helpPanel', 'helpBtn');
        }
        
        // ===== ä¸»é¡Œåˆ‡æ› =====
        let darkMode = true;
        
        function toggleTheme() {
            darkMode = !darkMode;
            document.documentElement.style.setProperty('--bg-dark', darkMode ? '#0a0a1a' : '#f5f5f5');
            document.documentElement.style.setProperty('--bg-card', darkMode ? '#1a1a2e' : '#ffffff');
            document.documentElement.style.setProperty('--text-primary', darkMode ? '#ffffff' : '#333333');
            showToast('ğŸ¨ ä¸»é¡Œå·²åˆ‡æ›');
        }
        
        // ===== èªè¨€åˆ‡æ› =====
        function toggleLang() {
            showToast('ğŸŒ èªè¨€åˆ‡æ›åŠŸèƒ½é–‹ç™¼ä¸­');
        }
        
        // ===== å±€éƒ¨å½©è‰² =====
        function showColorSplashPanel() {
            togglePanel('colorSplashPanel', 'colorSplashBtn');
        }
        
        function applyColorSplash() {
            saveHistory();
            const keepColor = hexToRgb(document.getElementById('splashColor')?.value || '#ff0000');
            const tolerance = parseInt(document.getElementById('splashTolerance')?.value || 30);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2];
                const diff = Math.abs(r - keepColor.r) + Math.abs(g - keepColor.g) + Math.abs(b - keepColor.b);
                
                if (diff > tolerance * 3) {
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    data[i] = data[i+1] = data[i+2] = gray;
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ’¦ å±€éƒ¨å½©è‰²æ•ˆæœå·²å¥—ç”¨');
        }
        
        // ===== é»é™£åœ–è—è¡“ =====
        function showDotArtPanel() {
            togglePanel('dotArtPanel', 'dotArtBtn');
        }
        
        function applyDotArt() {
            saveHistory();
            const dotSize = parseInt(document.getElementById('dotSize')?.value || 8);
            const spacing = parseInt(document.getElementById('dotSpacing')?.value || 10);
            const shape = document.getElementById('dotShape')?.value || 'circle';
            
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            for (let y = spacing/2; y < canvas.height; y += spacing) {
                for (let x = spacing/2; x < canvas.width; x += spacing) {
                    const pixel = tempCtx.getImageData(x, y, 1, 1).data;
                    ctx.fillStyle = `rgb(${pixel[0]},${pixel[1]},${pixel[2]})`;
                    
                    if (shape === 'circle') {
                        ctx.beginPath();
                        ctx.arc(x, y, dotSize/2, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (shape === 'square') {
                        ctx.fillRect(x - dotSize/2, y - dotSize/2, dotSize, dotSize);
                    } else if (shape === 'diamond') {
                        ctx.beginPath();
                        ctx.moveTo(x, y - dotSize/2);
                        ctx.lineTo(x + dotSize/2, y);
                        ctx.lineTo(x, y + dotSize/2);
                        ctx.lineTo(x - dotSize/2, y);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
            }
            
            showToast('âš« é»é™£åœ–è—è¡“å·²å¥—ç”¨');
        }
        
        // ===== ç¾é¡é€²éšåŠŸèƒ½ =====
        function showSlimFacePanel() {
            togglePanel('slimFacePanel', 'slimFaceBtn');
        }
        
        function applySlimFace() {
            showToast('ğŸ§‘ ç˜¦è‡‰åŠŸèƒ½éœ€è¦äººè‡‰æª¢æ¸¬');
        }
        
        function showBigEyePanel() {
            togglePanel('bigEyePanel', 'bigEyeBtn');
        }
        
        function applyBigEye() {
            saveHistory();
            const amount = parseInt(document.getElementById('eyeEnlarge')?.value || 20);
            
            // ç°¡åŒ–çš„æ”¾å¤§æ•ˆæœï¼ˆçƒé¢åŒ–ä¸­å¿ƒå€åŸŸï¼‰
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 3;  // çœ¼ç›å¤§ç´„åœ¨ä¸Š1/3ä½ç½®
            const radius = Math.min(canvas.width, canvas.height) / 4;
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const srcData = new Uint8ClampedArray(imageData.data);
            const data = imageData.data;
            
            const strength = amount / 100;
            
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const dx = x - centerX;
                    const dy = y - centerY;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < radius) {
                        const factor = 1 - (dist / radius) * strength * 0.5;
                        const srcX = Math.round(centerX + dx * factor);
                        const srcY = Math.round(centerY + dy * factor);
                        
                        if (srcX >= 0 && srcX < canvas.width && srcY >= 0 && srcY < canvas.height) {
                            const dstIdx = (y * canvas.width + x) * 4;
                            const srcIdx = (srcY * canvas.width + srcX) * 4;
                            data[dstIdx] = srcData[srcIdx];
                            data[dstIdx + 1] = srcData[srcIdx + 1];
                            data[dstIdx + 2] = srcData[srcIdx + 2];
                        }
                    }
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ‘€ å¤§çœ¼æ•ˆæœå·²å¥—ç”¨ï¼ˆæ¨¡æ“¬ï¼‰');
        }
        
        function showMakeupPanel() {
            togglePanel('makeupPanel', 'makeupBtn');
        }
        
        function applyMakeup(type) {
            saveHistory();
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // ç°¡åŒ–çš„å½©å¦æ•ˆæœï¼ˆèª¿æ•´è‰²èª¿ï¼‰
            switch(type) {
                case 'lipstick':
                    // å¢åŠ ç´…è‰²é£½å’Œåº¦ï¼ˆæ¨¡æ“¬å£ç´…ï¼‰
                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i] > data[i+1] && data[i] > data[i+2]) {
                            data[i] = Math.min(255, data[i] * 1.3);
                        }
                    }
                    showToast('ğŸ’‹ å£ç´…æ•ˆæœå·²å¥—ç”¨ï¼ˆæ¨¡æ“¬ï¼‰');
                    break;
                case 'blush':
                    // ä¸­é–“å€åŸŸåŠ ç²‰è‰²
                    const cx = canvas.width / 2;
                    const cy = canvas.height / 2;
                    for (let y = 0; y < canvas.height; y++) {
                        for (let x = 0; x < canvas.width; x++) {
                            const dist = Math.sqrt((x-cx)**2 + (y-cy)**2);
                            if (dist < canvas.width/4) {
                                const idx = (y * canvas.width + x) * 4;
                                data[idx] = Math.min(255, data[idx] + 15);
                                data[idx+1] = Math.min(255, data[idx+1] + 5);
                            }
                        }
                    }
                    showToast('ğŸŒ¸ è…®ç´…æ•ˆæœå·²å¥—ç”¨ï¼ˆæ¨¡æ“¬ï¼‰');
                    break;
                case 'eyeshadow':
                    showToast('ğŸ‘ï¸ çœ¼å½±éœ€è¦äººè‡‰æª¢æ¸¬å®šä½');
                    return;
                case 'eyeliner':
                    showToast('âœï¸ çœ¼ç·šéœ€è¦äººè‡‰æª¢æ¸¬å®šä½');
                    return;
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        function showFaceSwapPanel() {
            togglePanel('faceSwapPanel', 'faceSwapBtn');
        }
        
        function applyFaceSwap() {
            showToast('ğŸ­ æ›è‡‰åŠŸèƒ½éœ€è¦é€²éš AI æ¨¡å‹ï¼ˆå¦‚ InsightFaceï¼‰\nç›®å‰å°šæœªæ•´åˆï¼Œæ•¬è«‹æœŸå¾…ï¼');
        }
        
        function applyPortraitBlur() {
            showToast('ğŸ–¼ï¸ äººåƒæ¨¡ç³Šéœ€è¦äººé«”æª¢æ¸¬');
        }
        
        function showSkeletonPanel() {
            togglePanel('skeletonPanel', 'skeletonBtn');
        }
        
        function detectSkeleton() {
            showToast('ğŸ¦´ éª¨æ¶æª¢æ¸¬éœ€è¦ AI å§¿æ…‹ä¼°è¨ˆæ¨¡å‹ï¼ˆå¦‚ PoseNetï¼‰\nç›®å‰å°šæœªæ•´åˆï¼Œæ•¬è«‹æœŸå¾…ï¼');
        }
        
        function showMosaicArtPanel() {
            // ç›´æ¥æ‡‰ç”¨é¦¬è³½å…‹è—è¡“æ•ˆæœ
            saveHistory();
            const blockSize = 10;
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let y = 0; y < canvas.height; y += blockSize) {
                for (let x = 0; x < canvas.width; x += blockSize) {
                    let r = 0, g = 0, b = 0, count = 0;
                    
                    // è¨ˆç®—å€å¡Šå¹³å‡è‰²
                    for (let dy = 0; dy < blockSize && y + dy < canvas.height; dy++) {
                        for (let dx = 0; dx < blockSize && x + dx < canvas.width; dx++) {
                            const i = ((y + dy) * canvas.width + (x + dx)) * 4;
                            r += data[i];
                            g += data[i + 1];
                            b += data[i + 2];
                            count++;
                        }
                    }
                    
                    r = Math.round(r / count);
                    g = Math.round(g / count);
                    b = Math.round(b / count);
                    
                    // å¡«å……å€å¡Š
                    for (let dy = 0; dy < blockSize && y + dy < canvas.height; dy++) {
                        for (let dx = 0; dx < blockSize && x + dx < canvas.width; dx++) {
                            const i = ((y + dy) * canvas.width + (x + dx)) * 4;
                            data[i] = r;
                            data[i + 1] = g;
                            data[i + 2] = b;
                        }
                    }
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ§± é¦¬è³½å…‹è—è¡“æ•ˆæœå·²å¥—ç”¨');
        }
        
        // ===== å°ºè¦ =====
        let rulerVisible = false;
        
        function toggleRuler() {
            rulerVisible = !rulerVisible;
            document.getElementById('rulerBtn')?.classList.toggle('active', rulerVisible);
            
            if (rulerVisible) {
                // ç•«å°ºè¦
                ctx.strokeStyle = '#00ffff';
                ctx.lineWidth = 1;
                ctx.font = '10px sans-serif';
                ctx.fillStyle = '#00ffff';
                
                // ä¸Šå°º
                for (let x = 0; x < canvas.width; x += 50) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, 10);
                    ctx.stroke();
                    ctx.fillText(x.toString(), x + 2, 20);
                }
                
                // å·¦å°º
                for (let y = 0; y < canvas.height; y += 50) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(10, y);
                    ctx.stroke();
                    ctx.fillText(y.toString(), 12, y + 10);
                }
                
                showToast('ğŸ“ å°ºè¦å·²é¡¯ç¤º');
            } else {
                undoAction();
                showToast('ğŸ“ å°ºè¦å·²éš±è—');
            }
        }
        
        // ===== é€šç”¨é¢æ¿åˆ‡æ› =====
        function togglePanel(panelId, btnId) {
            const panel = document.getElementById(panelId);
            const allPanels = [
                'aiPanel', 'pdfToolPanel', 'watermarkPanel', 'stampPanel', 'signPanel', 
                'filterPanel', 'adjustPanel', 'framePanel', 'stickerPanel', 'cropPanel', 
                'mergePanel', 'qrPanel', 'compressPanel', 'brushPanel', 'shapePanel',
                'textFxPanel', 'templatePanel', 'collagePanel', 'beautyPanel', 'removeBgPanel',
                'batchPanel', 'effectPanel', 'overlayPanel', 'annotatePanel', 'historyPanel',
                'infoPanel', 'colorReplacePanel', 'idPhotoPanel', 'screenshotPanel',
                'pixelArtPanel', 'asciiPanel', 'duotonePanel', 'gradientPanel', 'noisePanel',
                'blurBgPanel', 'texturePanel', 'bokehPanel', 'mirrorPanel', 'splitPanel',
                'socialPanel', 'exportPanel', 'memePanel', 'posterPanel', 'bannerPanel',
                'chartPanel', 'diagramPanel', 'timelinePanel', 'infographicPanel',
                'businessCardPanel', 'invoicePanel', 'certificatePanel', 'badgePanel',
                'avatarPanel', 'thumbnailPanel', 'coverPanel', 'mockupPanel', 'colorPalettePanel',
                'imageAnalysisPanel', 'aiEnhancePanel', 'aiStylePanel', 'aiObjectPanel',
                'aiCaptionPanel', 'drawingPanel', 'patternPanel', 'borderPanel', 'shadowPanel',
                'reflectionPanel', 'perspective3DPanel', 'warpPanel', 'liquifyPanel',
                'clonePanel', 'healPanel', 'redeyePanel', 'whiteBalancePanel', 'levelsPanel',
                'curvesPanel', 'channelMixerPanel', 'colorBalancePanel', 'vibranPanel',
                'hslPanel', 'splitTonePanel', 'lensPanel', 'chromaticPanel', 'filmGrainPanel',
                'arrowPanel', 'printPanel', 'sharePanel', 'cloudPanel', 'shortcutPanel', 'helpPanel',
                'colorGradePanel', 'lutPanel', 'vintagePanel', 'filmPanel', 'cinemaPanel',
                'splitTonePanel', 'eyeDropperAdvPanel', 'gifPanel',
                'photoFilterPanel', 'selectiveColorPanel', 'colorBalancePanel', 'histogramPanel',
                'curvePanel', 'liquifyPanel', 'layerPanel', 'channelPanel', 'alignPanel', 'guidePanel',
                'dotArtPanel', 'colorSplashPanel', 'slimFacePanel', 'bigEyePanel', 'makeupPanel',
                'faceSwapPanel', 'skeletonPanel', 'lensBlurPanel', 'motionBlurPanel', 'warpPanel',
                'perspectivePanel', 'distortPanel', 'cardPanel', 'logoPanel'
            ];
            
            // é—œé–‰å…¶ä»–é¢æ¿
            allPanels.forEach(p => {
                if (p !== panelId) {
                    const el = document.getElementById(p);
                    if (el) el.classList.remove('show');
                }
            });
            
            if (panel) {
                panel.classList.toggle('show');
                const btn = document.getElementById(btnId);
                if (btn) btn.classList.toggle('active', panel.classList.contains('show'));
            }
        }
        
        // ===== æ¢—åœ–ç”¢ç”Ÿå™¨ =====
        const memeTemplates = [
            { name: 'ç¶“å…¸ä¸Šä¸‹æ–‡', type: 'top-bottom', positions: ['top', 'bottom'] },
            { name: 'å·¦å³å°è©±', type: 'left-right', positions: ['left', 'right'] },
            { name: 'å››æ ¼æ¼«ç•«', type: 'grid-4', positions: ['tl', 'tr', 'bl', 'br'] },
            { name: 'å°æ¯”', type: 'compare', positions: ['before', 'after'] },
            { name: 'æ—ç™½', type: 'caption', positions: ['caption'] },
            { name: 'æ³¡æ³¡å°è©±', type: 'bubble', positions: ['bubble1', 'bubble2'] }
        ];
        
        function showMemePanel() {
            togglePanel('memePanel', 'memeBtn');
            initMemeTemplates();
        }
        
        function initMemeTemplates() {
            const grid = document.getElementById('memeTemplateGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            memeTemplates.forEach((template, i) => {
                const item = document.createElement('button');
                item.className = 'meme-template';
                item.textContent = template.name;
                item.onclick = () => selectMemeTemplate(i);
                grid.appendChild(item);
            });
        }
        
        let currentMemeTemplate = null;
        
        function selectMemeTemplate(index) {
            currentMemeTemplate = memeTemplates[index];
            document.querySelectorAll('.meme-template').forEach((t, i) => {
                t.classList.toggle('active', i === index);
            });
            
            // é¡¯ç¤ºæ–‡å­—è¼¸å…¥æ¬„ä½
            const inputs = document.getElementById('memeInputs');
            inputs.innerHTML = '';
            
            currentMemeTemplate.positions.forEach((pos, i) => {
                const label = document.createElement('label');
                label.textContent = `æ–‡å­— ${i + 1} (${pos})`;
                const input = document.createElement('input');
                input.type = 'text';
                input.id = `memeText${i}`;
                input.className = 'wm-input';
                input.placeholder = `è¼¸å…¥ç¬¬ ${i + 1} æ®µæ–‡å­—...`;
                inputs.appendChild(label);
                inputs.appendChild(input);
            });
        }
        
        function generateMeme() {
            if (!currentMemeTemplate) {
                showToast('âš ï¸ è«‹å…ˆé¸æ“‡æ¢—åœ–æ¨¡æ¿');
                return;
            }
            
            saveHistory();
            
            const fontSize = parseInt(document.getElementById('memeFontSize')?.value || 40);
            const fontColor = document.getElementById('memeFontColor')?.value || '#ffffff';
            const strokeColor = document.getElementById('memeStrokeColor')?.value || '#000000';
            
            ctx.font = `bold ${fontSize}px Impact, sans-serif`;
            ctx.fillStyle = fontColor;
            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = 3;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            currentMemeTemplate.positions.forEach((pos, i) => {
                const text = document.getElementById(`memeText${i}`)?.value?.toUpperCase() || '';
                if (!text) return;
                
                let x, y;
                switch(pos) {
                    case 'top':
                        x = canvas.width / 2;
                        y = fontSize + 10;
                        break;
                    case 'bottom':
                        x = canvas.width / 2;
                        y = canvas.height - fontSize - 10;
                        break;
                    case 'left':
                        x = canvas.width / 4;
                        y = canvas.height / 2;
                        break;
                    case 'right':
                        x = canvas.width * 3 / 4;
                        y = canvas.height / 2;
                        break;
                    case 'caption':
                        x = canvas.width / 2;
                        y = canvas.height - fontSize - 10;
                        break;
                    default:
                        x = canvas.width / 2;
                        y = canvas.height / 2;
                }
                
                // æ–‡å­—æ›è¡Œè™•ç†
                const maxWidth = canvas.width * 0.9;
                const words = text.split(' ');
                let line = '';
                let lineY = y;
                
                words.forEach(word => {
                    const testLine = line + word + ' ';
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && line !== '') {
                        ctx.strokeText(line.trim(), x, lineY);
                        ctx.fillText(line.trim(), x, lineY);
                        line = word + ' ';
                        lineY += fontSize + 5;
                    } else {
                        line = testLine;
                    }
                });
                
                ctx.strokeText(line.trim(), x, lineY);
                ctx.fillText(line.trim(), x, lineY);
            });
            
            showToast('ğŸ˜‚ æ¢—åœ–å·²ç”¢ç”Ÿï¼');
        }
        
        // ===== æµ·å ±è£½ä½œ =====
        const posterStyles = {
            movie: { bg: '#1a1a2e', accent: '#e94560', font: 'Impact' },
            concert: { bg: '#0f0f23', accent: '#ff6b6b', font: 'Arial Black' },
            sale: { bg: '#ff4757', accent: '#ffd32a', font: 'Arial Black' },
            minimalist: { bg: '#ffffff', accent: '#2d3436', font: 'Helvetica' },
            vintage: { bg: '#f5e6d3', accent: '#8b4513', font: 'Georgia' },
            neon: { bg: '#000000', accent: '#00ff88', font: 'Arial' },
            gradient: { bg: 'gradient', accent: '#ffffff', font: 'Arial Black' },
            photo: { bg: 'photo', accent: '#ffffff', font: 'Helvetica' }
        };
        
        function showPosterPanel() {
            togglePanel('posterPanel', 'posterBtn');
        }
        
        function createPoster(style) {
            saveHistory();
            
            const posterStyle = posterStyles[style] || posterStyles.minimalist;
            const title = document.getElementById('posterTitle')?.value || 'æ¨™é¡Œ';
            const subtitle = document.getElementById('posterSubtitle')?.value || '';
            const date = document.getElementById('posterDate')?.value || '';
            const location = document.getElementById('posterLocation')?.value || '';
            
            // è¨­å®šèƒŒæ™¯
            if (posterStyle.bg === 'gradient') {
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (posterStyle.bg !== 'photo') {
                ctx.fillStyle = posterStyle.bg;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // æ¨™é¡Œ
            ctx.fillStyle = posterStyle.accent;
            ctx.font = `bold 60px ${posterStyle.font}`;
            ctx.textAlign = 'center';
            ctx.fillText(title, canvas.width / 2, canvas.height * 0.3);
            
            // å‰¯æ¨™é¡Œ
            if (subtitle) {
                ctx.font = `30px ${posterStyle.font}`;
                ctx.fillText(subtitle, canvas.width / 2, canvas.height * 0.45);
            }
            
            // æ—¥æœŸå’Œåœ°é»
            ctx.font = `24px ${posterStyle.font}`;
            if (date) ctx.fillText(date, canvas.width / 2, canvas.height * 0.75);
            if (location) ctx.fillText(location, canvas.width / 2, canvas.height * 0.82);
            
            showToast('ğŸ“° æµ·å ±å·²å»ºç«‹ï¼');
        }
        
        // ===== æ©«å¹…è£½ä½œ =====
        const bannerSizes = {
            'web-leaderboard': { w: 728, h: 90, name: 'ç¶²é æ©«å¹…' },
            'web-skyscraper': { w: 160, h: 600, name: 'æ‘©å¤©å¤§æ¨“' },
            'web-rectangle': { w: 300, h: 250, name: 'çŸ©å½¢å»£å‘Š' },
            'social-fb': { w: 1200, h: 628, name: 'FB æ©«å¹…' },
            'social-tw': { w: 1500, h: 500, name: 'Twitter æ©«å¹…' },
            'social-li': { w: 1584, h: 396, name: 'LinkedIn æ©«å¹…' },
            'email': { w: 600, h: 200, name: 'é›»éƒµæ©«å¹…' },
            'blog': { w: 1200, h: 400, name: 'éƒ¨è½æ ¼æ©«å¹…' }
        };
        
        function showBannerPanel() {
            togglePanel('bannerPanel', 'bannerBtn');
            initBannerSizes();
        }
        
        function initBannerSizes() {
            const grid = document.getElementById('bannerSizeGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            Object.entries(bannerSizes).forEach(([key, size]) => {
                const item = document.createElement('button');
                item.className = 'banner-size-item';
                item.innerHTML = `${size.name}<br><small>${size.w}Ã—${size.h}</small>`;
                item.onclick = () => createBanner(key);
                grid.appendChild(item);
            });
        }
        
        function createBanner(sizeKey) {
            const size = bannerSizes[sizeKey];
            if (!size) return;
            
            saveHistory();
            
            const text = document.getElementById('bannerText')?.value || 'æ©«å¹…æ¨™é¡Œ';
            const cta = document.getElementById('bannerCTA')?.value || '';
            const bgColor = document.getElementById('bannerBgColor')?.value || '#667eea';
            const textColor = document.getElementById('bannerTextColor')?.value || '#ffffff';
            
            canvas.width = size.w;
            canvas.height = size.h;
            
            // æ¼¸å±¤èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, size.w, 0);
            gradient.addColorStop(0, bgColor);
            gradient.addColorStop(1, adjustColor(bgColor, -30));
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, size.w, size.h);
            
            // ä¸»æ–‡å­—
            const fontSize = Math.min(size.h * 0.4, 48);
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.fillStyle = textColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, size.w / 2, size.h * 0.4);
            
            // CTA æŒ‰éˆ•
            if (cta) {
                const ctaWidth = ctx.measureText(cta).width + 40;
                const ctaHeight = fontSize * 0.8;
                const ctaX = size.w / 2 - ctaWidth / 2;
                const ctaY = size.h * 0.65;
                
                ctx.fillStyle = textColor;
                ctx.beginPath();
                ctx.roundRect(ctaX, ctaY, ctaWidth, ctaHeight, 5);
                ctx.fill();
                
                ctx.fillStyle = bgColor;
                ctx.font = `bold ${fontSize * 0.5}px Arial`;
                ctx.fillText(cta, size.w / 2, ctaY + ctaHeight / 2);
            }
            
            showToast('ğŸ¯ æ©«å¹…å·²å»ºç«‹ï¼');
        }
        
        function adjustColor(hex, amount) {
            const num = parseInt(hex.slice(1), 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
        }
        
        // ===== åœ–è¡¨è£½ä½œ =====
        function showChartPanel() {
            togglePanel('chartPanel', 'chartBtn');
        }
        
        function createChart(type) {
            saveHistory();
            
            const dataInput = document.getElementById('chartData')?.value || '30,50,40,60,80';
            const labelsInput = document.getElementById('chartLabels')?.value || 'A,B,C,D,E';
            const title = document.getElementById('chartTitle')?.value || 'åœ–è¡¨æ¨™é¡Œ';
            
            const data = dataInput.split(',').map(v => parseFloat(v.trim()));
            const labels = labelsInput.split(',').map(l => l.trim());
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#a29bfe', '#fd79a8'];
            
            // æ¸…ç©ºç•«å¸ƒ
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ¨™é¡Œ
            ctx.fillStyle = '#2d3436';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, canvas.width / 2, 40);
            
            const chartArea = {
                x: 60,
                y: 70,
                w: canvas.width - 100,
                h: canvas.height - 120
            };
            
            const maxValue = Math.max(...data);
            
            switch(type) {
                case 'bar':
                    drawBarChart(data, labels, colors, chartArea, maxValue);
                    break;
                case 'line':
                    drawLineChart(data, labels, colors[0], chartArea, maxValue);
                    break;
                case 'pie':
                    drawPieChart(data, labels, colors);
                    break;
                case 'donut':
                    drawDonutChart(data, labels, colors);
                    break;
                case 'horizontal':
                    drawHorizontalBarChart(data, labels, colors, chartArea, maxValue);
                    break;
                case 'area':
                    drawAreaChart(data, labels, colors[0], chartArea, maxValue);
                    break;
            }
            
            showToast('ğŸ“Š åœ–è¡¨å·²å»ºç«‹ï¼');
        }
        
        function drawBarChart(data, labels, colors, area, maxValue) {
            const barWidth = area.w / data.length * 0.7;
            const gap = area.w / data.length * 0.3;
            
            data.forEach((value, i) => {
                const barHeight = (value / maxValue) * area.h;
                const x = area.x + i * (barWidth + gap) + gap / 2;
                const y = area.y + area.h - barHeight;
                
                ctx.fillStyle = colors[i % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // æ•¸å€¼æ¨™ç±¤
                ctx.fillStyle = '#2d3436';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value, x + barWidth / 2, y - 10);
                
                // X è»¸æ¨™ç±¤
                ctx.fillText(labels[i] || '', x + barWidth / 2, area.y + area.h + 20);
            });
            
            // ç¹ªè£½è»¸ç·š
            ctx.strokeStyle = '#dfe6e9';
            ctx.beginPath();
            ctx.moveTo(area.x, area.y);
            ctx.lineTo(area.x, area.y + area.h);
            ctx.lineTo(area.x + area.w, area.y + area.h);
            ctx.stroke();
        }
        
        function drawLineChart(data, labels, color, area, maxValue) {
            const stepX = area.w / (data.length - 1);
            
            // ç¹ªè£½ç¶²æ ¼
            ctx.strokeStyle = '#ecf0f1';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = area.y + (area.h / 5) * i;
                ctx.beginPath();
                ctx.moveTo(area.x, y);
                ctx.lineTo(area.x + area.w, y);
                ctx.stroke();
            }
            
            // ç¹ªè£½ç·šæ¢
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            data.forEach((value, i) => {
                const x = area.x + i * stepX;
                const y = area.y + area.h - (value / maxValue) * area.h;
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // ç¹ªè£½é»å’Œæ¨™ç±¤
            data.forEach((value, i) => {
                const x = area.x + i * stepX;
                const y = area.y + area.h - (value / maxValue) * area.h;
                
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.fillStyle = '#2d3436';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value, x, y - 15);
                ctx.fillText(labels[i] || '', x, area.y + area.h + 20);
            });
        }
        
        function drawPieChart(data, labels, colors) {
            const total = data.reduce((a, b) => a + b, 0);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 + 20;
            const radius = Math.min(canvas.width, canvas.height) * 0.35;
            
            let startAngle = -Math.PI / 2;
            
            data.forEach((value, i) => {
                const sliceAngle = (value / total) * Math.PI * 2;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // æ¨™ç±¤
                const labelAngle = startAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
                const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const percent = Math.round((value / total) * 100);
                ctx.fillText(`${percent}%`, labelX, labelY);
                
                startAngle += sliceAngle;
            });
            
            // åœ–ä¾‹
            labels.forEach((label, i) => {
                const legendX = 20;
                const legendY = canvas.height - 30 - (labels.length - i - 1) * 25;
                
                ctx.fillStyle = colors[i % colors.length];
                ctx.fillRect(legendX, legendY - 10, 15, 15);
                
                ctx.fillStyle = '#2d3436';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(label, legendX + 20, legendY);
            });
        }
        
        function drawDonutChart(data, labels, colors) {
            const total = data.reduce((a, b) => a + b, 0);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2 + 20;
            const outerRadius = Math.min(canvas.width, canvas.height) * 0.35;
            const innerRadius = outerRadius * 0.6;
            
            let startAngle = -Math.PI / 2;
            
            data.forEach((value, i) => {
                const sliceAngle = (value / total) * Math.PI * 2;
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, outerRadius, startAngle, startAngle + sliceAngle);
                ctx.arc(centerX, centerY, innerRadius, startAngle + sliceAngle, startAngle, true);
                ctx.closePath();
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                startAngle += sliceAngle;
            });
            
            // ä¸­å¿ƒæ–‡å­—
            ctx.fillStyle = '#2d3436';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ç¸½è¨ˆ', centerX, centerY - 10);
            ctx.font = 'bold 32px Arial';
            ctx.fillText(total, centerX, centerY + 20);
        }
        
        function drawHorizontalBarChart(data, labels, colors, area, maxValue) {
            const barHeight = area.h / data.length * 0.7;
            const gap = area.h / data.length * 0.3;
            
            data.forEach((value, i) => {
                const barWidth = (value / maxValue) * area.w;
                const x = area.x;
                const y = area.y + i * (barHeight + gap) + gap / 2;
                
                ctx.fillStyle = colors[i % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // æ•¸å€¼æ¨™ç±¤
                ctx.fillStyle = '#2d3436';
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(value, x + barWidth + 10, y + barHeight / 2);
                
                // Y è»¸æ¨™ç±¤
                ctx.textAlign = 'right';
                ctx.fillText(labels[i] || '', area.x - 10, y + barHeight / 2);
            });
        }
        
        function drawAreaChart(data, labels, color, area, maxValue) {
            const stepX = area.w / (data.length - 1);
            
            // å¡«å……å€åŸŸ
            ctx.beginPath();
            ctx.moveTo(area.x, area.y + area.h);
            
            data.forEach((value, i) => {
                const x = area.x + i * stepX;
                const y = area.y + area.h - (value / maxValue) * area.h;
                ctx.lineTo(x, y);
            });
            
            ctx.lineTo(area.x + area.w, area.y + area.h);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(0, area.y, 0, area.y + area.h);
            gradient.addColorStop(0, color);
            gradient.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // ç¹ªè£½ç·šæ¢
            drawLineChart(data, labels, color, area, maxValue);
        }
        
        // ===== æµç¨‹åœ– =====
        const diagramShapes = {
            process: { draw: drawProcessBox, label: 'è™•ç†' },
            decision: { draw: drawDecisionDiamond, label: 'åˆ¤æ–·' },
            start: { draw: drawStartEnd, label: 'é–‹å§‹/çµæŸ' },
            io: { draw: drawIOParallel, label: 'è¼¸å…¥/è¼¸å‡º' },
            connector: { draw: drawConnector, label: 'é€£æ¥' }
        };
        
        function showDiagramPanel() {
            togglePanel('diagramPanel', 'diagramBtn');
        }
        
        function addDiagramShape(type) {
            saveHistory();
            const shape = diagramShapes[type];
            if (!shape) return;
            
            const text = document.getElementById('diagramText')?.value || shape.label;
            const x = canvas.width / 2;
            const y = canvas.height / 2;
            const color = document.getElementById('diagramColor')?.value || '#4ecdc4';
            
            shape.draw(ctx, x, y, 150, 80, color, text);
            showToast('ğŸ“ æµç¨‹åœ–å½¢ç‹€å·²åŠ å…¥');
        }
        
        function drawProcessBox(ctx, x, y, w, h, color, text) {
            ctx.fillStyle = color;
            ctx.strokeStyle = '#2d3436';
            ctx.lineWidth = 2;
            ctx.fillRect(x - w/2, y - h/2, w, h);
            ctx.strokeRect(x - w/2, y - h/2, w, h);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
        }
        
        function drawDecisionDiamond(ctx, x, y, w, h, color, text) {
            ctx.beginPath();
            ctx.moveTo(x, y - h/2);
            ctx.lineTo(x + w/2, y);
            ctx.lineTo(x, y + h/2);
            ctx.lineTo(x - w/2, y);
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#2d3436';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
        }
        
        function drawStartEnd(ctx, x, y, w, h, color, text) {
            ctx.beginPath();
            ctx.ellipse(x, y, w/2, h/2, 0, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#2d3436';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
        }
        
        function drawIOParallel(ctx, x, y, w, h, color, text) {
            const skew = 20;
            ctx.beginPath();
            ctx.moveTo(x - w/2 + skew, y - h/2);
            ctx.lineTo(x + w/2 + skew, y - h/2);
            ctx.lineTo(x + w/2 - skew, y + h/2);
            ctx.lineTo(x - w/2 - skew, y + h/2);
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#2d3436';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
        }
        
        function drawConnector(ctx, x, y, w, h, color, text) {
            ctx.beginPath();
            ctx.arc(x, y, Math.min(w, h) / 3, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#2d3436';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
        }
        
        function addDiagramArrow() {
            setTool('diagramArrow');
            showToast('â¡ï¸ æ‹–æ›³ç•«ç®­é ­é€£æ¥');
        }
        
        // ===== æ™‚é–“è»¸ =====
        function showTimelinePanel() {
            togglePanel('timelinePanel', 'timelineBtn');
        }
        
        function createTimeline() {
            saveHistory();
            
            const events = document.getElementById('timelineEvents')?.value?.split('\n') || [];
            const dates = document.getElementById('timelineDates')?.value?.split('\n') || [];
            const title = document.getElementById('timelineTitle')?.value || 'æ™‚é–“è»¸';
            const color = document.getElementById('timelineColor')?.value || '#4ecdc4';
            
            // èƒŒæ™¯
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ¨™é¡Œ
            ctx.fillStyle = '#2d3436';
            ctx.font = 'bold 28px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, canvas.width / 2, 50);
            
            // æ™‚é–“è»¸ç·š
            const lineY = canvas.height / 2;
            const startX = 80;
            const endX = canvas.width - 80;
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(startX, lineY);
            ctx.lineTo(endX, lineY);
            ctx.stroke();
            
            // äº‹ä»¶é»
            const eventCount = Math.max(events.length, 1);
            const stepX = (endX - startX) / (eventCount + 1);
            
            events.forEach((event, i) => {
                const x = startX + stepX * (i + 1);
                const isTop = i % 2 === 0;
                
                // é»
                ctx.beginPath();
                ctx.arc(x, lineY, 10, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // é€£æ¥ç·š
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x, lineY);
                ctx.lineTo(x, isTop ? lineY - 60 : lineY + 60);
                ctx.stroke();
                
                // æ—¥æœŸ
                ctx.fillStyle = color;
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(dates[i] || '', x, isTop ? lineY - 70 : lineY + 80);
                
                // äº‹ä»¶æ–‡å­—
                ctx.fillStyle = '#2d3436';
                ctx.font = '12px Arial';
                const textY = isTop ? lineY - 90 : lineY + 100;
                wrapText(ctx, event, x, textY, 100, 16);
            });
            
            showToast('ğŸ“… æ™‚é–“è»¸å·²å»ºç«‹ï¼');
        }
        
        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split('');
            let line = '';
            let testLine = '';
            
            for (let i = 0; i < words.length; i++) {
                testLine = line + words[i];
                const metrics = ctx.measureText(testLine);
                
                if (metrics.width > maxWidth && i > 0) {
                    ctx.fillText(line, x, y);
                    line = words[i];
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, y);
        }
        
        // ===== è³‡è¨Šåœ–è¡¨ =====
        function showInfographicPanel() {
            togglePanel('infographicPanel', 'infographicBtn');
        }
        
        function createInfographic(type) {
            saveHistory();
            
            const title = document.getElementById('infoTitle')?.value || 'è³‡è¨Šåœ–è¡¨';
            const stats = document.getElementById('infoStats')?.value?.split('\n') || [];
            const values = document.getElementById('infoValues')?.value?.split('\n') || [];
            
            // èƒŒæ™¯
            const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            bgGradient.addColorStop(0, '#667eea');
            bgGradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ¨™é¡Œ
            ctx.fillStyle = 'white';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(title, canvas.width / 2, 60);
            
            switch(type) {
                case 'stats':
                    drawStatsInfographic(stats, values);
                    break;
                case 'comparison':
                    drawComparisonInfographic(stats, values);
                    break;
                case 'steps':
                    drawStepsInfographic(stats);
                    break;
                case 'icons':
                    drawIconsInfographic(stats, values);
                    break;
            }
            
            showToast('ğŸ“Š è³‡è¨Šåœ–è¡¨å·²å»ºç«‹ï¼');
        }
        
        function drawStatsInfographic(stats, values) {
            const cols = Math.min(stats.length, 4);
            const colWidth = (canvas.width - 80) / cols;
            
            stats.forEach((stat, i) => {
                const x = 40 + colWidth * i + colWidth / 2;
                const y = canvas.height / 2;
                
                // æ•¸å€¼
                ctx.fillStyle = 'white';
                ctx.font = 'bold 48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(values[i] || '0', x, y);
                
                // æ¨™ç±¤
                ctx.font = '16px Arial';
                ctx.fillText(stat, x, y + 40);
            });
        }
        
        function drawComparisonInfographic(stats, values) {
            const numValues = values.map(v => parseFloat(v) || 0);
            const maxValue = Math.max(...numValues);
            
            stats.forEach((stat, i) => {
                const y = 120 + i * 80;
                const barWidth = (numValues[i] / maxValue) * (canvas.width - 200);
                
                // èƒŒæ™¯æ¢
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.fillRect(100, y, canvas.width - 200, 40);
                
                // æ•¸å€¼æ¢
                ctx.fillStyle = 'white';
                ctx.fillRect(100, y, barWidth, 40);
                
                // æ¨™ç±¤
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(stat, 100, y - 10);
                
                // æ•¸å€¼
                ctx.textAlign = 'right';
                ctx.fillText(values[i] || '', canvas.width - 100, y + 25);
            });
        }
        
        function drawStepsInfographic(stats) {
            stats.forEach((stat, i) => {
                const y = 120 + i * 100;
                
                // æ•¸å­—åœ“åœˆ
                ctx.beginPath();
                ctx.arc(60, y, 25, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                
                ctx.fillStyle = '#667eea';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(i + 1, 60, y);
                
                // é€£æ¥ç·š
                if (i < stats.length - 1) {
                    ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(60, y + 30);
                    ctx.lineTo(60, y + 70);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                
                // æ–‡å­—
                ctx.fillStyle = 'white';
                ctx.font = '18px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.fillText(stat, 100, y);
            });
        }
        
        function drawIconsInfographic(stats, values) {
            const icons = ['ğŸ“Š', 'ğŸ“ˆ', 'ğŸ’°', 'ğŸ‘¥', 'ğŸ¯', 'â­', 'ğŸ”¥', 'ğŸ’¡'];
            const cols = Math.min(stats.length, 4);
            const colWidth = (canvas.width - 80) / cols;
            
            stats.forEach((stat, i) => {
                const x = 40 + colWidth * i + colWidth / 2;
                const y = canvas.height / 2 - 40;
                
                // åœ–ç¤º
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(icons[i % icons.length], x, y);
                
                // æ•¸å€¼
                ctx.fillStyle = 'white';
                ctx.font = 'bold 32px Arial';
                ctx.fillText(values[i] || '0', x, y + 60);
                
                // æ¨™ç±¤
                ctx.font = '14px Arial';
                ctx.fillText(stat, x, y + 90);
            });
        }
        
        // ===== åç‰‡è£½ä½œ =====
        function showBusinessCardPanel() {
            togglePanel('businessCardPanel', 'businessCardBtn');
        }
        
        function createBusinessCard(style) {
            saveHistory();
            
            const name = document.getElementById('cardName')?.value || 'å§“å';
            const title = document.getElementById('cardTitle')?.value || 'è·ç¨±';
            const company = document.getElementById('cardCompany')?.value || 'å…¬å¸åç¨±';
            const phone = document.getElementById('cardPhone')?.value || '';
            const email = document.getElementById('cardEmail')?.value || '';
            const website = document.getElementById('cardWebsite')?.value || '';
            
            // åç‰‡å°ºå¯¸ (90mm x 54mm @ 300dpi)
            canvas.width = 1063;
            canvas.height = 638;
            
            const styles = {
                minimal: { bg: '#ffffff', text: '#2d3436', accent: '#667eea' },
                dark: { bg: '#1a1a2e', text: '#ffffff', accent: '#4ecdc4' },
                gradient: { bg: 'gradient', text: '#ffffff', accent: '#ffffff' },
                creative: { bg: '#f8f9fa', text: '#2d3436', accent: '#ff6b6b' }
            };
            
            const s = styles[style] || styles.minimal;
            
            // èƒŒæ™¯
            if (s.bg === 'gradient') {
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
            } else {
                ctx.fillStyle = s.bg;
            }
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // è£é£¾å…ƒç´ 
            if (style === 'creative') {
                ctx.fillStyle = s.accent;
                ctx.beginPath();
                ctx.arc(canvas.width - 100, 100, 200, 0, Math.PI * 2);
                ctx.globalAlpha = 0.1;
                ctx.fill();
                ctx.globalAlpha = 1;
            }
            
            // åå­—
            ctx.fillStyle = s.text;
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(name, 60, 150);
            
            // è·ç¨±
            ctx.fillStyle = s.accent;
            ctx.font = '24px Arial';
            ctx.fillText(title, 60, 190);
            
            // å…¬å¸
            ctx.fillStyle = s.text;
            ctx.font = '20px Arial';
            ctx.fillText(company, 60, 230);
            
            // è¯çµ¡è³‡è¨Š
            ctx.font = '16px Arial';
            let infoY = 350;
            
            if (phone) {
                ctx.fillText('ğŸ“ ' + phone, 60, infoY);
                infoY += 30;
            }
            if (email) {
                ctx.fillText('ğŸ“§ ' + email, 60, infoY);
                infoY += 30;
            }
            if (website) {
                ctx.fillText('ğŸŒ ' + website, 60, infoY);
            }
            
            // è£é£¾ç·š
            ctx.strokeStyle = s.accent;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(60, 260);
            ctx.lineTo(200, 260);
            ctx.stroke();
            
            showToast('ğŸªª åç‰‡å·²å»ºç«‹ï¼');
        }
        
        // ===== ç™¼ç¥¨/æ”¶æ“šè£½ä½œ =====
        function showInvoicePanel() {
            togglePanel('invoicePanel', 'invoiceBtn');
        }
        
        function createInvoice() {
            saveHistory();
            
            const companyName = document.getElementById('invoiceCompany')?.value || 'å…¬å¸åç¨±';
            const invoiceNo = document.getElementById('invoiceNo')?.value || 'INV-001';
            const date = document.getElementById('invoiceDate')?.value || new Date().toLocaleDateString();
            const items = document.getElementById('invoiceItems')?.value?.split('\n') || [];
            const prices = document.getElementById('invoicePrices')?.value?.split('\n') || [];
            
            canvas.width = 800;
            canvas.height = 600;
            
            // èƒŒæ™¯
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // é ­éƒ¨
            ctx.fillStyle = '#667eea';
            ctx.fillRect(0, 0, canvas.width, 100);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 36px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(companyName, 30, 60);
            
            // ç™¼ç¥¨è³‡è¨Š
            ctx.fillStyle = '#2d3436';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('ç™¼ç¥¨', canvas.width - 30, 150);
            
            ctx.font = '14px Arial';
            ctx.fillText(`ç™¼ç¥¨ç·¨è™Ÿ: ${invoiceNo}`, canvas.width - 30, 180);
            ctx.fillText(`æ—¥æœŸ: ${date}`, canvas.width - 30, 200);
            
            // è¡¨æ ¼æ¨™é ­
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(30, 250, canvas.width - 60, 40);
            
            ctx.fillStyle = '#2d3436';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('é …ç›®', 50, 275);
            ctx.textAlign = 'right';
            ctx.fillText('é‡‘é¡', canvas.width - 50, 275);
            
            // é …ç›®åˆ—è¡¨
            ctx.font = '14px Arial';
            let total = 0;
            items.forEach((item, i) => {
                const y = 310 + i * 35;
                const price = parseFloat(prices[i]) || 0;
                total += price;
                
                ctx.textAlign = 'left';
                ctx.fillText(item, 50, y);
                ctx.textAlign = 'right';
                ctx.fillText('$' + price.toFixed(2), canvas.width - 50, y);
                
                // åˆ†éš”ç·š
                ctx.strokeStyle = '#ecf0f1';
                ctx.beginPath();
                ctx.moveTo(30, y + 15);
                ctx.lineTo(canvas.width - 30, y + 15);
                ctx.stroke();
            });
            
            // ç¸½è¨ˆ
            const totalY = 320 + items.length * 35 + 30;
            ctx.fillStyle = '#667eea';
            ctx.fillRect(canvas.width - 250, totalY - 25, 220, 40);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('ç¸½è¨ˆ:', canvas.width - 240, totalY);
            ctx.textAlign = 'right';
            ctx.fillText('$' + total.toFixed(2), canvas.width - 50, totalY);
            
            showToast('ğŸ§¾ ç™¼ç¥¨å·²å»ºç«‹ï¼');
        }
        
        // ===== è­‰æ›¸è£½ä½œ =====
        function showCertificatePanel() {
            togglePanel('certificatePanel', 'certificateBtn');
        }
        
        function createCertificate(style) {
            saveHistory();
            
            const recipient = document.getElementById('certRecipient')?.value || 'å—çäºº';
            const achievement = document.getElementById('certAchievement')?.value || 'å„ªç•°è¡¨ç¾';
            const issuer = document.getElementById('certIssuer')?.value || 'é ’ç™¼å–®ä½';
            const date = document.getElementById('certDate')?.value || new Date().toLocaleDateString();
            
            canvas.width = 1200;
            canvas.height = 850;
            
            // èƒŒæ™¯
            ctx.fillStyle = '#fffef7';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // è£é£¾é‚Šæ¡†
            ctx.strokeStyle = '#d4af37';
            ctx.lineWidth = 15;
            ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);
            
            ctx.lineWidth = 3;
            ctx.strokeRect(60, 60, canvas.width - 120, canvas.height - 120);
            
            // è§’è½è£é£¾
            const corners = [[80, 80], [canvas.width - 80, 80], [80, canvas.height - 80], [canvas.width - 80, canvas.height - 80]];
            corners.forEach(([x, y]) => {
                ctx.beginPath();
                ctx.arc(x, y, 20, 0, Math.PI * 2);
                ctx.fillStyle = '#d4af37';
                ctx.fill();
            });
            
            // æ¨™é¡Œ
            ctx.fillStyle = '#1a1a2e';
            ctx.font = 'bold 60px "Times New Roman", serif';
            ctx.textAlign = 'center';
            ctx.fillText('æ¦®è­½è­‰æ›¸', canvas.width / 2, 180);
            
            // è£é£¾ç·š
            ctx.strokeStyle = '#d4af37';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 150, 210);
            ctx.lineTo(canvas.width / 2 + 150, 210);
            ctx.stroke();
            
            // å…§å®¹
            ctx.fillStyle = '#333';
            ctx.font = '24px "Times New Roman", serif';
            ctx.fillText('èŒ²è­‰æ˜', canvas.width / 2, 300);
            
            ctx.fillStyle = '#1a1a2e';
            ctx.font = 'bold 48px "Times New Roman", serif';
            ctx.fillText(recipient, canvas.width / 2, 380);
            
            ctx.fillStyle = '#333';
            ctx.font = '24px "Times New Roman", serif';
            ctx.fillText('å› ', canvas.width / 2, 450);
            
            ctx.fillStyle = '#d4af37';
            ctx.font = 'bold 36px "Times New Roman", serif';
            ctx.fillText(achievement, canvas.width / 2, 510);
            
            ctx.fillStyle = '#333';
            ctx.font = '24px "Times New Roman", serif';
            ctx.fillText('ç‰¹é ’æ­¤è­‰ï¼Œä»¥è³‡é¼“å‹µ', canvas.width / 2, 580);
            
            // ç°½åå€
            ctx.fillStyle = '#666';
            ctx.font = '18px Arial';
            ctx.fillText(issuer, canvas.width / 2 - 200, 720);
            ctx.fillText(date, canvas.width / 2 + 200, 720);
            
            // ç°½åç·š
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 300, 700);
            ctx.lineTo(canvas.width / 2 - 100, 700);
            ctx.moveTo(canvas.width / 2 + 100, 700);
            ctx.lineTo(canvas.width / 2 + 300, 700);
            ctx.stroke();
            
            showToast('ğŸ† è­‰æ›¸å·²å»ºç«‹ï¼');
        }
        
        // ===== å¾½ç« è£½ä½œ =====
        function showBadgePanel() {
            togglePanel('badgePanel', 'badgeBtn');
        }
        
        function createBadge(style) {
            saveHistory();
            
            const text = document.getElementById('badgeText')?.value || 'BADGE';
            const subtext = document.getElementById('badgeSubtext')?.value || '';
            const color1 = document.getElementById('badgeColor1')?.value || '#667eea';
            const color2 = document.getElementById('badgeColor2')?.value || '#764ba2';
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.35;
            
            switch(style) {
                case 'circle':
                    drawCircleBadge(centerX, centerY, radius, color1, color2, text, subtext);
                    break;
                case 'shield':
                    drawShieldBadge(centerX, centerY, radius, color1, color2, text, subtext);
                    break;
                case 'ribbon':
                    drawRibbonBadge(centerX, centerY, radius, color1, color2, text, subtext);
                    break;
                case 'star':
                    drawStarBadge(centerX, centerY, radius, color1, color2, text, subtext);
                    break;
                case 'hexagon':
                    drawHexagonBadge(centerX, centerY, radius, color1, color2, text, subtext);
                    break;
            }
            
            showToast('ğŸ… å¾½ç« å·²å»ºç«‹ï¼');
        }
        
        function drawCircleBadge(cx, cy, r, color1, color2, text, subtext) {
            // å¤–åœˆ
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            const gradient = ctx.createLinearGradient(cx - r, cy - r, cx + r, cy + r);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // å…§åœˆ
            ctx.beginPath();
            ctx.arc(cx, cy, r * 0.85, 0, Math.PI * 2);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            // æ–‡å­—
            ctx.fillStyle = 'white';
            ctx.font = `bold ${r * 0.4}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, cx, cy);
            
            if (subtext) {
                ctx.font = `${r * 0.15}px Arial`;
                ctx.fillText(subtext, cx, cy + r * 0.3);
            }
        }
        
        function drawShieldBadge(cx, cy, r, color1, color2, text, subtext) {
            ctx.beginPath();
            ctx.moveTo(cx, cy - r);
            ctx.lineTo(cx + r * 0.8, cy - r * 0.5);
            ctx.lineTo(cx + r * 0.8, cy + r * 0.3);
            ctx.quadraticCurveTo(cx + r * 0.4, cy + r, cx, cy + r);
            ctx.quadraticCurveTo(cx - r * 0.4, cy + r, cx - r * 0.8, cy + r * 0.3);
            ctx.lineTo(cx - r * 0.8, cy - r * 0.5);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(cx, cy - r, cx, cy + r);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            ctx.fillStyle = gradient;
            ctx.fill();
            
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = `bold ${r * 0.35}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, cx, cy);
            
            if (subtext) {
                ctx.font = `${r * 0.12}px Arial`;
                ctx.fillText(subtext, cx, cy + r * 0.35);
            }
        }
        
        function drawRibbonBadge(cx, cy, r, color1, color2, text, subtext) {
            // åœ“å½¢
            drawCircleBadge(cx, cy, r * 0.8, color1, color2, text, '');
            
            // ç·å¸¶
            ctx.fillStyle = color2;
            ctx.beginPath();
            ctx.moveTo(cx - r * 0.5, cy + r * 0.5);
            ctx.lineTo(cx - r * 0.8, cy + r * 1.2);
            ctx.lineTo(cx - r * 0.5, cy + r);
            ctx.lineTo(cx - r * 0.2, cy + r * 1.2);
            ctx.lineTo(cx, cy + r * 0.6);
            ctx.closePath();
            ctx.fill();
            
            ctx.beginPath();
            ctx.moveTo(cx + r * 0.5, cy + r * 0.5);
            ctx.lineTo(cx + r * 0.8, cy + r * 1.2);
            ctx.lineTo(cx + r * 0.5, cy + r);
            ctx.lineTo(cx + r * 0.2, cy + r * 1.2);
            ctx.lineTo(cx, cy + r * 0.6);
            ctx.closePath();
            ctx.fill();
        }
        
        function drawStarBadge(cx, cy, r, color1, color2, text, subtext) {
            const spikes = 5;
            const outerRadius = r;
            const innerRadius = r * 0.5;
            
            ctx.beginPath();
            let rot = Math.PI / 2 * 3;
            let step = Math.PI / spikes;
            
            ctx.moveTo(cx, cy - outerRadius);
            for (let i = 0; i < spikes; i++) {
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius);
                rot += step;
                ctx.lineTo(cx + Math.cos(rot) * innerRadius, cy + Math.sin(rot) * innerRadius);
                rot += step;
            }
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(cx, cy - r, cx, cy + r);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            ctx.fillStyle = gradient;
            ctx.fill();
            
            ctx.fillStyle = 'white';
            ctx.font = `bold ${r * 0.3}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, cx, cy);
        }
        
        function drawHexagonBadge(cx, cy, r, color1, color2, text, subtext) {
            ctx.beginPath();
            for (let i = 0; i < 6; i++) {
                const angle = (Math.PI / 3) * i - Math.PI / 2;
                const x = cx + r * Math.cos(angle);
                const y = cy + r * Math.sin(angle);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(cx, cy - r, cx, cy + r);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            ctx.fillStyle = gradient;
            ctx.fill();
            
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            ctx.fillStyle = 'white';
            ctx.font = `bold ${r * 0.35}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, cx, cy);
            
            if (subtext) {
                ctx.font = `${r * 0.12}px Arial`;
                ctx.fillText(subtext, cx, cy + r * 0.3);
            }
        }
        
        // ===== å¤§é ­è²¼è£½ä½œ =====
        function showAvatarPanel() {
            togglePanel('avatarPanel', 'avatarBtn');
        }
        
        function createAvatar(shape) {
            saveHistory();
            
            const bgColor = document.getElementById('avatarBgColor')?.value || '#667eea';
            const borderWidth = parseInt(document.getElementById('avatarBorder')?.value || 5);
            const borderColor = document.getElementById('avatarBorderColor')?.value || '#ffffff';
            
            const size = Math.min(canvas.width, canvas.height);
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = size;
            tempCanvas.height = size;
            const tempCtx = tempCanvas.getContext('2d');
            
            // èƒŒæ™¯
            tempCtx.fillStyle = bgColor;
            tempCtx.fillRect(0, 0, size, size);
            
            // è£åˆ‡å½¢ç‹€
            tempCtx.globalCompositeOperation = 'destination-in';
            
            switch(shape) {
                case 'circle':
                    tempCtx.beginPath();
                    tempCtx.arc(size/2, size/2, size/2 - borderWidth, 0, Math.PI * 2);
                    tempCtx.fill();
                    break;
                case 'rounded':
                    tempCtx.beginPath();
                    tempCtx.roundRect(borderWidth, borderWidth, size - borderWidth*2, size - borderWidth*2, 30);
                    tempCtx.fill();
                    break;
                case 'hexagon':
                    tempCtx.beginPath();
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI / 3) * i - Math.PI / 2;
                        const x = size/2 + (size/2 - borderWidth) * Math.cos(angle);
                        const y = size/2 + (size/2 - borderWidth) * Math.sin(angle);
                        if (i === 0) tempCtx.moveTo(x, y);
                        else tempCtx.lineTo(x, y);
                    }
                    tempCtx.closePath();
                    tempCtx.fill();
                    break;
            }
            
            tempCtx.globalCompositeOperation = 'destination-over';
            
            // ç¸®æ”¾åŸåœ–
            const scale = Math.max(size / canvas.width, size / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const x = (size - newW) / 2;
            const y = (size - newH) / 2;
            tempCtx.drawImage(canvas, x, y, newW, newH);
            
            // é‚Šæ¡†
            tempCtx.globalCompositeOperation = 'source-over';
            tempCtx.strokeStyle = borderColor;
            tempCtx.lineWidth = borderWidth;
            
            switch(shape) {
                case 'circle':
                    tempCtx.beginPath();
                    tempCtx.arc(size/2, size/2, size/2 - borderWidth/2, 0, Math.PI * 2);
                    tempCtx.stroke();
                    break;
                case 'rounded':
                    tempCtx.beginPath();
                    tempCtx.roundRect(borderWidth/2, borderWidth/2, size - borderWidth, size - borderWidth, 30);
                    tempCtx.stroke();
                    break;
                case 'hexagon':
                    tempCtx.beginPath();
                    for (let i = 0; i < 6; i++) {
                        const angle = (Math.PI / 3) * i - Math.PI / 2;
                        const xx = size/2 + (size/2 - borderWidth/2) * Math.cos(angle);
                        const yy = size/2 + (size/2 - borderWidth/2) * Math.sin(angle);
                        if (i === 0) tempCtx.moveTo(xx, yy);
                        else tempCtx.lineTo(xx, yy);
                    }
                    tempCtx.closePath();
                    tempCtx.stroke();
                    break;
            }
            
            canvas.width = size;
            canvas.height = size;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('ğŸ­ å¤§é ­è²¼å·²å»ºç«‹ï¼');
        }
        
        // ===== ç¸®åœ–è£½ä½œ =====
        function showThumbnailPanel() {
            togglePanel('thumbnailPanel', 'thumbnailBtn');
        }
        
        function createThumbnail(platform) {
            saveHistory();
            
            const title = document.getElementById('thumbTitle')?.value || 'æ¨™é¡Œ';
            const subtitle = document.getElementById('thumbSubtitle')?.value || '';
            
            const sizes = {
                youtube: { w: 1280, h: 720 },
                twitch: { w: 1920, h: 1080 },
                facebook: { w: 1200, h: 628 },
                instagram: { w: 1080, h: 1080 }
            };
            
            const size = sizes[platform] || sizes.youtube;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = size.w;
            tempCanvas.height = size.h;
            const tempCtx = tempCanvas.getContext('2d');
            
            // ç¸®æ”¾åŸåœ–ä½œç‚ºèƒŒæ™¯
            const scale = Math.max(size.w / canvas.width, size.h / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const x = (size.w - newW) / 2;
            const y = (size.h - newH) / 2;
            tempCtx.drawImage(canvas, x, y, newW, newH);
            
            // æ¼¸å±¤é®ç½©
            const gradient = tempCtx.createLinearGradient(0, size.h * 0.5, 0, size.h);
            gradient.addColorStop(0, 'rgba(0,0,0,0)');
            gradient.addColorStop(1, 'rgba(0,0,0,0.8)');
            tempCtx.fillStyle = gradient;
            tempCtx.fillRect(0, 0, size.w, size.h);
            
            // æ¨™é¡Œ
            const fontSize = size.w * 0.06;
            tempCtx.fillStyle = 'white';
            tempCtx.font = `bold ${fontSize}px Arial`;
            tempCtx.textAlign = 'center';
            tempCtx.textBaseline = 'bottom';
            
            // æ–‡å­—é™°å½±
            tempCtx.shadowColor = 'rgba(0,0,0,0.8)';
            tempCtx.shadowBlur = 10;
            tempCtx.shadowOffsetX = 3;
            tempCtx.shadowOffsetY = 3;
            
            tempCtx.fillText(title, size.w / 2, size.h - 60);
            
            if (subtitle) {
                tempCtx.font = `${fontSize * 0.5}px Arial`;
                tempCtx.fillText(subtitle, size.w / 2, size.h - 20);
            }
            
            canvas.width = size.w;
            canvas.height = size.h;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('ğŸ–¼ï¸ ç¸®åœ–å·²å»ºç«‹ï¼');
        }
        
        // ===== å°é¢è£½ä½œ =====
        function showCoverPanel() {
            togglePanel('coverPanel', 'coverBtn');
        }
        
        function createCover(type) {
            saveHistory();
            
            const title = document.getElementById('coverTitle')?.value || 'æ¨™é¡Œ';
            const author = document.getElementById('coverAuthor')?.value || 'ä½œè€…';
            
            const sizes = {
                book: { w: 1600, h: 2400 },
                album: { w: 1400, h: 1400 },
                magazine: { w: 1200, h: 1600 },
                ebook: { w: 1600, h: 2560 }
            };
            
            const size = sizes[type] || sizes.book;
            
            canvas.width = size.w;
            canvas.height = size.h;
            
            // æ¼¸å±¤èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, size.w, size.h);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(1, '#16213e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, size.w, size.h);
            
            // è£é£¾å…ƒç´ 
            ctx.fillStyle = 'rgba(255,255,255,0.05)';
            ctx.beginPath();
            ctx.arc(size.w * 0.8, size.h * 0.2, size.w * 0.4, 0, Math.PI * 2);
            ctx.fill();
            
            // æ¨™é¡Œ
            const titleSize = size.w * 0.08;
            ctx.fillStyle = 'white';
            ctx.font = `bold ${titleSize}px "Times New Roman", serif`;
            ctx.textAlign = 'center';
            ctx.fillText(title, size.w / 2, size.h * 0.45);
            
            // ä½œè€…
            ctx.fillStyle = '#d4af37';
            ctx.font = `${titleSize * 0.4}px Arial`;
            ctx.fillText(author, size.w / 2, size.h * 0.55);
            
            // è£é£¾ç·š
            ctx.strokeStyle = '#d4af37';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(size.w * 0.3, size.h * 0.48);
            ctx.lineTo(size.w * 0.7, size.h * 0.48);
            ctx.stroke();
            
            showToast('ğŸ“š å°é¢å·²å»ºç«‹ï¼');
        }
        
        // ===== ç”¢å“ Mockup =====
        function showMockupPanel() {
            togglePanel('mockupPanel', 'mockupBtn');
        }
        
        function createMockup(device) {
            saveHistory();
            
            const mockups = {
                iphone: { w: 400, h: 800, screenX: 30, screenY: 80, screenW: 340, screenH: 640, radius: 40 },
                macbook: { w: 1200, h: 750, screenX: 140, screenY: 40, screenW: 920, screenH: 575, radius: 10 },
                ipad: { w: 600, h: 800, screenX: 40, screenY: 60, screenW: 520, screenH: 680, radius: 20 },
                monitor: { w: 1000, h: 700, screenX: 50, screenY: 40, screenW: 900, screenH: 520, radius: 10 }
            };
            
            const m = mockups[device] || mockups.iphone;
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = m.w + 100;
            tempCanvas.height = m.h + 150;
            const tempCtx = tempCanvas.getContext('2d');
            
            // èƒŒæ™¯æ¼¸å±¤
            const bgGradient = tempCtx.createLinearGradient(0, 0, tempCanvas.width, tempCanvas.height);
            bgGradient.addColorStop(0, '#667eea');
            bgGradient.addColorStop(1, '#764ba2');
            tempCtx.fillStyle = bgGradient;
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            const offsetX = 50;
            const offsetY = 50;
            
            // è£ç½®é™°å½±
            tempCtx.shadowColor = 'rgba(0,0,0,0.3)';
            tempCtx.shadowBlur = 30;
            tempCtx.shadowOffsetY = 20;
            
            // è£ç½®å¤–æ¡†
            tempCtx.fillStyle = '#1a1a1a';
            tempCtx.beginPath();
            tempCtx.roundRect(offsetX, offsetY, m.w, m.h, m.radius);
            tempCtx.fill();
            
            tempCtx.shadowColor = 'transparent';
            
            // è¢å¹•å€åŸŸ
            tempCtx.save();
            tempCtx.beginPath();
            tempCtx.roundRect(offsetX + m.screenX, offsetY + m.screenY, m.screenW, m.screenH, m.radius / 2);
            tempCtx.clip();
            
            // ç¸®æ”¾åŸåœ–å¡«å…¥è¢å¹•
            const scale = Math.max(m.screenW / canvas.width, m.screenH / canvas.height);
            const newW = canvas.width * scale;
            const newH = canvas.height * scale;
            const imgX = offsetX + m.screenX + (m.screenW - newW) / 2;
            const imgY = offsetY + m.screenY + (m.screenH - newH) / 2;
            tempCtx.drawImage(canvas, imgX, imgY, newW, newH);
            tempCtx.restore();
            
            // iPhone ç‰¹æœ‰å…ƒç´ 
            if (device === 'iphone') {
                // ç€æµ·
                tempCtx.fillStyle = '#1a1a1a';
                tempCtx.beginPath();
                tempCtx.roundRect(offsetX + m.w/2 - 60, offsetY + 10, 120, 30, 15);
                tempCtx.fill();
                
                // Home æŒ‡ç¤ºæ¢
                tempCtx.fillStyle = '#666';
                tempCtx.beginPath();
                tempCtx.roundRect(offsetX + m.w/2 - 50, offsetY + m.h - 30, 100, 5, 3);
                tempCtx.fill();
            }
            
            // MacBook ç‰¹æœ‰å…ƒç´ 
            if (device === 'macbook') {
                // åº•åº§
                tempCtx.fillStyle = '#2a2a2a';
                tempCtx.beginPath();
                tempCtx.moveTo(offsetX - 20, offsetY + m.h);
                tempCtx.lineTo(offsetX + m.w + 20, offsetY + m.h);
                tempCtx.lineTo(offsetX + m.w + 40, offsetY + m.h + 20);
                tempCtx.lineTo(offsetX - 40, offsetY + m.h + 20);
                tempCtx.closePath();
                tempCtx.fill();
            }
            
            canvas.width = tempCanvas.width;
            canvas.height = tempCanvas.height;
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast('ğŸ“± Mockup å·²å»ºç«‹ï¼');
        }
        
        // ===== è‰²å½©åˆ†æ =====
        function showColorPalettePanel() {
            togglePanel('colorPalettePanel', 'colorPaletteBtn');
            analyzeColors();
        }
        
        function analyzeColors() {
            if (!currentImage && canvas.width === 300) {
                showToast('âš ï¸ è«‹å…ˆè¼‰å…¥åœ–ç‰‡');
                return;
            }
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const colorCounts = {};
            
            // å–æ¨£åˆ†æ
            const sampleStep = 10;
            for (let i = 0; i < data.length; i += 4 * sampleStep) {
                const r = Math.round(data[i] / 32) * 32;
                const g = Math.round(data[i+1] / 32) * 32;
                const b = Math.round(data[i+2] / 32) * 32;
                const key = `${r},${g},${b}`;
                colorCounts[key] = (colorCounts[key] || 0) + 1;
            }
            
            // æ’åºå–å‰ 8 å€‹ä¸»è¦é¡è‰²
            const sortedColors = Object.entries(colorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8)
                .map(([key]) => {
                    const [r, g, b] = key.split(',').map(Number);
                    const hex = `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
                    return { rgb: `rgb(${r},${g},${b})`, hex: hex };
                });
            
            // é¡¯ç¤ºè‰²å½©
            const container = document.getElementById('colorPaletteDisplay');
            if (container) {
                container.innerHTML = sortedColors.map(c => `
                    <div onclick="copyColorToClipboard('${c.hex}')" title="${c.hex}" style="
                        width:50px;height:50px;background:${c.rgb};border-radius:8px;cursor:pointer;
                        border:3px solid rgba(255,255,255,0.3);box-shadow:0 2px 8px rgba(0,0,0,0.3);
                        transition:transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"></div>
                `).join('');
            }
            
            showToast('ğŸ¨ å·²åˆ†æ ' + sortedColors.length + ' å€‹ä¸»è¦é¡è‰²');
        }
        
        function copyColorToClipboard(color) {
            navigator.clipboard.writeText(color).then(() => {
                showToast('ğŸ“‹ é¡è‰²å·²è¤‡è£½: ' + color);
            });
        }
        
        function extractPalette() {
            analyzeColors();
        }
        
        // ===== AI å¢å¼· =====
        function showAiEnhancePanel() {
            togglePanel('aiEnhancePanel', 'aiEnhanceBtn');
        }
        
        async function aiEnhance(type) {
            if (!settings.geminiApiKey) {
                showToast('âš ï¸ è«‹å…ˆè¨­å®š Gemini API Key');
                showPage('settings');
                return;
            }
            
            showToast('ğŸ¤– AI è™•ç†ä¸­...');
            
            try {
                // ç°¡å–®çš„æœ¬åœ°å¢å¼·ï¼ˆæ¨¡æ“¬ AI æ•ˆæœï¼‰
                saveHistory();
                
                switch(type) {
                    case 'enhance':
                        // è‡ªå‹•å¢å¼·
                        ctx.filter = 'contrast(1.1) saturate(1.1) brightness(1.05)';
                        ctx.drawImage(canvas, 0, 0);
                        ctx.filter = 'none';
                        break;
                    case 'denoise':
                        // å»å™ªï¼ˆè¼•å¾®æ¨¡ç³Šï¼‰
                        ctx.filter = 'blur(0.5px)';
                        ctx.drawImage(canvas, 0, 0);
                        ctx.filter = 'none';
                        break;
                    case 'sharpen':
                        // éŠ³åŒ–
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        applyConvolution(imageData, [0, -1, 0, -1, 5, -1, 0, -1, 0]);
                        ctx.putImageData(imageData, 0, 0);
                        break;
                    case 'upscale':
                        // æ”¾å¤§ï¼ˆç°¡å–®æ’å€¼ï¼‰
                        const scale = 2;
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = canvas.width * scale;
                        tempCanvas.height = canvas.height * scale;
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.imageSmoothingEnabled = true;
                        tempCtx.imageSmoothingQuality = 'high';
                        tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
                        canvas.width = tempCanvas.width;
                        canvas.height = tempCanvas.height;
                        ctx.drawImage(tempCanvas, 0, 0);
                        break;
                    case 'restore':
                        // ä¿®å¾©ï¼ˆæé«˜å°æ¯”å’Œæ¸…æ™°åº¦ï¼‰
                        ctx.filter = 'contrast(1.2) brightness(1.1)';
                        ctx.drawImage(canvas, 0, 0);
                        ctx.filter = 'none';
                        break;
                }
                
                showToast('âœ¨ AI å¢å¼·å®Œæˆï¼');
            } catch(e) {
                showToast('âŒ è™•ç†å¤±æ•—: ' + e.message);
            }
        }
        
        // ===== AI é¢¨æ ¼è½‰æ› =====
        function showAiStylePanel() {
            togglePanel('aiStylePanel', 'aiStyleBtn');
        }
        
        function aiStyleTransfer(style) {
            saveHistory();
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            switch(style) {
                case 'anime':
                    // å‹•æ¼«é¢¨æ ¼ï¼ˆç°¡åŒ–è‰²å½© + é‚Šç·£ï¼‰
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.floor(data[i] / 32) * 32;
                        data[i+1] = Math.floor(data[i+1] / 32) * 32;
                        data[i+2] = Math.floor(data[i+2] / 32) * 32;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    ctx.filter = 'contrast(1.3) saturate(1.2)';
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                    break;
                case 'watercolor':
                    // æ°´å½©é¢¨æ ¼
                    ctx.filter = 'blur(2px) saturate(1.5)';
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                    break;
                case 'pencil':
                    // é‰›ç­†ç´ æ
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
                        data[i] = data[i+1] = data[i+2] = avg;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    applyConvolution(ctx.getImageData(0, 0, canvas.width, canvas.height), [-1, -1, -1, -1, 8, -1, -1, -1, -1]);
                    break;
                case 'impressionist':
                    // å°è±¡æ´¾
                    ctx.filter = 'blur(1px) saturate(1.8) contrast(1.1)';
                    ctx.drawImage(canvas, 0, 0);
                    ctx.filter = 'none';
                    break;
                case 'pop_art':
                    // æ™®æ™®è—è¡“
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = data[i] > 128 ? 255 : 0;
                        data[i+1] = data[i+1] > 128 ? 255 : 0;
                        data[i+2] = data[i+2] > 128 ? 255 : 0;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    break;
                case 'cyberpunk':
                    // è³½åšé¾å…‹
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * 0.8 + 50);
                        data[i+1] = data[i+1] * 0.9;
                        data[i+2] = Math.min(255, data[i+2] * 1.2 + 30);
                    }
                    ctx.putImageData(imageData, 0, 0);
                    break;
            }
            
            showToast('ğŸ¨ é¢¨æ ¼è½‰æ›å®Œæˆï¼');
        }
        
        // ===== å°ˆæ¥­èª¿æ•´é¢æ¿ =====
        function showLevelsPanel() {
            togglePanel('levelsPanel', 'levelsBtn');
        }
        
        function applyLevels() {
            saveHistory();
            
            const inputBlack = parseInt(document.getElementById('levelsInputBlack')?.value || 0);
            const inputWhite = parseInt(document.getElementById('levelsInputWhite')?.value || 255);
            const gamma = parseFloat(document.getElementById('levelsGamma')?.value || 1);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                for (let c = 0; c < 3; c++) {
                    let value = data[i + c];
                    // è¼¸å…¥ç¯„åœèª¿æ•´
                    value = (value - inputBlack) / (inputWhite - inputBlack) * 255;
                    // Gamma æ ¡æ­£
                    value = Math.pow(value / 255, 1 / gamma) * 255;
                    data[i + c] = Math.min(255, Math.max(0, value));
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸ“Š è‰²éšå·²èª¿æ•´');
        }
        
        function showCurvesPanel() {
            togglePanel('curvesPanel', 'curvesBtn');
        }
        
        function showHslPanel() {
            togglePanel('hslPanel', 'hslBtn');
        }
        
        function applyHsl() {
            saveHistory();
            
            const hue = parseInt(document.getElementById('hslHue')?.value || 0);
            const saturation = parseInt(document.getElementById('hslSaturation')?.value || 0);
            const lightness = parseInt(document.getElementById('hslLightness')?.value || 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                let [h, s, l] = rgbToHsl(data[i], data[i+1], data[i+2]);
                
                h = (h + hue / 360) % 1;
                s = Math.min(1, Math.max(0, s + saturation / 100));
                l = Math.min(1, Math.max(0, l + lightness / 100));
                
                const [r, g, b] = hslToRgb(h, s, l);
                data[i] = r;
                data[i+1] = g;
                data[i+2] = b;
            }
            
            ctx.putImageData(imageData, 0, 0);
            showToast('ğŸŒˆ HSL å·²èª¿æ•´');
        }
        
        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            return [h, s, l];
        }
        
        function hslToRgb(h, s, l) {
            let r, g, b;
            
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }
        
        // ===== æ¸¬é‡å·¥å…· =====
        let measureStart = null;
        
        function handleMeasure(start, end) {
            const dx = end.x - start.x;
            const dy = end.y - start.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            // ç•«æ¸¬é‡ç·š
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(start.x, start.y);
            ctx.lineTo(end.x, end.y);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // é¡¯ç¤ºæ•¸å€¼
            const midX = (start.x + end.x) / 2;
            const midY = (start.y + end.y) / 2;
            ctx.fillStyle = 'white';
            ctx.fillRect(midX - 50, midY - 20, 100, 40);
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`${Math.round(distance)} px`, midX, midY - 5);
            ctx.fillText(`${Math.round(angle)}Â°`, midX, midY + 12);
            
            showToast(`ğŸ“ è·é›¢: ${Math.round(distance)}px, è§’åº¦: ${Math.round(angle)}Â°`);
        }
        
        // ===== ç•«å¸ƒäº‹ä»¶ =====
        function initCanvasEvents() {
            const container = document.getElementById('canvasContainer');
            
            canvas.addEventListener('mousedown', startSelection);
            canvas.addEventListener('mousemove', updateSelection);
            canvas.addEventListener('mouseup', endSelection);
            
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd);
            
            canvas.addEventListener('click', handleCanvasClick);
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            startSelection({ clientX: touch.clientX, clientY: touch.clientY, target: canvas });
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            updateSelection({ clientX: touch.clientX, clientY: touch.clientY });
        }
        
        function handleTouchEnd(e) {
            e.preventDefault();
            const touch = e.changedTouches[0];
            endSelection({ clientX: touch.clientX, clientY: touch.clientY });
        }
        
        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: Math.round((e.clientX - rect.left) * (canvas.width / rect.width)),
                y: Math.round((e.clientY - rect.top) * (canvas.height / rect.height))
            };
        }
        
        function setTool(tool) {
            // å·¥å…·åç¨±å°ç…§è¡¨
            const toolNames = {
                'select': 'âœ‚ï¸ é¸å–',
                'mosaic': 'ğŸ”² é¦¬è³½å…‹',
                'arrow': 'â¡ï¸ ç®­é ­',
                'brush': 'ğŸ–Œï¸ ç•«ç­†',
                'shape': 'â­• å½¢ç‹€',
                'eyedropperAdv': 'ğŸ’‰ å–è‰²å™¨',
                'lasso': 'ğŸ”— å¥—ç´¢',
                'magicWand': 'ğŸª„ é­”è¡“æ£’',
                'penTool': 'ğŸ–Šï¸ é‹¼ç­†'
            };
            
            // æ‰€æœ‰å·¥å…·æŒ‰éˆ• ID
            const toolBtnIds = [
                'selectBtn', 'selectBtn2', 'mosaicBtn', 'arrowBtn', 'brushBtn',
                'shapeBtn', 'eyeDropperAdvBtn', 'lassoBtn', 'magicWandBtn', 'penToolBtn'
            ];
            
            // Toggle åˆ‡æ›ï¼šå†é»ä¸€æ¬¡å–æ¶ˆ
            if (currentTool === tool) {
                cancelCurrentTool();
                return;
            }
            
            currentTool = tool;
            
            // æ›´æ–°æ‰€æœ‰å·¥å…·æŒ‰éˆ•ç‹€æ…‹
            toolBtnIds.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    const isActive = (id === 'selectBtn' || id === 'selectBtn2') ? tool === 'select' :
                                    id === 'mosaicBtn' ? tool === 'mosaic' :
                                    id === 'arrowBtn' ? tool === 'arrow' :
                                    id === 'brushBtn' ? tool === 'brush' :
                                    id === 'shapeBtn' ? tool === 'shape' :
                                    id === 'eyeDropperAdvBtn' ? tool === 'eyedropperAdv' :
                                    id === 'lassoBtn' ? tool === 'lasso' :
                                    id === 'magicWandBtn' ? tool === 'magicWand' :
                                    id === 'penToolBtn' ? tool === 'penTool' : false;
                    btn.classList.toggle('active', isActive);
                }
            });
            
            // æ›´æ–°æ¸¸æ¨™
            const cursorTools = ['select', 'mosaic', 'arrow', 'brush', 'shape', 'eyedropperAdv', 'lasso', 'magicWand', 'penTool'];
            canvas.style.cursor = cursorTools.includes(tool) ? 'crosshair' : 'default';
            
            // æ›´æ–°å·¥å…·ç‹€æ…‹æŒ‡ç¤ºå™¨
            const toolStatus = document.getElementById('toolStatus');
            const toolStatusName = document.getElementById('toolStatusName');
            if (toolStatus && toolStatusName) {
                toolStatus.style.display = 'flex';
                toolStatusName.textContent = toolNames[tool] || tool;
            }
            
            // é¡¯ç¤ºæç¤ºï¼ˆå« ESC å–æ¶ˆæç¤ºï¼‰
            const tips = {
                'select': 'âœ‚ï¸ æ‹–æ›³é¸å–å€åŸŸ',
                'mosaic': 'ğŸ”² æ‹–æ›³æ‰“é¦¬è³½å…‹',
                'arrow': 'â¡ï¸ æ‹–æ›³ç•«ç®­é ­',
                'brush': 'ğŸ–Œï¸ åœ¨ç•«å¸ƒä¸Šç¹ªè£½',
                'shape': 'â­• æ‹–æ›³ç¹ªè£½å½¢ç‹€',
                'eyedropperAdv': 'ğŸ’‰ é»æ“Šç•«å¸ƒå–è‰²',
                'lasso': 'ğŸ”— æ‹–æ›³ç¹ªè£½é¸å–å€åŸŸ',
                'magicWand': 'ğŸª„ é»æ“Šé¸å–ç›¸ä¼¼é¡è‰²å€åŸŸ',
                'penTool': 'ğŸ–Šï¸ é»æ“Šæ·»åŠ éŒ¨é»ï¼Œé›™æ“Šå®Œæˆ'
            };
            if (tips[tool]) {
                showToast(tips[tool] + ' | å†é»ä¸€æ¬¡æˆ–æŒ‰ ESC å–æ¶ˆ');
            }
            
            // é‡ç½®ç®­é ­èµ·é»
            if (tool === 'arrow') {
                arrowStart = null;
            }
            
            // åˆå§‹åŒ–é‹¼ç­†å·¥å…·
            if (tool === 'penTool') {
                penPoints = [];
            }
        }
        
        // å–æ¶ˆç•¶å‰å·¥å…·
        function cancelCurrentTool() {
            if (!currentTool) return;
            
            const prevTool = currentTool;
            currentTool = null;
            
            // ç§»é™¤æ‰€æœ‰å·¥å…·æŒ‰éˆ•çš„ active ç‹€æ…‹
            const toolBtnIds = [
                'selectBtn', 'selectBtn2', 'mosaicBtn', 'arrowBtn', 'brushBtn',
                'shapeBtn', 'eyeDropperAdvBtn', 'lassoBtn', 'magicWandBtn', 'penToolBtn'
            ];
            toolBtnIds.forEach(id => {
                document.getElementById(id)?.classList.remove('active');
            });
            
            // é‡ç½®æ¸¸æ¨™
            canvas.style.cursor = 'default';
            
            // éš±è—å·¥å…·ç‹€æ…‹æŒ‡ç¤ºå™¨
            const toolStatus = document.getElementById('toolStatus');
            if (toolStatus) {
                toolStatus.style.display = 'none';
            }
            
            // æ¸…é™¤é‹¼ç­†è·¯å¾‘
            if (prevTool === 'penTool') {
                penPoints = [];
            }
            
            showToast('ğŸ”“ å·¥å…·å·²å–æ¶ˆ');
        }
        
        // ===== é‹¼ç­†å·¥å…· =====
        let penPoints = [];
        
        function handlePenTool(coords) {
            penPoints.push(coords);
            
            // ç¹ªè£½è·¯å¾‘é è¦½
            drawPenPath();
            
            showToast(`ğŸ–Šï¸ å·²æ·»åŠ ç¬¬ ${penPoints.length} å€‹éŒ¨é»`);
        }
        
        function drawPenPath() {
            if (penPoints.length < 1) return;
            
            // å„²å­˜ç•¶å‰ç•«å¸ƒ
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            // ç¹ªè£½è·¯å¾‘
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(penPoints[0].x, penPoints[0].y);
            
            for (let i = 1; i < penPoints.length; i++) {
                ctx.lineTo(penPoints[i].x, penPoints[i].y);
            }
            ctx.stroke();
            ctx.setLineDash([]);
            
            // ç¹ªè£½éŒ¨é»
            penPoints.forEach((p, i) => {
                ctx.fillStyle = i === 0 ? '#00ff00' : '#00ffff';
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 1;
                ctx.stroke();
            });
        }
        
        function completePenPath() {
            if (penPoints.length < 2) {
                showToast('âš ï¸ è‡³å°‘éœ€è¦ 2 å€‹éŒ¨é»');
                return;
            }
            
            saveHistory();
            
            // ç”¨ç•¶å‰ç•«ç­†è¨­å®šç¹ªè£½æœ€çµ‚è·¯å¾‘
            ctx.strokeStyle = document.getElementById('brushColor')?.value || '#ff0000';
            ctx.lineWidth = parseInt(document.getElementById('brushSize')?.value || 3);
            ctx.setLineDash([]);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(penPoints[0].x, penPoints[0].y);
            
            for (let i = 1; i < penPoints.length; i++) {
                ctx.lineTo(penPoints[i].x, penPoints[i].y);
            }
            ctx.stroke();
            
            showToast(`ğŸ–Šï¸ å·²å®Œæˆè·¯å¾‘ï¼ˆ${penPoints.length} å€‹éŒ¨é»ï¼‰`);
            penPoints = [];
        }
        
        function startSelection(e) {
            const coords = getCanvasCoords(e);
            
            // å¸è‰²å™¨
            if (eyedropperTarget) {
                pickColor(coords);
                return;
            }
            
            // ç•«ç­†å·¥å…·
            if (currentTool === 'brush') {
                isDrawing = true;
                lastX = coords.x;
                lastY = coords.y;
                saveHistory();
                return;
            }
            
            // å–è‰²å™¨å·¥å…·
            if (currentTool === 'eyedropperAdv') {
                const pixel = ctx.getImageData(coords.x, coords.y, 1, 1).data;
                updateColorValues(pixel[0], pixel[1], pixel[2]);
                return;
            }
            
            // é‹¼ç­†å·¥å…·
            if (currentTool === 'penTool') {
                handlePenTool(coords);
                return;
            }
            
            // é­”è¡“æ£’å·¥å…·
            if (currentTool === 'magicWand') {
                magicWandSelect(coords.x, coords.y);
                return;
            }
            
            // å¥—ç´¢å·¥å…·
            if (currentTool === 'lasso') {
                isLassoing = true;
                lassoPoints = [coords];
                saveHistory();
                return;
            }
            
            // å½¢ç‹€å·¥å…·
            if (currentTool === 'shape') {
                isSelecting = true;
                selectionStart = coords;
                selectionEnd = coords;
                saveHistory();
                return;
            }
            
            // ç®­é ­å·¥å…·
            if (currentTool === 'arrow') {
                arrowStart = coords;
                return;
            }
            
            // å…¶ä»–å·¥å…·éœ€è¦ select æˆ– mosaic
            if (currentTool !== 'select' && currentTool !== 'mosaic') return;
            
            isSelecting = true;
            selectionStart = coords;
            selectionEnd = coords;
            
            const box = document.getElementById('selectionBox');
            box.style.display = 'block';
            updateSelectionBox();
        }
        
        function updateSelection(e) {
            const coords = getCanvasCoords(e);
            
            // ç•«ç­†ç¹ªè£½
            if (currentTool === 'brush' && isDrawing) {
                drawBrushStroke(lastX, lastY, coords.x, coords.y);
                lastX = coords.x;
                lastY = coords.y;
                return;
            }
            
            // å¥—ç´¢ç¹ªè£½
            if (currentTool === 'lasso' && isLassoing) {
                lassoPoints.push(coords);
                // å³æ™‚ç¹ªè£½å¥—ç´¢è·¯å¾‘
                drawLassoPath();
                return;
            }
            
            // å½¢ç‹€é è¦½ï¼ˆå¯é¸ï¼‰
            if (currentTool === 'shape' && isSelecting) {
                selectionEnd = coords;
                return;
            }
            
            if (!isSelecting) return;
            selectionEnd = coords;
            updateSelectionBox();
        }
        
        function drawLassoPath() {
            if (lassoPoints.length < 2) return;
            
            // ç¹ªè£½è™›ç·šè·¯å¾‘
            ctx.save();
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(lassoPoints[0].x, lassoPoints[0].y);
            for (let i = 1; i < lassoPoints.length; i++) {
                ctx.lineTo(lassoPoints[i].x, lassoPoints[i].y);
            }
            ctx.stroke();
            ctx.restore();
        }
        
        function endSelection(e) {
            const coords = getCanvasCoords(e);
            
            // ç•«ç­†çµæŸ
            if (currentTool === 'brush' && isDrawing) {
                isDrawing = false;
                return;
            }
            
            // å¥—ç´¢å®Œæˆ
            if (currentTool === 'lasso' && isLassoing) {
                isLassoing = false;
                if (lassoPoints.length > 2) {
                    completeLassoSelection();
                }
                return;
            }
            
            // å½¢ç‹€ç¹ªè£½
            if (currentTool === 'shape' && isSelecting) {
                isSelecting = false;
                const x = Math.min(selectionStart.x, coords.x);
                const y = Math.min(selectionStart.y, coords.y);
                const w = Math.abs(coords.x - selectionStart.x);
                const h = Math.abs(coords.y - selectionStart.y);
                if (w > 5 || h > 5) {
                    drawShape(x, y, w, h);
                }
                return;
            }
            
            // è™•ç†ç®­é ­
            if (currentTool === 'arrow' && arrowStart) {
                if (Math.abs(coords.x - arrowStart.x) > 10 || Math.abs(coords.y - arrowStart.y) > 10) {
                    drawArrow(arrowStart.x, arrowStart.y, coords.x, coords.y);
                }
                arrowStart = null;
                return;
            }
            
            if (!isSelecting) return;
            isSelecting = false;
            
            const x = Math.min(selectionStart.x, selectionEnd.x);
            const y = Math.min(selectionStart.y, selectionEnd.y);
            const w = Math.abs(selectionEnd.x - selectionStart.x);
            const h = Math.abs(selectionEnd.y - selectionStart.y);
            
            if (w > 5 && h > 5) {
                currentSelection = { x, y, w, h };
                
                // é¦¬è³½å…‹å·¥å…·ç›´æ¥å¥—ç”¨
                if (currentTool === 'mosaic') {
                    applyMosaic();
                } else {
                    showToast('âœ… å·²é¸å–å€åŸŸ');
                }
            } else {
                currentSelection = null;
                document.getElementById('selectionBox').style.display = 'none';
            }
        }
        
        function completeLassoSelection() {
            // è¨ˆç®—å¥—ç´¢å€åŸŸçš„é‚Šç•Œæ¡†
            const xs = lassoPoints.map(p => p.x);
            const ys = lassoPoints.map(p => p.y);
            const minX = Math.min(...xs);
            const minY = Math.min(...ys);
            const maxX = Math.max(...xs);
            const maxY = Math.max(...ys);
            
            // å„²å­˜é¸å–å€åŸŸ
            currentSelection = {
                x: minX,
                y: minY,
                w: maxX - minX,
                h: maxY - minY,
                isLasso: true,
                points: [...lassoPoints]
            };
            
            // ç¹ªè£½å°é–‰è·¯å¾‘
            ctx.save();
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(lassoPoints[0].x, lassoPoints[0].y);
            for (let i = 1; i < lassoPoints.length; i++) {
                ctx.lineTo(lassoPoints[i].x, lassoPoints[i].y);
            }
            ctx.closePath();
            ctx.stroke();
            ctx.restore();
            
            showToast(`ğŸ”— å¥—ç´¢é¸å–å®Œæˆï¼ˆ${lassoPoints.length} é»ï¼‰`);
            lassoPoints = [];
        }
        
        // ç•«ç­†ç¹ªè£½
        function drawBrushStroke(x1, y1, x2, y2) {
            const size = parseInt(document.getElementById('brushSize').value);
            const opacity = parseFloat(document.getElementById('brushOpacity').value);
            const color = document.getElementById('brushColor').value;
            
            ctx.save();
            ctx.globalAlpha = opacity;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            switch(currentBrush) {
                case 'pen':
                    ctx.strokeStyle = color;
                    ctx.lineWidth = size;
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    break;
                    
                case 'marker':
                    ctx.strokeStyle = color;
                    ctx.lineWidth = size * 2;
                    ctx.globalAlpha = opacity * 0.7;
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    break;
                    
                case 'highlighter':
                    ctx.strokeStyle = color;
                    ctx.lineWidth = size * 3;
                    ctx.globalAlpha = 0.3;
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    break;
                    
                case 'spray':
                    ctx.fillStyle = color;
                    for (let i = 0; i < 20; i++) {
                        const offsetX = (Math.random() - 0.5) * size * 2;
                        const offsetY = (Math.random() - 0.5) * size * 2;
                        ctx.fillRect(x2 + offsetX, y2 + offsetY, 1, 1);
                    }
                    break;
                    
                case 'eraser':
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.strokeStyle = 'rgba(0,0,0,1)';
                    ctx.lineWidth = size * 2;
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    ctx.globalCompositeOperation = 'source-over';
                    break;
            }
            
            ctx.restore();
        }
        
        function updateSelectionBox() {
            const container = document.getElementById('canvasContainer');
            const containerRect = container.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();
            
            // è¨ˆç®—ç•«å¸ƒåœ¨å®¹å™¨ä¸­çš„åç§»
            const offsetX = canvasRect.left - containerRect.left + container.scrollLeft;
            const offsetY = canvasRect.top - containerRect.top + container.scrollTop;
            
            const scaleX = canvasRect.width / canvas.width;
            const scaleY = canvasRect.height / canvas.height;
            
            const x = Math.min(selectionStart.x, selectionEnd.x) * scaleX + offsetX;
            const y = Math.min(selectionStart.y, selectionEnd.y) * scaleY + offsetY;
            const w = Math.abs(selectionEnd.x - selectionStart.x) * scaleX;
            const h = Math.abs(selectionEnd.y - selectionStart.y) * scaleY;
            
            const box = document.getElementById('selectionBox');
            box.style.left = x + 'px';
            box.style.top = y + 'px';
            box.style.width = w + 'px';
            box.style.height = h + 'px';
        }
        
        // ===== é­”è¡“æ£’é¸å– =====
        function magicWandSelect(startX, startY, tolerance = 32) {
            // ç¢ºä¿åº§æ¨™ç‚ºæ•´æ•¸
            startX = Math.round(startX);
            startY = Math.round(startY);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰åœ–ç‰‡
            if (!currentImage && canvas.width === 300) {
                showToast('âš ï¸ è«‹å…ˆè¼‰å…¥åœ–ç‰‡');
                return;
            }
            
            // æª¢æŸ¥åº§æ¨™ç¯„åœ
            if (startX < 0 || startX >= canvas.width || startY < 0 || startY >= canvas.height) {
                showToast('âš ï¸ è«‹é»æ“Šåœ–ç‰‡å€åŸŸ');
                return;
            }
            
            saveHistory();
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const width = canvas.width;
            const height = canvas.height;
            
            // å–å¾—èµ·å§‹é»é¡è‰²
            const startIdx = (startY * width + startX) * 4;
            const targetR = data[startIdx];
            const targetG = data[startIdx + 1];
            const targetB = data[startIdx + 2];
            
            // æ¨™è¨˜å·²è¨ªå•ï¼ˆä½¿ç”¨ Uint8Array æ›´å¿«ï¼‰
            const visited = new Uint8Array(width * height);
            const selected = [];
            const queue = [[startX, startY]];
            
            // ä½¿ç”¨è¼ƒå¤§çš„å®¹å·®
            const actualTolerance = tolerance * 3;
            
            while (queue.length > 0 && selected.length < 500000) {  // é™åˆ¶æœ€å¤§é¸å–æ•¸
                const [x, y] = queue.shift();
                const pixelIdx = y * width + x;
                
                if (visited[pixelIdx] || x < 0 || x >= width || y < 0 || y >= height) continue;
                visited[pixelIdx] = 1;
                
                const idx = pixelIdx * 4;
                const r = data[idx], g = data[idx + 1], b = data[idx + 2];
                
                // æª¢æŸ¥é¡è‰²æ˜¯å¦ç›¸ä¼¼
                const diff = Math.abs(r - targetR) + Math.abs(g - targetG) + Math.abs(b - targetB);
                if (diff <= actualTolerance) {
                    selected.push([x, y]);
                    // åªæ·»åŠ æœªè¨ªå•çš„é„°å±…
                    if (x + 1 < width && !visited[pixelIdx + 1]) queue.push([x + 1, y]);
                    if (x - 1 >= 0 && !visited[pixelIdx - 1]) queue.push([x - 1, y]);
                    if (y + 1 < height && !visited[pixelIdx + width]) queue.push([x, y + 1]);
                    if (y - 1 >= 0 && !visited[pixelIdx - width]) queue.push([x, y - 1]);
                }
            }
            
            if (selected.length === 0) {
                showToast('âš ï¸ æ²’æœ‰é¸å–åˆ°åƒç´ ï¼Œè«‹å˜—è©¦é»æ“Šå…¶ä»–å€åŸŸ');
                return;
            }
            
            // æ¨™è¨˜é¸ä¸­å€åŸŸï¼ˆç”¨èèŸ»ç·šé‚Šæ¡†è€Œéæ”¹è®Šé¡è‰²ï¼‰
            // å…ˆç•«é‚Šç•Œ
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            // ç¹ªè£½é¸å–é®ç½©
            tempCtx.fillStyle = 'rgba(0, 150, 255, 0.3)';
            selected.forEach(([x, y]) => {
                tempCtx.fillRect(x, y, 1, 1);
            });
            
            ctx.drawImage(tempCanvas, 0, 0);
            
            showToast(`ğŸª„ å·²é¸å– ${selected.length.toLocaleString()} å€‹åƒç´ `);
            
            // å„²å­˜é¸å–å€åŸŸçš„é‚Šç•Œ
            if (selected.length > 0) {
                const xs = selected.map(p => p[0]);
                const ys = selected.map(p => p[1]);
                currentSelection = {
                    x: Math.min(...xs),
                    y: Math.min(...ys),
                    w: Math.max(...xs) - Math.min(...xs) + 1,
                    h: Math.max(...ys) - Math.min(...ys) + 1,
                    isMagicWand: true,
                    pixels: selected
                };
            }
        }
        
        // ===== æ¸…é™¤é¸å–å€åŸŸ =====
        function clearSelection() {
            if (!currentSelection) {
                showToast('âš ï¸ è«‹å…ˆé¸å–å€åŸŸ');
                return;
            }
            
            saveHistory(); // å„²å­˜æ­·å²ä¾›å¾©åŸ
            
            const bgColor = document.getElementById('bgColor').value;
            ctx.fillStyle = bgColor;
            ctx.fillRect(currentSelection.x, currentSelection.y, currentSelection.w, currentSelection.h);
            
            // æ›´æ–° PDF æš«å­˜
            if (pdfDoc && pdfPages[currentPageNum - 1]) {
                pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            showToast('ğŸ§¹ å·²æ¸…é™¤ï¼');
        }
        
        // ===== å¸ç®¡å·¥å…· =====
        function startEyedropper(target) {
            eyedropperTarget = target;
            document.getElementById('textEyedropper').classList.toggle('active', target === 'text');
            document.getElementById('bgEyedropper').classList.toggle('active', target === 'bg');
            canvas.style.cursor = 'crosshair';
            showToast('ğŸ’§ é»æ“Šåœ–ç‰‡å¸å–é¡è‰²');
        }
        
        function handleCanvasClick(e) {
            const coords = getCanvasCoords(e);
            
            // åœ–ç« æ”¾ç½®æ¨¡å¼
            if (stampDragMode && pendingStamp) {
                placeStampAt(pendingStamp, coords.x, coords.y);
                pendingStamp = null;
                stampDragMode = false;
                canvas.style.cursor = 'default';
                return;
            }
            
            // ç°½åæ”¾ç½®æ¨¡å¼
            if (signDragMode && pendingSign) {
                placeSignAt(coords.x, coords.y);
                return;
            }
            
            // è²¼åœ–æ”¾ç½®æ¨¡å¼
            if (stickerDragMode && pendingSticker) {
                placeStickerAt(pendingSticker, coords.x, coords.y);
                return;
            }
            
            // QR ç¢¼æ”¾ç½®æ¨¡å¼
            if (qrDragMode && pendingQR) {
                placeQRAt(coords.x, coords.y);
                return;
            }
            
            // æ–‡å­—ç‰¹æ•ˆæ”¾ç½®æ¨¡å¼
            if (textFxDragMode && pendingTextFx) {
                applyTextFxAt(pendingTextFx.style, pendingTextFx.text, coords.x, coords.y);
                return;
            }
            
            // å¸è‰²å™¨
            if (eyedropperTarget) {
                pickColor(coords);
            }
        }
        
        function pickColor(coords) {
            const pixel = ctx.getImageData(coords.x, coords.y, 1, 1).data;
            const hex = '#' + [pixel[0], pixel[1], pixel[2]].map(x => x.toString(16).padStart(2, '0')).join('');
            
            if (eyedropperTarget === 'text') {
                document.getElementById('textColor').value = hex;
            } else {
                document.getElementById('bgColor').value = hex;
            }
            
            document.getElementById('textEyedropper').classList.remove('active');
            document.getElementById('bgEyedropper').classList.remove('active');
            eyedropperTarget = null;
            canvas.style.cursor = currentTool === 'select' ? 'crosshair' : 'default';
            showToast('ğŸ¨ å·²å¸å–é¡è‰² ' + hex);
        }
        
        // ===== æ–‡å­—æ¨£å¼ =====
        function toggleStyle(style) {
            textStyle[style] = !textStyle[style];
            document.getElementById(style + 'Btn').classList.toggle('active', textStyle[style]);
        }
        
        function setAlign(align) {
            textStyle.align = align;
        }
        
        // ===== å¿«é€Ÿæ·»åŠ æ–‡å­—ï¼ˆæ‹–æ›³æ¨¡å¼ï¼‰=====
        function addQuickText() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                showToast('âš ï¸ è«‹è¼¸å…¥æ–‡å­—');
                return;
            }
            
            const fontSize = parseInt(document.getElementById('fontSize').value) || 24;
            const color = document.getElementById('textColor').value;
            
            createDragObject('quicktext', text, {
                fontSize,
                color,
                bold: textStyle.bold,
                italic: textStyle.italic
            }, quickTextPosition);
        }
        
        function setQuickTextPosition(pos, btn) {
            quickTextPosition = pos;
            document.querySelectorAll('#textPanel .pos-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        // ===== æ‡‰ç”¨æ–‡å­—ï¼ˆé¸å–å€æ¨¡å¼ï¼‰=====
        function applyText() {
            if (!currentSelection) {
                showToast('âš ï¸ è«‹å…ˆç”¨ âœ‚ï¸ é¸å–å€åŸŸ');
                return;
            }
            
            const text = document.getElementById('textInput').value;
            if (!text.trim()) {
                showToast('âš ï¸ è«‹è¼¸å…¥æ–‡å­—');
                return;
            }
            
            const fontSize = parseInt(document.getElementById('fontSize').value) || 16;
            const textColor = document.getElementById('textColor').value;
            const bgColor = document.getElementById('bgColor').value;
            
            // å¡«å……èƒŒæ™¯
            ctx.fillStyle = bgColor;
            ctx.fillRect(currentSelection.x, currentSelection.y, currentSelection.w, currentSelection.h);
            
            // è¨­å®šæ–‡å­—æ¨£å¼
            let fontStyle = '';
            if (textStyle.bold) fontStyle += 'bold ';
            if (textStyle.italic) fontStyle += 'italic ';
            ctx.font = `${fontStyle}${fontSize}px sans-serif`;
            ctx.fillStyle = textColor;
            ctx.textBaseline = 'top';
            
            // æ–‡å­—æ›è¡Œè™•ç†
            const lines = text.split('\n');
            const lineHeight = fontSize * 1.3;
            let y = currentSelection.y + 5;
            
            lines.forEach(line => {
                let x = currentSelection.x + 5;
                if (textStyle.align === 'center') {
                    const textWidth = ctx.measureText(line).width;
                    x = currentSelection.x + (currentSelection.w - textWidth) / 2;
                } else if (textStyle.align === 'right') {
                    const textWidth = ctx.measureText(line).width;
                    x = currentSelection.x + currentSelection.w - textWidth - 5;
                }
                
                ctx.fillText(line, x, y);
                
                // åº•ç·š
                if (textStyle.underline) {
                    const textWidth = ctx.measureText(line).width;
                    ctx.beginPath();
                    ctx.moveTo(x, y + fontSize);
                    ctx.lineTo(x + textWidth, y + fontSize);
                    ctx.strokeStyle = textColor;
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
                
                y += lineHeight;
            });
            
            // æ›´æ–° PDF æš«å­˜
            if (pdfDoc && pdfPages[currentPageNum - 1]) {
                pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            // æ¸…é™¤é¸å–
            currentSelection = null;
            document.getElementById('selectionBox').style.display = 'none';
            document.getElementById('textInput').value = '';
            
            showToast('âœ… æ–‡å­—å·²æ‡‰ç”¨ï¼');
        }
        
        // ===== éµç›¤äº‹ä»¶ =====
        function initKeyboardEvents() {
            document.getElementById('textInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    applyText();
                }
            });
        }
        
        // ===== ä¸‹è¼‰åŠŸèƒ½ =====
        function downloadPNG() {
            const link = document.createElement('a');
            link.download = `magic-edit-${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showToast('ğŸ–¼ï¸ PNG ä¸‹è¼‰ä¸­...');
        }
        
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            
            // å„²å­˜ç•¶å‰é 
            if (pdfDoc) {
                pdfPages[currentPageNum - 1] = ctx.getImageData(0, 0, canvas.width, canvas.height);
            }
            
            showToast('ğŸ“„ ç”¢ç”Ÿ PDF ä¸­...');
            
            // å»ºç«‹è‡¨æ™‚ canvas
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            let pdf = null;
            
            if (pdfDoc && pdfPages.length > 0) {
                // å¤šé  PDF
                for (let i = 0; i < pdfPages.length; i++) {
                    if (!pdfPages[i]) {
                        await renderPdfPage(i + 1);
                    }
                    
                    const pageData = pdfPages[i];
                    tempCanvas.width = pageData.width;
                    tempCanvas.height = pageData.height;
                    tempCtx.putImageData(pageData, 0, 0);
                    
                    const imgData = tempCanvas.toDataURL('image/jpeg', 0.9);
                    const width = pageData.width * 0.264583;
                    const height = pageData.height * 0.264583;
                    
                    if (i === 0) {
                        pdf = new jsPDF({
                            orientation: width > height ? 'l' : 'p',
                            unit: 'mm',
                            format: [width, height]
                        });
                    } else {
                        pdf.addPage([width, height], width > height ? 'l' : 'p');
                    }
                    
                    pdf.addImage(imgData, 'JPEG', 0, 0, width, height);
                }
            } else {
                // å–®å¼µåœ–ç‰‡
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const width = canvas.width * 0.264583;
                const height = canvas.height * 0.264583;
                
                pdf = new jsPDF({
                    orientation: width > height ? 'l' : 'p',
                    unit: 'mm',
                    format: [width, height]
                });
                
                pdf.addImage(imgData, 'JPEG', 0, 0, width, height);
            }
            
            pdf.save(`magic-edit-${Date.now()}.pdf`);
            showToast('ğŸ“„ PDF ä¸‹è¼‰å®Œæˆï¼');
        }
        
        // ===== LINE åˆ†äº« =====
        async function sendToLine() {
            if (!settings.gasUrl) {
                showToast('âš ï¸ è«‹å…ˆåˆ°è¨­å®šé å¡«å¯« GAS URL');
                showPage('settings');
                return;
            }
            
            showToast('ğŸ’¬ å‚³é€ä¸­...');
            
            try {
                // å˜—è©¦å–å¾—åœ–ç‰‡è³‡æ–™ï¼ˆå¯èƒ½å› è·¨åŸŸè€Œå¤±æ•—ï¼‰
                let imageData;
                try {
                    imageData = canvas.toDataURL('image/png');
                } catch (canvasError) {
                    showToast('âŒ ç„¡æ³•å–å¾—åœ–ç‰‡ï¼ˆå¯èƒ½å«æœ‰è·¨åŸŸå…§å®¹ï¼‰');
                    console.error('Canvas toDataURL éŒ¯èª¤:', canvasError);
                    return;
                }
                
                const payload = {
                    action: 'sendImage',
                    image: imageData
                };
                
                if (settings.lineUserId) {
                    payload.userId = settings.lineUserId;
                }
                
                await fetch(settings.gasUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'no-cors'
                });
                showToast('âœ… å·²å‚³é€åˆ° LINEï¼');
            } catch (e) {
                showToast('âŒ å‚³é€å¤±æ•—: ' + e.message);
                console.error('LINE å‚³é€éŒ¯èª¤:', e);
            }
        }
        
        // ===== è¨­å®š =====
        function loadSettings() {
            const s = localStorage.getItem('imageMagicSettings');
            if (s) {
                settings = { ...settings, ...JSON.parse(s) };
                document.getElementById('gasUrl').value = settings.gasUrl || '';
                document.getElementById('lineUserId').value = settings.lineUserId || '';
                document.getElementById('geminiApiKey').value = settings.geminiApiKey || '';
                document.getElementById('groqApiKey').value = settings.groqApiKey || '';
            }
        }
        
        function saveSettings() {
            settings.gasUrl = document.getElementById('gasUrl').value.trim();
            settings.lineUserId = document.getElementById('lineUserId').value.trim();
            settings.geminiApiKey = document.getElementById('geminiApiKey').value.trim();
            settings.groqApiKey = document.getElementById('groqApiKey').value.trim();
            localStorage.setItem('imageMagicSettings', JSON.stringify(settings));
            showToast('ğŸ’¾ è¨­å®šå·²å„²å­˜ï¼');
        }
        
        function clearSettings() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨­å®šå—ï¼Ÿ')) return;
            settings = { gasUrl: '', lineUserId: '', geminiApiKey: '', groqApiKey: '' };
            document.getElementById('gasUrl').value = '';
            document.getElementById('lineUserId').value = '';
            document.getElementById('geminiApiKey').value = '';
            document.getElementById('groqApiKey').value = '';
            localStorage.removeItem('imageMagicSettings');
            showToast('ğŸ—‘ï¸ è¨­å®šå·²æ¸…é™¤ï¼');
        }
        
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                btn.textContent = 'ğŸ‘ï¸';
            }
        }
        
        async function testLineNotify() {
            // å…ˆå–å¾—ç•¶å‰è¼¸å…¥å€¼
            const gasUrl = document.getElementById('gasUrl').value.trim();
            const lineUserId = document.getElementById('lineUserId').value.trim();
            
            if (!gasUrl) {
                showToast('âš ï¸ è«‹å…ˆå¡«å¯« GAS éƒ¨ç½² URL');
                return;
            }
            
            showToast('ğŸ“¡ æ­£åœ¨æ¸¬è©¦ LINE é€£ç·š...');
            
            try {
                const payload = { action: 'testNotify' };
                if (lineUserId) {
                    payload.userId = lineUserId;
                }
                
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'no-cors'
                });
                
                showToast('âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼Œè«‹æª¢æŸ¥ LINEï¼');
            } catch (error) {
                showToast('âŒ æ¸¬è©¦å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // ===== Toast =====
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
